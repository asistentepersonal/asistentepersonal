<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- SDKs de Firebase para la Mini App (Cargados de forma segura) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <!-- SDKs de Firebase para la Mini App -->

  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card.clickable-card { cursor: pointer; }
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:12px;min-width:24px;height:24px;padding:0 7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:24px;font-weight:500;}
	.card-badge.card-badge-pill {
    width: auto;
    height: auto;
    min-width: 0;
    border-radius: 999px;
    padding: 3px 10px;
    line-height: 1.4;
}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;}
    .card-badge.red{background-color:#e74c3c;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; z-index: 10; }
        .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1100; /* Prioridad muy alta para estar siempre por encima */ overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
    .dropdown-menu.up { top: auto; bottom: 100%; margin-bottom: 5px; }
    .dropdown-item { padding: 12px 20px; color: var(--text) !important; background-color: var(--card-bg, #fff) !important; cursor: pointer; display: block; text-align: left; transition: background-color 0.2s, color 0.2s; }
    .dropdown-item:hover { background-color: var(--primary, #4a76f3) !important; color: var(--action-text, #fff) !important; }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container, .settings-container, .export-container, .chef-container {max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input, .form-card select, .form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input, .form-card select{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text); background-color: var(--bg, #f5f7fa);}
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center; flex-wrap: wrap;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .form-card .button-group { display: flex; gap: 10px; margin-top: 20px; }
    .form-card .button-group button { flex: 1; margin-top: 0; }
    .form-card button.cancel { background-color: var(--delete-bg); opacity: 1; cursor: pointer; }
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 2s linear infinite;z-index:1001; text-align: center;}    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
	.btn-spinner {
    display: inline-block !important; /* Asegura que se muestre */
    position: relative !important; /* Anula el 'fixed' */
    top: 0 !important; left: 0 !important; transform: none !important; /* Anula el centrado */
    border-color: white !important; /* Color para que se vea bien en botones oscuros */
    border-top-color: transparent !important; /* Efecto de giro */
    border-width: 2px !important; /* M√°s fino para el bot√≥n */
    width: 18px !important; height: 18px !important; /* M√°s peque√±o */
    vertical-align: middle;
    margin-right: 8px;
}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .list-style-none { list-style: none; padding: 0; margin: 0; }
    .list-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .list-item-content { display: flex; flex-direction: column; flex-grow: 1; text-align: left;}
    .list-item-title { font-size: 1.1rem; font-weight: 500; }
    .list-item-subtitle { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .list-item-actions { display: flex; align-items: center; gap: 5px; position: relative; flex-shrink: 0; }
    .generic-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-data-msg { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; font-size: 1.2rem; line-height: 1.5; }
    #recurrent-hours-container { display: none; margin-top: 15px; }
    .shopping-list-header-row { display: flex; align-items: center; justify-content: flex-end; padding: 0 10px 10px 10px; color: var(--muted); font-size: 0.9rem; }
    .shopping-list-header-row input[type="checkbox"] { margin-left: 5px; }
    .shopping-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .shopping-item-checkbox-wrapper { flex-shrink: 0; }
    .shopping-item input[type="checkbox"] { width: 20px; height: 20px; }
    .shopping-item-toggle-btn { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; color: var(--list-item-text); cursor: pointer; text-align: left; }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); }
    .shopping-item-toggle-btn .item-date { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; display:block; }
    .add-article-btn-container { padding: 10px; text-align: center; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .add-article-btn, .multi-select-action-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; flex-grow: 1; max-width: 250px; }
    .multi-select-action-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .shopping-list-section-title { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 10px 10px 10px; padding-top: 10px; border-top: 1px solid #eee; text-align: left; }
    .shopping-list-section-title:first-of-type { border-top: none; margin-top: 0; }
    .note-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .note-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; }
    .note-header-interactive { flex-grow: 1; padding-right: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .note-title-section { display: flex; flex-direction: column; text-align: left; }
    .note-title { font-size: 1.1rem; font-weight: 500; }
    .note-date { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .note-description { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    .note-item.open .note-description { max-height: 500px; padding: 0 15px 15px; }
    .expand-arrow { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
    .note-item.open .expand-arrow { transform: rotate(180deg); }
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; text-align: left;}
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; display: none; }
    .list-item.open .event-description { display: block; }
    .gasto-chart-container { text-align: center; margin-top: 15px; }
    .gasto-chart-container canvas { max-width: 100%; }
    .gasto-legend { list-style: none; padding: 15px 0 0 0; margin: 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .gasto-legend-item { display: flex; align-items: center; font-size: 0.9rem; }
    .gasto-legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; }
/* Contenedor principal de la fila de notificaci√≥n */
.notification-row {
    display: flex;         /* Usa Flexbox para alinear todo en una l√≠nea */
    align-items: center;   /* Centra los elementos verticalmente */
    gap: 8px;              /* Espacio entre los elementos (controles y bot√≥n) */
    margin-bottom: 8px;
}

/* El contenedor de los selects y el input num√©rico */
.notification-controls-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;              /* Espacio interno entre los controles */
    flex-grow: 1;          /* ¬°CLAVE! Hace que este grupo ocupe todo el espacio disponible */
}

/* Estilo para los selects y el input dentro de la fila */
.notification-row select, .notification-row input {
    margin-top: 0 !important; /* Anula otros m√°rgenes */
    padding: 8px;             /* Un poco de padding para que se vean mejor */
    flex: 1;                  /* Permite que los controles compartan el espacio de forma flexible */
    min-width: 60px;          /* Un ancho m√≠nimo para que nunca colapsen */
}

/* El bot√≥n de la papelera */
.notification-row .remove-notification-btn {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    color: var(--muted);
    cursor: pointer;
    padding: 0 5px;
    flex-shrink: 0;        /* ¬°CLAVE! Impide que el bot√≥n se encoja o desaparezca */
    line-height: 1;
}
    #image-preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    #image-preview-element { max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    #image-preview-actions { display: flex; gap: 20px; margin-top: 20px; width: 100%; max-width: 400px; }
    #image-preview-actions button { flex: 1; padding: 15px; font-size: 1.2rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; }
    #preview-send-btn { background-color: var(--action-bg); color: var(--action-text); }
    #preview-cancel-btn { background-color: var(--delete-bg); color: var(--delete-text); }
    .scan-instruction-screen { text-align: center; padding: 40px 20px; display: flex; flex-direction: column; justify-content: center; height: 100vh; }
    .scan-instruction-screen h2 { font-size: 1.6rem; margin-bottom: 20px; }
    .scan-instruction-screen ol { text-align: left; margin: 0 auto 30px auto; max-width: 300px; }
    .scan-instruction-screen li { margin-bottom: 10px; line-height: 1.5; }
    .scan-instruction-screen .add-article-btn { max-width: 100%; }
    .dropdown-item { background-color: var(--menu-bg, #fff); }
    .form-card textarea, .form-card input, .form-card select { background-color: var(--card-bg, #fff); color: var(--text, #333); border: 1px solid var(--muted, #ddd); }
    .dropdown-menu { background-color: var(--card-bg, #fff); }
    .settings-section-title { font-size: 1.3rem; font-weight: 600; color: var(--text); margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid #eee; text-align: left;}
    .settings-section-title:first-of-type { margin-top: 0; }
    .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
    .settings-item-label { font-size: 1.1rem; }
    .settings-item-control { flex-shrink: 0; margin-left: 15px; }
    .settings-item-control input, .settings-item-control select { margin-top:0 !important; width: auto; max-width: 150px;}
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }
    .chef-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .chef-item label { margin-top:0; }
    #chef-peticion-ayuda { font-size: 0.85rem; color: var(--muted); margin-top: 5px; display: block; }
    .recipe-card { background: var(--card-bg); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .recipe-header { padding: 15px; border-bottom: 1px solid #eee; }
    .recipe-title { font-size: 1.2rem; font-weight: 600; }
    .recipe-body { padding: 15px; }
    .recipe-description { margin-bottom: 15px; line-height: 1.5; }
    .recipe-subtitle { font-size: 1rem; font-weight: 500; margin-bottom: 8px; }
    .recipe-ingredient-list li { list-style: none; margin-bottom: 5px; }
    .recipe-ingredient-list.buy li { display: flex; align-items: center; }
    .recipe-ingredient-list.buy input { margin-right: 10px; width: 18px; height: 18px; }
    #chef-image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .preview-item { position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; }
    .preview-image { width: 100%; height: 100%; object-fit: cover; }
    .delete-preview-btn { position: absolute; top: 4px; right: 4px; width: 22px; height: 22px; background-color: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; font-size: 14px; line-height: 22px; text-align: center; cursor: pointer; font-weight: bold; }
    .tab-premium-locked {
        cursor: not-allowed;
        opacity: 0.6;
        pointer-events: none; /* Bloquea los clics */
    }
    .list-item.clickable {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .list-item.clickable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* --- INICIO C√ìDIGO NUEVO --- */
    .card.disabled-card {
        position: relative;
        cursor: not-allowed;
        overflow: hidden; /* Importante para la banda */
    }
    .card.disabled-card::before {
        content: "En desarrollo";
        position: absolute;
        top: 25px;
        right: -35px;
        background-color: #f39c12; /* Color naranja */
        color: white;
        padding: 5px 30px;
        transform: rotate(45deg);
        font-size: 0.8rem;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 5;
    }
    .card.disabled-card .card-icon, .card.disabled-card .card-title, .card.disabled-card .card-badge {
	/* Estilo espec√≠fico para la franja de la tarjeta Chef bloqueada */
.card.disabled-card#chef-card-locked::before {
    content: "Funci√≥n Premium ‚≠ê";
    background-color: #f1c40f; /* Un color dorado para Premium */
}
        opacity: 0.5;
    }
    /* --- FIN C√ìDIGO NUEVO --- */
   /* --- INICIO C√ìDIGO SPLASH SCREEN --- */
.splash-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--bg, #f5f7fa);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease-out;
  opacity: 1;
}
.splash-screen.hidden {
  opacity: 0;
  pointer-events: none;
}
.splash-logo {
  width: 120px;
  height: 120px;
  animation: pulse 1.5s infinite ease-in-out;
}
.splash-text {
  margin-top: 20px;
  font-size: 1.2rem;
  color: var(--muted, #555);
}
@keyframes pulse {
  0% { transform: scale(0.95); }
  50% { transform: scale(1); }
  100% { transform: scale(0.95); }
}
/* --- FIN C√ìDIGO SPLASH SCREEN --- */
/* --- INICIO ESTILOS GU√çA TV --- */
.guia-tv-container { padding: 10px; max-width: 100%; overflow: hidden; }
.guia-nav { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 8px; }
.guia-nav-btn { background-color: var(--card-bg); color: var(--text); border: 1px solid var(--muted); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; cursor: pointer; white-space: nowrap; }
.guia-nav-btn.active { background-color: var(--primary); color: var(--action-text); border-color: var(--primary); }
.guia-grid-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
.guia-grid { display: grid; grid-template-columns: 100px 1fr; position: relative; }
.guia-channels-col { z-index: 2; position: sticky; left: 0; background: var(--bg); }
.guia-channel-logo-placeholder { height: 60px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--muted); border-bottom: 1px solid #eee; }
.guia-channel-logo { height: 60px; display: flex; align-items: center; justify-content: center; padding: 5px; border-bottom: 1px solid #eee; }
.guia-channel-logo img { max-width: 80%; max-height: 40px; object-fit: contain; }
.guia-timeline-col { min-width: 2880px; /* 48 horas x 60px/hora */ }
.guia-time-header { display: flex; height: 60px; border-bottom: 1px solid #eee; position: relative; }
.guia-time-slot { width: 60px; /* Ancho para 30 minutos */ flex-shrink: 0; text-align: center; padding-top: 20px; color: var(--muted); font-size: 0.9rem; border-left: 1px solid #eee; }
.guia-channel-row { height: 60px; position: relative; border-bottom: 1px solid #eee; background-image: linear-gradient(to right, #eee 1px, transparent 1px); background-size: 60px 100%; }
.guia-program-block { position: absolute; top: 2px; bottom: 2px; background-color: var(--card-bg); border-radius: 6px; padding: 5px 8px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-size: 0.9rem; color: var(--text); border-left: 4px solid var(--primary); cursor: pointer; transition: background-color 0.2s; }
.guia-program-block:hover { background-color: #e9e9e9; }
.guia-program-title { font-weight: 600; }
.guia-program-time { font-size: 0.8rem; color: var(--muted); }
.guia-now-line { position: absolute; top: 0; bottom: 0; width: 2px; background-color: #e74c3c; z-index: 3; pointer-events: none; }
/* --- FIN ESTILOS GU√çA TV --- */  
/* --- INICIO ESTILOS CALENDARIO PROFESIONAL (V2) --- */
.calendar-header-sticky { position: sticky; top: 0; background-color: var(--bg); z-index: 30; padding-top: 10px; margin-bottom: 10px; overflow: visible; }
.calendar-timeline { position: relative; padding-left: 50px; }
.time-slot { height: 60px; border-top: 1px solid var(--muted); position: relative; }
.time-slot::before { content: attr(data-time); position: absolute; left: -50px; top: -10px; color: var(--muted); font-size: 0.8rem; }
.now-line { position: absolute; left: 50px; right: 0; height: 2px; background-color: #e74c3c; z-index: 15; }
.now-line::before { content: ''; position: absolute; left: -5px; top: -4px; width: 12px; height: 12px; background-color: #e74c3c; border-radius: 50%; }
.event-block { position: absolute; background-color: var(--primary); color: var(--action-text); border-radius: 8px; padding: 8px; overflow: hidden; z-index: 10; cursor: pointer; border-left: 5px solid rgba(0,0,0,0.2); box-sizing: border-box !important; }
.event-block-title {
    font-weight: bold;
    font-size: 0.9rem;
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* --- CORRECCI√ìN DEFINITIVA DE MEN√ö Y L√çNEAS --- */
/* Le da al men√∫ la m√°xima prioridad para que siempre est√© visible */
#calendar-view-menu {
    z-index: 100 !important;
}

/* Asegura que la columna de horas tenga la altura m√≠nima correcta */
.calendar-time-col {
    min-height: 1440px; /* 24h * 60px */
}

/* --- NUEVO: Correcci√≥n de posicionamiento del Men√∫ --- */
.list-header .dropdown-menu {
    z-index: 110; /* Asegura que el men√∫ est√© por encima de las cabeceras fijas */
}
.event-block-time { font-size: 0.8rem; opacity: 0.8; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; } /* Ajuste de gap para bordes */
.calendar-day-header { text-align: center; font-weight: bold; padding: 8px 0; font-size: 0.9rem; }
.calendar-day-cell { background: var(--card-bg); border-radius: 8px; min-height: 100px; cursor: pointer; display: flex; flex-direction: column; padding: 4px; border: 1px solid var(--bg); }
.calendar-day-cell.today { border-color: var(--primary); box-shadow: 0 0 5px var(--primary); }
.calendar-day-number { font-weight: bold; text-align: right; font-size: 0.9rem; padding: 4px; }
.month-event-pill { font-size: 0.75rem; padding: 2px 5px; border-radius: 5px; margin: 1px 2px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; color: var(--action-text); }
.week-view-col { display: flex; flex-direction: column; }
.week-view-timeline { flex-grow: 1; position: relative; border-left: 1px solid var(--bg); min-height: 500px; }
/* --- FIN ESTILOS CALENDARIO PROFESIONAL (V2) --- */
/* --- INICIO ESTILOS CALENDARIO (V3 - ESTILO GOOGLE CALENDAR) --- */

/* Contenedor principal para la vista mensual */
.calendar-month-container {
    /* Este contenedor ahora solo agrupa */
}

/* Cabecera de los d√≠as de la semana (Lun, Mar...) */
.calendar-month-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    position: sticky;
    top: 135px; /* Se pega debajo de los controles de navegaci√≥n */
    z-index: 10;
    
    /* Efecto de borde sutil usando el fondo y el gap */
    background-color: var(--muted); 
    gap: 1px;
    border: 1px solid var(--muted);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    overflow: hidden; /* Asegura que el borde redondeado se aplique a las celdas */
}

/* Celda individual de la cabecera */
.calendar-month-header .calendar-day-header {
    padding: 10px 0;
    font-size: 0.8rem;
    font-weight: 500;
    background-color: var(--card-bg);
    text-align: center;
}

/* Cuadr√≠cula principal de los d√≠as del mes */
.calendar-month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    /* ¬°CLAVE! Todas las filas tendr√°n la misma altura m√≠nima pero pueden crecer */
    grid-auto-rows: minmax(100px, auto); 
    gap: 1px;
    background-color: var(--muted);
    border: 1px solid var(--muted);
    border-top: none;
}

/* Celda de un d√≠a individual */
.calendar-day-cell {
    background: var(--card-bg);
    padding: 4px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    cursor: pointer;
    border: none;
    border-radius: 0;
    min-height: auto;
    transition: background-color 0.2s; /* Efecto suave al pasar el rat√≥n */
}
.calendar-day-cell:not(.empty):hover {
    background-color: #f0f0f0; /* Un color sutil para el hover, solo en celdas con d√≠a */
}

/* N√∫mero del d√≠a dentro de la celda */
.calendar-day-number {
    font-weight: 500;
    text-align: center; /* Centrado como en la imagen */
    font-size: 0.9rem;
    padding: 4px;
    width: 26px; /* Ancho y alto para formar un c√≠rculo */
    height: 26px;
    line-height: 18px; /* Ajuste para centrar el n√∫mero verticalmente */
    border-radius: 50%; /* Lo hace circular */
    margin: 0 auto 4px auto; /* Centra el c√≠rculo horizontalmente */
    transition: background-color 0.2s, color 0.2s;
}

/* Estilo para el d√≠a de HOY */
.calendar-day-cell.today .calendar-day-number {
    background-color: var(--primary); /* Fondo azul */
    color: var(--action-text); /* Texto blanco */
    font-weight: bold;
}

/* "Pastilla" para un evento */
.month-event-pill {
    font-size: 0.75rem;
    padding: 3px 6px;
    border-radius: 4px; /* Bordes menos redondeados, m√°s profesional */
    margin: 1px 2px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    color: var(--action-text);
    font-weight: 500;
}

/* Contenedor para las pastillas dentro de una celda */
.month-events-container {
    display: flex;
    flex-direction: column;
    gap: 2px; /* Peque√±o espacio entre pastillas */
}

/* --- FIN ESTILOS CALENDARIO (V3 - ESTILO GOOGLE CALENDAR) --- */
/* --- INICIO: NUEVA ARQUITECTURA VISUAL CALENDARIO (ESTILO GOOGLE CALENDAR) --- */
.calendar-grid-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 185px); /* Altura din√°mica para ocupar el espacio disponible */
    border: 1px solid var(--muted);
    border-radius: 8px;
    overflow: hidden; /* Clave para que el borde redondeado afecte a todo */
}

/* 1. Cabecera de D√≠as (Lun 15, Mar 16...) */
.calendar-header {
    display: grid;
    flex-shrink: 0; /* No se encoge */
    position: sticky;
    top: 0;
    z-index: 20; /* Por encima del cuerpo */
    background-color: var(--muted);
    gap: 1px;
    border-bottom: 1px solid var(--muted);
}

.calendar-header .day-label {
    background-color: var(--card-bg);
    text-align: center;
    padding: 6px 4px;
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.day-label .day-number-circle {
    font-size: 0.9rem; /* Un poco m√°s grande para el n√∫mero */
    font-weight: 500;
    width: 24px;
    height: 24px;
    line-height: 24px;
    border-radius: 50%;
    margin-top: 2px;
}
.day-label.today .day-number-circle {
    background-color: var(--primary);
    color: var(--action-text);
    font-weight: bold;
}

/* 2. Cabecera "Todo el D√≠a" */
.calendar-all-day-header {
    display: grid;
    flex-shrink: 0;
    position: sticky;
    top: 40px; /* Se pega justo debajo de la cabecera de d√≠as (ajustar si cambia la altura) */
    z-index: 20;
    background-color: var(--muted);
    gap: 1px;
    border-bottom: 1px solid var(--muted);
}

.all-day-label {
    background-color: var(--card-bg);
    font-size: 0.8rem;
    color: var(--muted);
    text-align: right;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

.all-day-slot {
    background-color: var(--card-bg);
    min-height: 28px;
    padding: 2px;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* 3. Cuerpo Deslizable (Contiene horas y eventos) */
.calendar-scroll-body {
    flex-grow: 1; /* Ocupa todo el espacio restante */
    display: flex;
    overflow: auto; /* PERMITE EL SCROLL */
    position: relative;
}

/* 4. Columna de Horas (a la izquierda) */
.calendar-time-col {
    width: 50px;
    flex-shrink: 0;
    background-color: var(--card-bg);
    position: sticky;
    left: 0;
    z-index: 10;
}

.calendar-time-slot {
    height: 60px;
    position: relative;
    font-size: 0.8rem;
    color: var(--muted);
    text-align: right;
    padding-right: 5px;
}
.calendar-time-slot span {
    position: relative;
    top: -9px;
    /* Mejora para modo oscuro: el texto de las horas siempre es legible */
    color: var(--text);
    opacity: 0.7;
}

/* 5. Cuadr√≠cula de Eventos (el fondo donde se dibujan las l√≠neas) */
.calendar-events-grid {
    display: grid;
    gap: 0;
    flex-grow: 1;
    /* La l√≠nea min-width: 650px; se ha eliminado para corregir el c√°lculo del ancho del evento */
}
.calendar-events-grid.three-day {
    min-width: auto; /* La vista 3 d√≠as no necesita scroll H */
}

/* Columna individual de un d√≠a */
.calendar-day-col {
    position: relative;
    background-color: var(--card-bg);
    /* L√çNEAS HORIZONTALES (sutiles y adaptables a temas) */
    background-image: linear-gradient(to bottom, transparent 59px, rgba(128, 128, 128, 0.2) 1px);
    background-size: 100% 60px;
    min-height: 1440px; /* 24h * 60px */
    /* L√çNEAS VERTICALES (sutiles y adaptables a temas) */
    border-left: 1px solid rgba(128, 128, 128, 0.2);
}

/* 6. Mejoras Adicionales y Correcciones */
.dropdown-item.active {
    background-color: var(--primary) !important;
    color: var(--action-text) !important;
    font-weight: bold;
}

.floating-action-button {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    background-color: var(--primary);
    color: var(--action-text);
    border-radius: 16px; /* Bordes redondeados como en la referencia */
    border: none;
    font-size: 28px;
    line-height: 56px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 1050;
    transition: transform 0.2s, border-radius 0.2s ease-out;
}
.floating-action-button:hover {
    transform: scale(1.05);
    border-radius: 50%; /* Efecto suave al pasar el rat√≥n */
}
/* --- FIN: NUEVA ARQUITECTURA VISUAL CALENDARIO --- */
/* --- INICIO: ESTILOS PARA MODAL Y CONTROLES PERSONALIZADOS --- */
.custom-dropdown {
    position: relative;
    width: 100%;
}
.custom-dropdown-selected {
    display: flex;
    align-items: center;
    background-color: var(--bg);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
}
.color-swatch {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 12px;
    flex-shrink: 0;
}
.custom-dropdown-options {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background-color: var(--card-bg);
    border: 1px solid var(--muted);
    border-radius: 8px;
    margin-top: 4px;
    z-index: 1200;
    max-height: 200px;
    overflow-y: auto;
}
.custom-dropdown-item {
    display: flex;
    align-items: center;
    padding: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.custom-dropdown-item:hover {
    background-color: var(--bg);
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    z-index: 1500;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none; /* No interactuable por defecto */
}
.modal-overlay.show {
    opacity: 1;
    pointer-events: auto; /* Interactuable cuando es visible */
}
.modal-content {
    background-color: var(--card-bg);
    width: 100%;
    max-width: 480px;
    padding: 20px;
    border-radius: 16px 16px 0 0;
    transform: translateY(100%);
    transition: transform 0.3s ease-out;
}
.modal-overlay.show .modal-content {
    transform: translateY(0);
}
.modal-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: left;
}
.preset-list-item {
    display: flex;
    align-items: center;
    padding: 12px 5px;
    cursor: pointer;
    font-size: 1rem;
}
.preset-list-item input[type="radio"] {
    width: 20px;
    height: 20px;
    margin-right: 15px;
}
.notification-chip {
    display: inline-flex;
    align-items: center;
    background-color: var(--bg);
    border: 1px solid var(--muted);
    border-radius: 16px;
    padding: 6px 10px;
    font-size: 0.9rem;
    margin: 4px;
}
.notification-chip-remove {
    margin-left: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1rem;
    line-height: 1;
}
#notification-chips-container {
    margin-top: 10px;
    padding: 5px;
    border: 1px dashed var(--muted);
    border-radius: 8px;
    min-height: 40px;
}
/* --- INICIO: Estilos para botones de modal modernos --- */
.modal-btn {
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.modal-btn:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}
.modal-btn-primary {
    background-color: #2980b9; /* Azul brillante */
    color: white;
}
.modal-btn-secondary {
    background-color: #f1f3f4; /* Gris claro sutil */
    color: #3c4043;
}
/* --- FIN: Estilos para botones de modal modernos --- */
/* --- FIN: ESTILOS PARA MODAL Y CONTROLES PERSONALIZADOS --- */
/* --- INICIO: Estilos para el Modal de Changelog --- */
.changelog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 9998; /* Justo debajo del splash screen */
    display: none; /* Oculto por defecto */
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.changelog-overlay.show {
    display: flex;
    opacity: 1;
}
.changelog-modal {
    background-color: var(--card-bg);
    color: var(--text);
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    transform: scale(0.95);
    transition: transform 0.3s ease;
}
.changelog-overlay.show .changelog-modal {
    transform: scale(1);
}
.changelog-modal h2 {
    font-size: 1.4rem;
    margin: 0 0 15px 0;
    text-align: center;
}
.changelog-modal-content {
    overflow-y: auto; /* Scroll si el contenido es muy largo */
    flex-grow: 1;
    margin-bottom: 20px;
}
.changelog-modal-content ul {
    list-style: none;
    padding-left: 5px;
}
.changelog-modal-content li {
    margin-bottom: 10px;
    line-height: 1.5;
    display: flex;
    align-items: flex-start;
}
.changelog-modal-content li::before {
    content: '‚úÖ';
    color: var(--primary);
    margin-right: 10px;
    font-size: 1rem;
}
.changelog-modal .button-group {
    margin-top: 0; /* Anulamos el margen superior del button-group */
}
/* --- FIN: Estilos para el Modal de Changelog --- */
  </style>
  <script>
    // Configuraci√≥n de Firebase para el cliente (conexi√≥n directa y segura)
    const firebaseConfig = {
      apiKey: "AIzaSyBXEOTkiOxyZfqX8QDZJraofPR9jMeIN6I",
      authDomain: "asistentepersonal-4ad2b.firebaseapp.com",
      projectId: "asistentepersonal-4ad2b",
      storageBucket: "asistentepersonal-4ad2b.firebasestorage.app",
      messagingSenderId: "1068752893536",
      appId: "1:1068752893536:web:ad23509d45dc7d448bf505"
    };
  </script>
</head>
<body>
  <!-- --- INICIO SPLASH SCREEN --- -->
	<div id="splash-screen" class="splash-screen">
  <img src="https://lh3.googleusercontent.com/d/1zQd1rn14IFHAGYHn95GVvILTB90i3320" alt="Logo" class="splash-logo" />
  <div class="splash-text">Cargando tu asistente...</div>
	</div>
<!-- --- FIN SPLASH SCREEN --- -->
<!-- --- INICIO MODAL DE CHANGELOG --- -->
<div class="changelog-overlay" id="changelog-overlay">
    <div class="changelog-modal">
        <h2 id="changelog-title">¬°Novedades en la Versi√≥n <span id="changelog-version"></span>!</h2>
        <div class="changelog-modal-content">
            <ul id="changelog-content">
                <!-- El contenido se insertar√° aqu√≠ con JS -->
            </ul>
        </div>
        <div class="button-group">
            <button id="changelog-continue-btn" class="enabled" style="width:100%;">Continuar</button>
        </div>
    </div>
</div>
<!-- --- FIN MODAL DE CHANGELOG --- -->
  <div id="spinner" class="spinner"></div>
  <div id="main-content-area">
  </div>
    <div class="tabs">
    <div class="tab active" id="tab-home">üè† Home</div>
    <div class="tab" id="tab-chef">üßë‚Äçüç≥ Chef</div>
    <div class="tab" id="tab-export">üìä Exportar Gastos</div>
    <div class="tab" id="tab-settings">‚öôÔ∏è Ajustes</div>
  </div>
  <div id="toast" class="toast"></div>
  <div id="image-preview-overlay" style="display: none;">
    <img id="image-preview-element" src="" alt="Vista previa del ticket" />
    <div id="image-preview-actions">
        <button id="preview-cancel-btn">Cancelar</button>
        <button id="preview-send-btn">Enviar</button>
    </div>
  </div>
<!-- INICIO MODAL DE NOTIFICACIONES -->
<div class="modal-overlay" id="notification-modal" style="display: none;">
    <div class="modal-content">
        <!-- Vista de Presets (inicial) -->
        <div id="notification-presets-view">
            <h3 class="modal-title">A√±adir notificaci√≥n</h3>
            <div id="notification-presets-list">
                <!-- Los presets se generar√°n con JS -->
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button id="notification-modal-cancel" class="cancel">Cancelar</button>
            </div>
        </div>
        <!-- Vista Personalizada (oculta por defecto) -->
        <div id="notification-custom-view" style="display: none;">
            <h3 class="modal-title">Notificaci√≥n personalizada</h3>
            
            <input type="number" id="custom-notification-value" placeholder="10" value="10" min="1" style="margin-bottom: 15px; text-align: center; font-size: 1.2rem;">
            
            <label class="preset-list-item">
                <input type="radio" name="custom_unit" value="minutes" checked>
                <span>Minutos antes</span>
            </label>
            <label class="preset-list-item">
                <input type="radio" name="custom_unit" value="hours">
                <span>Horas antes</span>
            </label>
            <label class="preset-list-item">
                <input type="radio" name="custom_unit" value="days">
                <span>D√≠as antes</span>
            </label>
            
            <hr style="margin: 15px 0; border-top: 1px solid var(--muted);">

            <label class="preset-list-item">
                <input type="radio" name="custom_method" value="telegram" checked>
                <span>En una notificaci√≥n</span>
            </label>
            <label class="preset-list-item">
                <input type="radio" name="custom_method" value="email">
                <span>En un correo</span>
            </label>
            
            <div class="button-group" style="margin-top: 20px;">
                <button id="custom-notification-back" class="cancel">Cancelar</button>
                <button id="custom-notification-done" class="enabled">Hecho</button>
            </div>
        </div>
    </div>
</div>
<!-- FIN MODAL DE NOTIFICACIONES -->
  
<script>
    document.addEventListener('DOMContentLoaded', () => {
    
// =========================================================================
// --- NUEVA L√ìGICA DE ARRANQUE (FIRESTORE FIRST) ---
// =========================================================================
const HTML_VERSION = "1.2.24"; // IMPORTANTE: Incrementa la versi√≥n del cliente.

// --- FUNCI√ìN DE ARRANQUE MODIFICADA (SOLO VERIFICA VERSI√ìN) ---
// --- INICIALIZACI√ìN GLOBAL DE FIREBASE ---
// Esta secci√≥n ahora se ejecuta siempre, garantizando que 'db' exista.
if (typeof firebaseConfig !== 'undefined' && !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
}

// --- FUNCI√ìN DE ARRANQUE MODIFICADA (SOLO VERIFICA VERSI√ìN) ---
async function initializeApp() {
    if (isInitializing) return;
    isInitializing = true;
    console.log("Iniciando app y verificando versi√≥n...");

    // Comprueba si venimos de una recarga forzada por el changelog.
    if (sessionStorage.getItem('force_app_load') === 'true') {
        sessionStorage.removeItem('force_app_load'); // Limpiamos la bandera
        console.log("Recarga forzada detectada. Saltando verificaci√≥n de versi√≥n.");
        runApp(); // Ejecutamos la app directamente
        return;
    }

    try {
        const versionDoc = await db.collection('app_config').doc('version_info').get();
        const serverVersion = versionDoc.exists ? versionDoc.data().current_version : "0.0.0";
        
        if (String(serverVersion) !== String(HTML_VERSION)) {
            console.log(`Versi√≥n desactualizada. Cliente: ${HTML_VERSION}, Servidor: ${serverVersion}. Mostrando changelog.`);
            const changelogText = versionDoc.data().changelog || "* Se han realizado mejoras y correcciones de errores.";
            hideSplashScreen(); 
            showChangelogModal(serverVersion, changelogText);
            return; 
        }

        console.log("Versi√≥n correcta. Ejecutando la aplicaci√≥n...");
        runApp();

    } catch (err) {
        console.error("Error cr√≠tico en initializeApp:", err);
        showToast(`Error de inicializaci√≥n: ${err.message}`, true);
        mainContentArea.innerHTML = `<div class="no-data-msg">üîå<br>Error de conexi√≥n.<br><small>Int√©ntalo de nuevo m√°s tarde.</small></div>`;
        hideSplashScreen();
    }
}

// --- FUNCI√ìN QUE CONTIENE LA L√ìGICA PRINCIPAL DE LA APP ---
async function runApp() {
    try {
        const userSettingsDoc = await db.collection('users').doc(chatId).get();

        if (!userSettingsDoc.exists) {
            failApp("Usuario no encontrado.<br><small>Contacta con soporte.</small>");
            return;
        }

        appData.settings = userSettingsDoc.data() || {};
        appData.isPremium = appData.settings.plan_premium === true;
        
        // Listener GLOBAL de contadores
        db.collection('users').doc(chatId).collection('_metadata').doc('counts')
            .onSnapshot((doc) => {
                if (doc.exists) {
                    const serverCounts = doc.data();
                    if (JSON.stringify(serverCounts) !== JSON.stringify(appData.counts)) {
                        appData.counts = serverCounts;
                        if (document.querySelector('.grid')) {
                            renderDashboard();
                            showToast("Datos sincronizados.", false);
                        }
                    }
                }
            }, (error) => {
                console.error("Error en el listener de contadores: ", error);
            });

        // Listener para el badge del calendario en tiempo real
        const startOfToday = new Date();
        startOfToday.setHours(0, 0, 0, 0);
        const endOfToday = new Date();
        endOfToday.setHours(23, 59, 59, 999);

        db.collection('users').doc(chatId).collection('eventos_calendario')
          .where('fechaInicio', '>=', startOfToday)
          .where('fechaInicio', '<=', endOfToday)
          .onSnapshot(snapshot => {
              appData.counts.calendarTodayCount = snapshot.size;
              const calendarBadge = document.getElementById('calendar-badge');
              if (calendarBadge) {
                  calendarBadge.textContent = snapshot.size;
              }
          }, error => {
              console.error("Error en listener de eventos de hoy:", error);
          });

        updateChefTabStyle();
        renderDashboard();
        isAppReady = true;
        hideSplashScreen();
        
    } catch (err) {
        console.error("Error cr√≠tico en runApp:", err);
        showToast(`Error al cargar datos de usuario: ${err.message}`, true);
        mainContentArea.innerHTML = `<div class="no-data-msg">üîå<br>Error de conexi√≥n.<br><small>Int√©ntalo de nuevo m√°s tarde.</small></div>`;
        hideSplashScreen();
    } finally {
        isInitializing = false;
    }
}

function hideSplashScreen() {
    const splash = document.getElementById('splash-screen');
    if (splash) {
        splash.classList.add('hidden');
        // Opcional: eliminar el splash del DOM despu√©s de la transici√≥n para liberar memoria.
        setTimeout(() => {
            if (splash.parentNode) {
                splash.parentNode.removeChild(splash);
            }
        }, 600); // Debe coincidir con la duraci√≥n de la transici√≥n en el CSS.
    }
}
function showChangelogModal(version, changelogText) {
    const overlay = document.getElementById('changelog-overlay');
    const versionSpan = document.getElementById('changelog-version');
    const contentUl = document.getElementById('changelog-content');
    const continueBtn = document.getElementById('changelog-continue-btn');

    if (!overlay || !versionSpan || !contentUl || !continueBtn) {
        // Si algo falla, forzamos la recarga para no bloquear al usuario
        console.error("No se encontraron los elementos del modal de changelog. Forzando actualizaci√≥n.");
        window.location.reload(true);
        return;
    }

    // Llenamos el modal con los datos de Firestore
    versionSpan.textContent = version;
    contentUl.innerHTML = changelogText
        .split('*') // Separamos por el asterisco
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => `<li>${line}</li>`)
        .join('');

    // Definimos la acci√≥n del bot√≥n
        continueBtn.onclick = () => {
        overlay.classList.remove('show');
        setTimeout(() => {
            showToast("Aplicando actualizaci√≥n...", false);
            // --- ¬°AQU√ç EST√Å LA CORRECCI√ìN! ---
            // Le decimos al navegador que en la pr√≥xima carga, ignore la verificaci√≥n.
            sessionStorage.setItem('force_app_load', 'true'); 
            window.location.reload(true);
        }, 300);
    };

    // Mostramos el modal
    overlay.classList.add('show');
}

// --- SISTEMA DE NAVEGACI√ìN (HISTORIAL) ---
let navigationHistory = [];

function goBack() {
    if (navigationHistory.length > 0) {
        const previousStep = navigationHistory.pop();
        if (typeof previousStep === 'function') {
            previousStep();
        }
    }
    updateBackButton();
}

function updateBackButton() {
    if (!tg || !tg.BackButton) return;
    if (tg.isVersionAtLeast('6.1') && tg.BackButton) {
        if (navigationHistory.length > 0) {
            tg.BackButton.show();
        } else {
            tg.BackButton.hide();
        }
    }
}

const tg = window.Telegram?.WebApp;
// --- VARIABLES GLOBALES PARA EMOJIS ---
let emojiDictionary = [];
const EMOJIS_DB_FILENAME = 'emoji-articulos-v1.json'; // Nombre del archivo JSON
// ---
if (tg) { 
    tg.expand(); 
    if (tg.isVersionAtLeast('6.1') && tg.BackButton) { tg.BackButton.onClick(goBack); }
    if (tg.themeParams) { 
        document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa'); 
        document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff'); 
        document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333'); 
        document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555'); 
        document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3'); 
        document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff'); 
    } 
    
    // =========================================================================
    // --- L√ìGICA DE SINCRONIZACI√ìN (VERSI√ìN ARQUITECT√ìNICAMENTE CORRECTA) ---
    // =========================================================================
tg.onEvent('viewportChanged', async (event) => {
    // --- L√ìGICA DE SINCRONIZACI√ìN MEJORADA ---
    // 'isStateStable' es true cuando la ventana se maximiza, pero a menudo
    // es false cuando el teclado aparece, lo que nos sirve como filtro.
    const isAppMaximized = event.isStateStable && tg.isExpanded;

    // Solo actuamos si la app est√° lista Y si el evento es una maximizaci√≥n real.
    if (!isAppReady || !isAppMaximized) {
        return;
    }
    // --- FIN DE LA L√ìGICA MEJORADA ---

    console.log("App maximizada y lista. Comprobando cambios...");
    
    try {
        const countsDoc = await db.collection('users').doc(chatId).collection('_metadata').doc('counts').get();
        if (!countsDoc.exists) {
            console.warn("No se encontr√≥ el documento de contadores durante la sincronizaci√≥n.");
            return;
        }

        const serverCounts = countsDoc.data();
        
        // Usar JSON.stringify para una comparaci√≥n robusta de los objetos
        if (JSON.stringify(serverCounts) !== JSON.stringify(appData.counts)) {
            console.log("Cambios en contadores detectados. Actualizando UI...");
            
            appData.counts = serverCounts;
            // Importante: Solo refrescamos el dashboard SI estamos en la pantalla de Home
            if (document.querySelector('.grid')) {
                renderDashboard();
            }
            showToast("Datos sincronizados.", false);
            // Marcamos las listas como potencialmente desactualizadas
            appData.isSecondaryDataLoaded = false;
        } else {
            console.log("Sin cambios detectados en los contadores.");
        }

    } catch (err) {
        console.error("Error en la sincronizaci√≥n al maximizar:", err);
    }
});
}
const gasWebhookURL = 'https://script.google.com/macros/s/AKfycbwq5YTuS1yk_0irer9CKvc2Prev5XWUaKJLR_UpNaEkY42rg6TMSCqnXo3FqMmHUUSX/exec';
const chefWebhookURL = 'https://hook.eu2.make.com/p6z2dgx6medjbx47udphv5nz2blqcvm8';
const makeTicketWebhookUrl = 'https://hook.eu2.make.com/d3lj3iug4qsbyjdmalmh3sk491elhqps';
let selectedImageFile = null;
    let chatId; // Solo declaramos la variable aqu√≠.
    
    // --- LISTA BLANCA DE USUARIOS AUTORIZADOS (SOLO PARA DESARROLLO) ---
    const authorizedUsers = ["6840956330"]; // <<<--- A√ëADE AQU√ç M√ÅS IDs DE PRUEBA SI ES NECESARIO

    // Funci√≥n auxiliar para gestionar el error de forma centralizada
    function failApp(message, canClose = false) {
        document.body.innerHTML = `<div class="no-data-msg">‚ùå<br>${message}</div>`;
        // Si es un error que permite cierre, y la API de Telegram est√° disponible, cerramos la Mini App.
        if (canClose && tg && tg.close) {
            setTimeout(() => tg.close(), 2500); // Dar tiempo al usuario para leer el mensaje.
        }
        throw new Error(message); // Detener la ejecuci√≥n del script
    }

    // --- NUEVO FLUJO DE INICIALIZACI√ìN CON LISTA BLANCA ---
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
        chatId = tg.initDataUnsafe.user.id.toString();
        console.log("Chat ID obtenido de Telegram:", chatId);
    } else {
        if (window.location.href.includes("github.io") || window.location.href.includes("file://")) {
            chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', '6840956330');
            if (!chatId) {
                failApp("Chat ID no proporcionado en modo de desarrollo.");
            }
            console.log("Chat ID obtenido por prompt (desarrollo):", chatId);
        } else {
            failApp("Error: No se pudo obtener tu ID de Telegram.", true);
        }
    }

    if (!chatId || chatId.trim() === '') {
        failApp("El ID de Chat obtenido no es v√°lido.");
    }
    
    // --- VERIFICACI√ìN FINAL CONTRA LA LISTA BLANCA ---
    if (!authorizedUsers.includes(chatId)) {
        failApp("Acceso no autorizado.", true);
    }


let appData = { 
    counts: { // Inicializar contadores con valores por defecto
        remindersCount: 0, 
        shoppingPendingCount: 0, 
        shoppingBoughtCount: 0, 
        notesCount: 0, 
        calendarTodayCount: 0, 
        gastosMesActual: '0,00', 
        mesesActivosGastos: [] 
    }, 
    remindersList: [], 
    shoppingList: [], 
    notesList: [], 
    calendarEvents: [], 
    settings: {}, 
    isPremium: false, 
    isSecondaryDataLoaded: false 
};
let initialUserSettings = {};
let secondaryDataPromise = null;
const mainContentArea = document.getElementById('main-content-area');
const spinner = document.getElementById('spinner');

function showSpinner(message = '') { 
    spinner.innerHTML = message ? `<div style="color:var(--text); margin-top:50px; font-size:1rem;">${message}</div>` : ''; 
    spinner.style.display = 'block'; 
}
async function loadEmojiDictionary() {
    const cacheKey = `emojiCache-${EMOJIS_DB_FILENAME}`; // Usa el nuevo nombre
    try {
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
            console.log("Cargando diccionario de emojis desde el cach√© local.");
            emojiDictionary = JSON.parse(cachedData);
            return;
        }

        console.log("Descargando diccionario de emojis por primera vez...");
        const response = await fetch(EMOJIS_DB_FILENAME); // Usa el nuevo nombre
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        
        const data = await response.json();
        emojiDictionary = data;
        localStorage.setItem(cacheKey, JSON.stringify(data));

    } catch (error) {
        console.error("No se pudo cargar el diccionario de emojis:", error);
    }
}
function generateCustomId(prefix) {
    const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
    return `${prefix}${randomPart}`;
}
function findEmojiForText(text) {
    if (!text || emojiDictionary.length === 0) return null;

    // Normalizar texto: min√∫sculas, sin tildes, y singularizar (aproximaci√≥n simple)
    const normalizedText = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const singularText = normalizedText.endsWith('es') ? normalizedText.slice(0, -2) : (normalizedText.endsWith('s') ? normalizedText.slice(0, -1) : normalizedText);

    for (const item of emojiDictionary) {
        // Comprobar si el texto singularizado est√° incluido en la etiqueta o en alguna de las palabras clave
        if (item.label.includes(singularText) || (item.tags && item.tags.some(tag => tag.includes(singularText)))) {
            return item.emoji;
        }
    }
    return null;
}
function hideSpinner() { spinner.style.display = 'none'; }
function showToast(msg, isError = false) { 
    let toastTimer; 
    clearTimeout(toastTimer); 
    const t = document.getElementById('toast'); 
    t.textContent = msg; 
    t.className = 'toast show' + (isError ? ' error' : ''); 
    toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); 
}

/**
 * Realiza una petici√≥n fetch con un tiempo de espera.
 * VERSI√ìN FINAL Y ROBUSTA: Usa siempre el m√©todo FormData para las peticiones a Apps Script
 * para evitar errores de CORS, independientemente de los par√°metros.
 */
/**
 * [VERSI√ìN CORREGIDA Y DEFINITIVA]
 * Realiza una petici√≥n fetch con un tiempo de espera.
 * Forza el uso de FormData para todas las llamadas a Apps Script para evitar errores de CORS.
 */
/**
 * [VERSI√ìN FINAL Y ROBUSTA]
 * Realiza una petici√≥n fetch con un tiempo de espera, manejando diferentes formatos
 * seg√∫n si el destino es Apps Script (anti-CORS) o Make.com (para im√°genes).
 */
async function fetchWithTimeout(resource, payloadObject, isMakeWebhook = false) {
  const controller = new AbortController();
  // Aumentamos el timeout para Make, ya que el procesamiento de im√°genes puede tardar.
  const timeout = isMakeWebhook ? 60000 : 30000;
  const id = setTimeout(() => controller.abort(), timeout);
  
  let options = {
    method: 'POST',
    signal: controller.signal
  };

  // --- L√ìGICA DE ENRUTAMIENTO DE FORMATO ---
  if (isMakeWebhook) {
      // Si es para Make.com, construimos un FormData espec√≠fico para im√°genes,
      // que es el formato que originalmente funcionaba.
      const formData = new FormData();
      // A√±adimos el prompt y el conteo de im√°genes como campos de texto.
      formData.append('prompt', payloadObject.prompt);
      if (payloadObject.image_count !== undefined) {
          formData.append('image_count', payloadObject.image_count);
      }
      // A√±adimos cada archivo de imagen.
      if (payloadObject.images && payloadObject.images.length > 0) {
          payloadObject.images.forEach(imageFile => {
              formData.append('images', imageFile, imageFile.name);
          });
      }
      options.body = formData;
      // IMPORTANTE: Al usar FormData para subir archivos, NO se debe especificar
      // el 'Content-Type' en las cabeceras. El navegador lo hace autom√°ticamente
      // con el 'boundary' correcto, lo cual es esencial para que funcione.
  } else {
      // Para TODAS las dem√°s peticiones (a Apps Script), usamos el m√©todo
      // FormData simple que evita el error de CORS.
      const formData = new FormData();
      formData.append("postData", JSON.stringify(payloadObject));
      options.body = formData;
  }
  // --- FIN DE LA L√ìGICA DE ENRUTAMIENTO ---
  
  try {
    const response = await fetch(resource, options);
    clearTimeout(id);
    if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
    return response; // Devuelve la respuesta para que la funci√≥n que llama la procese
  } catch (error) {
    clearTimeout(id);
    if (error.name === 'AbortError') throw new Error('La solicitud tard√≥ demasiado.');
    throw error;
  }
}

let isInitializing = false;
let isAppReady = false;
let unsubscribeShoppingList = null;
let unsubscribeCalendarEvents = null; // Declaraci√≥n √∫nica para el listener del calendario
let calendarScrollSyncHandler = null; // Para el listener de scroll sincronizado
const FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION = 'eventos_calendario';
let currentCalendarView = 'month';
let currentCalendarDate = new Date();
// --- Inputs de archivo globales para la c√°mara y galer√≠a (NUEVOS) ---
// Se declaran una sola vez al inicio de la aplicaci√≥n y se reutilizan.
const fileInputCamera = document.createElement('input');
fileInputCamera.type = 'file';
fileInputCamera.accept = 'image/*';
fileInputCamera.capture = 'camera'; // O 'environment' si 'camera' no funciona mejor
fileInputCamera.style.display = 'none'; // Asegurarse de que est√© oculto
document.body.appendChild(fileInputCamera);

const fileInputGallery = document.createElement('input');
fileInputGallery.type = 'file';
fileInputGallery.accept = 'image/*';
fileInputGallery.style.display = 'none'; // Asegurarse de que est√© oculto
document.body.appendChild(fileInputGallery);
// --- FIN Inputs de archivo globales ---

/// --- CARGADOR DE DATOS SECUNDARIOS (OPTIMIZADO) ---
async function loadSecondaryData() {
    if (appData.isSecondaryDataLoaded) return;
	// --- PUNTO DE DEPURACI√ìN 2: VERIFICAR SI HAY INTERFERENCIA ---
	console.log("2. ENTRANDO A loadSecondaryData. Estado actual de los contadores:", JSON.parse(JSON.stringify(appData.counts)));
	// --- FIN DEPURACI√ìN ---
    
    console.log("Cargando datos secundarios por primera vez...");
    showSpinner("Cargando listas...");
    try {
        const secondaryData = await fetchWithTimeout(gasWebhookURL, { Type: 'get_secondary_data', chat_ID: chatId }).then(res => res.json());
        if (secondaryData.error) throw new Error(secondaryData.error);

        appData.remindersList = secondaryData.remindersList;
        appData.shoppingList = secondaryData.shoppingList;
        appData.calendarEvents = secondaryData.calendarEvents;
        
        // La siguiente l√≠nea es la causa del error NaN. Se comenta para que Firestore sea la √∫nica fuente.
        // appData.counts.gastosMesActual = secondaryData.gastosMesActual; 
        
        appData.counts.calendarTodayCount = secondaryData.calendarTodayCount;
        appData.counts.mesesActivosGastos = secondaryData.mesesActivosGastos;

        appData.isSecondaryDataLoaded = true;
        console.log("Datos secundarios cargados con √©xito.");
        
    } catch (err) {
        console.error("Error cargando datos secundarios:", err);
        showToast(`Error al cargar datos: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function setActiveTab(activeTabId) { 
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); 
  const activeTab = document.getElementById(activeTabId); 
  if (activeTab) activeTab.classList.add('active'); 
}

document.body.addEventListener('click', (e) => {
    const menuBtn = e.target.closest('.card-menu-btn, .generic-menu-btn');
    
    if (!menuBtn && !e.target.closest('.dropdown-menu')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
        return;
    }

    if (menuBtn) {
        e.stopPropagation();
        const menuId = menuBtn.dataset.menuId;
        const menu = document.getElementById(menuId);

        if (menu) {
            const isShown = menu.classList.contains('show');
            
            document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                if (m.id !== menuId) m.classList.remove('show');
            });

            if (isShown) {
                menu.classList.remove('show');
            } else {
                const buttonRect = menuBtn.getBoundingClientRect();
                const windowHeight = window.innerHeight;

                if (buttonRect.top > (windowHeight / 2)) {
                    menu.classList.add('up');
                } else {
                    menu.classList.remove('up');
                }
                
                menu.classList.add('show');
            }
        }
    }
});

function updateChefTabStyle() {
    const chefTab = document.getElementById('tab-chef');
    if (!chefTab) return;
    
    const isPremium = appData.isPremium === true;
    
    if (isPremium) {
        // Si es Premium, la pesta√±a es funcional y normal.
        chefTab.classList.remove('tab-premium-locked');
        chefTab.innerHTML = 'üßë‚Äçüç≥ Chef';
        chefTab.onclick = renderChefPage; // Asignamos la funci√≥n para que se pueda hacer clic
    } else {
        // Si no es Premium, la pesta√±a se bloquea visualmente y funcionalmente.
        chefTab.classList.add('tab-premium-locked');
        chefTab.innerHTML = 'Chef ‚≠ê';
        // Asignamos una funci√≥n que solo muestra el toast.
        chefTab.onclick = () => {
            showToast('‚≠ê Funci√≥n exclusiva para usuarios Premium.');
        };
    }
}

window.confirmDelete = function(type, id) {
    const itemElement = document.getElementById(`item-${id}`);
    if (!itemElement) return;

    let actionsContainer, menuButton;

    if (itemElement.classList.contains('form-card')) {
        actionsContainer = itemElement.querySelector('.button-group');
        menuButton = null; 
    } else {
        actionsContainer = itemElement.querySelector('.list-item-actions');
        menuButton = actionsContainer.querySelector('.generic-menu-btn');
        const dropdown = actionsContainer.querySelector('.dropdown-menu');
        if (dropdown) dropdown.classList.remove('show');
        if (menuButton) menuButton.style.display = 'none';
    }
    
    actionsContainer.querySelectorAll('.confirm-btn-yes, .confirm-btn-no').forEach(btn => btn.remove());
    
    const confirmBtnYes = document.createElement('button');
    confirmBtnYes.className = 'confirm-btn-yes';
    confirmBtnYes.textContent = 'S√≠, Eliminar';
    confirmBtnYes.onclick = (e) => { e.stopPropagation(); executeDelete(type, id); };

    const confirmBtnNo = document.createElement('button');
    confirmBtnNo.className = 'confirm-btn-no';
    confirmBtnNo.textContent = 'No';
    confirmBtnNo.onclick = (e) => { 
        e.stopPropagation(); 
        if(menuButton) menuButton.style.display = 'block'; 
        confirmBtnYes.remove(); 
        confirmBtnNo.remove(); 
    };
    
    actionsContainer.appendChild(confirmBtnNo);
    actionsContainer.appendChild(confirmBtnYes);
}

async function executeDelete(type, id) {
    let payload = { chat_ID: chatId };
    let successMessage = '';

    try {
        switch(type) {
            case 'reminder':
                // --- L√≥gica optimista para la UI ---
                const reminderElem = document.getElementById(`item-${id}`);
                if (reminderElem) reminderElem.remove();
                const remIndex = appData.remindersList.findIndex(r => r.tracking_code === id);
                if (remIndex > -1) appData.remindersList.splice(remIndex, 1);
                appData.counts.remindersCount = Math.max(0, appData.counts.remindersCount - 1);
                renderDashboard();
                showToast('Cancelando recordatorio...');
            
                // --- Llamada al backend para la l√≥gica de cancelaci√≥n ---
                try {
                    const payload = { 
                        Type: 'cancel_reminder', 
                        chat_ID: chatId, 
                        tracking_code: id 
                    };
                    const res = await fetchWithTimeout(gasWebhookURL, payload);
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    showToast('Recordatorio cancelado con √©xito.');
                } catch(err) {
                    showToast(`Error de cancelaci√≥n: ${err.message}. Restaurando...`, true);
                    initializeApp();
                }
                return; // Salir para no ejecutar c√≥digo antiguo.

            case 'note':
                // --- L√ìGICA OPTIMISTA (se mantiene) ---
                const noteItemElement = document.getElementById(`item-${id}`);
                if (noteItemElement) noteItemElement.remove();
                
                const noteIndexToDelete = appData.notesList.findIndex(n => n.Nota_ID === id);
                if (noteIndexToDelete > -1) {
                    appData.notesList.splice(noteIndexToDelete, 1);
                    appData.counts.notesCount = Math.max(0, appData.counts.notesCount - 1);
                }
                
                const notesListBadge = document.getElementById('notes-badge');
                if(notesListBadge) notesListBadge.textContent = appData.counts.notesCount;

                if (appData.notesList.length === 0) {
                    const notesListUlContainer = document.getElementById('notes-list');
                    if (notesListUlContainer) notesListUlContainer.innerHTML = '<div class="no-data-msg">üìù<br>No tienes notas guardadas.</div>';
                }

                showToast('Nota eliminada');
                
                // --- SINCRONIZACI√ìN EN SEGUNDO PLANO CON FIRESTORE ---
                try {
                    const noteDocRef = db.collection('users').doc(chatId).collection('notas').doc(id);
                    const countsDocRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

                    // Ejecutamos ambas operaciones en un batch para asegurar consistencia
                    const batch = db.batch();
                    batch.delete(noteDocRef);
                    batch.update(countsDocRef, {
                        notesCount: firebase.firestore.FieldValue.increment(-1)
                    });
                    await batch.commit();
                    console.log("Nota eliminada y contador actualizado en Firestore.");

                } catch(err) {
                    console.error("Error al eliminar nota en Firestore:", err);
                    showToast('Error de sincronizaci√≥n al eliminar. Recargando...', true);
                    setTimeout(() => initializeApp(), 1500);
                }
                return; // Salimos para no ejecutar el fetch antiguo
            
            case 'calendar_event':
                // --- C√ìDIGO ACTUALIZADO ---
                // Ahora llama a la nueva funci√≥n de borrado de Firestore.
                handleDeleteCalendarEvent(id);
                return; // Importante salir para no ejecutar el fetch de abajo.

            case 'gasto':
                payload.Type = 'delete_gasto_id'; payload.ID_Unico = id; successMessage = 'Gasto eliminado';
                // La actualizaci√≥n de gastos y contadores se gestionar√° por el backend
                break;
            
            case 'shopping_item': // <--- CASO A√ëADIDO Y CORREGIDO
                handleDeleteShoppingItem(id); // Llamar a la funci√≥n dedicada para eliminar el art√≠culo
                return; // Salir, ya que handleDeleteShoppingItem gestiona todo el proceso
        }

    } catch(e) { showToast('Error local al procesar.', true); return; }

    // Este bloque 'try...catch' de abajo ahora solo se ejecutar√° para el caso 'gasto',
    // ya que todos los dem√°s casos tienen un 'return'.
    try {
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast(successMessage);

        // Forzar una resincronizaci√≥n de contadores del dashboard
        const syncCheck = await fetchWithTimeout(gasWebhookURL, { Type: 'resync_counts', chat_ID: chatId }).then(res => res.json());
        if (syncCheck.success) {
            appData.counts = syncCheck.counts; // Actualizar contadores localmente
        } else {
            initializeApp(); // Si falla la resincronizaci√≥n, recarga completa
        }

    } catch (err) {
        showToast(`Error: ${err.message}. Restaurando...`, true);
        initializeApp();
    }
}

// ==================================================
// --- M√ìDULO: RECORDATORIOS ---
// ==================================================
function renderReminderForm() {
  navigationHistory.push(renderDashboard);
  updateBackButton();
  mainContentArea.innerHTML = `
    <div class="list-container">
      <div class="list-header"><h2>üìù Nuevo Recordatorio</h2></div>
      <div class="form-card">
        <label>Descripci√≥n</label><textarea id="text" rows="3" required></textarea>
        <label>Fecha y hora</label><input type="text" id="time" required/>
        <label>Tipo</label>
        <div class="radio-group" id="reminder-type-group">
          <label><input type="radio" name="category" value="Un solo uso" checked/> √önico</label>
          <label><input type="radio" name="category" value="Diario"/> Diario</label>
          <label><input type="radio" name="category" value="Recurrente"/> Recurrente</label>
        </div>
        <div id="recurrent-hours-container">
          <label>Repetir cada...</label>
          <select id="recurrent-hours">${[...Array(11).keys()].map(i => `<option value="${i + 2}">${i + 2} horas</option>`).join('')}</select>
        </div>
        <button id="sendBtn" disabled>Crear Recordatorio</button>
      </div>
    </div>`;
  const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), sendBtn = document.getElementById('sendBtn'), radios = document.querySelectorAll('input[name="category"]'), recurrentContainer = document.getElementById('recurrent-hours-container');
  
  // --- INICIO DE LA CORRECCI√ìN CLAVE ---
  flatpickr("#time", {
    enableTime: true,
    altInput: true,                 // Muestra un input alternativo y amigable
    altFormat: "d/m/Y H:i",         // El formato que ver√° el usuario (dd/mm/yyyy HH:mm)
    dateFormat: "Y-m-d H:i",        // El formato t√©cnico que usa el c√≥digo (se mantiene igual)
    defaultDate: new Date(),
    locale: "es",
    minDate: "today"
  });
  // --- FIN DE LA CORRECCI√ìN CLAVE ---

  function toggleRecurrentField() { const selected = document.querySelector('input[name="category"]:checked').value; recurrentContainer.style.display = selected === 'Recurrente' ? 'block' : 'none'; }
  function validate() { const isValid = textInput.value.trim() !== '' && timeInput.value && document.querySelector('input[name="category"]:checked'); sendBtn.disabled = !isValid; sendBtn.classList.toggle('enabled', isValid); }
  textInput.oninput = validate; timeInput.oninput = validate; radios.forEach(r => r.onchange = () => { toggleRecurrentField(); validate(); });
  sendBtn.onclick = saveReminder;
  toggleRecurrentField(); validate();
}

async function saveReminder() {
  const category = document.querySelector('input[name="category"]:checked').value;
  const description = document.getElementById('text').value.trim();
  const time = document.getElementById('time')._flatpickr.selectedDates[0];
  const horas_recurrentes = (category === 'Recurrente') ? document.getElementById('recurrent-hours').value : null;

  if (!description || !time) {
    showToast("La descripci√≥n y la fecha son obligatorias.", true);
    return;
  }

  // --- FLUJO CORREGIDO ---
  // Ya no volvemos atr√°s ni renderizamos el dashboard. 
  // La app permanecer√° en la vista de lista.
  showToast('Guardando recordatorio...'); 
  
  try {
    const customId = generateCustomId('G-');
    const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const localTimeStr = time.toLocaleString('es-ES', { timeZone: userTimeZone, day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

    const reminderData = {
      descripcion: description,
      categoria_recordatorio: category,
      fecha_universal: time.toISOString(),
      status: "pending_creation",
      tracking_code: customId,
      chat_id: chatId.toString(),
      hora_local: localTimeStr,
      horas_recurrentes: horas_recurrentes ? parseInt(horas_recurrentes, 10) : null,
      trigger_id: null
    };

    const reminderRef = db.collection('users').doc(chatId).collection('notificaciones').doc(customId);
    const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
    
    await reminderRef.set(reminderData);
    await countsRef.update({
        remindersCount: firebase.firestore.FieldValue.increment(1)
    });
    
    // Al finalizar, en lugar de ir al dashboard, vamos a la lista.
    // El listener en tiempo real de la lista se encargar√° de mostrar el nuevo item.
    renderRemindersList();

  } catch (err) { 
    showToast(`Error al guardar: ${err.message}.`, true); 
    // Si hay un error, s√≠ volvemos al dashboard para evitar una pantalla de error.
    renderDashboard();
  }
}

// Variable global para poder desconectar el listener si el usuario sale de la vista
let unsubscribeRemindersList = null;

async function renderRemindersList() {
    navigationHistory.push(() => {
        // Al volver atr√°s, nos aseguramos de que el listener se desconecte
        if (typeof unsubscribeRemindersList === 'function') {
            unsubscribeRemindersList();
            unsubscribeRemindersList = null;
        }
        renderDashboard();
    });
    updateBackButton();
    
    mainContentArea.innerHTML = `<div class="list-container"><div class="list-header"><h2>Recordatorios</h2></div><ul class="list-style-none" id="reminders-list"><div class="no-data-msg">Cargando...</div></ul></div>`;
    const listElement = document.getElementById('reminders-list');

    // Desconectar cualquier listener anterior para evitar duplicados
    if (typeof unsubscribeRemindersList === 'function') {
        unsubscribeRemindersList();
    }

    const q = db.collection('users').doc(chatId).collection('notificaciones')
                .orderBy('fecha_universal', 'asc');
    
    // --- INICIO DE LA L√ìGICA EN TIEMPO REAL ---
    unsubscribeRemindersList = q.onSnapshot(snapshot => {
        if (snapshot.empty) {
            listElement.innerHTML = '<div class="no-data-msg">üéâ<br>No tienes recordatorios.</div>';
            appData.remindersList = [];
            appData.counts.remindersCount = 0;
            if (document.getElementById('reminders-badge')) {
                document.getElementById('reminders-badge').textContent = 0;
            }
            return;
        }

        const reminders = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            reminders.push({
                tracking_code: doc.id,
                Descripcion: data.descripcion,
                Categoria: data.categoria_recordatorio,
                Fecha: data.hora_local,
                Status: data.status // Guardamos el estado para la UI
            });
        });
        
        appData.remindersList = reminders;
        // Actualizamos el contador global y el badge
        appData.counts.remindersCount = reminders.length;
        if (document.getElementById('reminders-badge')) {
            document.getElementById('reminders-badge').textContent = reminders.length;
        }

        const listHtml = reminders.map(item => `
            <li class="list-item" id="item-${item.tracking_code}">
                <div class="list-item-content">
                    <span class="list-item-title">
                        ${item.Status === 'pending_creation' ? '‚åõ ' : ''}${item.Descripcion}
                    </span>
                    <span class="list-item-subtitle">${item.Categoria}: ${item.Fecha}</span>
                </div>
                <div class="list-item-actions">
                    <button class="generic-menu-btn" data-menu-id="menu-item-${item.tracking_code}">‚ãÆ</button>
                    <div class="dropdown-menu" id="menu-item-${item.tracking_code}">
                        <a class="dropdown-item" data-action="delete-reminder" data-tracking-code="${item.tracking_code}">Cancelar</a>
                    </div>
                </div>
            </li>`).join('');

        listElement.innerHTML = listHtml;
        listElement.removeEventListener('click', handleReminderListClick); // Prevenir duplicados
        listElement.addEventListener('click', handleReminderListClick);

    }, error => {
        console.error("Error en el listener de recordatorios:", error);
        showToast("Error de conexi√≥n con la lista.", true);
        listElement.innerHTML = '<div class="no-data-msg">‚ùå Error de conexi√≥n.</div>';
    });
    // --- FIN DE LA L√ìGICA EN TIEMPO REAL ---
}

// Nueva funci√≥n de ayuda para manejar los clics en la lista
function handleReminderListClick(e) {
    const target = e.target.closest('.dropdown-item[data-action="delete-reminder"]');
    if (target) {
        confirmDelete('reminder', target.dataset.trackingCode);
    }
}

async function editReminderDescription(item) {
  const newDescription = prompt('Editar descripci√≥n del recordatorio:', item.Descripcion);
  if (newDescription && newDescription.trim() !== '' && newDescription.trim() !== item.Descripcion) {
    showToast('Guardando cambios...');
    const payload = { Type: 'edit_reminder_description', chat_ID: chatId, tracking_code: item.tracking_code, new_description: newDescription.trim() };
    try {
      const res = await fetchWithTimeout(gasWebhookURL, payload);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      showToast('Recordatorio actualizado.');
      
      // Recargar la lista para reflejar el cambio
      await loadSecondaryData();
      renderRemindersList();

    } catch (err) {
      showToast(`Error: ${err.message}. No se actualiz√≥.`, true);
      initializeApp(); // Recarga completa en caso de error
    }
  }
}

// ==================================================
// --- M√ìDULO: COMPRAS (FIRESTORE EN TIEMPO REAL + OPTIMISTA) ---
// ==================================================

async function renderShoppingList() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>Lista de las Compras</h2></div>
            <div id="shopping-list-content">
                <div class="no-data-msg">Cargando lista de compras...</div>
            </div>
            <div class="add-article-btn-container">
                <button class="add-article-btn" id="add-shopping-item-btn">A√±adir Art√≠culo</button>
                <button class="multi-select-action-btn" id="multi-select-toggle-btn" disabled>Marcar para comprar</button>
            </div>
        </div>`;
    
    document.getElementById('add-shopping-item-btn').onclick = renderAddArticleForm;
    document.getElementById('multi-select-toggle-btn').onclick = toggleSelectedItemsToPending;

    // --- L√ìGICA DE TIEMPO REAL CON FIRESTORE ---
    if (unsubscribeShoppingList) {
        unsubscribeShoppingList(); // Desuscribirse si ya hay un oyente activo para evitar duplicados.
    }

    const userShoppingListPath = `users/${chatId}/listaDeLaCompra`;
    const q = db.collection(userShoppingListPath)
                .orderBy('estado', 'asc') // 'Comprado' antes que 'Pendiente'
                .orderBy('fecha', 'desc');

    unsubscribeShoppingList = q.onSnapshot((snapshot) => {
        const items = [];
        snapshot.forEach((doc) => {
            const data = doc.data();
            items.push({ 
                id: doc.id,
                articulo: data.articulo,
                estado: data.estado,
                fecha: data.fecha ? data.fecha.toDate() : null,
                cycle: data.cycle || 0
            });
        });
        
        appData.shoppingList = items;
        renderShoppingListContent(items);
        updateShoppingCounts(items);
        console.log("Lista de compras actualizada desde Firestore.");

    }, (error) => {
        console.error("Error al escuchar la lista de compras:", error);
        showToast("Error en tiempo real de la lista de compras.", true);
        document.getElementById('shopping-list-content').innerHTML = '<div class="no-data-msg">‚ùå Error al cargar la lista.</div>';
    });
}

function renderShoppingListContent(items) {
    const pendingItems = items.filter(item => item.estado === 'Pendiente');
    const boughtItems = items.filter(item => item.estado === 'Comprado');
    let listHtml = '';
    
    const createItemHTML = (item) => {
        const isPending = item.estado === 'Pendiente';
        const formattedDate = item.fecha ? item.fecha.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
        
        return `
            <li class="shopping-item" id="item-${item.id}">
                ${!isPending ? `<div class="shopping-item-checkbox-wrapper"><input type="checkbox" class="shopping-item-checkbox" data-id="${item.id}"></div>` : ''}
                <button class="shopping-item-toggle-btn ${isPending ? 'pending' : 'bought'}" data-id="${item.id}" data-current-status="${item.estado}">
                <span>${item.articulo}</span>
                    ${!isPending && formattedDate ? `<span class="item-date">${formattedDate}</span>` : ''}
                </button>
                <div class="list-item-actions">
                    <button class="generic-menu-btn" data-menu-id="menu-item-${item.id}">‚ãÆ</button>
                    <div class="dropdown-menu" id="menu-item-${item.id}">
                        <a class="dropdown-item" data-action="edit-shopping-item" data-id="${item.id}">Editar</a>
                        <a class="dropdown-item" data-action="delete-shopping-item" data-id="${item.id}">Eliminar</a>
                    </div>
                </div>
            </li>`;
    };

    if (pendingItems.length > 0) {
        listHtml += '<h3 class="shopping-list-section-title">Art√≠culos Pendientes</h3>';
        listHtml += pendingItems.map(createItemHTML).join('');
    }
    if (boughtItems.length > 0) {
        listHtml += '<h3 class="shopping-list-section-title">Art√≠culos Comprados</h3>';
        listHtml += `<div class="shopping-list-header-row"><label for="select-all-checkbox">Seleccionar Todos</label><input type="checkbox" id="select-all-checkbox"></div>`;
        listHtml += boughtItems.map(createItemHTML).join('');
    }
    if (items.length === 0) {
        listHtml = '<div class="no-data-msg">üõí<br>Tu lista est√° vac√≠a.</div>';
    }

    const contentDiv = document.getElementById('shopping-list-content');
    if (contentDiv) {
        contentDiv.innerHTML = listHtml;
        contentDiv.removeEventListener('click', handleShoppingItemInteractions);
        contentDiv.addEventListener('click', handleShoppingItemInteractions);
        
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.onchange = (e) => {
                document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.checked = e.target.checked; });
                updateMultiSelectButtonState();
            };
        }
        document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.onchange = updateMultiSelectButtonState; });
        updateMultiSelectButtonState();
    }
}

function updateShoppingCounts(items) {
    const pending = items.filter(item => item.estado === 'Pendiente').length;
    const bought = items.filter(item => item.estado === 'Comprado').length;
    
    appData.counts.shoppingPendingCount = pending;
    appData.counts.shoppingBoughtCount = bought;

    const pendingBadge = document.getElementById('shopping-pending-badge');
    const boughtBadge = document.getElementById('shopping-bought-badge');
    if (pendingBadge) pendingBadge.textContent = pending;
    if (boughtBadge) boughtBadge.textContent = bought;
}

function handleShoppingItemInteractions(event) {
    const target = event.target;
    const toggleButton = target.closest('.shopping-item-toggle-btn');
    const menuItem = target.closest('.dropdown-item');

    if (toggleButton) {
        const itemId = toggleButton.dataset.id;
        const currentStatus = toggleButton.dataset.currentStatus;
        const newStatus = currentStatus === 'Pendiente' ? 'Comprado' : 'Pendiente';
        toggleShoppingItemStatus(itemId, newStatus);
        return;
    }

    if (menuItem) {
        const action = menuItem.dataset.action;
        const itemId = menuItem.dataset.id;
        if (action === 'edit-shopping-item') {
            const item = appData.shoppingList.find(i => i.id === itemId);
            if(item) renderEditShoppingItemForm(item);
                } else if (action === 'delete-shopping-item') {
        confirmDelete('shopping_item', itemId); // <--- Restaurar la llamada a confirmDelete
    }
    }
}

async function toggleShoppingItemStatus(itemId, newStatus) {
    const itemRef = db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(itemId);
    // Usar el prefijo del ID para determinar si es un art√≠culo del Chef
    const isChefItem = itemId.startsWith('ITEM-');

    // --- L√≥gica de Eliminaci√≥n (para art√≠culos del Chef al ser Comprados) ---
    if (newStatus === 'Comprado' && isChefItem) {
        // Actualizaci√≥n optimista: lo removemos de la lista local y re-renderizamos
        const index = appData.shoppingList.findIndex(item => item.id === itemId);
        if (index > -1) {
            appData.shoppingList.splice(index, 1);
        }
        renderShoppingListContent(appData.shoppingList); // Re-renderizar la UI
        updateShoppingCounts(appData.shoppingList);      // Actualizar los badges de contadores
        showToast('Art√≠culo de Chef marcado como comprado y eliminado.');

        try {
            await itemRef.delete(); // Ejecutar la eliminaci√≥n real en Firestore
            // El listener de Firestore ('onSnapshot') confirmar√° la eliminaci√≥n y si hay alguna
            // discrepancia, la corregir√°, pero nuestra actualizaci√≥n optimista ya lo ha hecho en la UI.
        } catch (err) {
            console.error("Error al eliminar art√≠culo del Chef de Firestore:", err);
            showToast(`Error de sincronizaci√≥n al eliminar: ${err.message}. Restaurando datos...`, true);
            initializeApp(); // Recarga completa en caso de error grave en la eliminaci√≥n
        }
        return; // Salir despu√©s de procesar la eliminaci√≥n
    }

    // --- L√≥gica de Actualizaci√≥n de Estado (para otros casos) ---
    // Esto incluye:
    // - Art√≠culos manuales ('G-') que se marcan como 'Comprado'.
    // - Cualquier art√≠culo (Chef o manual) que se marca como 'Pendiente'.

    try {
        // Antes de intentar actualizar, verifica si el documento existe en Firestore
        const docSnap = await itemRef.get();
        if (!docSnap.exists) {
            console.warn(`Intento de actualizar documento no existente en Firestore: ${itemId}. Posiblemente ya eliminado o error de sincronizaci√≥n.`);
            showToast("Advertencia: El art√≠culo ya no existe en la base de datos. Actualizando lista.", false);
            renderShoppingList(); // Re-renderiza la lista para reflejar el estado actual de Firestore
            return;
        }

        // Si el documento existe, procede con la actualizaci√≥n del estado
        await itemRef.update({
            estado: newStatus,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        });
        // El listener de Firestore se encargar√° de actualizar la UI y los contadores.
    } catch (err) {
        console.error("Error al cambiar el estado del art√≠culo:", err);
        showToast(`Error: ${err.message}. Restaurando datos...`, true);
        initializeApp(); // Recarga completa en caso de error grave en la actualizaci√≥n
    }
}

async function handleDeleteShoppingItem(itemId) {
    // Obtenemos el tipo de ID para decidir si es un art√≠culo del Chef o manual
    const isChefItem = itemId.startsWith('ITEM-');
    
    // Confirmaci√≥n visual
    showToast("Eliminando art√≠culo...", false);

    try {
        const itemRef = db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(itemId);
        const docSnap = await itemRef.get();

        if (!docSnap.exists) {
            console.warn(`Intento de eliminar documento no existente en Firestore: ${itemId}.`);
            showToast("Advertencia: El art√≠culo ya no existe en la base de datos. Actualizando lista.", false);
            renderShoppingList();
            return;
        }

        // Realiza la eliminaci√≥n en Firestore
        await itemRef.delete();

        // Si es un art√≠culo del Chef, su contador ya se ajustar√≠a al marcar "Comprado" y eliminarse.
        // Para asegurar la consistencia y para art√≠culos manuales, ajustamos el contador aqu√≠.
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        const itemData = docSnap.data(); // Obtenemos el estado actual antes de la eliminaci√≥n
        
        if (itemData.estado === 'Pendiente') {
            await countsRef.update({ shoppingPendingCount: firebase.firestore.FieldValue.increment(-1) });
        } else if (itemData.estado === 'Comprado') {
            await countsRef.update({ shoppingBoughtCount: firebase.firestore.FieldValue.increment(-1) });
        }
        
        // Actualizaci√≥n optimista de la UI (ya se har√° por el onSnapshot, pero por si acaso)
        const index = appData.shoppingList.findIndex(item => item.id === itemId);
        if (index > -1) {
            appData.shoppingList.splice(index, 1);
        }
        renderShoppingListContent(appData.shoppingList);
        updateShoppingCounts(appData.shoppingList); // Actualiza los badges locales

        showToast('Art√≠culo eliminado con √©xito.');

    } catch (err) {
        console.error("Error al eliminar art√≠culo de compras:", err);
        showToast(`Error al eliminar: ${err.message}. Restaurando datos...`, true);
        initializeApp();
    }
}

function updateMultiSelectButtonState() {
    const multiSelectBtn = document.getElementById('multi-select-toggle-btn');
    if (!multiSelectBtn) return;
    const selectedCount = document.querySelectorAll('.shopping-item-checkbox:checked').length;
    multiSelectBtn.disabled = selectedCount === 0;
    multiSelectBtn.textContent = selectedCount > 0 ? `Marcar ${selectedCount} para comprar` : 'Marcar para comprar';
}

async function toggleSelectedItemsToPending() {
    const selectedIds = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.id);
    if (selectedIds.length === 0) return;

    showSpinner(`Moviendo ${selectedIds.length} art√≠culos...`);
    const batch = db.batch();
    selectedIds.forEach(id => {
        const docRef = db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(id);
        batch.update(docRef, { 
            estado: 'Pendiente',
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        });
    });
    try {
        await batch.commit();
        showToast('Art√≠culos movidos a pendientes.');
    } catch (err) {
        console.error("Error en lote:", err);
        showToast(`Error: ${err.message}.`, true);
    } finally {
        hideSpinner();
    }
}

function renderAddArticleForm() {
    navigationHistory.push(renderShoppingList);
    updateBackButton();
    mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>‚ûï A√±adir Art√≠culo</h2></div>
          <div class="form-card">
              <label>Descripci√≥n del art√≠culo</label> <textarea id="article-description" rows="2" required></textarea>
              <label>¬øCada cu√°ntos d√≠as lo compras? (0 si es ocasional)</label> <input type="number" id="article-cycle" value="0" min="0" step="1" required />
              <button id="add-article-send-btn" disabled>A√±adir</button>
          </div>
      </div>`;
    const sendBtn = document.getElementById('add-article-send-btn');
    const descriptionInput = document.getElementById('article-description');
    descriptionInput.oninput = () => { const isEnabled = descriptionInput.value.trim() !== ''; sendBtn.disabled = !isEnabled; sendBtn.classList.toggle('enabled', isEnabled); };
    sendBtn.onclick = addArticle;
}

async function addArticle() {
    const description = document.getElementById('article-description').value.trim();
    const cycle = parseInt(document.getElementById('article-cycle').value, 10) || 0;
    if (!description) return;

    const emoji = findEmojiForText(description);
    const finalDescription = emoji ? `${emoji} ${description}` : description;

    goBack();
    showToast('A√±adiendo art√≠culo...');

    try {
        const customId = generateCustomId('G-'); // Generar ID personalizado
        await db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(customId).set({
            articulo: finalDescription,
            cycle: cycle,
            estado: 'Pendiente',
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (err) { 
        console.error("Error al a√±adir art√≠culo:", err);
        showToast(`Error: ${err.message}.`, true);
    }
}

function renderEditShoppingItemForm(item) {
    navigationHistory.push(renderShoppingList);
    updateBackButton();
    mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>‚úèÔ∏è Editar Art√≠culo</h2></div>
          <div class="form-card">
              <label>Descripci√≥n</label> <textarea id="article-description" rows="2" required>${item.articulo}</textarea>
              <label>Ciclo de compra (d√≠as)</label> <input type="number" id="article-cycle" value="${item.cycle}" min="0" step="1" required />
              <button id="edit-article-send-btn" class="enabled">Guardar Cambios</button>
          </div>
      </div>`;
    document.getElementById('edit-article-send-btn').onclick = () => saveEditedShoppingItem(item.id);
}

async function saveEditedShoppingItem(itemId) {
    const newDescription = document.getElementById('article-description').value.trim();
    const newCycle = parseInt(document.getElementById('article-cycle').value, 10) || 0;
    if (!newDescription) return;

    const emoji = findEmojiForText(newDescription);
    const finalDescription = emoji ? `${emoji} ${newDescription}` : newDescription;
    
    goBack();
    showToast('Guardando cambios...');

    try {
        await db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(itemId).update({
            articulo: finalDescription,
            cycle: newCycle
        });
    } catch (err) {
        console.error("Error al editar:", err);
        showToast(`Error: ${err.message}.`, true);
    }
}

// ==================================================
// --- M√ìDULO: NOTAS (L√ìGICA OPTIMISTA PROFESIONAL) ---
// ==================================================

// Funci√≥n interna para dibujar la lista de notas desde la memoria (es r√°pida)
function drawNotesList() {
    const notesListUl = document.getElementById('notes-list');
    if (!notesListUl) return; // No hacer nada si el contenedor no est√° en pantalla

    if (!appData.notesList || appData.notesList.length === 0) {
        notesListUl.innerHTML = '<div class="no-data-msg">üìù<br>No tienes notas guardadas.</div>';
        return;
    }

    // Ordenar las notas en memoria por fecha (m√°s recientes primero) antes de dibujarlas
    appData.notesList.sort((a, b) => (new Date(b.FechaRaw) - new Date(a.FechaRaw)));

    const listHtml = appData.notesList.map(note => `
        <li class="list-item" id="item-${note.Nota_ID}">
            <div class="list-item-content">
                <span class="list-item-title">${note.Titulo}</span>
                <span class="list-item-subtitle">${note.Fecha}</span>
                <p style="margin-top: 8px; white-space: pre-wrap; word-wrap: break-word;">${note.Descripcion}</p>
            </div>
            <div class="list-item-actions">
                <button class="generic-menu-btn" data-menu-id="menu-item-${note.Nota_ID}">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-item-${note.Nota_ID}">
                    <a class="dropdown-item" data-action="edit-note" data-note-id="${note.Nota_ID}">Editar</a>
                    <a class="dropdown-item" data-action="delete-note" data-note-id="${note.Nota_ID}">Eliminar</a>
                </div>
            </div>
        </li>`).join('');
    
    notesListUl.innerHTML = listHtml;
}

// Funci√≥n principal que se conecta a Firestore CADA VEZ que se entra
async function renderNotesList() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    
    mainContentArea.innerHTML = `<div class="list-container">
                                <div class="list-header"><h2>Mis Notas</h2></div>
                                <div class="add-article-btn-container"><button class="add-article-btn" id="create-new-note-btn">Crear Nueva Nota</button></div>
                                <ul class="list-style-none" id="notes-list"><div class="no-data-msg">Cargando notas...</div></ul>
                             </div>`;
    document.getElementById('create-new-note-btn').onclick = () => renderNoteForm();
    document.getElementById('notes-list').addEventListener('click', e => {
        const target = e.target.closest('.dropdown-item');
        if (!target) return;
        const action = target.dataset.action;
        const noteId = target.dataset.noteId;
        if (action === 'edit-note') {
            const note = appData.notesList.find(n => n.Nota_ID === noteId);
            if (note) renderNoteForm(note);
        } else if (action === 'delete-note') {
            confirmDelete('note', noteId);
        }
    });

    showSpinner();
    try {
        const notesRef = db.collection(`users/${chatId}/notas`);
        const snapshot = await notesRef.get();

        appData.notesList = []; // Limpiamos la lista en memoria para asegurar datos frescos
        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                const data = doc.data();
                const fecha = data.fecha && data.fecha.toDate ? data.fecha.toDate() : new Date(0);
                appData.notesList.push({
                    Nota_ID: doc.id,
                    Titulo: data.titulo || 'Sin T√≠tulo',
                    Descripcion: data.descripcion || '',
                    Fecha: fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    FechaRaw: fecha.toISOString() // Guardamos la fecha real para ordenar
                });
            });
        }
        
        drawNotesList(); // Llamamos a la funci√≥n r√°pida para dibujar la lista

    } catch (error) {
        console.error("Error al cargar notas desde Firestore: ", error);
        showToast("Error al cargar las notas.", true);
        document.getElementById('notes-list').innerHTML = '<div class="no-data-msg">üîå<br>Error de conexi√≥n al cargar notas.</div>';
    } finally {
        hideSpinner();
    }
}

function renderNoteForm(note = null) {
    navigationHistory.push(renderNotesList);
    updateBackButton();
    const isEditing = note && note.Nota_ID;
    mainContentArea.innerHTML = `<div class="list-container">
                                <div class="list-header"><h2>${isEditing ? '‚úèÔ∏è Editar Nota' : '‚ûï Nueva Nota'}</h2></div>
                                <div class="form-card">
                                    <label>T√≠tulo</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}" required />
                                    <label>Descripci√≥n</label><textarea id="note-description" rows="8" required>${isEditing ? note.Descripcion : ''}</textarea>
                                    <div class="button-group">
                                        <button id="cancel-note-btn" class="cancel">Cancelar</button>
                                        <button id="save-note-btn" data-note-id="${isEditing ? note.Nota_ID : ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button>
                                    </div>
                                </div>
                             </div>`;
    const titleInput = document.getElementById('note-title');
    const descriptionInput = document.getElementById('note-description');
    const saveBtn = document.getElementById('save-note-btn');
    
    function validate() {
        const isEnabled = titleInput.value.trim() !== '' && descriptionInput.value.trim() !== '';
        saveBtn.disabled = !isEnabled;
        saveBtn.classList.toggle('enabled', isEnabled);
    }
    titleInput.oninput = validate;
    descriptionInput.oninput = validate;
    saveBtn.onclick = saveNote;
    document.getElementById('cancel-note-btn').onclick = goBack;
    validate();
}

async function saveNote() {
    const saveBtn = document.getElementById('save-note-btn');
    const title = document.getElementById('note-title').value.trim();
    const description = document.getElementById('note-description').value.trim();
    const noteId = saveBtn.dataset.noteId;
    const isEditing = !!noteId;

    // --- L√ìGICA OPTIMISTA (se mantiene) ---
    if (isEditing) {
        const noteIndex = appData.notesList.findIndex(n => n.Nota_ID === noteId);
        if (noteIndex > -1) { appData.notesList[noteIndex].Titulo = title; appData.notesList[noteIndex].Descripcion = description; }
    } else {
        const now = new Date();
        const tempId = 'temp-' + now.getTime();
        appData.notesList.unshift({ Nota_ID: tempId, Titulo: title, Descripcion: description, Fecha: now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }), FechaRaw: now.toISOString() });
        appData.counts.notesCount++;
    }
    goBack();
    drawNotesList();
    const notesBadge = document.getElementById('notes-badge');
    if(notesBadge) notesBadge.textContent = appData.counts.notesCount;
    showToast(isEditing ? 'Nota guardada' : 'Nota creada');
    
    // --- SINCRONIZACI√ìN EN SEGUNDO PLANO CON FIRESTORE ---
    try {
        const notesRef = db.collection('users').doc(chatId).collection('notas');
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

        if (isEditing) {
            await notesRef.doc(noteId).update({
                titulo: title,
                descripcion: description,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("Nota editada en Firestore con √©xito.");
        } else {
            const customId = generateCustomId('G-'); // Generar ID personalizado
            await notesRef.doc(customId).set({
                titulo: title,
                descripcion: description,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            });
            await countsRef.update({
                notesCount: firebase.firestore.FieldValue.increment(1)
            });
            console.log("Nota creada y contador actualizado en Firestore.");
        }
    } catch (error) {
        console.error("Error sincronizando nota con Firestore:", error);
        showToast("Error de sincronizaci√≥n. Recargando...", true);
        setTimeout(() => initializeApp(), 1500);
    }
}
// ==================================================
// --- M√ìDULO: GASTOS (ACTUALIZADO CON FIRESTORE) ---
// ==================================================
// Las funciones de Gastos se mantienen con la l√≥gica existente,
// pero las llamadas al backend ahora usar√°n las funciones adaptadas a Firestore.

let gastosEncontrados = [];
let pieChartInstance = null, dailyChartInstance = null, monthlyChartInstance = null;

const categoriasGastos = {
    "üè† Gastos del hogar": ["üîë Alquiler o hipoteca", "üí° Servicios (agua, luz, gas, electricidad)", "üåê Internet y tel√©fono", "üîß Mantenimiento y reparaciones", "üõãÔ∏è Mobiliario y electrodom√©sticos"],
    "üßæ Gastos personales": ["üõí Alimentaci√≥n y supermercado", "üëï Ropa y calzado", "üíä Salud (seguros, medicamentos, Farmacia, consultas)", "üéì Educaci√≥n y formaci√≥n", "üíà Cuidado personal (peluquer√≠a, cosm√©tica)"],
    "üöó Transporte": ["‚õΩ Combustible", "üöå Transporte p√∫blico", "üõ°Ô∏è Seguro del veh√≠culo", "üõ†Ô∏è Mantenimiento y reparaciones", "üÖøÔ∏è Estacionamiento y peajes"],
    "üçΩÔ∏è Entretenimiento y ocio": ["‚òï Restaurantes y caf√©s", "üé≠ Cine, teatro, conciertos", "üì∫ Suscripciones (Netflix, Spotify, etc.)", "‚úàÔ∏è Vacaciones y viajes", "‚öΩ Actividades deportivas o hobbies"],
    "üíº Finanzas y seguros": ["üí≥ Pr√©stamos o cr√©ditos", "üìà Ahorros e inversiones", "üìÑ Seguros (vida, hogar, salud, etc.)", "üí∏ Impuestos y tasas"],
    "üéÅ Otros": ["üéâ Regalos y celebraciones", "‚ù§Ô∏è Donaciones o caridad", "üêæ Mascotas (comida, veterinario, etc.)"]
};

function renderInstructionScreen() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"></div>
            <div class="scan-instruction-screen">
                <h2>Escanear un Ticket de Gasto</h2>
                <ol>
                    <li>Para un resultado √≥ptimo, aseg√∫rate de que el texto sea legible, con buena luz y sin sombras.</li>
                    <li>Pulsa el bot√≥n de abajo para continuar.</li>
                </ol>
                <div class="add-article-btn-container">
                    <button class="add-article-btn" id="scan-ticket-button">üì∏ Subir o Tomar Foto del Ticket</button>
                </div>
            </div>
        </div>`;
    
    const scanButton = document.getElementById('scan-ticket-button');
    if (scanButton) {
        scanButton.onclick = () => {
            // Usamos la API nativa de popups de Telegram para una mejor experiencia
            if (tg && tg.showPopup) {
                tg.showPopup({
                    title: 'Subir Ticket',
                    message: '¬øC√≥mo quieres a√±adir la foto de tu ticket?',
                    buttons: [
                        {id: 'camera', type: 'default', text: 'Tomar Foto üì∏'},
                        {id: 'gallery', type: 'default', text: 'Elegir de la Galer√≠a üñºÔ∏è'},
                        {type: 'cancel'},
                    ]
                }, (buttonId) => {
                    // El callback nos dice qu√© bot√≥n se puls√≥
                    if (buttonId === 'camera') {
                        triggerGastoImageInput('camera'); // Llamar√° a la funci√≥n que crearemos en el paso 2
                    } else if (buttonId === 'gallery') {
                        triggerGastoImageInput('gallery'); // Llamar√° a la funci√≥n que crearemos en el paso 2
                    }
                });
            } else {
                // Si la API de Telegram no est√° disponible (ej. en un navegador normal), 
                // por defecto abrimos la galer√≠a.
                triggerGastoImageInput('gallery');
            }
        };
    }
}
function triggerGastoImageInput(source) {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*'; // Aceptamos cualquier tipo de imagen
    fileInput.style.display = 'none';

    // ¬°Esta es la clave! El atributo 'capture' fuerza la apertura de la c√°mara.
    if (source === 'camera') {
        fileInput.capture = 'camera';
    }

    // El resto del flujo para procesar la imagen se mantiene igual
    fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) {
             // Si el usuario cancela, nos aseguramos de limpiar el elemento
             if (document.body.contains(fileInput)) {
                document.body.removeChild(fileInput);
            }
            return;
        }
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('image-preview-element').src = e.target.result;
            document.getElementById('image-preview-overlay').style.display = 'flex';
        };
        reader.readAsDataURL(file);
        
        // Limpiamos el input del DOM despu√©s de su uso
        if (document.body.contains(fileInput)) {
            document.body.removeChild(fileInput);
        }
    };

    document.body.appendChild(fileInput);
    fileInput.click();
}

async function handleImageScan() {
    if (!selectedImageFile) {
        showToast('No se ha seleccionado ninguna imagen.', true);
        return;
    }
    document.getElementById('image-preview-overlay').style.display = 'none';
    showSpinner();
    const formData = new FormData();
    formData.append('file', selectedImageFile, selectedImageFile.name);
    try {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 60000);
        const response = await fetch(makeTicketWebhookUrl, { method: 'POST', body: formData, signal: controller.signal });
        clearTimeout(id);
        if (!response.ok) { throw new Error(`Error del servidor de Make: ${response.status}`); }
        const resultText = await response.text();
        const resultJson = JSON.parse(resultText);
        if(resultJson.tipo && resultJson.tipo.toUpperCase() === 'GASTO') {
            renderAddGastoForm(resultJson);
        } else {
            throw new Error(resultJson.datos.motivo || 'El ticket no parece ser un gasto v√°lido.');
        }
    } catch (error) {
        console.error('Error al escanear el ticket:', error);
        showToast(`Error al procesar: ${error.message}`, true);
    } finally {
        hideSpinner();
        selectedImageFile = null;
    }
}

document.getElementById('preview-cancel-btn').onclick = () => {
    document.getElementById('image-preview-overlay').style.display = 'none';
    selectedImageFile = null;
};
document.getElementById('preview-send-btn').onclick = handleImageScan;

function renderAddGastoForm(initialData = null) {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    const data = initialData ? initialData.datos : {};
    const categoriasOptions = Object.keys(categoriasGastos).map(cat => `<option value="${cat}" ${data.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üí∞ Nuevo Gasto</h2></div>
            <div class="form-card" id="item-new">
                <label>Importe</label> <input type="number" id="gasto-importe" placeholder="Ej: 15.50" step="0.01" value="${data.importe_total || ''}" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" placeholder="Ej: Supermercado" value="${data.establecimiento || ''}" required />
                <label>Categor√≠a</label>
                <select id="gasto-categoria" required><option value="">-- Selecciona una categor√≠a --</option>${categoriasOptions}</select>
                <label>Subcategor√≠a</label>
                <select id="gasto-subcategoria" required disabled><option value="">-- Selecciona una subcategor√≠a --</option></select>
                <label>Fecha</label> <input type="text" id="gasto-fecha" required />
                <div class="button-group">
                    <button id="cancel-gasto-btn" class="cancel">Cancelar</button>
                    <button id="save-gasto-btn" disabled>Registrar Gasto</button>
                </div>
            </div>
        </div>`;

    document.getElementById('cancel-gasto-btn').onclick = goBack;
    const categoriaSelect = document.getElementById('gasto-categoria'), subcategoriaSelect = document.getElementById('gasto-subcategoria'), saveBtn = document.getElementById('save-gasto-btn');
    const elementsToValidate = [ document.getElementById('gasto-importe'), document.getElementById('gasto-establecimiento'), document.getElementById('gasto-fecha'), categoriaSelect, subcategoriaSelect ];
    function validateGastoForm() { const allValid = elementsToValidate.every(el => el.value && el.value.trim() !== ''); saveBtn.disabled = !allValid; saveBtn.classList.toggle('enabled', allValid); }
    let defaultDate = new Date();
    if(data.fecha) {
        const dateTimeParts = data.fecha.split(' ');
        const dateParts = dateTimeParts[0].split('/');
        if(dateParts.length === 3) {
            const year = parseInt(dateParts[2], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[0], 10);
            if(dateTimeParts.length > 1) {
                const timeParts = dateTimeParts[1].split(':');
                if(timeParts.length >= 2) {
                    const hours = parseInt(timeParts[0], 10);
                    const minutes = parseInt(timeParts[1], 10);
                    defaultDate = new Date(year, month, day, hours, minutes);
                } else {
                   defaultDate = new Date(year, month, day);
                }
            } else {
                defaultDate = new Date(year, month, day);
            }
        }
    }
    flatpickr("#gasto-fecha", { defaultDate: defaultDate, dateFormat: "d/m/Y H:i", enableTime: true, locale: "es", onChange: validateGastoForm });
    elementsToValidate.forEach(el => el.oninput = validateGastoForm);
    categoriaSelect.onchange = () => {
        const selectedCategory = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">-- Selecciona una subcategor√≠a --</option>';
        if (selectedCategory && categoriasGastos[selectedCategory]) {
            const subcategoriasOptions = categoriasGastos[selectedCategory].map(sub => `<option value="${sub}" ${data.subcategoria === sub ? 'selected' : ''}>${sub}</option>`).join('');
            subcategoriaSelect.innerHTML += subcategoriasOptions;
            subcategoriaSelect.disabled = false;
        } else { subcategoriaSelect.disabled = true; }
        validateGastoForm();
    };
    saveBtn.onclick = () => saveGasto();
    if (initialData) {
        categoriaSelect.dispatchEvent(new Event('change'));
        if(data.subcategoria) { subcategoriaSelect.value = data.subcategoria; }
    }
    validateGastoForm();
}

async function saveGasto() {
    try {
        showSpinner("Registrando gasto...");
        const fechaGastoObj = document.getElementById('gasto-fecha')._flatpickr.selectedDates[0];
        const importe = parseFloat(document.getElementById('gasto-importe').value.replace(',', '.'));
        const establecimiento = document.getElementById('gasto-establecimiento').value;
        const categoria = document.getElementById('gasto-categoria').value;
        const subCategoria = document.getElementById('gasto-subcategoria').value;
        const mesAnio = `${(fechaGastoObj.getMonth() + 1).toString().padStart(2, '0')}/${fechaGastoObj.getFullYear()}`;

        const gastoData = {
            importe, establecimiento, categoria, subCategoria,
            fecha: fechaGastoObj,
            mesAnio: mesAnio
        };

        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        const newGastoRef = db.collection('users').doc(chatId).collection('gastos').doc(generateCustomId('G-')); // Generar Ref con ID

        await db.runTransaction(async (transaction) => {
            const countsDoc = await transaction.get(countsRef);
            if (!countsDoc.exists) throw "Documento de contadores no encontrado.";
            
            const currentCounts = countsDoc.data();
            const nuevoTotalGastos = (currentCounts.gastosMesActual || 0) + importe;
            const mesesActivos = currentCounts.mesesActivosGastos || [];
            if (!mesesActivos.includes(mesAnio)) mesesActivos.push(mesAnio);

            transaction.set(newGastoRef, gastoData); // Crear el documento del gasto
            transaction.update(countsRef, {
                gastosMesActual: nuevoTotalGastos,
                mesesActivosGastos: mesesActivos
            });
        });

        appData.counts.gastosMesActual = (appData.counts.gastosMesActual || 0) + importe;
        if (!appData.counts.mesesActivosGastos.includes(mesAnio)) appData.counts.mesesActivosGastos.push(mesAnio);

        goBack();
        renderDashboard();
        showToast('Gasto registrado con √©xito.');

    } catch (err) {
        console.error("Error en saveGasto():", err);
        showToast(`Error: ${err.message}.`, true);
    } finally {
        hideSpinner();
    }
}

function renderGastoChart() {
  navigationHistory.push(renderDashboard);
  updateBackButton();

  const mesesOrdenados = (appData.counts.mesesActivosGastos || []).sort((a, b) => {
      const [mesA, anioA] = a.split('/');
      const [mesB, anioB] = b.split('/');
      return new Date(anioB, mesB - 1) - new Date(anioA, mesA - 1);
  });
  
  const mesesOptions = mesesOrdenados.map(mes => `<option value="${mes}">${mes}</option>`).join('');
  
  mainContentArea.innerHTML = `
    <div class="list-container">
      <div class="list-header"><h2>An√°lisis de Gastos</h2></div>
      <div class="form-card">
        <label>Detalle por Mes</label>
        <select id="gasto-chart-mes-select"><option value="">-- Selecciona un mes para ver gr√°ficos --</option>${mesesOptions}</select>
        <div class="gasto-chart-container" id="chart-container-pie" style="margin-top:20px; display:none;"><canvas id="pieChartCanvas"></canvas></div>
        <ul class="gasto-legend" id="gasto-legend-container"></ul>
        <hr style="margin: 25px 0; border-top: 1px solid #eee; display:none;" id="hr1">
        <div class="gasto-chart-container" id="chart-container-daily" style="position: relative; height:300px; display:none;"><canvas id="dailyChartCanvas"></canvas></div>
        <hr style="margin: 25px 0; border-top: 1px solid #eee; display:none;" id="hr2">
        <div class="gasto-chart-container" id="chart-container-monthly" style="position: relative; height:300px; display:none;"><canvas id="monthlyChartCanvas"></canvas></div>
      </div>
    </div>`;
  document.getElementById('gasto-chart-mes-select').onchange = fetchAndDisplayGastoChart;
}

async function fetchAndDisplayGastoChart(event) {
    const mesAnio = event.target.value;
    if (pieChartInstance) pieChartInstance.destroy();
    if (dailyChartInstance) dailyChartInstance.destroy();
    if (monthlyChartInstance) monthlyChartInstance.destroy();
    
    document.getElementById('gasto-legend-container').innerHTML = '';
    ['chart-container-pie', 'chart-container-daily', 'chart-container-monthly', 'hr1', 'hr2'].forEach(id => document.getElementById(id).style.display = 'none');
    
    if (!mesAnio) return;
    
    showSpinner("Generando gr√°ficos...");
    try {
        // --- 1. Obtener datos del mes seleccionado ---
        const [mes, anio] = mesAnio.split('/').map(Number);
        const startDate = new Date(anio, mes - 1, 1);
        const endDate = new Date(anio, mes, 0, 23, 59, 59);

        const gastosRef = db.collection('users').doc(chatId).collection('gastos');
        const qMes = gastosRef.where('fecha', '>=', startDate).where('fecha', '<=', endDate);
        const snapshotMes = await qMes.get();
        const gastosDelMes = snapshotMes.docs.map(doc => ({ ...doc.data(), id: doc.id }));

        // --- 2. Obtener datos de los √∫ltimos 6 meses para el gr√°fico de barras ---
        const monthlyEndDate = new Date();
        const monthlyStartDate = new Date();
        monthlyStartDate.setMonth(monthlyStartDate.getMonth() - 5);
        monthlyStartDate.setDate(1);

        const qMonthly = gastosRef.where('fecha', '>=', monthlyStartDate).where('fecha', '<=', monthlyEndDate);
        const snapshotMonthly = await qMonthly.get();
        const gastosUltimosMeses = snapshotMonthly.docs.map(doc => doc.data());

        // --- 3. Procesar todos los datos ---
        const data = procesarDatosParaGrafico(gastosDelMes, gastosUltimosMeses, mesAnio);
        if (data.error) throw new Error(data.error);
        
        // --- 4. Dibujar los gr√°ficos ---
        Chart.register(ChartDataLabels);
        const paletaDeColores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        const moneda = appData.settings.moneda || '‚Ç¨';
        
        // Gr√°fico de Pastel (Pie Chart)
        if (data.pieData && data.pieData.data.length > 0) {
            document.getElementById('chart-container-pie').style.display = 'block';
            const pieCtx = document.getElementById('pieChartCanvas').getContext('2d');
            pieChartInstance = new Chart(pieCtx, { type: 'pie', data: { labels: data.pieData.labels, datasets: [{ data: data.pieData.data, backgroundColor: paletaDeColores, borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, plugins: { title: { display: true, text: data.tituloPie + ' ' + moneda, font: { size: 18 } }, legend: { display: false }, datalabels: { formatter: (v,c) => { const total = c.chart.data.datasets[0].data.reduce((a,b) => a+b,0); return total > 0 ? (v/total*100).toFixed(0)+'%' : '0%';}, color:'#fff',font:{weight:'bold',size:16}}, tooltip: { callbacks: { label: c => `${c.label}: ${parseFloat(c.raw).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})} ${moneda}`}}}}});
            document.getElementById('gasto-legend-container').innerHTML = data.datosParaLeyenda.map(item => `<li class="gasto-legend-item"><span class="gasto-legend-color" style="background-color:${item.color};"></span><div>${item.categoria}: <strong>${item.importe} ${moneda}</strong></div></li>`).join('');
        }

        // Gr√°fico de L√≠neas (Evoluci√≥n Diaria)
        if (data.dailyData && data.dailyData.data.length > 0) {
            document.getElementById('hr1').style.display = 'block';
            document.getElementById('chart-container-daily').style.display = 'block';
            const dailyCtx = document.getElementById('dailyChartCanvas').getContext('2d');
            dailyChartInstance = new Chart(dailyCtx, { type: 'line', data: { labels: data.dailyData.labels, datasets: [{ label: 'Gasto Diario (' + moneda + ')', data: data.dailyData.data, borderColor: '#4BC0C0', fill: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `Evoluci√≥n Diaria - ${mesAnio}`, font: { size: 18 } }, legend: { display: false }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.formattedValue} ${moneda}`}}}}});
        }
        
        // Gr√°fico de Barras (Comparativa Mensual)
        if (data.monthlyData && data.monthlyData.data.length > 0) {
            document.getElementById('hr2').style.display = 'block';
            document.getElementById('chart-container-monthly').style.display = 'block';
            const monthlyCtx = document.getElementById('monthlyChartCanvas').getContext('2d');
            monthlyChartInstance = new Chart(monthlyCtx, { type: 'bar', data: { labels: data.monthlyData.labels, datasets: [{ label: 'Gasto Mensual (' + moneda + ')', data: data.monthlyData.data, backgroundColor: '#36A2EB' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Evoluci√≥n de Gastos Mensuales', font: { size: 18 } }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.formattedValue} ${moneda}`}}}}});
        }

    } catch (err) {
        showToast(`No se pudo generar el gr√°fico: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function procesarDatosParaGrafico(gastosDelMes, gastosUltimosMeses, mesAnioSeleccionado) {
    // --- L√≥gica para Gr√°fico de Pastel y Leyenda ---
    const datosParaLeyenda = [];
    const gastosPorCategoria = gastosDelMes.reduce((acc, gasto) => {
        const cat = gasto.categoria || 'Sin categor√≠a';
        acc[cat] = (acc[cat] || 0) + (gasto.importe || 0);
        return acc;
    }, {});
    const pieData = { labels: Object.keys(gastosPorCategoria), data: Object.values(gastosPorCategoria) };
    const paletaDeColores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    pieData.labels.forEach((label, index) => {
        datosParaLeyenda.push({ categoria: label, importe: pieData.data[index].toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), color: paletaDeColores[index % paletaDeColores.length] });
    });
    const totalGastosMes = gastosDelMes.reduce((sum, g) => sum + (g.importe || 0), 0);
    
    // --- L√≥gica para Gr√°fico de L√≠neas (Evoluci√≥n Diaria) ---
    const diasEnMes = new Date(mesAnioSeleccionado.split('/')[1], mesAnioSeleccionado.split('/')[0], 0).getDate();
    const dailyData = { labels: Array.from({ length: diasEnMes }, (_, i) => i + 1), data: Array(diasEnMes).fill(0) };
    gastosDelMes.forEach(gasto => {
        if (gasto.fecha && typeof gasto.fecha.toDate === 'function') {
            const dia = gasto.fecha.toDate().getDate();
            dailyData.data[dia - 1] += gasto.importe || 0;
        }
    });

    // --- L√≥gica para Gr√°fico de Barras (Comparativa Mensual) ---
    const monthlyData = { labels: [], data: [] };
    const gastosPorMes = {};
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const mes = (d.getMonth() + 1).toString().padStart(2, '0');
        const anio = d.getFullYear();
        monthlyData.labels.push(`${mes}/${anio}`);
        gastosPorMes[`${mes}/${anio}`] = 0;
    }
    gastosUltimosMeses.forEach(gasto => {
        if (gasto.mesAnio && gastosPorMes.hasOwnProperty(gasto.mesAnio)) {
            gastosPorMes[gasto.mesAnio] += gasto.importe || 0;
        }
    });
    monthlyData.data = Object.values(gastosPorMes);

    return {
        pieData,
        datosParaLeyenda,
        tituloPie: `Total Gastos ${mesAnioSeleccionado}: ${totalGastosMes.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
        dailyData,
        monthlyData
    };
}

function renderGastosSearchScreen(gastos = null) {
	updateBackButton();
    let resultsHtml = '';
    let legendDisplay = 'none';

    if (gastos) {
        if (gastos.length > 0) {
            // L√çNEA CORREGIDA: Se usan los nombres de campo correctos (min√∫sculas y 'Fecha' may√∫scula)
            resultsHtml = gastos.map(g => `<li class="list-item clickable" data-id-unico="${g.ID_Unico}"><div class="list-item-content"><span class="list-item-title">${g.establecimiento} - ${Number(g.importe).toLocaleString('es-ES', {minimumFractionDigits: 2})} ${(appData.settings.moneda || '‚Ç¨')}</span><span class="list-item-subtitle">${g.subCategoria || g.categoria} - ${g.Fecha}</span></div></li>`).join('');
            resultsHtml = `<ul class="list-style-none">${resultsHtml}</ul>`;
            legendDisplay = 'block';
        } else {
            resultsHtml = `<div class="no-data-msg" style="padding: 20px;">No se encontraron gastos.</div>`;
        }
    }

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üîé Buscar Gastos</h2></div>
            <div class="form-card">
                <label>Fecha de Inicio</label> <input type="text" id="gasto-fecha-inicio" required />
                <label>Fecha de Fin</label> <input type="text" id="gasto-fecha-fin" required />
                <button id="search-gasto-btn" class="enabled">Buscar</button>
            </div>
            <p style="text-align: center; color: var(--muted); font-size: 0.9rem; margin-top: 15px; display: ${legendDisplay};">Pulsa sobre un gasto para ver/editarlo</p>
            <div id="gastos-search-results" style="margin-top: 10px;">${resultsHtml}</div>
        </div>`;
        
    const fpConfig = { dateFormat: "d/m/Y", locale: "es" };
    flatpickr("#gasto-fecha-inicio", { ...fpConfig, defaultDate: new Date(new Date().setDate(1)) });
    flatpickr("#gasto-fecha-fin", { ...fpConfig, defaultDate: new Date() });
    
    document.getElementById('search-gasto-btn').onclick = executeSearchGastos;
    
    document.getElementById('gastos-search-results').addEventListener('click', (e) => {
        const item = e.target.closest('.list-item.clickable');
        if (item) {
            const idUnico = item.dataset.idUnico;
            const gasto = gastosEncontrados.find(g => g.ID_Unico === idUnico);
            if(gasto) {
                navigationHistory.push(() => renderGastosSearchScreen(gastosEncontrados));
                updateBackButton();
                renderEditGastoForm(gasto);
            }
        }
    });
}

async function executeSearchGastos() {
    const startDateString = document.getElementById('gasto-fecha-inicio').value;
    const endDateString = document.getElementById('gasto-fecha-fin').value;
    if (!startDateString || !endDateString) {
        showToast('Debes seleccionar ambas fechas.', true);
        return;
    }

    showSpinner("Buscando gastos...");

    try {
        const startParts = startDateString.split('/');
        const endParts = endDateString.split('/');
        const startDateObj = new Date(startParts[2], startParts[1] - 1, startParts[0], 0, 0, 0);
        const endDateObj = new Date(endParts[2], endParts[1] - 1, endParts[0], 23, 59, 59);

        const gastosRef = db.collection('users').doc(chatId).collection('gastos');
        const q = gastosRef.where('fecha', '>=', startDateObj).where('fecha', '<=', endDateObj);
        const snapshot = await q.get();

        gastosEncontrados = snapshot.docs.map(doc => {
            const data = doc.data();
            const fechaGasto = (data.fecha && typeof data.fecha.toDate === 'function') ? data.fecha.toDate() : null;
            
            return {
                ...data,
                ID_Unico: doc.id,
                Fecha: fechaGasto ? fechaGasto.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'Fecha inv√°lida'
            };
        });
        
        // Ordenar resultados por fecha, m√°s reciente primero
        gastosEncontrados.sort((a, b) => {
            const dateA = a.fecha && a.fecha.toDate ? a.fecha.toDate() : 0;
            const dateB = b.fecha && b.fecha.toDate ? b.fecha.toDate() : 0;
            return dateB - dateA;
        });

        renderGastosSearchScreen(gastosEncontrados);

    } catch (err) {
        console.error("Error al buscar gastos:", err);
        showToast(`Error al buscar gastos: ${err.message}`, true);
        renderGastosSearchScreen([]);
    } finally {
        hideSpinner();
    }
}

function renderEditGastoForm(gasto) {
    updateBackButton();
    
    // CORREGIDO: Se usan los nombres de campo en min√∫scula
    const categoriasOptions = Object.keys(categoriasGastos).map(cat => `<option value="${cat}" ${gasto.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
    const subcategoriasOptions = (categoriasGastos[gasto.categoria] || []).map(sub => `<option value="${sub}" ${gasto.subCategoria === sub ? 'selected' : ''}>${sub}</option>`).join('');
    
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>‚úèÔ∏è Ver/Editar Gasto</h2></div>
            <div class="form-card" id="item-${gasto.ID_Unico}">
                <label>Importe</label> <input type="number" id="gasto-importe" value="${gasto.importe}" step="0.01" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" value="${gasto.establecimiento}" required />
                <label>Categor√≠a</label> <select id="gasto-categoria" required>${categoriasOptions}</select>
                <label>Subcategor√≠a</label> <select id="gasto-subcategoria" required>${subcategoriasOptions}</select>
                <label>Fecha</label> <input type="text" id="gasto-fecha" required />
                <div class="button-group">
                    <button id="delete-gasto-btn" class="cancel">Eliminar</button>
                    <button id="save-gasto-btn" disabled>Guardar Cambios</button>
                </div>
            </div>
        </div>`;
    
    const fechaPicker = flatpickr("#gasto-fecha", { defaultDate: gasto.Fecha, dateFormat: "d/m/Y H:i", enableTime: true, locale: "es" });
    const categoriaSelect = document.getElementById('gasto-categoria');
    const subcategoriaSelect = document.getElementById('gasto-subcategoria');
    const importeInput = document.getElementById('gasto-importe');
    const establecimientoInput = document.getElementById('gasto-establecimiento');
    const saveBtn = document.getElementById('save-gasto-btn');
    
    // CORREGIDO: Se usan los nombres de campo en min√∫scula
    const initialValues = { importe: importeInput.value, establecimiento: establecimientoInput.value, categoria: categoriaSelect.value, subcategoria: subcategoriaSelect.value, fecha: fechaPicker.input.value };

    function validateChanges() {
        const currentValues = { importe: importeInput.value, establecimiento: establecimientoInput.value, categoria: categoriaSelect.value, subcategoria: subcategoriaSelect.value, fecha: fechaPicker.input.value };
        const hasChanged = JSON.stringify(initialValues) !== JSON.stringify(currentValues);
        saveBtn.disabled = !hasChanged;
        saveBtn.classList.toggle('enabled', hasChanged);
    }

    [importeInput, establecimientoInput, categoriaSelect, subcategoriaSelect].forEach(el => el.addEventListener('input', validateChanges));
    fechaPicker.config.onChange.push(validateChanges);
    
    categoriaSelect.onchange = () => {
        const selectedCategory = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">-- Selecciona una subcategor√≠a --</option>';
        if (selectedCategory && categoriasGastos[selectedCategory]) {
            subcategoriaSelect.innerHTML += categoriasGastos[selectedCategory].map(sub => `<option value="${sub}">${sub}</option>`).join('');
            subcategoriaSelect.disabled = false;
        } else {
            subcategoriaSelect.disabled = true;
        }
        validateChanges();
    };

    document.getElementById('save-gasto-btn').onclick = () => saveEditedGasto(gasto.ID_Unico);
    document.getElementById('delete-gasto-btn').onclick = () => confirmDelete('gasto', gasto.ID_Unico);
}

/**
 * Guarda un gasto editado, actualiza el documento existente y recalcula los contadores.
 * VERSI√ìN CORREGIDA Y COMPLETA.
 */
async function saveEditedGasto(idUnico) {
    showSpinner("Guardando cambios...");
    try {
        const gastoOriginal = gastosEncontrados.find(g => g.ID_Unico === idUnico);
        if (!gastoOriginal) {
            throw new Error("No se encontr√≥ el gasto original para calcular la diferencia.");
        }

        const importeAntiguo = parseFloat(gastoOriginal.importe);
        const nuevoImporte = parseFloat(document.getElementById('gasto-importe').value);
        const diferencia = nuevoImporte - importeAntiguo;

        const nuevoEstablecimiento = document.getElementById('gasto-establecimiento').value;
        const nuevaCategoria = document.getElementById('gasto-categoria').value;
        const nuevaSubcategoria = document.getElementById('gasto-subcategoria').value;
        const fechaGastoObj = document.getElementById('gasto-fecha')._flatpickr.selectedDates[0];
        const mesAnio = `${(fechaGastoObj.getMonth() + 1).toString().padStart(2, '0')}/${fechaGastoObj.getFullYear()}`;

        const gastoActualizado = { 
            importe: nuevoImporte, 
            establecimiento: nuevoEstablecimiento, 
            categoria: nuevaCategoria, 
            subCategoria: nuevaSubcategoria, 
            fecha: fechaGastoObj,
            mesAnio: mesAnio
        };

        const gastoRef = db.collection('users').doc(chatId).collection('gastos').doc(idUnico);
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

        // Usar un batch para actualizar el gasto y el contador en una sola operaci√≥n at√≥mica.
        const batch = db.batch();
        batch.update(gastoRef, gastoActualizado);
        batch.update(countsRef, {
            gastosMesActual: firebase.firestore.FieldValue.increment(diferencia)
        });
        await batch.commit();
        
        // Actualizar la UI localmente para una respuesta instant√°nea
        appData.counts.gastosMesActual += diferencia;
        
        goBack(); // Vuelve a la lista de b√∫squeda
        goBack(); // Vuelve al dashboard
        renderDashboard(); // Re-renderiza el dashboard para mostrar el nuevo total
        showToast("Gasto actualizado con √©xito.");

    } catch (err) {
        showToast(`Error al guardar: ${err.message}.`, true);
        initializeApp(); // Recarga completa en caso de error grave.
    } finally {
        hideSpinner();
    }
}

// ==================================================
// --- M√ìDULO: CHEF ASISTENTE (VERSI√ìN FINAL) ---
// ==================================================
function renderChefPage() {
    removeCalendarFAB();
	setActiveTab('tab-chef');
    navigationHistory.push(renderDashboard);
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="chef-container">
            <h2 class="settings-section-title">üßë‚Äçüç≥ Chef Asistente</h2>
            <div class="form-card">
                <div class="chef-item">
                    <label>Tipo de Comida</label>
                    <select id="chef-tipo-comida">
                        <option value="Desayuno">üç≥ Desayuno</option>
                        <option value="Almuerzo" selected>ü•ó Almuerzo</option>
                        <option value="Merienda">ü•™ Merienda</option>
                        <option value="Cena">üçù Cena</option>
                    </select>
                </div>
                <div class="chef-item">
                    <label>Hora Aproximada</label>
                    <input type="text" id="chef-hora" style="width: 100px; text-align: center;"/>
                </div>
                <div class="chef-item">
                    <label>N¬∫ de Comensales</label>
                    <input type="number" id="chef-comensales" value="1" min="1" style="width: 80px; text-align: center;"/>
                </div>
                <div class="chef-item">
                    <label>Estilo de Cocina</label>
                    <select id="chef-estilo">
                        <option value="Sorpr√©ndeme">‚ú® Sorpr√©ndeme</option>
                        <option value="R√°pida">üèÉ R√°pida</option>
                        <option value="Casera">üè° Casera</option>
                        <option value="Saludable">üí™ Saludable</option>
                    </select>
                </div>
                <div class="chef-item">
                    <label>¬øIncluir Postre?</label>
                    <label class="switch"><input type="checkbox" id="chef-postre"><span class="slider"></span></label>
                </div>
                <div class="chef-item">
                    <label>Solo con lo que tengo</label>
                    <label class="switch"><input type="checkbox" id="chef-solo-nevera"><span class="slider"></span></label>
                </div>
                <label style="margin-top: 20px;">Tu Petici√≥n Especial</label>
                <textarea id="chef-peticion" rows="3" placeholder="Ej: soy vegano, alergia al marisco, usa el pollo antes de que caduque..."></textarea>
                
                <div id="chef-image-previews"></div>
                <div class="button-group" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
                <button id="chef-take-photo-btn" class="add-article-btn enabled" style="flex: 1; min-width: 150px; background-color: #28a745;">üì∏ Tomar Foto</button>
                <button id="chef-select-gallery-btn" class="add-article-btn enabled" style="flex: 1; min-width: 150px;">üñºÔ∏è Seleccionar de Galer√≠a</button>
            </div>

                <div class="button-group">
                    <button id="chef-cancel-btn" class="cancel">Cancelar/Salir</button>
                    <button id="chef-submit-btn" class="enabled">Obtener Sugerencias</button>
                </div>
            </div>
        </div>`;

    flatpickr("#chef-hora", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, defaultDate: "13:00" });
    document.getElementById('chef-cancel-btn').onclick = goBack;
    
    let selectedFiles = [];

    const previewsContainer = document.getElementById('chef-image-previews');
    const addPhotoButton = document.getElementById('chef-add-photo-btn');

    const updatePreviews = () => {
        previewsContainer.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="preview">
                    <button class="delete-preview-btn" data-index="${index}">&times;</button>
                `;
                previewsContainer.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
        const takePhotoBtn = document.getElementById('chef-take-photo-btn');
    const selectGalleryBtn = document.getElementById('chef-select-gallery-btn');
    if (takePhotoBtn && selectGalleryBtn) {
        if (selectedFiles.length < 2) {
            takePhotoBtn.style.display = 'block';
            selectGalleryBtn.style.display = 'block';
        } else {
            takePhotoBtn.style.display = 'none';
            selectGalleryBtn.style.display = 'none';
        }
    }
    };

    previewsContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('delete-preview-btn')) {
            const index = parseInt(event.target.dataset.index, 10);
            selectedFiles.splice(index, 1);
            updatePreviews();
        }
    });

    // Manejador para el bot√≥n "Tomar Foto"
document.getElementById('chef-take-photo-btn').onclick = () => {
    if (selectedFiles.length >= 2) {
        showToast("Puedes subir un m√°ximo de 2 fotos.", true);
        return;
    }
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.capture = 'camera'; // Intentamos 'camera' gen√©rico o 'environment'
    fileInput.style.display = 'none'; // Ocultar input
    fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
            handleChefImageSelection(file, (confirmedFile) => {
                selectedFiles.push(confirmedFile);
                updatePreviews();
            });
        }
    };
    document.body.appendChild(fileInput); // A√±adir al body para poder hacer click
    fileInput.click();
    document.body.removeChild(fileInput); // Eliminar del body
};

// Manejador para el bot√≥n "Seleccionar de Galer√≠a"
document.getElementById('chef-select-gallery-btn').onclick = () => {
    if (selectedFiles.length >= 2) {
        showToast("Puedes subir un m√°ximo de 2 fotos.", true);
        return;
    }
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none'; // Ocultar input
    fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
            handleChefImageSelection(file, (confirmedFile) => {
                selectedFiles.push(confirmedFile);
                updatePreviews();
            });
        }
    };
    document.body.appendChild(fileInput); // A√±adir al body
    fileInput.click();
    document.body.removeChild(fileInput); // Eliminar del body
};
    
                document.getElementById('chef-submit-btn').onclick = () => {
                if(selectedFiles.length === 0) {
                    showToast("Por favor, sube una foto de tus ingredientes.", true);
                    return;
                }
                executeChefRequest(selectedFiles);
            };
        } // Esta es la llave de cierre de renderChefPage

function handleChefImageSelection(file, callback) {
    const overlay = document.getElementById('image-preview-overlay');
    const imgElement = document.getElementById('image-preview-element');
    const sendBtn = document.getElementById('preview-send-btn');
    const cancelBtn = document.getElementById('preview-cancel-btn');

    sendBtn.textContent = "Usar esta Foto";
    const reader = new FileReader();
    reader.onload = (e) => {
        imgElement.src = e.target.result;
        overlay.style.display = 'flex';
    };
    reader.readAsDataURL(file);

    const cleanup = () => {
        overlay.style.display = 'none';
        sendBtn.onclick = handleImageScan; 
        cancelBtn.onclick = () => {
            document.getElementById('image-preview-overlay').style.display = 'none';
            selectedImageFile = null;
        };
        sendBtn.textContent = "Enviar";
    };

    sendBtn.onclick = () => {
        callback(file);
        cleanup();
    };
    
    cancelBtn.onclick = () => {
        cleanup();
    };
}

// [VERSI√ìN FINAL CON CLOUD FUNCTIONS - CORREGIDA]
// Esta funci√≥n ahora se comunica directamente con nuestro propio backend en Firebase.
async function executeChefRequest(files) {
    showSpinner("Un momento, el Chef est√° trabajando...");
    // URL directa a tu Cloud Function
    const chefFunctionUrl = "https://europe-west1-asistentepersonal-4ad2b.cloudfunctions.net/processChefRequest";

    try {
        const userPreferences = {
            tipoComida: document.getElementById('chef-tipo-comida').value,
            hora: document.getElementById('chef-hora').value,
            comensales: document.getElementById('chef-comensales').value,
            estilo: document.getElementById('chef-estilo').value,
            conPostre: document.getElementById('chef-postre').checked,
            soloNevera: document.getElementById('chef-solo-nevera').checked,
            peticionUsuario: document.getElementById('chef-peticion').value,
        };

        const imagePromises = files.map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64String = event.target.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        });

        const imagesBase64 = await Promise.all(imagePromises);

        const response = await fetch(chefFunctionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: {
                chatId: chatId,
                userPreferences: userPreferences,
                imagesBase64: imagesBase64,
            }})
        });

        if (!response.ok) {
            const errorBody = await response.json();
            throw new Error(errorBody.error.message || `Error del servidor: ${response.status}`);
        }

        const result = await response.json();
                const data = result.result; // Para funciones onCall, el resultado est√° en 'result'
        
        // --- CAMBIO CLAVE: Limpieza profunda de instrucciones aqu√≠ ---
               if (data && data.sugerencias) {
            data.sugerencias.forEach(sug => {
                if (sug.instrucciones_preparacion && Array.isArray(sug.instrucciones_preparacion)) {
                    sug.instrucciones_preparacion = sug.instrucciones_preparacion
                        // Filtra nulos, no-strings, vac√≠os y l√≠neas que solo contienen espacios o caracteres invisibles
                        .filter(step => typeof step === 'string' && step.replace(/\s+/g, '').length > 0)
                        .map(step => step.trim()); // Limpia cada paso restante
                }
            });
        }
        // --- FIN CAMBIO CLAVE ---

        if (data && data.sugerencias) {
            showToast("¬°Aqu√≠ tienes tus sugerencias!");
            renderChefResults(data.sugerencias);
        } else {
            throw new Error("Respuesta inesperada del Chef.");
        }

    } catch (err) {
        console.error("Error definitivo en executeChefRequest:", err);
        showToast(err.message || "Error al contactar al Chef.", true);
    } finally {
        hideSpinner();
    }
}

function renderChefResults(sugerencias) {
    updateBackButton();
    let html = '<div class="chef-container">';
    if (!sugerencias || sugerencias.length === 0) {
        html += '<div class="no-data-msg">üßë‚Äçüç≥<br>El Chef no ha encontrado sugerencias. Int√©ntalo de nuevo con otra foto o petici√≥n.</div>';
    } else {
        sugerencias.forEach((sug, index) => {
            html += `
            <div class="recipe-card" id="recipe-${index}">
                <div class="recipe-header"><h3 class="recipe-title">${sug.titulo_receta}</h3></div>
                <div class="recipe-body">
                    <p class="recipe-description">${sug.descripcion}</p>
                    <h4 class="recipe-subtitle">Ingredientes que ya tienes:</h4>
                    <ul class="recipe-ingredient-list">
                        ${(sug.ingredientes_detectados || []).map(ing => `<li>‚úÖ ${ing}</li>`).join('')}
                    </ul>
                    ${sug.ingredientes_a_comprar && sug.ingredientes_a_comprar.length > 0 ? `
                        <h4 class="recipe-subtitle" style="margin-top:15px;">Necesitar√°s comprar:</h4>
                        <ul class="recipe-ingredient-list buy">
                           ${sug.ingredientes_a_comprar.map(ing => `<li><input type="checkbox" class="buy-checkbox" checked data-item-name="${ing.nombre} (${ing.cantidad})"> ${ing.nombre} (${ing.cantidad})</li>`).join('')}
                        </ul>
                        <button class="add-article-btn" data-action="add-ingredients" style="width:100%; max-width:100%; margin-top:15px;">A√±adir seleccionados a la compra</button>
                    ` : '<p style="color:var(--muted); margin-top:15px;">¬°No necesitas comprar nada para esta receta!</p>'}
                    
                    ${sug.instrucciones_preparacion && sug.instrucciones_preparacion.length > 0 ? `
                        <div class="list-item clickable" style="margin-top:20px; text-align:left;" data-action="toggle-instructions" data-target="instructions-${index}">
                            <div class="list-item-content">
                                <span class="list-item-title">üßë‚Äçüç≥ C√≥mo Preparar</span>
                            </div>
                            <div class="list-item-actions"><span class="expand-arrow">‚ñº</span></div>
                        </div>
                        <div id="instructions-${index}" class="event-description" style="margin-top:0; padding:15px; background:var(--bg); border-radius:0 0 10px 10px; box-shadow:inset 0 2px 5px rgba(0,0,0,0.02); display:none; max-height:0; overflow:hidden; transition:max-height 0.3s ease-out, padding 0.3s ease-out;">
                        <ol style="padding-left:20px; margin-top:0;">
                                ${sug.instrucciones_preparacion
                                    .filter(step => typeof step === 'string' && step.trim().length > 0) // Filtra nulos, no-strings y vac√≠os
                                    .map(step => `<li>${step.trim()}</li>`)
                                    .join('')}
                            </ol>
                        </div>
                    ` : ''}

                    <button class="add-article-btn" data-action="copy-recipe" style="background-color: var(--muted); width:100%; max-width:100%; margin-top:10px;">Copiar Receta</button>
                </div>
            </div>`;
        });
    }
    html += `<div class="form-card" style="margin-top: 20px;"><button data-action="go-home" class="cancel" style="width:100%; max-width:100%; opacity:1; cursor:pointer;">Volver a Inicio</button></div>`;
    html += '</div>';
    
    mainContentArea.innerHTML = html;
    mainContentArea.removeEventListener('click', handleChefResultsClicks);
	            // --- CAMBIO CLAVE: Scroll autom√°tico al inicio de las recetas con retraso ---
    // Esperamos un peque√±o momento para asegurarnos de que el DOM est√© completamente renderizado
    setTimeout(() => {
        const firstRecipeCard = document.getElementById('recipe-0'); // Obtener la primera tarjeta de receta
        if (firstRecipeCard) {
            firstRecipeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            // Como fallback, o si no hay recetas, ir al top del contenedor general del chef
            const chefContainer = document.querySelector('.chef-container');
            if (chefContainer) {
                chefContainer.scrollTop = 0;
            } else {
                mainContentArea.scrollTop = 0;
            }
        }
    }, 100); // Peque√±o retraso de 100ms
    // --- FIN CAMBIO CLAVE ---
    mainContentArea.addEventListener('click', handleChefResultsClicks);
}

function handleChefResultsClicks(event) {
    const button = event.target.closest('[data-action]');
    if (!button) return;
    const action = button.dataset.action;
    switch(action) {
        case 'add-ingredients': addIngredientsToShoppingList(button); break;
        case 'copy-recipe': copyToClipboard(button); break;
        case 'go-home': renderDashboard(); break;
        case 'toggle-instructions': // <--- Nueva acci√≥n para el desplegable
            event.stopPropagation(); // Evitar que el clic se propague m√°s all√° del bot√≥n
            const targetId = button.dataset.target;
            const targetElement = document.getElementById(targetId);
            const parentCard = button.closest('.recipe-card');

            if (targetElement && parentCard) {
                const isOpen = targetElement.style.display === 'block';
                if (isOpen) {
                    targetElement.style.maxHeight = '0';
                    targetElement.style.padding = '0 15px'; // Restablecer padding al cerrar
                    setTimeout(() => { targetElement.style.display = 'none'; }, 300); // Ocultar despu√©s de la transici√≥n
                    parentCard.classList.remove('open'); // Quitar clase 'open' del padre
                } else {
                    targetElement.style.display = 'block';
                    // Forzar el redibujado para que la transici√≥n funcione
                    targetElement.offsetHeight; 
                    targetElement.style.maxHeight = '500px'; // Un valor suficientemente grande
                    targetElement.style.padding = '15px'; // Restaurar padding al abrir
                    parentCard.classList.add('open'); // A√±adir clase 'open' al padre
                }
                const arrow = button.querySelector('.expand-arrow');
                if (arrow) {
                    arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
                }
            }
            break;
    }
}

function copyToClipboard(buttonElement) {
    const recipeCard = buttonElement.closest('.recipe-card');
    const title = recipeCard.querySelector('.recipe-title').innerText;
    const description = recipeCard.querySelector('.recipe-description').innerText;
    let textToCopy = `Receta: ${title}\n\n${description}\n\n`;
    const detectedIngredients = Array.from(recipeCard.querySelectorAll('.recipe-ingredient-list:not(.buy) li')).map(li => `- ${li.innerText.replace('‚úÖ ', '')}`);
    if(detectedIngredients.length > 0) textToCopy += `Ingredientes en casa:\n${detectedIngredients.join('\n')}\n\n`;
    const toBuyIngredients = Array.from(recipeCard.querySelectorAll('.recipe-ingredient-list.buy li')).map(li => `- ${li.innerText.trim()}`);
    if(toBuyIngredients.length > 0) textToCopy += `Ingredientes a comprar:\n${toBuyIngredients.join('\n')}`;
    navigator.clipboard.writeText(textToCopy).then(() => { showToast('Receta copiada al portapapeles'); }).catch(err => { showToast('Error al copiar la receta', true); });
}

/**
 * [VERSI√ìN DEFINITIVA CON SDK DE FIRESTORE Y EMOJI EN EL NOMBRE]
 * A√±ade los ingredientes del Chef a la lista de la compra de forma at√≥mica.
 * El emoji del Chef ahora se concatena directamente en el nombre del art√≠culo.
 */
async function addIngredientsToShoppingList(buttonElement) {
    const recipeCard = buttonElement.closest('.recipe-card');
    const checkboxes = recipeCard.querySelectorAll('.buy-checkbox:checked');
    if (checkboxes.length === 0) {
        showToast("No has seleccionado ning√∫n ingrediente.", true);
        return;
    }
    
    // Concatenar el emoji del Chef directamente en el nombre del art√≠culo
    const itemsToAdd = Array.from(checkboxes).map(cb => `${cb.dataset.itemName} üßë‚Äçüç≥`);
    
    // No mostramos spinner, la operaci√≥n es muy r√°pida.
    // Deshabilitamos el bot√≥n inmediatamente para evitar dobles clics.
    buttonElement.disabled = true;
    
    try {
        const batch = db.batch();
        const shoppingListRef = db.collection('users').doc(chatId).collection('listaDeLaCompra');
        
        itemsToAdd.forEach(finalItemName => {
            const newId = generateCustomId('ITEM-'); // ID espec√≠fico para art√≠culos del Chef
            const newItemRef = shoppingListRef.doc(newId);
            const newItemData = {
                articulo: finalItemName, // El nombre del art√≠culo AHORA incluye el emoji del Chef
                estado: 'Pendiente',
                cycle: 0,
                // Ya no necesitamos 'origen: "chef"', el ID "ITEM-" y el emoji en el nombre lo identifican
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            };
            batch.set(newItemRef, newItemData);
        });

        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        batch.update(countsRef, {
            shoppingPendingCount: firebase.firestore.FieldValue.increment(itemsToAdd.length)
        });

        await batch.commit();

        showToast(`${itemsToAdd.length} ingredientes a√±adidos a la lista.`);
        buttonElement.textContent = 'A√±adido ‚úîÔ∏è';
        // El oyente en tiempo real de la lista de compras se encargar√° de actualizar la UI
        // con los art√≠culos que ya tienen el emoji incluido en su nombre.
        
    } catch(err) {
        console.error("Error al a√±adir ingredientes con batch write:", err);
        showToast(`Error: ${err.message}`, true);
        buttonElement.disabled = false; // Habilitar el bot√≥n de nuevo si falla
    }
}
// ==================================================
// --- M√ìDULO: AJUSTES (CON GUARDADO SEGURO) ---
// ==================================================
function renderSettings() {
    removeCalendarFAB();
    setActiveTab('tab-settings');
    navigationHistory.push(renderDashboard);
    updateBackButton();

    const settings = appData.settings || {};
    const config = settings.configuracion || {};
    const ubicacion = settings.ubicacion || {};
    const informeManana = config.informeManana || {};
    const informeTarde = config.informeTarde || {};
    const informeMensual = config.informeMensual || {};
    const isPremium = appData.isPremium === true;
    
    // Capturamos el estado inicial para la validaci√≥n de cambios
    initialUserSettings = {
        nombre: settings.nombre || '',
        ciudad: ubicacion.ciudad || '',
        pais: ubicacion.pais || '',
        tema: config.tema || 'auto',
        informeMananaActivo: informeManana.activo === true,
        franjaManana: String(informeManana.franjaHoraria || '2'),
        informeTardeActivo: informeTarde.activo === true,
        franjaTarde: String(informeTarde.franjaHoraria || '20'),
        alertaInventario: config.alertaInventario === true,
        informeMensualActivo: informeMensual.activo === true,
        diaInformeMensual: String(informeMensual.dia || '1'),
        horaInformeMensual: String(informeMensual.hora || '12')
    };
    
    mainContentArea.innerHTML = `
        <div class="settings-container">
            <h2 class="settings-section-title">üë§ Perfil de Usuario</h2>
            <div class="form-card">
                <label>Nombre</label><input type="text" id="settings-nombre" placeholder="Tu nombre" />
                <label>Ciudad</label><input type="text" id="settings-ciudad" placeholder="Ej: Barcelona" />
                <label>Pa√≠s</label><input type="text" id="settings-pais" placeholder="Ej: Espa√±a" />
                <div class="settings-item" style="padding-top:15px;"><span class="settings-item-label">Tema de la App</span><div class="settings-item-control"><select id="settings-theme"><option value="auto">Autom√°tico (Telegram)</option><option value="light">Claro</option><option value="dark">Oscuro</option></select></div></div>
            </div>
            <h2 class="settings-section-title">üìÑ Informaci√≥n de la Cuenta</h2>
            <div class="form-card">
                <label>Email de Registro (no editable)</label><input type="email" id="settings-email" readonly />
                <label>Fecha de Activaci√≥n (no editable)</label><input type="text" id="settings-fecha-activacion" readonly />
                <label>Zona Horaria Detectada (no editable)</label><input type="text" id="settings-zona-horaria" readonly />
                <label>Moneda (detectada)</label><input type="text" id="settings-moneda" readonly />
            </div>
            <h2 class="settings-section-title">üîî Informes y Alertas</h2>
            <div class="form-card">
                <div class="settings-item"><span class="settings-item-label">Informe Matutino</span><label class="switch"><input type="checkbox" id="settings-informe-manana-activo"><span class="slider"></span></label></div>
                <div class="settings-item"><span class="settings-item-label">Hora del Informe</span><select id="settings-franja-manana"><option value="1">A primera hora (6:00)</option><option value="2">Habitual (7:00)</option><option value="3">Media ma√±ana (8:00)</option><option value="4">Tarde (9:00)</option></select></div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item"><span class="settings-item-label">Informe del Tiempo (Tarde)</span><label class="switch"><input type="checkbox" id="settings-informe-tarde-activo"><span class="slider"></span></label></div>
                <div class="settings-item"><span class="settings-item-label">Hora del Informe</span><select id="settings-franja-tarde"><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option></select></div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item"><span class="settings-item-label">Informe Mensual de Gastos</span><label class="switch"><input type="checkbox" id="settings-informe-mensual-activo"><span class="slider"></span></label></div>
                <div class="settings-item"><span class="settings-item-label">D√≠a de Env√≠o</span><select id="settings-dia-informe-mensual">${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join('')}</select></div>
                <div class="settings-item"><span class="settings-item-label">Hora de Env√≠o</span><select id="settings-hora-informe-mensual">${[...Array(15).keys()].map(i => `<option value="${i + 8}">${(i + 8).toString().padStart(2, '0')}:00</option>`).join('')}</select></div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item" id="alerta-inventario-wrapper"><span class="settings-item-label">Alertas de Compra Inteligente ${isPremium ? '' : '‚≠ê'}</span><label class="switch"><input type="checkbox" id="settings-alerta-inventario"><span class="slider"></span></label></div>
            </div>
            <div class="form-card" style="margin-top: 20px;"><div class="button-group">
                <button id="settings-cancel-btn" class="cancel">Cancelar</button>
                <button id="settings-save-btn" disabled>Guardar Cambios</button>
            </div>
			</div>
            <div class="form-card" style="margin-top: 20px;">
                 <button id="settings-sync-btn" class="add-article-btn enabled" style="width:100%; max-width:100%; background-color: var(--muted);">Sincronizar Contadores</button>
            </div>
        </div>
    `;

    // --- Rellenar los campos del formulario con los datos correctos ---
    document.getElementById('settings-nombre').value = initialUserSettings.nombre;
    document.getElementById('settings-ciudad').value = initialUserSettings.ciudad;
    document.getElementById('settings-pais').value = initialUserSettings.pais;
    document.getElementById('settings-theme').value = initialUserSettings.tema;
    
    // Lectura correcta de datos no editables
    document.getElementById('settings-email').value = settings.email || 'No disponible';
    document.getElementById('settings-fecha-activacion').value = settings.fechaActivacion || 'No disponible';
    document.getElementById('settings-zona-horaria').value = ubicacion.timeZone || 'No disponible';
    document.getElementById('settings-moneda').value = settings.moneda || 'No disponible';
    
    document.getElementById('settings-informe-manana-activo').checked = initialUserSettings.informeMananaActivo;
    document.getElementById('settings-franja-manana').value = initialUserSettings.franjaManana;
    document.getElementById('settings-informe-tarde-activo').checked = initialUserSettings.informeTardeActivo;
    document.getElementById('settings-franja-tarde').value = initialUserSettings.franjaTarde;
    
    const alertaInventarioSwitch = document.getElementById('settings-alerta-inventario');
    alertaInventarioSwitch.checked = initialUserSettings.alertaInventario;
    if (!isPremium) {
        alertaInventarioSwitch.disabled = true;
        document.getElementById('alerta-inventario-wrapper').style.opacity = '0.6';
        document.getElementById('alerta-inventario-wrapper').onclick = () => showToast('‚≠ê Funci√≥n exclusiva para usuarios Premium.');
    }

    document.getElementById('settings-informe-mensual-activo').checked = initialUserSettings.informeMensualActivo;
    document.getElementById('settings-dia-informe-mensual').value = initialUserSettings.diaInformeMensual;
    document.getElementById('settings-hora-informe-mensual').value = initialUserSettings.horaInformeMensual;

    // Asignar listeners
    const controls = document.querySelectorAll('#settings-nombre, #settings-ciudad, #settings-pais, #settings-theme, #settings-informe-manana-activo, #settings-franja-manana, #settings-informe-tarde-activo, #settings-franja-tarde, #settings-informe-mensual-activo, #settings-dia-informe-mensual, #settings-hora-informe-mensual, #settings-alerta-inventario');
    controls.forEach(control => {
        control.addEventListener('input', validateSettings);
        control.addEventListener('change', validateSettings);
    });

    document.getElementById('settings-save-btn').onclick = saveSettings;
    document.getElementById('settings-cancel-btn').onclick = renderDashboard;
    document.getElementById('settings-sync-btn').onclick = syncCounts;
}

/**
 * Valida si hay cambios en el formulario de ajustes comparando con el estado inicial.
 * Habilita/deshabilita el bot√≥n de guardar de forma inteligente.
 */
function validateSettings() {
    const saveBtn = document.getElementById('settings-save-btn');

    // Recoger valores actuales del formulario
    const currentValues = {
        nombre: document.getElementById('settings-nombre').value,
        ciudad: document.getElementById('settings-ciudad').value,
        pais: document.getElementById('settings-pais').value,
        tema: document.getElementById('settings-theme').value,
        informeMananaActivo: document.getElementById('settings-informe-manana-activo').checked,
        franjaManana: document.getElementById('settings-franja-manana').value,
        informeTardeActivo: document.getElementById('settings-informe-tarde-activo').checked,
        franjaTarde: document.getElementById('settings-franja-tarde').value,
        alertaInventario: document.getElementById('settings-alerta-inventario').checked,
        informeMensualActivo: document.getElementById('settings-informe-mensual-activo').checked,
        diaInformeMensual: document.getElementById('settings-dia-informe-mensual').value,
        horaInformeMensual: document.getElementById('settings-hora-informe-mensual').value
    };

    // Comparamos los objetos completos. JSON.stringify es una forma simple y efectiva para esto.
    const hasChanged = JSON.stringify(currentValues) !== JSON.stringify(initialUserSettings);
    
    saveBtn.disabled = !hasChanged;
    saveBtn.classList.toggle('enabled', hasChanged);
}

// --- VERSI√ìN FINAL-FINAL DE saveSettings (CON SPINNER Y CAPITALIZACI√ìN) ---
async function saveSettings() {
    const saveBtn = document.getElementById('settings-save-btn');
    const originalBtnText = saveBtn.textContent;
    
    // Funci√≥n de ayuda para capitalizar nombres
    const capitalize = (str) => {
        if (!str) return '';
        return str.toLowerCase().replace(/(?:^|\s)\S/g, char => char.toUpperCase());
    };

    // 1. Mostramos el spinner interno y desactivamos el bot√≥n
         saveBtn.innerHTML = `<span class="spinner btn-spinner"></span> Guardando...`;    saveBtn.disabled = true;
    try {
        // 2. Recogemos y capitalizamos los valores de ciudad y pa√≠s
        const currentValues = {
            nombre: document.getElementById('settings-nombre').value,
            ciudad: capitalize(document.getElementById('settings-ciudad').value.trim()),
            pais: capitalize(document.getElementById('settings-pais').value.trim()),
            tema: document.getElementById('settings-theme').value,
            informeMananaActivo: document.getElementById('settings-informe-manana-activo').checked,
            franjaManana: document.getElementById('settings-franja-manana').value,
            informeTardeActivo: document.getElementById('settings-informe-tarde-activo').checked,
            franjaTarde: document.getElementById('settings-franja-tarde').value,
            alertaInventario: document.getElementById('settings-alerta-inventario').checked,
            informeMensualActivo: document.getElementById('settings-informe-mensual-activo').checked,
            diaInformeMensual: document.getElementById('settings-dia-informe-mensual').value,
            horaInformeMensual: document.getElementById('settings-hora-informe-mensual').value
        };

        const simpleChanges = {};
        let hasComplexChanges = false;

        for (const key in currentValues) {
            if (String(currentValues[key]) !== String(initialUserSettings[key])) { // Comparaci√≥n robusta
                if (key === 'ciudad' || key === 'pais') {
                    hasComplexChanges = true;
                } else {
                    simpleChanges[key] = currentValues[key];
                }
            }
        }
        
        let updatePromise = Promise.resolve();
        let cloudFunctionPromise = Promise.resolve();

        if (Object.keys(simpleChanges).length > 0) {
            const userDocRef = db.collection('users').doc(chatId);
            const firestoreUpdateData = {};
            for (const key in simpleChanges) {
                 if (key.includes('Manana') || key.includes('Tarde') || key.includes('Mensual')) {
                    const informe = key.includes('Manana') ? 'informeManana' : (key.includes('Tarde') ? 'informeTarde' : 'informeMensual');
                    const subKey = key.includes('Activo') ? 'activo' : (key.includes('franja') ? 'franjaHoraria' : (key.includes('dia') ? 'dia' : 'hora'));
                    firestoreUpdateData[`configuracion.${informe}.${subKey}`] = simpleChanges[key];
                } else if (key === 'alertaInventario' || key === 'tema') {
                    firestoreUpdateData[`configuracion.${key}`] = simpleChanges[key];
                } else {
                    firestoreUpdateData[key] = simpleChanges[key];
                }
            }
            updatePromise = userDocRef.update(firestoreUpdateData);
        }

        if (hasComplexChanges) {
            const functionUrl = 'https://europe-west1-asistentepersonal-4ad2b.cloudfunctions.net/updateUserSettings';
            const payload = {
                data: {
                    chatId: chatId,
                    nombre: currentValues.nombre,
                    ciudad: currentValues.ciudad, // Enviamos el valor ya capitalizado
                    pais: currentValues.pais       // Enviamos el valor ya capitalizado
                }
            };
            cloudFunctionPromise = fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error.message || `Error del servidor: ${response.status}`); });
                }
                return response.json();
            });
        }
        
        const results = await Promise.all([updatePromise, cloudFunctionPromise]);
        
        const cloudFunctionResult = results[1];
        if (cloudFunctionResult && cloudFunctionResult.result && cloudFunctionResult.result.status === 'success') {
            appData.settings = cloudFunctionResult.result.updatedSettings;
        } else {
            const userDoc = await db.collection('users').doc(chatId).get();
            if (userDoc.exists) appData.settings = userDoc.data();
        }
        
        // 3. Actualizamos la UI con los datos capitalizados y los nuevos datos del backend
        document.getElementById('settings-ciudad').value = appData.settings.ubicacion?.ciudad || '';
        document.getElementById('settings-pais').value = appData.settings.ubicacion?.pais || '';
        document.getElementById('settings-zona-horaria').value = appData.settings.ubicacion?.timeZone || 'No disponible';
        document.getElementById('settings-moneda').value = appData.settings.moneda || 'No disponible';

        initialUserSettings = { ...currentValues }; // Actualizamos el estado de referencia
        showToast("Ajustes guardados con √©xito.");

    } catch (error) {
        console.error("Error al guardar ajustes:", error);
        showToast(`Error: ${error.message || 'Ocurri√≥ un error desconocido.'}`, true);
    } finally {
        // 4. Restauramos el bot√≥n a su estado original
        saveBtn.innerHTML = originalBtnText;
        saveBtn.disabled = true;
        saveBtn.classList.remove('enabled');
    }
}

async function syncCounts() {
    showSpinner("Sincronizando contadores...");
    try {
        const res = await fetchWithTimeout(gasWebhookURL, { Type: 'resync_counts', chat_ID: chatId });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        if (data.success && data.counts) {
            Object.assign(appData.counts, data.counts);
            showToast("Contadores resincronizados con √©xito.");
            renderDashboard(); // Re-renderizar el dashboard para mostrar los nuevos contadores
        } else {
            throw new Error("Respuesta inesperada del servidor.");
        }
    } catch (err) {
        showToast(`Error al sincronizar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function renderExportPage() {
    removeCalendarFAB();
	setActiveTab('tab-export');
    navigationHistory.push(renderDashboard);
    updateBackButton();
    mainContentArea.innerHTML = `
        <div class="export-container">
            <h2 class="settings-section-title">üìä Exportar Gastos</h2>
            <div class="form-card">
                <p style="font-size:0.9rem; color:var(--muted); margin-bottom:15px;">Selecciona el rango de fechas para la exportaci√≥n. Recibir√°s el archivo en tu email.</p>
                <label>Fecha de Inicio</label>
                <input type="text" id="export-start-date" required />
                <label>Fecha de Fin</label>
                <input type="text" id="export-end-date" required />
                <div class="button-group">
                    <button id="export-cancel-btn" class="cancel">Cancelar</button>
                    <button id="export-confirm-btn" class="enabled">Generar y Enviar</button>
                </div>
            </div>
        </div>
    `;
    const fpConfig = { dateFormat: "d/m/Y", locale: "es" };
    flatpickr("#export-start-date", { ...fpConfig, defaultDate: new Date(new Date().getFullYear(), 0, 1) });
    flatpickr("#export-end-date", { ...fpConfig, defaultDate: new Date() });
    document.getElementById('export-cancel-btn').onclick = goBack;
    document.getElementById('export-confirm-btn').onclick = executeExport;
}

async function executeExport() {
    showSpinner("Generando exportaci√≥n...");
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    if (!startDate || !endDate) {
        hideSpinner();
        showToast("Por favor, selecciona ambas fechas.", true);
        return;
    }
    try {
        const payload = { Type: 'export_gastos', chat_ID: chatId, startDate: startDate, endDate: endDate };
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast(data.message || "Petici√≥n de exportaci√≥n enviada. Revisa tu email.");
        renderDashboard();
    } catch (err) {
        showToast(`Error al exportar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

// ==================================================
// --- M√ìDULO: GU√çA TV ---
// ==================================================

/**
 * Renderiza la vista principal de la Gu√≠a TV.
 * VERSI√ìN FINAL: Utiliza fetchWithTimeout con el m√©todo FormData probado.
 */
/**
 * Controlador principal para la Gu√≠a TV.
 * Construye la estructura base y lanza la carga de datos para el d√≠a actual.
 */
function renderGuiaTV() {
    navigationHistory.push(renderDashboard);
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="guia-tv-container">
            <div class="list-header"><h2>Gu√≠a TV</h2></div>
            <div id="guia-nav-container" class="guia-nav"></div>
            <div id="guia-grid-wrapper" class="guia-grid-wrapper">
                <div id="guia-grid-content">
                    <div class="no-data-msg">Cargando programaci√≥n...</div>
                </div>
            </div>
        </div>`;

    // Generar botones de navegaci√≥n para los pr√≥ximos 4 d√≠as
    const navContainer = document.getElementById('guia-nav-container');
    for (let i = 0; i < 4; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i);
        const dateISO = date.toISOString().split('T')[0];

        const btn = document.createElement('button');
        btn.className = 'guia-nav-btn';
        btn.dataset.date = dateISO;
        if (i === 0) {
            btn.classList.add('active');
            btn.textContent = 'Hoy';
        } else if (i === 1) {
            btn.textContent = 'Ma√±ana';
        } else {
            btn.textContent = date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
        }
        
        btn.onclick = () => {
            document.querySelectorAll('.guia-nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadGuiaDataForDate(dateISO);
        };
        navContainer.appendChild(btn);
    }

    // Cargar datos para el d√≠a de hoy
    const todayISO = new Date().toISOString().split('T')[0];
    loadGuiaDataForDate(todayISO);
}

/**
 * Carga los datos de la gu√≠a para una fecha espec√≠fica desde Firestore y llama a la funci√≥n de renderizado.
 * @param {string} dateISO - La fecha en formato YYYY-MM-DD.
 */
async function loadGuiaDataForDate(dateISO) {
    showSpinner();
    const gridContent = document.getElementById('guia-grid-content');

    try {
        const geoTags = appData.settings.ubicacion?.geo_tags;
        if (!geoTags || !geoTags.country || !geoTags.admin_level_1) {
            throw new Error("Ubicaci√≥n no configurada correctamente.");
        }

        const pais = geoTags.country.toLowerCase();
        const codigoRegion = `${pais.substring(0, 2).toUpperCase()}-${(geoTags.admin_level_1 || 'General').replace(/\s+/g, '-').toUpperCase()}`;
        
        const docPath = `guia_tv/${codigoRegion}/programacion/${dateISO}`;
        const docSnap = await db.collection('guia_tv').doc(codigoRegion).collection('programacion').doc(dateISO).get();

        if (!docSnap.exists) {
            throw new Error(`No hay programaci√≥n disponible para el d√≠a ${dateISO}.`);
        }
        
        const data = docSnap.data();
        renderTimelineGrid(data.canales, data.programas);

    } catch (err) {
        console.error("Error cargando la Gu√≠a TV desde Firestore:", err);
        gridContent.innerHTML = `<div class="no-data-msg">‚ùå<br>No se pudo cargar la gu√≠a.<br><small>${err.message}</small></div>`;
    } finally {
        hideSpinner();
    }
}

/**
 * Renderiza la parrilla de l√≠nea de tiempo con los datos de canales y programas.
 * @param {Array} canales - El array de objetos de canal.
 * @param {Array} programas - El array de objetos de programa.
 */
function renderTimelineGrid(canales, programas) {
    const gridContent = document.getElementById('guia-grid-content');
    const PIXELS_PER_MINUTE = 2; // 120px por hora

    // Construir HTML para la columna de canales
    let channelsHtml = '<div class="guia-channels-col"><div class="guia-channel-logo-placeholder"></div>';
    canales.forEach(canal => {
        channelsHtml += `<div class="guia-channel-logo"><img src="${canal.logo}" alt="${canal.nombre}"></div>`;
    });
    channelsHtml += '</div>';

    // Construir HTML para la columna de la l√≠nea de tiempo
    let timelineHtml = '<div class="guia-timeline-col">';
    
    // Cabecera de horas
    let timeHeaderHtml = '<div class="guia-time-header">';
    for (let i = 0; i < 48; i++) { // 24 horas * 2 slots de 30 min
        const hour = Math.floor(i / 2).toString().padStart(2, '0');
        const minutes = (i % 2 === 0) ? '00' : '30';
        timeHeaderHtml += `<div class="guia-time-slot">${hour}:${minutes}</div>`;
    }
    timeHeaderHtml += '</div>';
    timelineHtml += timeHeaderHtml;

    // Filas de programas para cada canal
    canales.forEach(canal => {
        timelineHtml += `<div class="guia-channel-row" data-channel-id="${canal.id}">`;
        const programasDelCanal = programas.filter(p => p.canal === canal.id);
        programasDelCanal.forEach(prog => {
            const startTime = new Date(prog.inicio);
            const endTime = new Date(prog.fin);
            const startMinutes = startTime.getUTCHours() * 60 + startTime.getUTCMinutes();
            const endMinutes = endTime.getUTCHours() * 60 + endTime.getUTCMinutes();
            const durationMinutes = Math.max(15, (endMinutes - startMinutes)); // Duraci√≥n m√≠nima de 15 min

            const left = startMinutes * PIXELS_PER_MINUTE;
            const width = durationMinutes * PIXELS_PER_MINUTE;

            timelineHtml += `
                <div class="guia-program-block" style="left: ${left}px; width: ${width}px;" data-program-id="${prog.titulo}">
                    <div class="guia-program-title">${prog.titulo}</div>
                    <div class="guia-program-time">${startTime.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</div>
                </div>`;
        });
        timelineHtml += '</div>';
    });
    
    // L√≠nea de "Ahora"
    const now = new Date();
    const nowMinutes = now.getHours() * 60 + now.getMinutes();
    const nowPosition = nowMinutes * PIXELS_PER_MINUTE;
    const todayISO = now.toISOString().split('T')[0];
    const activeDate = document.querySelector('.guia-nav-btn.active')?.dataset.date;

    if (activeDate === todayISO) {
         timelineHtml += `<div class="guia-now-line" style="left: ${nowPosition}px;"></div>`;
    }

    timelineHtml += '</div>'; // Cierre de guia-timeline-col
    gridContent.innerHTML = `<div class="guia-grid">${channelsHtml}${timelineHtml}</div>`;

    // Scroll autom√°tico a la hora actual
    const wrapper = document.getElementById('guia-grid-wrapper');
    if (activeDate === todayISO) {
         wrapper.scrollLeft = nowPosition - (wrapper.offsetWidth / 2);
    }
}
// ====================================================================================
// --- INICIO DEL BLOQUE DE REEMPLAZO (CALENDARIO SIMPLIFICADO + MEN√ö + BOT√ìN FLOTANTE) ---
// ====================================================================================
// --- NUEVA FUNCI√ìN DE AYUDA ---
function removeCalendarFAB() {
    const fab = document.getElementById('calendar-fab');
    if (fab) fab.remove();
}
function renderCalendarView() {
    currentCalendarView = 'month';
    currentCalendarDate = new Date();
    
    navigationHistory.push(() => {
        if (typeof unsubscribeCalendarEvents === 'function') {
            unsubscribeCalendarEvents();
            unsubscribeCalendarEvents = null;
        }
        // Asegurarse de que el bot√≥n + se elimina al salir de la vista de calendario
        const fab = document.getElementById('calendar-fab');
        if (fab) fab.remove();
        renderDashboard();
    });
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="calendar-header-sticky">
                 <div class="list-header" style="padding-bottom:0; justify-content: space-between; align-items: center;">
                    <div style="position: relative; z-index: 100;">
                        <button class="generic-menu-btn" id="calendar-view-menu-btn" style="font-size: 1.8rem; padding: 5px;">‚ò∞</button>
                        <div class="dropdown-menu" id="calendar-view-menu" style="top: 100%; left: 0; min-width: 120px;">
                            <a class="dropdown-item" data-view="day">Hoy</a>
                            <a class="dropdown-item" data-view="three_day">3 D√≠as</a>
                            <a class="dropdown-item" data-view="week">Semana</a>
                            <a class="dropdown-item" data-view="month">Mes</a>
                        </div>
                    </div>
                    <h2 style="margin:0; flex-grow: 1; text-align: left; padding-left: 15px;">üóìÔ∏è Mi Calendario</h2>
                </div>
                <div id="calendar-controls" style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0; padding: 0 10px;">
                    <button id="calendar-prev-btn" class="back-btn" style="font-size:1.5rem; margin-right:0;">‚óÄÔ∏è</button>
                    <h3 id="calendar-current-period" style="font-size:1.1rem; flex-grow:1; text-align:center; margin:0;">Cargando...</h3>
                    <button id="calendar-next-btn" class="back-btn" style="font-size:1.5rem; margin-left:0;">‚ñ∂Ô∏è</button>
                </div>
            </div>
            <div id="calendar-content" style="min-height:300px;"></div>
        </div>`;

    // --- BOT√ìN FLOTANTE (+) RESTAURADO ---
    const fab = document.createElement('button');
    fab.id = 'calendar-fab';
    fab.className = 'floating-action-button';
    fab.innerHTML = '+';
    fab.onclick = () => renderCalendarEventForm(null, renderCalendarView);
    document.body.appendChild(fab);

    const viewMenuBtn = document.getElementById('calendar-view-menu-btn');
    const viewMenu = document.getElementById('calendar-view-menu');
    
    viewMenuBtn.onclick = (e) => { e.stopPropagation(); viewMenu.classList.toggle('show'); };

    viewMenu.addEventListener('click', (e) => {
        const target = e.target.closest('.dropdown-item');
        if (target) {
            currentCalendarView = target.dataset.view;
            viewMenu.classList.remove('show');
            loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
        }
    });

    document.getElementById('calendar-prev-btn').onclick = () => {
        currentCalendarDate = getPreviousPeriodDate(currentCalendarView, currentCalendarDate);
        loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
    };
    document.getElementById('calendar-next-btn').onclick = () => {
        currentCalendarDate = getNextPeriodDate(currentCalendarView, currentCalendarDate);
        loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
    };
    
    loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
}

// Funciones auxiliares para la navegaci√≥n de fechas (actualizadas para "3 D√≠as")
function getPreviousPeriodDate(view, date) {
    const d = new Date(date);
    if (view === 'day') d.setDate(d.getDate() - 1);
    else if (view === 'three_day') d.setDate(d.getDate() - 3); // Retrocede 3 d√≠as
    else if (view === 'week') d.setDate(d.getDate() - 7);
    else d.setMonth(d.getMonth() - 1); // vista 'month'
    return d;
}

function getNextPeriodDate(view, date) {
    const d = new Date(date);
    if (view === 'day') d.setDate(d.getDate() + 1);
    else if (view === 'three_day') d.setDate(d.getDate() + 3); // Avanza 3 d√≠as
    else if (view === 'week') d.setDate(d.getDate() + 7);
    else d.setMonth(d.getMonth() + 1); // vista 'month'
    return d;
}

// Funci√≥n principal que carga los datos de Firestore y decide qu√© vista renderizar
function loadAndDisplayCalendarEvents(view, date) {
    showSpinner("Cargando calendario...");
    if (typeof unsubscribeCalendarEvents === 'function') unsubscribeCalendarEvents();

    const menuItems = document.querySelectorAll('#calendar-view-menu .dropdown-item');
    menuItems.forEach(item => item.classList.remove('active'));
    const activeItem = document.querySelector(`#calendar-view-menu .dropdown-item[data-view="${view}"]`);
    if (activeItem) activeItem.classList.add('active');

    let start = new Date(date); // Siempre creamos una nueva instancia para evitar mutaciones
    let end = new Date(date);
    const periodEl = document.getElementById('calendar-current-period');
    
    start.setHours(0,0,0,0);

    if (view === 'day') {
        // CORRECCI√ìN CLAVE: Creamos un nuevo objeto para 'end' para no modificar 'start'
        end = new Date(start); 
        end.setHours(23,59,59,999);
        currentCalendarDate = new Date(start);
        if (periodEl) periodEl.textContent = start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
    } else if (view === 'three_day') {
        end.setDate(end.getDate() + 2);
        end.setHours(23,59,59,999);
        if (periodEl) periodEl.textContent = `${start.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} - ${end.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}`;
    } else if (view === 'week') {
        const dayOfWeek = date.getDay();
        const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        start = new Date(date.getFullYear(), date.getMonth(), diff, 0, 0, 0, 0);
        end = new Date(start);
        end.setDate(start.getDate() + 6);
        end.setHours(23,59,59,999);
        if (periodEl) periodEl.textContent = `${start.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} - ${end.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}`;
    } else { // 'month'
        start = new Date(date.getFullYear(), date.getMonth(), 1, 0, 0, 0, 0);
        end = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59, 999);
        if (periodEl) periodEl.textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    }

    const q = db.collection('users').doc(chatId).collection(FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION).where('fechaInicio', '<=', end).orderBy('fechaInicio', 'asc');
    
    unsubscribeCalendarEvents = q.onSnapshot(snapshot => {
        if (!document.getElementById('calendar-content')) return;
        const allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), fechaInicio: doc.data().fechaInicio.toDate(), fechaFin: doc.data().fechaFin.toDate() }));
        const eventsInRange = allEvents.filter(e => e.fechaFin >= start);
        
        if (view === 'day') renderDayView(eventsInRange, currentCalendarDate);
        else if (view === 'three_day') renderThreeDayView(eventsInRange, date);
        else if (view === 'week') renderWeekView(eventsInRange, start);
        else if (view === 'month') renderMonthView(eventsInRange, date);
        
        hideSpinner();
    }, error => { console.error("Error en listener de calendario:", error); hideSpinner(); });
}

// ====================================================================================
// --- FIN DEL BLOQUE DE REEMPLAZO ---
// ====================================================================================

// =========================================================================
// --- INICIO: NUEVA FUNCI√ìN DE C√ÅLCULO DE DISE√ëO DE EVENTOS ---
// =========================================================================
function calculateEventLayout(eventsForDay, HOUR_HEIGHT) {
    if (!eventsForDay || eventsForDay.length === 0) return [];

    // 1. Ordenar eventos por hora de inicio
    const sortedEvents = [...eventsForDay].sort((a, b) => a.fechaInicio - b.fechaInicio);

    // 2. Calcular 'top' y 'height' inicial para cada evento
    sortedEvents.forEach(event => {
        const startMinutes = event.fechaInicio.getHours() * 60 + event.fechaInicio.getMinutes();
        const endMinutes = event.fechaFin.getHours() * 60 + event.fechaFin.getMinutes();
        const durationMinutes = Math.max(30, (endMinutes - startMinutes)); // Duraci√≥n m√≠nima visual de 30 min
        
        event.layout = {
            top: (startMinutes / 60) * HOUR_HEIGHT,
            height: (durationMinutes / 60) * HOUR_HEIGHT,
            collisions: 1,
            colIndex: 0
        };
    });

    // 3. Detectar colisiones y determinar el ancho y la posici√≥n
    for (let i = 0; i < sortedEvents.length; i++) {
        const eventA = sortedEvents[i];
        let collisionGroup = [eventA];

        for (let j = i + 1; j < sortedEvents.length; j++) {
            const eventB = sortedEvents[j];
            // Si el evento B empieza antes de que el A termine, hay colisi√≥n
            if (eventB.fechaInicio < eventA.fechaFin) {
                collisionGroup.push(eventB);
            }
        }
        
        // Solo si hay m√°s de un evento colisionando, ajustamos el layout
        if (collisionGroup.length > 1) {
            // Re-evaluar el grupo para encontrar el n√∫mero m√°ximo de solapamientos simult√°neos
            const maxCollisions = collisionGroup.reduce((max, currentEvent) => {
                const simultaneous = collisionGroup.filter(e => e.fechaInicio < currentEvent.fechaFin && e.fechaFin > currentEvent.fechaInicio).length;
                return Math.max(max, simultaneous);
            }, 1);

            collisionGroup.forEach(eventInGroup => {
                // Asignamos el n√∫mero m√°ximo de colisiones detectado a todos los miembros del grupo
                eventInGroup.layout.collisions = Math.max(eventInGroup.layout.collisions, maxCollisions);
            });
        }
    }

    // 4. Asignar el √≠ndice de columna (posici√≥n horizontal)
    sortedEvents.forEach(event => {
        const collidingEvents = sortedEvents.filter(e => e !== event && e.fechaInicio < event.fechaFin && e.fechaFin > event.fechaInicio);
        const colIndicesTaken = collidingEvents.map(e => e.layout.colIndex);
        
        let assignedColIndex = 0;
        while (colIndicesTaken.includes(assignedColIndex)) {
            assignedColIndex++;
        }
        event.layout.colIndex = assignedColIndex;
    });


    return sortedEvents;
}
const EVENT_COLORS_PRESETS = [
    { value: '#039be5', label: 'Predeterminado (Trabajo)' },
    { value: '#e67c73', label: 'Salud / Citas' },
    { value: '#f6bf26', label: 'Personal / Ocio' },
    { value: '#33b679', label: 'Cumplea√±os / Eventos' },
    { value: '#8e24aa', label: 'Importante / Urgente' }
];
// =========================================================================
// --- FIN: NUEVA FUNCI√ìN DE C√ÅLCULO ---
// =========================================================================
async function handleTimelineClick(event) {
    const eventBlock = event.target.closest('.event-block, .month-event-pill');
    const emptySlot = event.target.closest('.calendar-day-col');

    // CASO 1: Se ha hecho clic en un evento existente
    if (eventBlock) {
        const eventId = eventBlock.dataset.eventId;
        if (!eventId) return;
        
        showSpinner();
        try {
            const eventDoc = await db.collection('users').doc(chatId).collection(FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION).doc(eventId).get();
            if (eventDoc.exists) {
                const eventData = eventDoc.data();
                renderCalendarEventForm({ id: eventDoc.id, ...eventData, fechaInicio: eventData.fechaInicio.toDate(), fechaFin: eventData.fechaFin.toDate() }, renderCalendarView);
            } else {
                showToast("El evento ya no existe.", true);
            }
        } catch (err) {
            showToast(`Error al cargar evento: ${err.message}`, true);
        } finally {
            hideSpinner();
        }
        return;
    }

    // CASO 2: Se ha hecho clic en un hueco vac√≠o
    if (emptySlot) {
        const HOUR_HEIGHT = 60;
        const dateISO = emptySlot.dataset.dateIso;
        if (!dateISO) return;

        const baseDate = new Date(dateISO);
        const clickY = event.offsetY;
        
        const totalMinutes = (clickY / HOUR_HEIGHT) * 60;
        const roundedMinutes = Math.floor(totalMinutes / 15) * 15; // Redondear hacia abajo al cuarto de hora m√°s cercano
        
        const startHour = Math.floor(roundedMinutes / 60);
        const startMinute = roundedMinutes % 60;

        const prefilledStartDate = new Date(baseDate);
        prefilledStartDate.setHours(startHour, startMinute, 0, 0);

        const prefilledEndDate = new Date(prefilledStartDate.getTime() + 60 * 60 * 1000); // 1 hora despu√©s

        renderCalendarEventForm(null, renderCalendarView, prefilledStartDate, prefilledEndDate);
    }
}
function renderDayView(events, currentDate) {
    const contentEl = document.getElementById('calendar-content');
    const HOUR_HEIGHT = 60;
    const isToday = currentDate.toDateString() === new Date().toDateString();

    const allDayEvents = events.filter(e => e.esTodoElDia);
    const timedEvents = events.filter(e => !e.esTodoElDia);

    let allDayPillsHtml = '';
    allDayEvents.forEach(event => {
        allDayPillsHtml += `<div class="month-event-pill" data-event-id="${event.id}" style="background-color:${event.color || '#36A2EB'}; cursor:pointer;">${event.titulo}</div>`;
    });

    const structureHtml = `
    <div class="calendar-grid-container" style="height: calc(100vh - 220px);">
        <div class="calendar-all-day-header" style="grid-template-columns: 50px 1fr; top: 0;">
            <div class="all-day-label">Todo el d√≠a</div>
            <div class="all-day-slot">${allDayPillsHtml}</div>
        </div>
        <div class="calendar-scroll-body">
            <div class="calendar-time-col">
                 ${Array.from({length:24}, (_,h) => `<div class="calendar-time-slot"><span>${h.toString().padStart(2, '0')}:00</span></div>`).join('')}
            </div>
            <div class="calendar-events-grid" style="grid-template-columns: 1fr;">
                <div id="day-col-today" class="calendar-day-col" data-date-iso="${currentDate.toISOString()}"></div>
            </div>
        </div>
    </div>`;
    contentEl.innerHTML = structureHtml;

    const dayCol = document.getElementById('day-col-today');
    const layoutReadyEvents = calculateEventLayout(timedEvents, HOUR_HEIGHT);
    let dayEventsHtml = '';

    if (isToday) {
        const now = new Date();
        const nowPosition = ((now.getHours() * 60 + now.getMinutes()) / 60) * HOUR_HEIGHT;
        dayEventsHtml += `<div class="now-line" style="top: ${nowPosition}px; left:0; right:0;"></div>`;
    }

    layoutReadyEvents.forEach(event => {
        const width = 100 / event.layout.collisions;
        const left = event.layout.colIndex * width;
        dayEventsHtml += `<div class="event-block" data-event-id="${event.id}" 
                             style="top:${event.layout.top}px; height:${event.layout.height}px; left:${left}%; width:${width}%; background-color:${event.color||'#36A2EB'}; box-sizing: border-box;">
                             <div class="event-block-title">${event.titulo}</div>
                             <div class="event-block-time">${event.fechaInicio.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</div>
                          </div>`;
    });
    dayCol.innerHTML = dayEventsHtml;
    
    contentEl.removeEventListener('click', handleTimelineClick);
    contentEl.addEventListener('click', handleTimelineClick);

    if (isToday) {
        setTimeout(() => {
            const scrollBody = contentEl.querySelector('.calendar-scroll-body');
            const nowLine = contentEl.querySelector('.now-line');
            if (scrollBody && nowLine) {
                scrollBody.scrollTo({ top: nowLine.offsetTop - 50, behavior: 'smooth' });
            }
        }, 100);
    }
}
function renderWeekView(events, startOfWeek) {
    const contentEl = document.getElementById('calendar-content');
    const HOUR_HEIGHT = 60;
    const allDayEvents = events.filter(e => e.esTodoElDia);
    const timedEvents = events.filter(e => !e.esTodoElDia);
    
    let headerDaysHtml = '', allDaySlotsHtml = '', eventGridColsHtml = '';
    const eventsByDay = {}; 

    for (let i = 0; i < 7; i++) {
        const day = new Date(startOfWeek);
        day.setDate(startOfWeek.getDate() + i);
        const isToday = day.toDateString() === new Date().toDateString();
        const dayNumber = isToday ? `<span class="day-number-circle">${day.getDate()}</span>` : `<span>${day.getDate()}</span>`;
        
        headerDaysHtml += `<div class="day-label ${isToday ? 'today':''}"><span class="day-name">${day.toLocaleDateString('es-ES',{weekday:'short'})}</span>${dayNumber}</div>`;
        
        const dayStart = new Date(new Date(day).setHours(0,0,0,0));
        const dayEnd = new Date(new Date(day).setHours(23,59,59,999));
        const allDayEventsForThisDay = allDayEvents.filter(e => e.fechaInicio <= dayEnd && e.fechaFin >= dayStart);
        
        let pillsHtml = allDayEventsForThisDay.map(event => 
            `<div class="month-event-pill" data-event-id="${event.id}" style="background-color:${event.color || '#36A2EB'}; cursor:pointer;">${event.titulo}</div>`
        ).join('');

        allDaySlotsHtml += `<div class="all-day-slot">${pillsHtml}</div>`;
        eventGridColsHtml += `<div id="day-col-week-${i}" class="calendar-day-col" data-date-iso="${day.toISOString()}"></div>`;
        eventsByDay[i] = [];
    }

    const structureHtml = `
    <div class="calendar-grid-container">
        <div class="calendar-header" style="grid-template-columns: 50px repeat(7, 1fr);">
            <div style="background-color: var(--card-bg);"></div>${headerDaysHtml}
        </div>
        <div class="calendar-all-day-header" style="grid-template-columns: 50px repeat(7, 1fr);">
            <div class="all-day-label">Todo el d√≠a</div>${allDaySlotsHtml}
        </div>
        <div class="calendar-scroll-body">
            <div class="calendar-time-col">
                ${Array.from({length:24}, (_,h) => `<div class="calendar-time-slot"><span>${h.toString().padStart(2, '0')}:00</span></div>`).join('')}
            </div>
            <div class="calendar-events-grid" style="grid-template-columns: repeat(7, 1fr);">${eventGridColsHtml}</div>
        </div>
    </div>`;
    contentEl.innerHTML = structureHtml;

    const viewEndDate = new Date(startOfWeek); viewEndDate.setDate(startOfWeek.getDate() + 7);
    timedEvents.filter(e => e.fechaInicio >= startOfWeek && e.fechaInicio < viewEndDate).forEach(event => {
        const diffDays = Math.floor((new Date(event.fechaInicio).setHours(0,0,0,0) - new Date(startOfWeek).setHours(0,0,0,0)) / (1000*3600*24));
        if (diffDays >= 0 && diffDays < 7) { eventsByDay[diffDays].push(event); }
    });
    
    for (let i = 0; i < 7; i++) {
        const dayCol = document.getElementById(`day-col-week-${i}`);
        const layoutReadyEvents = calculateEventLayout(eventsByDay[i], HOUR_HEIGHT);
        dayCol.innerHTML = layoutReadyEvents.map(event => {
            const width = 100 / event.layout.collisions;
            const left = event.layout.colIndex * width;
            return `<div class="event-block" data-event-id="${event.id}" 
                         style="top:${event.layout.top}px; height:${event.layout.height}px; left:${left}%; width:${width}%; background-color:${event.color||'#36A2EB'}; box-sizing: border-box;">
                         <div class="event-block-title">${event.titulo}</div>
                         <div class="event-block-time">${event.fechaInicio.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</div>
                      </div>`;
        }).join('');
    }

    contentEl.removeEventListener('click', handleTimelineClick);
    contentEl.addEventListener('click', handleTimelineClick);
}
function renderThreeDayView(events, startDate) {
    const contentEl = document.getElementById('calendar-content');
    const HOUR_HEIGHT = 60;
    const allDayEvents = events.filter(e => e.esTodoElDia);
    const timedEvents = events.filter(e => !e.esTodoElDia);

    let headerDaysHtml = '', allDaySlotsHtml = '', eventGridColsHtml = '';
    const eventsByDay = {}; 

    for (let i = 0; i < 3; i++) {
        const day = new Date(startDate); day.setDate(startDate.getDate() + i);
        const isToday = day.toDateString() === new Date().toDateString();
        const dayNumber = isToday ? `<span class="day-number-circle">${day.getDate()}</span>` : `<span>${day.getDate()}</span>`;
        
        headerDaysHtml += `<div class="day-label ${isToday ? 'today':''}"><span class="day-name">${day.toLocaleDateString('es-ES',{weekday:'short'})}</span>${dayNumber}</div>`;
        
        const dayStart = new Date(new Date(day).setHours(0,0,0,0));
        const dayEnd = new Date(new Date(day).setHours(23,59,59,999));
        const allDayEventsForThisDay = allDayEvents.filter(e => e.fechaInicio <= dayEnd && e.fechaFin >= dayStart);
        
        let pillsHtml = allDayEventsForThisDay.map(event => 
            `<div class="month-event-pill" data-event-id="${event.id}" style="background-color:${event.color || '#36A2EB'}; cursor:pointer;">${event.titulo}</div>`
        ).join('');

        allDaySlotsHtml += `<div class="all-day-slot">${pillsHtml}</div>`;
        eventGridColsHtml += `<div id="day-col-3day-${i}" class="calendar-day-col" data-date-iso="${day.toISOString()}"></div>`;
        eventsByDay[i] = [];
    }
    
    const structureHtml = `
    <div class="calendar-grid-container">
        <div class="calendar-header" style="grid-template-columns: 50px repeat(3, 1fr);">
            <div style="background-color: var(--card-bg);"></div>${headerDaysHtml}
        </div>
        <div class="calendar-all-day-header" style="grid-template-columns: 50px repeat(3, 1fr);">
            <div class="all-day-label">Todo el d√≠a</div>${allDaySlotsHtml}
        </div>
        <div class="calendar-scroll-body">
            <div class="calendar-time-col">
                ${Array.from({length:24}, (_,h) => `<div class="calendar-time-slot"><span>${h.toString().padStart(2, '0')}:00</span></div>`).join('')}
            </div>
            <div class="calendar-events-grid three-day" style="grid-template-columns: repeat(3, 1fr);">${eventGridColsHtml}</div>
        </div>
    </div>`;
    contentEl.innerHTML = structureHtml;
    
    const viewEndDate = new Date(startDate); viewEndDate.setDate(startDate.getDate() + 3);
    timedEvents.filter(e => e.fechaInicio >= startDate && e.fechaInicio < viewEndDate).forEach(event => {
        const diffDays = Math.floor((new Date(event.fechaInicio).setHours(0,0,0,0) - new Date(startDate).setHours(0,0,0,0)) / (1000*3600*24));
        if (diffDays >= 0 && diffDays < 3) { eventsByDay[diffDays].push(event); }
    });
    
    for (let i = 0; i < 3; i++) {
        const dayCol = document.getElementById(`day-col-3day-${i}`);
        const layoutReadyEvents = calculateEventLayout(eventsByDay[i], HOUR_HEIGHT);
        dayCol.innerHTML = layoutReadyEvents.map(event => {
            const width = 100 / event.layout.collisions;
            const left = event.layout.colIndex * width;
            return `<div class="event-block" data-event-id="${event.id}" 
                         style="top:${event.layout.top}px; height:${event.layout.height}px; left:${left}%; width:${width}%; background-color:${event.color||'#36A2EB'}; box-sizing: border-box;">
                         <div class="event-block-title">${event.titulo}</div>
                         <div class="event-block-time">${event.fechaInicio.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</div>
                      </div>`;
        }).join('');
    }

    contentEl.removeEventListener('click', handleTimelineClick);
    contentEl.addEventListener('click', handleTimelineClick);
}
function renderMonthView(events, currentDate) {
    const contentEl = document.getElementById('calendar-content');
    const weekdays = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];

    // Contenedor principal que envuelve la cabecera y la cuadr√≠cula
    let finalHtml = `<div class="calendar-month-container">`;
    
    // Cabecera con los d√≠as de la semana
    let headerHtml = `<div class="calendar-month-header">`;
    weekdays.forEach(day => {
        headerHtml += `<div class="calendar-day-header">${day}</div>`;
    });
    headerHtml += `</div>`;
    finalHtml += headerHtml;

    // Cuadr√≠cula principal del mes
    let gridHtml = `<div class="calendar-month-grid">`;

    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    // Ajuste para que la semana empiece en Lunes (getDay() 0=Dom, 1=Lun...)
    const startDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; 

    // A√±adir celdas vac√≠as para los d√≠as del mes anterior
    for (let i = 0; i < startDayOfWeek; i++) {
        gridHtml += `<div class="calendar-day-cell empty" style="background-color: var(--bg);"></div>`; 
    }
    
    // Generar las celdas para cada d√≠a del mes
    for (let dayNum = 1; dayNum <= lastDay.getDate(); dayNum++) {
        const day = new Date(currentDate.getFullYear(), currentDate.getMonth(), dayNum);
        const isToday = day.toDateString() === new Date().toDateString();
        const dayStart = new Date(new Date(day).setHours(0,0,0,0));
        const dayEnd = new Date(new Date(day).setHours(23,59,59,999));
        
        // --- L√ìGICA CORREGIDA ---
        // Ahora solo filtramos los eventos que INICIAN en este d√≠a.
        const eventsForDay = events.filter(e => e.fechaInicio >= dayStart && e.fechaInicio <= dayEnd);
        
        // Empieza la celda del d√≠a
        gridHtml += `<div class="calendar-day-cell ${isToday ? 'today' : ''}" data-date="${day.toISOString()}">
                        <div class="calendar-day-number">${dayNum}</div>
                        <div class="month-events-container">`; // Contenedor para las pastillas

        // Genera las "pastillas" para los eventos del d√≠a
        eventsForDay.slice(0, 3).forEach(event => { // Muestra un m√°ximo de 3 eventos
            gridHtml += `<div class="month-event-pill" style="background-color:${event.color || '#36A2EB'};">${event.titulo}</div>`;
        });

        // Si hay m√°s de 3 eventos, muestra un indicador
        if (eventsForDay.length > 3) {
            gridHtml += `<div class="month-event-pill" style="background:var(--muted);">${eventsForDay.length - 3} m√°s...</div>`;
        }
        
        // Cierra los contenedores
        gridHtml += `   </div>
                      </div>`;
    }
    
    gridHtml += `</div>`; // Cierre de calendar-month-grid
    finalHtml += gridHtml;
    finalHtml += `</div>`; // Cierre de calendar-month-container
    
    contentEl.innerHTML = finalHtml;

    // A√±ade el listener para hacer clic en un d√≠a y cambiar a la vista de "Hoy" (vista de d√≠a)
    contentEl.querySelectorAll('.calendar-day-cell:not(.empty)').forEach(dayCell => {
        dayCell.onclick = (e) => {
            currentCalendarDate = new Date(e.currentTarget.dataset.date);
            // Cambiamos la vista activa a 'day' y recargamos
            currentCalendarView = 'day';
            loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
        };
    });
}

function renderCalendarEventForm(event = null, onBackCallback, prefilledStartDate = null, prefilledEndDate = null) {
    navigationHistory.push(onBackCallback);
    updateBackButton();
    const isEditing = event && event.id;
    let currentNotifications = (isEditing && event.notificaciones) ? 
        event.notificaciones.map(n => ({ metodo: n.metodo, minutosAntes: n.minutosAntes })) : 
        [];

    const colorOptionsHtml = EVENT_COLORS_PRESETS.map(preset => 
        `<div class="custom-dropdown-item" data-value="${preset.value}">
            <span class="color-swatch" style="background-color:${preset.value};"></span>
            <span>${preset.label}</span>
        </div>`
    ).join('');
    
    const selectedColor = (isEditing && event.color) ? EVENT_COLORS_PRESETS.find(p => p.value === event.color) || EVENT_COLORS_PRESETS[0] : EVENT_COLORS_PRESETS[0];

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>${isEditing ? '‚úèÔ∏è Editar Evento' : '‚ûï Nuevo Evento'}</h2></div>
            <div class="form-card">
                <label>T√≠tulo</label><input type="text" id="event-title" value="${isEditing ? event.titulo : ''}" required />
                <label>Descripci√≥n</label><textarea id="event-description" rows="5">${isEditing ? event.descripcion : ''}</textarea>
                <div class="settings-item"><span class="settings-item-label">Todo el d√≠a</span><label class="switch"><input type="checkbox" id="event-all-day" ${isEditing && event.esTodoElDia ? 'checked' : ''}><span class="slider"></span></label></div>
                <div id="time-pickers">
                    <label>Inicio</label><input type="text" id="event-start-date" required/>
                    <label>Fin</label><input type="text" id="event-end-date" required/>
                </div>
                
                <label>Color</label>
                <div class="custom-dropdown">
                    <div class="custom-dropdown-selected" id="color-selector">
                        <span class="color-swatch" style="background-color:${selectedColor.value};"></span>
                        <span>${selectedColor.label}</span>
                    </div>
                    <div class="custom-dropdown-options" id="color-options">${colorOptionsHtml}</div>
                </div>
                <input type="hidden" id="event-color-value" value="${selectedColor.value}">

                <label style="margin-top:20px;">Notificaciones</label>
                <div id="notification-chips-container"></div>
                  <button id="add-notification-btn" style="width:100%; max-width:100%; margin:15px 0;" disabled>A√±adir Notificaci√≥n</button>
                <div class="button-group">
                    ${isEditing ? `<button id="delete-event-btn" class="cancel">Eliminar</button>` : `<button id="cancel-event-btn" class="cancel">Cancelar</button>`}
                    <button id="save-event-btn" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Evento'}</button>
                </div>
            </div>
        </div>`;
    
    const titleInput = document.getElementById('event-title');
    const saveBtn = document.getElementById('save-event-btn');
    const allDayCheckbox = document.getElementById('event-all-day');
    const timePickersDiv = document.getElementById('time-pickers');
    const chipsContainer = document.getElementById('notification-chips-container');
    const addNotificationBtn = document.getElementById('add-notification-btn');

    let initialStartDate; // Variable para almacenar la fecha de inicio original al cargar

    const fpEnd = flatpickr("#event-end-date", {
        enableTime: true, altInput: true, altFormat: "d/m/Y H:i", dateFormat: "Z", locale: "es",
        defaultDate: isEditing ? event.fechaFin : (prefilledEndDate || new Date(new Date().getTime() + 60 * 60 * 1000))
    });

    const fpStart = flatpickr("#event-start-date", {
        enableTime: true, altInput: true, altFormat: "d/m/Y H:i", dateFormat: "Z", locale: "es",
        defaultDate: isEditing ? event.fechaInicio : (prefilledStartDate || new Date()),
        onReady: function(selectedDates) {
            // Se ejecuta solo una vez al cargar. Guardamos la fecha inicial.
            if (selectedDates.length > 0) {
                initialStartDate = new Date(selectedDates[0].getTime());
            }
        },
        onChange: function(selectedDates) {
            const newStartDate = selectedDates[0];
            // Si no hay fecha o la fecha no ha cambiado desde la carga inicial, no hacemos nada.
            if (!newStartDate || !initialStartDate || newStartDate.getTime() === initialStartDate.getTime()) {
                return;
            }
            
            // Actualizamos la fecha de referencia para futuros cambios manuales.
            initialStartDate = new Date(newStartDate.getTime());

            const currentEndDate = fpEnd.selectedDates[0];
            if (!currentEndDate || newStartDate >= currentEndDate) {
                const newEndDate = new Date(newStartDate.getTime() + 60 * 60 * 1000);
                fpEnd.setDate(newEndDate, true);
            }
        }
    });

    const toggleTimePickers = () => {
        const isAllDay = allDayCheckbox.checked;
        timePickersDiv.style.display = isAllDay ? 'none' : 'block';
        const newFormat = isAllDay ? "d/m/Y" : "d/m/Y H:i";
        fpStart.set('enableTime', !isAllDay);
        fpEnd.set('enableTime', !isAllDay);
        fpStart.set('altFormat', newFormat);
        fpEnd.set('altFormat', newFormat);
        fpStart.redraw();
        fpEnd.redraw();
    };
    allDayCheckbox.onchange = toggleTimePickers;
    toggleTimePickers();

    const colorSelector = document.getElementById('color-selector');
    const colorOptions = document.getElementById('color-options');
    const colorValueInput = document.getElementById('event-color-value');
    colorSelector.onclick = () => colorOptions.style.display = colorOptions.style.display === 'block' ? 'none' : 'block';
    
    colorOptions.querySelectorAll('.custom-dropdown-item').forEach(item => {
        item.onclick = () => {
            const value = item.dataset.value;
            const label = item.querySelector('span:last-child').textContent;
            colorValueInput.value = value;
            colorSelector.querySelector('.color-swatch').style.backgroundColor = value;
            colorSelector.querySelector('span:last-child').textContent = label;
            colorOptions.style.display = 'none';
        };
    });
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-dropdown')) {
            colorOptions.style.display = 'none';
        }
    }, true);
    
    const getNotificationText = (notif) => {
        const mins = notif.minutosAntes;
        let text = '';
        if (mins >= 1440 && mins % 1440 === 0) text = `${mins/1440} d√≠a(s) antes`;
        else if (mins >= 60 && mins % 60 === 0) text = `${mins/60} hora(s) antes`;
        else text = `${mins} minutos antes`;
        if (notif.metodo === 'email') text += ' - correo';
        return text;
    };

    const renderChips = () => {
        chipsContainer.innerHTML = '';
        currentNotifications.forEach((notif, index) => {
            const chip = document.createElement('div');
            chip.className = 'notification-chip';
            chip.innerHTML = `<span>${getNotificationText(notif)}</span><span class="notification-chip-remove" data-index="${index}">&times;</span>`;
            chip.querySelector('.notification-chip-remove').onclick = (e) => {
                currentNotifications.splice(parseInt(e.target.dataset.index, 10), 1);
                renderChips();
            };
            chipsContainer.appendChild(chip);
        });
    };

    addNotificationBtn.onclick = () => showNotificationModal(currentNotifications, renderChips);
    renderChips();

    // --- L√ìGICA DE ACTIVACI√ìN INTELIGENTE ---
        const validate = () => { 
        const isValid = titleInput.value.trim() !== '';
        saveBtn.disabled = !isValid;
        addNotificationBtn.disabled = !isValid; // Controla la funcionalidad
        saveBtn.classList.toggle('enabled', isValid); // Controla el estilo visual de "Guardar"
        addNotificationBtn.classList.toggle('enabled', isValid); // <-- ESTA L√çNEA FALTABA Y SOLUCIONA TODO
    };
    titleInput.oninput = validate;
    validate(); // Llamada inicial para establecer el estado correcto al cargar
    
    saveBtn.onclick = () => {
        const finalEventData = isEditing ? { ...event } : {};
        finalEventData.notificaciones = currentNotifications;
        saveCalendarEvent(finalEventData);
    };

    if (isEditing) {
        document.getElementById('delete-event-btn').onclick = () => { confirmDelete('calendar_event', event.id); };
    } else {
        document.getElementById('cancel-event-btn').onclick = goBack;
    }
}
function showNotificationModal(currentNotificationsRef, renderChipsCallback) {
    const modal = document.getElementById('notification-modal');
    const presetsView = document.getElementById('notification-presets-view');
    const customView = document.getElementById('notification-custom-view');
    const presetsList = document.getElementById('notification-presets-list');
    
    const notificationPresets = [
        { label: '5 minutos antes', value: 5, method: 'telegram' },
        { label: '10 minutos antes', value: 10, method: 'telegram' },
        { label: '1 hora antes', value: 60, method: 'telegram' },
        { label: '2 horas antes - correo', value: 120, method: 'email' },
        { label: '2 horas antes', value: 120, method: 'telegram' },
        { label: '1 d√≠a antes - correo', value: 1440, method: 'email' },
        { label: 'Personalizar...', value: 'custom' }
    ];

    presetsList.innerHTML = notificationPresets.map(p => {
        const icon = p.method === 'email' ? '‚úâÔ∏è' : 'üîî';
        return `
        <div class="preset-list-item" data-value='${JSON.stringify(p)}'>
             <span style="font-size:1.5rem; width: 35px; text-align:center;">${icon}</span>
             <span>${p.label}</span>
        </div>`;
    }).join('');

    const hideModal = () => {
        modal.classList.remove('show');
        setTimeout(() => { modal.style.display = 'none'; }, 300);

        // --- INICIO: Restaurar el comportamiento original del bot√≥n "Atr√°s" ---
        // Al cerrar el modal, devolvemos al bot√≥n "Atr√°s" su funci√≥n de navegaci√≥n normal.
        tg.BackButton.onClick(goBack);
        updateBackButton(); // Esto lo ocultar√° si no hay m√°s historial de navegaci√≥n.
        // --- FIN: Restaurar el comportamiento ---
    };

    const addNotification = (notifData) => {
        if (currentNotificationsRef.length >= 5) {
            showToast("Puedes a√±adir un m√°ximo de 5 notificaciones.", true);
            return;
        }
        currentNotificationsRef.push({ 
            metodo: notifData.method, 
            minutosAntes: notifData.value, 
            status: 'pending_creation' 
        });
        renderChipsCallback();
        hideModal();
    };

    presetsList.querySelectorAll('.preset-list-item').forEach(item => {
        item.onclick = () => {
            const data = JSON.parse(item.dataset.value);
            if (data.value === 'custom') {
                presetsView.style.display = 'none';
                customView.style.display = 'block';
            } else {
                addNotification(data);
            }
        };
    });

    document.getElementById('notification-modal-cancel').onclick = hideModal;
    document.getElementById('custom-notification-back').onclick = () => {
        customView.style.display = 'none';
        presetsView.style.display = 'block';
    };
    document.getElementById('custom-notification-done').onclick = () => {
        const value = parseInt(document.getElementById('custom-notification-value').value, 10);
        const unit = document.querySelector('input[name="custom_unit"]:checked').value;
        const method = document.querySelector('input[name="custom_method"]:checked').value;
        if (isNaN(value) || value < 1) {
            showToast("Introduce un n√∫mero v√°lido.", true);
            return;
        }
        let mins = value;
        if (unit === 'hours') mins = value * 60;
        else if (unit === 'days') mins = value * 1440;
        
        addNotification({ value: mins, method: method });
        
        setTimeout(() => {
            customView.style.display = 'none';
            presetsView.style.display = 'block';
        }, 300);
    };

    modal.onclick = (e) => { if (e.target === modal) hideModal(); };
    
    // --- INICIO: L√≥gica para controlar el bot√≥n "Atr√°s" del m√≥vil ---
    // Justo antes de mostrar el modal, le decimos al bot√≥n "Atr√°s" que su nueva
    // funci√≥n es, simplemente, cerrar el modal.
    if (tg && tg.BackButton) {
        tg.BackButton.onClick(hideModal);
        tg.BackButton.show();
    }
    // --- FIN: L√≥gica para controlar el bot√≥n "Atr√°s" ---

    modal.style.display = 'flex';
    setTimeout(() => { modal.classList.add('show'); }, 10);
}
async function saveCalendarEvent(eventData) {
    showSpinner("Guardando evento...");
    const title = document.getElementById('event-title').value.trim();
    // Determinamos si estamos editando bas√°ndonos en si eventData tiene un ID.
    const isEditing = eventData && eventData.id;

    if (!title) {
        showToast("El t√≠tulo es obligatorio.", true);
        hideSpinner();
        return;
    }

    try {
        const isAllDay = document.getElementById('event-all-day').checked;
        let startDate, endDate;
        
        // Obtenemos las fechas del formulario
        startDate = document.getElementById('event-start-date')._flatpickr.selectedDates[0];
        endDate = document.getElementById('event-end-date')._flatpickr.selectedDates[0];

        // L√≥gica para eventos de "Todo el d√≠a"
        if (isAllDay) {
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(startDate); 
            endDate.setHours(23, 59, 59, 999);
        }

        // Validaci√≥n de fechas
        if (endDate < startDate) {
            hideSpinner();
            showToast("La fecha de fin no puede ser anterior a la de inicio.", true);
            return;
        }

        // Leemos las notificaciones desde la variable `eventData.notificaciones` (del sistema de chips)
        // y la transformamos a la estructura que tu backend necesita.
        const notificationsToSave = (eventData.notificaciones || []).map(notif => ({
            metodo: notif.metodo,
            minutosAntes: notif.minutosAntes,
            trigger_id: null,
            status: 'pending_creation'
        }));

        // Construimos el objeto final con la estructura requerida por tus activadores
        const dataToSave = {
            titulo: title,
            descripcion: document.getElementById('event-description').value.trim(),
            color: document.getElementById('event-color-value').value,
            fechaInicio: firebase.firestore.Timestamp.fromDate(startDate),
            fechaFin: firebase.firestore.Timestamp.fromDate(endDate),
            esTodoElDia: isAllDay,
            notificaciones: notificationsToSave,
            status: 'pending_creation'
        };
        
        const collectionRef = db.collection('users').doc(chatId).collection(FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION);

        if (isEditing) {
            await collectionRef.doc(eventData.id).set(dataToSave, { merge: true });
            showToast("Evento actualizado.");
        } else {
            await collectionRef.add(dataToSave);
            showToast("Evento creado.");
        }
        
        goBack(); // Volvemos a la vista del calendario

    } catch (err) {
        console.error("Error guardando evento en Firestore:", err);
        showToast(`Error al guardar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

async function handleDeleteCalendarEvent(eventId) {
    showSpinner("Eliminando...");
    try {
        // Ahora llamamos al backend para que √©l se encargue de todo
        const payload = { 
            Type: 'delete_calendar_event', 
            chat_ID: chatId, 
            eventId: eventId 
        };
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();

        if (data.error) throw new Error(data.error);
        
        showToast("Evento eliminado.");
        // El listener de Firestore en la vista del calendario se encargar√° de actualizar la UI
        
    } catch (err) { 
        showToast(`Error al eliminar: ${err.message}`, true); 
    } finally { 
        hideSpinner(); 
    }
}
// ==================================================
// --- CONECTOR E INICIO DE LA APP ---
// ==================================================
function renderDashboard() {
  removeCalendarFAB();
  setActiveTab('tab-home');
  navigationHistory = [];
  updateBackButton();
  const counts = appData.counts;
  const isPremium = appData.isPremium === true;

  let chefCardHtml = '';
  if (isPremium) {
    chefCardHtml = `<div class="card clickable-card" id="chef-card"><div class="card-icon">üßë‚Äçüç≥</div><div class="card-title">Chef</div></div>`;
  } else {
    // --- LA CORRECCI√ìN CLAVE ---
    // A√±adimos el id 'chef-card-locked' para poder aplicar el estilo espec√≠fico.
    chefCardHtml = `<div class="card disabled-card" id="chef-card-locked"><div class="card-icon">üßë‚Äçüç≥</div><div class="card-title">Chef ‚≠ê</div></div>`;
  }
  
  // La tarjeta del calendario ya es activa y llama a renderCalendarView
  const calendarCardHtml = `<div class="card clickable-card" id="calendar-card"><div class="card-badge red" style="left:12px;" id="calendar-badge">${counts.calendarTodayCount || 0}</div><div class="card-icon">üóìÔ∏è</div><div class="card-title">Calendario</div></div>`;
  const cuentasClarasCardHtml = `<div class="card disabled-card" id="cuentas-claras-card"><div class="card-icon">‚öñÔ∏è</div><div class="card-title">Cuentas Claras</div></div>`;

  mainContentArea.innerHTML = `
    <div class="grid">
      <div class="card clickable-card"><div class="card-badge red" style="left:12px;" id="reminders-badge">${counts.remindersCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-recordatorios">‚ãÆ</button><div class="card-icon">‚úçÔ∏èÔ∏è</div><div class="card-title">Avisarme</div><div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">A√±adir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div></div>
      <div class="card clickable-card"><div class="card-badge-group"><div class="card-badge green" id="shopping-pending-badge">${counts.shoppingPendingCount || 0}</div><div class="card-badge red" id="shopping-bought-badge">${counts.shoppingBoughtCount || 0}</div></div><button class="card-menu-btn" data-menu-id="menu-shopping-list">‚ãÆ</button><div class="card-icon">üõí</div><div class="card-title">Compras</div><div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">A√±adir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div></div>
      <div class="card clickable-card"><div class="card-badge red" style="left:12px;" id="notes-badge">${counts.notesCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-notes">‚ãÆ</button><div class="card-icon">üìù</div><div class="card-title">Notas</div><div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">A√±adir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div></div>
      ${calendarCardHtml}
      <div class="card clickable-card"><div class="card-badge card-badge-pill red" style="left:12px;" id="gastos-badge">${Number(counts.gastosMesActual || 0).toLocaleString('es-ES', { maximumFractionDigits: 0 })} ${appData.settings.moneda || ''}</div><button class="card-menu-btn" data-menu-id="menu-gastos">‚ãÆ</button><div class="card-icon">üí∞</div><div class="card-title">Gastos</div><div class="dropdown-menu" id="menu-gastos"><a class="dropdown-item" id="add-gasto-link">A√±adir</a><a class="dropdown-item" id="scan-gasto-link">Escanear Ticket</a><a class="dropdown-item" id="list-gastos-link">Ver/Buscar</a><a class="dropdown-item" id="view-gasto-chart-link">Ver Gr√°fico</a></div></div>
      ${cuentasClarasCardHtml}
      ${chefCardHtml}
      <div id="guia-tv-card" class="card clickable-card"><div class="card-icon">üì∫</div><div class="card-title">Gu√≠a TV</div></div>
    </div>`;
  
  document.getElementById('add-reminder-link').onclick = renderReminderForm;
  document.getElementById('list-reminders-link').onclick = renderRemindersList;
  document.getElementById('view-shopping-list-link').onclick = renderShoppingList;
  document.getElementById('add-shopping-item-link').onclick = renderAddArticleForm;
  document.getElementById('add-note-link').onclick = () => renderNoteForm();
  document.getElementById('list-notes-link').onclick = renderNotesList;
  document.getElementById('scan-gasto-link').onclick = renderInstructionScreen;
  document.getElementById('add-gasto-link').onclick = () => renderAddGastoForm();
  document.getElementById('guia-tv-card').onclick = renderGuiaTV;
  document.getElementById('list-gastos-link').onclick = () => {
      navigationHistory.push(renderDashboard);
      updateBackButton();
      renderGastosSearchScreen();
  };
  document.getElementById('view-gasto-chart-link').onclick = renderGastoChart;

  document.getElementById('calendar-card').onclick = renderCalendarView; // Ahora llama a nuestra nueva funci√≥n
  document.getElementById('cuentas-claras-card').onclick = () => showToast('Funci√≥n en desarrollo.');
  
  if (isPremium) {
    const chefCard = document.getElementById('chef-card');
    if (chefCard) chefCard.onclick = renderChefPage;
  } else {
    const chefCardLocked = document.getElementById('chef-card-locked');
    if (chefCardLocked) chefCardLocked.onclick = () => showToast('‚≠ê Funci√≥n exclusiva para usuarios Premium.');
  }

  // --- C√ìDIGO RESTAURADO PARA LOS MEN√öS ---
  // Este es el bloque que faltaba y que repara los men√∫s desplegables.
  document.querySelectorAll('.clickable-card').forEach(card => {
      card.addEventListener('click', (e) => {
          if (e.target.closest('.card-menu-btn') || e.target.closest('.dropdown-menu')) return;
          if (e.currentTarget.id === 'chef-card' && !isPremium) return;
          e.stopPropagation();
          const menuBtn = card.querySelector('.card-menu-btn');
          if (menuBtn) {
            const menuId = menuBtn.dataset.menuId;
            const menu = document.getElementById(menuId);
            if (menu) {
                const isShown = menu.classList.contains('show');
                document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                    if (m.id !== menuId) m.classList.remove('show');
                });
                if (isShown) {
                    menu.classList.remove('show');
                } else {
                    const buttonRect = menuBtn.getBoundingClientRect();
                    const windowHeight = window.innerHeight;
                    if (buttonRect.top > (windowHeight / 2)) {
                        menu.classList.add('up');
                    } else {
                        menu.classList.remove('up');
                    }
                    menu.classList.add('show');
                }
            }
          }
      });
  });
  // --- FIN DEL C√ìDIGO RESTAURADO ---
}

// L√≥gica de pesta√±as
document.getElementById('tab-home').onclick = renderDashboard;
document.getElementById('tab-settings').onclick = renderSettings;
document.getElementById('tab-export').onclick = renderExportPage;
document.getElementById('tab-chef').onclick = () => {
    if (String(appData.settings.Premium).toLowerCase() === 'si') {
        renderChefPage();
    }
};
loadEmojiDictionary(); // Carga el diccionario de emojis
initializeApp();
});
</script>
</body>
</html>
