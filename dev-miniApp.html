<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- SDKs de Firebase para la Mini App (Cargados de forma segura) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- SDKs de Firebase para la Mini App -->

  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card.clickable-card { cursor: pointer; }
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:12px;min-width:24px;height:24px;padding:0 7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:24px;font-weight:500;}
	.card-badge.card-badge-pill {
    width: auto;
    height: auto;
    min-width: 0;
    border-radius: 999px;
    padding: 3px 10px;
    line-height: 1.4;
}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;}
    .card-badge.red{background-color:#e74c3c;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; z-index: 10; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
    .dropdown-menu.up { top: auto; bottom: 100%; margin-bottom: 5px; }
    .dropdown-item { padding: 12px 20px; color: var(--text) !important; background-color: var(--card-bg, #fff) !important; cursor: pointer; display: block; text-align: left; transition: background-color 0.2s, color 0.2s; }
    .dropdown-item:hover { background-color: var(--primary, #4a76f3) !important; color: var(--action-text, #fff) !important; }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container, .settings-container, .export-container, .chef-container {max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input, .form-card select, .form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input, .form-card select{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text); background-color: var(--bg, #f5f7fa);}
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center; flex-wrap: wrap;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .form-card .button-group { display: flex; gap: 10px; margin-top: 20px; }
    .form-card .button-group button { flex: 1; margin-top: 0; }
    .form-card button.cancel { background-color: var(--delete-bg); opacity: 1; cursor: pointer; }
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 2s linear infinite;z-index:1001; text-align: center;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .list-style-none { list-style: none; padding: 0; margin: 0; }
    .list-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .list-item-content { display: flex; flex-direction: column; flex-grow: 1; text-align: left;}
    .list-item-title { font-size: 1.1rem; font-weight: 500; }
    .list-item-subtitle { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .list-item-actions { display: flex; align-items: center; gap: 5px; position: relative; flex-shrink: 0; }
    .generic-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-data-msg { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; font-size: 1.2rem; line-height: 1.5; }
    #recurrent-hours-container { display: none; margin-top: 15px; }
    .shopping-list-header-row { display: flex; align-items: center; justify-content: flex-end; padding: 0 10px 10px 10px; color: var(--muted); font-size: 0.9rem; }
    .shopping-list-header-row input[type="checkbox"] { margin-left: 5px; }
    .shopping-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .shopping-item-checkbox-wrapper { flex-shrink: 0; }
    .shopping-item input[type="checkbox"] { width: 20px; height: 20px; }
    .shopping-item-toggle-btn { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; color: var(--list-item-text); cursor: pointer; text-align: left; }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); }
    .shopping-item-toggle-btn .item-date { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; display:block; }
    .add-article-btn-container { padding: 10px; text-align: center; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .add-article-btn, .multi-select-action-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; flex-grow: 1; max-width: 250px; }
    .multi-select-action-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .shopping-list-section-title { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 10px 10px 10px; padding-top: 10px; border-top: 1px solid #eee; text-align: left; }
    .shopping-list-section-title:first-of-type { border-top: none; margin-top: 0; }
    .note-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .note-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; }
    .note-header-interactive { flex-grow: 1; padding-right: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .note-title-section { display: flex; flex-direction: column; text-align: left; }
    .note-title { font-size: 1.1rem; font-weight: 500; }
    .note-date { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .note-description { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    .note-item.open .note-description { max-height: 500px; padding: 0 15px 15px; }
    .expand-arrow { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
    .note-item.open .expand-arrow { transform: rotate(180deg); }
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; text-align: left;}
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; display: none; }
    .list-item.open .event-description { display: block; }
    .gasto-chart-container { text-align: center; margin-top: 15px; }
    .gasto-chart-container canvas { max-width: 100%; }
    .gasto-legend { list-style: none; padding: 15px 0 0 0; margin: 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .gasto-legend-item { display: flex; align-items: center; font-size: 0.9rem; }
    .gasto-legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; }
    .notification-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
    .notification-row .event-reminder-method { flex: 2 1 auto; min-width: 120px; }
    .notification-row .event-reminder-quantity { flex: 1 1 60px; text-align: right; }
    .notification-row .event-reminder-unit { flex: 2 1 auto; min-width: 90px; }
    .notification-row .remove-notification-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 0 5px; flex-shrink: 0; line-height: 1; }
    .notification-row select, .notification-row input { margin-top: 0 !important; width: auto; }
    #image-preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    #image-preview-element { max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    #image-preview-actions { display: flex; gap: 20px; margin-top: 20px; width: 100%; max-width: 400px; }
    #image-preview-actions button { flex: 1; padding: 15px; font-size: 1.2rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; }
    #preview-send-btn { background-color: var(--action-bg); color: var(--action-text); }
    #preview-cancel-btn { background-color: var(--delete-bg); color: var(--delete-text); }
    .scan-instruction-screen { text-align: center; padding: 40px 20px; display: flex; flex-direction: column; justify-content: center; height: 100vh; }
    .scan-instruction-screen h2 { font-size: 1.6rem; margin-bottom: 20px; }
    .scan-instruction-screen ol { text-align: left; margin: 0 auto 30px auto; max-width: 300px; }
    .scan-instruction-screen li { margin-bottom: 10px; line-height: 1.5; }
    .scan-instruction-screen .add-article-btn { max-width: 100%; }
    .dropdown-item { background-color: var(--menu-bg, #fff); }
    .form-card textarea, .form-card input, .form-card select { background-color: var(--card-bg, #fff); color: var(--text, #333); border: 1px solid var(--muted, #ddd); }
    .dropdown-menu { background-color: var(--card-bg, #fff); }
    .settings-section-title { font-size: 1.3rem; font-weight: 600; color: var(--text); margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid #eee; text-align: left;}
    .settings-section-title:first-of-type { margin-top: 0; }
    .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
    .settings-item-label { font-size: 1.1rem; }
    .settings-item-control { flex-shrink: 0; margin-left: 15px; }
    .settings-item-control input, .settings-item-control select { margin-top:0 !important; width: auto; max-width: 150px;}
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }
    .chef-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .chef-item label { margin-top:0; }
    #chef-peticion-ayuda { font-size: 0.85rem; color: var(--muted); margin-top: 5px; display: block; }
    .recipe-card { background: var(--card-bg); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .recipe-header { padding: 15px; border-bottom: 1px solid #eee; }
    .recipe-title { font-size: 1.2rem; font-weight: 600; }
    .recipe-body { padding: 15px; }
    .recipe-description { margin-bottom: 15px; line-height: 1.5; }
    .recipe-subtitle { font-size: 1rem; font-weight: 500; margin-bottom: 8px; }
    .recipe-ingredient-list li { list-style: none; margin-bottom: 5px; }
    .recipe-ingredient-list.buy li { display: flex; align-items: center; }
    .recipe-ingredient-list.buy input { margin-right: 10px; width: 18px; height: 18px; }
    #chef-image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .preview-item { position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; }
    .preview-image { width: 100%; height: 100%; object-fit: cover; }
    .delete-preview-btn { position: absolute; top: 4px; right: 4px; width: 22px; height: 22px; background-color: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; font-size: 14px; line-height: 22px; text-align: center; cursor: pointer; font-weight: bold; }
    .tab-premium-locked {
        cursor: not-allowed;
        opacity: 0.6;
        pointer-events: none; /* Bloquea los clics */
    }
    .list-item.clickable {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .list-item.clickable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* --- INICIO C√ìDIGO NUEVO --- */
    .card.disabled-card {
        position: relative;
        cursor: not-allowed;
        overflow: hidden; /* Importante para la banda */
    }
    .card.disabled-card::before {
        content: "En desarrollo";
        position: absolute;
        top: 25px;
        right: -35px;
        background-color: #f39c12; /* Color naranja */
        color: white;
        padding: 5px 30px;
        transform: rotate(45deg);
        font-size: 0.8rem;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 5;
    }
    .card.disabled-card .card-icon, .card.disabled-card .card-title, .card.disabled-card .card-badge {
        opacity: 0.5;
    }
    /* --- FIN C√ìDIGO NUEVO --- */
   /* --- INICIO C√ìDIGO SPLASH SCREEN --- */
.splash-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--bg, #f5f7fa);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease-out;
  opacity: 1;
}
.splash-screen.hidden {
  opacity: 0;
  pointer-events: none;
}
.splash-logo {
  width: 120px;
  height: 120px;
  animation: pulse 1.5s infinite ease-in-out;
}
.splash-text {
  margin-top: 20px;
  font-size: 1.2rem;
  color: var(--muted, #555);
}
@keyframes pulse {
  0% { transform: scale(0.95); }
  50% { transform: scale(1); }
  100% { transform: scale(0.95); }
}
/* --- FIN C√ìDIGO SPLASH SCREEN --- */  
  </style>
  <script>
    // Configuraci√≥n de Firebase para el cliente (conexi√≥n directa y segura)
    const firebaseConfig = {
      apiKey: "AIzaSyBNldvtTk0JwwydigAmiI2k1RRZpYriK_E",
      authDomain: "asistentepersonal-4ad2b.firebaseapp.com",
      projectId: "asistentepersonal-4ad2b",
      storageBucket: "asistentepersonal-4ad2b.firebasestorage.app",
      messagingSenderId: "1068752893536",
      appId: "1:1068752893536:web:ad23509d45dc7d448bf505"
    };
  </script>
</head>
<body>
  <!-- --- INICIO SPLASH SCREEN --- -->
	<div id="splash-screen" class="splash-screen">
  <img src="https://lh3.googleusercontent.com/d/1zQd1rn14IFHAGYHn95GVvILTB90i3320" alt="Logo" class="splash-logo" />
  <div class="splash-text">Cargando tu asistente...</div>
	</div>
<!-- --- FIN SPLASH SCREEN --- -->
  <div id="spinner" class="spinner"></div>
  <div id="main-content-area">
  </div>
    <div class="tabs">
    <div class="tab active" id="tab-home">üè† Home</div>
    <div class="tab" id="tab-chef">üßë‚Äçüç≥ Chef</div>
    <div class="tab" id="tab-export">üìä Exportar Gastos</div>
    <div class="tab" id="tab-settings">‚öôÔ∏è Ajustes</div>
  </div>
  <div id="toast" class="toast"></div>
  <div id="image-preview-overlay" style="display: none;">
    <img id="image-preview-element" src="" alt="Vista previa del ticket" />
    <div id="image-preview-actions">
        <button id="preview-cancel-btn">Cancelar</button>
        <button id="preview-send-btn">Enviar</button>
    </div>
  </div>
  
<script>
    document.addEventListener('DOMContentLoaded', () => {
    
// =========================================================================
// --- NUEVA L√ìGICA DE ARRANQUE (FIRESTORE FIRST) ---
// =========================================================================
const HTML_VERSION = "1.2.10"; // IMPORTANTE: Incrementa la versi√≥n del cliente.

async function initializeApp() {
    if (isInitializing) return;
    isInitializing = true;
    console.log("Iniciando app desde Firestore...");
    
    // El Splash Screen ya est√° visible por defecto, no necesitamos mostrarlo.
    // showSpinner() ya no es necesario aqu√≠.

    try {
        // --- Paso 1: Inicializar Firebase ---
        // Esto es s√≠ncrono y muy r√°pido.
        if (typeof firebaseConfig !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            window.db = firebase.firestore();
            console.log("Firebase inicializado correctamente.");
        } else {
            console.log("Firebase ya estaba inicializado.");
        }
        
        // --- Paso 2: Lanzar todas las lecturas a Firestore en paralelo ---
        const versionPromise = db.collection('app_config').doc('version_info').get();
        const userSettingsPromise = db.collection('users').doc(chatId).get();
        const userCountsPromise = db.collection('users').doc(chatId).collection('_metadata').doc('counts').get();
        
        const [versionDoc, userSettingsDoc, userCountsDoc] = await Promise.all([
            versionPromise,
            userSettingsPromise,
            userCountsPromise
        ]);

		// --- PUNTO DE DEPURACI√ìN 1: VERIFICAR CARGA INICIAL ---
		console.log("1. DATOS INICIALES DESDE FIRESTORE:", JSON.parse(JSON.stringify(userCountsDoc.data())));
		// --- FIN DEPURACI√ìN ---

        // --- Paso 3: Comprobar la versi√≥n de la app ---
        const serverVersion = versionDoc.exists ? versionDoc.data().current_version : "0.0.0";
        if (serverVersion !== HTML_VERSION) {
            console.log(`Nueva versi√≥n detectada. Servidor: ${serverVersion}, Cliente: ${HTML_VERSION}. Recargando...`);
            showToast("Actualizando aplicaci√≥n...", false);
            // Damos un peque√±o margen para que el toast sea visible antes de recargar.
            setTimeout(() => window.location.reload(true), 1500);
            return; // Detenemos la ejecuci√≥n para esperar la recarga.
        }

        // --- Paso 4: Validar y poblar los datos del usuario ---
        if (!userSettingsDoc.exists) {
            // Este es un caso cr√≠tico: el usuario no existe en la BD.
            mainContentArea.innerHTML = `<div class="no-data-msg">üö´<br>Usuario no encontrado.<br><small>No se pudo cargar tu perfil. Contacta con soporte.</small></div>`;
            document.querySelector('.tabs').style.display = 'none';
            hideSplashScreen(); // Ocultamos el splash para mostrar el error.
            return;
        }

        // Poblamos appData con los datos le√≠dos.
        appData.settings = userSettingsDoc.data() || {}; // Carga todo el documento del usuario en los ajustes.
        appData.isPremium = userSettingsDoc.data().plan_basic === false;
        
        if (userCountsDoc.exists) {
            appData.counts = userCountsDoc.data();
        } else {
            // Si no hay documento de contadores, los dejamos en 0 por defecto.
            console.warn("No se encontr√≥ documento de contadores para el usuario. Se usar√°n valores por defecto.");
        }
        
        appData.isSecondaryDataLoaded = false; // A√∫n no hemos cargado listas detalladas.

        // --- Paso 5: Renderizar la interfaz y ocultar el splash screen ---
        updateChefTabStyle();
        renderDashboard();
		isAppReady = true;
        hideSplashScreen();
        
    } catch (err) {
        console.error("Error cr√≠tico en initializeApp:", err);
        showToast(`Error de inicializaci√≥n: ${err.message}`, true);
        mainContentArea.innerHTML = `<div class="no-data-msg">üîå<br>Error de conexi√≥n.<br><small>No se pudo conectar con el servidor. Int√©ntalo de nuevo m√°s tarde.</small></div>`;
        hideSplashScreen(); // Ocultar splash para mostrar el error.
    } finally {
        isInitializing = false;
        console.log("Inicializaci√≥n de Firestore finalizada.");
    }
}

function hideSplashScreen() {
    const splash = document.getElementById('splash-screen');
    if (splash) {
        splash.classList.add('hidden');
        // Opcional: eliminar el splash del DOM despu√©s de la transici√≥n para liberar memoria.
        setTimeout(() => {
            if (splash.parentNode) {
                splash.parentNode.removeChild(splash);
            }
        }, 600); // Debe coincidir con la duraci√≥n de la transici√≥n en el CSS.
    }
}

// --- SISTEMA DE NAVEGACI√ìN (HISTORIAL) ---
let navigationHistory = [];

function goBack() {
    if (navigationHistory.length > 0) {
        const previousStep = navigationHistory.pop();
        if (typeof previousStep === 'function') {
            previousStep();
        }
    }
    updateBackButton();
}

function updateBackButton() {
    if (!tg || !tg.BackButton) return;
    if (tg.isVersionAtLeast('6.1') && tg.BackButton) {
        if (navigationHistory.length > 0) {
            tg.BackButton.show();
        } else {
            tg.BackButton.hide();
        }
    }
}

const tg = window.Telegram?.WebApp;
if (tg) { 
    tg.expand(); 
    if (tg.isVersionAtLeast('6.1') && tg.BackButton) { tg.BackButton.onClick(goBack); }
    if (tg.themeParams) { 
        document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa'); 
        document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff'); 
        document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333'); 
        document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555'); 
        document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3'); 
        document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff'); 
    } 
    
    // =========================================================================
    // --- L√ìGICA DE SINCRONIZACI√ìN (VERSI√ìN ARQUITECT√ìNICAMENTE CORRECTA) ---
    // =========================================================================
    tg.onEvent('viewportChanged', async (event) => {
        // La √∫nica condici√≥n para actuar es que la app ya est√© lista y la ventana expandida.
        if (!isAppReady || !event.isStateStable || !tg.isExpanded) {
            return;
        }

        console.log("App maximizada y lista. Comprobando cambios...");
        
        try {
            // No necesitamos inicializar nada aqu√≠, ya est√° garantizado que db existe.
            const countsDoc = await db.collection('users').doc(chatId).collection('_metadata').doc('counts').get();
            if (!countsDoc.exists) {
                console.warn("No se encontr√≥ el documento de contadores durante la sincronizaci√≥n.");
                return;
            }

            const serverCounts = countsDoc.data();
            
            if (JSON.stringify(serverCounts) !== JSON.stringify(appData.counts)) {
                console.log("Cambios en contadores detectados. Actualizando UI...");
                
                appData.counts = serverCounts;
                renderDashboard();
                showToast("Datos sincronizados.", false);
                appData.isSecondaryDataLoaded = false;
            } else {
                console.log("Sin cambios detectados en los contadores.");
            }

        } catch (err) {
            console.error("Error en la sincronizaci√≥n al maximizar:", err);
        }
    });
}
const gasWebhookURL = 'https://script.google.com/macros/s/AKfycbwq5YTuS1yk_0irer9CKvc2Prev5XWUaKJLR_UpNaEkY42rg6TMSCqnXo3FqMmHUUSX/exec';
const chefWebhookURL = 'https://hook.eu2.make.com/p6z2dgx6medjbx47udphv5nz2blqcvm8';
const makeTicketWebhookUrl = 'https://hook.eu2.make.com/d3lj3iug4qsbyjdmalmh3sk491elhqps';
let selectedImageFile = null;
let chatId = tg?.initDataUnsafe?.user?.id?.toString();
let emojiDictionary = [];
const EMOJI_DB_URL = 'emoji-articulos-v1.json'; // Actualiza aqu√≠ a 'v2' en el futuro
// MODIFICACI√ìN: Si no hay chat_ID, el prompt es solo para desarrollo local
if (!chatId) { 
    if (window.location.href.includes("github.io") || window.location.href.includes("file://")) {
        chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', '6840956330'); 
    } else {
        // En producci√≥n o si no es desarrollo local y no hay chat_ID, mostrar mensaje de error
        document.body.innerHTML = `<div class="no-data-msg">‚ùå Error: No se pudo obtener tu ID de Telegram. Abre la Mini App desde un bot de Telegram.</div>`;
        throw new Error("Chat ID no disponible en entorno de producci√≥n.");
    }
}


let appData = { 
    counts: { // Inicializar contadores con valores por defecto
        remindersCount: 0, 
        shoppingPendingCount: 0, 
        shoppingBoughtCount: 0, 
        notesCount: 0, 
        calendarTodayCount: 0, 
        gastosMesActual: '0,00', 
        mesesActivosGastos: [] 
    }, 
    remindersList: [], 
    shoppingList: [], 
    notesList: [], 
    calendarEvents: [], 
    settings: {}, 
    isPremium: false, 
    isSecondaryDataLoaded: false 
};
let initialUserSettings = {};
let secondaryDataPromise = null;
const mainContentArea = document.getElementById('main-content-area');
const spinner = document.getElementById('spinner');

function showSpinner(message = '') { 
    spinner.innerHTML = message ? `<div style="color:var(--text); margin-top:50px; font-size:1rem;">${message}</div>` : ''; 
    spinner.style.display = 'block'; 
}
async function loadEmojiDictionary() {
    const cacheKey = `emojiCache-${EMOJI_DB_URL}`;
    try {
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
            console.log("Cargando diccionario de emojis desde el cach√© local.");
            emojiDictionary = JSON.parse(cachedData);
            return;
        }

        console.log("Descargando diccionario de emojis por primera vez...");
        const response = await fetch(EMOJI_DB_URL);
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        
        const data = await response.json();
        emojiDictionary = data;
        localStorage.setItem(cacheKey, JSON.stringify(data));

    } catch (error) {
        console.error("No se pudo cargar el diccionario de emojis:", error);
        // La app seguir√° funcionando, simplemente no a√±adir√° emojis.
    }
}
function generateCustomId(prefix) {
    const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
    return `${prefix}${randomPart}`;
}
function findEmojiForText(text) {
    if (!text || emojiDictionary.length === 0) return null;

    // Normalizar texto: min√∫sculas, sin tildes, y singularizar (aproximaci√≥n simple)
    const normalizedText = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const singularText = normalizedText.endsWith('es') ? normalizedText.slice(0, -2) : (normalizedText.endsWith('s') ? normalizedText.slice(0, -1) : normalizedText);

    for (const item of emojiDictionary) {
        // Comprobar si el texto singularizado est√° incluido en la etiqueta o en alguna de las palabras clave
        if (item.label.includes(singularText) || (item.tags && item.tags.some(tag => tag.includes(singularText)))) {
            return item.emoji;
        }
    }
    return null;
}
function hideSpinner() { spinner.style.display = 'none'; }
function showToast(msg, isError = false) { 
    let toastTimer; 
    clearTimeout(toastTimer); 
    const t = document.getElementById('toast'); 
    t.textContent = msg; 
    t.className = 'toast show' + (isError ? ' error' : ''); 
    toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); 
}

async function fetchWithTimeout(resource, payloadObject, isMakeWebhook = false) {
  const controller = new AbortController();
  const timeout = isMakeWebhook ? 60000 : 30000;
  const id = setTimeout(() => controller.abort(), timeout);
  let options = { method: 'POST', signal: controller.signal };
  if (isMakeWebhook) {
      const formData = new FormData();
      formData.append('prompt', payloadObject.prompt);
      if (payloadObject.image_count !== undefined) { formData.append('image_count', payloadObject.image_count); }
      if (payloadObject.images && payloadObject.images.length > 0) { payloadObject.images.forEach(imageFile => { formData.append('images', imageFile, imageFile.name); }); }
      options.body = formData;
  } else {
      const formData = new FormData();
      formData.append("postData", JSON.stringify(payloadObject));
      options.body = formData;
  }
  try {
    const response = await fetch(resource, options);
    clearTimeout(id);
    if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
    return response;
  } catch (error) {
    clearTimeout(id);
    if (error.name === 'AbortError') throw new Error('La solicitud tard√≥ demasiado.');
    throw error;
  }
}

let isInitializing = false;
let isAppReady = false;
let unsubscribeShoppingList = null;

/// --- CARGADOR DE DATOS SECUNDARIOS (OPTIMIZADO) ---
async function loadSecondaryData() {
    if (appData.isSecondaryDataLoaded) return;
	// --- PUNTO DE DEPURACI√ìN 2: VERIFICAR SI HAY INTERFERENCIA ---
	console.log("2. ENTRANDO A loadSecondaryData. Estado actual de los contadores:", JSON.parse(JSON.stringify(appData.counts)));
	// --- FIN DEPURACI√ìN ---
    
    console.log("Cargando datos secundarios por primera vez...");
    showSpinner("Cargando listas...");
    try {
        const secondaryData = await fetchWithTimeout(gasWebhookURL, { Type: 'get_secondary_data', chat_ID: chatId }).then(res => res.json());
        if (secondaryData.error) throw new Error(secondaryData.error);

        appData.remindersList = secondaryData.remindersList;
        appData.shoppingList = secondaryData.shoppingList;
        appData.calendarEvents = secondaryData.calendarEvents;
        
        // La siguiente l√≠nea es la causa del error NaN. Se comenta para que Firestore sea la √∫nica fuente.
        // appData.counts.gastosMesActual = secondaryData.gastosMesActual; 
        
        appData.counts.calendarTodayCount = secondaryData.calendarTodayCount;
        appData.counts.mesesActivosGastos = secondaryData.mesesActivosGastos;

        appData.isSecondaryDataLoaded = true;
        console.log("Datos secundarios cargados con √©xito.");
        
    } catch (err) {
        console.error("Error cargando datos secundarios:", err);
        showToast(`Error al cargar datos: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function setActiveTab(activeTabId) { 
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); 
  const activeTab = document.getElementById(activeTabId); 
  if (activeTab) activeTab.classList.add('active'); 
}

document.body.addEventListener('click', (e) => {
    const menuBtn = e.target.closest('.card-menu-btn, .generic-menu-btn');
    
    if (!menuBtn && !e.target.closest('.dropdown-menu')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
        return;
    }

    if (menuBtn) {
        e.stopPropagation();
        const menuId = menuBtn.dataset.menuId;
        const menu = document.getElementById(menuId);

        if (menu) {
            const isShown = menu.classList.contains('show');
            
            document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                if (m.id !== menuId) m.classList.remove('show');
            });

            if (isShown) {
                menu.classList.remove('show');
            } else {
                const buttonRect = menuBtn.getBoundingClientRect();
                const windowHeight = window.innerHeight;

                if (buttonRect.top > (windowHeight / 2)) {
                    menu.classList.add('up');
                } else {
                    menu.classList.remove('up');
                }
                
                menu.classList.add('show');
            }
        }
    }
});

function updateChefTabStyle() {
    const chefTab = document.getElementById('tab-chef');
    if (!chefTab) return;
    
    const isPremium = String(appData.settings?.Premium).toLowerCase() === 'si';
    
    if (isPremium) {
        chefTab.classList.remove('tab-premium-locked');
        chefTab.innerHTML = 'üßë‚Äçüç≥ Chef';
    } else {
        chefTab.classList.add('tab-premium-locked');
        chefTab.innerHTML = '‚≠ê Chef';
    }
}

window.confirmDelete = function(type, id) {
    const itemElement = document.getElementById(`item-${id}`);
    if (!itemElement) return;

    let actionsContainer, menuButton;

    if (itemElement.classList.contains('form-card')) {
        actionsContainer = itemElement.querySelector('.button-group');
        menuButton = null; 
    } else {
        actionsContainer = itemElement.querySelector('.list-item-actions');
        menuButton = actionsContainer.querySelector('.generic-menu-btn');
        const dropdown = actionsContainer.querySelector('.dropdown-menu');
        if (dropdown) dropdown.classList.remove('show');
        if (menuButton) menuButton.style.display = 'none';
    }
    
    actionsContainer.querySelectorAll('.confirm-btn-yes, .confirm-btn-no').forEach(btn => btn.remove());
    
    const confirmBtnYes = document.createElement('button');
    confirmBtnYes.className = 'confirm-btn-yes';
    confirmBtnYes.textContent = 'S√≠, Eliminar';
    confirmBtnYes.onclick = (e) => { e.stopPropagation(); executeDelete(type, id); };

    const confirmBtnNo = document.createElement('button');
    confirmBtnNo.className = 'confirm-btn-no';
    confirmBtnNo.textContent = 'No';
    confirmBtnNo.onclick = (e) => { 
        e.stopPropagation(); 
        if(menuButton) menuButton.style.display = 'block'; 
        confirmBtnYes.remove(); 
        confirmBtnNo.remove(); 
    };
    
    actionsContainer.appendChild(confirmBtnNo);
    actionsContainer.appendChild(confirmBtnYes);
}

async function executeDelete(type, id) {
    let payload = { chat_ID: chatId };
    let successMessage = '';
    
    try {
        switch(type) {
                case 'reminder':
        // --- L√≥gica optimista para la UI ---
        const reminderElem = document.getElementById(`item-${id}`);
        if (reminderElem) reminderElem.remove();
        const remIndex = appData.remindersList.findIndex(r => r.tracking_code === id);
        if (remIndex > -1) appData.remindersList.splice(remIndex, 1);
        appData.counts.remindersCount = Math.max(0, appData.counts.remindersCount - 1);
        renderDashboard();
        showToast('Cancelando recordatorio...');
    
        // --- Llamada al backend para la l√≥gica de cancelaci√≥n ---
        try {
            const payload = { 
                Type: 'cancel_reminder', 
                chat_ID: chatId, 
                tracking_code: id 
            };
            const res = await fetchWithTimeout(gasWebhookURL, payload);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            showToast('Recordatorio cancelado con √©xito.');
        } catch(err) {
            showToast(`Error de cancelaci√≥n: ${err.message}. Restaurando...`, true);
            initializeApp();
        }
        return; // Salir para no ejecutar c√≥digo antiguo.
            case 'note':
    // --- L√ìGICA OPTIMISTA (se mantiene) ---
    const noteItemElement = document.getElementById(`item-${id}`);
    if (noteItemElement) noteItemElement.remove();
    
    const noteIndexToDelete = appData.notesList.findIndex(n => n.Nota_ID === id);
    if (noteIndexToDelete > -1) {
        appData.notesList.splice(noteIndexToDelete, 1);
        appData.counts.notesCount = Math.max(0, appData.counts.notesCount - 1);
    }
    
    const notesListBadge = document.getElementById('notes-badge');
    if(notesListBadge) notesListBadge.textContent = appData.counts.notesCount;

    if (appData.notesList.length === 0) {
        const notesListUlContainer = document.getElementById('notes-list');
        if (notesListUlContainer) notesListUlContainer.innerHTML = '<div class="no-data-msg">üìù<br>No tienes notas guardadas.</div>';
    }

    showToast('Nota eliminada');
    
    // --- SINCRONIZACI√ìN EN SEGUNDO PLANO CON FIRESTORE ---
    try {
        const noteDocRef = db.collection('users').doc(chatId).collection('notas').doc(id);
        const countsDocRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

        // Ejecutamos ambas operaciones en un batch para asegurar consistencia
        const batch = db.batch();
        batch.delete(noteDocRef);
        batch.update(countsDocRef, {
            notesCount: firebase.firestore.FieldValue.increment(-1)
        });
        await batch.commit();
        console.log("Nota eliminada y contador actualizado en Firestore.");

    } catch(err) {
        console.error("Error al eliminar nota en Firestore:", err);
        showToast('Error de sincronizaci√≥n al eliminar. Recargando...', true);
        setTimeout(() => initializeApp(), 1500);
    }
    return; // Salimos para no ejecutar el fetch antiguo
            case 'calendar_event':
                payload.Type = 'delete_calendar_event'; payload.eventId = id; successMessage = 'Evento eliminado';
                const eventIndex = appData.calendarEvents.findIndex(e => e.id === id);
                if (eventIndex > -1) {
                    const event = appData.calendarEvents[eventIndex];
                    const eventDateStr = event.start.dateTime || event.start.date;
                    if (eventDateStr) {
                      const eventDate = new Date(eventDateStr).toISOString().split('T')[0];
                      if (eventDate === new Date().toISOString().split('T')[0]) { appData.counts.calendarTodayCount = Math.max(0, appData.counts.calendarTodayCount - 1); }
                    }
                    appData.calendarEvents.splice(eventIndex, 1);
                }
                renderCalendarView();
                break;
            case 'gasto':
                payload.Type = 'delete_gasto_id'; payload.ID_Unico = id; successMessage = 'Gasto eliminado';
                // La actualizaci√≥n de gastos y contadores se gestionar√° por el backend
                break;
            default: return;
        }

    } catch(e) { showToast('Error local al procesar.', true); return; }

    try {
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast(successMessage);

        // Forzar una resincronizaci√≥n de contadores del dashboard
        const syncCheck = await fetchWithTimeout(gasWebhookURL, { Type: 'resync_counts', chat_ID: chatId }).then(res => res.json());
        if (syncCheck.success) {
            appData.counts = syncCheck.counts; // Actualizar contadores localmente
            // No renderDashboard aqu√≠, ya que el delete/update puede venir desde una lista espec√≠fica
            // y el renderDashboard ya se encargar√° de refrescar los badges.
            // La lista de compras se actualiza via Firestore listener.
        } else {
            initializeApp(); // Si falla la resincronizaci√≥n, recarga completa
        }

    } catch (err) {
        showToast(`Error: ${err.message}. Restaurando...`, true);
        initializeApp();
    }
}

// ==================================================
// --- M√ìDULO: RECORDATORIOS ---
// ==================================================
function renderReminderForm() {
  navigationHistory.push(renderDashboard);
  updateBackButton();
  mainContentArea.innerHTML = `
    <div class="list-container">
      <div class="list-header"><h2>üìù Nuevo Recordatorio</h2></div>
      <div class="form-card">
        <label>Descripci√≥n</label><textarea id="text" rows="3" required></textarea>
        <label>Fecha y hora</label><input type="text" id="time" required/>
        <label>Tipo</label>
        <div class="radio-group" id="reminder-type-group">
          <label><input type="radio" name="category" value="Un solo uso" checked/> √önico</label>
          <label><input type="radio" name="category" value="Diario"/> Diario</label>
          <label><input type="radio" name="category" value="Recurrente"/> Recurrente</label>
        </div>
        <div id="recurrent-hours-container">
          <label>Repetir cada...</label>
          <select id="recurrent-hours">${[...Array(11).keys()].map(i => `<option value="${i + 2}">${i + 2} horas</option>`).join('')}</select>
        </div>
        <button id="sendBtn" disabled>Crear Recordatorio</button>
      </div>
    </div>`;
  const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), sendBtn = document.getElementById('sendBtn'), radios = document.querySelectorAll('input[name="category"]'), recurrentContainer = document.getElementById('recurrent-hours-container');
  flatpickr("#time", { enableTime: true, dateFormat: "Y-m-d H-i", defaultDate: new Date(), locale: "es", minDate: "today" });
  function toggleRecurrentField() { const selected = document.querySelector('input[name="category"]:checked').value; recurrentContainer.style.display = selected === 'Recurrente' ? 'block' : 'none'; }
  function validate() { const isValid = textInput.value.trim() !== '' && timeInput.value && document.querySelector('input[name="category"]:checked'); sendBtn.disabled = !isValid; sendBtn.classList.toggle('enabled', isValid); }
  textInput.oninput = validate; timeInput.oninput = validate; radios.forEach(r => r.onchange = () => { toggleRecurrentField(); validate(); });
  sendBtn.onclick = saveReminder;
  toggleRecurrentField(); validate();
}

async function saveReminder() {
  const category = document.querySelector('input[name="category"]:checked').value;
  const description = document.getElementById('text').value.trim();
  const time = document.getElementById('time')._flatpickr.selectedDates[0];
  const horas_recurrentes = (category === 'Recurrente') ? document.getElementById('recurrent-hours').value : null;

  if (!description || !time) {
    showToast("La descripci√≥n y la fecha son obligatorias.", true);
    return;
  }

  goBack();
  showToast('Guardando recordatorio...');

  try {
    const customId = generateCustomId('G-');
    const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const localTimeStr = time.toLocaleString('es-ES', { timeZone: userTimeZone, day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

    const reminderData = {
      descripcion: description,
      categoria_recordatorio: category,
      fecha_universal: time.toISOString(), // Guardar como String ISO 8601 (UTC / Zul√∫)
      status: "pending_creation",
      tracking_code: customId,
      chat_id: chatId.toString(),
      hora_local: localTimeStr,
      horas_recurrentes: horas_recurrentes ? parseInt(horas_recurrentes, 10) : null,
      trigger_id: null
    };

    const reminderRef = db.collection('users').doc(chatId).collection('notificaciones').doc(customId);
    const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
    
    await reminderRef.set(reminderData);
    await countsRef.update({
        remindersCount: firebase.firestore.FieldValue.increment(1)
    });

    // Actualizaci√≥n optimista de la UI
    appData.counts.remindersCount++;
    renderDashboard();
    showToast('Recordatorio programado.');

  } catch (err) { 
    showToast(`Error al guardar: ${err.message}.`, true); 
    initializeApp(); // Recarga completa en caso de error
  }
}

async function renderRemindersList() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    
    mainContentArea.innerHTML = `<div class="list-container"><div class="list-header"><h2>Recordatorios</h2></div><ul class="list-style-none" id="reminders-list"><div class="no-data-msg">Cargando...</div></ul></div>`;

    try {
        const q = db.collection('users').doc(chatId).collection('notificaciones')
                    .where('status', '==', 'active')
                    .orderBy('fecha_universal', 'asc');
        
        const snapshot = await q.get();
        const reminders = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            reminders.push({
                tracking_code: doc.id,
                Descripcion: data.descripcion,
                Categoria: data.categoria_recordatorio,
                Fecha: data.hora_local // Mostramos la hora local que guarda el backend
            });
        });
        appData.remindersList = reminders;

        let listHtml = (reminders.length > 0) ? reminders.map(item => `
            <li class="list-item" id="item-${item.tracking_code}">
                <div class="list-item-content">
                    <span class="list-item-title">${item.Descripcion}</span>
                    <span class="list-item-subtitle">${item.Categoria}: ${item.Fecha}</span>
                </div>
                <div class="list-item-actions">
                    <button class="generic-menu-btn" data-menu-id="menu-item-${item.tracking_code}">‚ãÆ</button>
                    <div class="dropdown-menu" id="menu-item-${item.tracking_code}">
                        <a class="dropdown-item" data-action="delete-reminder" data-tracking-code="${item.tracking_code}">Eliminar</a>
                    </div>
                </div>
            </li>`).join('') : '<div class="no-data-msg">üéâ<br>No tienes recordatorios activos.</div>';

        const listElement = document.getElementById('reminders-list');
        listElement.innerHTML = listHtml;
        listElement.addEventListener('click', (e) => {
            const target = e.target.closest('.dropdown-item[data-action="delete-reminder"]');
            if (target) {
                confirmDelete('reminder', target.dataset.trackingCode);
            }
        });

    } catch(err) {
        console.error("Error al cargar recordatorios:", err);
        showToast("Error al cargar la lista.", true);
        document.getElementById('reminders-list').innerHTML = '<div class="no-data-msg">‚ùå Error de conexi√≥n.</div>';
    }
}

async function editReminderDescription(item) {
  const newDescription = prompt('Editar descripci√≥n del recordatorio:', item.Descripcion);
  if (newDescription && newDescription.trim() !== '' && newDescription.trim() !== item.Descripcion) {
    showToast('Guardando cambios...');
    const payload = { Type: 'edit_reminder_description', chat_ID: chatId, tracking_code: item.tracking_code, new_description: newDescription.trim() };
    try {
      const res = await fetchWithTimeout(gasWebhookURL, payload);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      showToast('Recordatorio actualizado.');
      
      // Recargar la lista para reflejar el cambio
      await loadSecondaryData();
      renderRemindersList();

    } catch (err) {
      showToast(`Error: ${err.message}. No se actualiz√≥.`, true);
      initializeApp(); // Recarga completa en caso de error
    }
  }
}

// ==================================================
// --- M√ìDULO: COMPRAS (FIRESTORE EN TIEMPO REAL + OPTIMISTA) ---
// ==================================================

async function renderShoppingList() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>Lista de las Compras</h2></div>
            <div id="shopping-list-content">
                <div class="no-data-msg">Cargando lista de compras...</div>
            </div>
            <div class="add-article-btn-container">
                <button class="add-article-btn" id="add-shopping-item-btn">A√±adir Art√≠culo</button>
                <button class="multi-select-action-btn" id="multi-select-toggle-btn" disabled>Marcar para comprar</button>
            </div>
        </div>`;
    
    document.getElementById('add-shopping-item-btn').onclick = renderAddArticleForm;
    document.getElementById('multi-select-toggle-btn').onclick = toggleSelectedItemsToPending;

    // --- L√ìGICA DE TIEMPO REAL CON FIRESTORE ---
    if (unsubscribeShoppingList) {
        unsubscribeShoppingList(); // Desuscribirse si ya hay un oyente activo para evitar duplicados.
    }

    const userShoppingListPath = `users/${chatId}/listaDeLaCompra`;
    const q = db.collection(userShoppingListPath)
                .orderBy('estado', 'asc') // 'Comprado' antes que 'Pendiente'
                .orderBy('fecha', 'desc');

    unsubscribeShoppingList = q.onSnapshot((snapshot) => {
        const items = [];
        snapshot.forEach((doc) => {
            const data = doc.data();
            items.push({ 
                id: doc.id,
                articulo: data.articulo,
                estado: data.estado,
                fecha: data.fecha ? data.fecha.toDate() : null,
                cycle: data.cycle || 0
            });
        });
        
        appData.shoppingList = items;
        renderShoppingListContent(items);
        updateShoppingCounts(items);
        console.log("Lista de compras actualizada desde Firestore.");

    }, (error) => {
        console.error("Error al escuchar la lista de compras:", error);
        showToast("Error en tiempo real de la lista de compras.", true);
        document.getElementById('shopping-list-content').innerHTML = '<div class="no-data-msg">‚ùå Error al cargar la lista.</div>';
    });
}

function renderShoppingListContent(items) {
    const pendingItems = items.filter(item => item.estado === 'Pendiente');
    const boughtItems = items.filter(item => item.estado === 'Comprado');
    let listHtml = '';
    
    const createItemHTML = (item) => {
        const isPending = item.estado === 'Pendiente';
        const formattedDate = item.fecha ? item.fecha.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
        
        return `
            <li class="shopping-item" id="item-${item.id}">
                ${!isPending ? `<div class="shopping-item-checkbox-wrapper"><input type="checkbox" class="shopping-item-checkbox" data-id="${item.id}"></div>` : ''}
                <button class="shopping-item-toggle-btn ${isPending ? 'pending' : 'bought'}" data-id="${item.id}" data-current-status="${item.estado}">
                    <span>${item.articulo}</span>
                    ${!isPending && formattedDate ? `<span class="item-date">${formattedDate}</span>` : ''}
                </button>
                <div class="list-item-actions">
                    <button class="generic-menu-btn" data-menu-id="menu-item-${item.id}">‚ãÆ</button>
                    <div class="dropdown-menu" id="menu-item-${item.id}">
                        <a class="dropdown-item" data-action="edit-shopping-item" data-id="${item.id}">Editar</a>
                        <a class="dropdown-item" data-action="delete-shopping-item" data-id="${item.id}">Eliminar</a>
                    </div>
                </div>
            </li>`;
    };

    if (pendingItems.length > 0) {
        listHtml += '<h3 class="shopping-list-section-title">Art√≠culos Pendientes</h3>';
        listHtml += pendingItems.map(createItemHTML).join('');
    }
    if (boughtItems.length > 0) {
        listHtml += '<h3 class="shopping-list-section-title">Art√≠culos Comprados</h3>';
        listHtml += `<div class="shopping-list-header-row"><label for="select-all-checkbox">Seleccionar Todos</label><input type="checkbox" id="select-all-checkbox"></div>`;
        listHtml += boughtItems.map(createItemHTML).join('');
    }
    if (items.length === 0) {
        listHtml = '<div class="no-data-msg">üõí<br>Tu lista est√° vac√≠a.</div>';
    }

    const contentDiv = document.getElementById('shopping-list-content');
    if (contentDiv) {
        contentDiv.innerHTML = listHtml;
        contentDiv.removeEventListener('click', handleShoppingItemInteractions);
        contentDiv.addEventListener('click', handleShoppingItemInteractions);
        
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.onchange = (e) => {
                document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.checked = e.target.checked; });
                updateMultiSelectButtonState();
            };
        }
        document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.onchange = updateMultiSelectButtonState; });
        updateMultiSelectButtonState();
    }
}

function updateShoppingCounts(items) {
    const pending = items.filter(item => item.estado === 'Pendiente').length;
    const bought = items.filter(item => item.estado === 'Comprado').length;
    
    appData.counts.shoppingPendingCount = pending;
    appData.counts.shoppingBoughtCount = bought;

    const pendingBadge = document.getElementById('shopping-pending-badge');
    const boughtBadge = document.getElementById('shopping-bought-badge');
    if (pendingBadge) pendingBadge.textContent = pending;
    if (boughtBadge) boughtBadge.textContent = bought;
}

function handleShoppingItemInteractions(event) {
    const target = event.target;
    const toggleButton = target.closest('.shopping-item-toggle-btn');
    const menuItem = target.closest('.dropdown-item');

    if (toggleButton) {
        const itemId = toggleButton.dataset.id;
        const currentStatus = toggleButton.dataset.currentStatus;
        const newStatus = currentStatus === 'Pendiente' ? 'Comprado' : 'Pendiente';
        toggleShoppingItemStatus(itemId, newStatus);
        return;
    }

    if (menuItem) {
        const action = menuItem.dataset.action;
        const itemId = menuItem.dataset.id;
        if (action === 'edit-shopping-item') {
            const item = appData.shoppingList.find(i => i.id === itemId);
            if(item) renderEditShoppingItemForm(item);
        } else if (action === 'delete-shopping-item') {
            confirmDelete('shopping_item', itemId);
        }
    }
}

async function toggleShoppingItemStatus(itemId, newStatus) {
    const itemRef = db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(itemId);
    try {
        await itemRef.update({
            estado: newStatus,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        });
        // No es necesario showToast, el cambio es visualmente instant√°neo y el listener lo confirma.
    } catch (err) {
        console.error("Error al cambiar estado:", err);
        showToast(`Error: ${err.message}.`, true);
    }
}

function updateMultiSelectButtonState() {
    const multiSelectBtn = document.getElementById('multi-select-toggle-btn');
    if (!multiSelectBtn) return;
    const selectedCount = document.querySelectorAll('.shopping-item-checkbox:checked').length;
    multiSelectBtn.disabled = selectedCount === 0;
    multiSelectBtn.textContent = selectedCount > 0 ? `Marcar ${selectedCount} para comprar` : 'Marcar para comprar';
}

async function toggleSelectedItemsToPending() {
    const selectedIds = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.id);
    if (selectedIds.length === 0) return;

    showSpinner(`Moviendo ${selectedIds.length} art√≠culos...`);
    const batch = db.batch();
    selectedIds.forEach(id => {
        const docRef = db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(id);
        batch.update(docRef, { 
            estado: 'Pendiente',
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        });
    });
    try {
        await batch.commit();
        showToast('Art√≠culos movidos a pendientes.');
    } catch (err) {
        console.error("Error en lote:", err);
        showToast(`Error: ${err.message}.`, true);
    } finally {
        hideSpinner();
    }
}

function renderAddArticleForm() {
    navigationHistory.push(renderShoppingList);
    updateBackButton();
    mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>‚ûï A√±adir Art√≠culo</h2></div>
          <div class="form-card">
              <label>Descripci√≥n del art√≠culo</label> <textarea id="article-description" rows="2" required></textarea>
              <label>¬øCada cu√°ntos d√≠as lo compras? (0 si es ocasional)</label> <input type="number" id="article-cycle" value="0" min="0" step="1" required />
              <button id="add-article-send-btn" disabled>A√±adir</button>
          </div>
      </div>`;
    const sendBtn = document.getElementById('add-article-send-btn');
    const descriptionInput = document.getElementById('article-description');
    descriptionInput.oninput = () => { const isEnabled = descriptionInput.value.trim() !== ''; sendBtn.disabled = !isEnabled; sendBtn.classList.toggle('enabled', isEnabled); };
    sendBtn.onclick = addArticle;
}

async function addArticle() {
    const description = document.getElementById('article-description').value.trim();
    const cycle = parseInt(document.getElementById('article-cycle').value, 10) || 0;
    if (!description) return;

    const emoji = findEmojiForText(description);
    const finalDescription = emoji ? `${emoji} ${description}` : description;

    goBack();
    showToast('A√±adiendo art√≠culo...');

    try {
        const customId = generateCustomId('G-'); // Generar ID personalizado
        await db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(customId).set({
            articulo: finalDescription,
            cycle: cycle,
            estado: 'Pendiente',
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (err) { 
        console.error("Error al a√±adir art√≠culo:", err);
        showToast(`Error: ${err.message}.`, true);
    }
}

function renderEditShoppingItemForm(item) {
    navigationHistory.push(renderShoppingList);
    updateBackButton();
    mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>‚úèÔ∏è Editar Art√≠culo</h2></div>
          <div class="form-card">
              <label>Descripci√≥n</label> <textarea id="article-description" rows="2" required>${item.articulo}</textarea>
              <label>Ciclo de compra (d√≠as)</label> <input type="number" id="article-cycle" value="${item.cycle}" min="0" step="1" required />
              <button id="edit-article-send-btn" class="enabled">Guardar Cambios</button>
          </div>
      </div>`;
    document.getElementById('edit-article-send-btn').onclick = () => saveEditedShoppingItem(item.id);
}

async function saveEditedShoppingItem(itemId) {
    const newDescription = document.getElementById('article-description').value.trim();
    const newCycle = parseInt(document.getElementById('article-cycle').value, 10) || 0;
    if (!newDescription) return;

    const emoji = findEmojiForText(newDescription);
    const finalDescription = emoji ? `${emoji} ${newDescription}` : newDescription;
    
    goBack();
    showToast('Guardando cambios...');

    try {
        await db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(itemId).update({
            articulo: finalDescription,
            cycle: newCycle
        });
    } catch (err) {
        console.error("Error al editar:", err);
        showToast(`Error: ${err.message}.`, true);
    }
}

// ==================================================
// --- M√ìDULO: NOTAS (L√ìGICA OPTIMISTA PROFESIONAL) ---
// ==================================================

// Funci√≥n interna para dibujar la lista de notas desde la memoria (es r√°pida)
function drawNotesList() {
    const notesListUl = document.getElementById('notes-list');
    if (!notesListUl) return; // No hacer nada si el contenedor no est√° en pantalla

    if (!appData.notesList || appData.notesList.length === 0) {
        notesListUl.innerHTML = '<div class="no-data-msg">üìù<br>No tienes notas guardadas.</div>';
        return;
    }

    // Ordenar las notas en memoria por fecha (m√°s recientes primero) antes de dibujarlas
    appData.notesList.sort((a, b) => (new Date(b.FechaRaw) - new Date(a.FechaRaw)));

    const listHtml = appData.notesList.map(note => `
        <li class="list-item" id="item-${note.Nota_ID}">
            <div class="list-item-content">
                <span class="list-item-title">${note.Titulo}</span>
                <span class="list-item-subtitle">${note.Fecha}</span>
                <p style="margin-top: 8px; white-space: pre-wrap; word-wrap: break-word;">${note.Descripcion}</p>
            </div>
            <div class="list-item-actions">
                <button class="generic-menu-btn" data-menu-id="menu-item-${note.Nota_ID}">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-item-${note.Nota_ID}">
                    <a class="dropdown-item" data-action="edit-note" data-note-id="${note.Nota_ID}">Editar</a>
                    <a class="dropdown-item" data-action="delete-note" data-note-id="${note.Nota_ID}">Eliminar</a>
                </div>
            </div>
        </li>`).join('');
    
    notesListUl.innerHTML = listHtml;
}

// Funci√≥n principal que se conecta a Firestore CADA VEZ que se entra
async function renderNotesList() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    
    mainContentArea.innerHTML = `<div class="list-container">
                                <div class="list-header"><h2>Mis Notas</h2></div>
                                <div class="add-article-btn-container"><button class="add-article-btn" id="create-new-note-btn">Crear Nueva Nota</button></div>
                                <ul class="list-style-none" id="notes-list"><div class="no-data-msg">Cargando notas...</div></ul>
                             </div>`;
    document.getElementById('create-new-note-btn').onclick = () => renderNoteForm();
    document.getElementById('notes-list').addEventListener('click', e => {
        const target = e.target.closest('.dropdown-item');
        if (!target) return;
        const action = target.dataset.action;
        const noteId = target.dataset.noteId;
        if (action === 'edit-note') {
            const note = appData.notesList.find(n => n.Nota_ID === noteId);
            if (note) renderNoteForm(note);
        } else if (action === 'delete-note') {
            confirmDelete('note', noteId);
        }
    });

    showSpinner();
    try {
        const notesRef = db.collection(`users/${chatId}/notas`);
        const snapshot = await notesRef.get();

        appData.notesList = []; // Limpiamos la lista en memoria para asegurar datos frescos
        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                const data = doc.data();
                const fecha = data.fecha && data.fecha.toDate ? data.fecha.toDate() : new Date(0);
                appData.notesList.push({
                    Nota_ID: doc.id,
                    Titulo: data.titulo || 'Sin T√≠tulo',
                    Descripcion: data.descripcion || '',
                    Fecha: fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    FechaRaw: fecha.toISOString() // Guardamos la fecha real para ordenar
                });
            });
        }
        
        drawNotesList(); // Llamamos a la funci√≥n r√°pida para dibujar la lista

    } catch (error) {
        console.error("Error al cargar notas desde Firestore: ", error);
        showToast("Error al cargar las notas.", true);
        document.getElementById('notes-list').innerHTML = '<div class="no-data-msg">üîå<br>Error de conexi√≥n al cargar notas.</div>';
    } finally {
        hideSpinner();
    }
}

function renderNoteForm(note = null) {
    navigationHistory.push(renderNotesList);
    updateBackButton();
    const isEditing = note && note.Nota_ID;
    mainContentArea.innerHTML = `<div class="list-container">
                                <div class="list-header"><h2>${isEditing ? '‚úèÔ∏è Editar Nota' : '‚ûï Nueva Nota'}</h2></div>
                                <div class="form-card">
                                    <label>T√≠tulo</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}" required />
                                    <label>Descripci√≥n</label><textarea id="note-description" rows="8" required>${isEditing ? note.Descripcion : ''}</textarea>
                                    <div class="button-group">
                                        <button id="cancel-note-btn" class="cancel">Cancelar</button>
                                        <button id="save-note-btn" data-note-id="${isEditing ? note.Nota_ID : ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button>
                                    </div>
                                </div>
                             </div>`;
    const titleInput = document.getElementById('note-title');
    const descriptionInput = document.getElementById('note-description');
    const saveBtn = document.getElementById('save-note-btn');
    
    function validate() {
        const isEnabled = titleInput.value.trim() !== '' && descriptionInput.value.trim() !== '';
        saveBtn.disabled = !isEnabled;
        saveBtn.classList.toggle('enabled', isEnabled);
    }
    titleInput.oninput = validate;
    descriptionInput.oninput = validate;
    saveBtn.onclick = saveNote;
    document.getElementById('cancel-note-btn').onclick = goBack;
    validate();
}

async function saveNote() {
    const saveBtn = document.getElementById('save-note-btn');
    const title = document.getElementById('note-title').value.trim();
    const description = document.getElementById('note-description').value.trim();
    const noteId = saveBtn.dataset.noteId;
    const isEditing = !!noteId;

    // --- L√ìGICA OPTIMISTA (se mantiene) ---
    if (isEditing) {
        const noteIndex = appData.notesList.findIndex(n => n.Nota_ID === noteId);
        if (noteIndex > -1) { appData.notesList[noteIndex].Titulo = title; appData.notesList[noteIndex].Descripcion = description; }
    } else {
        const now = new Date();
        const tempId = 'temp-' + now.getTime();
        appData.notesList.unshift({ Nota_ID: tempId, Titulo: title, Descripcion: description, Fecha: now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }), FechaRaw: now.toISOString() });
        appData.counts.notesCount++;
    }
    goBack();
    drawNotesList();
    const notesBadge = document.getElementById('notes-badge');
    if(notesBadge) notesBadge.textContent = appData.counts.notesCount;
    showToast(isEditing ? 'Nota guardada' : 'Nota creada');
    
    // --- SINCRONIZACI√ìN EN SEGUNDO PLANO CON FIRESTORE ---
    try {
        const notesRef = db.collection('users').doc(chatId).collection('notas');
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

        if (isEditing) {
            await notesRef.doc(noteId).update({
                titulo: title,
                descripcion: description,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("Nota editada en Firestore con √©xito.");
        } else {
            const customId = generateCustomId('G-'); // Generar ID personalizado
            await notesRef.doc(customId).set({
                titulo: title,
                descripcion: description,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            });
            await countsRef.update({
                notesCount: firebase.firestore.FieldValue.increment(1)
            });
            console.log("Nota creada y contador actualizado en Firestore.");
        }
    } catch (error) {
        console.error("Error sincronizando nota con Firestore:", error);
        showToast("Error de sincronizaci√≥n. Recargando...", true);
        setTimeout(() => initializeApp(), 1500);
    }
}

// ==================================================
// --- M√ìDULO: CALENDARIO (ACTUALIZADO CON FIRESTORE) ---
// ==================================================
// Las funciones de calendario se mantienen con la l√≥gica existente (Google Calendar API),
// pero las llamadas al backend ahora usar√°n las funciones adaptadas a Firestore.

let lastCalendarSearchQuery = null;

async function renderCalendarView(searchQuery = null) {
    // La lista de eventos se sigue cargando a trav√©s de loadSecondaryData (que llama a Apps Script)
    if (!searchQuery && !appData.isSecondaryDataLoaded) { await loadSecondaryData(); }
    
    navigationHistory.push(renderDashboard);
    updateBackButton();
    
    let eventsToRender;

    if (searchQuery) {
        showSpinner("Buscando eventos...");
        try {
            const serverCheck = await fetchWithTimeout(gasWebhookURL, { Type: 'search_calendar_events', chat_ID: chatId, query: searchQuery }).then(res => res.json());
            if (serverCheck.error) throw new Error(serverCheck.error);
            eventsToRender = serverCheck;
            lastCalendarSearchQuery = searchQuery;
        } catch (err) {
            mainContentArea.innerHTML = `<div class="no-data-msg">‚ùå<br>Error al buscar.<br><small>${err.message}</small></div>`;
            hideSpinner();
            return;
        } finally {
            hideSpinner();
        }
    } else {
        eventsToRender = appData.calendarEvents;
        lastCalendarSearchQuery = null;
    }

    const groupAndRenderEvents = (evs) => {
        if (!evs || evs.length === 0) {
            const message = searchQuery ? `No se encontraron eventos para "${searchQuery}".` : "No tienes eventos en los pr√≥ximos 30 d√≠as.";
            return `<div class="no-data-msg">üóìÔ∏è<br>${message}</div>`;
        }
        const eventsByDay = evs.reduce((acc, event) => {
            const dateKey = event.start.dateTime || event.start.date; if (!dateKey) return acc;
            const day = new Date(dateKey).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            if (!acc[day]) acc[day] = []; acc[day].push(event); return acc;
        }, {});
        let html = '';
        for (const day in eventsByDay) {
            html += `<h3 class="day-header">${day}</h3>`;
            html += Object.values(eventsByDay[day]).map(event => {
                const isAllDay = !event.start.dateTime;
                const startTime = isAllDay ? 'Todo el d√≠a' : new Date(event.start.dateTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const endTime = isAllDay ? '' : ' - ' + new Date(event.end.dateTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                return `<li class="list-item" id="item-${event.id}">
                          <div class="list-item-content" onclick="this.parentElement.classList.toggle('open')">
                            <span class="list-item-title">${event.summary}</span>
                            <span class="list-item-subtitle">${startTime}${endTime}</span>
                            <div class="event-description">${event.description || ''}</div>
                          </div>
                          <div class="list-item-actions">
                            <button class="generic-menu-btn" data-menu-id="menu-item-${event.id}">‚ãÆ</button>
                            <div class="dropdown-menu" id="menu-item-${event.id}">
                              <a class="dropdown-item" data-action="edit-calendar-event" data-event-id="${event.id}">Editar</a>
                              <a class="dropdown-item" data-action="delete-calendar-event" data-event-id="${event.id}">Eliminar</a>
                              ${event.htmlLink ? `<a class="dropdown-item" href="${event.htmlLink}" target="_blank">Ver en Google</a>` : ''}
                            </div>
                          </div></li>`;
            }).join('');
        }
        return html;
    };
    
    mainContentArea.innerHTML = `<div class="list-container">
                              <div class="list-header"><h2>Calendario</h2></div>
                              <div class="add-article-btn-container">
                                <button class="add-article-btn" id="add-event-btn">A√±adir Evento</button>
                                <button class="add-article-btn" id="search-event-btn">Buscar</button>
                              </div>
                              <ul class="list-style-none" id="calendar-list">${groupAndRenderEvents(eventsToRender)}</ul></div>`;
                            
    document.getElementById('add-event-btn').onclick = () => renderEventForm(null, () => renderCalendarView(null));
    document.getElementById('search-event-btn').onclick = renderSearchCalendarForm;
    document.getElementById('calendar-list').addEventListener('click', (e) => {
        const target = e.target.closest('.dropdown-item'); if (!target || target.href) return;
        const action = target.dataset.action; const eventId = target.dataset.eventId;
        if (action === 'delete-calendar-event') { confirmDelete('calendar_event', eventId);
        } else if (action === 'edit-calendar-event') {
            const event = appData.calendarEvents.find(ev => ev.id === eventId);
            if (event) renderEventForm(event, () => renderCalendarView(lastCalendarSearchQuery));
        }
    });
}

function renderEventForm(event = null, returnPath = renderCalendarView) {
    navigationHistory.push(() => returnPath(null, true));
    updateBackButton();
    
    const isEditing = event !== null;

    mainContentArea.innerHTML = `
      <div class="list-container"><div class="list-header"><h2>${isEditing ? '‚úèÔ∏è Editar Evento' : '‚ûï Nuevo Evento'}</h2></div>
      <div class="form-card" id="item-${isEditing ? event.id : 'new'}">
          <label>T√≠tulo</label><input type="text" id="event-summary" value="${isEditing ? event.summary.replace('[ASIST_OK] ', '') : ''}" required />
          <label><input type="checkbox" id="event-all-day" style="width:auto;margin-right:8px;" ${isEditing && !event.start.dateTime ? 'checked' : ''}> Todo el d√≠a</label>
          <label>Inicio</label><input type="text" id="event-start">
          <label>Fin</label><input type="text" id="event-end">
          <label>Notificarme</label>
          <div id="notifications-container"></div>
          <div class="add-article-btn-container" style="padding: 10px 0;">
            <button id="add-notification-btn" class="add-article-btn" style="width:100%; max-width:100%;" disabled>‚ûï A√±adir Notificaci√≥n</button>
          </div>
          <label>Descripci√≥n</label><textarea id="event-description" rows="4">${isEditing ? (event.description || '') : ''}</textarea>
          <div class="button-group">
            <button id="save-event-btn" class="enabled" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Evento'}</button>
            <button id="cancel-event-btn" class="cancel">Cancelar</button>
          </div></div></div>`;

    document.getElementById('cancel-event-btn').onclick = goBack;
    const addNotificationBtn = document.getElementById('add-notification-btn');
    const notificationsContainer = document.getElementById('notifications-container');

    const updateAddNotificationButtonVisibility = () => {
        const rows = notificationsContainer.querySelectorAll('.notification-row');
        const lastRow = rows.length > 0 ? rows[rows.length - 1] : null; let isLastRowFilled = true;
        if (lastRow) {
            const method = lastRow.querySelector('.event-reminder-method').value;
            const quantity = lastRow.querySelector('.event-reminder-quantity').value;
            const unit = lastRow.querySelector('.event-reminder-unit').value;
            isLastRowFilled = method && quantity.trim() !== '' && parseInt(quantity, 10) > 0 && unit;
        }
        addNotificationBtn.style.display = 'block'; addNotificationBtn.disabled = !isLastRowFilled;
        addNotificationBtn.classList.toggle('enabled', isLastRowFilled);
    };
    
    const createNotificationRow = (reminder = null) => {
        const row = document.createElement('div'); row.className = 'notification-row';
        let quantity = '', unit = '';
        if(reminder){
             if (reminder.minutes % (24 * 60) === 0) { unit = 'days'; quantity = reminder.minutes / (24 * 60); }
             else if (reminder.minutes % 60 === 0) { unit = 'hours'; quantity = reminder.minutes / 60; }
             else { unit = 'minutes'; quantity = reminder.minutes; }
        }
        row.innerHTML = `
            <select class="event-reminder-method"><option value="" selected disabled>Tipo</option><option value="popup" ${reminder && reminder.method ==='popup' ? 'selected':''}>Notificaci√≥n</option><option value="email" ${reminder && reminder.method ==='email' ? 'selected':''}>Email</option></select>
            <input type="number" class="event-reminder-quantity" value="${quantity}" min="1" placeholder="10"/>
            <select class="event-reminder-unit"><option value="" selected disabled>Unidad</option><option value="minutes" ${unit ==='minutes'?'selected':''}>min</option><option value="hours" ${unit==='hours'?'selected':''}>hrs</option><option value="days" ${unit==='days'?'selected':''}>d√≠as</option></select>
            <button class="remove-notification-btn">üóëÔ∏è</button>`;
        notificationsContainer.appendChild(row);
        row.querySelector('.remove-notification-btn').onclick = () => { row.remove(); updateAddNotificationButtonVisibility(); };
        row.querySelectorAll('input, select').forEach(el => el.addEventListener('input', updateAddNotificationButtonVisibility));
        updateAddNotificationButtonVisibility();
    };

    addNotificationBtn.onclick = () => createNotificationRow();
    
    const baseConfig = { time_24hr: true, locale: flatpickr.l10ns.es };
    const dateTimeConfig = { ...baseConfig, enableTime: true, dateFormat: "Y-m-d H:i" };
    const dateConfig = { ...baseConfig, enableTime: false, dateFormat: "Y-m-d" };
    const initialIsAllDay = isEditing && !event.start.dateTime;
    
    const startPicker = flatpickr("#event-start", { 
        ...(initialIsAllDay ? dateConfig : dateTimeConfig),
        defaultDate: isEditing ? new Date(event.start.dateTime || event.start.date) : new Date(),
        onChange: function(selectedDates) {
            if (selectedDates[0] && !document.getElementById('event-all-day').checked) {
                const endPicker = document.getElementById('event-end')._flatpickr;
                const currentEndDate = endPicker.selectedDates[0];
                const newEndDate = new Date(selectedDates[0].getTime() + 3600000);
                if (!currentEndDate || newEndDate > currentEndDate) { endPicker.setDate(newEndDate); }
            }
        }
    });
    const endPicker = flatpickr("#event-end", { 
        ...(initialIsAllDay ? dateConfig : dateTimeConfig),
        defaultDate: isEditing ? new Date(event.end.dateTime || event.end.date) : new Date(Date.now() + 3600000)
    });

    document.getElementById('event-all-day').addEventListener('change', (e) => {
        const isAllDay = e.target.checked; const newConfig = isAllDay ? dateConfig : dateTimeConfig;
        const currentStartDate = startPicker.selectedDates[0] || new Date();
        let currentEndDate = endPicker.selectedDates[0] || new Date(Date.now() + 3600000);
        if(isAllDay && currentEndDate < currentStartDate) currentEndDate = currentStartDate;
        startPicker.set(newConfig); endPicker.set(newConfig);
        startPicker.setDate(currentStartDate); endPicker.setDate(currentEndDate);
    });

    const summaryInput = document.getElementById('event-summary'), saveBtn = document.getElementById('save-event-btn');
    function validate() { saveBtn.disabled = summaryInput.value.trim() === ''; saveBtn.classList.toggle('enabled', !saveBtn.disabled); }
    summaryInput.oninput = validate;
    validate();
    saveBtn.onclick = () => saveEvent(event);

    if (isEditing && event.reminders && event.reminders.overrides) {
        event.reminders.overrides.forEach(rem => createNotificationRow(rem));
    }
    updateAddNotificationButtonVisibility();
}

async function saveEvent(eventToEdit = null) {
    const isEditing = eventToEdit !== null;
    const reminders = []; let notificationsValid = true;
    document.querySelectorAll('.notification-row').forEach(row => {
        const quantity = parseInt(row.querySelector('.event-reminder-quantity').value, 10);
        const unit = row.querySelector('.event-reminder-unit').value;
        const method = row.querySelector('.event-reminder-method').value;
        if (!quantity || !unit || !method) { notificationsValid = false; return; }
        let minutes = 0;
        if (unit === 'days') minutes = quantity * 24 * 60; else if (unit === 'hours') minutes = quantity * 60; else minutes = quantity;
        reminders.push({ method: method, minutes: minutes });
    });

    if (!notificationsValid) { showToast("Completa o elimina las notificaciones vac√≠as.", true); return; }

    const isAllDay = document.getElementById('event-all-day').checked;
    const startDate = document.getElementById('event-start')._flatpickr.selectedDates[0];
    const endDate = document.getElementById('event-end')._flatpickr.selectedDates[0];

    if (!startDate || !endDate) { showToast("Las fechas son obligatorias.", true); return; }
    if (endDate < startDate) { showToast("La fecha de fin no puede ser anterior a la de inicio.", true); return; }

    const eventData = {
        summary: document.getElementById('event-summary').value.trim(), start: startDate.toISOString(), end: endDate.toISOString(),
        description: document.getElementById('event-description').value, isAllDay: isAllDay, reminders: reminders,
        eventId: isEditing ? eventToEdit.id : null
    };
    
    // No actualizamos appData.counts aqu√≠ optim√≠sticamente, esperamos la resincronizaci√≥n del dashboard
    goBack();
    showToast(isEditing ? 'Evento actualizado. Guardando...' : 'Evento creado. Guardando...');
    
    try {
        const res = await fetchWithTimeout(gasWebhookURL, { chat_ID: chatId, Type: 'miniapp_save_calendar_event', eventData });
        const result = await res.json(); if (result.error) throw new Error(result.error);
        showToast(isEditing ? 'Evento actualizado con √©xito.' : 'Evento creado con √©xito.');

        // Forzar resincronizaci√≥n de contadores y recarga de la lista de eventos
        const syncCheck = await fetchWithTimeout(gasWebhookURL, { Type: 'resync_counts', chat_ID: chatId }).then(res => res.json());
        if (syncCheck.success) {
            appData.counts = syncCheck.counts; // Actualizar contadores localmente
            await loadSecondaryData(); // Recargar los eventos
            renderCalendarView();
        } else {
            initializeApp(); // Recarga completa si falla la resincronizaci√≥n
        }

    } catch (err) {
        showToast(`Error: ${err.message}.`, true);
        initializeApp(); // Recarga completa en caso de error
    }
}

function renderSearchCalendarForm() {
    navigationHistory.push(() => renderCalendarView(null, true));
    updateBackButton();
    mainContentArea.innerHTML = `
        <div class="list-container"><div class="list-header"><h2>üîé Buscar en Calendario</h2></div>
        <div class="form-card">
            <label>T√©rmino de b√∫squeda</label>
            <input type="text" id="calendar-search-query" placeholder="Ej: Reuni√≥n, Dentista..." required />
            <button id="search-calendar-btn" class="enabled">Buscar</button>
        </div></div>`;
    document.getElementById('search-calendar-btn').onclick = executeSearchCalendar;
}

async function executeSearchCalendar() {
    const query = document.getElementById('calendar-search-query').value.trim();
    if (!query) { showToast('Introduce un t√©rmino para buscar.', true); return; }
    navigationHistory.push(renderSearchCalendarForm);
    updateBackButton();
    await renderCalendarView(query);
}

// ==================================================
// --- M√ìDULO: GASTOS (ACTUALIZADO CON FIRESTORE) ---
// ==================================================
// Las funciones de Gastos se mantienen con la l√≥gica existente,
// pero las llamadas al backend ahora usar√°n las funciones adaptadas a Firestore.

let gastosEncontrados = [];
let pieChartInstance = null, dailyChartInstance = null, monthlyChartInstance = null;

const categoriasGastos = {
    "üè† Gastos del hogar": ["üîë Alquiler o hipoteca", "üí° Servicios (agua, luz, gas, electricidad)", "üåê Internet y tel√©fono", "üîß Mantenimiento y reparaciones", "üõãÔ∏è Mobiliario y electrodom√©sticos"],
    "üßæ Gastos personales": ["üõí Alimentaci√≥n y supermercado", "üëï Ropa y calzado", "üíä Salud (seguros, medicamentos, Farmacia, consultas)", "üéì Educaci√≥n y formaci√≥n", "üíà Cuidado personal (peluquer√≠a, cosm√©tica)"],
    "üöó Transporte": ["‚õΩ Combustible", "üöå Transporte p√∫blico", "üõ°Ô∏è Seguro del veh√≠culo", "üõ†Ô∏è Mantenimiento y reparaciones", "üÖøÔ∏è Estacionamiento y peajes"],
    "üçΩÔ∏è Entretenimiento y ocio": ["‚òï Restaurantes y caf√©s", "üé≠ Cine, teatro, conciertos", "üì∫ Suscripciones (Netflix, Spotify, etc.)", "‚úàÔ∏è Vacaciones y viajes", "‚öΩ Actividades deportivas o hobbies"],
    "üíº Finanzas y seguros": ["üí≥ Pr√©stamos o cr√©ditos", "üìà Ahorros e inversiones", "üìÑ Seguros (vida, hogar, salud, etc.)", "üí∏ Impuestos y tasas"],
    "üéÅ Otros": ["üéâ Regalos y celebraciones", "‚ù§Ô∏è Donaciones o caridad", "üêæ Mascotas (comida, veterinario, etc.)"]
};

function renderInstructionScreen() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"></div>
            <div class="scan-instruction-screen">
                <h2>Escanear un Ticket de Gasto</h2>
                <ol>
                    <li>Primero, <strong>saca una foto n√≠tida</strong> de tu ticket con la c√°mara de tu m√≥vil.</li>
                    <li>Aseg√∫rate de que el texto sea legible, con buena luz y sin sombras.</li>
                    <li>Luego, <strong>pulsa el bot√≥n de abajo</strong> para seleccionarla de tu galer√≠a.</li>
                </ol>
                <button class="add-article-btn" id="select-photo-btn">Seleccionar Foto de la Galer√≠a</button>
            </div>
        </div>`;
    document.getElementById('select-photo-btn').onclick = renderScanTicketView;
}

function renderScanTicketView() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
	fileInput.capture = 'environment';
    fileInput.style.display = 'none';
    fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('image-preview-element').src = e.target.result;
            document.getElementById('image-preview-overlay').style.display = 'flex';
        };
        reader.readAsDataURL(file);
    };
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

async function handleImageScan() {
    if (!selectedImageFile) {
        showToast('No se ha seleccionado ninguna imagen.', true);
        return;
    }
    document.getElementById('image-preview-overlay').style.display = 'none';
    showSpinner();
    const formData = new FormData();
    formData.append('file', selectedImageFile, selectedImageFile.name);
    try {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 60000);
        const response = await fetch(makeTicketWebhookUrl, { method: 'POST', body: formData, signal: controller.signal });
        clearTimeout(id);
        if (!response.ok) { throw new Error(`Error del servidor de Make: ${response.status}`); }
        const resultText = await response.text();
        const resultJson = JSON.parse(resultText);
        if(resultJson.tipo && resultJson.tipo.toUpperCase() === 'GASTO') {
            renderAddGastoForm(resultJson);
        } else {
            throw new Error(resultJson.datos.motivo || 'El ticket no parece ser un gasto v√°lido.');
        }
    } catch (error) {
        console.error('Error al escanear el ticket:', error);
        showToast(`Error al procesar: ${error.message}`, true);
    } finally {
        hideSpinner();
        selectedImageFile = null;
    }
}

document.getElementById('preview-cancel-btn').onclick = () => {
    document.getElementById('image-preview-overlay').style.display = 'none';
    selectedImageFile = null;
};
document.getElementById('preview-send-btn').onclick = handleImageScan;

function renderAddGastoForm(initialData = null) {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    const data = initialData ? initialData.datos : {};
    const categoriasOptions = Object.keys(categoriasGastos).map(cat => `<option value="${cat}" ${data.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üí∞ Nuevo Gasto</h2></div>
            <div class="form-card" id="item-new">
                <label>Importe</label> <input type="number" id="gasto-importe" placeholder="Ej: 15.50" step="0.01" value="${data.importe_total || ''}" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" placeholder="Ej: Supermercado" value="${data.establecimiento || ''}" required />
                <label>Categor√≠a</label>
                <select id="gasto-categoria" required><option value="">-- Selecciona una categor√≠a --</option>${categoriasOptions}</select>
                <label>Subcategor√≠a</label>
                <select id="gasto-subcategoria" required disabled><option value="">-- Selecciona una subcategor√≠a --</option></select>
                <label>Fecha</label> <input type="text" id="gasto-fecha" required />
                <div class="button-group">
                    <button id="cancel-gasto-btn" class="cancel">Cancelar</button>
                    <button id="save-gasto-btn" disabled>Registrar Gasto</button>
                </div>
            </div>
        </div>`;

    document.getElementById('cancel-gasto-btn').onclick = goBack;
    const categoriaSelect = document.getElementById('gasto-categoria'), subcategoriaSelect = document.getElementById('gasto-subcategoria'), saveBtn = document.getElementById('save-gasto-btn');
    const elementsToValidate = [ document.getElementById('gasto-importe'), document.getElementById('gasto-establecimiento'), document.getElementById('gasto-fecha'), categoriaSelect, subcategoriaSelect ];
    function validateGastoForm() { const allValid = elementsToValidate.every(el => el.value && el.value.trim() !== ''); saveBtn.disabled = !allValid; saveBtn.classList.toggle('enabled', allValid); }
    let defaultDate = new Date();
    if(data.fecha) {
        const dateTimeParts = data.fecha.split(' ');
        const dateParts = dateTimeParts[0].split('/');
        if(dateParts.length === 3) {
            const year = parseInt(dateParts[2], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[0], 10);
            if(dateTimeParts.length > 1) {
                const timeParts = dateTimeParts[1].split(':');
                if(timeParts.length >= 2) {
                    const hours = parseInt(timeParts[0], 10);
                    const minutes = parseInt(timeParts[1], 10);
                    defaultDate = new Date(year, month, day, hours, minutes);
                } else {
                   defaultDate = new Date(year, month, day);
                }
            } else {
                defaultDate = new Date(year, month, day);
            }
        }
    }
    flatpickr("#gasto-fecha", { defaultDate: defaultDate, dateFormat: "d/m/Y H:i", enableTime: true, locale: "es", onChange: validateGastoForm });
    elementsToValidate.forEach(el => el.oninput = validateGastoForm);
    categoriaSelect.onchange = () => {
        const selectedCategory = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">-- Selecciona una subcategor√≠a --</option>';
        if (selectedCategory && categoriasGastos[selectedCategory]) {
            const subcategoriasOptions = categoriasGastos[selectedCategory].map(sub => `<option value="${sub}" ${data.subcategoria === sub ? 'selected' : ''}>${sub}</option>`).join('');
            subcategoriaSelect.innerHTML += subcategoriasOptions;
            subcategoriaSelect.disabled = false;
        } else { subcategoriaSelect.disabled = true; }
        validateGastoForm();
    };
    saveBtn.onclick = () => saveGasto();
    if (initialData) {
        categoriaSelect.dispatchEvent(new Event('change'));
        if(data.subcategoria) { subcategoriaSelect.value = data.subcategoria; }
    }
    validateGastoForm();
}

async function saveGasto() {
    try {
        showSpinner("Registrando gasto...");
        const fechaGastoObj = document.getElementById('gasto-fecha')._flatpickr.selectedDates[0];
        const importe = parseFloat(document.getElementById('gasto-importe').value.replace(',', '.'));
        const establecimiento = document.getElementById('gasto-establecimiento').value;
        const categoria = document.getElementById('gasto-categoria').value;
        const subCategoria = document.getElementById('gasto-subcategoria').value;
        const mesAnio = `${(fechaGastoObj.getMonth() + 1).toString().padStart(2, '0')}/${fechaGastoObj.getFullYear()}`;

        const gastoData = {
            importe, establecimiento, categoria, subCategoria,
            fecha: fechaGastoObj,
            mesAnio: mesAnio
        };

        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        const newGastoRef = db.collection('users').doc(chatId).collection('gastos').doc(generateCustomId('G-')); // Generar Ref con ID

        await db.runTransaction(async (transaction) => {
            const countsDoc = await transaction.get(countsRef);
            if (!countsDoc.exists) throw "Documento de contadores no encontrado.";
            
            const currentCounts = countsDoc.data();
            const nuevoTotalGastos = (currentCounts.gastosMesActual || 0) + importe;
            const mesesActivos = currentCounts.mesesActivosGastos || [];
            if (!mesesActivos.includes(mesAnio)) mesesActivos.push(mesAnio);

            transaction.set(newGastoRef, gastoData); // Crear el documento del gasto
            transaction.update(countsRef, {
                gastosMesActual: nuevoTotalGastos,
                mesesActivosGastos: mesesActivos
            });
        });

        appData.counts.gastosMesActual = (appData.counts.gastosMesActual || 0) + importe;
        if (!appData.counts.mesesActivosGastos.includes(mesAnio)) appData.counts.mesesActivosGastos.push(mesAnio);

        goBack();
        renderDashboard();
        showToast('Gasto registrado con √©xito.');

    } catch (err) {
        console.error("Error en saveGasto():", err);
        showToast(`Error: ${err.message}.`, true);
    } finally {
        hideSpinner();
    }
}

function renderGastoChart() {
  navigationHistory.push(renderDashboard);
  updateBackButton();

  const mesesOrdenados = (appData.counts.mesesActivosGastos || []).sort((a, b) => {
      const [mesA, anioA] = a.split('/');
      const [mesB, anioB] = b.split('/');
      return new Date(anioB, mesB - 1) - new Date(anioA, mesA - 1);
  });
  
  const mesesOptions = mesesOrdenados.map(mes => `<option value="${mes}">${mes}</option>`).join('');
  
  mainContentArea.innerHTML = `
    <div class="list-container">
      <div class="list-header"><h2>An√°lisis de Gastos</h2></div>
      <div class="form-card">
        <label>Detalle por Mes</label>
        <select id="gasto-chart-mes-select"><option value="">-- Selecciona un mes para ver gr√°ficos --</option>${mesesOptions}</select>
        <div class="gasto-chart-container" id="chart-container-pie" style="margin-top:20px; display:none;"><canvas id="pieChartCanvas"></canvas></div>
        <ul class="gasto-legend" id="gasto-legend-container"></ul>
        <hr style="margin: 25px 0; border-top: 1px solid #eee; display:none;" id="hr1">
        <div class="gasto-chart-container" id="chart-container-daily" style="position: relative; height:300px; display:none;"><canvas id="dailyChartCanvas"></canvas></div>
        <hr style="margin: 25px 0; border-top: 1px solid #eee; display:none;" id="hr2">
        <div class="gasto-chart-container" id="chart-container-monthly" style="position: relative; height:300px; display:none;"><canvas id="monthlyChartCanvas"></canvas></div>
      </div>
    </div>`;
  document.getElementById('gasto-chart-mes-select').onchange = fetchAndDisplayGastoChart;
}

async function fetchAndDisplayGastoChart(event) {
    const mesAnio = event.target.value;
    if (pieChartInstance) pieChartInstance.destroy();
    if (dailyChartInstance) dailyChartInstance.destroy();
    if (monthlyChartInstance) monthlyChartInstance.destroy();
    
    document.getElementById('gasto-legend-container').innerHTML = '';
    ['chart-container-pie', 'chart-container-daily', 'chart-container-monthly', 'hr1', 'hr2'].forEach(id => document.getElementById(id).style.display = 'none');
    
    if (!mesAnio) return;
    
    showSpinner("Generando gr√°ficos...");
    try {
        // --- 1. Obtener datos del mes seleccionado ---
        const [mes, anio] = mesAnio.split('/').map(Number);
        const startDate = new Date(anio, mes - 1, 1);
        const endDate = new Date(anio, mes, 0, 23, 59, 59);

        const gastosRef = db.collection('users').doc(chatId).collection('gastos');
        const qMes = gastosRef.where('fecha', '>=', startDate).where('fecha', '<=', endDate);
        const snapshotMes = await qMes.get();
        const gastosDelMes = snapshotMes.docs.map(doc => ({ ...doc.data(), id: doc.id }));

        // --- 2. Obtener datos de los √∫ltimos 6 meses para el gr√°fico de barras ---
        const monthlyEndDate = new Date();
        const monthlyStartDate = new Date();
        monthlyStartDate.setMonth(monthlyStartDate.getMonth() - 5);
        monthlyStartDate.setDate(1);

        const qMonthly = gastosRef.where('fecha', '>=', monthlyStartDate).where('fecha', '<=', monthlyEndDate);
        const snapshotMonthly = await qMonthly.get();
        const gastosUltimosMeses = snapshotMonthly.docs.map(doc => doc.data());

        // --- 3. Procesar todos los datos ---
        const data = procesarDatosParaGrafico(gastosDelMes, gastosUltimosMeses, mesAnio);
        if (data.error) throw new Error(data.error);
        
        // --- 4. Dibujar los gr√°ficos ---
        Chart.register(ChartDataLabels);
        const paletaDeColores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        const moneda = appData.settings.moneda || '‚Ç¨';
        
        // Gr√°fico de Pastel (Pie Chart)
        if (data.pieData && data.pieData.data.length > 0) {
            document.getElementById('chart-container-pie').style.display = 'block';
            const pieCtx = document.getElementById('pieChartCanvas').getContext('2d');
            pieChartInstance = new Chart(pieCtx, { type: 'pie', data: { labels: data.pieData.labels, datasets: [{ data: data.pieData.data, backgroundColor: paletaDeColores, borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, plugins: { title: { display: true, text: data.tituloPie + ' ' + moneda, font: { size: 18 } }, legend: { display: false }, datalabels: { formatter: (v,c) => { const total = c.chart.data.datasets[0].data.reduce((a,b) => a+b,0); return total > 0 ? (v/total*100).toFixed(0)+'%' : '0%';}, color:'#fff',font:{weight:'bold',size:16}}, tooltip: { callbacks: { label: c => `${c.label}: ${parseFloat(c.raw).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})} ${moneda}`}}}}});
            document.getElementById('gasto-legend-container').innerHTML = data.datosParaLeyenda.map(item => `<li class="gasto-legend-item"><span class="gasto-legend-color" style="background-color:${item.color};"></span><div>${item.categoria}: <strong>${item.importe} ${moneda}</strong></div></li>`).join('');
        }

        // Gr√°fico de L√≠neas (Evoluci√≥n Diaria)
        if (data.dailyData && data.dailyData.data.length > 0) {
            document.getElementById('hr1').style.display = 'block';
            document.getElementById('chart-container-daily').style.display = 'block';
            const dailyCtx = document.getElementById('dailyChartCanvas').getContext('2d');
            dailyChartInstance = new Chart(dailyCtx, { type: 'line', data: { labels: data.dailyData.labels, datasets: [{ label: 'Gasto Diario (' + moneda + ')', data: data.dailyData.data, borderColor: '#4BC0C0', fill: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `Evoluci√≥n Diaria - ${mesAnio}`, font: { size: 18 } }, legend: { display: false }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.formattedValue} ${moneda}`}}}}});
        }
        
        // Gr√°fico de Barras (Comparativa Mensual)
        if (data.monthlyData && data.monthlyData.data.length > 0) {
            document.getElementById('hr2').style.display = 'block';
            document.getElementById('chart-container-monthly').style.display = 'block';
            const monthlyCtx = document.getElementById('monthlyChartCanvas').getContext('2d');
            monthlyChartInstance = new Chart(monthlyCtx, { type: 'bar', data: { labels: data.monthlyData.labels, datasets: [{ label: 'Gasto Mensual (' + moneda + ')', data: data.monthlyData.data, backgroundColor: '#36A2EB' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Evoluci√≥n de Gastos Mensuales', font: { size: 18 } }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.formattedValue} ${moneda}`}}}}});
        }

    } catch (err) {
        showToast(`No se pudo generar el gr√°fico: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function procesarDatosParaGrafico(gastosDelMes, gastosUltimosMeses, mesAnioSeleccionado) {
    // --- L√≥gica para Gr√°fico de Pastel y Leyenda ---
    const datosParaLeyenda = [];
    const gastosPorCategoria = gastosDelMes.reduce((acc, gasto) => {
        const cat = gasto.categoria || 'Sin categor√≠a';
        acc[cat] = (acc[cat] || 0) + (gasto.importe || 0);
        return acc;
    }, {});
    const pieData = { labels: Object.keys(gastosPorCategoria), data: Object.values(gastosPorCategoria) };
    const paletaDeColores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    pieData.labels.forEach((label, index) => {
        datosParaLeyenda.push({ categoria: label, importe: pieData.data[index].toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), color: paletaDeColores[index % paletaDeColores.length] });
    });
    const totalGastosMes = gastosDelMes.reduce((sum, g) => sum + (g.importe || 0), 0);
    
    // --- L√≥gica para Gr√°fico de L√≠neas (Evoluci√≥n Diaria) ---
    const diasEnMes = new Date(mesAnioSeleccionado.split('/')[1], mesAnioSeleccionado.split('/')[0], 0).getDate();
    const dailyData = { labels: Array.from({ length: diasEnMes }, (_, i) => i + 1), data: Array(diasEnMes).fill(0) };
    gastosDelMes.forEach(gasto => {
        if (gasto.fecha && typeof gasto.fecha.toDate === 'function') {
            const dia = gasto.fecha.toDate().getDate();
            dailyData.data[dia - 1] += gasto.importe || 0;
        }
    });

    // --- L√≥gica para Gr√°fico de Barras (Comparativa Mensual) ---
    const monthlyData = { labels: [], data: [] };
    const gastosPorMes = {};
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const mes = (d.getMonth() + 1).toString().padStart(2, '0');
        const anio = d.getFullYear();
        monthlyData.labels.push(`${mes}/${anio}`);
        gastosPorMes[`${mes}/${anio}`] = 0;
    }
    gastosUltimosMeses.forEach(gasto => {
        if (gasto.mesAnio && gastosPorMes.hasOwnProperty(gasto.mesAnio)) {
            gastosPorMes[gasto.mesAnio] += gasto.importe || 0;
        }
    });
    monthlyData.data = Object.values(gastosPorMes);

    return {
        pieData,
        datosParaLeyenda,
        tituloPie: `Total Gastos ${mesAnioSeleccionado}: ${totalGastosMes.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
        dailyData,
        monthlyData
    };
}

function renderGastosSearchScreen(gastos = null) {
	updateBackButton();
    let resultsHtml = '';
    let legendDisplay = 'none';

    if (gastos) {
        if (gastos.length > 0) {
            // L√çNEA CORREGIDA: Se usan los nombres de campo correctos (min√∫sculas y 'Fecha' may√∫scula)
            resultsHtml = gastos.map(g => `<li class="list-item clickable" data-id-unico="${g.ID_Unico}"><div class="list-item-content"><span class="list-item-title">${g.establecimiento} - ${Number(g.importe).toLocaleString('es-ES', {minimumFractionDigits: 2})} ${(appData.settings.moneda || '‚Ç¨')}</span><span class="list-item-subtitle">${g.subCategoria || g.categoria} - ${g.Fecha}</span></div></li>`).join('');
            resultsHtml = `<ul class="list-style-none">${resultsHtml}</ul>`;
            legendDisplay = 'block';
        } else {
            resultsHtml = `<div class="no-data-msg" style="padding: 20px;">No se encontraron gastos.</div>`;
        }
    }

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üîé Buscar Gastos</h2></div>
            <div class="form-card">
                <label>Fecha de Inicio</label> <input type="text" id="gasto-fecha-inicio" required />
                <label>Fecha de Fin</label> <input type="text" id="gasto-fecha-fin" required />
                <button id="search-gasto-btn" class="enabled">Buscar</button>
            </div>
            <p style="text-align: center; color: var(--muted); font-size: 0.9rem; margin-top: 15px; display: ${legendDisplay};">Pulsa sobre un gasto para ver/editarlo</p>
            <div id="gastos-search-results" style="margin-top: 10px;">${resultsHtml}</div>
        </div>`;
        
    const fpConfig = { dateFormat: "d/m/Y", locale: "es" };
    flatpickr("#gasto-fecha-inicio", { ...fpConfig, defaultDate: new Date(new Date().setDate(1)) });
    flatpickr("#gasto-fecha-fin", { ...fpConfig, defaultDate: new Date() });
    
    document.getElementById('search-gasto-btn').onclick = executeSearchGastos;
    
    document.getElementById('gastos-search-results').addEventListener('click', (e) => {
        const item = e.target.closest('.list-item.clickable');
        if (item) {
            const idUnico = item.dataset.idUnico;
            const gasto = gastosEncontrados.find(g => g.ID_Unico === idUnico);
            if(gasto) {
                navigationHistory.push(() => renderGastosSearchScreen(gastosEncontrados));
                updateBackButton();
                renderEditGastoForm(gasto);
            }
        }
    });
}

async function executeSearchGastos() {
    const startDateString = document.getElementById('gasto-fecha-inicio').value;
    const endDateString = document.getElementById('gasto-fecha-fin').value;
    if (!startDateString || !endDateString) {
        showToast('Debes seleccionar ambas fechas.', true);
        return;
    }

    showSpinner("Buscando gastos...");

    try {
        const startParts = startDateString.split('/');
        const endParts = endDateString.split('/');
        const startDateObj = new Date(startParts[2], startParts[1] - 1, startParts[0], 0, 0, 0);
        const endDateObj = new Date(endParts[2], endParts[1] - 1, endParts[0], 23, 59, 59);

        const gastosRef = db.collection('users').doc(chatId).collection('gastos');
        const q = gastosRef.where('fecha', '>=', startDateObj).where('fecha', '<=', endDateObj);
        const snapshot = await q.get();

        gastosEncontrados = snapshot.docs.map(doc => {
            const data = doc.data();
            const fechaGasto = (data.fecha && typeof data.fecha.toDate === 'function') ? data.fecha.toDate() : null;
            
            return {
                ...data,
                ID_Unico: doc.id,
                Fecha: fechaGasto ? fechaGasto.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'Fecha inv√°lida'
            };
        });
        
        // Ordenar resultados por fecha, m√°s reciente primero
        gastosEncontrados.sort((a, b) => {
            const dateA = a.fecha && a.fecha.toDate ? a.fecha.toDate() : 0;
            const dateB = b.fecha && b.fecha.toDate ? b.fecha.toDate() : 0;
            return dateB - dateA;
        });

        renderGastosSearchScreen(gastosEncontrados);

    } catch (err) {
        console.error("Error al buscar gastos:", err);
        showToast(`Error al buscar gastos: ${err.message}`, true);
        renderGastosSearchScreen([]);
    } finally {
        hideSpinner();
    }
}

function renderEditGastoForm(gasto) {
    updateBackButton();
    
    // CORREGIDO: Se usan los nombres de campo en min√∫scula
    const categoriasOptions = Object.keys(categoriasGastos).map(cat => `<option value="${cat}" ${gasto.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
    const subcategoriasOptions = (categoriasGastos[gasto.categoria] || []).map(sub => `<option value="${sub}" ${gasto.subCategoria === sub ? 'selected' : ''}>${sub}</option>`).join('');
    
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>‚úèÔ∏è Ver/Editar Gasto</h2></div>
            <div class="form-card" id="item-${gasto.ID_Unico}">
                <label>Importe</label> <input type="number" id="gasto-importe" value="${gasto.importe}" step="0.01" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" value="${gasto.establecimiento}" required />
                <label>Categor√≠a</label> <select id="gasto-categoria" required>${categoriasOptions}</select>
                <label>Subcategor√≠a</label> <select id="gasto-subcategoria" required>${subcategoriasOptions}</select>
                <label>Fecha</label> <input type="text" id="gasto-fecha" required />
                <div class="button-group">
                    <button id="delete-gasto-btn" class="cancel">Eliminar</button>
                    <button id="save-gasto-btn" disabled>Guardar Cambios</button>
                </div>
            </div>
        </div>`;
    
    const fechaPicker = flatpickr("#gasto-fecha", { defaultDate: gasto.Fecha, dateFormat: "d/m/Y H:i", enableTime: true, locale: "es" });
    const categoriaSelect = document.getElementById('gasto-categoria');
    const subcategoriaSelect = document.getElementById('gasto-subcategoria');
    const importeInput = document.getElementById('gasto-importe');
    const establecimientoInput = document.getElementById('gasto-establecimiento');
    const saveBtn = document.getElementById('save-gasto-btn');
    
    // CORREGIDO: Se usan los nombres de campo en min√∫scula
    const initialValues = { importe: importeInput.value, establecimiento: establecimientoInput.value, categoria: categoriaSelect.value, subcategoria: subcategoriaSelect.value, fecha: fechaPicker.input.value };

    function validateChanges() {
        const currentValues = { importe: importeInput.value, establecimiento: establecimientoInput.value, categoria: categoriaSelect.value, subcategoria: subcategoriaSelect.value, fecha: fechaPicker.input.value };
        const hasChanged = JSON.stringify(initialValues) !== JSON.stringify(currentValues);
        saveBtn.disabled = !hasChanged;
        saveBtn.classList.toggle('enabled', hasChanged);
    }

    [importeInput, establecimientoInput, categoriaSelect, subcategoriaSelect].forEach(el => el.addEventListener('input', validateChanges));
    fechaPicker.config.onChange.push(validateChanges);
    
    categoriaSelect.onchange = () => {
        const selectedCategory = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">-- Selecciona una subcategor√≠a --</option>';
        if (selectedCategory && categoriasGastos[selectedCategory]) {
            subcategoriaSelect.innerHTML += categoriasGastos[selectedCategory].map(sub => `<option value="${sub}">${sub}</option>`).join('');
            subcategoriaSelect.disabled = false;
        } else {
            subcategoriaSelect.disabled = true;
        }
        validateChanges();
    };

    document.getElementById('save-gasto-btn').onclick = () => saveEditedGasto(gasto.ID_Unico);
    document.getElementById('delete-gasto-btn').onclick = () => confirmDelete('gasto', gasto.ID_Unico);
}

async function saveEditedGasto(idUnico) {
    const nuevoImporte = parseFloat(document.getElementById('gasto-importe').value);
    const nuevoEstablecimiento = document.getElementById('gasto-establecimiento').value;
    const nuevaCategoria = document.getElementById('gasto-categoria').value;
    const nuevaSubcategoria = document.getElementById('gasto-subcategoria').value;
    const fechaGastoObj = document.getElementById('gasto-fecha')._flatpickr.selectedDates[0];

    showToast('Gasto actualizado. Guardando...');
    
    try {
        // CORREGIDO: Se usan los nombres de campo en min√∫scula
        const payload = { 
            importe: nuevoImporte, 
            establecimiento: nuevoEstablecimiento, 
            categoria: nuevaCategoria, 
            subCategoria: nuevaSubcategoria, 
            fecha: fechaGastoObj 
        };
        await db.collection('users').doc(chatId).collection('gastos').doc(idUnico).update(payload);

        goBack(); 
        showToast("Gasto actualizado.");
        // Aqu√≠ faltar√≠a la l√≥gica para recalcular los contadores, pero es m√°s compleja.
        // Se deja para una fase posterior o se asume que la edici√≥n no afecta los totales mensuales.
        initializeApp(); // Forzar recarga para asegurar consistencia total.

    } catch (err) {
        showToast(`Error de sincronizaci√≥n: ${err.message}.`, true);
        initializeApp(); 
    }
}

// ==================================================
// --- M√ìDULO: CHEF ASISTENTE (VERSI√ìN FINAL) ---
// ==================================================
function renderChefPage() {
    setActiveTab('tab-chef');
    navigationHistory.push(renderDashboard);
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="chef-container">
            <h2 class="settings-section-title">üßë‚Äçüç≥ Chef Asistente</h2>
            <div class="form-card">
                <div class="chef-item">
                    <label>Tipo de Comida</label>
                    <select id="chef-tipo-comida">
                        <option value="Desayuno">üç≥ Desayuno</option>
                        <option value="Almuerzo" selected>ü•ó Almuerzo</option>
                        <option value="Merienda">ü•™ Merienda</option>
                        <option value="Cena">üçù Cena</option>
                    </select>
                </div>
                <div class="chef-item">
                    <label>Hora Aproximada</label>
                    <input type="text" id="chef-hora" style="width: 100px; text-align: center;"/>
                </div>
                <div class="chef-item">
                    <label>N¬∫ de Comensales</label>
                    <input type="number" id="chef-comensales" value="1" min="1" style="width: 80px; text-align: center;"/>
                </div>
                <div class="chef-item">
                    <label>Estilo de Cocina</label>
                    <select id="chef-estilo">
                        <option value="Sorpr√©ndeme">‚ú® Sorpr√©ndeme</option>
                        <option value="R√°pida">üèÉ R√°pida</option>
                        <option value="Casera">üè° Casera</option>
                        <option value="Saludable">üí™ Saludable</option>
                    </select>
                </div>
                <div class="chef-item">
                    <label>¬øIncluir Postre?</label>
                    <label class="switch"><input type="checkbox" id="chef-postre"><span class="slider"></span></label>
                </div>
                <div class="chef-item">
                    <label>Solo con lo que tengo</label>
                    <label class="switch"><input type="checkbox" id="chef-solo-nevera"><span class="slider"></span></label>
                </div>
                <label style="margin-top: 20px;">Tu Petici√≥n Especial</label>
                <textarea id="chef-peticion" rows="3" placeholder="Ej: soy vegano, alergia al marisco, usa el pollo antes de que caduque..."></textarea>
                
                <div id="chef-image-previews"></div>
                <button id="chef-add-photo-btn" class="add-article-btn enabled" style="width:100%; max-width:100%; margin-top: 20px;">üì∏ A√±adir Foto de Ingredientes</button>

                <div class="button-group">
                    <button id="chef-cancel-btn" class="cancel">Cancelar/Salir</button>
                    <button id="chef-submit-btn" class="enabled">Obtener Sugerencias</button>
                </div>
            </div>
        </div>`;

    flatpickr("#chef-hora", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, defaultDate: "13:00" });
    document.getElementById('chef-cancel-btn').onclick = goBack;
    
    let selectedFiles = [];

    const previewsContainer = document.getElementById('chef-image-previews');
    const addPhotoButton = document.getElementById('chef-add-photo-btn');

    const updatePreviews = () => {
        previewsContainer.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="preview">
                    <button class="delete-preview-btn" data-index="${index}">&times;</button>
                `;
                previewsContainer.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
        addPhotoButton.style.display = selectedFiles.length < 2 ? 'block' : 'none';
    };

    previewsContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('delete-preview-btn')) {
            const index = parseInt(event.target.dataset.index, 10);
            selectedFiles.splice(index, 1);
            updatePreviews();
        }
    });

    addPhotoButton.onclick = () => {
        if (selectedFiles.length >= 2) {
            showToast("Puedes subir un m√°ximo de 2 fotos.", true);
            return;
        }
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.capture = 'environment';
        fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                handleChefImageSelection(file, (confirmedFile) => {
                    selectedFiles.push(confirmedFile);
                    updatePreviews();
                });
            }
        };
        fileInput.click();
    };
    
    document.getElementById('chef-submit-btn').onclick = () => {
        if(selectedFiles.length === 0) {
            showToast("Por favor, sube una foto de tus ingredientes.", true);
            return;
        }
        executeChefRequest(selectedFiles);
    };
}

function handleChefImageSelection(file, callback) {
    const overlay = document.getElementById('image-preview-overlay');
    const imgElement = document.getElementById('image-preview-element');
    const sendBtn = document.getElementById('preview-send-btn');
    const cancelBtn = document.getElementById('preview-cancel-btn');

    sendBtn.textContent = "Usar esta Foto";
    const reader = new FileReader();
    reader.onload = (e) => {
        imgElement.src = e.target.result;
        overlay.style.display = 'flex';
    };
    reader.readAsDataURL(file);

    const cleanup = () => {
        overlay.style.display = 'none';
        sendBtn.onclick = handleImageScan; 
        cancelBtn.onclick = () => {
            document.getElementById('image-preview-overlay').style.display = 'none';
            selectedImageFile = null;
        };
        sendBtn.textContent = "Enviar";
    };

    sendBtn.onclick = () => {
        callback(file);
        cleanup();
    };
    
    cancelBtn.onclick = () => {
        cleanup();
    };
}

async function executeChefRequest(files) {
    showSpinner("Un momento, el Chef est√° trabajando...");
    
    const tipoComida = document.getElementById('chef-tipo-comida').value;
    const hora = document.getElementById('chef-hora').value;
    const comensales = document.getElementById('chef-comensales').value;
    const estilo = document.getElementById('chef-estilo').value;
    const conPostre = document.getElementById('chef-postre').checked;
    const soloNevera = document.getElementById('chef-solo-nevera').checked;
    const peticionUsuario = document.getElementById('chef-peticion').value;

    try {
        const contextRes = await fetchWithTimeout(gasWebhookURL, { Type: 'get_user_context', chat_ID: chatId, hora_comida: hora });
        const userContextForChef = await contextRes.json();
        if (userContextForChef.error) throw new Error(userContextForChef.error);

        let prompt = `Rol: Eres un "Chef Asistente Contextual", amigable, creativo y pr√°ctico. Tu objetivo es ayudar a un usuario a decidir qu√© cocinar bas√°ndote en lo que tiene en casa y sus preferencias.
Contexto del Entorno del Usuario:
Ubicaci√≥n: ${userContextForChef.ciudad || 'desconocida'}, ${userContextForChef.pais || 'desconocido'}.
Estaci√≥n del A√±o: ${userContextForChef.estacion}.
Clima a la hora de la comida (${hora}): ${userContextForChef.clima_hora_especifica}.
Contexto de la Petici√≥n:
Tipo de Comida: ${tipoComida} ${conPostre ? '(con Postre incluido)' : ''}
N√∫mero de Comensales: ${comensales}
Estilo de Cocina Deseado: ${estilo}
Petici√≥n Espec√≠fica del Usuario: "${peticionUsuario || 'Ninguna'}"
Restricciones Diet√©ticas del Usuario: ${userContextForChef.preferencias_dieteticas || 'Ninguna especificada'}.
Condici√≥n de ingredientes: ${soloNevera ? 'El usuario solicita usar EXCLUSIVAMENTE los ingredientes de la foto, sin comprar nada m√°s.' : 'El usuario est√° dispuesto a comprar ingredientes si es necesario.'}
An√°lisis de Ingredientes:
Analiza las im√°genes adjuntas de la nevera/despensa del usuario. Lista en primer lugar los ingredientes principales que identificas.
Tu Tarea:
Basado en TODO el contexto anterior, proporciona 2 sugerencias de men√∫. Menciona el clima en tu descripci√≥n para hacerla m√°s personal. Tu respuesta DEBE estar en formato JSON, siguiendo estrictamente esta estructura:
{"sugerencias": [{"titulo_receta": "Nombre Receta 1","descripcion": "Texto apetitoso.","ingredientes_detectados": ["Ingrediente 1"],"ingredientes_a_comprar": [{"nombre": "Ingrediente 3", "cantidad": "1 ud"}],"postre": {"titulo": "Nombre Postre","descripcion": "Descripci√≥n.","ingredientes_a_comprar": []}},{"titulo_receta": "Nombre Receta 2","descripcion": "Texto apetitoso.","ingredientes_detectados": [],"ingredientes_a_comprar": [],"postre": null}]}
Instrucciones Adicionales:
Si no hay postre, el campo "postre" debe ser null. Si no hay ingredientes a comprar, el array debe estar vac√≠o. S√© realista.`;

        const makeRes = await fetchWithTimeout(chefWebhookURL, { 
            prompt: prompt, 
            images: files, 
            image_count: files.length
        }, true);

        const responseText = await makeRes.text();
        const data = JSON.parse(responseText);
        
        showToast("¬°Aqu√≠ tienes tus sugerencias!");
        renderChefResults(data.sugerencias);

    } catch(err) {
        showToast(err.message, true);
    } finally {
        hideSpinner();
    }
}

function renderChefResults(sugerencias) {
    updateBackButton();
    let html = '<div class="chef-container">';
    if (!sugerencias || sugerencias.length === 0) {
        html += '<div class="no-data-msg">üßë‚Äçüç≥<br>El Chef no ha encontrado sugerencias. Int√©ntalo de nuevo con otra foto o petici√≥n.</div>';
    } else {
        sugerencias.forEach((sug, index) => {
            html += `
            <div class="recipe-card" id="recipe-${index}">
                <div class="recipe-header"><h3 class="recipe-title">${sug.titulo_receta}</h3></div>
                <div class="recipe-body">
                    <p class="recipe-description">${sug.descripcion}</p>
                    <h4 class="recipe-subtitle">Ingredientes que ya tienes:</h4>
                    <ul class="recipe-ingredient-list">
                        ${(sug.ingredientes_detectados || []).map(ing => `<li>‚úÖ ${ing}</li>`).join('')}
                    </ul>
                    ${sug.ingredientes_a_comprar && sug.ingredientes_a_comprar.length > 0 ? `
                        <h4 class="recipe-subtitle" style="margin-top:15px;">Necesitar√°s comprar:</h4>
                        <ul class="recipe-ingredient-list buy">
                           ${sug.ingredientes_a_comprar.map(ing => `<li><input type="checkbox" class="buy-checkbox" checked data-item-name="${ing.nombre} (${ing.cantidad})"> ${ing.nombre} (${ing.cantidad})</li>`).join('')}
                        </ul>
                        <button class="add-article-btn" data-action="add-ingredients" style="width:100%; max-width:100%; margin-top:15px;">A√±adir seleccionados a la compra</button>
                    ` : '<p style="color:var(--muted); margin-top:15px;">¬°No necesitas comprar nada para esta receta!</p>'}
                    <button class="add-article-btn" data-action="copy-recipe" style="background-color: var(--muted); width:100%; max-width:100%; margin-top:10px;">Copiar Receta</button>
                </div>
            </div>`;
        });
    }
    html += `<div class="form-card" style="margin-top: 20px;"><button data-action="go-home" class="cancel" style="width:100%; max-width:100%; opacity:1; cursor:pointer;">Volver a Inicio</button></div>`;
    html += '</div>';
    
    mainContentArea.innerHTML = html;
    mainContentArea.removeEventListener('click', handleChefResultsClicks);
    mainContentArea.addEventListener('click', handleChefResultsClicks);
}

function handleChefResultsClicks(event) {
    const button = event.target.closest('[data-action]');
    if (!button) return;
    const action = button.dataset.action;
    switch(action) {
        case 'add-ingredients': addIngredientsToShoppingList(button); break;
        case 'copy-recipe': copyToClipboard(button); break;
        case 'go-home': renderDashboard(); break;
    }
}

function copyToClipboard(buttonElement) {
    const recipeCard = buttonElement.closest('.recipe-card');
    const title = recipeCard.querySelector('.recipe-title').innerText;
    const description = recipeCard.querySelector('.recipe-description').innerText;
    let textToCopy = `Receta: ${title}\n\n${description}\n\n`;
    const detectedIngredients = Array.from(recipeCard.querySelectorAll('.recipe-ingredient-list:not(.buy) li')).map(li => `- ${li.innerText.replace('‚úÖ ', '')}`);
    if(detectedIngredients.length > 0) textToCopy += `Ingredientes en casa:\n${detectedIngredients.join('\n')}\n\n`;
    const toBuyIngredients = Array.from(recipeCard.querySelectorAll('.recipe-ingredient-list.buy li')).map(li => `- ${li.innerText.trim()}`);
    if(toBuyIngredients.length > 0) textToCopy += `Ingredientes a comprar:\n${toBuyIngredients.join('\n')}`;
    navigator.clipboard.writeText(textToCopy).then(() => { showToast('Receta copiada al portapapeles'); }).catch(err => { showToast('Error al copiar la receta', true); });
}

async function addIngredientsToShoppingList(buttonElement) {
    const recipeCard = buttonElement.closest('.recipe-card');
    const checkboxes = recipeCard.querySelectorAll('.buy-checkbox:checked');
    if (checkboxes.length === 0) {
        showToast("No has seleccionado ning√∫n ingrediente.", true);
        return;
    }
    const itemsToAdd = Array.from(checkboxes).map(cb => cb.dataset.itemName);
    showSpinner();
    try {
        const payload = { Type: 'add_multiple_shopping_items', chat_ID: chatId, items: itemsToAdd };
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast(`${itemsToAdd.length} ingredientes a√±adidos a la lista.`);
        buttonElement.style.display = 'none';
        
        // Forzar resincronizaci√≥n de contadores del dashboard
        const syncCheck = await fetchWithTimeout(gasWebhookURL, { Type: 'resync_counts', chat_ID: chatId }).then(res => res.json());
        if (syncCheck.success) {
            appData.counts = syncCheck.counts; // Actualizar contadores localmente
            // La lista de compras se actualizar√° v√≠a Firestore listener, no necesita renderDashboard
        } else {
            initializeApp(); // Recarga completa si falla la resincronizaci√≥n
        }

    } catch(err) {
        showToast(err.message, true);
        initializeApp(); // Recarga completa en caso de error
    } finally {
        hideSpinner();
    }
}
// ==================================================
// --- M√ìDULO: AJUSTES (CON GUARDADO SEGURO) ---
// ==================================================
function renderSettings() {
    setActiveTab('tab-settings');
    navigationHistory.push(renderDashboard);
    updateBackButton();
    initialUserSettings = JSON.parse(JSON.stringify(appData.settings || {}));
    
    mainContentArea.innerHTML = `
        <div class="settings-container">
            <h2 class="settings-section-title">üë§ Perfil de Usuario</h2>
            <div class="form-card">
                <label>Nombre</label>
                <input type="text" id="settings-nombre" placeholder="Tu nombre" />
                <label>Ciudad</label>
                <input type="text" id="settings-ciudad" placeholder="Ej: Barcelona" />
                <label>Pa√≠s</label>
                <input type="text" id="settings-pais" placeholder="Ej: Espa√±a" />
                <div class="settings-item" style="padding-top:15px;">
                    <span class="settings-item-label">Tema de la App</span>
                    <div class="settings-item-control">
                        <select id="settings-theme">
                            <option value="auto">Autom√°tico (Telegram)</option>
                            <option value="light">Claro</option>
                            <option value="dark">Oscuro</option>
                        </select>
                    </div>
                </div>
            </div>

            <h2 class="settings-section-title">üìÑ Informaci√≥n de la Cuenta</h2>
            <div class="form-card">
                <label>Email de Registro (no editable)</label>
                <input type="email" id="settings-email" readonly />
                <label>Fecha de Activaci√≥n (no editable)</label>
                <input type="text" id="settings-fecha-activacion" readonly />
                <label>Zona Horaria Detectada (no editable)</label>
                <input type="text" id="settings-zona-horaria" readonly />
                <!-- INICIO DE CAMBIO: Campo Moneda a√±adido -->
                <label>Moneda (detectada)</label>
                <input type="text" id="settings-moneda" readonly />
                <!-- FIN DE CAMBIO -->
            </div>

            <h2 class="settings-section-title">üîî Informes y Alertas</h2>
            <div class="form-card">
                <div class="settings-item">
                    <span class="settings-item-label">Informe Matutino</span>
                    <label class="switch"><input type="checkbox" id="settings-informe-manana-activo"><span class="slider"></span></label>
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">Hora del Informe</span>
                    <select id="settings-franja-manana">
                        <option value="1">A primera hora (6:00)</option>
                        <option value="2">Habitual (7:00)</option>
                        <option value="3">Media ma√±ana (8:00)</option>
                        <option value="4">Tarde (9:00)</option>
                    </select>
                </div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item">
                    <span class="settings-item-label">Informe del Tiempo (Tarde)</span>
                    <label class="switch"><input type="checkbox" id="settings-informe-tarde-activo"><span class="slider"></span></label>
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">Hora del Informe</span>
                    <select id="settings-franja-tarde">
                        <option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option>
                    </select>
                </div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item">
                    <span class="settings-item-label">Informe Mensual de Gastos</span>
                    <label class="switch"><input type="checkbox" id="settings-informe-mensual-activo"><span class="slider"></span></label>
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">D√≠a de Env√≠o</span>
                    <select id="settings-dia-informe-mensual">
                        ${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join('')}
                    </select>
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">Hora de Env√≠o</span>
                    <select id="settings-hora-informe-mensual">
                        ${[...Array(15).keys()].map(i => `<option value="${i + 8}">${(i + 8).toString().padStart(2, '0')}:00</option>`).join('')}
                    </select>
                </div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item">
                    <span class="settings-item-label">Alertas de Compra Inteligente</span>
                    <label class="switch"><input type="checkbox" id="settings-alerta-inventario"><span class="slider"></span></label>
                </div>
            </div>
             
            <div class="form-card" style="margin-top: 20px;">
                <div class="button-group">
                    <button id="settings-cancel-btn" class="cancel">Cancelar</button>
                    <button id="settings-save-btn" disabled>Guardar Ajustes</button>
                </div>
            </div>

            <!-- INICIO DE CAMBIO: Bot√≥n movido y renombrado -->
            <div class="form-card" style="margin-top: 20px;">
                 <button id="settings-sync-btn" class="add-article-btn enabled" style="width:100%; max-width:100%; background-color: var(--muted);">Sincronizar Contadores</button>
            </div>
            <!-- FIN DE CAMBIO -->
        </div>
    `;

document.getElementById('settings-nombre').value = appData.settings['Nombre'] || '';
document.getElementById('settings-ciudad').value = appData.settings['Ciudad'] || '';
document.getElementById('settings-pais').value = appData.settings['Pais'] || '';
document.getElementById('settings-theme').value = appData.settings['Tema'] || 'auto';

document.getElementById('settings-email').value = appData.settings['Email'] || 'No disponible';
const fechaActivacion = appData.settings['Fecha_Activacion'] 
    ? new Date(appData.settings['Fecha_Activacion']).toLocaleString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' }) 
    : 'No disponible';
document.getElementById('settings-fecha-activacion').value = fechaActivacion;
document.getElementById('settings-zona-horaria').value = appData.settings['Time Zone'] || 'No disponible';
// INICIO DE CAMBIO: Poblar el campo Moneda
document.getElementById('settings-moneda').value = appData.settings['Moneda'] || 'No disponible';
// FIN DE CAMBIO

document.getElementById('settings-informe-manana-activo').checked = (appData.settings['Informe_Ma√±ana_Activo'] === 'SI');
document.getElementById('settings-franja-manana').value = appData.settings['Franja_Informe_Ma√±ana'] || '2';
document.getElementById('settings-informe-tarde-activo').checked = (appData.settings['Informe_Tarde_Activo'] === 'SI');
document.getElementById('settings-franja-tarde').value = appData.settings['Franja_Informe_Tarde'] || '20';
document.getElementById('settings-alerta-inventario').checked = (appData.settings['Alerta_Inventario'] === 'SI');

document.getElementById('settings-informe-mensual-activo').checked = (appData.settings['Informe_Mensual_Activo'] === 'SI');
document.getElementById('settings-dia-informe-mensual').value = appData.settings['Dia_Informe_Mensual'] || '1';
document.getElementById('settings-hora-informe-mensual').value = appData.settings['Hora_Informe_Mensual'] || '12';

const controls = document.querySelectorAll(
    '#settings-nombre, #settings-ciudad, #settings-pais, #settings-theme, ' +
    '#settings-informe-manana-activo, #settings-franja-manana, ' +
    '#settings-informe-tarde-activo, #settings-franja-tarde, ' +
    '#settings-informe-mensual-activo, #settings-dia-informe-mensual, #settings-hora-informe-mensual, ' +
    '#settings-alerta-inventario'
);
controls.forEach(control => {
    control.addEventListener('input', validateSettings);
    control.addEventListener('change', validateSettings);
});

document.getElementById('settings-save-btn').onclick = saveSettings;
document.getElementById('settings-cancel-btn').onclick = goBack;
document.getElementById('settings-sync-btn').onclick = syncCounts;

}

function validateSettings() {
    const saveBtn = document.getElementById('settings-save-btn');
    let hasChanged = false;
    if (document.getElementById('settings-nombre').value !== (initialUserSettings['Nombre'] || '')) hasChanged = true;
    if (document.getElementById('settings-ciudad').value !== (initialUserSettings['Ciudad'] || '')) hasChanged = true;
    if (document.getElementById('settings-pais').value !== (initialUserSettings['Pais'] || '')) hasChanged = true;
    if (document.getElementById('settings-theme').value !== (initialUserSettings['Tema'] || 'auto')) hasChanged = true;
    if (document.getElementById('settings-informe-manana-activo').checked !== (initialUserSettings['Informe_Ma√±ana_Activo'] === 'SI')) hasChanged = true;
    if (document.getElementById('settings-franja-manana').value != (initialUserSettings['Franja_Informe_Ma√±ana'] || '2')) hasChanged = true; 
    if (document.getElementById('settings-informe-tarde-activo').checked !== (initialUserSettings['Informe_Tarde_Activo'] === 'SI')) hasChanged = true;
    if (document.getElementById('settings-franja-tarde').value != (initialUserSettings['Franja_Informe_Tarde'] || '20')) hasChanged = true; 
    if (document.getElementById('settings-alerta-inventario').checked !== (initialUserSettings['Alerta_Inventario'] === 'SI')) hasChanged = true;
    if (document.getElementById('settings-informe-mensual-activo').checked !== (initialUserSettings['Informe_Mensual_Activo'] === 'SI')) hasChanged = true;
    if (document.getElementById('settings-dia-informe-mensual').value != (initialUserSettings['Dia_Informe_Mensual'] || '1')) hasChanged = true; 
    if (document.getElementById('settings-hora-informe-mensual').value != (initialUserSettings['Hora_Informe_Mensual'] || '12')) hasChanged = true; 
    
    saveBtn.disabled = !hasChanged;
    saveBtn.classList.toggle('enabled', hasChanged);
}

// --- FUNCI√ìN DE GUARDADO MODIFICADA (NO OPTIMISTA) ---
async function saveSettings() {
    showSpinner("Guardando...");
    const settingsToUpdate = {};
    
    const newName = document.getElementById('settings-nombre').value; if (newName !== (initialUserSettings['Nombre'] || '')) settingsToUpdate['Nombre'] = newName;
    const newCiudad = document.getElementById('settings-ciudad').value; if (newCiudad !== (initialUserSettings['Ciudad'] || '')) settingsToUpdate['Ciudad'] = newCiudad;
    const newPais = document.getElementById('settings-pais').value; if (newPais !== (initialUserSettings['Pais'] || '')) settingsToUpdate['Pais'] = newPais;
    const newTheme = document.getElementById('settings-theme').value; if (newTheme !== (initialUserSettings['Tema'] || 'auto')) settingsToUpdate['Tema'] = newTheme;
    const newMananaActivo = document.getElementById('settings-informe-manana-activo').checked; if (newMananaActivo !== (initialUserSettings['Informe_Ma√±ana_Activo'] === 'SI')) settingsToUpdate['Informe_Ma√±ana_Activo'] = newMananaActivo ? 'SI' : 'NO';
    const newFranjaManana = document.getElementById('settings-franja-manana').value; if (newFranjaManana != (initialUserSettings['Franja_Informe_Ma√±ana'] || '2')) settingsToUpdate['Franja_Informe_Ma√±ana'] = newFranjaManana;
    const newTardeActivo = document.getElementById('settings-informe-tarde-activo').checked; if (newTardeActivo !== (initialUserSettings['Informe_Tarde_Activo'] === 'SI')) settingsToUpdate['Informe_Tarde_Activo'] = newTardeActivo ? 'SI' : 'NO';
    const newFranjaTarde = document.getElementById('settings-franja-tarde').value; if (newFranjaTarde != (initialUserSettings['Franja_Informe_Tarde'] || '20')) settingsToUpdate['Franja_Informe_Tarde'] = newFranjaTarde;
    const newAlerta = document.getElementById('settings-alerta-inventario').checked; if (newAlerta !== (initialUserSettings['Alerta_Inventario'] === 'SI')) settingsToUpdate['Alerta_Inventario'] = newAlerta ? 'SI' : 'NO';
    const newMensualActivo = document.getElementById('settings-informe-mensual-activo').checked; if (newMensualActivo !== (initialUserSettings['Informe_Mensual_Activo'] === 'SI')) settingsToUpdate['Informe_Mensual_Activo'] = newMensualActivo ? 'SI' : 'NO';
    const newDiaMensual = document.getElementById('settings-dia-informe-mensual').value; if (newDiaMensual != (initialUserSettings['Dia_Informe_Mensual'] || '1')) settingsToUpdate['Dia_Informe_Mensual'] = newDiaMensual;
    const newHoraMensual = document.getElementById('settings-hora-informe-mensual').value; if (newHoraMensual != (initialUserSettings['Hora_Informe_Mensual'] || '12')) settingsToUpdate['Hora_Informe_Mensual'] = newHoraMensual;

    if (Object.keys(settingsToUpdate).length === 0) {
        hideSpinner();
        showToast("No hay cambios para guardar.");
        return;
    }

    try {
        const payload = { Type: 'save_user_settings', chat_ID: chatId, settings: settingsToUpdate };
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        
        if (data.error) throw new Error(data.error);

        if (data.success && data.updatedSettings) {
            Object.assign(appData.settings, data.updatedSettings);
            initialUserSettings = JSON.parse(JSON.stringify(appData.settings));

            document.getElementById('settings-ciudad').value = appData.settings['Ciudad'] || '';
            document.getElementById('settings-pais').value = appData.settings['Pais'] || '';
            document.getElementById('settings-zona-horaria').value = appData.settings['Time Zone'] || 'No disponible';
            document.getElementById('settings-moneda').value = appData.settings['Moneda'] || 'No disponible';
            
            showToast(data.message || "Ajustes guardados con √©xito.");
            document.getElementById('settings-save-btn').disabled = true;
            document.getElementById('settings-save-btn').classList.remove('enabled');
        } else {
            throw new Error("La respuesta del servidor no fue la esperada.");
        }

    } catch (err) {
        showToast(`Error al guardar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

async function syncCounts() {
    showSpinner("Sincronizando contadores...");
    try {
        const res = await fetchWithTimeout(gasWebhookURL, { Type: 'resync_counts', chat_ID: chatId });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        if (data.success && data.counts) {
            Object.assign(appData.counts, data.counts);
            showToast("Contadores resincronizados con √©xito.");
            renderDashboard(); // Re-renderizar el dashboard para mostrar los nuevos contadores
        } else {
            throw new Error("Respuesta inesperada del servidor.");
        }
    } catch (err) {
        showToast(`Error al sincronizar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function renderExportPage() {
    setActiveTab('tab-export');
    navigationHistory.push(renderDashboard);
    updateBackButton();
    mainContentArea.innerHTML = `
        <div class="export-container">
            <h2 class="settings-section-title">üìä Exportar Gastos</h2>
            <div class="form-card">
                <p style="font-size:0.9rem; color:var(--muted); margin-bottom:15px;">Selecciona el rango de fechas para la exportaci√≥n. Recibir√°s el archivo en tu email.</p>
                <label>Fecha de Inicio</label>
                <input type="text" id="export-start-date" required />
                <label>Fecha de Fin</label>
                <input type="text" id="export-end-date" required />
                <div class="button-group">
                    <button id="export-cancel-btn" class="cancel">Cancelar</button>
                    <button id="export-confirm-btn" class="enabled">Generar y Enviar</button>
                </div>
            </div>
        </div>
    `;
    const fpConfig = { dateFormat: "d/m/Y", locale: "es" };
    flatpickr("#export-start-date", { ...fpConfig, defaultDate: new Date(new Date().getFullYear(), 0, 1) });
    flatpickr("#export-end-date", { ...fpConfig, defaultDate: new Date() });
    document.getElementById('export-cancel-btn').onclick = goBack;
    document.getElementById('export-confirm-btn').onclick = executeExport;
}

async function executeExport() {
    showSpinner("Generando exportaci√≥n...");
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    if (!startDate || !endDate) {
        hideSpinner();
        showToast("Por favor, selecciona ambas fechas.", true);
        return;
    }
    try {
        const payload = { Type: 'export_gastos', chat_ID: chatId, startDate: startDate, endDate: endDate };
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast(data.message || "Petici√≥n de exportaci√≥n enviada. Revisa tu email.");
        renderDashboard();
    } catch (err) {
        showToast(`Error al exportar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

// ==================================================
// --- CONECTOR E INICIO DE LA APP ---
// ==================================================
function renderDashboard() {
  setActiveTab('tab-home');
  navigationHistory = [];
  updateBackButton();
  const counts = appData.counts;
  
  mainContentArea.innerHTML = `
    <div class="grid">
      <div class="card clickable-card"><div class="card-badge red" style="left:12px;" id="reminders-badge">${counts.remindersCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-recordatorios">‚ãÆ</button><div class="card-icon">üóìÔ∏è</div><div class="card-title">Recordatorios</div><div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">A√±adir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div></div>
      <div class="card clickable-card"><div class="card-badge-group"><div class="card-badge green" id="shopping-pending-badge">${counts.shoppingPendingCount || 0}</div><div class="card-badge red" id="shopping-bought-badge">${counts.shoppingBoughtCount || 0}</div></div><button class="card-menu-btn" data-menu-id="menu-shopping-list">‚ãÆ</button><div class="card-icon">üõí</div><div class="card-title">Compras</div><div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">A√±adir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div></div>
      <div class="card clickable-card"><div class="card-badge red" style="left:12px;" id="notes-badge">${counts.notesCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-notes">‚ãÆ</button><div class="card-icon">üìù</div><div class="card-title">Notas</div><div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">A√±adir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div></div>
      <div class="card disabled-card" id="calendar-card"><div class="card-badge red" style="left:12px;" id="calendar-badge">${counts.calendarTodayCount || 0}</div><div class="card-icon">üóìÔ∏è</div><div class="card-title">Calendario</div></div>
<div class="card clickable-card"><div class="card-badge card-badge-pill red" style="left:12px;" id="gastos-badge">${Number(counts.gastosMesActual || 0).toLocaleString('es-ES', { maximumFractionDigits: 0 })} ${appData.settings.moneda || ''}</div><button class="card-menu-btn" data-menu-id="menu-gastos">‚ãÆ</button><div class="card-icon">üí∞</div><div class="card-title">Gastos</div><div class="dropdown-menu" id="menu-gastos"><a class="dropdown-item" id="add-gasto-link">A√±adir</a><a class="dropdown-item" id="scan-gasto-link">Escanear Ticket</a><a class="dropdown-item" id="list-gastos-link">Ver/Buscar</a><a class="dropdown-item" id="view-gasto-chart-link">Ver Gr√°fico</a></div></div>      <div class="card disabled-card" onclick="() => showToast('Funci√≥n en desarrollo.')"><div class="card-icon">‚öñÔ∏è</div><div class="card-title">Cuentas Claras</div></div>
    </div>`;
  document.getElementById('add-reminder-link').onclick = renderReminderForm;
  document.getElementById('list-reminders-link').onclick = renderRemindersList;
  document.getElementById('view-shopping-list-link').onclick = renderShoppingList;
  document.getElementById('add-shopping-item-link').onclick = renderAddArticleForm;
  document.getElementById('add-note-link').onclick = () => renderNoteForm();
  document.getElementById('list-notes-link').onclick = renderNotesList;
  document.getElementById('scan-gasto-link').onclick = renderInstructionScreen;
  document.getElementById('add-gasto-link').onclick = () => renderAddGastoForm();
  document.getElementById('list-gastos-link').onclick = () => {
      navigationHistory.push(renderDashboard);
      updateBackButton();
      renderGastosSearchScreen();
  };
  document.getElementById('view-gasto-chart-link').onclick = renderGastoChart;
  
  // --- LISTENER MODIFICADO PARA LA TARJETA DE CALENDARIO ---
  document.getElementById('calendar-card').onclick = () => showToast('Funci√≥n en desarrollo.');

  document.querySelectorAll('.clickable-card').forEach(card => {
      card.addEventListener('click', (e) => {
          if (e.target.closest('.card-menu-btn') || e.target.closest('.dropdown-menu')) return;
          if (e.currentTarget.id === 'chef-card' && !isPremium) return;
          e.stopPropagation();
          const menuBtn = card.querySelector('.card-menu-btn');
          if (menuBtn) {
            const menuId = menuBtn.dataset.menuId;
            const menu = document.getElementById(menuId);
            if (menu) {
                const isShown = menu.classList.contains('show');
                document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                    if (m.id !== menuId) m.classList.remove('show');
                });
                if (isShown) {
                    menu.classList.remove('show');
                } else {
                    const buttonRect = menuBtn.getBoundingClientRect();
                    const windowHeight = window.innerHeight;

                    if (buttonRect.top > (windowHeight / 2)) {
                        menu.classList.add('up');
                    } else {
                        menu.classList.remove('up');
                    }
                    
                    menu.classList.add('show');
                }
            }
          }
      });
  });
}

// L√≥gica de pesta√±as
document.getElementById('tab-home').onclick = renderDashboard;
document.getElementById('tab-settings').onclick = renderSettings;
document.getElementById('tab-export').onclick = renderExportPage;
document.getElementById('tab-chef').onclick = () => {
    if (String(appData.settings.Premium).toLowerCase() === 'si') {
        renderChefPage();
    }
};
loadEmojiDictionary(); // Carga el diccionario de emojis
initializeApp();
});
</script>
</body>
</html>
