<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script>
    // Carga el tema guardado de forma segura
    document.addEventListener('DOMContentLoaded', (event) => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }
    });
</script>

    <!-- SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
    <style>
        :root { 
    --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; 
    --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; 
    --error-bg:#e74c3c; --delete-bg: #e74c3c; --input-bg: #f0f0f0;
}

body.dark-mode {
    --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --muted: #888;
    --input-bg: #2c2c2c;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
    background: var(--bg); color: var(--text); padding-bottom: 100px;
    transition: background-color 0.3s, color 0.3s;
}
.container { width: 100%; max-width: 480px; margin: 0 auto; padding: 10px; }
.card { 
    background: var(--card-bg); border-radius: 12px; 
    padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
    text-align: center; transition: background-color 0.3s;
}
.button { display: block; width: 100%; padding: 12px; background: var(--action-bg); color: var(--action-text); border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; text-decoration: none; margin-top: 15px; }
.button.secondary { background-color: #555; }
.button:disabled { background-color: #ccc; cursor: not-allowed; }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1.5s linear infinite; margin: 20px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.screen { display: none; }
.screen.active { display: block; }

.list-header { 
    padding: 15px 0; 
    text-align: center;
    display: flex; /* Nuevo */
    justify-content: center; /* Nuevo */
    align-items: center; /* Nuevo */
    position: relative; /* Nuevo */
}
.list-header h2 { margin: 0; font-size: 1.5rem; }

#theme-switcher {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
}

.summary-card { text-align: left; padding: 15px; margin-bottom: 15px; }
.summary-card .total { font-size: 1.8rem; font-weight: bold; text-align: center; }

#balances-container { margin-bottom: 20px; }
.balance-list { list-style: none; padding: 0; }
.balance-item { 
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--input-bg);
}
.balance-item:last-child { border-bottom: none; }
.balance-name { font-weight: 500; }
.balance-amount { font-weight: bold; }
.balance-amount.positive { color: #28a745; }
.balance-amount.negative { color: #e74c3c; }

.expense-list { list-style: none; padding: 0; }
.expense-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
.expense-item-info { text-align: left; }
.expense-item-desc { font-weight: 500; }
.expense-item-sub { font-size: 0.85rem; color: var(--muted); margin-top: 4px; }
.expense-item-amount { font-size: 1.2rem; font-weight: 500; text-align: right; }
.fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background-color: var(--primary); color: white; border-radius: 50%; border: none; font-size: 28px; line-height: 56px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; z-index: 1000; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
.modal-content { background: var(--card-bg); border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; }
.modal-content label { display: block; margin-top: 15px; font-weight: 600; text-align: left; }
.modal-content input, .modal-content select { width: 100%; padding: 10px; border: 1px solid var(--input-bg); border-radius: 8px; margin-top: 8px; background-color: var(--input-bg); color: var(--text); }
.split-options { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 8px; text-align: left; }
.split-options label { display: block; font-weight: 400; }
.no-data-msg { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; font-size: 1.2rem; line-height: 1.5; }
/* --- ESTILOS PARA LAS PESTA√ëAS --- */
.tabs {
    display: flex;
    justify-content: space-around;
    background-color: var(--card-bg);
    border-radius: 10px;
    padding: 5px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.tab-link {
    flex-grow: 1;
    padding: 10px 15px;
    cursor: pointer;
    border: none;
    background-color: transparent;
    color: var(--muted);
    font-size: 1rem;
    font-weight: 500;
    border-radius: 8px;
    transition: background-color 0.3s, color 0.3s;
}
.tab-link.active {
    background-color: var(--primary);
    color: var(--action-text);
}
.tab-content {
    display: none; /* Oculta todas las pesta√±as por defecto */
}
.tab-content.active {
    display: block; /* Muestra solo la pesta√±a activa */
}
/* --- INICIO: ESTILOS RESPONSIVOS --- */
@media (max-width: 480px) {
    .modal-content {
        width: 100%;
        height: 100%;
        border-radius: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .modal-content .split-options {
        flex-grow: 1; /* Permite que ocupe el espacio sobrante */
        margin-bottom: 15px;
    }

    .modal-content .button {
        margin-top: auto; /* Empuja los botones hacia abajo */
    }
}
/* --- FIN: ESTILOS RESPONSIVOS --- */
		/* --- INICIO: CORRECCIONES CSS --- */
html, body {
    overflow-x: hidden; /* Evita el scroll horizontal */
    width: 100%;
}

#toast-notification {
    visibility: hidden;
    width: 90%;
    max-width: 480px;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    z-index: 3000;
    font-size: 1rem;
    opacity: 0;
    transition: opacity 0.3s, visibility 0.3s;
}

#toast-notification.show {
    visibility: visible;
    opacity: 1;
    transition: opacity 0.3s;
}

@media (max-width: 480px) {
    .modal-content {
        width: 100%;
        height: 100%;
        border-radius: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .modal-content .split-options {
        flex-grow: 1; /* Permite que ocupe el espacio sobrante */
        margin-bottom: 15px;
    }

    .modal-content .button {
        margin-top: auto; /* Empuja los botones hacia abajo */
    }
}
/* --- INICIO: AJUSTE DE ANCHO DE CONTENIDO (V2) --- */
.container {
    padding: 10px; /* Asegura un peque√±o margen en los bordes de la pantalla */
}

.card, .summary-card, .expense-list, #gastos-tab, #pagos-tab {
    width: 100%;
}

.expense-item {
    display: flex;
    width: 100%;
    padding: 12px 15px;
}

.expense-item-info {
    flex-grow: 1; /* Permite que la descripci√≥n ocupe el espacio disponible */
    margin-right: 10px; /* Espacio entre la info y el importe */
}

.expense-item-amount {
    flex-shrink: 0; /* Evita que el importe se encoja */
}
/* --- INICIO: ESTILOS PARA GR√ÅFICO DE ESTAD√çSTICAS --- */
.stats-chart { list-style: none; padding: 0; margin-top: 25px; }
.chart-bar-item { display: flex; align-items: center; margin-bottom: 12px; }
.chart-bar-label { width: 80px; text-align: right; padding-right: 10px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chart-bar-container { flex-grow: 1; background-color: var(--input-bg); border-radius: 4px; }
.chart-bar { background-color: var(--primary); height: 24px; border-radius: 4px; text-align: right; padding-right: 8px; line-height: 24px; color: var(--action-text); font-size: 0.85rem; font-weight: 500; white-space: nowrap; }
/* --- FIN: ESTILOS PARA GR√ÅFICO DE ESTAD√çSTICAS --- */
/* --- FIN: AJUSTE DE ANCHO DE CONTENIDO (V2) --- */
	</style>
</head>
<body>
    <div id="app-container" class="container">
        <!-- PANTALLAS INICIALES -->
        <div id="loading-screen" class="screen active card"><div class="spinner"></div><p>Verificando invitaci√≥n...</p></div>
        <div id="error-screen" class="screen card"><h2 style="color: var(--error-bg);">‚ùå Enlace no v√°lido</h2><p id="error-message"></p></div>
        <div id="notifications-screen" class="screen card">
            <h2>¬°Hola, <span id="guest-name"></span>!</h2>
            <p>Te han invitado a <b>"<span id="list-name-perms"></span>"</b>.</p>
            <p style="font-size: 1.2rem; margin: 20px 0;">üîî</p>
            <p>Activa las notificaciones para saber al instante cu√°ndo alguien a√±ade un nuevo gasto.</p>
            <button id="accept-notifications-btn" class="button">Activar Notificaciones</button>
            <button id="reject-notifications-btn" class="button secondary">No, gracias</button>
        </div>
        
        <!-- PANTALLA PRINCIPAL CON PESTA√ëAS -->
<div id="main-screen" class="screen">
    
    <!-- ENCABEZADO PERSISTENTE (CORREGIDO) -->
    <div class="list-header">
        <h2 id="list-name-expenses"></h2>
        <button id="theme-switcher">üåì</button>
    </div>

<!-- PESTA√ëAS -->
<div class="tabs">
    <button class="tab-link active" data-tab="balances-tab">Balances</button>
    <button class="tab-link" data-tab="gastos-tab">Gastos</button>
    <button class="tab-link" data-tab="pagos-tab">Pagos</button>
    <button class="tab-link" data-tab="stats-tab">Estad√≠sticas</button>
</div>

    <!-- CONTENIDO DE LA PESTA√ëA BALANCES -->
<div id="balances-tab" class="tab-content active">
    <div id="balances-container" class="card summary-card">
        <!-- El resumen de balances se insertar√° aqu√≠ -->
    </div>

    <!-- BOT√ìN DE RECORDATORIO (INICIALMENTE OCULTO) -->
    <div id="reminder-button-container" style="display: none; padding: 0 10px; margin-top: 15px;">
        <button id="send-reminder-btn" class="button secondary">üîî Recordar a Deudores</button>
    </div>
</div>

<!-- CONTENIDO DE LA PESTA√ëA GASTOS -->
<div id="gastos-tab" class="tab-content">
    <div class="card summary-card">
        <p style="color: var(--muted); margin-bottom: 5px;">Total Gastado</p>
        <div id="total-spent" class="total">0,00 ‚Ç¨</div>
    </div>
    <ul id="expense-list-container" class="expense-list">
        <!-- Los gastos se insertar√°n aqu√≠ -->
    </ul>
    <button id="add-expense-btn" class="fab">+</button>
</div>

<!-- CONTENIDO DE LA PESTA√ëA PAGOS -->
<div id="pagos-tab" class="tab-content">
    <div class="card" id="payment-form-container">
         <!-- El formulario para registrar pagos se insertar√° aqu√≠ -->
    </div>
    <hr style="border: none; border-top: 1px solid var(--input-bg); margin: 24px 0;">
    <h3 style="text-align: center; color: var(--muted); margin-bottom: 15px;">Historial de Pagos</h3>
    <ul id="payment-list-container" class="expense-list" style="padding-top: 0;">
        <!-- El historial de pagos se insertar√° aqu√≠ -->
    </ul>
</div>

<!-- CONTENIDO DE LA PESTA√ëA ESTAD√çSTICAS -->
<div id="stats-tab" class="tab-content">
    <div class="card">
        <h2 style="text-align: center; margin-bottom: 20px;">Estad√≠sticas</h2>
        <div id="stats-container">
            <!-- Las estad√≠sticas y el gr√°fico se insertar√°n aqu√≠ -->
        </div>
    </div>
</div>

</div>
    </div>

    <!-- MODAL PARA A√ëADIR GASTO -->
    <div id="add-expense-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 20px;">A√±adir Gasto</h2>
            <label>Importe</label>
            <input type="number" id="expense-amount" placeholder="0.00" step="0.01" />
            <label>Descripci√≥n</label>
            <input type="text" id="expense-description" placeholder="Ej: Cena en el restaurante" />
            <label>Pagado por</label>
            <input type="text" id="payer-name" readonly style="background-color: #eee; font-weight: bold;">
            <label>¬øDividir entre?</label>
            <div class="split-options" id="split-checkboxes"></div>
            <button id="save-expense-btn" class="button" style="margin-top: 20px;" disabled>Guardar Gasto</button>
            <button id="cancel-expense-btn" class="button secondary">Cancelar</button>
        </div>
    </div>

<script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCz7-d3dX2uw_sF4swtmNY0zXScphxkZk",
      authDomain: "asistentepersonal-4ad2b.firebaseapp.com",
      projectId: "asistentepersonal-4ad2b",
      storageBucket: "asistentepersonal-4ad2b.firebasestorage.app",
      messagingSenderId: "1068752893536",
      appId: "1:1068752893536:web:4654f215bc2676b68bf505",
      measurementId: "G-XWEJS9BMFY"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const messaging = firebase.messaging();

    // --- VARIABLES GLOBALES ---
    let listId, guestToken, guestName, participants = [], listCurrency = '‚Ç¨';
    let unsubscribeExpenses = null;
    let unsubscribePayments = null; // A√±adimos para el nuevo listener

function showToast(msg, isError = false) {
    let toast = document.getElementById('toast-notification');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        Object.assign(toast.style, {
            visibility: 'hidden',
            width: '90%',
            maxWidth: '480px',
            textAlign: 'center',
            borderRadius: '8px',
            padding: '12px',
            position: 'fixed',
            left: '50%',
            bottom: '30px',
            transform: 'translateX(-50%)',
            zIndex: '3000',
            fontSize: '1rem',
            transition: 'visibility 0s 3s, opacity 0.3s'
        });
        document.body.appendChild(toast);
    }

    if (window.toastTimer) clearTimeout(window.toastTimer);
    
    toast.textContent = msg;
    toast.style.backgroundColor = isError ? 'var(--error-bg)' : 'var(--action-bg)';
    toast.style.color = 'var(--action-text)';
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';

    window.toastTimer = setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
    }, 3000);
}

    // --- INICIO DE LA APP ---
    function initializeAppLogic() {
        handlePageLoad();
        setupThemeSwitcher();
        setupTabs();
    }

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    async function handlePageLoad() {
    try {
        const params = new URLSearchParams(window.location.search);
        const pathParts = window.location.pathname.split('/lista/');
        listId = pathParts.length > 1 ? pathParts[1] : null;
        guestToken = params.get('invitado');

        if (!listId || !guestToken) throw new Error("El enlace es incompleto.");

        const listDoc = await db.collection('cuentasClaras_listas').doc(listId).get();
        if (!listDoc.exists) throw new Error("La lista de gastos no existe.");
        
        const listData = listDoc.data();
        const participant = listData.participantes.find(p => p.token === guestToken);
        if (!participant) throw new Error("Tu invitaci√≥n no es v√°lida para esta lista.");
        
        guestName = participant.nombre;
        // --- INICIO DE LA MODIFICACI√ìN ---
        // Guardamos la lista completa de participantes (con tokens) en una variable global
        window.fullParticipantsList = listData.participantes || []; 
        participants = listData.participantes.map(p => p.nombre);
        listCurrency = listData.moneda || '‚Ç¨';

        // Comprobamos si el usuario actual es el creador de la lista
        const isCreator = listData.token_creador && listData.token_creador === guestToken;
        if (isCreator) {
            const reminderContainer = document.getElementById('reminder-button-container');
            if (reminderContainer) {
                reminderContainer.style.display = 'block'; // Mostramos el bot√≥n
                document.getElementById('send-reminder-btn').onclick = () => sendDebtReminders(listData.nombre);
            }
        }
        // --- FIN DE LA MODIFICACI√ìN ---

        const storageKey = `cc_prefs_${guestToken}`;
        const localPrefs = JSON.parse(localStorage.getItem(storageKey));

        if (localPrefs && localPrefs.notificationPref) {
            initializeExpenseView(listData.nombre);
        } else {
            renderNotificationPermsView(listData.nombre, storageKey);
        }
    } catch (error) {
        document.getElementById('error-message').textContent = error.message;
        showScreen('error-screen');
    }
}

    async function requestNotificationPermission(listName, storageKey) {
    // --- INICIO: Mejora de Feedback ---
    const acceptBtn = document.getElementById('accept-notifications-btn');
    const rejectBtn = document.getElementById('reject-notifications-btn');
    const originalBtnText = acceptBtn.textContent;
    acceptBtn.disabled = true;
    rejectBtn.style.display = 'none'; // Ocultamos el bot√≥n de rechazar
    acceptBtn.innerHTML = `<div class="spinner" style="width:20px; height:20px; border-width:2px; display:inline-block; vertical-align:middle; margin:0 8px 0 0;"></div> Esperando permiso...`;
    // --- FIN: Mejora de Feedback ---

    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            const registration = await navigator.serviceWorker.getRegistration();
            if (!registration) throw new Error('No se encontr√≥ el registro del Service Worker.');
            
            const VAPID_KEY = 'BMGWIlbfno4MANJ6yGKEL6Zxti0XFkLFovZ6O0UguDMK6tMKRInE9tmAfuEKN3yWpyNvoVxvsN8uiShg9xqe1wQ'; 
            const fcmToken = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: registration });
            
            if (fcmToken) {
                const listDocRef = db.collection('cuentasClaras_listas').doc(listId);
                const listDoc = await listDocRef.get();
                if (!listDoc.exists) throw new Error("La lista ya no existe.");
                const listData = listDoc.data();
                const participantsArray = listData.participantes;
                const participantIndex = participantsArray.findIndex(p => p.token === guestToken);

                if (participantIndex !== -1) {
                    participantsArray[participantIndex].fcmToken = fcmToken;
                    await listDocRef.update({ participantes: participantsArray });
                }
                
                localStorage.setItem(storageKey, JSON.stringify({ notificationPref: 'accepted' }));
                alert('¬°Genial! Notificaciones activadas.'); // Mantenemos el alert para confirmaci√≥n expl√≠cita
                initializeExpenseView(listName);
            } else {
                throw new Error('No se pudo obtener el token de notificaci√≥n (FCM).');
            }
        } else {
            alert('Has denegado las notificaciones.');
            localStorage.setItem(storageKey, JSON.stringify({ notificationPref: 'denied' }));
            initializeExpenseView(listName);
        }
    } catch (error) {
        console.error('Error en permisos de notificaci√≥n:', error);
        alert(`Hubo un error al activar las notificaciones: ${error.message}`);
        initializeExpenseView(listName);
    } finally {
        // --- INICIO: Restaurar botones ---
        // Este bloque se ejecuta siempre, haya √©xito o error.
        acceptBtn.disabled = false;
        acceptBtn.innerHTML = originalBtnText;
        rejectBtn.style.display = 'block'; // Mostramos de nuevo el bot√≥n de rechazar
        // --- FIN: Restaurar botones ---
    }
}

    function renderNotificationPermsView(listName, storageKey) {
        document.getElementById('guest-name').textContent = guestName;
        document.getElementById('list-name-perms').textContent = listName;
        showScreen('notifications-screen');

        const acceptBtn = document.getElementById('accept-notifications-btn');
        const rejectBtn = document.getElementById('reject-notifications-btn');
        const newAcceptBtn = acceptBtn.cloneNode(true);
        acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
        const newRejectBtn = rejectBtn.cloneNode(true);
        rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);
        
        newAcceptBtn.addEventListener('click', () => requestNotificationPermission(listName, storageKey));
        newRejectBtn.addEventListener('click', () => {
            const confirmed = confirm(`¬øEst√°s seguro? Sin notificaciones, te perder√°s las actualizaciones.`);
            if (confirmed) {
                localStorage.setItem(storageKey, JSON.stringify({ notificationPref: 'rejected' }));
                initializeExpenseView(listName);
            }
        });
    }
    
    // --- BLOQUE DE FUNCIONES DE LA PANTALLA PRINCIPAL (ORDENADO) ---

    function initializeExpenseView(listName) {
        document.getElementById('list-name-expenses').textContent = listName;
        showScreen('main-screen');
        setupModal();
        setupRealtimeListeners(); // Ahora esta funci√≥n existe antes de ser llamada.
    }

    function setupRealtimeListeners() {
        if (typeof unsubscribeExpenses === 'function') unsubscribeExpenses();
        if (typeof unsubscribePayments === 'function') unsubscribePayments();

        const expensesQuery = db.collection('cuentasClaras_listas').doc(listId).collection('gastos');
        const paymentsQuery = db.collection('cuentasClaras_listas').doc(listId).collection('pagos');

        let gastosCache = [];
        let pagosCache = [];

        unsubscribeExpenses = expensesQuery.onSnapshot(snapshot => {
            gastosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateUI(gastosCache, pagosCache);
        });

        unsubscribePayments = paymentsQuery.onSnapshot(snapshot => {
            pagosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateUI(gastosCache, pagosCache);
        });
    }
    
    function updateUI(gastos, pagos) {
    // 1. Calcular todos los datos necesarios primero
    const finalBalances = calculateBalances(gastos, pagos);
    const statsData = calculateStats(gastos);

    // 2. Renderizar (dibujar) cada componente en su pesta√±a correspondiente
    renderBalances(finalBalances);     // Pesta√±a "Balances"
    renderExpensesAndSummary(gastos);  // Pesta√±a "Gastos"
    setupPaymentsTab(finalBalances);   // Pesta√±a "Pagos" (Formulario)
    renderPayments(pagos);             // Pesta√±a "Pagos" (Historial)
    renderStatistics(statsData);       // Pesta√±a "Estad√≠sticas"
}

    function calculateBalances(gastos, pagos) {
    window.currentBalances = {}; // Limpiamos la variable global
    const balances = window.currentBalances; // Usamos la variable global
    participants.forEach(p => { balances[p] = 0; });

    // 1. Calcular los saldos basados en los GASTOS
    gastos.forEach(gasto => {
        const importeTotal = gasto.importe;
        const pagadoPor = gasto.pagado_por;
        const divididoEntre = gasto.dividido_entre || [];

        if (importeTotal > 0 && divididoEntre.length > 0) {
            const costePorPersona = importeTotal / divididoEntre.length;

            divididoEntre.forEach(nombreParticipante => {
                if (balances.hasOwnProperty(nombreParticipante)) {
                    balances[nombreParticipante] -= costePorPersona;
                }
            });
            if (balances.hasOwnProperty(pagadoPor)) {
                balances[pagadoPor] += importeTotal;
            }
        }
    });

    // 2. Aplicar los PAGOS para ajustar los saldos
    if (pagos && pagos.length > 0) {
        pagos.forEach(pago => {
            if (balances.hasOwnProperty(pago.de_parte_de)) {
                balances[pago.de_parte_de] += pago.importe;
            }
            if (balances.hasOwnProperty(pago.para)) {
                balances[pago.para] -= pago.importe;
            }
        });
    }
    
    // 3. Devolver los datos calculados
    return balances;
}

function renderBalances(balances) {
    const container = document.getElementById('balances-container');
    if (Object.keys(balances).length === 0) {
        container.innerHTML = '<p>Calculando balances...</p>';
        return;
    }
    let html = '<p style="color: var(--muted); margin-bottom: 10px; text-align:center;">Balances Finales</p><ul class="balance-list">';
    for (const name in balances) {
        const amount = balances[name];
        // Se usan umbrales peque√±os para evitar problemas con decimales
        const esPositivo = amount > 0.005;
        const esNegativo = amount < -0.005;
        
        const amountClass = esPositivo ? 'positive' : (esNegativo ? 'negative' : '');
        const sign = esPositivo ? '+' : '';
        
        html += `<li class="balance-item"><span class="balance-name">${name}</span><span class="balance-amount ${amountClass}">${sign}${amount.toFixed(2).replace('.',',')} ${listCurrency}</span></li>`;
    }
    html += '</ul>';
    container.innerHTML = html;
}

    function renderExpensesAndSummary(gastos) {
    const container = document.getElementById('expense-list-container');
    const total = gastos.reduce((sum, gasto) => sum + gasto.importe, 0);
    document.getElementById('total-spent').textContent = `${total.toFixed(2).replace('.',',')} ${listCurrency}`;

    if (gastos.length === 0) {
        container.innerHTML = `<div class="no-data-msg">A√∫n no hay gastos.<br>¬°A√±ade el primero!</div>`;
        return;
    }
    container.innerHTML = gastos.sort((a, b) => b.fecha - a.fecha).map(gasto => {
        const fecha = gasto.fecha ? gasto.fecha.toDate().toLocaleDateString('es-ES') : 'Sin fecha';
        return `<li class="expense-item"><div class="expense-item-info"><div class="expense-item-desc">${gasto.descripcion}</div><div class="expense-item-sub">Pagado por <b>${gasto.pagado_por}</b> el ${fecha}</div></div><div class="expense-item-amount">${gasto.importe.toFixed(2).replace('.',',')} ${listCurrency}</div></li>`;
    }).join('');
}

function renderPayments(pagos) {
    const container = document.getElementById('payment-list-container');
    if (!container) return;
    if (!pagos || pagos.length === 0) {
        container.innerHTML = `<p style="color: var(--muted); text-align: center; padding: 20px 0;">A√∫n no se han registrado pagos.</p>`;
        return;
    }
    container.innerHTML = pagos.sort((a, b) => b.fecha - a.fecha).map(pago => {
        const fecha = pago.fecha ? pago.fecha.toDate().toLocaleDateString('es-ES') : 'Sin fecha';
        return `<li class="expense-item" style="padding: 12px 15px;"><div class="expense-item-info"><div class="expense-item-desc"><b>${pago.de_parte_de}</b> pag√≥ a <b>${pago.para}</b></div><div class="expense-item-sub">${fecha}</div></div><div class="expense-item-amount">${pago.importe.toFixed(2).replace('.',',')} ${listCurrency}</div></li>`;
    }).join('');
}
function calculateStats(gastos) {
    const stats = {};
    participants.forEach(p => { stats[p] = 0; });
    gastos.forEach(gasto => {
        if (stats.hasOwnProperty(gasto.pagado_por)) {
            stats[gasto.pagado_por] += gasto.importe;
        }
    });
    return Object.entries(stats).map(([name, total]) => ({ name, total })).sort((a, b) => b.total - a.total);
}

function renderStatistics(statsData) {
    const container = document.getElementById('stats-container');
    if (!statsData || statsData.length === 0) {
        container.innerHTML = '<p>No hay datos para mostrar estad√≠sticas.</p>';
        return;
    }

    const maxTotal = Math.max(...statsData.map(d => d.total));
    let chartHtml = '<ul class="stats-chart">';

    statsData.forEach(item => {
        const barWidth = (maxTotal > 0) ? (item.total / maxTotal) * 100 : 0;
        chartHtml += `
            <li class="chart-bar-item">
                <span class="chart-bar-label" title="${item.name}">${item.name}</span>
                <div class="chart-bar-container">
                    <div class="chart-bar" style="width: ${barWidth}%;">
                        ${item.total.toFixed(2).replace('.',',')} ${listCurrency}
                    </div>
                </div>
            </li>`;
    });
    
    chartHtml += '</ul>';
    container.innerHTML = chartHtml;
}

    function setupPaymentsTab(balances) {
    const formContainer = document.getElementById('payment-form-container');
    if (!formContainer) return;

    const myBalance = balances[guestName] || 0;
    const creditors = Object.entries(balances)
        .filter(([name, amount]) => amount > 0.01 && name !== guestName);
    const myTotalDebt = Math.abs(myBalance < -0.01 ? myBalance : 0);
        
    let formHtml = '';
    if (myTotalDebt < 0.01 || creditors.length === 0) {
        formHtml = `<p style="color: var(--muted); text-align: center; padding: 20px 0;">¬°Est√°s al d√≠a! No tienes deudas pendientes.</p>`;
    } else {
        const recipientOptions = creditors.map(([name, amount]) => 
            `<option value="${name}">${name} (le debes ${amount.toFixed(2).replace('.',',')} ${listCurrency})</option>`
        ).join('');

        formHtml = `
            <h2 style="text-align: center; margin-bottom: 20px;">Registrar un Pago</h2>
            <label for="payment-amount" style="display: block; text-align: left; font-weight: 600;">Importe</label>
            <input type="number" id="payment-amount" placeholder="${myTotalDebt.toFixed(2)}" step="0.01" style="width: 100%; padding: 10px; border: 1px solid var(--input-bg); border-radius: 8px; margin-top: 8px; margin-bottom: 15px; background-color: var(--input-bg); color: var(--text);">
            <label for="payment-recipient" style="display: block; text-align: left; font-weight: 600;">He pagado a</label>
            <select id="payment-recipient" style="width: 100%; padding: 10px; border: 1px solid var(--input-bg); border-radius: 8px; margin-top: 8px; margin-bottom: 20px; background-color: var(--input-bg); color: var(--text);">
                <option value="">Selecciona a qui√©n pagaste...</option>
                ${recipientOptions}
            </select>
            <button id="save-payment-btn" class="button">Guardar Pago</button>`;
    }
    formContainer.innerHTML = formHtml;
    
    const saveBtn = document.getElementById('save-payment-btn');
    if (saveBtn) {
        saveBtn.onclick = async () => {
            const amountInput = document.getElementById('payment-amount');
            const recipient = document.getElementById('payment-recipient').value;
            let amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                amount = myTotalDebt;
            }

            if (!recipient) {
                showToast('Selecciona a qui√©n le has pagado.', true);
                return;
            }
            if (isNaN(amount) || amount < 0.01) { 
                showToast('El importe del pago debe ser mayor que cero.', true);
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';

            const newPayment = {
                importe: amount,
                de_parte_de: guestName,
                para: recipient,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('cuentasClaras_listas').doc(listId).collection('pagos').add(newPayment);
                showToast('Pago registrado con √©xito.');
                amountInput.value = '';
                document.getElementById('payment-recipient').value = '';
            } catch (error) {
                console.error("Error al guardar el pago:", error);
                showToast("Hubo un error al guardar el pago.", true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Pago';
            }
        };
    }
}
    
    function setupModal() {
        const modal = document.getElementById('add-expense-modal');
        const addBtn = document.getElementById('add-expense-btn');
        const cancelBtn = document.getElementById('cancel-expense-btn');
        const saveBtn = document.getElementById('save-expense-btn');
        addBtn.onclick = () => { populateModal(); modal.style.display = 'flex'; };
        cancelBtn.onclick = () => modal.style.display = 'none';
        saveBtn.onclick = async () => {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            const amountInput = document.getElementById('expense-amount');
            const descriptionInput = document.getElementById('expense-description');
            const dividido_entre = Array.from(document.querySelectorAll('#split-checkboxes input:checked')).map(cb => cb.value);
            const newExpense = { importe: parseFloat(amountInput.value), descripcion: descriptionInput.value.trim(), pagado_por: guestName, dividido_entre: dividido_entre, fecha: firebase.firestore.FieldValue.serverTimestamp() };
            try {
                await db.collection('cuentasClaras_listas').doc(listId).collection('gastos').add(newExpense);
                modal.style.display = 'none';
            } catch (error) {
                alert("Error al guardar el gasto.");
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Gasto';
            }
        };
    }

    function populateModal() {
        document.getElementById('payer-name').value = guestName;
        const splitCheckboxes = document.getElementById('split-checkboxes');
        splitCheckboxes.innerHTML = participants.map(p => `<label><input type="checkbox" value="${p}" checked> ${p}</label>`).join('');
        const amountInput = document.getElementById('expense-amount');
        const descriptionInput = document.getElementById('expense-description');
        const saveBtn = document.getElementById('save-expense-btn');
        const validate = () => {
             const amountValid = parseFloat(amountInput.value) > 0;
             const descValid = descriptionInput.value.trim() !== '';
             const splitValid = document.querySelectorAll('#split-checkboxes input:checked').length > 0;
             saveBtn.disabled = !(amountValid && descValid && splitValid);
        };
        splitCheckboxes.querySelectorAll('input').forEach(cb => cb.onchange = validate);
        amountInput.oninput = validate;
        descriptionInput.oninput = validate;
        amountInput.value = '';
        descriptionInput.value = '';
        validate();
    }

    function setupThemeSwitcher() {
        const themeSwitcher = document.getElementById('theme-switcher');
        themeSwitcher.onclick = () => {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        };
    }

    function setupTabs() {
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        tabLinks.forEach(link => {
            link.addEventListener('click', () => {
                tabLinks.forEach(l => l.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                link.classList.add('active');
                const tabId = link.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
    }
</script>
<script>
    // Funci√≥n para registrar el Service Worker en segundo plano
    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/firebase-messaging-sw.js', { scope: '/' })
                .then(registration => {
                    console.log('Service Worker registrado con √©xito, alcance:', registration.scope);
                })
                .catch(error => {
                    console.error('Error en el registro del Service Worker:', error);
                });
        }
    }

    // Arrancamos la l√≥gica de la app inmediatamente al cargar la p√°gina
    initializeAppLogic();
    // Y registramos el Service Worker sin bloquear el inicio
    registerServiceWorker();
// --- NUEVA FUNCI√ìN PARA ENVIAR RECORDATORIOS DE DEUDA ---
async function sendDebtReminders(listName) {
    const sendBtn = document.getElementById('send-reminder-btn');
    if (!sendBtn || sendBtn.disabled) return;

    sendBtn.disabled = true;
    sendBtn.textContent = 'Enviando...';

    try {
        // Obtenemos los saldos actuales, que ya han sido calculados por la UI
        const balances = window.currentBalances || {};
        const debtors = [];

        // Identificamos a los deudores y recopilamos sus fcmTokens
        for (const name in balances) {
            if (balances[name] < -0.01) { // Umbral para considerar deuda
                const participantData = window.fullParticipantsList.find(p => p.nombre === name);
                if (participantData && participantData.fcmToken) {
                    debtors.push(participantData.fcmToken);
                }
            }
        }
        
        if (debtors.length === 0) {
            showToast("¬°Genial! Nadie tiene saldos negativos.");
            return;
        }
        
        // --- LLAMADA A LA GOOGLE CLOUD FUNCTION ---
        // Nota: Debes asegurarte de que tu Cloud Function pueda recibir y procesar este payload.
        const webhookUrl = 'URL_DE_TU_CLOUD_FUNCTION'; // <-- REEMPLAZA CON TU URL REAL
        
        const payload = {
            tipoNotificacion: "recordatorioDeuda",
            nombreLista: listName,
            fcmTokens: debtors
        };
        
        // Usamos fetch para llamar a la funci√≥n. Asumimos que es una funci√≥n HTTP.
        const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'El servidor devolvi√≥ un error.');
        }

        showToast(`Recordatorios enviados a ${debtors.length} participante(s).`);

    } catch (error) {
        console.error('Error al enviar recordatorios:', error);
        showToast(`Error: ${error.message}`, true);
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'üîî Recordar a Deudores';
    }
}
</script>
</body>
</html>
