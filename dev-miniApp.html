<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/plugins/confirmDate/confirmDate.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src="https://npmcdn.com/flatpickr/dist/plugins/confirmDate/confirmDate.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- Librer√≠a de Mapas (Leaflet.js) -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
	<link rel="stylesheet" href="https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/dist/leaflet-color-markers.css" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SDKs de Firebase para la Mini App (Cargados de forma segura) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <!-- SDKs de Firebase para la Mini App -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(135px, 1fr));gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);position:relative;aspect-ratio:1 / 1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;}
    .card.clickable-card { cursor: pointer; }

/* --- INICIO: ESTILOS PARA FEEDBACK DE EMERGENCIA --- */
	.card.emergency-selected {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(74, 118, 243, 0.4);
    border: 2px solid var(--primary);
}
	.grid.emergency-dimmed .card:not(.emergency-selected) {
    opacity: 0.6;
    pointer-events: none;
    transform: scale(0.98);
}
/* --- FIN: ESTILOS PARA FEEDBACK DE EMERGENCIA --- */
	.card.sortable-ghost {
    opacity: 0.4;
    background: #c8ebfb;
}
	.card.sortable-chosen {
    cursor: grabbing;
}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:8px;left:8px;background:var(--badge-color);color:#fff;border-radius:12px;min-width:24px;height:24px;padding:0 7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:24px;font-weight:500;}
	.card-badge.card-badge-pill {
    width: auto;
    height: auto;
    min-width: 0;
    border-radius: 999px;
    padding: 4px 9px;
    font-size: 0.85rem;
    line-height: 1.2;
    display: flex;
    align-items: center;
    gap: 4px;
    /* --- L√çNEA A√ëADIDA --- */
    color: var(--action-text, #fff) !important; /* Asegura que el texto e iconos sean siempre blancos */
}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
	.trend-icon { font-size: 0.9em; vertical-align: middle; margin-left: 2px; font-weight: bold; }
	.trend-up { color: #e74c3c; }
	.trend-down { color: #2ecc71; }
    .card-badge.green{background-color:#28a745;}
    .card-badge.red{background-color:#e74c3c;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; z-index: 10; }
        .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1100; /* Prioridad muy alta para estar siempre por encima */ overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
    .dropdown-menu.up { top: auto; bottom: 100%; margin-bottom: 5px; }
    .dropdown-item { padding: 12px 20px; color: var(--text) !important; background-color: var(--card-bg, #fff) !important; cursor: pointer; display: block; text-align: left; transition: background-color 0.2s, color 0.2s; }
    .dropdown-item:hover { background-color: var(--primary, #4a76f3) !important; color: var(--action-text, #fff) !important; }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container, .settings-container, .export-container, .chef-container {max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input, .form-card select, .form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input, .form-card select{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text); background-color: var(--bg, #f5f7fa);}
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center; flex-wrap: wrap;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .form-card .button-group { display: flex; gap: 10px; margin-top: 20px; }
    .form-card .button-group button { flex: 1; margin-top: 0; }
    .form-card button.cancel { background-color: var(--delete-bg); opacity: 1; cursor: pointer; }
.toast {
    visibility: hidden;
    width: 90%;
    max-width: 480px;
    background: var(--action-bg);
    color: var(--action-text);
    text-align: left; /* Alineamos a la izquierda para el texto */
    border-radius: 8px;
    padding: 12px 15px;
    position: fixed;
    left: 50%;
    bottom: 80px;
    transform: translateX(-50%);
    z-index: 1000;
    font-size: 1rem;
    display: flex; /* Nuevo */
    align-items: center; /* Nuevo */
    justify-content: space-between; /* Nuevo */
}

.toast.error {
    background: var(--error-bg);
}

.toast.show {
    visibility: visible;
    animation: fadein .3s; /* Eliminamos el fadeout autom√°tico */
}

.toast.fadeout {
    animation: fadeout .3s forwards; /* Nueva clase para cierre manual */
}

.toast-close-btn {
    background: none;
    border: none;
    color: var(--action-text);
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    margin-left: 15px;
    opacity: 0.8;
}    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    /* --- SPINNER MEJORADO (M√ÅS FLUIDO Y REUTILIZABLE) --- */
    /* --- ESTILOS PARA EL CONTENEDOR DEL SPINNER GENERAL --- */
#spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Centrado perfecto */
    z-index: 1001;
}
    
    /* --- ESTILOS PARA SPINNER DENTRO DE BOTONES --- */
    .btn-spinner {
        animation: spin-button 0.8s linear infinite;
        border-color: rgba(255, 255, 255, 0.8) !important;
        border-top-color: transparent !important; /* Esto crea el efecto de giro */
    }

    @keyframes spin-button {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
	.btn-spinner {
    display: inline-block !important; /* Asegura que se muestre */
    position: relative !important; /* Anula el 'fixed' */
    top: 0 !important; left: 0 !important; transform: none !important; /* Anula el centrado */
    border-color: white !important; /* Color para que se vea bien en botones oscuros */
    border-top-color: transparent !important; /* Efecto de giro */
    border-width: 2px !important; /* M√°s fino para el bot√≥n */
    width: 18px !important; height: 18px !important; /* M√°s peque√±o */
    vertical-align: middle;
    margin-right: 8px;
}

.share-action-btn {
    width: 44px;
    height: 44px;
    padding: 8px;
    border-radius: 50%; /* Esto los hace redondos */
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1 !important;
    transition: transform 0.2s ease;
}
.share-action-btn:hover {
    transform: scale(1.1);
}
.share-action-btn svg {
    width: 100%;
    height: 100%;
    fill: white; /* Color del logo */
}
.participant-item.selected {
    background-color: var(--primary) !important;
    color: var(--action-text) !important;
    transform: scale(1.02);
}
.participant-item.selected .list-item-subtitle {
    color: var(--action-text) !important;
    opacity: 0.8;
}
}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .list-style-none { list-style: none; padding: 0; margin: 0; }
    .list-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .list-item-content { display: flex; flex-direction: column; flex-grow: 1; text-align: left;}
    .list-item-title { font-size: 1.1rem; font-weight: 500; }
    .list-item-subtitle { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .list-item-actions { display: flex; align-items: center; gap: 5px; position: relative; flex-shrink: 0; }
    .generic-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-data-msg { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; font-size: 1.2rem; line-height: 1.5; }
    #recurrent-hours-container { display: none; margin-top: 15px; }
    .shopping-list-header-row { display: flex; align-items: center; justify-content: flex-end; padding: 0 10px 10px 10px; color: var(--muted); font-size: 0.9rem; }
    .shopping-list-header-row input[type="checkbox"] { margin-left: 5px; }
    .shopping-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .shopping-item-checkbox-wrapper { flex-shrink: 0; }
    .shopping-item input[type="checkbox"] { width: 20px; height: 20px; }
    .shopping-item-toggle-btn { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; color: var(--list-item-text); cursor: pointer; text-align: left; }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); }
    .shopping-item-toggle-btn .item-date { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; display:block; }
    .add-article-btn-container { padding: 10px; text-align: center; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .add-article-btn, .multi-select-action-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; flex-grow: 1; max-width: 250px; }
    .multi-select-action-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .shopping-list-section-title { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 10px 10px 10px; padding-top: 10px; border-top: 1px solid #eee; text-align: left; }
    .shopping-list-section-title:first-of-type { border-top: none; margin-top: 0; }
    .note-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .note-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; }
    .note-header-interactive { flex-grow: 1; padding-right: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .note-title-section { display: flex; flex-direction: column; text-align: left; }
    .note-title { font-size: 1.1rem; font-weight: 500; }
    .note-date { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .note-description { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    .note-item.open .note-description { max-height: 500px; padding: 0 15px 15px; }
    .expand-arrow { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
    .note-item.open .expand-arrow { transform: rotate(180deg); }
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; text-align: left;}
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; display: none; }
    .list-item.open .event-description { display: block; }
    .gasto-chart-container { text-align: center; margin-top: 15px; }
    .gasto-chart-container canvas { max-width: 100%; }
    .gasto-legend { list-style: none; padding: 15px 0 0 0; margin: 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .gasto-legend-item { display: flex; align-items: center; font-size: 0.9rem; }
    .gasto-legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; }
/* Contenedor principal de la fila de notificaci√≥n */
.notification-row {
    display: flex;         /* Usa Flexbox para alinear todo en una l√≠nea */
    align-items: center;   /* Centra los elementos verticalmente */
    gap: 8px;              /* Espacio entre los elementos (controles y bot√≥n) */
    margin-bottom: 8px;
}

/* El contenedor de los selects y el input num√©rico */
.notification-controls-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;              /* Espacio interno entre los controles */
    flex-grow: 1;          /* ¬°CLAVE! Hace que este grupo ocupe todo el espacio disponible */
}

/* Estilo para los selects y el input dentro de la fila */
.notification-row select, .notification-row input {
    margin-top: 0 !important; /* Anula otros m√°rgenes */
    padding: 8px;             /* Un poco de padding para que se vean mejor */
    flex: 1;                  /* Permite que los controles compartan el espacio de forma flexible */
    min-width: 60px;          /* Un ancho m√≠nimo para que nunca colapsen */
}

/* El bot√≥n de la papelera */
.notification-row .remove-notification-btn {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    color: var(--muted);
    cursor: pointer;
    padding: 0 5px;
    flex-shrink: 0;        /* ¬°CLAVE! Impide que el bot√≥n se encoja o desaparezca */
    line-height: 1;
}
    #image-preview-overlay, #chef-image-preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    #image-preview-element, #chef-image-preview-element { max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    #image-preview-actions { display: flex; gap: 20px; margin-top: 20px; width: 100%; max-width: 400px; }
    #image-preview-actions button { flex: 1; padding: 15px; font-size: 1.2rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; }
    #preview-send-btn { background-color: var(--action-bg); color: var(--action-text); }
    #preview-cancel-btn { background-color: var(--delete-bg); color: var(--delete-text); }
    .scan-instruction-screen { text-align: center; padding: 40px 20px; display: flex; flex-direction: column; justify-content: center; height: 100vh; }
    .scan-instruction-screen h2 { font-size: 1.6rem; margin-bottom: 20px; }
    .scan-instruction-screen ol { text-align: left; margin: 0 auto 30px auto; max-width: 300px; }
    .scan-instruction-screen li { margin-bottom: 10px; line-height: 1.5; }
    .scan-instruction-screen .add-article-btn { max-width: 100%; }
    .dropdown-item { background-color: var(--menu-bg, #fff); }
    .form-card textarea, .form-card input, .form-card select { background-color: var(--card-bg, #fff); color: var(--text, #333); border: 1px solid var(--muted, #ddd); }
    .dropdown-menu { background-color: var(--card-bg, #fff); }
    .settings-section-title { font-size: 1.3rem; font-weight: 600; color: var(--text); margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid #eee; text-align: left;}
    .settings-section-title:first-of-type { margin-top: 0; }
    .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
    .settings-item-label { font-size: 1.1rem; }
    .settings-item-control { flex-shrink: 0; margin-left: 15px; }
    .settings-item-control input, .settings-item-control select { margin-top:0 !important; width: auto; max-width: 150px;}
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }
    .chef-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .chef-item label { margin-top:0; }
    #chef-peticion-ayuda { font-size: 0.85rem; color: var(--muted); margin-top: 5px; display: block; }
    .recipe-card { background: var(--card-bg); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .recipe-header { padding: 15px; border-bottom: 1px solid #eee; }
    .recipe-title { font-size: 1.2rem; font-weight: 600; }
    .recipe-body { padding: 15px; }
    .recipe-description { margin-bottom: 15px; line-height: 1.5; }
    .recipe-subtitle { font-size: 1rem; font-weight: 500; margin-bottom: 8px; }
    .recipe-ingredient-list li { list-style: none; margin-bottom: 5px; }
    .recipe-ingredient-list.buy li { display: flex; align-items: center; }
    .recipe-ingredient-list.buy input { margin-right: 10px; width: 18px; height: 18px; }
	.recipe-body .event-description {
    margin-top: 0 !important;
}
	.recipe-body .event-description {
    margin-top: 0 !important;
}
    #chef-image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .preview-item { position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; }
    .preview-image { width: 100%; height: 100%; object-fit: cover; }
    .delete-preview-btn { position: absolute; top: 4px; right: 4px; width: 22px; height: 22px; background-color: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; font-size: 14px; line-height: 22px; text-align: center; cursor: pointer; font-weight: bold; }
    .tab-premium-locked {
        cursor: not-allowed;
        opacity: 0.6;
        pointer-events: none; /* Bloquea los clics */
    }
    .list-item.clickable {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .list-item.clickable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* --- INICIO C√ìDIGO NUEVO --- */
    .card.disabled-card {
        position: relative;
        cursor: not-allowed;
        overflow: hidden; /* Importante para la banda */
    }
    .card.disabled-card::before {
        content: "En desarrollo";
        position: absolute;
        top: 25px;
        right: -35px;
        background-color: #f39c12; /* Color naranja */
        color: white;
        padding: 5px 30px;
        transform: rotate(45deg);
        font-size: 0.8rem;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 5;
    }
    .card.disabled-card .card-icon, .card.disabled-card .card-title, .card.disabled-card .card-badge {
	/* Estilo espec√≠fico para la franja de la tarjeta Chef bloqueada */
.card.disabled-card#chef-card-locked::before {
    content: "Funci√≥n Premium ‚≠ê";
    background-color: #f1c40f; /* Un color dorado para Premium */
}
        opacity: 0.5;
    }
    /* --- FIN C√ìDIGO NUEVO --- */
   /* --- INICIO C√ìDIGO SPLASH SCREEN --- */
.splash-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--bg, #f5f7fa);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease-out;
  opacity: 1;
}
.splash-screen.hidden {
  opacity: 0;
  pointer-events: none;
}
.splash-logo {
  width: 120px;
  height: 120px;
  animation: pulse 1.5s infinite ease-in-out;
}
.splash-text {
  margin-top: 20px;
  font-size: 1.2rem;
  color: var(--muted, #555);
}
@keyframes pulse {
  0% { transform: scale(0.95); }
  50% { transform: scale(1); }
  100% { transform: scale(0.95); }
}
/* --- FIN C√ìDIGO SPLASH SCREEN --- */

/* --- INICIO ESTILOS SPINNER DE PUNTOS --- */
.dot-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px; /* Espacio entre los puntos */
}
.dot-spinner__dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background-color: var(--primary); /* Usa el color principal de la app */
  animation: pulse-dot 1.4s infinite ease-in-out;
}
.dot-spinner__dot:nth-child(2) {
  animation-delay: 0.2s;
}
.dot-spinner__dot:nth-child(3) {
  animation-delay: 0.4s;
}
@keyframes pulse-dot {
  0%, 100% {
    transform: scale(0.5);
    opacity: 0.5;
  }
  50% {
    transform: scale(1);
    opacity: 1;
  }
}
/* --- INICIO: ESTILO PARA ESTADO DE CARGA LOCALIZADO --- */
.combustible-loading-state {
    text-align: center;
    padding: 20px 0;
    color: var(--muted);
}
.combustible-loading-state .dot-spinner {
    margin-top: 15px; /* Espacio entre el texto y los puntos */
}
/* --- INICIO: ESTILOS PARA LISTA INTELIGENTE DE COMBUSTIBLE --- */
.combustible-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 10px;
    border-bottom: 1px solid var(--bg);
    cursor: pointer;
    transition: background-color 0.2s;
}
.combustible-list-item:hover {
    background-color: var(--bg);
}
.combustible-item-info {
    display: flex;
    flex-direction: column;
    text-align: left;
}
.combustible-item-name {
    font-weight: 500;
    font-size: 1rem;
}
.combustible-item-distance {
    font-size: 0.85rem;
    color: var(--muted);
    margin-top: 2px;
}
.combustible-item-price {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--primary);
}
.combustible-list-item.cheapest .combustible-item-price {
    color: #2ecc71; /* Verde para el m√°s barato */
}
/* --- INICIO: ESTILOS PARA CONTROL DE ORDENACI√ìN DE COMBUSTIBLE --- */
.combustible-sort-controls {
    display: flex;
    justify-content: center;
    padding: 10px;
    gap: 8px;
    border-bottom: 1px solid var(--bg);
}
.sort-btn {
    padding: 8px 16px;
    border: 1px solid var(--muted);
    background-color: transparent;
    color: var(--muted);
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}
.sort-btn.active {
    background-color: var(--primary);
    color: var(--action-text);
    border-color: var(--primary);
}
/* --- FIN: ESTILOS PARA CONTROL DE ORDENACI√ìN --- */
/* --- FIN: ESTILOS PARA LISTA INTELIGENTE --- */
/* --- FIN: ESTILO PARA ESTADO DE CARGA LOCALIZADO --- */
/* --- FIN ESTILOS SPINNER DE PUNTOS --- */
/* --- INICIO ESTILOS GU√çA TV --- */
.guia-tv-container { padding: 10px; max-width: 100%; overflow: hidden; }
.guia-nav { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 8px; }
.guia-nav-btn { background-color: var(--card-bg); color: var(--text); border: 1px solid var(--muted); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; cursor: pointer; white-space: nowrap; }
.guia-nav-btn.active { background-color: var(--primary); color: var(--action-text); border-color: var(--primary); }
.guia-grid-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
.guia-grid { display: grid; grid-template-columns: 100px 1fr; position: relative; }
.guia-channels-col { z-index: 2; position: sticky; left: 0; background: var(--bg); }
.guia-channel-logo-placeholder { height: 60px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--muted); border-bottom: 1px solid #eee; }
.guia-channel-logo { height: 60px; display: flex; align-items: center; justify-content: center; padding: 5px; border-bottom: 1px solid #eee; }
.guia-channel-logo img { max-width: 80%; max-height: 40px; object-fit: contain; }
.guia-timeline-col { min-width: 2880px; /* 48 horas x 60px/hora */ }
.guia-time-header { display: flex; height: 60px; border-bottom: 1px solid #eee; position: relative; }
.guia-time-slot { width: 60px; /* Ancho para 30 minutos */ flex-shrink: 0; text-align: center; padding-top: 20px; color: var(--muted); font-size: 0.9rem; border-left: 1px solid #eee; }
.guia-channel-row { height: 60px; position: relative; border-bottom: 1px solid #eee; background-image: linear-gradient(to right, #eee 1px, transparent 1px); background-size: 60px 100%; }
.guia-program-block { position: absolute; top: 2px; bottom: 2px; background-color: var(--card-bg); border-radius: 6px; padding: 5px 8px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-size: 0.9rem; color: var(--text); border-left: 4px solid var(--primary); cursor: pointer; transition: background-color 0.2s; }
.guia-program-block:hover { background-color: #e9e9e9; }
.guia-program-title { font-weight: 600; }
.guia-program-time { font-size: 0.8rem; color: var(--muted); }
.guia-now-line { position: absolute; top: 0; bottom: 0; width: 2px; background-color: #e74c3c; z-index: 3; pointer-events: none; }
/* --- FIN ESTILOS GU√çA TV --- */  
/* --- INICIO ESTILOS CALENDARIO PROFESIONAL (V2) --- */
.calendar-header-sticky { position: sticky; top: 0; background-color: var(--bg); z-index: 30; padding-top: 10px; margin-bottom: 10px; overflow: visible; }
.calendar-timeline { position: relative; padding-left: 50px; }
.time-slot { height: 60px; border-top: 1px solid var(--muted); position: relative; }
.time-slot::before { content: attr(data-time); position: absolute; left: -50px; top: -10px; color: var(--muted); font-size: 0.8rem; }
.now-line { position: absolute; left: 50px; right: 0; height: 2px; background-color: #e74c3c; z-index: 15; }
.now-line::before { content: ''; position: absolute; left: -5px; top: -4px; width: 12px; height: 12px; background-color: #e74c3c; border-radius: 50%; }
.event-block { position: absolute; background-color: var(--primary); color: var(--action-text); border-radius: 8px; padding: 8px; overflow: hidden; z-index: 10; cursor: pointer; border-left: 5px solid rgba(0,0,0,0.2); box-sizing: border-box !important; }
.event-block-title {
    font-weight: bold;
    font-size: 0.9rem;
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* --- CORRECCI√ìN DEFINITIVA DE MEN√ö Y L√çNEAS --- */
/* Le da al men√∫ la m√°xima prioridad para que siempre est√© visible */
#calendar-view-menu {
    z-index: 100 !important;
}

/* Asegura que la columna de horas tenga la altura m√≠nima correcta */
.calendar-time-col {
    min-height: 1440px; /* 24h * 60px */
}

/* --- NUEVO: Correcci√≥n de posicionamiento del Men√∫ --- */
.list-header .dropdown-menu {
    z-index: 110; /* Asegura que el men√∫ est√© por encima de las cabeceras fijas */
}
.event-block-time { font-size: 0.8rem; opacity: 0.8; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; } /* Ajuste de gap para bordes */
.calendar-day-header { text-align: center; font-weight: bold; padding: 8px 0; font-size: 0.9rem; }
.calendar-day-cell { background: var(--card-bg); border-radius: 8px; min-height: 100px; cursor: pointer; display: flex; flex-direction: column; padding: 4px; border: 1px solid var(--bg); }
.calendar-day-cell.today { border-color: var(--primary); box-shadow: 0 0 5px var(--primary); }
.calendar-day-number { font-weight: bold; text-align: right; font-size: 0.9rem; padding: 4px; }
.month-event-pill { font-size: 0.75rem; padding: 2px 5px; border-radius: 5px; margin: 1px 2px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; color: var(--action-text); }
.week-view-col { display: flex; flex-direction: column; }
.week-view-timeline { flex-grow: 1; position: relative; border-left: 1px solid var(--bg); min-height: 500px; }
/* --- FIN ESTILOS CALENDARIO PROFESIONAL (V2) --- */
/* --- INICIO ESTILOS CALENDARIO (V3 - ESTILO GOOGLE CALENDAR) --- */

/* Contenedor principal para la vista mensual */
.calendar-month-container {
    /* Este contenedor ahora solo agrupa */
}

/* Cabecera de los d√≠as de la semana (Lun, Mar...) */
.calendar-month-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    position: sticky;
    top: 135px; /* Se pega debajo de los controles de navegaci√≥n */
    z-index: 10;
    
    /* Efecto de borde sutil usando el fondo y el gap */
    background-color: var(--muted); 
    gap: 1px;
    border: 1px solid var(--muted);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    overflow: hidden; /* Asegura que el borde redondeado se aplique a las celdas */
}

/* Celda individual de la cabecera */
.calendar-month-header .calendar-day-header {
    padding: 10px 0;
    font-size: 0.8rem;
    font-weight: 500;
    background-color: var(--card-bg);
    text-align: center;
}

/* Cuadr√≠cula principal de los d√≠as del mes */
.calendar-month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    /* ¬°CLAVE! Todas las filas tendr√°n la misma altura m√≠nima pero pueden crecer */
    grid-auto-rows: minmax(100px, auto); 
    gap: 1px;
    background-color: var(--muted);
    border: 1px solid var(--muted);
    border-top: none;
}

/* Celda de un d√≠a individual */
.calendar-day-cell {
    background: var(--card-bg);
    padding: 4px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    cursor: pointer;
    border: none;
    border-radius: 0;
    min-height: auto;
    transition: background-color 0.2s; /* Efecto suave al pasar el rat√≥n */
}
.calendar-day-cell:not(.empty):hover {
    background-color: #f0f0f0; /* Un color sutil para el hover, solo en celdas con d√≠a */
}

/* N√∫mero del d√≠a dentro de la celda */
.calendar-day-number {
    font-weight: 500;
    text-align: center; /* Centrado como en la imagen */
    font-size: 0.9rem;
    padding: 4px;
    width: 26px; /* Ancho y alto para formar un c√≠rculo */
    height: 26px;
    line-height: 18px; /* Ajuste para centrar el n√∫mero verticalmente */
    border-radius: 50%; /* Lo hace circular */
    margin: 0 auto 4px auto; /* Centra el c√≠rculo horizontalmente */
    transition: background-color 0.2s, color 0.2s;
}

/* Estilo para el d√≠a de HOY */
.calendar-day-cell.today .calendar-day-number {
    background-color: var(--primary); /* Fondo azul */
    color: var(--action-text); /* Texto blanco */
    font-weight: bold;
}

/* "Pastilla" para un evento */
.month-event-pill {
    font-size: 0.75rem;
    padding: 3px 6px;
    border-radius: 4px; /* Bordes menos redondeados, m√°s profesional */
    margin: 1px 2px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    color: var(--action-text);
    font-weight: 500;
}

/* Contenedor para las pastillas dentro de una celda */
.month-events-container {
    display: flex;
    flex-direction: column;
    gap: 2px; /* Peque√±o espacio entre pastillas */
}

/* --- FIN ESTILOS CALENDARIO (V3 - ESTILO GOOGLE CALENDAR) --- */
/* --- INICIO: NUEVA ARQUITECTURA VISUAL CALENDARIO (ESTILO GOOGLE CALENDAR) --- */
.calendar-grid-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 185px); /* Altura din√°mica para ocupar el espacio disponible */
    border: 1px solid var(--muted);
    border-radius: 8px;
    overflow: hidden; /* Clave para que el borde redondeado afecte a todo */
}

/* 1. Cabecera de D√≠as (Lun 15, Mar 16...) */
.calendar-header {
    display: grid;
    flex-shrink: 0; /* No se encoge */
    position: sticky;
    top: 0;
    z-index: 20; /* Por encima del cuerpo */
    background-color: var(--muted);
    gap: 1px;
    border-bottom: 1px solid var(--muted);
}

.calendar-header .day-label {
    background-color: var(--card-bg);
    text-align: center;
    padding: 6px 4px;
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.day-label .day-number-circle {
    font-size: 0.9rem; /* Un poco m√°s grande para el n√∫mero */
    font-weight: 500;
    width: 24px;
    height: 24px;
    line-height: 24px;
    border-radius: 50%;
    margin-top: 2px;
}
.day-label.today .day-number-circle {
    background-color: var(--primary);
    color: var(--action-text);
    font-weight: bold;
}

/* 2. Cabecera "Todo el D√≠a" */
.calendar-all-day-header {
    display: grid;
    flex-shrink: 0;
    position: sticky;
    top: 40px; /* Se pega justo debajo de la cabecera de d√≠as (ajustar si cambia la altura) */
    z-index: 20;
    background-color: var(--muted);
    gap: 1px;
    border-bottom: 1px solid var(--muted);
}

.all-day-label {
    background-color: var(--card-bg);
    font-size: 0.8rem;
    color: var(--muted);
    text-align: right;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

.all-day-slot {
    background-color: var(--card-bg);
    min-height: 28px;
    padding: 2px;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* 3. Cuerpo Deslizable (Contiene horas y eventos) */
.calendar-scroll-body {
    flex-grow: 1; /* Ocupa todo el espacio restante */
    display: flex;
    overflow: auto; /* PERMITE EL SCROLL */
    position: relative;
}

/* 4. Columna de Horas (a la izquierda) */
.calendar-time-col {
    width: 50px;
    flex-shrink: 0;
    background-color: var(--card-bg);
    position: sticky;
    left: 0;
    z-index: 10;
}

.calendar-time-slot {
    height: 60px;
    position: relative;
    font-size: 0.8rem;
    color: var(--muted);
    text-align: right;
    padding-right: 5px;
}
.calendar-time-slot span {
    position: relative;
    top: -9px;
    /* Mejora para modo oscuro: el texto de las horas siempre es legible */
    color: var(--text);
    opacity: 0.7;
}

/* 5. Cuadr√≠cula de Eventos (el fondo donde se dibujan las l√≠neas) */
.calendar-events-grid {
    display: grid;
    gap: 0;
    flex-grow: 1;
    /* La l√≠nea min-width: 650px; se ha eliminado para corregir el c√°lculo del ancho del evento */
}
.calendar-events-grid.three-day {
    min-width: auto; /* La vista 3 d√≠as no necesita scroll H */
}

/* Columna individual de un d√≠a */
.calendar-day-col {
    position: relative;
    background-color: var(--card-bg);
    /* L√çNEAS HORIZONTALES (sutiles y adaptables a temas) */
    background-image: linear-gradient(to bottom, transparent 59px, rgba(128, 128, 128, 0.2) 1px);
    background-size: 100% 60px;
    min-height: 1440px; /* 24h * 60px */
    /* L√çNEAS VERTICALES (sutiles y adaptables a temas) */
    border-left: 1px solid rgba(128, 128, 128, 0.2);
}

/* 6. Mejoras Adicionales y Correcciones */
.dropdown-item.active {
    background-color: var(--primary) !important;
    color: var(--action-text) !important;
    font-weight: bold;
}

.floating-action-button {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    background-color: var(--primary);
    color: var(--action-text);
    border-radius: 16px; /* Bordes redondeados como en la referencia */
    border: none;
    font-size: 28px;
    line-height: 56px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 1050;
    transition: transform 0.2s, border-radius 0.2s ease-out;
}
.floating-action-button:hover {
    transform: scale(1.05);
    border-radius: 50%; /* Efecto suave al pasar el rat√≥n */
}
/* --- FIN: NUEVA ARQUITECTURA VISUAL CALENDARIO --- */
/* --- INICIO: ESTILOS PARA MODAL Y CONTROLES PERSONALIZADOS --- */
.custom-dropdown {
    position: relative;
    width: 100%;
}
.custom-dropdown-selected {
    display: flex;
    align-items: center;
    background-color: var(--bg);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
}
.color-swatch {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 12px;
    flex-shrink: 0;
}
.custom-dropdown-options {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background-color: var(--card-bg);
    border: 1px solid var(--muted);
    border-radius: 8px;
    margin-top: 4px;
    z-index: 1200;
    max-height: 200px;
    overflow-y: auto;
}
.custom-dropdown-item {
    display: flex;
    align-items: center;
    padding: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.custom-dropdown-item:hover {
    background-color: var(--bg);
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    z-index: 1500;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none; /* No interactuable por defecto */
}
.modal-overlay.show {
    opacity: 1;
    pointer-events: auto; /* Interactuable cuando es visible */
}
.modal-content {
    background-color: var(--card-bg);
    width: 100%;
    max-width: 480px;
    padding: 20px;
    border-radius: 16px 16px 0 0;
    transform: translateY(100%);
    transition: transform 0.3s ease-out;
}
.modal-overlay.show .modal-content {
    transform: translateY(0);
}
.modal-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: left;
}
.preset-list-item {
    display: flex;
    align-items: center;
    padding: 12px 5px;
    cursor: pointer;
    font-size: 1rem;
}
.preset-list-item input[type="radio"] {
    width: 20px;
    height: 20px;
    margin-right: 15px;
}
.notification-chip {
    display: inline-flex;
    align-items: center;
    background-color: var(--bg);
    border: 1px solid var(--muted);
    border-radius: 16px;
    padding: 6px 10px;
    font-size: 0.9rem;
    margin: 4px;
}
.notification-chip-remove {
    margin-left: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1rem;
    line-height: 1;
}
#notification-chips-container {
    margin-top: 10px;
    padding: 5px;
    border: 1px dashed var(--muted);
    border-radius: 8px;
    min-height: 40px;
}
/* --- INICIO: Estilos para botones de modal modernos --- */
.modal-btn {
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.modal-btn:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}
.modal-btn-primary {
    background-color: #2980b9; /* Azul brillante */
    color: white;
}
.modal-btn-secondary {
    background-color: #f1f3f4; /* Gris claro sutil */
    color: #3c4043;
}
/* --- FIN: Estilos para botones de modal modernos --- */
/* --- FIN: ESTILOS PARA MODAL Y CONTROLES PERSONALIZADOS --- */
/* --- INICIO: Estilos para el Modal de Changelog --- */
.changelog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 9998; /* Justo debajo del splash screen */
    display: none; /* Oculto por defecto */
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.changelog-overlay.show {
    display: flex;
    opacity: 1;
}
.changelog-modal {
    background-color: var(--card-bg);
    color: var(--text);
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    transform: scale(0.95);
    transition: transform 0.3s ease;
}
.changelog-overlay.show .changelog-modal {
    transform: scale(1);
}
.changelog-modal h2 {
    font-size: 1.4rem;
    margin: 0 0 15px 0;
    text-align: center;
}
.changelog-modal-content {
    overflow-y: auto; /* Scroll si el contenido es muy largo */
    flex-grow: 1;
    margin-bottom: 20px;
}
.changelog-modal-content ul {
    list-style: none;
    padding-left: 5px;
}
.changelog-modal-content li {
    margin-bottom: 10px;
    line-height: 1.5;
    display: flex;
    align-items: flex-start;
}
.changelog-modal-content li::before {
    content: '‚úÖ';
    color: var(--primary);
    margin-right: 10px;
    font-size: 1rem;
}
.changelog-modal .button-group {
    margin-top: 0; /* Anulamos el margen superior del button-group */
}
/* --- FIN: Estilos para el Modal de Changelog --- */
/* --- INICIO: Estilos para Botones de Calendario Personalizados --- */
.flatpickr-calendar .fp-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 8px;
    border-top: 1px solid var(--bg);
    background-color: var(--card-bg);
}
.flatpickr-calendar .fp-button {
    background-color: transparent;
    border: 1px solid var(--muted);
    color: var(--text);
    border-radius: 5px;
    padding: 6px 12px;
    font-weight: 500;
    cursor: pointer;
}
.flatpickr-calendar .fp-button.fp-confirm-btn {
    background-color: var(--primary);
    color: var(--action-text);
    border-color: var(--primary);
}
.dark-theme .fp-buttons {
    border-top-color: var(--muted);
}
/* --- FIN: Estilos para Botones --- */

/* --- INICIO: CORRECCI√ìN DE VISIBILIDAD DE BOTONES DE CALENDARIO --- */
	.flatpickr-calendar {
    z-index: 9999 !important; /* Asegura que el calendario flote por encima de todo */
}
/* --- FIN: CORRECCI√ìN --- */

/* --- INICIO: ESTILOS PARA MODAL DE UBICACI√ìN Y MAPA AMPLIABLE --- */
.fuel-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    z-index: 2100; /* Prioridad alta */
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.fuel-modal-overlay.show {
    display: flex;
    opacity: 1;
}
.fuel-modal-content {
    background-color: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    transform: scale(0.95);
    transition: transform 0.3s ease;
}
.fuel-modal-overlay.show .fuel-modal-content {
    transform: scale(1);
}
.fuel-modal-checkbox-container {
    display: flex;
    align-items: center;
    margin-top: 20px;
    padding: 10px;
    background-color: var(--bg);
    border-radius: 8px;
    cursor: pointer;
}
.fuel-modal-checkbox-container input {
    width: 18px;
    height: 18px;
    margin-right: 12px;
}
.map-fullscreen-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg);
    z-index: 2050; /* Prioridad muy alta */
    display: none; /* Oculto por defecto */
    flex-direction: column;
}
.map-fullscreen-header {
    flex-shrink: 0;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--muted);
}
#fullscreen-map-container {
    flex-grow: 1;
    width: 100%;
    height: 100%;
}
.map-expand-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 401; /* Justo encima del mapa */
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid var(--muted);
    border-radius: 8px;
    width: 36px;
    height: 36px;
    cursor: pointer;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
/* --- FIN: ESTILOS PARA MODAL DE UBICACI√ìN Y MAPA AMPLIABLE --- */
  </style>

</head>
<body>
  <!-- --- INICIO SPLASH SCREEN --- -->
	<div id="splash-screen" class="splash-screen">
        <div class="dot-spinner">
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
            <div class="dot-spinner__dot"></div>
        </div>
        <div class="splash-text">Cargando tu asistente...</div>
	</div>
<!-- --- FIN SPLASH SCREEN --- -->
<!-- --- INICIO MODAL DE CHANGELOG --- -->
<div class="changelog-overlay" id="changelog-overlay">
    <div class="changelog-modal">
        <h2 id="changelog-title">¬°Novedades en la Versi√≥n <span id="changelog-version"></span>!</h2>
        <div class="changelog-modal-content">
            <ul id="changelog-content">
                <!-- El contenido se insertar√° aqu√≠ con JS -->
            </ul>
        </div>
        <div class="button-group">
            <button id="changelog-continue-btn" class="enabled" style="width:100%;">Continuar</button>
        </div>
    </div>
</div>
<!-- --- FIN MODAL DE CHANGELOG --- -->
  <div id="spinner" style="display: none;">
    <div class="dot-spinner">
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
    </div>
</div>
  <div id="main-content-area">
  </div>
  <div id="toast" class="toast"></div>
  </div>
    <div class="tabs">
    <div class="tab active" id="tab-home">üè† Home</div>
    <div class="tab" id="tab-export">üìä Exportar Gastos</div>
    <div class="tab" id="tab-settings">‚öôÔ∏è Ajustes</div>
  </div>
  <div id="image-preview-overlay" style="display: none;">
    <img id="image-preview-element" src="" alt="Vista previa del ticket" />
    <div id="image-preview-actions">
        <button id="preview-cancel-btn">Cancelar</button>
        <button id="preview-send-btn">Enviar</button>
    </div>
  </div>
  <!-- INICIO MODAL DE PREVISUALIZACI√ìN EXCLUSIVO PARA CHEF -->
  <div id="chef-image-preview-overlay" style="display: none;">
    <img id="chef-image-preview-element" src="" alt="Vista previa de ingredientes" />
    <div id="image-preview-actions">
        <button id="chef-preview-cancel-btn">Cancelar</button>
        <button id="chef-preview-send-btn">Usar esta Foto</button>
    </div>
  </div>
  <!-- FIN MODAL DE PREVISUALIZACI√ìN EXCLUSIVO PARA CHEF -->
<!-- INICIO MODAL DE NOTIFICACIONES -->
<div class="modal-overlay" id="notification-modal" style="display: none;">
    <div class="modal-content">
        <!-- Vista de Presets (inicial) -->
        <div id="notification-presets-view">
            <h3 class="modal-title">A√±adir notificaci√≥n</h3>
            <div id="notification-presets-list">
                <!-- Los presets se generar√°n con JS -->
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button id="notification-modal-cancel" class="cancel">Cancelar</button>
            </div>
        </div>
        <!-- Vista Personalizada (oculta por defecto) -->
        <div id="notification-custom-view" style="display: none;">
            <h3 class="modal-title">Notificaci√≥n personalizada</h3>
            
            <input type="number" id="custom-notification-value" placeholder="10" value="10" min="1" style="margin-bottom: 15px; text-align: center; font-size: 1.2rem;">
            
            <label class="preset-list-item">
                <input type="radio" name="custom_unit" value="minutes" checked>
                <span>Minutos antes</span>
            </label>
            <label class="preset-list-item">
                <input type="radio" name="custom_unit" value="hours">
                <span>Horas antes</span>
            </label>
            <label class="preset-list-item">
                <input type="radio" name="custom_unit" value="days">
                <span>D√≠as antes</span>
            </label>
            
            <hr style="margin: 15px 0; border-top: 1px solid var(--muted);">

            <label class="preset-list-item">
                <input type="radio" name="custom_method" value="telegram" checked>
                <span>En una notificaci√≥n</span>
            </label>
            <label class="preset-list-item">
                <input type="radio" name="custom_method" value="email">
                <span>En un correo</span>
            </label>
            
            <div class="button-group" style="margin-top: 20px;">
                <button id="custom-notification-back" class="cancel">Cancelar</button>
                <button id="custom-notification-done" class="enabled">Hecho</button>
            </div>
        </div>
    </div>
</div>
<!-- FIN MODAL DE NOTIFICACIONES -->

<!-- INICIO MODAL AVISO UBICACI√ìN COMBUSTIBLE -->
<div class="fuel-modal-overlay" id="fuel-location-modal">
    <div class="fuel-modal-content">
        <h3>Activa tu Ubicaci√≥n</h3>
        <p style="line-height: 1.5; color: var(--muted); margin-top: 10px;">
            Para buscar, aseg√∫rate de tener activado el GPS o los servicios de ubicaci√≥n en los ajustes de tu m√≥vil y concede el permiso cuando se te pida.
        </p>
        <div class="fuel-modal-checkbox-container" onclick="document.getElementById('fuel-modal-checkbox').click();">
            <input type="checkbox" id="fuel-modal-checkbox">
            <label for="fuel-modal-checkbox">No volver a mostrar este aviso</label>
        </div>
        <div class="button-group" style="margin-top: 20px;">
            <button id="fuel-modal-cancel" class="cancel">Cancelar</button>
            <button id="fuel-modal-continue" class="enabled">Continuar</button>
        </div>
    </div>
</div>
<!-- FIN MODAL AVISO UBICACI√ìN COMBUSTIBLE -->
<!-- INICIO MODAL AVISO UBICACI√ìN EMERGENCIAS -->
<div class="fuel-modal-overlay" id="emergency-location-modal">
    <div class="fuel-modal-content">
        <h3>Permiso de Ubicaci√≥n</h3>
        <p style="line-height: 1.5; color: var(--muted); margin-top: 10px;">
            Para realizar una b√∫squeda de emergencia, necesitamos acceder a tu ubicaci√≥n. Por favor, activa el GPS y concede el permiso cuando se te pida.
        </p>
        <div class="fuel-modal-checkbox-container" onclick="document.getElementById('emergency-modal-checkbox').click();">
            <input type="checkbox" id="emergency-modal-checkbox">
            <label for="emergency-modal-checkbox">No volver a mostrar este aviso</label>
        </div>
        <div class="button-group" style="margin-top: 20px;">
            <button id="emergency-modal-cancel" class="cancel">Cancelar</button>
            <button id="emergency-modal-continue" class="enabled">Continuar</button>
        </div>
    </div>
</div>
<!-- FIN MODAL AVISO UBICACI√ìN EMERGENCIAS -->

<!-- INICIO VISTA MAPA PANTALLA COMPLETA -->
<div class="map-fullscreen-overlay" id="map-fullscreen-view">
    <div class="map-fullscreen-header">
        <h3 id="fullscreen-map-title" style="margin: 0;">Gasolineras Cercanas</h3>
        <button id="map-close-fullscreen-btn" class="back-btn" style="font-size: 1.5rem; padding: 5px;">‚úñ</button>
    </div>
    <div id="fullscreen-map-container"></div>
</div>
<!-- FIN VISTA MAPA PANTALLA COMPLETA -->
  
<script>
    document.addEventListener('DOMContentLoaded', () => {
	let appData = { 
    counts: { // Inicializar contadores con valores por defecto
        remindersCount: 0, 
        shoppingPendingCount: 0, 
        shoppingBoughtCount: 0, 
        notesCount: 0, 
        calendarTodayCount: 0, 
        gastosMesActual: '0,00', 
        mesesActivosGastos: [],
        cuentasClarasCount: 0 // <-- CONTADOR A√ëADIDO
    },
    remindersList: [], 
    shoppingList: [], 
    notesList: [], 
    calendarEvents: [], 
    settings: {}, 
    isPremium: false 
};
let initialUserSettings = {};
let secondaryDataPromise = null;
const mainContentArea = document.getElementById('main-content-area');
const spinner = document.getElementById('spinner');
	// --- INICIALIZACI√ìN GLOBAL DE FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCCz7-d3dX2uw_sF4swtmNY0zXScphxkZk",
  authDomain: "asistentepersonal-4ad2b.firebaseapp.com",
  projectId: "asistentepersonal-4ad2b",
  storageBucket: "asistentepersonal-4ad2b.firebasestorage.app",
  messagingSenderId: "1068752893536",
  appId: "1:1068752893536:web:4654f215bc2676b68bf505",
  measurementId: "G-XWEJS9BMFY"
};

if (typeof firebase !== 'undefined' && !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
}
// --- FIN DE INICIALIZACI√ìN ---
	
	
    
// =========================================================================
// --- NUEVA L√ìGICA DE ARRANQUE (FIRESTORE FIRST) ---
// =========================================================================
// La constante HTML_VERSION se elimina. La versi√≥n ahora se gestiona desde Firestore.

// --- FUNCI√ìN DE ARRANQUE MODIFICADA (SOLO VERIFICA VERSI√ìN) ---
// --- INICIALIZACI√ìN GLOBAL DE FIREBASE ---
// Esta secci√≥n ahora se ejecuta siempre, garantizando que 'db' exista.
if (typeof firebaseConfig !== 'undefined' && !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
}

// --- FUNCI√ìN DE ARRANQUE SIMPLIFICADA ---
async function initializeApp() {
    if (isInitializing) return;
    isInitializing = true;
    
    // Ahora esta funci√≥n solo se preocupa de ejecutar la l√≥gica principal.
    loadEmojiDictionary();
    runApp(); 
}

// --- FUNCI√ìN QUE CONTIENE LA L√ìGICA PRINCIPAL DE LA APP ---
// --- NUEVA FUNCI√ìN PARA ACTUALIZAR EL LISTENER DEL BADGE DEL CALENDARIO ---
let unsubscribeCalendarBadge = null; // Guardi√°n para el listener
let listeningDate = null; // Para saber para qu√© d√≠a estamos escuchando

function updateCalendarBadgeListener() {
    const today = new Date();
    const todayString = today.toDateString(); // "Mon Oct 23 2025"

    // Si ya estamos escuchando para el d√≠a de hoy, no hacemos nada.
    if (listeningDate === todayString) {
        return;
    }

    // Si hay un listener antiguo, lo desconectamos.
    if (unsubscribeCalendarBadge) {
        unsubscribeCalendarBadge();
    }

    console.log(`[Badge Calendario] Estableciendo nuevo listener para: ${todayString}`);
    listeningDate = todayString;

    const startOfToday = new Date(today.setHours(0, 0, 0, 0));
    const endOfToday = new Date(today.setHours(23, 59, 59, 999));

    const startOfTodayTimestamp = firebase.firestore.Timestamp.fromDate(startOfToday);
    const endOfTodayTimestamp = firebase.firestore.Timestamp.fromDate(endOfToday);

    const query = db.collection('users').doc(chatId).collection('eventos_calendario')
        .where('fechaInicio', '>=', startOfTodayTimestamp)
        .where('fechaInicio', '<=', endOfTodayTimestamp);

    unsubscribeCalendarBadge = query.onSnapshot(snapshot => {
    const newCount = snapshot.size;
    const oldCount = appData.counts.calendarTodayCount;

    // 1. Actualizamos siempre la UI y los datos locales.
    appData.counts.calendarTodayCount = newCount;
    const calendarBadge = document.getElementById('calendar-badge');
    if (calendarBadge) {
        calendarBadge.textContent = newCount;
    }

    // 2. Sincronizamos con Firestore SOLO si el valor ha cambiado.
    if (newCount !== oldCount) {
        console.log(`[Badge Sync] El contador ha cambiado. Sincronizando con Firestore. Viejo: ${oldCount}, Nuevo: ${newCount}`);
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        
        // Actualizamos el documento en segundo plano.
        countsRef.update({
            calendarTodayCount: newCount
        }).catch(err => {
            // Este error no es cr√≠tico para el usuario, solo lo registramos.
            console.error("Error al sincronizar el contador del badge con Firestore:", err);
        });
    }
}, error => {
    console.error("Error en listener de eventos de hoy:", error);
});
}
async function runApp() {
    try {
        console.log("‚ñ∂Ô∏è [Arranque] runApp iniciado. Configurando oyentes en tiempo real...");
        // 1. Obtener los ajustes del usuario (sin cambios)
        const userSettingsDoc = await db.collection('users').doc(chatId).get();
if (!userSettingsDoc.exists) {
    failApp("Usuario no encontrado.<br><small>Contacta con soporte.</small>");
    return;
}
appData.settings = userSettingsDoc.data() || {};

// L√≥gica de tema simplificada
	const userConfig = appData.settings.configuracion || {};
	applyTheme(userConfig.tema || 'auto');

		appData.isPremium = appData.settings.plan_premium === true;
        console.log(`[App Flow] runApp ejecutado. Contadores iniciales:`, JSON.parse(JSON.stringify(appData.counts)));

        // 2. Configurar el listener √öNICO para contadores
        db.collection('users').doc(chatId).collection('_metadata').doc('counts')
            .onSnapshot(async (doc) => {
                if (doc.exists) {
                    // Caso 1: El documento existe. Actualizamos los datos locales.
                    appData.counts = { ...appData.counts, ...doc.data() };

                    // ¬°Paso Clave! Siempre que recibimos datos, redibujamos el dashboard
                    // si es la vista activa. Esto cubre la carga inicial y las actualizaciones.
                    if (document.querySelector('.grid')) {
                        renderDashboard();
                    }
                    console.log("üèÅ [Listener] Contadores sincronizados. UI actualizada.");

                } else {
                    // Caso 2: El documento NO existe (usuario nuevo). Lo creamos.
                    console.log("Documento 'counts' no existe. Creando estructura inicial completa...");
                    const now = new Date();
                    const mesAnioActual = `${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
                    
                    // Definimos la estructura completa, incluyendo el caso especial de gastos.
                    const contadoresIniciales = {
                        gastosMesActual: 0,
                        mesesActivosGastos: [mesAnioActual],
                        remindersCount: 0,
                        shoppingPendingCount: 0,
                        shoppingBoughtCount: 0,
                        notesCount: 0,
                        calendarTodayCount: 0,
                        cuentasClarasCount: 0
                    };
                    
                    // Guardamos la estructura inicial. Esto disparar√° de nuevo el onSnapshot,
                    // que entrar√° en el bloque `if (doc.exists)` y renderizar√° la UI.
                    await db.collection('users').doc(chatId).collection('_metadata').doc('counts').set(contadoresIniciales, { merge: true });
                }
            }, (error) => {
                console.error("Error en el listener de contadores: ", error);
            });

        updateCalendarBadgeListener(); // Llamada inicial al arrancar la app.
        
        // 4. Dibujar la UI con los datos ya cargados (sin cambios)
        renderDashboard();
        isAppReady = true;
		// --- INICIO: Listener para re-verificar versi√≥n y contadores al reanudar la app ---
if (tg) {
    tg.onEvent('viewportChanged', (event) => {
        if (event.isStateStable) {
            console.log("[Reanudaci√≥n] Vista estable, re-verificando servicios...");
            performVersionCheck(true); // Re-verifica la versi√≥n

            // --- INICIO: L√ìGICA DE SINCRONIZACI√ìN DE AJUSTES Y TEMA A√ëADIDA ---
            if (chatId) {
                db.collection('users').doc(chatId).get().then(doc => {
                    if (doc.exists) {
                        const newSettings = doc.data();
                        Object.assign(appData.settings, newSettings); // Fusiona los ajustes
                        const userConfig = appData.settings.configuracion || {};
                        applyTheme(userConfig.tema || 'auto'); // Re-aplica el tema
                        console.log("[Reanudaci√≥n] Ajustes y tema sincronizados desde Firestore.");
                    }
                }).catch(error => {
                    console.error("Error al sincronizar ajustes al reanudar:", error);
                });
            }
            // --- FIN: L√ìGICA DE SINCRONIZACI√ìN ---

			syncShoppingCounts(); // ¬°NUEVO! Sincroniza los contadores de la compra
			updateCalendarBadgeListener(); // Re-verifica el badge del calendario
        }
    });
}
// --- FIN: Listener para re-verificar versi√≥n y contadores ---
		hideSplashScreen();
        
    } catch (err) {
        console.error("Error cr√≠tico en runApp:", err);
        showToast(`Error al cargar datos de usuario: ${err.message}`, true);
        mainContentArea.innerHTML = `<div class="no-data-msg">üîå<br>Error de conexi√≥n.<br><small>Int√©ntalo de nuevo m√°s tarde.</small></div>`;
        hideSplashScreen();
    } finally {
        isInitializing = false;
    }
}

function hideSplashScreen() {
    const splash = document.getElementById('splash-screen');
    if (splash) {
        splash.classList.add('hidden');
        // Opcional: eliminar el splash del DOM despu√©s de la transici√≥n para liberar memoria.
        setTimeout(() => {
            if (splash.parentNode) {
                splash.parentNode.removeChild(splash);
            }
        }, 600); // Debe coincidir con la duraci√≥n de la transici√≥n en el CSS.
    }
}
function showChangelogModal(version, changelogText) {
    const overlay = document.getElementById('changelog-overlay');
    const versionSpan = document.getElementById('changelog-version');
    const contentUl = document.getElementById('changelog-content');
    const continueBtn = document.getElementById('changelog-continue-btn');
	hideSplashScreen();

    // Si los elementos no se encuentran por alguna raz√≥n, simplemente no mostramos el modal
    // y lo reportamos en la consola, evitando la recarga.
    if (!overlay || !versionSpan || !contentUl || !continueBtn) {
        console.error("No se encontraron los elementos del modal de changelog. La actualizaci√≥n no se puede mostrar visualmente.");
        return; // Detenemos la funci√≥n para evitar errores.
    }

    // Llenamos el modal con los datos de Firestore
    versionSpan.textContent = version;
    contentUl.innerHTML = changelogText
        .split('*')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => `<li>${line}</li>`)
        .join('');

    // Definimos la acci√≥n del bot√≥n con la l√≥gica de localStorage y recarga forzada
    continueBtn.onclick = () => {
        overlay.classList.remove('show');
        setTimeout(() => {
            showToast("Aplicando actualizaci√≥n...", false);
            // 1. Guardamos la nueva versi√≥n en el almacenamiento local.
            localStorage.setItem('app_version', version);
            // 2. Forzamos una recarga completa para obtener el nuevo HTML.
            window.location.href = window.location.pathname + '?v=' + new Date().getTime();
        }, 300);
    };

    // Mostramos el modal
    overlay.classList.add('show');
}

// --- SISTEMA DE NAVEGACI√ìN (HISTORIAL) ---
let navigationHistory = [];

function goBack() {
	destroyActiveFlatpickr();
    if (navigationHistory.length > 0) {
        const previousStep = navigationHistory.pop();
        if (typeof previousStep === 'function') {
            previousStep();
        }
    }
    updateBackButton();
}

function updateBackButton() {
    if (!tg || !tg.BackButton) return;
    if (tg.isVersionAtLeast('6.1') && tg.BackButton) {
        if (navigationHistory.length > 0) {
            tg.BackButton.show();
        } else {
            tg.BackButton.hide();
        }
    }
}

const tg = window.Telegram?.WebApp;
// --- VARIABLES GLOBALES PARA EMOJIS ---
let emojiDictionary = [];
const EMOJIS_DB_FILENAME = 'https://asistentepersonal-4ad2b.web.app/emoji-articulos-v1.json'; // Nombre del archivo JSON
// ---

// Variable "guardi√°n" para asegurar una √∫nica ejecuci√≥n
let versionCheckPerformed = false;
let selectedImageFile = null;
let chatId;

// --- LISTA BLANCA DE USUARIOS AUTORIZADOS (SOLO PARA DESARROLLO) ---
const authorizedUsers = ["6840956330", "7200016", "8004110685"];

// Funci√≥n auxiliar para gestionar el error de forma centralizada
function failApp(message, canClose = false) {
    document.body.innerHTML = `<div class="no-data-msg">‚ùå<br>${message}</div>`;
    if (canClose && tg && tg.close) {
        setTimeout(() => tg.close(), 2500);
    }
    throw new Error(message);
}

// --- Flujo de inicializaci√≥n que SOLO PREPARA la app ---
const startApp = () => {
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
        chatId = tg.initDataUnsafe.user.id.toString();
        console.log("Chat ID obtenido de Telegram:", chatId);
    } else {
        if (window.location.href.includes("github.io") || window.location.href.includes("file://")) {
            chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', '6840956330');
            if (!chatId) {
                failApp("Chat ID no proporcionado en modo de desarrollo.");
            }
            console.log("Chat ID obtenido por prompt (desarrollo):", chatId);
        } else {
            failApp("Error: No se pudo obtener tu ID de Telegram.", true);
        }
    }

    if (!chatId || chatId.trim() === '') {
        failApp("El ID de Chat obtenido no es v√°lido.");
    }

    (async () => {
        if (authorizedUsers.includes(chatId)) {
            console.log("Acceso de desarrollador concedido.");
            return;
        }
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore();
            }
            const userDoc = await db.collection('users').doc(chatId).get();
            if (!userDoc.exists || userDoc.data().activo !== true) {
                failApp("Tu cuenta no se encuentra activa.<br><small>Por favor, contacta con soporte.</small>", true);
            }
        } catch (error) {
            console.error("Error al verificar el estado del usuario:", error);
            failApp("Error al verificar tu cuenta.<br><small>Int√©ntalo de nuevo m√°s tarde.</small>", true);
        }
    })();
};

// --- PUNTO DE ENTRADA DEFINITIVO Y ROBUSTO ---
// --- PUNTO DE ENTRADA DEFINITIVO Y ROBUSTO ---
function bootstrapApp() {
    // Esta funci√≥n solo se ejecuta una vez gracias al guardi√°n
    if (versionCheckPerformed) return;
    versionCheckPerformed = true;

    // Prepara la app (obtiene chatId, etc.), esto es r√°pido.
    startApp();
    
    // Inmediatamente despu√©s de preparar la app, verificamos la versi√≥n.
    checkVersionAndBootstrap();
}

if (tg) {
    tg.expand();
    if (tg.isVersionAtLeast('6.1') && tg.BackButton) {
        tg.BackButton.onClick(goBack);
    }

    // Definimos una funci√≥n manejadora que se auto-eliminar√°
    const onViewportStable = (event) => {
        if (event.isStateStable) {
            // Una vez que el estado es estable, quitamos el listener
            tg.offEvent('viewportChanged', onViewportStable);
            // Y arrancamos la aplicaci√≥n
            bootstrapApp();
        }
    };

    tg.ready();

    if (tg.isExpanded) {
        console.log("[Arranque R√°pido] La app ya est√° expandida. Iniciando...");
        bootstrapApp();
    } else {
        console.log("[Arranque Est√°ndar] Esperando a que la vista se estabilice...");
        tg.onEvent('viewportChanged', onViewportStable);
    }

} else {
    // Fallback para desarrollo fuera de un entorno Telegram.
    console.log("[Arranque Fallback] Entorno no-Telegram detectado.");
    bootstrapApp();
}


function showSpinner(message = '') { 
    spinner.innerHTML = message ? `<div style="color:var(--text); margin-top:50px; font-size:1rem;">${message}</div>` : ''; 
    spinner.style.display = 'block'; 
}
async function loadEmojiDictionary() {
    // 1. Definimos los nombres de las claves que usaremos en el localStorage.
    const EMOJI_DATA_CACHE_KEY = 'emoji_dictionary_data';
    const EMOJI_VERSION_CACHE_KEY = 'emoji_dictionary_version';

    try {
        // 2. Obtenemos la versi√≥n m√°s reciente del diccionario desde Firestore.
        const versionDoc = await db.collection('app_config').doc('version_info').get();
        const serverVersion = versionDoc.exists ? (versionDoc.data().emoji_dictionary_version || 1) : 1;

        // 3. Obtenemos la versi√≥n y los datos que el usuario tiene guardados localmente.
        const localVersion = parseInt(localStorage.getItem(EMOJI_VERSION_CACHE_KEY) || '0', 10);
        const cachedData = localStorage.getItem(EMOJI_DATA_CACHE_KEY);

        // 4. Comparamos. Descargamos solo si la versi√≥n del servidor es m√°s nueva O si no hay datos en cach√©.
        if (serverVersion > localVersion || !cachedData) {
            console.log(`[Emoji] Actualizando diccionario. Servidor: v${serverVersion}, Local: v${localVersion}`);
            
            const response = await fetch(EMOJIS_DB_FILENAME);
            if (!response.ok) throw new Error(`Error HTTP al descargar diccionario: ${response.status}`);
            
            const data = await response.json();
            emojiDictionary = data;

            // 5. Guardamos los nuevos datos Y la nueva versi√≥n en el localStorage.
            localStorage.setItem(EMOJI_DATA_CACHE_KEY, JSON.stringify(data));
            localStorage.setItem(EMOJI_VERSION_CACHE_KEY, serverVersion.toString());

        } else {
            // Si las versiones coinciden y hay datos, cargamos desde la cach√© local.
            console.log(`[Emoji] Diccionario local (v${localVersion}) est√° actualizado.`);
            emojiDictionary = JSON.parse(cachedData);
        }

    } catch (error) {
        console.error("No se pudo cargar el diccionario de emojis:", error);
        // Plan B: Si todo falla, intentamos usar la √∫ltima versi√≥n que tengamos guardada.
        const fallbackData = localStorage.getItem(EMOJI_DATA_CACHE_KEY);
        if (fallbackData) {
            console.warn("[Emoji] Usando versi√≥n de respaldo del diccionario desde cach√©.");
            emojiDictionary = JSON.parse(fallbackData);
        } else {
            emojiDictionary = []; // Si no hay nada, lo dejamos vac√≠o para no romper la app.
        }
    }
}
function generateCustomId(prefix) {
    const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
    return `${prefix}${randomPart}`;
}
function findEmojiForText(text) {
    if (!text || !text.trim() || emojiDictionary.length === 0) return null;

    const searchTerm = text.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    for (const item of emojiDictionary) {
        if (item.label === searchTerm) {
            return item.emoji;
        }
        if (item.tags && item.tags.includes(searchTerm)) {
            return item.emoji;
        }
    }
    
    return null;
}
function hideSpinner() { spinner.style.display = 'none'; }
// --- FUNCI√ìN PARA DETECTAR DISPOSITIVOS M√ìVILES ---
function isMobileDevice() {
    return /Mobi/i.test(navigator.userAgent);
}
function showToast(msg, isError = false, persistent = false) {
    const t = document.getElementById('toast');
    
    // Limpiamos el contenido anterior y el timer si exist√≠a
    if (window.toastTimer) clearTimeout(window.toastTimer);
    t.innerHTML = ''; 

    // Creamos el contenido del toast
    const textSpan = document.createElement('span');
    textSpan.textContent = msg;
    t.appendChild(textSpan);

    t.className = 'toast' + (isError ? ' error' : ''); // Limpiamos clases de animaci√≥n

    if (persistent) {
        const closeBtn = document.createElement('button');
        closeBtn.className = 'toast-close-btn';
        closeBtn.innerHTML = '&times;';
        closeBtn.onclick = () => {
            t.classList.add('fadeout');
            setTimeout(() => {
                t.classList.remove('show', 'fadeout');
            }, 300);
        };
        t.appendChild(closeBtn);
    } else {
        // Si no es persistente, se cierra solo despu√©s de 3 segundos
        window.toastTimer = setTimeout(() => {
            t.classList.add('fadeout');
            setTimeout(() => {
                t.classList.remove('show', 'fadeout');
            }, 300);
        }, 3000);
    }
    
    // Mostramos el toast
    t.classList.add('show');
}

let isInitializing = false;

// ==================================================
// --- M√ìDULO: GESTOR DE TEMAS (VERSI√ìN CON CALENDARIO) ---
// ==================================================
function applyTheme(theme) {
    const root = document.documentElement;
    const tg = window.Telegram?.WebApp;

    const themes = {
        light: {
            '--bg': '#f5f7fa',
            '--card-bg': '#ffffff',
            '--text': '#333333',
            '--muted': '#555555',
            '--menu-bg': '#ffffff'
        },
        dark: {
            '--bg': '#1c2128',
            '--card-bg': '#2d333b',
            '--text': '#cdd9e5',
            '--muted': '#768390',
            '--menu-bg': '#2d333b'
        }
    };

    let themeToApply = {};
    let isDarkMode = false; // <-- Nueva variable para rastrear el modo

    if (theme === 'auto' && tg && tg.themeParams) {
        // Modo autom√°tico: Usar los colores de Telegram
        themeToApply = {
            '--bg': tg.themeParams.bg_color || themes.light['--bg'],
            '--card-bg': tg.themeParams.secondary_bg_color || themes.light['--card-bg'],
            '--text': tg.themeParams.text_color || themes.light['--text'],
            '--muted': tg.themeParams.hint_color || themes.light['--muted'],
            '--menu-bg': tg.themeParams.secondary_bg_color || themes.light['--card-bg']
        };
        isDarkMode = (tg.colorScheme === 'dark'); // <-- Determinamos si Telegram est√° en modo oscuro
    } else {
        // Modos manuales: Usar nuestras paletas predefinidas
        themeToApply = themes[theme] || themes.light;
        isDarkMode = (theme === 'dark'); // <-- Determinamos si se eligi√≥ el modo oscuro manualmente
    }

    // Aplicar los colores al documento
    for (const [property, value] of Object.entries(themeToApply)) {
        root.style.setProperty(property, value);
    }

    // --- L√ìGICA DEL CALENDARIO INTEGRADA ---
    const darkThemeLinkId = 'flatpickr-dark-theme';
    const existingLink = document.getElementById(darkThemeLinkId);

    if (isDarkMode && !existingLink) {
        // Si es modo oscuro y el estilo no existe, lo creamos y a√±adimos.
        const darkThemeLink = document.createElement('link');
        darkThemeLink.id = darkThemeLinkId;
        darkThemeLink.rel = 'stylesheet';
        darkThemeLink.href = 'https://npmcdn.com/flatpickr/dist/themes/dark.css';
        document.head.appendChild(darkThemeLink);
    } else if (!isDarkMode && existingLink) {
        // Si NO es modo oscuro y el estilo existe, lo eliminamos.
        existingLink.remove();
    }
    
    console.log(`[Theme] Tema aplicado: ${theme}. Modo oscuro: ${isDarkMode}`);
}

// --- FIN GESTOR DE TEMAS ---
let isAppReady = false;
let activeFlatpickrInstance = null;

function destroyActiveFlatpickr() {
  if (activeFlatpickrInstance) {
    activeFlatpickrInstance.destroy();
    activeFlatpickrInstance = null;
  }
}

// Funci√≥n de ayuda para la configuraci√≥n base de todos los calendarios
function getFlatpickrBaseConfig() {
    let initialDate = null; // Guardar√° la fecha original al abrir

    return {
        disableMobile: true,
        locale: "es",
        wrap: true,   // CLAVE: Necesario para que detecte el <input> dentro del <div>

        onOpen: function(selectedDates, dateStr, instance) {
            if (activeFlatpickrInstance && activeFlatpickrInstance !== instance) {
                activeFlatpickrInstance.destroy();
            }
            activeFlatpickrInstance = instance;
            // Guarda la fecha inicial para poder "cancelar"
            initialDate = instance.selectedDates[0] || null;
        },

        onClose: function(selectedDates, dateStr, instance) {
            if (activeFlatpickrInstance === instance) {
                activeFlatpickrInstance = null;
            }
        },

        // onReady es el hook oficial para a√±adir elementos al calendario ya construido
        onReady: function(selectedDates, dateStr, instance) {
            const isDarkMode = !!document.getElementById('flatpickr-dark-theme');
            if (isDarkMode) {
                instance.calendarContainer.classList.add("dark-theme");
            }

            // Si los botones ya existen, no los volvemos a crear
            if (instance.calendarContainer.querySelector('.fp-buttons')) return;

            const btnContainer = document.createElement('div');
            btnContainer.className = 'fp-buttons';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'fp-button fp-cancel-btn';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.addEventListener('click', (e) => {
                e.preventDefault();
                instance.setDate(initialDate, true);
                instance.close();
            });

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'fp-button fp-confirm-btn';
            confirmBtn.textContent = 'Establecer';
            confirmBtn.addEventListener('click', (e) => {
                e.preventDefault();
                instance.close();
            });

            btnContainer.appendChild(cancelBtn);
            btnContainer.appendChild(confirmBtn);
            instance.calendarContainer.appendChild(btnContainer);
        }
    };
}
let unsubscribeShoppingList = null;
let unsubscribeNotesList = null;
let unsubscribeCalendarEvents = null; // Declaraci√≥n √∫nica para el listener del calendario
let calendarScrollSyncHandler = null; // Para el listener de scroll sincronizado
const FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION = 'eventos_calendario';
let currentCalendarView = 'month';
let currentCalendarDate = new Date();

function setActiveTab(activeTabId) { 
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); 
  const activeTab = document.getElementById(activeTabId); 
  if (activeTab) activeTab.classList.add('active'); 
}

document.body.addEventListener('click', (e) => {
    const menuBtn = e.target.closest('.card-menu-btn, .generic-menu-btn');
    
    if (!menuBtn && !e.target.closest('.dropdown-menu')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
        return;
    }

    if (menuBtn) {
        e.stopPropagation();
        const menuId = menuBtn.dataset.menuId;
        const menu = document.getElementById(menuId);

        if (menu) {
            const isShown = menu.classList.contains('show');
            
            document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                if (m.id !== menuId) m.classList.remove('show');
            });

            if (isShown) {
                menu.classList.remove('show');
            } else {
                const buttonRect = menuBtn.getBoundingClientRect();
                const windowHeight = window.innerHeight;

                if (buttonRect.top > (windowHeight / 2)) {
                    menu.classList.add('up');
                } else {
                    menu.classList.remove('up');
                }
                
                menu.classList.add('show');
            }
        }
    }
});

window.confirmDelete = function(type, id) {
    const itemElement = document.getElementById(`item-${id}`);
    if (!itemElement) return;

    let actionsContainer, menuButton;
    let originalDeleteBtn, originalSaveBtn; // Variables para guardar los botones del formulario

    if (itemElement.classList.contains('form-card')) {
        // --- INICIO: L√≥gica espec√≠fica para el formulario ---
        actionsContainer = itemElement.querySelector('.button-group');
        originalDeleteBtn = actionsContainer.querySelector('#delete-gasto-btn');
        originalSaveBtn = actionsContainer.querySelector('#save-gasto-btn');
        
        // Ocultamos los botones originales
        if (originalDeleteBtn) originalDeleteBtn.style.display = 'none';
        if (originalSaveBtn) originalSaveBtn.style.display = 'none';
        // --- FIN: L√≥gica espec√≠fica para el formulario ---
    } else {
        // L√≥gica para elementos de lista (sin cambios)
        actionsContainer = itemElement.querySelector('.list-item-actions');
        menuButton = actionsContainer.querySelector('.generic-menu-btn');
        const dropdown = actionsContainer.querySelector('.dropdown-menu');
        if (dropdown) dropdown.classList.remove('show');
        if (menuButton) menuButton.style.display = 'none';
    }
    
    actionsContainer.querySelectorAll('.confirm-btn-yes, .confirm-btn-no').forEach(btn => btn.remove());
    
    const confirmBtnYes = document.createElement('button');
    confirmBtnYes.className = 'confirm-btn-yes';
    confirmBtnYes.textContent = 'S√≠, Eliminar';
    confirmBtnYes.onclick = (e) => { e.stopPropagation(); executeDelete(type, id); };

    const confirmBtnNo = document.createElement('button');
    confirmBtnNo.className = 'confirm-btn-no';
    confirmBtnNo.textContent = 'No';
    confirmBtnNo.onclick = (e) => { 
        e.stopPropagation(); 
        // --- INICIO: L√≥gica de restauraci√≥n mejorada ---
        if (itemElement.classList.contains('form-card')) {
            // Si es el formulario, volvemos a mostrar los botones originales
            if (originalDeleteBtn) originalDeleteBtn.style.display = 'block';
            if (originalSaveBtn) originalSaveBtn.style.display = 'block';
        } else {
            // Si es una lista, mostramos el men√∫ de nuevo
            if (menuButton) menuButton.style.display = 'block'; 
        }
        // --- FIN: L√≥gica de restauraci√≥n mejorada ---
        confirmBtnYes.remove(); 
        confirmBtnNo.remove(); 
    };
    
    actionsContainer.appendChild(confirmBtnNo);
    actionsContainer.appendChild(confirmBtnYes);
}

async function executeDelete(type, id) {
    let payload = { chat_ID: chatId };
    let successMessage = '';

    try {
        switch(type) {
            case 'reminder': {
                // --- L√ìGICA OPTIMISTA Y NATIVA DE FIRESTORE ---
                const reminderItem = document.getElementById(`item-${id}`);
                if (reminderItem) reminderItem.remove();
                
                appData.counts.remindersCount = Math.max(0, appData.counts.remindersCount - 1);
                const reminderBadge = document.getElementById('reminders-badge');
                if (reminderBadge) reminderBadge.textContent = appData.counts.remindersCount;

                (async () => {
                    try {
                        const reminderRef = db.collection('users').doc(chatId).collection('notificaciones').doc(id);
                        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

                        const batch = db.batch();
                        batch.delete(reminderRef);
                        batch.update(countsRef, {
                            remindersCount: firebase.firestore.FieldValue.increment(-1)
                        });
                        await batch.commit();
                        console.log("Recordatorio eliminado y contador actualizado en Firestore.");

                    } catch (err) {
                        console.error("Error al eliminar recordatorio en Firestore:", err);
                        showToast('Error de sincronizaci√≥n al eliminar. Restaurando...', true);
                        setTimeout(() => initializeApp(), 1500);
                    }
                })(); 
                return;
            }

            case 'note': {
                const noteItemElement = document.getElementById(`item-${id}`);
                if (noteItemElement) noteItemElement.remove();
                
                appData.counts.notesCount = Math.max(0, appData.counts.notesCount - 1);
                const notesListBadge = document.getElementById('notes-badge');
                if(notesListBadge) notesListBadge.textContent = appData.counts.notesCount;

                if (document.getElementById('notes-list') && document.getElementById('notes-list').children.length === 0) {
                     document.getElementById('notes-list').innerHTML = '<div class="no-data-msg">üìù<br>No tienes notas guardadas.</div>';
                }

                showToast('Nota eliminada');
                
                (async () => {
                    try {
                        const noteDocRef = db.collection('users').doc(chatId).collection('notas').doc(id);
                        const countsDocRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

                        const batch = db.batch();
                        batch.delete(noteDocRef);
                        batch.update(countsDocRef, {
                            notesCount: firebase.firestore.FieldValue.increment(-1)
                        });
                        await batch.commit();
                        console.log("Nota eliminada y contador actualizado en Firestore.");

                    } catch(err) {
                        console.error("Error al eliminar nota en Firestore:", err);
                        showToast('Error de sincronizaci√≥n al eliminar. Recargando...', true);
                        setTimeout(() => initializeApp(), 1500);
                    }
                })();
                return; 
            }
            
            case 'calendar_event':
                handleDeleteCalendarEvent(id);
                return;

            case 'gasto': {
                // --- INICIO: L√ìGICA DE ELIMINACI√ìN NATIVA CON TRANSACCI√ìN DE FIRESTORE ---
                showToast("Eliminando gasto...");

                (async () => {
                    try {
                        const gastoRef = db.collection('users').doc(chatId).collection('gastos').doc(id);
                        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

                        // Usamos una transacci√≥n para garantizar la consistencia de los datos financieros.
                        await db.runTransaction(async (transaction) => {
                            const gastoDoc = await transaction.get(gastoRef);
                            if (!gastoDoc.exists) {
                                throw "El gasto que intentas eliminar ya no existe.";
                            }

                            const importeGasto = gastoDoc.data().importe || 0;
                            const decremento = -importeGasto;

                            // 1. Preparamos la eliminaci√≥n del gasto
                            transaction.delete(gastoRef);
                            // 2. Preparamos la actualizaci√≥n del contador
                            transaction.update(countsRef, { 
                                gastosMesActual: firebase.firestore.FieldValue.increment(decremento) 
                            });
                        });

                        // Si la transacci√≥n tuvo √©xito, actualizamos la UI localmente.
                        // La lista de gastos se actualizar√° la pr√≥xima vez que se cargue,
                        // pero el contador del dashboard lo podemos refrescar ya.
                        const gastoOriginal = gastosEncontrados.find(g => g.ID_Unico === id);
                        if (gastoOriginal) {
                             appData.counts.gastosMesActual -= (gastoOriginal.importe || 0);
                        }
                        renderDashboard(); // Re-dibuja el dashboard con el nuevo total.
                        showToast("Gasto eliminado con √©xito.");

                    } catch (err) {
                        console.error("Error en la transacci√≥n de eliminaci√≥n de gasto:", err);
                        showToast(`Error al eliminar: ${err}.`, true);
                    }
                })();

                return; // Salimos para no ejecutar el c√≥digo antiguo de abajo.
            }
            
            case 'shopping_item': 
                handleDeleteShoppingItem(id);
                return;
        }

    } catch(e) { showToast('Error local al procesar.', true); return; }
}

// ==================================================
// --- M√ìDULO: RECORDATORIOS ---
// ==================================================
function renderReminderForm() {
  navigationHistory.push(renderDashboard);
  updateBackButton();
  mainContentArea.innerHTML = `
    <div class="list-container">
      <div class="list-header"><h2>üìù Nuevo Recordatorio</h2></div>
      <div class="form-card">
        <label>Descripci√≥n</label><textarea id="text" rows="3" required></textarea>
        <label>Fecha y hora</label><div class="flatpickr-wrapper"><input type="text" id="time" required data-input/></div>
        <label>Tipo</label>
        <div class="radio-group" id="reminder-type-group">
          <label><input type="radio" name="category" value="Un solo uso" checked/> √önico</label>
          <label><input type="radio" name="category" value="Diario"/> Diario</label>
          <label><input type="radio" name="category" value="Recurrente"/> Recurrente</label>
        </div>
        <div id="recurrent-hours-container">
          <label>Repetir cada...</label>
          <select id="recurrent-hours">${[...Array(11).keys()].map(i => `<option value="${i + 2}">${i + 2} horas</option>`).join('')}</select>
        </div>
        <button id="sendBtn" disabled>Crear Recordatorio</button>
      </div>
    </div>`;
  const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), sendBtn = document.getElementById('sendBtn'), radios = document.querySelectorAll('input[name="category"]'), recurrentContainer = document.getElementById('recurrent-hours-container');
  
  // --- INICIO: L√≥gica de fecha por defecto precisa (v2.1) ---
const userTimeZone = appData.settings.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;

// Funci√≥n para obtener la fecha/hora actual real en la zona del usuario
const getNowInUserTimeZone = () => {
    const now = new Date(); // Obtiene la hora actual universal (UTC)
    // Usamos Intl.DateTimeFormat para convertir la hora UTC a la zona horaria del usuario
    // 'en-CA' nos da el formato YYYY-MM-DD, ideal para flatpickr
    const parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: userTimeZone,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).formatToParts(now).reduce((acc, part) => ({ ...acc, [part.type]: part.value }), {});
    
    // Devolvemos la fecha como un objeto Date, que es lo que flatpickr maneja mejor
    // para evitar ambig√ºedades de zona horaria.
    return new Date(`${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`);
};

const nowInUserZone = getNowInUserTimeZone();

flatpickr(document.querySelector("#time").parentElement, {
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    enableTime: true,
    altInput: true,
    altFormat: "d/m/Y H:i",
    dateFormat: "Y-m-d H:i",
    defaultDate: nowInUserZone, // Usamos el objeto Date preciso
    minDate: nowInUserZone // Bloqueamos la selecci√≥n de cualquier momento anterior al actual
});
// --- FIN: L√≥gica de fecha por defecto precisa ---

  function toggleRecurrentField() { const selected = document.querySelector('input[name="category"]:checked').value; recurrentContainer.style.display = selected === 'Recurrente' ? 'block' : 'none'; }
  function validate() { const isValid = textInput.value.trim() !== '' && timeInput.value && document.querySelector('input[name="category"]:checked'); sendBtn.disabled = !isValid; sendBtn.classList.toggle('enabled', isValid); }
  textInput.oninput = validate; timeInput.oninput = validate; radios.forEach(r => r.onchange = () => { toggleRecurrentField(); validate(); });
  sendBtn.onclick = saveReminder;
  toggleRecurrentField(); validate();
}

async function saveReminder() {
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    // Guardamos los datos antes de la operaci√≥n as√≠ncrona
    const category = document.querySelector('input[name="category"]:checked').value;
    const description = document.getElementById('text').value.trim();
    const timePicker = document.getElementById('time').parentElement._flatpickr;
    const selectedDate = timePicker.selectedDates[0];
    const horas_recurrentes = (category === 'Recurrente') ? document.getElementById('recurrent-hours').value : null;
    
    if (!description || !selectedDate) {
        showToast("La descripci√≥n y la fecha son obligatorias.", true);
        sendBtn.disabled = false; // Reactivamos el bot√≥n
        return;
    }

    // --- INICIO: L√ìGICA OPTIMISTA MEJORADA ---
    const customId = generateCustomId('G-');
    const fechaLocalParaUI = timePicker.formatDate(selectedDate, "d/m/Y H:i");

    const tempReminder = {
        tracking_code: customId,
        Descripcion: description,
        Categoria: category,
        Fecha: fechaLocalParaUI,
        Status: 'pending_creation'
    };
    appData.remindersList.unshift(tempReminder);
    
    // Navegamos a la lista, que ahora dibujar√° desde la memoria local primero.
    renderRemindersList();
    // --- FIN: L√ìGICA OPTIMISTA MEJORADA ---

    try {
        // 3. En segundo plano, llamamos a la Cloud Function.
        const fechaLocalString = timePicker.formatDate(selectedDate, "Y-m-d\\TH:i:S");
        const datosRecordatorio = {
            descripcion: description,
            categoria_recordatorio: category,
            hora_local: fechaLocalParaUI,
            horas_recurrentes: horas_recurrentes ? parseInt(horas_recurrentes, 10) : null
        };

        const payload = {
            chatId: chatId,
            tipo: 'recordatorioSimple',
            fechaLocal: fechaLocalString,
            datos: datosRecordatorio,
            customId: customId
        };
        
        const functions = firebase.app().functions('europe-west1');
        const createNotificationFunction = functions.httpsCallable('createNotification');
        await createNotificationFunction(payload);
        // Si tiene √©xito, no hacemos nada. El listener se encargar√°.

    } catch (err) {
        // --- INICIO: NUEVO MANEJO DE ERRORES ---
        console.error("Error al guardar el recordatorio:", err);
        showToast("Error al guardar. No se pudo crear el recordatorio. Por favor, int√©ntalo de nuevo.", true, true); // Toast persistente
        
        // Eliminamos el recordatorio optimista fallido de la lista local
        const index = appData.remindersList.findIndex(r => r.tracking_code === customId);
        if (index > -1) {
            appData.remindersList.splice(index, 1);
        }
        
        // Volvemos al formulario para que el usuario pueda reintentar
        renderReminderForm();
        
        // Rellenamos el formulario con los datos que el usuario ya hab√≠a introducido
        document.getElementById('text').value = description;
        document.querySelector(`input[name="category"][value="${category}"]`).checked = true;
        document.getElementById('time').parentElement._flatpickr.setDate(selectedDate);
        if(horas_recurrentes) document.getElementById('recurrent-hours').value = horas_recurrentes;
        // --- FIN: NUEVO MANEJO DE ERRORES ---
    }
}

// Variable global para poder desconectar el listener si el usuario sale de la vista
let unsubscribeRemindersList = null;

async function renderRemindersList() {
    navigationHistory.push(() => {
        if (typeof unsubscribeRemindersList === 'function') {
            unsubscribeRemindersList();
            unsubscribeRemindersList = null;
        }
        renderDashboard();
    });
    updateBackButton();
    
    mainContentArea.innerHTML = `<div class="list-container">
                            <div class="list-header"><h2>Recordatorios</h2></div>
                            <div class="add-article-btn-container">
                                <button class="add-article-btn" id="add-new-reminder-btn">‚ûï A√±adir Recordatorio</button>
                            </div>
                            <ul class="list-style-none" id="reminders-list"></ul>
                         </div>`;
						 document.getElementById('add-new-reminder-btn').onclick = renderReminderForm;

    // 1. Dibuja la lista INMEDIATAMENTE desde la memoria local (incluyendo el recordatorio optimista)
    drawRemindersList();
    
    const listElement = document.getElementById('reminders-list');
    listElement.removeEventListener('click', handleReminderListClick);
    listElement.addEventListener('click', handleReminderListClick);

    // 2. Si ya hay un listener, no lo reinicies todav√≠a para evitar el parpadeo.
    if (typeof unsubscribeRemindersList === 'function') {
        return; 
    }

    const q = db.collection('users').doc(chatId).collection('notificaciones')
                .orderBy('fecha_universal', 'asc');
    
    unsubscribeRemindersList = q.onSnapshot(snapshot => {
    const reminders = [];
    snapshot.forEach(doc => {
        const data = doc.data();
        reminders.push({
            tracking_code: doc.id,
            Descripcion: data.descripcion,
            Categoria: data.categoria_recordatorio,
            Fecha: data.hora_local,
            Status: data.status
        });
    });
    
    // --- INICIO: Fusi√≥n Inteligente ---
		const pendingOptimistic = appData.remindersList.filter(r => r.Status === 'pending_creation');
		const finalReminders = [...reminders];

	pendingOptimistic.forEach(pending => {
		// Si el recordatorio optimista a√∫n no ha sido confirmado por Firestore, lo mantenemos en la lista.
    if (!finalReminders.some(r => r.tracking_code === pending.tracking_code)) {
        finalReminders.unshift(pending);
    }
});

appData.remindersList = finalReminders;
appData.counts.remindersCount = finalReminders.length;
// --- FIN: Fusi√≥n Inteligente ---
    if (document.getElementById('reminders-badge')) {
        document.getElementById('reminders-badge').textContent = reminders.length;
    }

    drawRemindersList();

}, error => {
    console.error("Error en el listener de recordatorios:", error);
    showToast("Error de conexi√≥n con la lista.", true);
    const listElement = document.getElementById('reminders-list');
    if(listElement) listElement.innerHTML = '<div class="no-data-msg">‚ùå Error de conexi√≥n.</div>';
});
}

function drawRemindersList() {
    const listElement = document.getElementById('reminders-list');
    if (!listElement) return;

    const listHtml = appData.remindersList.map(item => `
        <li class="list-item" id="item-${item.tracking_code}">
            <div class="list-item-content">
                <span class="list-item-title">
                    ${item.Status === 'pending_creation' ? '‚åõ ' : ''}${item.Descripcion}
                </span>
                <span class="list-item-subtitle">${item.Categoria}: ${item.Fecha}</span>
            </div>
            <div class="list-item-actions">
                <button class="generic-menu-btn" data-menu-id="menu-item-${item.tracking_code}">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-item-${item.tracking_code}">
                    <a class="dropdown-item" data-action="delete-reminder" data-tracking-code="${item.tracking_code}">Eliminar</a>
                </div>
            </div>
        </li>`).join('');

    listElement.innerHTML = listHtml;
}

// Nueva funci√≥n de ayuda para manejar los clics en la lista
function handleReminderListClick(e) {
    const target = e.target.closest('.dropdown-item[data-action="delete-reminder"]');
    if (target) {
        confirmDelete('reminder', target.dataset.trackingCode);
    }
}

async function editReminderDescription(item) {
  const newDescription = prompt('Editar descripci√≥n del recordatorio:', item.Descripcion);
  
  // Verificamos que el usuario introdujo un texto nuevo y diferente.
  if (newDescription && newDescription.trim() !== '' && newDescription.trim() !== item.Descripcion) {
    showToast('Guardando cambios...');
    
    try {
      // Usamos el SDK de Firestore para actualizar el documento directamente.
      const reminderRef = db.collection('users').doc(chatId).collection('notificaciones').doc(item.tracking_code);
      await reminderRef.update({
        descripcion: newDescription.trim()
      });
      
      // No necesitamos hacer nada m√°s. El oyente `onSnapshot` en `renderRemindersList`
      // detectar√° este cambio autom√°ticamente y actualizar√° la UI.
      showToast('Recordatorio actualizado.');

    } catch (err) {
      // En caso de error, mostramos un mensaje y la app permanecer√° consistente.
      showToast(`Error al actualizar: ${err.message}`, true);
      console.error("Error al editar descripci√≥n del recordatorio:", err);
    }
  }
}

// ==================================================
// --- M√ìDULO: COMPRAS (FIRESTORE EN TIEMPO REAL + OPTIMISTA) ---
// ==================================================

async function renderShoppingList() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>Lista de las Compras</h2></div>
            <div id="shopping-list-content">
                <div class="no-data-msg">Cargando lista de compras...</div>
            </div>
            <div class="add-article-btn-container">
                <button class="add-article-btn" id="add-shopping-item-btn">A√±adir Art√≠culo</button>
                <button class="multi-select-action-btn" id="multi-select-toggle-btn" disabled>Marcar para comprar</button>
            </div>
        </div>`;
    
    document.getElementById('add-shopping-item-btn').onclick = renderAddArticleForm;
    document.getElementById('multi-select-toggle-btn').onclick = toggleSelectedItemsToPending;

    // --- L√ìGICA DE TIEMPO REAL CON FIRESTORE ---
    if (unsubscribeShoppingList) {
        unsubscribeShoppingList(); // Desuscribirse si ya hay un oyente activo para evitar duplicados.
    }

    const userShoppingListPath = `users/${chatId}/listaDeLaCompra`;
    const q = db.collection(userShoppingListPath)
                .orderBy('estado', 'asc') // 'Comprado' antes que 'Pendiente'
                .orderBy('fecha', 'desc');

    unsubscribeShoppingList = q.onSnapshot((snapshot) => {
    const items = [];
    snapshot.forEach((doc) => {
        const data = doc.data();
        items.push({ 
            id: doc.id,
            articulo: data.articulo,
            estado: data.estado,
            fecha: data.fecha ? data.fecha.toDate() : null,
            cycle: data.cycle || 0
        });
    });
    
    appData.shoppingList = items;
    const userTimeZone = appData.settings.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;
	renderShoppingListContent(items, userTimeZone);
	syncShoppingCounts();
    console.log("Lista de compras actualizada desde Firestore.");

}, (error) => {
        console.error("Error al escuchar la lista de compras:", error);
        showToast("Error en tiempo real de la lista de compras.", true);
        document.getElementById('shopping-list-content').innerHTML = '<div class="no-data-msg">‚ùå Error al cargar la lista.</div>';
    });
}

function renderShoppingListContent(items, userTimeZone) {
    const pendingItems = items.filter(item => item.estado === 'Pendiente');
    const boughtItems = items.filter(item => item.estado === 'Comprado');
    let listHtml = '';
    
    const createItemHTML = (item) => {
        const isPending = item.estado === 'Pendiente';
        const formattedDate = item.fecha ? item.fecha.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit', timeZone: userTimeZone }) : '';
        
        return `
            <li class="shopping-item" id="item-${item.id}">
                ${!isPending ? `<div class="shopping-item-checkbox-wrapper"><input type="checkbox" class="shopping-item-checkbox" data-id="${item.id}"></div>` : ''}
                <button class="shopping-item-toggle-btn ${isPending ? 'pending' : 'bought'}" data-id="${item.id}" data-current-status="${item.estado}">
                <span>${item.articulo}</span>
                    ${!isPending && formattedDate ? `<span class="item-date">${formattedDate}</span>` : ''}
                </button>
                <div class="list-item-actions">
                    <button class="generic-menu-btn" data-menu-id="menu-item-${item.id}">‚ãÆ</button>
                    <div class="dropdown-menu" id="menu-item-${item.id}">
                        <a class="dropdown-item" data-action="edit-shopping-item" data-id="${item.id}">Editar</a>
                        <a class="dropdown-item" data-action="delete-shopping-item" data-id="${item.id}">Eliminar</a>
                    </div>
                </div>
            </li>`;
    };

    if (pendingItems.length > 0) {
        listHtml += '<h3 class="shopping-list-section-title">Art√≠culos Pendientes</h3>';
        listHtml += pendingItems.map(createItemHTML).join('');
    }
    if (boughtItems.length > 0) {
        listHtml += '<h3 class="shopping-list-section-title">Art√≠culos Comprados</h3>';
        listHtml += `<div class="shopping-list-header-row"><label for="select-all-checkbox">Seleccionar Todos</label><input type="checkbox" id="select-all-checkbox"></div>`;
        listHtml += boughtItems.map(createItemHTML).join('');
    }
    if (items.length === 0) {
        listHtml = '<div class="no-data-msg">üõí<br>Tu lista est√° vac√≠a.</div>';
    }

    const contentDiv = document.getElementById('shopping-list-content');
    if (contentDiv) {
        contentDiv.innerHTML = listHtml;
        contentDiv.removeEventListener('click', handleShoppingItemInteractions);
        contentDiv.addEventListener('click', handleShoppingItemInteractions);
        
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.onchange = (e) => {
                document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.checked = e.target.checked; });
                updateMultiSelectButtonState();
            };
        }
        document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.onchange = updateMultiSelectButtonState; });
        updateMultiSelectButtonState();
    }
}

function handleShoppingItemInteractions(event) {
    const target = event.target;
    const toggleButton = target.closest('.shopping-item-toggle-btn');
    const menuItem = target.closest('.dropdown-item');

    if (toggleButton) {
        const itemId = toggleButton.dataset.id;
        const currentStatus = toggleButton.dataset.currentStatus;
        const newStatus = currentStatus === 'Pendiente' ? 'Comprado' : 'Pendiente';
        toggleShoppingItemStatus(itemId, newStatus);
        return;
    }

    if (menuItem) {
        const action = menuItem.dataset.action;
        const itemId = menuItem.dataset.id;
        if (action === 'edit-shopping-item') {
            const item = appData.shoppingList.find(i => i.id === itemId);
            if(item) renderEditShoppingItemForm(item);
                } else if (action === 'delete-shopping-item') {
        confirmDelete('shopping_item', itemId); // <--- Restaurar la llamada a confirmDelete
    }
    }
}

async function toggleShoppingItemStatus(itemId, newStatus) {
    const itemRef = db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(itemId);

    // --- L√≥gica Unificada y Moderna ---
    if (newStatus === 'Comprado') {
        // 1. Buscamos el art√≠culo en nuestra lista local para chequear su ciclo de compra.
        const item = appData.shoppingList.find(i => i.id === itemId);

        // 2. Si el art√≠culo existe y su ciclo es 0, es un art√≠culo de un solo uso y debe ser eliminado.
        if (item && item.cycle === 0) {
            const itemName = item.articulo.length > 20 ? item.articulo.substring(0, 20) + '...' : item.articulo;
            showToast(`'${itemName}' completado y eliminado.`);
            
            // Llamamos a la funci√≥n de borrado existente que ya maneja la l√≥gica de Firestore y contadores.
            handleDeleteShoppingItem(itemId);
            return; // ¬°Importante! Salimos de la funci√≥n, el trabajo est√° hecho.
        }
    }

    // 3. Si no se cumpli√≥ la condici√≥n de borrado (ciclo > 0 o se est√° moviendo a "Pendiente"), 
    // procedemos a actualizar el estado del art√≠culo.
    try {
        const docSnap = await itemRef.get();
        if (!docSnap.exists) {
            console.warn(`Intento de actualizar documento no existente: ${itemId}.`);
            showToast("El art√≠culo ya no existe. Actualizando lista.", false);
            if (unsubscribeShoppingList) unsubscribeShoppingList();
            renderShoppingList();
            return;
        }

        await itemRef.update({
		estado: newStatus,
		fecha: new Date()
	});
        // El listener onSnapshot en tiempo real se encargar√° de actualizar la UI autom√°ticamente.

    } catch (err) {
        console.error("Error al cambiar el estado del art√≠culo:", err);
        showToast(`Error de sincronizaci√≥n: ${err.message}.`, true);
        initializeApp(); // Forzamos una recarga completa en caso de un error grave.
    }
}

async function handleDeleteShoppingItem(itemId) {
    // Obtenemos el tipo de ID para decidir si es un art√≠culo del Chef o manual
    const isChefItem = itemId.startsWith('ITEM-');
    
    // Confirmaci√≥n visual
    showToast("Eliminando art√≠culo...", false);

    try {
        const itemRef = db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(itemId);
        const docSnap = await itemRef.get();

        if (!docSnap.exists) {
            console.warn(`Intento de eliminar documento no existente en Firestore: ${itemId}.`);
            showToast("Advertencia: El art√≠culo ya no existe en la base de datos. Actualizando lista.", false);
            renderShoppingList();
            return;
        }

        // Realiza la eliminaci√≥n en Firestore
        await itemRef.delete();

        // Si es un art√≠culo del Chef, su contador ya se ajustar√≠a al marcar "Comprado" y eliminarse.
        // Para asegurar la consistencia y para art√≠culos manuales, ajustamos el contador aqu√≠.
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        const itemData = docSnap.data(); // Obtenemos el estado actual antes de la eliminaci√≥n
        
        if (itemData.estado === 'Pendiente') {
            await countsRef.update({ shoppingPendingCount: firebase.firestore.FieldValue.increment(-1) });
        } else if (itemData.estado === 'Comprado') {
            await countsRef.update({ shoppingBoughtCount: firebase.firestore.FieldValue.increment(-1) });
        }
        
        // Actualizaci√≥n optimista de la UI (ya se har√° por el onSnapshot, pero por si acaso)
        const index = appData.shoppingList.findIndex(item => item.id === itemId);
        if (index > -1) {
            appData.shoppingList.splice(index, 1);
        }
        renderShoppingListContent(appData.shoppingList);
        updateShoppingCounts(appData.shoppingList); // Actualiza los badges locales

        showToast('Art√≠culo eliminado con √©xito.');

    } catch (err) {
        console.error("Error al eliminar art√≠culo de compras:", err);
        showToast(`Error al eliminar: ${err.message}. Restaurando datos...`, true);
        initializeApp();
    }
}

function updateMultiSelectButtonState() {
    const multiSelectBtn = document.getElementById('multi-select-toggle-btn');
    if (!multiSelectBtn) return;
    const selectedCount = document.querySelectorAll('.shopping-item-checkbox:checked').length;
    multiSelectBtn.disabled = selectedCount === 0;
    multiSelectBtn.textContent = selectedCount > 0 ? `Marcar ${selectedCount} para comprar` : 'Marcar para comprar';
}

async function toggleSelectedItemsToPending() {
    const selectedIds = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.id);
    if (selectedIds.length === 0) return;

    showSpinner(`Moviendo ${selectedIds.length} art√≠culos...`);
    const batch = db.batch();
    selectedIds.forEach(id => {
        const docRef = db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(id);
        batch.update(docRef, { 
            estado: 'Pendiente',
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        });
    });
    try {
        await batch.commit();
        showToast('Art√≠culos movidos a pendientes.');
    } catch (err) {
        console.error("Error en lote:", err);
        showToast(`Error: ${err.message}.`, true);
    } finally {
        hideSpinner();
    }
}

function renderAddArticleForm() {
    navigationHistory.push(renderShoppingList);
    updateBackButton();
    mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>‚ûï A√±adir Art√≠culo</h2></div>
          <div class="form-card">
              <label>Descripci√≥n del art√≠culo</label> <textarea id="article-description" rows="2" required></textarea>
              <label>¬øCada cu√°ntos d√≠as lo compras? (0 si es ocasional)</label> <input type="number" id="article-cycle" value="0" min="0" step="1" required />
              <button id="add-article-send-btn" disabled>A√±adir</button>
          </div>
      </div>`;
    const sendBtn = document.getElementById('add-article-send-btn');
    const descriptionInput = document.getElementById('article-description');
descriptionInput.oninput = () => {
            const isEnabled = descriptionInput.value.trim() !== '';
            sendBtn.disabled = !isEnabled;
            sendBtn.classList.toggle('enabled', isEnabled);

            const text = descriptionInput.value;

            // Evitar buscar si el campo est√° vac√≠o o ya empieza con un emoji
            const startsWithEmoji = emojiDictionary.some(e => text.startsWith(e.emoji));
            if (!text || startsWithEmoji) {
                return;
            }

            // Dividir el texto en palabras y buscar una coincidencia
            const words = text.toLowerCase().split(' ').filter(word => word.length > 2);
            let foundEmoji = null;

            for (const word of words) {
                const foundItem = emojiDictionary.find(item =>
                    item.label === word || (item.tags && item.tags.includes(word))
                );

                if (foundItem) {
                    foundEmoji = foundItem.emoji;
                    break;
                }
            }

            if (foundEmoji) {
                descriptionInput.value = `${foundEmoji} ${text}`;
            }
        };    sendBtn.onclick = addArticle;
}

async function addArticle() {
    const description = document.getElementById('article-description').value.trim();
    const cycle = parseInt(document.getElementById('article-cycle').value, 10) || 0;
    if (!description) return;

    // Verificamos si el texto que vamos a guardar ya empieza con un emoji del diccionario
    const startsWithEmoji = emojiDictionary.some(e => description.startsWith(e.emoji));

    // Solo si NO empieza con un emoji, disparamos la Cloud Function
    if (!startsWithEmoji) {
        try {
            const user = tg?.initDataUnsafe?.user;
            const userName = (user?.first_name || user?.username) || 'Usuario Desconocido';
            
           // Preparamos la llamada a nuestra Cloud Function especificando la regi√≥n correcta
            const functions = firebase.app().functions('europe-west1');
            const logEmojiFunction = functions.httpsCallable('logMissingEmojiTerm');
            logEmojiFunction({ 
                listId: chatId, // Tu funci√≥n espera 'listId', le pasamos el chatId
                guestName: userName, // Tu funci√≥n espera 'guestName', le pasamos el userName
                article: description 
            }).catch(err => console.error("Error al notificar emoji faltante a la Cloud Function:", err));

        } catch (e) {
            console.error("Error construyendo la notificaci√≥n de emoji faltante:", e);
        }
    }

    // El resto de la l√≥gica para guardar el art√≠culo en Firestore no cambia.
    const finalDescription = description;

    goBack();
    showToast('A√±adiendo art√≠culo...');

    try {
        const customId = generateCustomId('G-');
        await db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(customId).set({
            articulo: finalDescription,
            cycle: cycle,
            estado: 'Pendiente',
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (err) { 
        console.error("Error al a√±adir art√≠culo:", err);
        showToast(`Error: ${err.message}.`, true);
    }
}

function renderEditShoppingItemForm(item) {
    navigationHistory.push(renderShoppingList);
    updateBackButton();
    mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>‚úèÔ∏è Editar Art√≠culo</h2></div>
          <div class="form-card">
              <label>Descripci√≥n</label> <textarea id="article-description" rows="2" required>${item.articulo}</textarea>
              <label>Ciclo de compra (d√≠as)</label> <input type="number" id="article-cycle" value="${item.cycle}" min="0" step="1" required />
              <button id="edit-article-send-btn" class="enabled">Guardar Cambios</button>
          </div>
      </div>`;
    document.getElementById('edit-article-send-btn').onclick = () => saveEditedShoppingItem(item.id);
}

async function saveEditedShoppingItem(itemId) {
    const newDescription = document.getElementById('article-description').value.trim();
    const newCycle = parseInt(document.getElementById('article-cycle').value, 10) || 0;
    if (!newDescription) return;

    const emoji = findEmojiForText(newDescription);
    const finalDescription = emoji ? `${emoji} ${newDescription}` : newDescription;
    
    goBack();
    showToast('Guardando cambios...');

    try {
        await db.collection('users').doc(chatId).collection('listaDeLaCompra').doc(itemId).update({
            articulo: finalDescription,
            cycle: newCycle
        });
    } catch (err) {
        console.error("Error al editar:", err);
        showToast(`Error: ${err.message}.`, true);
    }
}

// ==================================================
// --- M√ìDULO: NOTAS (L√ìGICA OPTIMISTA PROFESIONAL) ---
// ==================================================

// Funci√≥n interna para dibujar la lista de notas desde la memoria (es r√°pida)
function drawNotesList() {
    const notesListUl = document.getElementById('notes-list');
    if (!notesListUl) return; // No hacer nada si el contenedor no est√° en pantalla

    if (!appData.notesList || appData.notesList.length === 0) {
        notesListUl.innerHTML = '<div class="no-data-msg">üìù<br>No tienes notas guardadas.</div>';
        return;
    }

    // Ordenar las notas en memoria por fecha (m√°s recientes primero) antes de dibujarlas
    appData.notesList.sort((a, b) => (new Date(b.FechaRaw) - new Date(a.FechaRaw)));

    const listHtml = appData.notesList.map(note => `
        <li class="list-item" id="item-${note.Nota_ID}">
            <div class="list-item-content">
                <span class="list-item-title">${note.Titulo}</span>
                <span class="list-item-subtitle">${note.Fecha}</span>
                <p style="margin-top: 8px; white-space: pre-wrap; word-wrap: break-word;">${note.Descripcion}</p>
            </div>
            <div class="list-item-actions">
                <button class="generic-menu-btn" data-menu-id="menu-item-${note.Nota_ID}">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-item-${note.Nota_ID}">
                    <a class="dropdown-item" data-action="edit-note" data-note-id="${note.Nota_ID}">Editar</a>
                    <a class="dropdown-item" data-action="delete-note" data-note-id="${note.Nota_ID}">Eliminar</a>
                </div>
            </div>
        </li>`).join('');
    
    notesListUl.innerHTML = listHtml;
}

// --- VERSI√ìN EN TIEMPO REAL ---
function renderNotesList() {
    navigationHistory.push(() => {
        // Al volver atr√°s, nos aseguramos de que el listener se desconecte
        if (typeof unsubscribeNotesList === 'function') {
            unsubscribeNotesList();
            unsubscribeNotesList = null;
        }
        renderDashboard();
    });
    updateBackButton();
    
    mainContentArea.innerHTML = `<div class="list-container">
                                <div class="list-header"><h2>Mis Notas</h2></div>
                                <div class="add-article-btn-container"><button class="add-article-btn" id="create-new-note-btn">Crear Nueva Nota</button></div>
                                <ul class="list-style-none" id="notes-list"><div class="no-data-msg">Cargando notas...</div></ul>
                             </div>`;
    
    const listElement = document.getElementById('notes-list');
    
    document.getElementById('create-new-note-btn').onclick = () => renderNoteForm();
    listElement.addEventListener('click', e => {
        const target = e.target.closest('.dropdown-item');
        if (!target) return;
        const action = target.dataset.action;
        const noteId = target.dataset.noteId;
        if (action === 'edit-note') {
            const note = appData.notesList.find(n => n.Nota_ID === noteId);
            if (note) renderNoteForm(note);
        } else if (action === 'delete-note') {
            confirmDelete('note', noteId);
        }
    });

    // Desconectar cualquier listener anterior para evitar duplicados
    if (typeof unsubscribeNotesList === 'function') {
        unsubscribeNotesList();
    }

    const q = db.collection('users').doc(chatId).collection('notas')
                .orderBy('fecha', 'desc');
    
    // --- INICIO DE LA L√ìGICA EN TIEMPO REAL ---
    unsubscribeNotesList = q.onSnapshot(snapshot => {
        appData.notesList = []; // Limpiamos para reconstruir desde la fuente de verdad
        
        if (snapshot.empty) {
            listElement.innerHTML = '<div class="no-data-msg">üìù<br>No tienes notas guardadas.</div>';
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const fecha = data.fecha && data.fecha.toDate ? data.fecha.toDate() : new Date(0);
            appData.notesList.push({
                Nota_ID: doc.id,
                Titulo: data.titulo || 'Sin T√≠tulo',
                Descripcion: data.descripcion || '',
                Fecha: fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                FechaRaw: fecha.toISOString()
            });
        });
        
        // La funci√≥n drawNotesList ahora se vuelve reutilizable y se llama desde aqu√≠
        drawNotesList(); 

    }, error => {
        console.error("Error en el listener de notas:", error);
        showToast("Error de conexi√≥n con la lista de notas.", true);
        listElement.innerHTML = '<div class="no-data-msg">‚ùå Error de conexi√≥n.</div>';
    });
}

function renderNoteForm(note = null) {
    navigationHistory.push(renderNotesList);
    updateBackButton();
    const isEditing = note && note.Nota_ID;
    mainContentArea.innerHTML = `<div class="list-container">
                                <div class="list-header"><h2>${isEditing ? '‚úèÔ∏è Editar Nota' : '‚ûï Nueva Nota'}</h2></div>
                                <div class="form-card">
                                    <label>T√≠tulo</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}" required />
                                    <label>Descripci√≥n</label><textarea id="note-description" rows="8" required>${isEditing ? note.Descripcion : ''}</textarea>
                                    <div class="button-group">
                                        <button id="cancel-note-btn" class="cancel">Cancelar</button>
                                        <button id="save-note-btn" data-note-id="${isEditing ? note.Nota_ID : ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button>
                                    </div>
                                </div>
                             </div>`;
    const titleInput = document.getElementById('note-title');
    const descriptionInput = document.getElementById('note-description');
    const saveBtn = document.getElementById('save-note-btn');
    
    function validate() {
        const isEnabled = titleInput.value.trim() !== '' && descriptionInput.value.trim() !== '';
        saveBtn.disabled = !isEnabled;
        saveBtn.classList.toggle('enabled', isEnabled);
    }
    titleInput.oninput = validate;
    descriptionInput.oninput = validate;
    saveBtn.onclick = saveNote;
    document.getElementById('cancel-note-btn').onclick = goBack;
    validate();
}

async function saveNote() {
    const saveBtn = document.getElementById('save-note-btn');
    const title = document.getElementById('note-title').value.trim();
    const description = document.getElementById('note-description').value.trim();
    const noteId = saveBtn.dataset.noteId;
    const isEditing = !!noteId;

    if (!title) {
        showToast("El t√≠tulo es obligatorio.", true);
        return;
    }
    
    // Volvemos a la lista ANTES de empezar la operaci√≥n de guardado.
    // El oyente onSnapshot se encargar√° de mostrar los cambios.
    goBack(); 
    showToast(isEditing ? 'Guardando cambios...' : 'Creando nota...');

    try {
        const notesRef = db.collection('users').doc(chatId).collection('notas');
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

        const dataToSave = {
            titulo: title,
            descripcion: description,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (isEditing) {
            // En modo edici√≥n, simplemente actualizamos el documento existente.
            await notesRef.doc(noteId).update(dataToSave);
        } else {
            // Al crear, generamos un nuevo documento y actualizamos el contador.
            const newNoteRef = notesRef.doc(); // Firestore genera el ID
            
            const batch = db.batch();
            batch.set(newNoteRef, dataToSave);
            batch.update(countsRef, {
                notesCount: firebase.firestore.FieldValue.increment(1)
            });
            await batch.commit();
        }
        
        // No necesitamos hacer nada m√°s. El oyente onSnapshot en `renderNotesList`
        // detectar√° el cambio y actualizar√° la UI autom√°ticamente.

    } catch (error) {
        console.error("Error sincronizando nota con Firestore:", error);
        showToast("Error de sincronizaci√≥n. Int√©ntalo de nuevo.", true);
        // En caso de error, el usuario ya est√° en la pantalla de la lista,
        // por lo que ver√° que su cambio no se aplic√≥.
    }
}

// ==================================================
// --- M√ìDULO: GASTOS (ACTUALIZADO CON FIRESTORE) ---
// ==================================================
// Las funciones de Gastos se mantienen con la l√≥gica existente,
// pero las llamadas al backend ahora usar√°n las funciones adaptadas a Firestore.

let gastosEncontrados = [];
let pieChartInstance = null, dailyChartInstance = null, monthlyChartInstance = null;

const categoriasGastos = {
    "üè† Gastos del hogar": ["üîë Alquiler o hipoteca", "üí° Servicios (agua, luz, gas, electricidad)", "üåê Internet y tel√©fono", "üîß Mantenimiento y reparaciones", "üõãÔ∏è Mobiliario y electrodom√©sticos"],
    "üßæ Gastos personales": ["üõí Alimentaci√≥n y supermercado", "üëï Ropa y calzado", "üíä Salud (seguros, medicamentos, Farmacia, consultas)", "üéì Educaci√≥n y formaci√≥n", "üíà Cuidado personal (peluquer√≠a, cosm√©tica)"],
    "üöó Transporte": ["‚õΩ Combustible", "üöå Transporte p√∫blico", "üõ°Ô∏è Seguro del veh√≠culo", "üõ†Ô∏è Mantenimiento y reparaciones", "üÖøÔ∏è Estacionamiento y peajes"],
    "üçΩÔ∏è Entretenimiento y ocio": ["‚òï Restaurantes y caf√©s", "üé≠ Cine, teatro, conciertos", "üì∫ Suscripciones (Netflix, Spotify, etc.)", "‚úàÔ∏è Vacaciones y viajes", "‚öΩ Actividades deportivas o hobbies"],
    "üíº Finanzas y seguros": ["üí≥ Pr√©stamos o cr√©ditos", "üìà Ahorros e inversiones", "üìÑ Seguros (vida, hogar, salud, etc.)", "üí∏ Impuestos y tasas"],
    "üéÅ Otros": ["üéâ Regalos y celebraciones", "‚ù§Ô∏è Donaciones o caridad", "üêæ Mascotas (comida, veterinario, etc.)"]
};

function renderInstructionScreen() {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üì∑ Registrar Gasto con Foto</h2></div>
            <div class="form-card" style="text-align: left;">
                <p style="margin-bottom: 20px; line-height: 1.5; color: var(--muted);">Sigue estos pasos para un an√°lisis r√°pido y preciso de tu ticket:</p>
                <ol style="padding-left: 20px; margin-bottom: 30px;">
                    <li style="margin-bottom: 10px;">Primero, sal de la app y saca una foto n√≠tida y bien iluminada de tu ticket con la c√°mara de tu tel√©fono.</li>
                    <li>Luego, vuelve aqu√≠ y pulsa el bot√≥n de abajo para subir esa foto desde tu galer√≠a.</li>
                </ol>
                <div class="add-article-btn-container" style="padding: 0;">
                    <button class="add-article-btn enabled" id="scan-ticket-button" style="width:100%; max-width:100%;">
                        Subir Ticket desde Galer√≠a üñºÔ∏è
                    </button>
                </div>
            </div>
        </div>`;
    
    // Asignamos la acci√≥n directamente al bot√≥n, que ahora abre la galer√≠a.
    document.getElementById('scan-ticket-button').onclick = triggerFileInput;
}
function triggerFileInput() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';

    fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('image-preview-element').src = e.target.result;
            document.getElementById('image-preview-overlay').style.display = 'flex';
        };
        reader.readAsDataURL(file);
    };

    document.body.appendChild(fileInput);
    fileInput.click();
    
    // Limpiamos el input del DOM para evitar problemas en futuras aperturas.
    window.addEventListener('focus', () => {
        if (document.body.contains(fileInput)) {
            document.body.removeChild(fileInput);
        }
    }, { once: true });
}

async function handleImageScan() {
    if (!selectedImageFile) {
        showToast('No se ha seleccionado ninguna imagen.', true);
        return;
    }

    const sendBtn = document.getElementById('preview-send-btn');
    const originalBtnHTML = sendBtn.innerHTML;
    
    // Activamos el spinner en el bot√≥n. El overlay de previsualizaci√≥n NO se cierra.
    sendBtn.disabled = true;
    sendBtn.innerHTML = `<span class="spinner btn-spinner"></span> Procesando...`;

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    try {
        const imageBase64 = await toBase64(selectedImageFile);
        const functions = firebase.app().functions('europe-west1');
        const scanTicketFunction = functions.httpsCallable('processTicketScan');
        
        const result = await scanTicketFunction({ imageBase64: imageBase64 });
        const resultData = result.data;

        // Si la respuesta es un gasto v√°lido, cerramos el overlay y renderizamos el formulario
        if (resultData && resultData.tipo && resultData.tipo.toUpperCase() === 'GASTO') {
            document.getElementById('image-preview-overlay').style.display = 'none'; // <-- Cierre del modal aqu√≠
            renderAddGastoForm(resultData);
        } else {
            const errorMessage = resultData?.datos?.motivo || "El ticket no parece ser un gasto v√°lido.";
            showToast(errorMessage, true);
            // Si hay un error, restauramos el bot√≥n para que el usuario pueda intentarlo de nuevo
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalBtnHTML;
        }

    } catch (error) {
        console.error('Error al escanear el ticket v√≠a Cloud Function:', error);
        showToast(`Error al procesar: ${error.message}`, true);
        // Si hay un error, tambi√©n restauramos el bot√≥n
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalBtnHTML;
    } finally {
    // Restauramos el bot√≥n a su estado original, independientemente del resultado
    sendBtn.disabled = false;
    sendBtn.innerHTML = originalBtnHTML;
    // Limpiamos la variable de la imagen seleccionada
    selectedImageFile = null;
}
}

document.getElementById('preview-cancel-btn').onclick = () => {
    document.getElementById('image-preview-overlay').style.display = 'none';
    selectedImageFile = null;
};
document.getElementById('preview-send-btn').onclick = handleImageScan;

function renderAddGastoForm(initialData = null) {
    navigationHistory.push(renderDashboard);
    updateBackButton();
    const data = initialData ? initialData.datos : {};
    const categoriasOptions = Object.keys(categoriasGastos).map(cat => `<option value="${cat}" ${data.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üí∞ Nuevo Gasto</h2></div>
            <div class="form-card" id="item-new">
                <label>Importe</label> <input type="number" id="gasto-importe" placeholder="Ej: 15.50" step="0.01" value="${data.importe_total || ''}" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" placeholder="Ej: Supermercado" value="${data.establecimiento || ''}" required />
                <label>Categor√≠a</label>
                <select id="gasto-categoria" required><option value="">-- Selecciona una categor√≠a --</option>${categoriasOptions}</select>
                <label>Subcategor√≠a</label>
                <select id="gasto-subcategoria" required disabled><option value="">-- Selecciona una subcategor√≠a --</option></select>
                <label>Fecha</label> <div class="flatpickr-wrapper"><input type="text" id="gasto-fecha" required data-input/></div>
                <div class="button-group">
                    <button id="cancel-gasto-btn" class="cancel">Cancelar</button>
                    <button id="save-gasto-btn" disabled>Registrar Gasto</button>
                </div>
            </div>
        </div>`;

    document.getElementById('cancel-gasto-btn').onclick = goBack;
    const categoriaSelect = document.getElementById('gasto-categoria'), subcategoriaSelect = document.getElementById('gasto-subcategoria'), saveBtn = document.getElementById('save-gasto-btn');
    const elementsToValidate = [ document.getElementById('gasto-importe'), document.getElementById('gasto-establecimiento'), document.getElementById('gasto-fecha'), categoriaSelect, subcategoriaSelect ];
    function validateGastoForm() { const allValid = elementsToValidate.every(el => el.value && el.value.trim() !== ''); saveBtn.disabled = !allValid; saveBtn.classList.toggle('enabled', allValid); }
    let defaultDate = new Date();
    if(data.fecha) {
        const dateTimeParts = data.fecha.split(' ');
        const dateParts = dateTimeParts[0].split('/');
        if(dateParts.length === 3) {
            const year = parseInt(dateParts[2], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[0], 10);
            if(dateTimeParts.length > 1) {
                const timeParts = dateTimeParts[1].split(':');
                if(timeParts.length >= 2) {
                    const hours = parseInt(timeParts[0], 10);
                    const minutes = parseInt(timeParts[1], 10);
                    defaultDate = new Date(year, month, day, hours, minutes);
                } else {
                   defaultDate = new Date(year, month, day);
                }
            } else {
                defaultDate = new Date(year, month, day);
            }
        }
    }
    flatpickr(document.querySelector("#gasto-fecha").parentElement, { 
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    disableMobile: true, 
    defaultDate: defaultDate, 
    dateFormat: "d/m/Y H:i", 
    enableTime: true, 
    locale: "es", 
    onChange: validateGastoForm 
});
    // Asignamos los listeners para validaci√≥n manual
elementsToValidate.forEach(el => el.addEventListener('input', validateGastoForm));

categoriaSelect.onchange = () => {
    const selectedCategory = categoriaSelect.value;
    subcategoriaSelect.innerHTML = '<option value="">-- Selecciona una subcategor√≠a --</option>';
    if (selectedCategory && categoriasGastos[selectedCategory]) {
        const subcategoriasOptions = categoriasGastos[selectedCategory].map(sub => `<option value="${sub}">${sub}</option>`).join('');
        subcategoriaSelect.innerHTML += subcategoriasOptions;
        subcategoriaSelect.disabled = false;
    } else {
        subcategoriaSelect.disabled = true;
    }
    validateGastoForm();
};
// A√±adimos el listener que faltaba para la selecci√≥n manual de subcategor√≠a
subcategoriaSelect.onchange = validateGastoForm;

saveBtn.onclick = () => saveGasto();

// L√≥gica de inicializaci√≥n con datos del ticket
if (initialData) {
    // Disparamos el cambio de categor√≠a para poblar las subcategor√≠as
    categoriaSelect.dispatchEvent(new Event('change'));
    
    // Esperamos un instante para que el DOM se actualice con las nuevas opciones
    setTimeout(() => {
        if (data.subcategoria) {
            subcategoriaSelect.value = data.subcategoria;
        }
        // Ahora, con todos los datos en su sitio, forzamos la validaci√≥n final.
        validateGastoForm();
    }, 0);
} else {
    // Si no hay datos iniciales, validamos para establecer el estado inicial del bot√≥n.
    validateGastoForm();
}
}

async function saveGasto() {
    const saveBtn = document.getElementById('save-gasto-btn');
    const originalBtnHTML = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = `<span class="spinner btn-spinner"></span> Registrando...`;

    try {
        const fechaGastoObj = document.getElementById('gasto-fecha').parentElement._flatpickr.selectedDates[0];
        const importe = parseFloat(document.getElementById('gasto-importe').value.replace(',', '.'));
        const establecimiento = document.getElementById('gasto-establecimiento').value;
        const categoria = document.getElementById('gasto-categoria').value;
        const subCategoria = document.getElementById('gasto-subcategoria').value;
        const mesAnio = `${(fechaGastoObj.getMonth() + 1).toString().padStart(2, '0')}/${fechaGastoObj.getFullYear()}`;

        const gastoData = { importe, establecimiento, categoria, subCategoria, fecha: fechaGastoObj, mesAnio: mesAnio };

        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        const newGastoRef = db.collection('users').doc(chatId).collection('gastos').doc(generateCustomId('G-'));

        // Transacci√≥n robusta: crea o actualiza el documento de contadores.
await db.runTransaction(async (transaction) => {
    const countsDoc = await transaction.get(countsRef);

    // Primero, siempre creamos el nuevo gasto.
    transaction.set(newGastoRef, gastoData);

    if (countsDoc.exists) {
        // Si el documento de contadores EXISTE, lo actualizamos.
        const currentCounts = countsDoc.data();
        const nuevoTotalGastos = (currentCounts.gastosMesActual || 0) + importe;
        const mesesActivos = currentCounts.mesesActivosGastos || [];
        if (!mesesActivos.includes(mesAnio)) {
            mesesActivos.push(mesAnio);
        }
        transaction.update(countsRef, { 
            gastosMesActual: nuevoTotalGastos, 
            mesesActivosGastos: mesesActivos 
        });
    } else {
        // Si el documento NO EXISTE, lo creamos con los valores iniciales.
        transaction.set(countsRef, {
            gastosMesActual: importe,
            mesesActivosGastos: [mesAnio]
        });
    }
});

        // Se actualiza la UI local SOLO si la transacci√≥n tuvo √©xito.
        appData.counts.gastosMesActual = (parseFloat(appData.counts.gastosMesActual) || 0) + importe;
        if (!appData.counts.mesesActivosGastos.includes(mesAnio)) {
            appData.counts.mesesActivosGastos.push(mesAnio);
        }

        goBack();

        setTimeout(() => {
            showToast('Gasto registrado con √©xito.');
        }, 100);

    } catch (err) {
        console.error("Error en saveGasto():", err);
        showToast(`Error: ${err.message}.`, true);
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnHTML;
    }
}

function renderGastoChart() {
  navigationHistory.push(renderDashboard);
  updateBackButton();

  const mesesOrdenados = (appData.counts.mesesActivosGastos || []).sort((a, b) => {
      const [mesA, anioA] = a.split('/');
      const [mesB, anioB] = b.split('/');
      return new Date(anioB, mesB - 1) - new Date(anioA, mesA - 1);
  });
  
  const mesesOptions = mesesOrdenados.map(mes => `<option value="${mes}">${mes}</option>`).join('');
  
  mainContentArea.innerHTML = `
    <div class="list-container">
      <div class="list-header"><h2>An√°lisis de Gastos</h2></div>
      <div class="form-card">
        <label>Detalle por Mes</label>
        <select id="gasto-chart-mes-select"><option value="">-- Selecciona un mes para ver gr√°ficos --</option>${mesesOptions}</select>
        <div class="gasto-chart-container" id="chart-container-pie" style="margin-top:20px; display:none;"><canvas id="pieChartCanvas"></canvas></div>
        <ul class="gasto-legend" id="gasto-legend-container"></ul>
        <hr style="margin: 25px 0; border-top: 1px solid #eee; display:none;" id="hr1">
        <div class="gasto-chart-container" id="chart-container-daily" style="position: relative; height:300px; display:none;"><canvas id="dailyChartCanvas"></canvas></div>
        <hr style="margin: 25px 0; border-top: 1px solid #eee; display:none;" id="hr2">
        <div class="gasto-chart-container" id="chart-container-monthly" style="position: relative; height:300px; display:none;"><canvas id="monthlyChartCanvas"></canvas></div>
      </div>
    </div>`;
  document.getElementById('gasto-chart-mes-select').onchange = fetchAndDisplayGastoChart;
}

async function fetchAndDisplayGastoChart(event) {
    const mesAnio = event.target.value;
    if (pieChartInstance) pieChartInstance.destroy();
    if (dailyChartInstance) dailyChartInstance.destroy();
    if (monthlyChartInstance) monthlyChartInstance.destroy();
    
    document.getElementById('gasto-legend-container').innerHTML = '';
    ['chart-container-pie', 'chart-container-daily', 'chart-container-monthly', 'hr1', 'hr2'].forEach(id => document.getElementById(id).style.display = 'none');
    
    if (!mesAnio) return;
    
    showSpinner("Generando gr√°ficos...");
    try {
        // --- 1. Obtener datos del mes seleccionado ---
        const [mes, anio] = mesAnio.split('/').map(Number);
        const startDate = new Date(anio, mes - 1, 1);
        const endDate = new Date(anio, mes, 0, 23, 59, 59);

        const gastosRef = db.collection('users').doc(chatId).collection('gastos');
        const qMes = gastosRef.where('fecha', '>=', startDate).where('fecha', '<=', endDate);
        const snapshotMes = await qMes.get();
        const gastosDelMes = snapshotMes.docs.map(doc => ({ ...doc.data(), id: doc.id }));

        // --- 2. Obtener datos de los √∫ltimos 6 meses para el gr√°fico de barras ---
        const monthlyEndDate = new Date();
        const monthlyStartDate = new Date();
        monthlyStartDate.setMonth(monthlyStartDate.getMonth() - 5);
        monthlyStartDate.setDate(1);

        const qMonthly = gastosRef.where('fecha', '>=', monthlyStartDate).where('fecha', '<=', monthlyEndDate);
        const snapshotMonthly = await qMonthly.get();
        const gastosUltimosMeses = snapshotMonthly.docs.map(doc => doc.data());

        // --- 3. Procesar todos los datos ---
        const data = procesarDatosParaGrafico(gastosDelMes, gastosUltimosMeses, mesAnio);
        if (data.error) throw new Error(data.error);
        
        // --- 4. Dibujar los gr√°ficos ---
        Chart.register(ChartDataLabels);
        const paletaDeColores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        const moneda = appData.settings.moneda || '‚Ç¨';
        
        // Gr√°fico de Pastel (Pie Chart)
        if (data.pieData && data.pieData.data.length > 0) {
            document.getElementById('chart-container-pie').style.display = 'block';
            const pieCtx = document.getElementById('pieChartCanvas').getContext('2d');
            pieChartInstance = new Chart(pieCtx, { type: 'pie', data: { labels: data.pieData.labels, datasets: [{ data: data.pieData.data, backgroundColor: paletaDeColores, borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, plugins: { title: { display: true, text: data.tituloPie + ' ' + moneda, font: { size: 18 } }, legend: { display: false }, datalabels: { formatter: (v,c) => { const total = c.chart.data.datasets[0].data.reduce((a,b) => a+b,0); return total > 0 ? (v/total*100).toFixed(0)+'%' : '0%';}, color:'#fff',font:{weight:'bold',size:16}}, tooltip: { callbacks: { label: c => `${c.label}: ${parseFloat(c.raw).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})} ${moneda}`}}}}});
            document.getElementById('gasto-legend-container').innerHTML = data.datosParaLeyenda.map(item => `<li class="gasto-legend-item"><span class="gasto-legend-color" style="background-color:${item.color};"></span><div>${item.categoria}: <strong>${item.importe} ${moneda}</strong></div></li>`).join('');
        }

        // Gr√°fico de L√≠neas (Evoluci√≥n Diaria)
        if (data.dailyData && data.dailyData.data.length > 0) {
            document.getElementById('hr1').style.display = 'block';
            document.getElementById('chart-container-daily').style.display = 'block';
            const dailyCtx = document.getElementById('dailyChartCanvas').getContext('2d');
            dailyChartInstance = new Chart(dailyCtx, { type: 'line', data: { labels: data.dailyData.labels, datasets: [{ label: 'Gasto Diario (' + moneda + ')', data: data.dailyData.data, borderColor: '#4BC0C0', fill: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `Evoluci√≥n Diaria - ${mesAnio}`, font: { size: 18 } }, legend: { display: false }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.formattedValue} ${moneda}`}}}}});
        }
        
        // Gr√°fico de Barras (Comparativa Mensual)
        if (data.monthlyData && data.monthlyData.data.length > 0) {
            document.getElementById('hr2').style.display = 'block';
            document.getElementById('chart-container-monthly').style.display = 'block';
            const monthlyCtx = document.getElementById('monthlyChartCanvas').getContext('2d');
            monthlyChartInstance = new Chart(monthlyCtx, { type: 'bar', data: { labels: data.monthlyData.labels, datasets: [{ label: 'Gasto Mensual (' + moneda + ')', data: data.monthlyData.data, backgroundColor: '#36A2EB' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Evoluci√≥n de Gastos Mensuales', font: { size: 18 } }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.formattedValue} ${moneda}`}}}}});
        }

    } catch (err) {
        showToast(`No se pudo generar el gr√°fico: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function procesarDatosParaGrafico(gastosDelMes, gastosUltimosMeses, mesAnioSeleccionado) {
    // --- L√≥gica para Gr√°fico de Pastel y Leyenda ---
    const datosParaLeyenda = [];
    const gastosPorCategoria = gastosDelMes.reduce((acc, gasto) => {
        const cat = gasto.categoria || 'Sin categor√≠a';
        acc[cat] = (acc[cat] || 0) + (gasto.importe || 0);
        return acc;
    }, {});
    const pieData = { labels: Object.keys(gastosPorCategoria), data: Object.values(gastosPorCategoria) };
    const paletaDeColores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    pieData.labels.forEach((label, index) => {
        datosParaLeyenda.push({ categoria: label, importe: pieData.data[index].toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), color: paletaDeColores[index % paletaDeColores.length] });
    });
    const totalGastosMes = gastosDelMes.reduce((sum, g) => sum + (g.importe || 0), 0);
    
    // --- L√≥gica para Gr√°fico de L√≠neas (Evoluci√≥n Diaria) ---
    const diasEnMes = new Date(mesAnioSeleccionado.split('/')[1], mesAnioSeleccionado.split('/')[0], 0).getDate();
    const dailyData = { labels: Array.from({ length: diasEnMes }, (_, i) => i + 1), data: Array(diasEnMes).fill(0) };
    gastosDelMes.forEach(gasto => {
        if (gasto.fecha && typeof gasto.fecha.toDate === 'function') {
            const dia = gasto.fecha.toDate().getDate();
            dailyData.data[dia - 1] += gasto.importe || 0;
        }
    });

    // --- L√≥gica para Gr√°fico de Barras (Comparativa Mensual) ---
    const monthlyData = { labels: [], data: [] };
    const gastosPorMes = {};
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const mes = (d.getMonth() + 1).toString().padStart(2, '0');
        const anio = d.getFullYear();
        monthlyData.labels.push(`${mes}/${anio}`);
        gastosPorMes[`${mes}/${anio}`] = 0;
    }
    gastosUltimosMeses.forEach(gasto => {
        if (gasto.mesAnio && gastosPorMes.hasOwnProperty(gasto.mesAnio)) {
            gastosPorMes[gasto.mesAnio] += gasto.importe || 0;
        }
    });
    monthlyData.data = Object.values(gastosPorMes);

    return {
        pieData,
        datosParaLeyenda,
        tituloPie: `Total Gastos ${mesAnioSeleccionado}: ${totalGastosMes.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
        dailyData,
        monthlyData
    };
}

function renderGastosSearchScreen(gastos = null) {
	updateBackButton();
    let resultsHtml = '';
    let legendDisplay = 'none';

    if (gastos) {
        if (gastos.length > 0) {
            // L√çNEA CORREGIDA: Se usan los nombres de campo correctos (min√∫sculas y 'Fecha' may√∫scula)
            resultsHtml = gastos.map(g => `<li class="list-item clickable" data-id-unico="${g.ID_Unico}"><div class="list-item-content"><span class="list-item-title">${g.establecimiento} - ${Number(g.importe).toLocaleString('es-ES', {minimumFractionDigits: 2})} ${(appData.settings.moneda || '‚Ç¨')}</span><span class="list-item-subtitle">${g.subCategoria || g.categoria} - ${g.Fecha}</span></div></li>`).join('');
            resultsHtml = `<ul class="list-style-none">${resultsHtml}</ul>`;
            legendDisplay = 'block';
        } else {
            resultsHtml = `<div class="no-data-msg" style="padding: 20px;">No se encontraron gastos.</div>`;
        }
    }

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üîé Buscar Gastos</h2></div>
            <div class="form-card">
                <label>Fecha de Inicio</label> <div class="flatpickr-wrapper"><input type="text" id="gasto-fecha-inicio" required data-input/></div>
                <label>Fecha de Fin</label> <div class="flatpickr-wrapper"><input type="text" id="gasto-fecha-fin" required data-input/></div>
                <button id="search-gasto-btn" class="enabled">Buscar</button>
            </div>
            <p style="text-align: center; color: var(--muted); font-size: 0.9rem; margin-top: 15px; display: ${legendDisplay};">Pulsa sobre un gasto para ver/editarlo</p>
            <div id="gastos-search-results" style="margin-top: 10px;">${resultsHtml}</div>
        </div>`;
        
    flatpickr(document.querySelector("#gasto-fecha-inicio").parentElement, {
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    dateFormat: "d/m/Y",
    defaultDate: new Date(new Date().setDate(1))
});
	flatpickr(document.querySelector("#gasto-fecha-fin").parentElement, {
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    dateFormat: "d/m/Y",
    defaultDate: new Date()
});
    
    document.getElementById('search-gasto-btn').onclick = executeSearchGastos;
    
    document.getElementById('gastos-search-results').addEventListener('click', (e) => {
        const item = e.target.closest('.list-item.clickable');
        if (item) {
            const idUnico = item.dataset.idUnico;
            const gasto = gastosEncontrados.find(g => g.ID_Unico === idUnico);
            if(gasto) {
                navigationHistory.push(() => renderGastosSearchScreen(gastosEncontrados));
                updateBackButton();
                renderEditGastoForm(gasto);
            }
        }
    });
}

async function executeSearchGastos() {
    const startDateString = document.getElementById('gasto-fecha-inicio').value;
    const endDateString = document.getElementById('gasto-fecha-fin').value;
    if (!startDateString || !endDateString) {
        showToast('Debes seleccionar ambas fechas.', true);
        return;
    }

    showSpinner("Buscando gastos...");

    try {
        const startParts = startDateString.split('/');
        const endParts = endDateString.split('/');
        const startDateObj = new Date(startParts[2], startParts[1] - 1, startParts[0], 0, 0, 0);
        const endDateObj = new Date(endParts[2], endParts[1] - 1, endParts[0], 23, 59, 59);

        const gastosRef = db.collection('users').doc(chatId).collection('gastos');
        const q = gastosRef.where('fecha', '>=', startDateObj).where('fecha', '<=', endDateObj);
        const snapshot = await q.get();

        gastosEncontrados = snapshot.docs.map(doc => {
            const data = doc.data();
            const fechaGasto = (data.fecha && typeof data.fecha.toDate === 'function') ? data.fecha.toDate() : null;
            
            return {
                ...data,
                ID_Unico: doc.id,
                Fecha: fechaGasto ? fechaGasto.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'Fecha inv√°lida'
            };
        });
        
        // Ordenar resultados por fecha, m√°s reciente primero
        gastosEncontrados.sort((a, b) => {
            const dateA = a.fecha && a.fecha.toDate ? a.fecha.toDate() : 0;
            const dateB = b.fecha && b.fecha.toDate ? b.fecha.toDate() : 0;
            return dateB - dateA;
        });

        renderGastosSearchScreen(gastosEncontrados);

    } catch (err) {
        console.error("Error al buscar gastos:", err);
        showToast(`Error al buscar gastos: ${err.message}`, true);
        renderGastosSearchScreen([]);
    } finally {
        hideSpinner();
    }
}

function renderEditGastoForm(gasto) {
    updateBackButton();
    
    // CORREGIDO: Se usan los nombres de campo en min√∫scula
    const categoriasOptions = Object.keys(categoriasGastos).map(cat => `<option value="${cat}" ${gasto.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
    const subcategoriasOptions = (categoriasGastos[gasto.categoria] || []).map(sub => `<option value="${sub}" ${gasto.subCategoria === sub ? 'selected' : ''}>${sub}</option>`).join('');
    
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>‚úèÔ∏è Ver/Editar Gasto</h2></div>
            <div class="form-card" id="item-${gasto.ID_Unico}">
                <label>Importe</label> <input type="number" id="gasto-importe" value="${gasto.importe}" step="0.01" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" value="${gasto.establecimiento}" required />
                <label>Categor√≠a</label> <select id="gasto-categoria" required>${categoriasOptions}</select>
                <label>Subcategor√≠a</label> <select id="gasto-subcategoria" required>${subcategoriasOptions}</select>
                <label>Fecha</label> <div class="flatpickr-wrapper"><input type="text" id="gasto-fecha" required data-input/></div>
                <div class="button-group">
                    <button id="delete-gasto-btn" class="cancel">Eliminar</button>
                    <button id="save-gasto-btn" disabled>Guardar Cambios</button>
                </div>
            </div>
        </div>`;
    
    const fechaPicker = flatpickr(document.querySelector("#gasto-fecha").parentElement, { 
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    disableMobile: true, 
    defaultDate: gasto.Fecha, 
    dateFormat: "d/m/Y H:i", 
    enableTime: true, 
    locale: "es" 
});
    const categoriaSelect = document.getElementById('gasto-categoria');
    const subcategoriaSelect = document.getElementById('gasto-subcategoria');
    const importeInput = document.getElementById('gasto-importe');
    const establecimientoInput = document.getElementById('gasto-establecimiento');
    const saveBtn = document.getElementById('save-gasto-btn');
    
    // CORREGIDO: Se usan los nombres de campo en min√∫scula
    const initialValues = { importe: importeInput.value, establecimiento: establecimientoInput.value, categoria: categoriaSelect.value, subcategoria: subcategoriaSelect.value, fecha: fechaPicker.input.value };

    function validateChanges() {
        const currentValues = { importe: importeInput.value, establecimiento: establecimientoInput.value, categoria: categoriaSelect.value, subcategoria: subcategoriaSelect.value, fecha: fechaPicker.input.value };
        const hasChanged = JSON.stringify(initialValues) !== JSON.stringify(currentValues);
        saveBtn.disabled = !hasChanged;
        saveBtn.classList.toggle('enabled', hasChanged);
    }

    [importeInput, establecimientoInput, categoriaSelect, subcategoriaSelect].forEach(el => el.addEventListener('input', validateChanges));
    fechaPicker.config.onChange.push(validateChanges);
    
    categoriaSelect.onchange = () => {
        const selectedCategory = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">-- Selecciona una subcategor√≠a --</option>';
        if (selectedCategory && categoriasGastos[selectedCategory]) {
            subcategoriaSelect.innerHTML += categoriasGastos[selectedCategory].map(sub => `<option value="${sub}">${sub}</option>`).join('');
            subcategoriaSelect.disabled = false;
        } else {
            subcategoriaSelect.disabled = true;
        }
        validateChanges();
    };

    document.getElementById('save-gasto-btn').onclick = () => saveEditedGasto(gasto.ID_Unico);
    document.getElementById('delete-gasto-btn').onclick = () => confirmDelete('gasto', gasto.ID_Unico);
}

/**
 * Guarda un gasto editado, actualiza el documento existente y recalcula los contadores.
 * VERSI√ìN CORREGIDA Y COMPLETA.
 */
async function saveEditedGasto(idUnico) {
    showSpinner("Guardando cambios...");
    try {
        const gastoOriginal = gastosEncontrados.find(g => g.ID_Unico === idUnico);
        if (!gastoOriginal) {
            throw new Error("No se encontr√≥ el gasto original para calcular la diferencia.");
        }

        const importeAntiguo = parseFloat(gastoOriginal.importe);
        const nuevoImporte = parseFloat(document.getElementById('gasto-importe').value);
        const diferencia = nuevoImporte - importeAntiguo;

        const nuevoEstablecimiento = document.getElementById('gasto-establecimiento').value;
        const nuevaCategoria = document.getElementById('gasto-categoria').value;
        const nuevaSubcategoria = document.getElementById('gasto-subcategoria').value;
        const fechaGastoObj = document.getElementById('gasto-fecha').parentElement._flatpickr.selectedDates[0];
        const mesAnio = `${(fechaGastoObj.getMonth() + 1).toString().padStart(2, '0')}/${fechaGastoObj.getFullYear()}`;

        const gastoActualizado = { 
            importe: nuevoImporte, 
            establecimiento: nuevoEstablecimiento, 
            categoria: nuevaCategoria, 
            subCategoria: nuevaSubcategoria, 
            fecha: fechaGastoObj,
            mesAnio: mesAnio
        };

        const gastoRef = db.collection('users').doc(chatId).collection('gastos').doc(idUnico);
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');

        // Usar un batch para actualizar el gasto y el contador en una sola operaci√≥n at√≥mica.
        const batch = db.batch();
        batch.update(gastoRef, gastoActualizado);
        batch.update(countsRef, {
            gastosMesActual: firebase.firestore.FieldValue.increment(diferencia)
        });
        await batch.commit();
        
        // Actualizar la UI localmente para una respuesta instant√°nea
        appData.counts.gastosMesActual += diferencia;
        
        goBack(); // Vuelve a la lista de b√∫squeda
        goBack(); // Vuelve al dashboard
        renderDashboard(); // Re-renderiza el dashboard para mostrar el nuevo total
        showToast("Gasto actualizado con √©xito.");

    } catch (err) {
        showToast(`Error al guardar: ${err.message}.`, true);
        initializeApp(); // Recarga completa en caso de error grave.
    } finally {
        hideSpinner();
    }
}

// ==================================================
// --- M√ìDULO: CHEF ASISTENTE (VERSI√ìN FINAL) ---
// ==================================================
function renderChefPage() {
    removeCalendarFAB();
	setActiveTab('tab-chef');
    mainContentArea.removeEventListener('click', handleChefResultsClicks); // <-- L√çNEA A√ëADIDA: Limpia el listener anterior
    navigationHistory.push(renderDashboard);
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="chef-container">
            <h2 class="settings-section-title">üßë‚Äçüç≥ Chef Asistente</h2>
            <div class="form-card">
                <div class="chef-item">
                    <label>Tipo de Comida</label>
                    <select id="chef-tipo-comida">
                        <option value="Desayuno">üç≥ Desayuno</option>
                        <option value="Almuerzo" selected>ü•ó Almuerzo</option>
                        <option value="Merienda">ü•™ Merienda</option>
                        <option value="Cena">üçù Cena</option>
                    </select>
                </div>
                <div class="chef-item">
                    <label>Fecha y Hora</label>
                    <div class="flatpickr-wrapper"><input type="text" id="chef-fecha-comida" style="width: 150px; text-align: center;" data-input/></div>
                </div>
                <div class="chef-item">
                    <label>N¬∫ de Comensales</label>
                    <input type="number" id="chef-comensales" value="1" min="1" style="width: 80px; text-align: center;"/>
                </div>
                <div class="chef-item">
                    <label>Estilo de Cocina</label>
                    <select id="chef-estilo">
                        <option value="Sorpr√©ndeme">‚ú® Sorpr√©ndeme</option>
                        <option value="R√°pida">üèÉ R√°pida</option>
                        <option value="Casera">üè° Casera</option>
                        <option value="Saludable">üí™ Saludable</option>
                    </select>
                </div>
                <div class="chef-item">
                    <label>¬øIncluir Postre?</label>
                    <label class="switch"><input type="checkbox" id="chef-postre"><span class="slider"></span></label>
                </div>
                <div class="chef-item">
                    <label>Solo con lo que tengo</label>
                    <label class="switch"><input type="checkbox" id="chef-solo-nevera"><span class="slider"></span></label>
                </div>
                <label style="margin-top: 20px;">Tu Petici√≥n Especial</label>
                <textarea id="chef-peticion" rows="3" placeholder="Ej: soy vegano, alergia al marisco, usa el pollo antes de que caduque..."></textarea>
                
                <div id="chef-image-previews"></div>
                <div class="button-group" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
				<div style="margin-top: 20px; text-align: left; font-size: 0.9rem; color: var(--muted);">
				<ol style="padding-left: 20px;">
				<li>Primero, saca una foto de tus ingredientes/nevera con buena luz.</li>
				<li>Luego, pulsa el bot√≥n de abajo para subirla desde tu galer√≠a.</li>
				</ol>
				</div>
				<div class="add-article-btn-container" style="margin-top: 15px;">
				<button class="add-article-btn enabled" id="chef-upload-button">Subir Foto desde Galer√≠a üñºÔ∏è</button>
				</div>

                <div class="button-group">
                    <button id="chef-cancel-btn" class="cancel">Cancelar/Salir</button>
                    <button id="chef-submit-btn" class="enabled">Obtener Sugerencias</button>
                </div>
            </div>
        </div>`;

    const now = new Date();
    const maxDateForChef = new Date();
    maxDateForChef.setDate(now.getDate() + 3);

    flatpickr(document.querySelector("#chef-fecha-comida").parentElement, {
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    enableTime: true,
    altInput: true,
    altFormat: "D, j M H:i",
    dateFormat: "Z",
    time_24hr: true,
    defaultDate: now,
    minDate: now,
    maxDate: maxDateForChef
});

    document.getElementById('chef-cancel-btn').onclick = goBack;
    
    let selectedFiles = [];

    const previewsContainer = document.getElementById('chef-image-previews');
    
    const updatePreviews = () => {
        previewsContainer.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="preview">
                    <button class="delete-preview-btn" data-index="${index}">&times;</button>
                `;
                previewsContainer.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
    };

    previewsContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('delete-preview-btn')) {
            const index = parseInt(event.target.dataset.index, 10);
            selectedFiles.splice(index, 1);
            updatePreviews();
        }
    });

    document.getElementById('chef-upload-button').onclick = () => {
        if (selectedFiles.length >= 2) {
            showToast("Puedes subir un m√°ximo de 2 fotos.", true);
            return;
        }
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                handleChefImageSelection(file, (confirmedFile) => {
                    selectedFiles.push(confirmedFile);
                    updatePreviews();
                });
            }
        };
        document.body.appendChild(fileInput);
        fileInput.click();
        
        setTimeout(() => {
             if (document.body.contains(fileInput)) {
                document.body.removeChild(fileInput);
            }
        }, 1000);
    };
    
    document.getElementById('chef-submit-btn').onclick = () => {
        if(selectedFiles.length === 0) {
            showToast("Por favor, sube una foto de tus ingredientes.", true);
            return;
        }
        executeChefRequest(selectedFiles);
    };
}

function handleChefImageSelection(file, callback) {
    // Utilizamos los nuevos IDs exclusivos para el modal del Chef
    const overlay = document.getElementById('chef-image-preview-overlay');
    const imgElement = document.getElementById('chef-image-preview-element');
    const sendBtn = document.getElementById('chef-preview-send-btn');
    const cancelBtn = document.getElementById('chef-preview-cancel-btn');

    const reader = new FileReader();
    reader.onload = (e) => {
        imgElement.src = e.target.result;
        overlay.style.display = 'flex';
    };
    reader.readAsDataURL(file);

    // La funci√≥n de limpieza ahora es mucho m√°s simple y autocontenida
    const cleanup = () => {
        overlay.style.display = 'none';
        // Ya no necesitamos restaurar los handlers de otros flujos, evitando conflictos.
    };

    // Asignamos las acciones a los botones del modal del Chef
    sendBtn.onclick = () => {
        callback(file); // Ejecuta la acci√≥n de a√±adir la foto a las previsualizaciones
        cleanup();      // Cierra y limpia el modal
    };

    cancelBtn.onclick = () => {
        cleanup();      // Simplemente cierra y limpia el modal
    };
}

// [VERSI√ìN FINAL CON CLOUD FUNCTIONS - CORREGIDA]
// Esta funci√≥n ahora se comunica directamente con nuestro propio backend en Firebase.
// [VERSI√ìN FINAL CON CLOUD FUNCTIONS - CORREGIDA]
// Esta funci√≥n ahora se comunica directamente con nuestro propio backend en Firebase.
async function executeChefRequest(files) {
    // --- INICIO DE LA MODIFICACI√ìN CLAVE ---
    const submitBtn = document.getElementById('chef-submit-btn');
    if (!submitBtn) return; // Salida de seguridad si el bot√≥n no existe
    
    const originalBtnHTML = submitBtn.innerHTML; // Guardamos el texto original
    
    // Cambiamos el estado del bot√≥n a "cargando"
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<span class="spinner btn-spinner"></span> Chef trabajando...`;
    // --- FIN DE LA MODIFICACI√ìN CLAVE ---

    const chefFunctionUrl = "https://europe-west1-asistentepersonal-4ad2b.cloudfunctions.net/processChefRequest";

    try {
        const fechaComidaSeleccionada = document.getElementById('chef-fecha-comida').parentElement._flatpickr.selectedDates[0];
        
        if (!fechaComidaSeleccionada) {
            throw new Error("Por favor, selecciona una fecha y hora v√°lidas.");
        }

        const userPreferences = {
            tipoComida: document.getElementById('chef-tipo-comida').value,
            fechaComida: fechaComidaSeleccionada.toISOString(),
            comensales: document.getElementById('chef-comensales').value,
            estilo: document.getElementById('chef-estilo').value,
            conPostre: document.getElementById('chef-postre').checked,
            soloNevera: document.getElementById('chef-solo-nevera').checked,
            peticionUsuario: document.getElementById('chef-peticion').value,
        };

        const imagePromises = files.map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64String = event.target.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        });

        const imagesBase64 = await Promise.all(imagePromises);

        const response = await fetch(chefFunctionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: {
                chatId: chatId,
                userPreferences: userPreferences,
                imagesBase64: imagesBase64,
            }})
        });

        if (!response.ok) {
            const errorBody = await response.json();
            throw new Error(errorBody.error.message || `Error del servidor: ${response.status}`);
        }

        const result = await response.json();
        const data = result.result;
        
        if (data && data.sugerencias) {
            data.sugerencias.forEach(sug => {
                if (sug.instrucciones_preparacion && Array.isArray(sug.instrucciones_preparacion)) {
                    sug.instrucciones_preparacion = sug.instrucciones_preparacion
                        .filter(step => typeof step === 'string' && step.replace(/\s+/g, '').length > 0)
                        .map(step => step.trim());
                }
            });
        }

        if (data && data.sugerencias) {
            showToast("¬°Aqu√≠ tienes tus sugerencias!");
            renderChefResults(data.sugerencias);
        } else {
            throw new Error("Respuesta inesperada del Chef.");
        }

    } catch (err) {
        console.error("Error definitivo en executeChefRequest:", err);
        showToast(err.message || "Error al contactar al Chef.", true);
    } finally {
        // --- INICIO DE LA MODIFICACI√ìN CLAVE ---
        // Restauramos el bot√≥n a su estado original, independientemente del resultado.
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHTML;
        // --- FIN DE LA MODIFICACI√ìN CLAVE ---
    }
}

function renderChefResults(sugerencias) {
    updateBackButton();
    let html = '<div class="chef-container">';
    if (!sugerencias || sugerencias.length === 0) {
        html += '<div class="no-data-msg">üßë‚Äçüç≥<br>El Chef no ha encontrado sugerencias. Int√©ntalo de nuevo con otra foto o petici√≥n.</div>';
    } else {
        sugerencias.forEach((sug, index) => {
            html += `
            <div class="recipe-card" id="recipe-${index}">
                <div class="recipe-header"><h3 class="recipe-title">${sug.titulo_receta}</h3></div>
                <div class="recipe-body">
                    <p class="recipe-description">${sug.descripcion}</p>
                    <h4 class="recipe-subtitle">Ingredientes que ya tienes:</h4>
                    <ul class="recipe-ingredient-list">
                        ${(sug.ingredientes_detectados || []).map(ing => `<li>‚úÖ ${ing}</li>`).join('')}
                    </ul>
                    ${sug.ingredientes_a_comprar && sug.ingredientes_a_comprar.length > 0 ? `
                        <h4 class="recipe-subtitle" style="margin-top:15px;">Necesitar√°s comprar:</h4>
                        <ul class="recipe-ingredient-list buy">
                           ${sug.ingredientes_a_comprar.map(ing => `<li><input type="checkbox" class="buy-checkbox" checked data-item-name="${ing.nombre} (${ing.cantidad})"> ${ing.nombre} (${ing.cantidad})</li>`).join('')}
                        </ul>
                        <button class="add-article-btn" data-action="add-ingredients" style="width:100%; max-width:100%; margin-top:15px;">A√±adir seleccionados a la compra</button>
                    ` : '<p style="color:var(--muted); margin-top:15px;">¬°No necesitas comprar nada para esta receta!</p>'}
                    
                    ${sug.instrucciones_preparacion && sug.instrucciones_preparacion.length > 0 ? `
                    <div class="list-item clickable" style="margin-top:20px; text-align:left;" data-action="toggle-instructions" data-target="instructions-${index}">
                        <div class="list-item-content">
                            <span class="list-item-title">üßë‚Äçüç≥ C√≥mo Preparar</span>
                        </div>
                        <div class="list-item-actions"><span class="expand-arrow">‚ñº</span></div>
                    </div>
                    <div id="instructions-${index}" class="event-description" style="padding:15px; background:var(--bg); border-radius:0 0 10px 10px; box-shadow:inset 0 2px 5px rgba(0,0,0,0.02); display:none; max-height:0; overflow:hidden; transition:max-height 0.3s ease-out, padding 0.3s ease-out;">
                        <ol style="padding-left:20px;">
                            ${sug.instrucciones_preparacion
                                .filter(step => typeof step === 'string' && step.trim().length > 0) // Filtra nulos, no-strings y vac√≠os
                                .map(step => `<li>${step.trim()}</li>`)
                                .join('')}
                        </ol>
                    </div>
                ` : ''}

                    <button class="add-article-btn" data-action="copy-recipe" style="background-color: var(--muted); width:100%; max-width:100%; margin-top:10px;">Copiar Receta</button>
                </div>
            </div>`;
        });
    }
    html += `<div class="form-card" style="margin-top: 20px;"><button data-action="go-home" class="cancel" style="width:100%; max-width:100%; opacity:1; cursor:pointer;">Volver a Inicio</button></div>`;
    html += '</div>';
    
    mainContentArea.innerHTML = html;
    mainContentArea.removeEventListener('click', handleChefResultsClicks);
	            // --- CAMBIO CLAVE: Scroll autom√°tico al inicio de las recetas con retraso ---
    // Esperamos un peque√±o momento para asegurarnos de que el DOM est√© completamente renderizado
    setTimeout(() => {
        const firstRecipeCard = document.getElementById('recipe-0'); // Obtener la primera tarjeta de receta
        if (firstRecipeCard) {
            firstRecipeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            // Como fallback, o si no hay recetas, ir al top del contenedor general del chef
            const chefContainer = document.querySelector('.chef-container');
            if (chefContainer) {
                chefContainer.scrollTop = 0;
            } else {
                mainContentArea.scrollTop = 0;
            }
        }
    }, 100); // Peque√±o retraso de 100ms
    // --- FIN CAMBIO CLAVE ---
    mainContentArea.addEventListener('click', handleChefResultsClicks);
}

function handleChefResultsClicks(event) {
    const button = event.target.closest('[data-action]');
    if (!button) return;
    const action = button.dataset.action;
    switch(action) {
        case 'add-ingredients': addIngredientsToShoppingList(button); break;
        case 'copy-recipe': copyToClipboard(button); break;
        case 'go-home': renderDashboard(); break;
        case 'toggle-instructions': // <--- Nueva acci√≥n para el desplegable
    event.stopPropagation(); // Evitar que el clic se propague m√°s all√° del bot√≥n
    const targetId = button.dataset.target;
    const targetElement = document.getElementById(targetId);
    const parentCard = button.closest('.recipe-card');

    if (targetElement && parentCard) {
        const isOpen = targetElement.style.display === 'block';
        if (isOpen) {
            targetElement.style.maxHeight = '0';
            targetElement.style.padding = '0 15px'; // Restablecer padding al cerrar
            setTimeout(() => { targetElement.style.display = 'none'; }, 300); // Ocultar despu√©s de la transici√≥n
            parentCard.classList.remove('open'); // Quitar clase 'open' del padre
        } else {
            targetElement.style.display = 'block';
            // Forzar el redibujado para que la transici√≥n funcione
            targetElement.offsetHeight; 
            targetElement.style.maxHeight = '500px'; // Un valor suficientemente grande
            targetElement.style.padding = '15px'; // Restaurar padding al abrir
            parentCard.classList.add('open'); // A√±adir clase 'open' al padre
        }
        const arrow = button.querySelector('.expand-arrow');
        if (arrow) {
            arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    }
    break;
    }
}

function copyToClipboard(buttonElement) {
    const recipeCard = buttonElement.closest('.recipe-card');
    const title = recipeCard.querySelector('.recipe-title').innerText;
    const description = recipeCard.querySelector('.recipe-description').innerText;
    let textToCopy = `Receta: ${title}\n\n${description}\n\n`;
    const detectedIngredients = Array.from(recipeCard.querySelectorAll('.recipe-ingredient-list:not(.buy) li')).map(li => `- ${li.innerText.replace('‚úÖ ', '')}`);
    if(detectedIngredients.length > 0) textToCopy += `Ingredientes en casa:\n${detectedIngredients.join('\n')}\n\n`;
    const toBuyIngredients = Array.from(recipeCard.querySelectorAll('.recipe-ingredient-list.buy li')).map(li => `- ${li.innerText.trim()}`);
    if(toBuyIngredients.length > 0) textToCopy += `Ingredientes a comprar:\n${toBuyIngredients.join('\n')}`;
    navigator.clipboard.writeText(textToCopy).then(() => { showToast('Receta copiada al portapapeles'); }).catch(err => { showToast('Error al copiar la receta', true); });
}

/**
 * [VERSI√ìN DEFINITIVA CON SDK DE FIRESTORE Y EMOJI EN EL NOMBRE]
 * A√±ade los ingredientes del Chef a la lista de la compra de forma at√≥mica.
 * El emoji del Chef ahora se concatena directamente en el nombre del art√≠culo.
 */
async function addIngredientsToShoppingList(buttonElement) {
    const recipeCard = buttonElement.closest('.recipe-card');
    const checkboxes = recipeCard.querySelectorAll('.buy-checkbox:checked');
    if (checkboxes.length === 0) {
        showToast("No has seleccionado ning√∫n ingrediente.", true);
        return;
    }
    
    // Concatenar el emoji del Chef directamente en el nombre del art√≠culo
    const itemsToAdd = Array.from(checkboxes).map(cb => `${cb.dataset.itemName} üßë‚Äçüç≥`);
    
    // No mostramos spinner, la operaci√≥n es muy r√°pida.
    // Deshabilitamos el bot√≥n inmediatamente para evitar dobles clics.
    buttonElement.disabled = true;
    
    try {
        const batch = db.batch();
        const shoppingListRef = db.collection('users').doc(chatId).collection('listaDeLaCompra');
        
        itemsToAdd.forEach(finalItemName => {
            const newId = generateCustomId('ITEM-'); // ID espec√≠fico para art√≠culos del Chef
            const newItemRef = shoppingListRef.doc(newId);
            const newItemData = {
                articulo: finalItemName, // El nombre del art√≠culo AHORA incluye el emoji del Chef
                estado: 'Pendiente',
                cycle: 0,
                // Ya no necesitamos 'origen: "chef"', el ID "ITEM-" y el emoji en el nombre lo identifican
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            };
            batch.set(newItemRef, newItemData);
        });

        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        batch.update(countsRef, {
            shoppingPendingCount: firebase.firestore.FieldValue.increment(itemsToAdd.length)
        });

        await batch.commit();

        showToast(`${itemsToAdd.length} ingredientes a√±adidos a la lista.`);
        buttonElement.textContent = 'A√±adido ‚úîÔ∏è';
        // El oyente en tiempo real de la lista de compras se encargar√° de actualizar la UI
        // con los art√≠culos que ya tienen el emoji incluido en su nombre.
        
    } catch(err) {
        console.error("Error al a√±adir ingredientes con batch write:", err);
        showToast(`Error: ${err.message}`, true);
        buttonElement.disabled = false; // Habilitar el bot√≥n de nuevo si falla
    }
}

// ==================================================
// --- M√ìDULO: AJUSTES (CON GUARDADO SEGURO) ---
// ==================================================
function renderSettings() {
    removeCalendarFAB();
    setActiveTab('tab-settings');
    navigationHistory.push(renderDashboard);
    updateBackButton();

    const settings = appData.settings || {};
    const config = settings.configuracion || {};
    const ubicacion = settings.ubicacion || {};
    const informeManana = config.InformeDiario || {}; 
    const informeTarde = config.informeTarde || {};
    const informeMensual = config.informeMensual || {};
    const isPremium = appData.isPremium === true;
    
    // Lectura inteligente: Prioriza la nueva estructura aplanada y usa la anidada como respaldo.
    const settingsData = {
        nombre: settings.nombre || '',
        ciudad: ubicacion.ciudad || '',
        pais: settings.pais || '', // <-- CORRECCI√ìN #1: Leemos 'pais' del nivel superior (settings)
        tema: settings.tema ?? config.tema ?? 'auto',
        alertaInventario: settings.alertaInventario ?? config.alertaInventario ?? false,
        informeDiario_activo: settings.informeDiario_activo ?? informeManana.activo ?? false,
        informeDiario_franjaHoraria: String(settings.informeDiario_franjaHoraria ?? informeManana.franjaHoraria ?? '8'),
        informeTarde_activo: settings.informeTarde_activo ?? informeTarde.activo ?? false,
        informeTarde_franjaHoraria: String(settings.informeTarde_franjaHoraria ?? informeTarde.franjaHoraria ?? '20'),
        informeMensual_activo: settings.informeMensual_activo ?? informeMensual.activo ?? false,
        informeMensual_dia: String(settings.informeMensual_dia ?? informeMensual.dia ?? '1'),
        informeMensual_hora: String(settings.informeMensual_hora ?? informeMensual.hora ?? '14'),
    };
    
    initialUserSettings = { ...settingsData };
    
    mainContentArea.innerHTML = `
        <div class="settings-container">
            <h2 class="settings-section-title">üë§ Perfil de Usuario</h2>
            <div class="form-card">
                <label>Nombre</label><input type="text" id="settings-nombre" placeholder="Tu nombre" />
                <label>Ciudad</label><input type="text" id="settings-ciudad" placeholder="Ej: Barcelona" />
                <label>Pa√≠s</label><input type="text" id="settings-pais" placeholder="Ej: Espa√±a" />
                <div class="settings-item" style="padding-top:15px;"><span class="settings-item-label">Tema de la App</span><div class="settings-item-control"><select id="settings-theme"><option value="auto">Autom√°tico (Telegram)</option><option value="light">Claro</option><option value="dark">Oscuro</option></select></div></div>
            </div>
            <h2 class="settings-section-title">üìÑ Informaci√≥n de la Cuenta</h2>
            <div class="form-card">
                <label>Email de Registro (no editable)</label><input type="email" id="settings-email" readonly />
                <label>Fecha de Activaci√≥n (no editable)</label><input type="text" id="settings-fecha-activacion" readonly />
                <label>Zona Horaria Detectada (no editable)</label><input type="text" id="settings-zona-horaria" readonly />
                <label>Moneda (detectada)</label><input type="text" id="settings-moneda" readonly />
            </div>
            <h2 class="settings-section-title">üîî Informes y Alertas</h2>
            <div class="form-card">
                <div class="settings-item"><span class="settings-item-label">Informe Matutino</span><label class="switch"><input type="checkbox" id="settings-informe-manana-activo"><span class="slider"></span></label></div>
                <div class="settings-item">
                    <span class="settings-item-label">Hora del Informe</span>
                    <select id="settings-franja-manana">
                        <option value="6">Franja de 6 a 7 hs</option>
                        <option value="7">Franja de 7 a 8 hs</option>
                        <option value="8">Franja de 8 a 9 hs</option>
                        <option value="9">Franja de 9 a 10 hs</option>
                    </select>
                </div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item"><span class="settings-item-label">Informe del Tiempo (Tarde)</span><label class="switch"><input type="checkbox" id="settings-informe-tarde-activo"><span class="slider"></span></label></div>
                <div class="settings-item"><span class="settings-item-label">Hora del Informe</span><select id="settings-franja-tarde"><option value="19">19:00</option><option value="20">20:00</option><option value="21">21:00</option></select></div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item"><span class="settings-item-label">Informe Mensual de Gastos</span><label class="switch"><input type="checkbox" id="settings-informe-mensual-activo"><span class="slider"></span></label></div>
                <div class="settings-item"><span class="settings-item-label">D√≠a de Env√≠o</span><select id="settings-dia-informe-mensual">${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join('')}</select></div>
                <div class="settings-item"><span class="settings-item-label">Hora de Env√≠o</span><select id="settings-hora-informe-mensual">${[...Array(15).keys()].map(i => `<option value="${i + 8}">${(i + 8).toString().padStart(2, '0')}:00</option>`).join('')}</select></div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item" id="alerta-inventario-wrapper"><span class="settings-item-label">Alertas de Compra Inteligente ${isPremium ? '' : '‚≠ê'}</span><label class="switch"><input type="checkbox" id="settings-alerta-inventario"><span class="slider"></span></label></div>
            </div>
            <div class="form-card" style="margin-top: 20px;"><div class="button-group">
                <button id="settings-cancel-btn" class="cancel">Cancelar</button>
                <button id="settings-save-btn" disabled>Guardar Cambios</button>
            </div>
			</div>
            <div class="form-card" style="margin-top: 20px;">
                 <button id="settings-sync-btn" class="add-article-btn enabled" style="width:100%; max-width:100%; background-color: var(--muted);">Sincronizar Contadores</button>
            </div>
        </div>
    `;
    
    document.getElementById('settings-nombre').value = settingsData.nombre;
    document.getElementById('settings-ciudad').value = settingsData.ciudad;
    document.getElementById('settings-pais').value = settingsData.pais;
    document.getElementById('settings-theme').value = settingsData.tema;
    
    document.getElementById('settings-email').value = settings.email || 'No disponible';
    document.getElementById('settings-fecha-activacion').value = settings.fechaActivacion || 'No disponible';
    document.getElementById('settings-zona-horaria').value = settings.timeZone || 'No disponible'; // <-- CORRECCI√ìN #2: Leemos 'timeZone' del nivel superior (settings)
    document.getElementById('settings-moneda').value = settings.moneda || 'No disponible';
    
    document.getElementById('settings-informe-manana-activo').checked = settingsData.informeDiario_activo;
    document.getElementById('settings-franja-manana').value = settingsData.informeDiario_franjaHoraria;
    
    document.getElementById('settings-informe-tarde-activo').checked = settingsData.informeTarde_activo;
    document.getElementById('settings-franja-tarde').value = settingsData.informeTarde_franjaHoraria;
    
    const alertaInventarioSwitch = document.getElementById('settings-alerta-inventario');
    alertaInventarioSwitch.checked = settingsData.alertaInventario;
    if (!isPremium) {
        alertaInventarioSwitch.disabled = true;
        document.getElementById('alerta-inventario-wrapper').style.opacity = '0.6';
        document.getElementById('alerta-inventario-wrapper').onclick = () => showToast('‚≠ê Funci√≥n exclusiva para usuarios Premium.');
    }

    document.getElementById('settings-informe-mensual-activo').checked = settingsData.informeMensual_activo;
    document.getElementById('settings-dia-informe-mensual').value = settingsData.informeMensual_dia;
    document.getElementById('settings-hora-informe-mensual').value = settingsData.informeMensual_hora;

    const controls = document.querySelectorAll('#settings-nombre, #settings-ciudad, #settings-pais, #settings-informe-manana-activo, #settings-franja-manana, #settings-informe-tarde-activo, #settings-franja-tarde, #settings-informe-mensual-activo, #settings-dia-informe-mensual, #settings-hora-informe-mensual, #settings-alerta-inventario');
	controls.forEach(control => {
    control.addEventListener('input', validateSettings);
    control.addEventListener('change', validateSettings);
});

	const themeSelector = document.getElementById('settings-theme');
	themeSelector.addEventListener('change', () => {
        const nuevoTema = themeSelector.value;
        applyTheme(nuevoTema);
        
        // Actualizamos la memoria local en la ruta correcta
        if (!appData.settings.configuracion) appData.settings.configuracion = {};
        appData.settings.configuracion.tema = nuevoTema;

        // Guardado directo en Firestore usando "dot notation" para el campo anidado
        db.collection('users').doc(chatId).update({
            'configuracion.tema': nuevoTema
        }).catch(error => {
            console.error("Error al guardar el tema directamente en Firestore:", error);
            showToast("No se pudo guardar la preferencia de tema.", true);
        });
    });

    document.getElementById('settings-save-btn').onclick = saveSettings;
    document.getElementById('settings-cancel-btn').onclick = renderDashboard;
    document.getElementById('settings-sync-btn').onclick = syncCounts;
}

/**
 * Valida si hay cambios en el formulario de ajustes comparando con el estado inicial.
 * Habilita/deshabilita el bot√≥n de guardar de forma inteligente.
 */
function validateSettings() {
    const saveBtn = document.getElementById('settings-save-btn');

    // --- INICIO DE LA MODIFICACI√ìN QUIR√öRGICA ---
    // Recogemos los valores actuales del formulario usando los nuevos nombres aplanados.
    const currentValues = {
        nombre: document.getElementById('settings-nombre').value,
        ciudad: document.getElementById('settings-ciudad').value,
        pais: document.getElementById('settings-pais').value,
        
        informeDiario_activo: document.getElementById('settings-informe-manana-activo').checked,
        informeDiario_franjaHoraria: document.getElementById('settings-franja-manana').value,

        informeTarde_activo: document.getElementById('settings-informe-tarde-activo').checked,
        informeTarde_franjaHoraria: document.getElementById('settings-franja-tarde').value,

        informeMensual_activo: document.getElementById('settings-informe-mensual-activo').checked,
        informeMensual_dia: document.getElementById('settings-dia-informe-mensual').value,
        informeMensual_hora: document.getElementById('settings-hora-informe-mensual').value,

        alertaInventario: document.getElementById('settings-alerta-inventario').checked
    };
    // --- FIN DE LA MODIFICACI√ìN QUIR√öRGICA ---

    // La comparaci√≥n ahora funciona perfectamente porque ambos objetos tienen la misma estructura aplanada.
    const hasChanged = JSON.stringify(currentValues) !== JSON.stringify(initialUserSettings);
    
    saveBtn.disabled = !hasChanged;
    saveBtn.classList.toggle('enabled', hasChanged);
}

// --- VERSI√ìN DEFINITIVA DE saveSettings ---
async function saveSettings() {
    const saveBtn = document.getElementById('settings-save-btn');
    const originalBtnText = saveBtn.textContent;
    
    const capitalize = (str) => {
        if (!str) return '';
        return str.toLowerCase().replace(/(?:^|\s)\S/g, char => char.toUpperCase());
    };

    saveBtn.innerHTML = `<span class="spinner btn-spinner"></span> Guardando...`;
    saveBtn.disabled = true;

    try {
        // 1. Recopilamos TODOS los datos del formulario que el usuario puede cambiar.
        const settingsPayload = {
            chatId: chatId,
            nombre: document.getElementById('settings-nombre').value,
            ciudad: capitalize(document.getElementById('settings-ciudad').value.trim()),
            pais: capitalize(document.getElementById('settings-pais').value.trim()),
			alertaInventario: document.getElementById('settings-alerta-inventario').checked,
			
            // Enviamos un objeto 'informesConfig' que la Cloud Function ya sabe c√≥mo interpretar.
            informesConfig: {
                diario: {
                    activo: document.getElementById('settings-informe-manana-activo').checked,
                    hora: parseInt(document.getElementById('settings-franja-manana').value, 10)
                },
                tarde: {
                    activo: document.getElementById('settings-informe-tarde-activo').checked,
                    hora: parseInt(document.getElementById('settings-franja-tarde').value, 10)
                },
                mensual: {
                    activo: document.getElementById('settings-informe-mensual-activo').checked,
                    dia: parseInt(document.getElementById('settings-dia-informe-mensual').value, 10),
                    hora: parseInt(document.getElementById('settings-hora-informe-mensual').value, 10)
                }
            }
            // NOTA: El tema y la alerta de inventario se guardan localmente en el cliente
            // y no necesitan pasar por esta Cloud Function espec√≠fica.
        };

        // 2. Llamamos SIEMPRE a la Cloud Function con todos los datos.
        const functionUrl = 'https://europe-west1-asistentepersonal-4ad2b.cloudfunctions.net/updateUserSettings';
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: settingsPayload }) // El payload se anida dentro de 'data' como espera tu funci√≥n.
        });

        const result = await response.json();

        if (!response.ok) {
            // Si la respuesta no es OK, lanzamos un error con el mensaje del servidor.
            throw new Error(result.error.message || `Error del servidor: ${response.status}`);
        }

        // 3. Si todo fue bien, actualizamos los datos locales con la respuesta del servidor.
        if (result && result.result && result.result.status === 'success') {
            appData.settings = result.result.updatedSettings;
            showToast("Ajustes guardados y programados con √©xito.");
            renderDashboard();
        } else {
            throw new Error("La respuesta del servidor no fue la esperada.");
        }

    } catch (error) {
        console.error("Error al guardar ajustes:", error);
        showToast(`Error: ${error.message || 'Ocurri√≥ un error desconocido.'}`, true);
        // Si hay un error, restauramos el bot√≥n para que el usuario pueda reintentar.
        saveBtn.innerHTML = originalBtnText;
        saveBtn.disabled = false;
        saveBtn.classList.add('enabled');
    }
}

async function syncShoppingCounts() {
    if (!chatId) return;
    console.log("[Sincronizaci√≥n de Compra] Iniciando rec√°lculo de contadores.");
    try {
        const shoppingListRef = db.collection('users').doc(chatId).collection('listaDeLaCompra');
        
        // M√©todo de conteo universalmente compatible
        const pendingPromise = shoppingListRef.where('estado', '==', 'Pendiente').get();
        const boughtPromise = shoppingListRef.where('estado', '==', 'Comprado').get();
        
        const [pendingSnapshot, boughtSnapshot] = await Promise.all([pendingPromise, boughtPromise]);
        
        const pendingCount = pendingSnapshot.size;
        const boughtCount = boughtSnapshot.size;
        
        // Actualizamos el documento de resumen en Firestore
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        await countsRef.update({
            shoppingPendingCount: pendingCount,
            shoppingBoughtCount: boughtCount
        });
        
        console.log(`[Sincronizaci√≥n de Compra] Rec√°lculo completado. Pendientes: ${pendingCount}, Comprados: ${boughtCount}`);
        
    } catch (error) {
        // Este error no debe detener al usuario, solo lo registramos.
        console.error("[Sincronizaci√≥n de Compra] Error durante el rec√°lculo:", error);
    }
}

async function syncCounts() {
    showSpinner("Sincronizando contadores...");
    try {
        // [NUEVA L√ìGICA FIRESTORE] Consultas de conteo en paralelo.
        const remindersPromise = db.collection('users').doc(chatId).collection('notificaciones').get();
        const shoppingPendingPromise = db.collection('users').doc(chatId).collection('listaDeLaCompra').where('estado', '==', 'Pendiente').get();
        const shoppingBoughtPromise = db.collection('users').doc(chatId).collection('listaDeLaCompra').where('estado', '==', 'Comprado').get();
        const notesPromise = db.collection('users').doc(chatId).collection('notas').get();
        // A√±ade aqu√≠ m√°s promesas de conteo si es necesario en el futuro.

        const [
            remindersSnapshot,
            shoppingPendingSnapshot,
            shoppingBoughtSnapshot,
            notesSnapshot
        ] = await Promise.all([
            remindersPromise,
            shoppingPendingPromise,
            shoppingBoughtPromise,
            notesPromise
        ]);

        // Construimos el objeto con los nuevos contadores reales.
        const newCounts = {
            remindersCount: remindersSnapshot.size,
            shoppingPendingCount: shoppingPendingSnapshot.size,
            shoppingBoughtCount: shoppingBoughtSnapshot.size,
            notesCount: notesSnapshot.size
            // No tocamos los contadores de gastos o calendario que se gestionan por separado.
        };

        // Actualizamos el documento maestro en Firestore.
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        await countsRef.update(newCounts);

        // Actualizamos la data local y la UI.
        Object.assign(appData.counts, newCounts);
        showToast("Contadores resincronizados con √©xito.");
        renderDashboard();

    } catch (err) {
        showToast(`Error al sincronizar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function renderExportPage() {
    removeCalendarFAB();
	setActiveTab('tab-export');
    navigationHistory.push(renderDashboard);
    updateBackButton();
    mainContentArea.innerHTML = `
        <div class="export-container">
            <h2 class="settings-section-title">üìä Exportar Gastos</h2>
            <div class="form-card">
                <p style="font-size:0.9rem; color:var(--muted); margin-bottom:15px;">Selecciona el rango de fechas para la exportaci√≥n. Recibir√°s el archivo en tu email.</p>
                <label>Fecha de Inicio</label>
                <div class="flatpickr-wrapper"><input type="text" id="export-start-date" required data-input/></div>
                <label>Fecha de Fin</label>
                <div class="flatpickr-wrapper"><input type="text" id="export-end-date" required data-input/></div>
                <div class="button-group">
                    <button id="export-cancel-btn" class="cancel">Cancelar</button>
                    <button id="export-confirm-btn" class="enabled">Generar y Enviar</button>
                </div>
            </div>
        </div>
    `;
    flatpickr(document.querySelector("#export-start-date").parentElement, {
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    dateFormat: "d/m/Y",
    defaultDate: new Date(new Date().getFullYear(), 0, 1)
});
flatpickr(document.querySelector("#export-end-date").parentElement, {
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    dateFormat: "d/m/Y",
    defaultDate: new Date()
});
    document.getElementById('export-cancel-btn').onclick = goBack;
    document.getElementById('export-confirm-btn').onclick = executeExport;
}

async function executeExport() {
    const exportBtn = document.getElementById('export-confirm-btn');
    const originalBtnHTML = exportBtn.innerHTML;
    
    // 1. Cambiamos el estado del bot√≥n a "cargando"
    exportBtn.disabled = true;
    exportBtn.innerHTML = `<span class="spinner btn-spinner"></span> Generando...`;

    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;

    if (!startDate || !endDate) {
        showToast("Por favor, selecciona ambas fechas.", true);
        // Restauramos el bot√≥n si hay un error de validaci√≥n
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalBtnHTML;
        return;
    }

    const exportFunctionUrl = 'https://europe-west1-asistentepersonal-4ad2b.cloudfunctions.net/exportarGastos';

    try {
        const payload = { data: { chatId, startDate, endDate } };

        const response = await fetch(exportFunctionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error.message || `Error del servidor: ${response.status}`);
        }
        
        // 2. L√≥gica anti-doble-toast
        showToast(result.result.message || "Petici√≥n enviada. Revisa tu email.");
        
        // Hacemos una peque√±a pausa ANTES de navegar al Home
        setTimeout(() => {
            renderDashboard(); 
        }, 300); // 300ms es suficiente para que la animaci√≥n del toast se vea bien

    } catch (err) {
        showToast(`Error al exportar: ${err.message}`, true);
        // 3. Restauramos el bot√≥n SOLO si hay un error, para que el usuario pueda reintentar
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalBtnHTML;
    }
    // Nota: No hay 'finally' para que el bot√≥n no reaparezca brevemente antes de navegar.
}

// ==================================================
// --- M√ìDULO: GU√çA TV ---
// ==================================================

/**
 * Renderiza la vista principal de la Gu√≠a TV.
 * VERSI√ìN FINAL: Utiliza fetchWithTimeout con el m√©todo FormData probado.
 */
/**
 * Controlador principal para la Gu√≠a TV.
 * Construye la estructura base y lanza la carga de datos para el d√≠a actual.
 */
function renderGuiaTV() {
    navigationHistory.push(renderDashboard);
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="guia-tv-container">
            <div class="list-header"><h2>Gu√≠a TV</h2></div>
            <div id="guia-nav-container" class="guia-nav"></div>
            <div id="guia-grid-wrapper" class="guia-grid-wrapper">
                <div id="guia-grid-content">
                    <div class="no-data-msg">Cargando programaci√≥n...</div>
                </div>
            </div>
        </div>`;

    // Generar botones de navegaci√≥n para los pr√≥ximos 4 d√≠as
    const navContainer = document.getElementById('guia-nav-container');
    for (let i = 0; i < 4; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i);
        const dateISO = date.toISOString().split('T')[0];

        const btn = document.createElement('button');
        btn.className = 'guia-nav-btn';
        btn.dataset.date = dateISO;
        if (i === 0) {
            btn.classList.add('active');
            btn.textContent = 'Hoy';
        } else if (i === 1) {
            btn.textContent = 'Ma√±ana';
        } else {
            btn.textContent = date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
        }
        
        btn.onclick = () => {
            document.querySelectorAll('.guia-nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadGuiaDataForDate(dateISO);
        };
        navContainer.appendChild(btn);
    }

    // Cargar datos para el d√≠a de hoy
    const todayISO = new Date().toISOString().split('T')[0];
    loadGuiaDataForDate(todayISO);
}

/**
 * Carga los datos de la gu√≠a para una fecha espec√≠fica desde Firestore y llama a la funci√≥n de renderizado.
 * @param {string} dateISO - La fecha en formato YYYY-MM-DD.
 */
async function loadGuiaDataForDate(dateISO) {
    showSpinner();
    const gridContent = document.getElementById('guia-grid-content');

    try {
        const geoTags = appData.settings.ubicacion?.geo_tags;
        if (!geoTags || !geoTags.country || !geoTags.admin_level_1) {
            throw new Error("Ubicaci√≥n no configurada correctamente.");
        }

        const pais = geoTags.country.toLowerCase();
        const codigoRegion = `${pais.substring(0, 2).toUpperCase()}-${(geoTags.admin_level_1 || 'General').replace(/\s+/g, '-').toUpperCase()}`;
        
        const docPath = `guia_tv/${codigoRegion}/programacion/${dateISO}`;
        const docSnap = await db.collection('guia_tv').doc(codigoRegion).collection('programacion').doc(dateISO).get();

        if (!docSnap.exists) {
            throw new Error(`No hay programaci√≥n disponible para el d√≠a ${dateISO}.`);
        }
        
        const data = docSnap.data();
        renderTimelineGrid(data.canales, data.programas);

    } catch (err) {
        console.error("Error cargando la Gu√≠a TV desde Firestore:", err);
        gridContent.innerHTML = `<div class="no-data-msg">‚ùå<br>No se pudo cargar la gu√≠a.<br><small>${err.message}</small></div>`;
    } finally {
        hideSpinner();
    }
}

/**
 * Renderiza la parrilla de l√≠nea de tiempo con los datos de canales y programas.
 * @param {Array} canales - El array de objetos de canal.
 * @param {Array} programas - El array de objetos de programa.
 */
function renderTimelineGrid(canales, programas) {
    const gridContent = document.getElementById('guia-grid-content');
    const PIXELS_PER_MINUTE = 2; // 120px por hora

    // Construir HTML para la columna de canales
    let channelsHtml = '<div class="guia-channels-col"><div class="guia-channel-logo-placeholder"></div>';
    canales.forEach(canal => {
        channelsHtml += `<div class="guia-channel-logo"><img src="${canal.logo}" alt="${canal.nombre}"></div>`;
    });
    channelsHtml += '</div>';

    // Construir HTML para la columna de la l√≠nea de tiempo
    let timelineHtml = '<div class="guia-timeline-col">';
    
    // Cabecera de horas
    let timeHeaderHtml = '<div class="guia-time-header">';
    for (let i = 0; i < 48; i++) { // 24 horas * 2 slots de 30 min
        const hour = Math.floor(i / 2).toString().padStart(2, '0');
        const minutes = (i % 2 === 0) ? '00' : '30';
        timeHeaderHtml += `<div class="guia-time-slot">${hour}:${minutes}</div>`;
    }
    timeHeaderHtml += '</div>';
    timelineHtml += timeHeaderHtml;

    // Filas de programas para cada canal
    canales.forEach(canal => {
        timelineHtml += `<div class="guia-channel-row" data-channel-id="${canal.id}">`;
        const programasDelCanal = programas.filter(p => p.canal === canal.id);
        programasDelCanal.forEach(prog => {
            const startTime = new Date(prog.inicio);
            const endTime = new Date(prog.fin);
            const startMinutes = startTime.getUTCHours() * 60 + startTime.getUTCMinutes();
            const endMinutes = endTime.getUTCHours() * 60 + endTime.getUTCMinutes();
            const durationMinutes = Math.max(15, (endMinutes - startMinutes)); // Duraci√≥n m√≠nima de 15 min

            const left = startMinutes * PIXELS_PER_MINUTE;
            const width = durationMinutes * PIXELS_PER_MINUTE;

            timelineHtml += `
                <div class="guia-program-block" style="left: ${left}px; width: ${width}px;" data-program-id="${prog.titulo}">
                    <div class="guia-program-title">${prog.titulo}</div>
                    <div class="guia-program-time">${startTime.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</div>
                </div>`;
        });
        timelineHtml += '</div>';
    });
    
    // L√≠nea de "Ahora"
    const now = new Date();
    const nowMinutes = now.getHours() * 60 + now.getMinutes();
    const nowPosition = nowMinutes * PIXELS_PER_MINUTE;
    const todayISO = now.toISOString().split('T')[0];
    const activeDate = document.querySelector('.guia-nav-btn.active')?.dataset.date;

    if (activeDate === todayISO) {
         timelineHtml += `<div class="guia-now-line" style="left: ${nowPosition}px;"></div>`;
    }

    timelineHtml += '</div>'; // Cierre de guia-timeline-col
    gridContent.innerHTML = `<div class="guia-grid">${channelsHtml}${timelineHtml}</div>`;

    // Scroll autom√°tico a la hora actual
    const wrapper = document.getElementById('guia-grid-wrapper');
    if (activeDate === todayISO) {
         wrapper.scrollLeft = nowPosition - (wrapper.offsetWidth / 2);
    }
}

// ==================================================
// --- M√ìDULO: EMERGENCIAS ---
// ==================================================
function renderMyLocationView() {
    navigationHistory.push(renderEmergenciasView);
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üìç Mi Ubicaci√≥n Actual</h2></div>
            <div class="form-card" id="location-display-card">
                
                <div id="location-spinner" class="combustible-loading-state" style="padding: 30px 0;">
                    <p>Obteniendo tu ubicaci√≥n precisa...</p>
                    <small style="color:var(--muted); display:block; margin-top:5px;">Por favor, acepta el permiso si se solicita.</small>
                    <div class="dot-spinner" style="margin-top: 20px;"><div class="dot-spinner__dot"></div><div class="dot-spinner__dot"></div><div class="dot-spinner__dot"></div></div>
                </div>

                <div id="location-content" style="display:none;">
                    <div id="location-map" style="height: 200px; border-radius: 12px; margin-bottom: 20px; background-color: #e9e9e9;"></div>
                    <div style="text-align: left; line-height: 1.6;">
                        <p><strong>Latitud:</strong> <code id="location-lat">--</code></p>
                        <p><strong>Longitud:</strong> <code id="location-lon">--</code></p>
                    </div>
                    <div id="location-actions" style="margin-top: 25px;">
                        <button id="copy-location-btn" class="add-article-btn enabled" style="width:100%; max-width:100%; margin-bottom:10px;">Copiar Coordenadas</button>
                        
                        <p style="text-align: center; font-weight: 500; color: var(--muted); margin-bottom: 15px;">Compartir Mi Ubicaci√≥n:</p>
                        
                        <div id="share-actions-container" style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;"></div>
                    </div>
                </div>

                <div id="location-error" style="display:none; text-align:center;" class="no-data-msg">
                    <p style="font-size:1.1rem; line-height:1.5;">‚ùå No se pudo obtener la ubicaci√≥n.</p>
                    <small id="location-error-reason" style="color:var(--muted); margin-top:10px; display:block;"></small>
                    <button id="retry-location-btn" class="add-article-btn enabled" style="width:100%; max-width:250px; margin-top:20px;">Reintentar</button>
                </div>
            </div>
        </div>
    `;

    fetchAndDisplayLocationWithMap();
}

function fetchAndDisplayLocationWithMap() {
    const spinner = document.getElementById('location-spinner');
    const contentContainer = document.getElementById('location-content');
    const errorContainer = document.getElementById('location-error');
    let map = null;

    spinner.style.display = 'block';
    contentContainer.style.display = 'none';
    errorContainer.style.display = 'none';

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const { latitude, longitude } = position.coords;

            spinner.style.display = 'none';
            contentContainer.style.display = 'block';

            document.getElementById('location-lat').textContent = latitude.toFixed(6);
            document.getElementById('location-lon').textContent = longitude.toFixed(6);

            const mapContainer = document.getElementById('location-map');
            if (mapContainer) {
                map = L.map('location-map').setView([latitude, longitude], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([latitude, longitude]).addTo(map);
            }

            const locationTextForCopy = `Latitud: ${latitude.toFixed(6)}, Longitud: ${longitude.toFixed(6)}`;
            const locationTextForShare = `Mi ubicaci√≥n actual:\n${locationTextForCopy}\n\nVer en el mapa:\nhttps://www.google.com/maps?q=${latitude},${longitude}`;

            document.getElementById('copy-location-btn').onclick = () => {
                navigator.clipboard.writeText(locationTextForCopy).then(() => {
                    showToast('Coordenadas copiadas.');
                }).catch(() => showToast('Error al copiar.', true));
            };

            const shareActionsContainer = document.getElementById('share-actions-container');
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(locationTextForShare)}`;
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(`https://www.google.com/maps?q=${latitude},${longitude}`)}&text=${encodeURIComponent("Mi ubicaci√≥n actual:")}`;
            
            shareActionsContainer.innerHTML = `
                <button class="share-action-btn whatsapp-btn" style="background-color: #25D366;" onclick="Telegram.WebApp.openLink('${whatsappUrl}')" title="Compartir en WhatsApp">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.35 3.48 16.84L2 22L7.32 20.55C8.75 21.33 10.36 21.8 12.04 21.8H12.05C17.5 21.8 21.95 17.35 21.95 11.9C21.95 9.28 20.94 6.85 19.1 4.99C17.25 3.14 14.81 2 12.04 2M16.57 13.95C16.37 14.45 15.38 15.05 15.11 15.2C14.84 15.35 14.53 15.41 14.24 15.26C13.94 15.11 13.06 14.81 12.08 13.95C10.88 12.89 10.24 11.65 10.09 11.4C9.94 11.15 10.12 10.98 10.27 10.83C10.4 10.7 10.55 10.5 10.69 10.3C10.84 10.15 10.89 10.03 10.79 9.88C10.69 9.73 10.24 8.53 10.04 8.03C9.84 7.53 9.64 7.6 9.49 7.6H9.04C8.84 7.6 8.53 7.68 8.26 7.93C7.98 8.18 7.34 8.76 7.34 9.95C7.34 11.15 8.29 12.3 8.44 12.45C8.59 12.6 10.04 14.83 12.31 15.75C14.58 16.68 14.93 16.53 15.38 16.48C15.83 16.43 16.71 15.86 16.91 15.31C17.11 14.76 17.11 14.28 17.06 14.18C17 14.08 16.77 13.95 16.57 13.95Z" /></svg>
                </button>
                <button class="share-action-btn telegram-btn" style="background-color: #0088cc;" onclick="Telegram.WebApp.openTelegramLink('${telegramUrl}')" title="Compartir en Telegram">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M9.78,18.65L10.26,14.21L18.46,7.5C18.85,7.11 18.42,6.92 18,7.31L9.62,13.23L5.32,11.86C4.89,11.72 4.88,11.37 5.37,11.16L19.37,5.16C19.87,4.96 20.34,5.25 20.14,5.83L17.14,19.83C16.94,20.33 16.47,20.44 16.1,20.05L12.06,16.64L9.78,18.65Z" /></svg>
                </button>
            `;
        },
        (error) => {
            spinner.style.display = 'none';
            errorContainer.style.display = 'block';
            const reasonEl = document.getElementById('location-error-reason');
            const errorMessages = {
                [error.PERMISSION_DENIED]: "Has denegado el permiso. Act√≠valo en los ajustes de tu m√≥vil o Telegram.",
                [error.POSITION_UNAVAILABLE]: "La informaci√≥n no est√° disponible. Int√©ntalo en un lugar con mejor se√±al.",
                [error.TIMEOUT]: "La solicitud ha tardado demasiado. Comprueba tu conexi√≥n a internet."
            };
            reasonEl.textContent = errorMessages[error.code] || "Ha ocurrido un error desconocido.";
            document.getElementById('retry-location-btn').onclick = fetchAndDisplayLocationWithMap;
        },
        { timeout: 15000, enableHighAccuracy: true }
    );
}

function renderEmergenciasView() {
    if (tg && tg.MainButton.isVisible) {
        tg.MainButton.hide();
    }

    navigationHistory.push(() => {
        if (tg && tg.MainButton.isVisible) {
            tg.MainButton.hide();
        }
        mainContentArea.removeEventListener('click', handleEmergenciasClick);
        renderDashboard();
    });
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üÜò B√∫squedas de Emergencia</h2></div>

            <div class="grid" id="emergency-searches-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                <div class="card clickable-card" data-card-id="my-location" id="my-location-card">
				<div class="card-icon">üìç</div><div class="card-title">Mi Ubicaci√≥n</div>
				</div>
				<div class="card clickable-card" data-search-term="veterinario 24 horas">
				<div class="card-icon">üêæ</div><div class="card-title">Veterinarias 24h</div>
				</div>
				<div class="card clickable-card" data-search-term="hospital">
				<div class="card-icon">üè•</div><div class="card-title">Hospitales</div>
				</div>
                <div class="card clickable-card" data-search-term="pharmacy">
                    <div class="card-icon">üíä</div><div class="card-title">Farmacias</div>
                </div>
                <div class="card clickable-card" data-search-term="police">
                    <div class="card-icon">üöì</div><div class="card-title">Polic√≠a</div>
                </div>
                <div class="card clickable-card" data-search-term="gas station">
                    <div class="card-icon">‚õΩ</div><div class="card-title">Gasolineras</div>
                </div>
                <div class="card clickable-card" data-search-term="car repair">
                    <div class="card-icon">üîß</div><div class="card-title">Talleres</div>
                </div>
                <div class="card clickable-card" data-search-term="atm">
                    <div class="card-icon">üèß</div><div class="card-title">Cajeros</div>
                </div>
            </div>
        </div>
    `;

    setTimeout(() => { mainContentArea.addEventListener('click', handleEmergenciasClick); }, 0);
}

function handleEmergenciasClick(event) {
    const card = event.target.closest('.card.clickable-card');
    if (!card) return;

    if (card.dataset.cardId === 'my-location') {
        renderMyLocationView();
        return;
    }
    
    const grid = document.getElementById('emergency-searches-grid');
    grid.querySelectorAll('.card').forEach(c => c.classList.remove('emergency-selected'));
    card.classList.add('emergency-selected');
    grid.classList.add('emergency-dimmed');
    
    const searchTerm = card.dataset.searchTerm;
    const categoryTitle = card.querySelector('.card-title').textContent;
    const mainButtonText = `Buscar ${categoryTitle} cerca üìç`;
    
    if (tg && tg.MainButton) {
        const restoreCards = () => {
            const grid = document.getElementById('emergency-searches-grid');
            if (!grid) return;
            const selectedCard = grid.querySelector('.emergency-selected');
            grid.classList.remove('emergency-dimmed');
            if (selectedCard) selectedCard.classList.remove('emergency-selected');
        };

        const handleLocationError = (error, retryCallback) => {
            tg.MainButton.hideProgress();
            tg.MainButton.enable();
            let msg = "No se pudo obtener tu ubicaci√≥n. Revisa los permisos y la se√±al de GPS.";
            if (error && error.code === 1) msg = "Has denegado el permiso de ubicaci√≥n.";

            tg.showPopup({
                title: "Ubicaci√≥n no encontrada", message: msg,
                buttons: [{ id: 'retry', type: 'default', text: 'Reintentar' }, { id: 'cancel', type: 'cancel' }]
            }, (buttonId) => {
                restoreCards();
                if (buttonId === 'retry') {
                    retryCallback();
                } else {
                    tg.MainButton.hide();
                }
            });
        };

        const requestLocationAndSearch = () => {
            tg.MainButton.showProgress(true);
            tg.MainButton.disable();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(categoryTitle + ' cercanas')}/@${latitude},${longitude},15z`;

                    tg.MainButton.hideProgress();
                    tg.MainButton.enable();
                    tg.MainButton.hide();
                    restoreCards();

                    tg.showPopup({
                        title: "B√∫squeda Lista",
                        message: `Pulsa el bot√≥n para ver los resultados de "${categoryTitle}" en Google Maps.`,
                        buttons: [{ id: 'open_map', type: 'default', text: 'üó∫Ô∏è Ver en Google Maps' }, { type: 'cancel' }]
                    }, (buttonId) => {
                        if (buttonId === 'open_map') {
                            tg.openLink(mapsUrl);
                        }
                    });
                },
                (error) => {
                    handleLocationError(error, requestLocationAndSearch);
                },
                { timeout: 12000, enableHighAccuracy: true }
            );
        };

        const onMainButtonClick = () => {
        const emergencyModalShown = localStorage.getItem('emergencyModalShown');
        if (emergencyModalShown === 'true') {
            requestLocationAndSearch();
        } else {
            const modal = document.getElementById('emergency-location-modal');
            if (modal) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('show'), 10);
                
                document.getElementById('emergency-modal-continue').onclick = () => {
                    if (document.getElementById('emergency-modal-checkbox').checked) {
                        localStorage.setItem('emergencyModalShown', 'true');
                    }
                    modal.classList.remove('show');
                    setTimeout(() => { modal.style.display = 'none'; }, 300);
                    requestLocationAndSearch();
                };
                
                document.getElementById('emergency-modal-cancel').onclick = () => {
                     modal.classList.remove('show');
                     setTimeout(() => { modal.style.display = 'none'; }, 300);
                     tg.MainButton.hide();
                     restoreCards();
                };
            } else {
                // Si el modal no existe por alguna raz√≥n, ejecutar la b√∫squeda directamente
                requestLocationAndSearch();
            }
        }
    };

        tg.MainButton.offClick(onMainButtonClick);
        tg.MainButton.setText(mainButtonText);
        tg.MainButton.setParams({ text_color: '#ffffff', color: '#4a76f3' });
        tg.MainButton.onClick(onMainButtonClick);
        tg.MainButton.show();
    }
}

// ==================================================
// --- M√ìDULO: CUENTAS CLARAS ---
// ==================================================

// Variable global para poder desconectar el listener al salir de la vista
let unsubscribeCuentasClaras = null;

function renderCuentasClarasLobby() {
    // Al volver atr√°s, nos aseguramos de que el listener se desconecte
    navigationHistory.push(() => {
        if (typeof unsubscribeCuentasClaras === 'function') {
            unsubscribeCuentasClaras();
            unsubscribeCuentasClaras = null;
        }
        renderDashboard();
    });
    updateBackButton();
    
    mainContentArea.innerHTML = `
        <div class="list-container" id="cuentas-claras-lobby">
            <div class="list-header">
                <h2>‚öñÔ∏è Cuentas Claras</h2>
            </div>
            <div class="add-article-btn-container">
                <button class="add-article-btn" id="crear-nueva-lista-btn">‚ûï Crear Nueva Lista</button>
            </div>
            
            <!-- Separador visual para las listas -->
            <div style="padding: 0 10px;">
                <hr style="margin: 20px 0; border-top: 1px solid #eee;">
            </div>

            <div id="listas-container">
                <!-- El contenido de las listas se insertar√° aqu√≠ din√°micamente -->
            </div>
        </div>
    `;

    // Conectamos el bot√≥n para ir al formulario de creaci√≥n
    document.getElementById('crear-nueva-lista-btn').onclick = renderCrearListaForm;

    const listasContainer = document.getElementById('listas-container');
    listasContainer.innerHTML = `<div class="no-data-msg">Cargando tus listas...</div>`;

    // Desconectamos cualquier listener anterior para evitar duplicados
    if (typeof unsubscribeCuentasClaras === 'function') {
        unsubscribeCuentasClaras();
    }

    // Creamos la consulta a Firestore
    const q = db.collection('cuentasClaras_listas') // Usamos la nueva colecci√≥n
                 .where('miembros', 'array-contains', chatId) // Buscamos listas donde el usuario es miembro
                 .orderBy('fecha_creacion', 'desc');

    // Escuchamos los cambios en tiempo real
    unsubscribeCuentasClaras = q.onSnapshot(snapshot => {
        if (snapshot.empty) {
            listasContainer.innerHTML = '<div class="no-data-msg">A√∫n no tienes listas.<br>¬°Crea una para empezar!</div>';
            return;
        }

        const listasActivas = [];
        const listasArchivadas = [];

        snapshot.forEach(doc => {
            const lista = { id: doc.id, ...doc.data() };
            if (lista.estado === 'archivado') {
                listasArchivadas.push(lista);
            } else {
                listasActivas.push(lista);
            }
        });
        
        let html = '';

        if (listasActivas.length > 0) {
            html += '<h3 class="shopping-list-section-title">Listas Activas</h3><ul class="list-style-none">';
            listasActivas.forEach(lista => {
                html += `
                    <li class="list-item clickable" data-lista-id="${lista.id}">
                        <div class="list-item-content">
                            <span class="list-item-title">${lista.nombre}</span>
                            <span class="list-item-subtitle">
                                ${lista.participantes.length} Participantes | Creada el ${lista.fecha_creacion ? lista.fecha_creacion.toDate().toLocaleDateString('es-ES') : '...'}
                            </span>
                        </div>
                        <div class="list-item-actions">
                            <span style="color: var(--muted); font-size: 1.5rem;">‚Ä∫</span>
                        </div>
                    </li>`;
            });
            html += '</ul>';
        }

        if (listasArchivadas.length > 0) {
            html += '<h3 class="shopping-list-section-title">Historial (Archivadas)</h3><ul class="list-style-none">';
            listasArchivadas.forEach(lista => {
                html += `
                    <li class="list-item" style="opacity: 0.7;">
                        <div class="list-item-content">
                            <span class="list-item-title">${lista.nombre}</span>
                            <span class="list-item-subtitle">Archivada</span>
                        </div>
                    </li>`;
            });
            html += '</ul>';
        }

        if (listasActivas.length === 0 && listasArchivadas.length === 0) {
             listasContainer.innerHTML = '<div class="no-data-msg">A√∫n no tienes listas.<br>¬°Crea una para empezar!</div>';
        } else {
             listasContainer.innerHTML = html;
        }

        // A√±adimos el listener que abre el panel de gesti√≥n para cada lista
        listasContainer.querySelectorAll('.list-item.clickable').forEach(item => {
        item.onclick = () => {
        const listaId = item.dataset.listaId;
        renderPanelGestion(listaId);
    };
});

    }, error => {
        console.error("Error al escuchar las listas de Cuentas Claras:", error);
        listasContainer.innerHTML = '<div class="no-data-msg">‚ùå<br>Error al cargar las listas.</div>';
    });
}

function renderCrearListaForm() {
    navigationHistory.push(renderCuentasClarasLobby);
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header">
                <h2>‚ûï Crear Nueva Lista de Gastos</h2>
            </div>
            <div class="form-card">
                <label>Nombre de la Lista</label>
                <input type="text" id="nueva-lista-nombre" placeholder="Ej: Fin de semana en la sierra" />

                <label>Moneda</label>
                <input type="text" id="nueva-lista-moneda" value="${appData.settings.moneda || '‚Ç¨'}" />

                <label>Participantes (uno por l√≠nea, incl√∫yete)</label>
                <textarea id="nueva-lista-participantes" rows="5" placeholder="${appData.settings.nombre || 'TuNombre'}\nAna\nCarlos"></textarea>
                
                <div class="button-group">
                    <button id="cancelar-creacion-lista-btn" class="cancel">Cancelar</button>
                    <button id="confirmar-creacion-lista-btn" disabled>Crear Lista</button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('cancelar-creacion-lista-btn').onclick = goBack;
    
    const nombreInput = document.getElementById('nueva-lista-nombre');
    const participantesInput = document.getElementById('nueva-lista-participantes');
    const crearBtn = document.getElementById('confirmar-creacion-lista-btn');

    function validarFormulario() {
        const nombreValido = nombreInput.value.trim().length > 2;
        const participantes = participantesInput.value.trim().split('\n').filter(p => p.trim() !== '');
        const participantesValidos = participantes.length >= 2;
        
        const esValido = nombreValido && participantesValidos;
        crearBtn.disabled = !esValido;
        crearBtn.classList.toggle('enabled', esValido);
    }

    nombreInput.addEventListener('input', validarFormulario);
    participantesInput.addEventListener('input', validarFormulario);

// --- ESTE ES EL NUEVO BLOQUE DE C√ìDIGO ---
crearBtn.onclick = async () => {
    showSpinner("Creando y vinculando perfiles...");
    crearBtn.disabled = true;

    try {
        const nombreLista = nombreInput.value.trim();
        const moneda = document.getElementById('nueva-lista-moneda').value.trim() || '‚Ç¨';
        const creadorNombre = (appData.settings.nombre || `Usuario${chatId}`).trim();

        // 1. Obtener y unificar la lista de nombres de participantes (tu l√≥gica es correcta)
        const nombresDelTextarea = participantesInput.value.trim().split('\n').map(p => p.trim()).filter(p => p !== '');
        const nombresUnicos = new Set([creadorNombre, ...nombresDelTextarea]);
        const participantesNombres = Array.from(nombresUnicos);
        participantesInput.value = participantesNombres.join('\n');

        // 2. Procesar cada participante para obtener/crear su perfil de usuario
        const participantesProcesados = await Promise.all(participantesNombres.map(async (nombre) => {
            let idUsuario;
            let userDoc = null;

            // Buscar si el usuario ya existe por nombre
            const userQuery = await db.collection('usuarios').where('nombre', '==', nombre).limit(1).get();
            
            if (!userQuery.empty) {
                // Si existe, usamos su ID
                userDoc = userQuery.docs[0];
                idUsuario = userDoc.id;
            } else {
                // Si no existe, creamos un nuevo perfil para √©l
                const newUserRef = db.collection('usuarios').doc();
                idUsuario = newUserRef.id;
                await newUserRef.set({
                    nombre: nombre,
                    fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
                    listas: [] // Empezamos con un array de listas vac√≠o
                });
            }
            
            // Devolvemos el objeto completo para este participante
            return {
                nombre: nombre,
                token: generateCustomId('INV-'),
                idUsuario: idUsuario 
            };
        }));

        // 3. Encontrar el token del creador de forma segura
        const creadorData = participantesProcesados.find(p => p.nombre.toLowerCase() === creadorNombre.toLowerCase());
        if (!creadorData || !creadorData.token) {
            throw new Error("Error cr√≠tico: No se pudo encontrar el token del creador.");
        }
        const tokenDelCreador = creadorData.token;
        
        // 4. Crear la nueva lista en Firestore
        const listaId = `lista_${generateCustomId('')}`;
        const listaRef = db.collection('cuentasClaras_listas').doc(listaId);
        await listaRef.set({
            nombre: nombreLista,
            moneda: moneda,
            participantes: participantesProcesados, // Ahora incluye idUsuario
            token_creador: tokenDelCreador,
            miembros: [chatId],
            creador: chatId,
            estado: 'abierto',
            fecha_creacion: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 5. Actualizar el perfil de cada participante para a√±adir esta nueva lista
        const batch = db.batch();
        participantesProcesados.forEach(participante => {
            const userRef = db.collection('usuarios').doc(participante.idUsuario);
            batch.update(userRef, {
                listas: firebase.firestore.FieldValue.arrayUnion(listaId)
            });
        });
        await batch.commit();
        
        // --- INICIO: L√ìGICA DE INCREMENTO DEL CONTADOR ---
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        await countsRef.update({
            cuentasClarasCount: firebase.firestore.FieldValue.increment(1)
        });
        // --- FIN: L√ìGICA DE INCREMENTO DEL CONTADOR ---

        showToast("¬°Lista creada y perfiles vinculados con √©xito!");
        goBack();

    } catch (error) {
        console.error("Error al crear la lista:", error);
        showToast(error.message || "No se pudo crear la lista. Int√©ntalo de nuevo.", true);
        crearBtn.disabled = false;
    } finally {
        hideSpinner();
    }
};
}

async function renderPanelGestion(listaId) {
    navigationHistory.push(renderCuentasClarasLobby);
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header">
                <h2 id="gestion-nombre-lista">Cargando...</h2>
            </div>
            <div id="gestion-contenido">
                <div class="no-data-msg">Cargando datos de la lista...</div>
            </div>
        </div>
    `;
    
    try {
        const listaDoc = await db.collection('cuentasClaras_listas').doc(listaId).get();
        if (!listaDoc.exists) {
            showToast("Error: No se encontr√≥ la lista.", true);
            goBack();
            return;
        }

        const listaData = listaDoc.data();
        document.getElementById('gestion-nombre-lista').textContent = `Gestionar: "${listaData.nombre}"`;

        let participantsHtml = '<p style="padding: 0 10px; color: var(--muted);">Selecciona un participante para invitar:</p><ul id="participants-list" class="list-style-none" style="margin-top:10px;">';
        const baseUrl = 'https://asistentepersonal-4ad2b.web.app'; 
        
        listaData.participantes.forEach(participante => {
    const invitationLink = `${baseUrl}/lista/${listaId}?invitado=${participante.token}`;
    
    // 1. Mejora del texto de la invitaci√≥n para mayor claridad y formato.
    const shareText = `¬°Hola, ${participante.nombre}!\n\nTe invito a la lista de gastos "${listaData.nombre}".\n\nüëá Accede con tu enlace personal:`;

    // 2. L√≥gica para identificar y etiquetar al organizador.
    const esOrganizador = participante.token === listaData.token_creador;
    const organizadorLabel = esOrganizador ? ' <span class="list-item-subtitle" style="font-weight:normal; opacity:0.8;">(organizador)</span>' : '';

    participantsHtml += `
        <li class="list-item clickable participant-item" 
            data-share-text="${encodeURIComponent(shareText)}" 
            data-share-link="${encodeURIComponent(invitationLink)}"
            data-share-title="Invitaci√≥n a ${encodeURIComponent(listaData.nombre)}">
            <div class="list-item-content">
                <span class="list-item-title">${participante.nombre}${organizadorLabel}</span>
                <span class="list-item-subtitle">Toca para invitar</span>
            </div>
        </li>`;
});
        participantsHtml += '</ul>';

        const mobileOnlyButton = isMobileDevice() 
            ? `<button class="share-action-btn more-options-btn" style="background-color: #7f8c8d;" data-action="open-share-page">
                   <svg viewBox="0 0 24 24"><path fill="currentColor" d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,14.92 6,14.92C6.76,14.92 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z" /></svg>
               </button>`
            : '';

        const actionsHtml = `
            <div id="share-actions-container" style="display: none; padding: 15px; margin-top: 15px; background-color: var(--bg); border-radius: 10px;">
                <p id="share-actions-title" style="text-align:center; font-weight:500; margin-bottom:15px;"></p>
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="share-action-btn whatsapp-btn" style="background-color: #25D366;" data-action="whatsapp"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.35 3.48 16.84L2 22L7.32 20.55C8.75 21.33 10.36 21.8 12.04 21.8H12.05C17.5 21.8 21.95 17.35 21.95 11.9C21.95 9.28 20.94 6.85 19.1 4.99C17.25 3.14 14.81 2 12.04 2M16.57 13.95C16.37 14.45 15.38 15.05 15.11 15.2C14.84 15.35 14.53 15.41 14.24 15.26C13.94 15.11 13.06 14.81 12.08 13.95C10.88 12.89 10.24 11.65 10.09 11.4C9.94 11.15 10.12 10.98 10.27 10.83C10.4 10.7 10.55 10.5 10.69 10.3C10.84 10.15 10.89 10.03 10.79 9.88C10.69 9.73 10.24 8.53 10.04 8.03C9.84 7.53 9.64 7.6 9.49 7.6H9.04C8.84 7.6 8.53 7.68 8.26 7.93C7.98 8.18 7.34 8.76 7.34 9.95C7.34 11.15 8.29 12.3 8.44 12.45C8.59 12.6 10.04 14.83 12.31 15.75C14.58 16.68 14.93 16.53 15.38 16.48C15.83 16.43 16.71 15.86 16.91 15.31C17.11 14.76 17.11 14.28 17.06 14.18C17 14.08 16.77 13.95 16.57 13.95Z" /></svg></button>
                    <button class="share-action-btn telegram-btn" style="background-color: #0088cc;" data-action="telegram"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M9.78,18.65L10.26,14.21L18.46,7.5C18.85,7.11 18.42,6.92 18,7.31L9.62,13.23L5.32,11.86C4.89,11.72 4.88,11.37 5.37,11.16L19.37,5.16C19.87,4.96 20.34,5.25 20.14,5.83L17.14,19.83C16.94,20.33 16.47,20.44 16.1,20.05L12.06,16.64L9.78,18.65Z" /></svg></button>
                    <button class="share-action-btn twitter-btn" style="background-color: #1DA1F2;" data-action="twitter"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.26C11.73,8.63 11.77,8.98 11.84,9.31C8.16,9.12 4.88,7.37 2.6,4.79C2.22,5.42 2,6.16 2,6.94C2,8.43 2.77,9.75 3.94,10.54C3.22,10.52 2.53,10.31 1.91,10V10.03C1.91,12.11 3.38,13.85 5.4,14.26C5.02,14.37 4.61,14.42 4.19,14.42C3.92,14.42 3.65,14.39 3.39,14.34C3.9,16.03 5.4,17.26 7.2,17.29C5.74,18.46 3.9,19.16 2,19.16C1.63,19.16 1.27,19.14 0.91,19.12C2.73,20.33 4.91,21 7.2,21C16,21 20.28,13.58 20.28,7.5C20.28,7.29 20.27,7.09 20.26,6.89C21.1,6.25 21.85,5.45 22.46,4.5Z" /></svg></button>
                    ${mobileOnlyButton}
                </div>
            </div>
        `;
        // --- INICIO: NUEVO C√ìDIGO PARA A√ëADIR PARTICIPANTES ---
        const addButtonHtml = `
            <div class="add-article-btn-container">
                <button class="add-article-btn enabled" id="show-add-participant-modal-btn" style="background-color: var(--muted); max-width: 100%;">
                    ‚ûï A√±adir Participantes
                </button>
            </div>`;
        
        const modalHtml = `
            <div class="modal-overlay" id="add-participant-modal" style="display: none;">
                <div class="modal-content">
                    <div class="form-card">
                        <h3 class="modal-title" style="margin-bottom: 20px;">A√±adir a "${listaData.nombre}"</h3>
                        <label>Nuevos participantes (uno por l√≠nea)</label>
                        <textarea id="new-participants-textarea" rows="4" placeholder="Ana\nCarlos"></textarea>
                        <div class="button-group">
                            <button id="cancel-add-participant-btn" class="cancel">Cancelar</button>
                            <button id="confirm-add-participant-btn" class="enabled" disabled>A√±adir</button>
                        </div>
                    </div>
                </div>
            </div>`;

        document.getElementById('gestion-contenido').innerHTML = participantsHtml + addButtonHtml + actionsHtml + modalHtml;
        
        // Conectar botones del nuevo modal
        const addParticipantModal = document.getElementById('add-participant-modal');
        document.getElementById('show-add-participant-modal-btn').onclick = () => {
            addParticipantModal.style.display = 'flex';
            setTimeout(() => addParticipantModal.classList.add('show'), 10);
        };
        document.getElementById('cancel-add-participant-btn').onclick = () => {
            addParticipantModal.classList.remove('show');
            setTimeout(() => addParticipantModal.style.display = 'none', 300);
        };
        document.getElementById('confirm-add-participant-btn').onclick = () => {
            addParticipantsToList(listaId, listaData.participantes.map(p => p.nombre));
        };

        // L√≥gica para habilitar/deshabilitar el bot√≥n de a√±adir del modal
        const newParticipantsTextarea = document.getElementById('new-participants-textarea');
        const confirmAddBtn = document.getElementById('confirm-add-participant-btn');
        newParticipantsTextarea.oninput = () => {
            const hasText = newParticipantsTextarea.value.trim() !== '';
            confirmAddBtn.disabled = !hasText;
        };
        // --- FIN: NUEVO C√ìDIGO ---

        const participantsList = document.getElementById('participants-list');
        const actionsContainer = document.getElementById('share-actions-container');
        const actionsTitle = document.getElementById('share-actions-title');
        
        let activeShareData = {};

        participantsList.addEventListener('click', (e) => {
            const selectedItem = e.target.closest('.participant-item');
            if (!selectedItem) return;

            participantsList.querySelectorAll('.participant-item').forEach(item => item.classList.remove('selected'));
            selectedItem.classList.add('selected');

            activeShareData = {
                text: decodeURIComponent(selectedItem.dataset.shareText),
                link: decodeURIComponent(selectedItem.dataset.shareLink),
                title: decodeURIComponent(selectedItem.dataset.shareTitle)
            };
            
            const participantName = selectedItem.querySelector('.list-item-title').textContent;
            actionsTitle.textContent = `Invitar a ${participantName}`;
            actionsContainer.style.display = 'block';
        });

        actionsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.share-action-btn');
            if (!button) return;

            const action = button.dataset.action;
            const { text, link, title } = activeShareData;

            // Para WhatsApp y Twitter, juntamos el texto y el link para `openLink`
            const combinedTextForOpenLink = `${text}\n${link}`;

            switch(action) {
                case 'whatsapp':
                    tg.openLink(`https://wa.me/?text=${encodeURIComponent(combinedTextForOpenLink)}`);
                    break;
                case 'telegram':
                    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
                    break;
                case 'twitter':
                    tg.openLink(`https://twitter.com/intent/tweet?text=${encodeURIComponent(combinedTextForOpenLink)}`);
                    break;
                case 'open-share-page':
                    const shareUrl = `${baseUrl}/invite.html?text=${encodeURIComponent(text)}&link=${encodeURIComponent(link)}&title=${encodeURIComponent(title)}`;
                    tg.openLink(shareUrl);
                    break;
            }
        });

    } catch (error) {
        console.error("Error al cargar el panel de gesti√≥n:", error);
        showToast("No se pudo cargar la lista.", true);
        goBack();
    }
}

// --- INICIO: NUEVA FUNCI√ìN PARA A√ëADIR PARTICIPANTES A LA LISTA ---
async function addParticipantsToList(listaId, nombresExistentes) {
    const confirmBtn = document.getElementById('confirm-add-participant-btn');
    const originalBtnHTML = confirmBtn.innerHTML;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `<span class="spinner btn-spinner"></span> A√±adiendo...`;
    
    const textarea = document.getElementById('new-participants-textarea');
    const nombresNuevos = textarea.value.trim().split('\n')
        .map(p => p.trim())
        .filter(p => p && !nombresExistentes.includes(p)); // Filtra vac√≠os y ya existentes

    if (nombresNuevos.length === 0) {
        showToast("No hay nuevos participantes para a√±adir.", true);
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalBtnHTML;
        return;
    }

    try {
        // 1. Procesar cada nombre para obtener/crear su perfil de usuario
        const nuevosParticipantesProcesados = await Promise.all(nombresNuevos.map(async (nombre) => {
            let idUsuario;
            const userQuery = await db.collection('usuarios').where('nombre', '==', nombre).limit(1).get();
            
            if (!userQuery.empty) {
                idUsuario = userQuery.docs[0].id;
            } else {
                const newUserRef = db.collection('usuarios').doc();
                idUsuario = newUserRef.id;
                await newUserRef.set({
                    nombre: nombre,
                    fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
                    listas: []
                });
            }
            return { nombre: nombre, token: generateCustomId('INV-'), idUsuario: idUsuario };
        }));

        // 2. Actualizar el documento de la lista y los perfiles de los nuevos usuarios en un batch
        const batch = db.batch();
        const listaRef = db.collection('cuentasClaras_listas').doc(listaId);
        
        // A√±adir los nuevos participantes a la lista
        batch.update(listaRef, {
            participantes: firebase.firestore.FieldValue.arrayUnion(...nuevosParticipantesProcesados)
        });

        // A√±adir la lista al perfil de cada nuevo participante
        nuevosParticipantesProcesados.forEach(participante => {
            const userRef = db.collection('usuarios').doc(participante.idUsuario);
            batch.update(userRef, {
                listas: firebase.firestore.FieldValue.arrayUnion(listaId)
            });
        });

        await batch.commit();

        // 3. Cerrar modal y refrescar la vista
        const addParticipantModal = document.getElementById('add-participant-modal');
        addParticipantModal.classList.remove('show');
        setTimeout(() => {
            addParticipantModal.style.display = 'none';
            showToast(`${nombresNuevos.length} participante(s) a√±adido(s).`);
            renderPanelGestion(listaId); // ¬°La clave para refrescar la lista en pantalla!
        }, 300);

    } catch (error) {
        console.error("Error al a√±adir participantes:", error);
        showToast("No se pudieron a√±adir los participantes.", true);
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalBtnHTML;
    }
}
// --- FIN: NUEVA FUNCI√ìN ---

// ====================================================================================
// --- INICIO DEL BLOQUE DE REEMPLAZO (CALENDARIO SIMPLIFICADO + MEN√ö + BOT√ìN FLOTANTE) ---
// ====================================================================================
// --- NUEVA FUNCI√ìN DE AYUDA ---
function removeCalendarFAB() {
    const fab = document.getElementById('calendar-fab');
    if (fab) fab.remove();
}
function renderCalendarView() {
    currentCalendarView = 'month';
    currentCalendarDate = new Date();
    
    navigationHistory.push(() => {
        if (typeof unsubscribeCalendarEvents === 'function') {
            unsubscribeCalendarEvents();
            unsubscribeCalendarEvents = null;
        }
        // Asegurarse de que el bot√≥n + se elimina al salir de la vista de calendario
        const fab = document.getElementById('calendar-fab');
        if (fab) fab.remove();
        renderDashboard();
    });
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="calendar-header-sticky">
                 <div class="list-header" style="padding-bottom:0; justify-content: space-between; align-items: center;">
                    <div style="position: relative; z-index: 100;">
                        <button class="generic-menu-btn" id="calendar-view-menu-btn" style="font-size: 1.8rem; padding: 5px;">‚ò∞</button>
                        <div class="dropdown-menu" id="calendar-view-menu" style="top: 100%; left: 0; min-width: 120px;">
                            <a class="dropdown-item" data-view="day">Hoy</a>
                            <a class="dropdown-item" data-view="three_day">3 D√≠as</a>
                            <a class="dropdown-item" data-view="week">Semana</a>
                            <a class="dropdown-item" data-view="month">Mes</a>
                        </div>
                    </div>
                    <h2 style="margin:0; flex-grow: 1; text-align: left; padding-left: 15px;">üóìÔ∏è Mi Calendario</h2>
                </div>
                <div id="calendar-controls" style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0; padding: 0 10px;">
                    <button id="calendar-prev-btn" class="back-btn" style="font-size:1.5rem; margin-right:0;">‚óÄÔ∏è</button>
                    <h3 id="calendar-current-period" style="font-size:1.1rem; flex-grow:1; text-align:center; margin:0;">Cargando...</h3>
                    <button id="calendar-next-btn" class="back-btn" style="font-size:1.5rem; margin-left:0;">‚ñ∂Ô∏è</button>
                </div>
            </div>
            <div id="calendar-content" style="min-height:300px;"></div>
        </div>`;

    // --- BOT√ìN FLOTANTE (+) RESTAURADO ---
    const fab = document.createElement('button');
    fab.id = 'calendar-fab';
    fab.className = 'floating-action-button';
    fab.innerHTML = '+';
    fab.onclick = () => renderCalendarEventForm(null, renderCalendarView);
    document.body.appendChild(fab);

    const viewMenuBtn = document.getElementById('calendar-view-menu-btn');
    const viewMenu = document.getElementById('calendar-view-menu');
    
    viewMenuBtn.onclick = (e) => { e.stopPropagation(); viewMenu.classList.toggle('show'); };

    viewMenu.addEventListener('click', (e) => {
        const target = e.target.closest('.dropdown-item');
        if (target) {
            currentCalendarView = target.dataset.view;
            viewMenu.classList.remove('show');
            loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
        }
    });

    document.getElementById('calendar-prev-btn').onclick = () => {
        currentCalendarDate = getPreviousPeriodDate(currentCalendarView, currentCalendarDate);
        loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
    };
    document.getElementById('calendar-next-btn').onclick = () => {
        currentCalendarDate = getNextPeriodDate(currentCalendarView, currentCalendarDate);
        loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
    };
    
    loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
}

// Funciones auxiliares para la navegaci√≥n de fechas (actualizadas para "3 D√≠as")
function getPreviousPeriodDate(view, date) {
    const d = new Date(date);
    if (view === 'day') d.setDate(d.getDate() - 1);
    else if (view === 'three_day') d.setDate(d.getDate() - 3); // Retrocede 3 d√≠as
    else if (view === 'week') d.setDate(d.getDate() - 7);
    else d.setMonth(d.getMonth() - 1); // vista 'month'
    return d;
}

function getNextPeriodDate(view, date) {
    const d = new Date(date);
    if (view === 'day') d.setDate(d.getDate() + 1);
    else if (view === 'three_day') d.setDate(d.getDate() + 3); // Avanza 3 d√≠as
    else if (view === 'week') d.setDate(d.getDate() + 7);
    else d.setMonth(d.getMonth() + 1); // vista 'month'
    return d;
}

// Funci√≥n principal que carga los datos de Firestore y decide qu√© vista renderizar
function loadAndDisplayCalendarEvents(view, date) {
    showSpinner("Cargando calendario...");
    if (typeof unsubscribeCalendarEvents === 'function') unsubscribeCalendarEvents();

    const menuItems = document.querySelectorAll('#calendar-view-menu .dropdown-item');
    menuItems.forEach(item => item.classList.remove('active'));
    const activeItem = document.querySelector(`#calendar-view-menu .dropdown-item[data-view="${view}"]`);
    if (activeItem) activeItem.classList.add('active');

    let start = new Date(date); // Siempre creamos una nueva instancia para evitar mutaciones
    let end = new Date(date);
    const periodEl = document.getElementById('calendar-current-period');
    
    start.setHours(0,0,0,0);

    if (view === 'day') {
        // CORRECCI√ìN CLAVE: Creamos un nuevo objeto para 'end' para no modificar 'start'
        end = new Date(start); 
        end.setHours(23,59,59,999);
        currentCalendarDate = new Date(start);
        if (periodEl) periodEl.textContent = start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
    } else if (view === 'three_day') {
        end.setDate(end.getDate() + 2);
        end.setHours(23,59,59,999);
        if (periodEl) periodEl.textContent = `${start.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} - ${end.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}`;
    } else if (view === 'week') {
        const dayOfWeek = date.getDay();
        const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        start = new Date(date.getFullYear(), date.getMonth(), diff, 0, 0, 0, 0);
        end = new Date(start);
        end.setDate(start.getDate() + 6);
        end.setHours(23,59,59,999);
        if (periodEl) periodEl.textContent = `${start.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} - ${end.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}`;
    } else { // 'month'
        start = new Date(date.getFullYear(), date.getMonth(), 1, 0, 0, 0, 0);
        end = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59, 999);
        if (periodEl) periodEl.textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    }

    const q = db.collection('users').doc(chatId).collection(FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION).where('fechaInicio', '<=', end).orderBy('fechaInicio', 'asc');

	const userTimeZone = appData.settings.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;

	unsubscribeCalendarEvents = q.onSnapshot(snapshot => {
    if (!document.getElementById('calendar-content')) return;
    const allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), fechaInicio: doc.data().fechaInicio.toDate(), fechaFin: doc.data().fechaFin.toDate() }));
    const eventsInRange = allEvents.filter(e => e.fechaFin >= start);
    
    if (view === 'day') renderDayView(eventsInRange, currentCalendarDate, userTimeZone);
    else if (view === 'three_day') renderThreeDayView(eventsInRange, date, userTimeZone);
    else if (view === 'week') renderWeekView(eventsInRange, start, userTimeZone);
    else if (view === 'month') renderMonthView(eventsInRange, date);
    
    hideSpinner();
	}, error => { console.error("Error en listener de calendario:", error); hideSpinner(); 
});
}

// ====================================================================================
// --- FIN DEL BLOQUE DE REEMPLAZO ---
// ====================================================================================

// =========================================================================
// --- INICIO: NUEVA FUNCI√ìN DE C√ÅLCULO DE DISE√ëO DE EVENTOS ---
// =========================================================================
function calculateEventLayout(eventsForDay, HOUR_HEIGHT) {
    if (!eventsForDay || eventsForDay.length === 0) return [];

    // 1. Ordenar eventos por hora de inicio
    const sortedEvents = [...eventsForDay].sort((a, b) => a.fechaInicio - b.fechaInicio);

    // 2. Calcular 'top' y 'height' inicial para cada evento
    sortedEvents.forEach(event => {
        const startMinutes = event.fechaInicio.getHours() * 60 + event.fechaInicio.getMinutes();
        const endMinutes = event.fechaFin.getHours() * 60 + event.fechaFin.getMinutes();
        const durationMinutes = Math.max(30, (endMinutes - startMinutes)); // Duraci√≥n m√≠nima visual de 30 min
        
        event.layout = {
            top: (startMinutes / 60) * HOUR_HEIGHT,
            height: (durationMinutes / 60) * HOUR_HEIGHT,
            collisions: 1,
            colIndex: 0
        };
    });

    // 3. Detectar colisiones y determinar el ancho y la posici√≥n
    for (let i = 0; i < sortedEvents.length; i++) {
        const eventA = sortedEvents[i];
        let collisionGroup = [eventA];

        for (let j = i + 1; j < sortedEvents.length; j++) {
            const eventB = sortedEvents[j];
            // Si el evento B empieza antes de que el A termine, hay colisi√≥n
            if (eventB.fechaInicio < eventA.fechaFin) {
                collisionGroup.push(eventB);
            }
        }
        
        // Solo si hay m√°s de un evento colisionando, ajustamos el layout
        if (collisionGroup.length > 1) {
            // Re-evaluar el grupo para encontrar el n√∫mero m√°ximo de solapamientos simult√°neos
            const maxCollisions = collisionGroup.reduce((max, currentEvent) => {
                const simultaneous = collisionGroup.filter(e => e.fechaInicio < currentEvent.fechaFin && e.fechaFin > currentEvent.fechaInicio).length;
                return Math.max(max, simultaneous);
            }, 1);

            collisionGroup.forEach(eventInGroup => {
                // Asignamos el n√∫mero m√°ximo de colisiones detectado a todos los miembros del grupo
                eventInGroup.layout.collisions = Math.max(eventInGroup.layout.collisions, maxCollisions);
            });
        }
    }

    // 4. Asignar el √≠ndice de columna (posici√≥n horizontal)
    sortedEvents.forEach(event => {
        const collidingEvents = sortedEvents.filter(e => e !== event && e.fechaInicio < event.fechaFin && e.fechaFin > event.fechaInicio);
        const colIndicesTaken = collidingEvents.map(e => e.layout.colIndex);
        
        let assignedColIndex = 0;
        while (colIndicesTaken.includes(assignedColIndex)) {
            assignedColIndex++;
        }
        event.layout.colIndex = assignedColIndex;
    });


    return sortedEvents;
}
const EVENT_COLORS_PRESETS = [
    { value: '#039be5', label: 'Predeterminado (Trabajo)' },
    { value: '#e67c73', label: 'Salud / Citas' },
    { value: '#f6bf26', label: 'Personal / Ocio' },
    { value: '#33b679', label: 'Cumplea√±os / Eventos' },
    { value: '#8e24aa', label: 'Importante / Urgente' }
];
// =========================================================================
// --- FIN: NUEVA FUNCI√ìN DE C√ÅLCULO ---
// =========================================================================
async function handleTimelineClick(event) {
    const eventBlock = event.target.closest('.event-block, .month-event-pill');
    const emptySlot = event.target.closest('.calendar-day-col');

    // CASO 1: Se ha hecho clic en un evento existente
    if (eventBlock) {
        const eventId = eventBlock.dataset.eventId;
        if (!eventId) return;
        
        showSpinner();
        try {
            const eventDoc = await db.collection('users').doc(chatId).collection(FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION).doc(eventId).get();
            if (eventDoc.exists) {
                const eventData = eventDoc.data();
                renderCalendarEventForm({ id: eventDoc.id, ...eventData, fechaInicio: eventData.fechaInicio.toDate(), fechaFin: eventData.fechaFin.toDate() }, renderCalendarView);
            } else {
                showToast("El evento ya no existe.", true);
            }
        } catch (err) {
            showToast(`Error al cargar evento: ${err.message}`, true);
        } finally {
            hideSpinner();
        }
        return;
    }

    // CASO 2: Se ha hecho clic en un hueco vac√≠o
    if (emptySlot) {
        const HOUR_HEIGHT = 60;
        const dateISO = emptySlot.dataset.dateIso;
        if (!dateISO) return;

        const baseDate = new Date(dateISO);
        const clickY = event.offsetY;
        
        const totalMinutes = (clickY / HOUR_HEIGHT) * 60;
        const roundedMinutes = Math.floor(totalMinutes / 15) * 15; // Redondear hacia abajo al cuarto de hora m√°s cercano
        
        const startHour = Math.floor(roundedMinutes / 60);
        const startMinute = roundedMinutes % 60;

        const prefilledStartDate = new Date(baseDate);
        prefilledStartDate.setHours(startHour, startMinute, 0, 0);

        const prefilledEndDate = new Date(prefilledStartDate.getTime() + 60 * 60 * 1000); // 1 hora despu√©s

        renderCalendarEventForm(null, renderCalendarView, prefilledStartDate, prefilledEndDate);
    }
}
function renderDayView(events, currentDate, userTimeZone) {
    const contentEl = document.getElementById('calendar-content');
    const HOUR_HEIGHT = 60;
    const isToday = currentDate.toDateString() === new Date().toDateString();

    const allDayEvents = events.filter(e => e.esTodoElDia);
    const timedEvents = events.filter(e => !e.esTodoElDia);

    let allDayPillsHtml = '';
    allDayEvents.forEach(event => {
        allDayPillsHtml += `<div class="month-event-pill" data-event-id="${event.id}" style="background-color:${event.color || '#36A2EB'}; cursor:pointer;">${event.titulo}</div>`;
    });

    const structureHtml = `
    <div class="calendar-grid-container" style="height: calc(100vh - 220px);">
        <div class="calendar-all-day-header" style="grid-template-columns: 50px 1fr; top: 0;">
            <div class="all-day-label">Todo el d√≠a</div>
            <div class="all-day-slot">${allDayPillsHtml}</div>
        </div>
        <div class="calendar-scroll-body">
            <div class="calendar-time-col">
                 ${Array.from({length:24}, (_,h) => `<div class="calendar-time-slot"><span>${h.toString().padStart(2, '0')}:00</span></div>`).join('')}
            </div>
            <div class="calendar-events-grid" style="grid-template-columns: 1fr;">
                <div id="day-col-today" class="calendar-day-col" data-date-iso="${currentDate.toISOString()}"></div>
            </div>
        </div>
    </div>`;
    contentEl.innerHTML = structureHtml;

    const dayCol = document.getElementById('day-col-today');
    const layoutReadyEvents = calculateEventLayout(timedEvents, HOUR_HEIGHT);
    let dayEventsHtml = '';

    if (isToday) {
    // --- INICIO: L√≥gica de c√°lculo de hora actual robusta ---
    const nowUTC = new Date();
    
    // Obtenemos el offset en minutos para la zona horaria del usuario.
    // Intl.DateTimeFormat nos da las partes de la hora en esa zona.
    const parts = new Intl.DateTimeFormat('en-US', {
        timeZone: userTimeZone,
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    }).formatToParts(nowUTC);
    
    const getPart = (partName) => parseInt(parts.find(p => p.type === partName)?.value || '0', 10);
    
    const hoursInUserTimeZone = getPart('hour');
    const minutesInUserTimeZone = getPart('minute');
    
    // Calculamos la posici√≥n bas√°ndonos en la hora real de la zona del usuario.
    const nowPosition = ((hoursInUserTimeZone * 60 + minutesInUserTimeZone) / 60) * HOUR_HEIGHT;
    dayEventsHtml += `<div class="now-line" style="top: ${nowPosition}px; left:0; right:0;"></div>`;
    // --- FIN: L√≥gica robusta ---
}

    layoutReadyEvents.forEach(event => {
        const width = 100 / event.layout.collisions;
        const left = event.layout.colIndex * width;
        dayEventsHtml += `<div class="event-block" data-event-id="${event.id}" 
                             style="top:${event.layout.top}px; height:${event.layout.height}px; left:${left}%; width:${width}%; background-color:${event.color||'#36A2EB'}; box-sizing: border-box;">
                             <div class="event-block-title">${event.titulo}</div>
                             <div class="event-block-time">${event.fechaInicio.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit', timeZone: userTimeZone})}</div>
                          </div>`;
    });
    dayCol.innerHTML = dayEventsHtml;
    
    contentEl.removeEventListener('click', handleTimelineClick);
    contentEl.addEventListener('click', handleTimelineClick);

    if (isToday) {
        setTimeout(() => {
        const scrollBody = contentEl.querySelector('.calendar-scroll-body');
        const nowLine = contentEl.querySelector('.now-line');
        if (scrollBody && nowLine) {
            scrollBody.scrollTo({ top: nowLine.offsetTop - 50, behavior: 'smooth' });
        }
    }, 100);
}
}
	function renderWeekView(events, startOfWeek, userTimeZone) {
    const contentEl = document.getElementById('calendar-content');
    const HOUR_HEIGHT = 60;
    const allDayEvents = events.filter(e => e.esTodoElDia);
    const timedEvents = events.filter(e => !e.esTodoElDia);
    
    let headerDaysHtml = '', allDaySlotsHtml = '', eventGridColsHtml = '';
    const eventsByDay = {}; 

    for (let i = 0; i < 7; i++) {
        const day = new Date(startOfWeek);
        day.setDate(startOfWeek.getDate() + i);
        const isToday = day.toDateString() === new Date().toDateString();
        const dayNumber = isToday ? `<span class="day-number-circle">${day.getDate()}</span>` : `<span>${day.getDate()}</span>`;
        
        headerDaysHtml += `<div class="day-label ${isToday ? 'today':''}"><span class="day-name">${day.toLocaleDateString('es-ES',{weekday:'short'})}</span>${dayNumber}</div>`;
        
        const dayStart = new Date(new Date(day).setHours(0,0,0,0));
        const dayEnd = new Date(new Date(day).setHours(23,59,59,999));
        const allDayEventsForThisDay = allDayEvents.filter(e => e.fechaInicio <= dayEnd && e.fechaFin >= dayStart);
        
        let pillsHtml = allDayEventsForThisDay.map(event => 
            `<div class="month-event-pill" data-event-id="${event.id}" style="background-color:${event.color || '#36A2EB'}; cursor:pointer;">${event.titulo}</div>`
        ).join('');

        allDaySlotsHtml += `<div class="all-day-slot">${pillsHtml}</div>`;
        eventGridColsHtml += `<div id="day-col-week-${i}" class="calendar-day-col" data-date-iso="${day.toISOString()}"></div>`;
        eventsByDay[i] = [];
    }

    const structureHtml = `
    <div class="calendar-grid-container">
        <div class="calendar-header" style="grid-template-columns: 50px repeat(7, 1fr);">
            <div style="background-color: var(--card-bg);"></div>${headerDaysHtml}
        </div>
        <div class="calendar-all-day-header" style="grid-template-columns: 50px repeat(7, 1fr);">
            <div class="all-day-label">Todo el d√≠a</div>${allDaySlotsHtml}
        </div>
        <div class="calendar-scroll-body">
            <div class="calendar-time-col">
                ${Array.from({length:24}, (_,h) => `<div class="calendar-time-slot"><span>${h.toString().padStart(2, '0')}:00</span></div>`).join('')}
            </div>
            <div class="calendar-events-grid" style="grid-template-columns: repeat(7, 1fr);">${eventGridColsHtml}</div>
        </div>
    </div>`;
    contentEl.innerHTML = structureHtml;

    const viewEndDate = new Date(startOfWeek); viewEndDate.setDate(startOfWeek.getDate() + 7);
    timedEvents.filter(e => e.fechaInicio >= startOfWeek && e.fechaInicio < viewEndDate).forEach(event => {
        const diffDays = Math.floor((new Date(event.fechaInicio).setHours(0,0,0,0) - new Date(startOfWeek).setHours(0,0,0,0)) / (1000*3600*24));
        if (diffDays >= 0 && diffDays < 7) { eventsByDay[diffDays].push(event); }
    });
    
    for (let i = 0; i < 7; i++) {
        const dayCol = document.getElementById(`day-col-week-${i}`);
        const layoutReadyEvents = calculateEventLayout(eventsByDay[i], HOUR_HEIGHT);
        dayCol.innerHTML = layoutReadyEvents.map(event => {
            const width = 100 / event.layout.collisions;
            const left = event.layout.colIndex * width;
            return `<div class="event-block" data-event-id="${event.id}" 
                         style="top:${event.layout.top}px; height:${event.layout.height}px; left:${left}%; width:${width}%; background-color:${event.color||'#36A2EB'}; box-sizing: border-box;">
                         <div class="event-block-title">${event.titulo}</div>
                         <div class="event-block-time">${event.fechaInicio.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit', timeZone: userTimeZone})}</div>
                      </div>`;
        }).join('');
    }

    contentEl.removeEventListener('click', handleTimelineClick);
    contentEl.addEventListener('click', handleTimelineClick);
}
function renderThreeDayView(events, startDate, userTimeZone) {
    const contentEl = document.getElementById('calendar-content');
    const HOUR_HEIGHT = 60;
    const allDayEvents = events.filter(e => e.esTodoElDia);
    const timedEvents = events.filter(e => !e.esTodoElDia);

    let headerDaysHtml = '', allDaySlotsHtml = '', eventGridColsHtml = '';
    const eventsByDay = {}; 

    for (let i = 0; i < 3; i++) {
        const day = new Date(startDate); day.setDate(startDate.getDate() + i);
        const isToday = day.toDateString() === new Date().toDateString();
        const dayNumber = isToday ? `<span class="day-number-circle">${day.getDate()}</span>` : `<span>${day.getDate()}</span>`;
        
        headerDaysHtml += `<div class="day-label ${isToday ? 'today':''}"><span class="day-name">${day.toLocaleDateString('es-ES',{weekday:'short'})}</span>${dayNumber}</div>`;
        
        const dayStart = new Date(new Date(day).setHours(0,0,0,0));
        const dayEnd = new Date(new Date(day).setHours(23,59,59,999));
        const allDayEventsForThisDay = allDayEvents.filter(e => e.fechaInicio <= dayEnd && e.fechaFin >= dayStart);
        
        let pillsHtml = allDayEventsForThisDay.map(event => 
            `<div class="month-event-pill" data-event-id="${event.id}" style="background-color:${event.color || '#36A2EB'}; cursor:pointer;">${event.titulo}</div>`
        ).join('');

        allDaySlotsHtml += `<div class="all-day-slot">${pillsHtml}</div>`;
        eventGridColsHtml += `<div id="day-col-3day-${i}" class="calendar-day-col" data-date-iso="${day.toISOString()}"></div>`;
        eventsByDay[i] = [];
    }
    
    const structureHtml = `
    <div class="calendar-grid-container">
        <div class="calendar-header" style="grid-template-columns: 50px repeat(3, 1fr);">
            <div style="background-color: var(--card-bg);"></div>${headerDaysHtml}
        </div>
        <div class="calendar-all-day-header" style="grid-template-columns: 50px repeat(3, 1fr);">
            <div class="all-day-label">Todo el d√≠a</div>${allDaySlotsHtml}
        </div>
        <div class="calendar-scroll-body">
            <div class="calendar-time-col">
                ${Array.from({length:24}, (_,h) => `<div class="calendar-time-slot"><span>${h.toString().padStart(2, '0')}:00</span></div>`).join('')}
            </div>
            <div class="calendar-events-grid three-day" style="grid-template-columns: repeat(3, 1fr);">${eventGridColsHtml}</div>
        </div>
    </div>`;
    contentEl.innerHTML = structureHtml;
    
    const viewEndDate = new Date(startDate); viewEndDate.setDate(startDate.getDate() + 3);
    timedEvents.filter(e => e.fechaInicio >= startDate && e.fechaInicio < viewEndDate).forEach(event => {
        const diffDays = Math.floor((new Date(event.fechaInicio).setHours(0,0,0,0) - new Date(startDate).setHours(0,0,0,0)) / (1000*3600*24));
        if (diffDays >= 0 && diffDays < 3) { eventsByDay[diffDays].push(event); }
    });
    
    for (let i = 0; i < 3; i++) {
        const dayCol = document.getElementById(`day-col-3day-${i}`);
        const layoutReadyEvents = calculateEventLayout(eventsByDay[i], HOUR_HEIGHT);
        dayCol.innerHTML = layoutReadyEvents.map(event => {
            const width = 100 / event.layout.collisions;
            const left = event.layout.colIndex * width;
            return `<div class="event-block" data-event-id="${event.id}" 
                         style="top:${event.layout.top}px; height:${event.layout.height}px; left:${left}%; width:${width}%; background-color:${event.color||'#36A2EB'}; box-sizing: border-box;">
                         <div class="event-block-title">${event.titulo}</div>
                         <div class="event-block-time">${event.fechaInicio.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit', timeZone: userTimeZone})}</div>
                      </div>`;
        }).join('');
    }

    contentEl.removeEventListener('click', handleTimelineClick);
    contentEl.addEventListener('click', handleTimelineClick);
}
function renderMonthView(events, currentDate) {
    const contentEl = document.getElementById('calendar-content');
    const weekdays = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];

    // Contenedor principal que envuelve la cabecera y la cuadr√≠cula
    let finalHtml = `<div class="calendar-month-container">`;
    
    // Cabecera con los d√≠as de la semana
    let headerHtml = `<div class="calendar-month-header">`;
    weekdays.forEach(day => {
        headerHtml += `<div class="calendar-day-header">${day}</div>`;
    });
    headerHtml += `</div>`;
    finalHtml += headerHtml;

    // Cuadr√≠cula principal del mes
    let gridHtml = `<div class="calendar-month-grid">`;

    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    // Ajuste para que la semana empiece en Lunes (getDay() 0=Dom, 1=Lun...)
    const startDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; 

    // A√±adir celdas vac√≠as para los d√≠as del mes anterior
    for (let i = 0; i < startDayOfWeek; i++) {
        gridHtml += `<div class="calendar-day-cell empty" style="background-color: var(--bg);"></div>`; 
    }
    
    // Generar las celdas para cada d√≠a del mes
    for (let dayNum = 1; dayNum <= lastDay.getDate(); dayNum++) {
        const day = new Date(currentDate.getFullYear(), currentDate.getMonth(), dayNum);
        const isToday = day.toDateString() === new Date().toDateString();
        const dayStart = new Date(new Date(day).setHours(0,0,0,0));
        const dayEnd = new Date(new Date(day).setHours(23,59,59,999));
        
        // --- L√ìGICA CORREGIDA ---
        // Ahora solo filtramos los eventos que INICIAN en este d√≠a.
        const eventsForDay = events.filter(e => e.fechaInicio >= dayStart && e.fechaInicio <= dayEnd);
        
        // Empieza la celda del d√≠a
        gridHtml += `<div class="calendar-day-cell ${isToday ? 'today' : ''}" data-date="${day.toISOString()}">
                        <div class="calendar-day-number">${dayNum}</div>
                        <div class="month-events-container">`; // Contenedor para las pastillas

        // Genera las "pastillas" para los eventos del d√≠a
        eventsForDay.slice(0, 3).forEach(event => { // Muestra un m√°ximo de 3 eventos
            gridHtml += `<div class="month-event-pill" style="background-color:${event.color || '#36A2EB'};">${event.titulo}</div>`;
        });

        // Si hay m√°s de 3 eventos, muestra un indicador
        if (eventsForDay.length > 3) {
            gridHtml += `<div class="month-event-pill" style="background:var(--muted);">${eventsForDay.length - 3} m√°s...</div>`;
        }
        
        // Cierra los contenedores
        gridHtml += `   </div>
                      </div>`;
    }
    
    gridHtml += `</div>`; // Cierre de calendar-month-grid
    finalHtml += gridHtml;
    finalHtml += `</div>`; // Cierre de calendar-month-container
    
    contentEl.innerHTML = finalHtml;

    // A√±ade el listener para hacer clic en un d√≠a y cambiar a la vista de "Hoy" (vista de d√≠a)
    contentEl.querySelectorAll('.calendar-day-cell:not(.empty)').forEach(dayCell => {
        dayCell.onclick = (e) => {
            currentCalendarDate = new Date(e.currentTarget.dataset.date);
            // Cambiamos la vista activa a 'day' y recargamos
            currentCalendarView = 'day';
            loadAndDisplayCalendarEvents(currentCalendarView, currentCalendarDate);
        };
    });
}

function renderCalendarEventForm(event = null, onBackCallback, prefilledStartDate = null, prefilledEndDate = null) {
    navigationHistory.push(onBackCallback);
    updateBackButton();
    const isEditing = event && event.id;
    let currentNotifications = (isEditing && event.notificaciones) ? 
        event.notificaciones.map(n => ({ metodo: n.metodo, minutosAntes: n.minutosAntes })) : 
        [];

    const colorOptionsHtml = EVENT_COLORS_PRESETS.map(preset => 
        `<div class="custom-dropdown-item" data-value="${preset.value}">
            <span class="color-swatch" style="background-color:${preset.value};"></span>
            <span>${preset.label}</span>
        </div>`
    ).join('');
    
    const selectedColor = (isEditing && event.color) ? EVENT_COLORS_PRESETS.find(p => p.value === event.color) || EVENT_COLORS_PRESETS[0] : EVENT_COLORS_PRESETS[0];

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>${isEditing ? '‚úèÔ∏è Editar Evento' : '‚ûï Nuevo Evento'}</h2></div>
            <div class="form-card">
                <label>T√≠tulo</label><input type="text" id="event-title" value="${isEditing ? event.titulo : ''}" required />
                <label>Descripci√≥n</label><textarea id="event-description" rows="5">${isEditing ? event.descripcion : ''}</textarea>
                <div class="settings-item"><span class="settings-item-label">Todo el d√≠a</span><label class="switch"><input type="checkbox" id="event-all-day" ${isEditing && event.esTodoElDia ? 'checked' : ''}><span class="slider"></span></label></div>
                <div id="time-pickers">
                    <label>Inicio</label><div class="flatpickr-wrapper"><input type="text" id="event-start-date" required data-input/></div>
                    <label>Fin</label><div class="flatpickr-wrapper"><input type="text" id="event-end-date" required data-input/></div>
                </div>
                
                <label>Color</label>
                <div class="custom-dropdown">
                    <div class="custom-dropdown-selected" id="color-selector">
                        <span class="color-swatch" style="background-color:${selectedColor.value};"></span>
                        <span>${selectedColor.label}</span>
                    </div>
                    <div class="custom-dropdown-options" id="color-options">${colorOptionsHtml}</div>
                </div>
                <input type="hidden" id="event-color-value" value="${selectedColor.value}">

                <label style="margin-top:20px;">Notificaciones</label>
                <div id="notification-chips-container"></div>
                  <button id="add-notification-btn" style="width:100%; max-width:100%; margin:15px 0;" disabled>A√±adir Notificaci√≥n</button>
                <div class="button-group">
                    ${isEditing ? `<button id="delete-event-btn" class="cancel">Eliminar</button>` : `<button id="cancel-event-btn" class="cancel">Cancelar</button>`}
                    <button id="save-event-btn" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Evento'}</button>
                </div>
            </div>
        </div>`;
    
    const titleInput = document.getElementById('event-title');
    const saveBtn = document.getElementById('save-event-btn');
    const allDayCheckbox = document.getElementById('event-all-day');
    const timePickersDiv = document.getElementById('time-pickers');
    const chipsContainer = document.getElementById('notification-chips-container');
    const addNotificationBtn = document.getElementById('add-notification-btn');

    let initialStartDate;

    // --- INICIO: L√≥gica robusta de fecha por defecto ---
const userTimeZone = appData.settings.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;

// Funci√≥n para obtener la fecha/hora actual real en la zona del usuario
	const getNowInUserTimeZone = () => {
    const now = new Date();
    const parts = new Intl.DateTimeFormat('en-CA', { // 'en-CA' da YYYY-MM-DD
        timeZone: userTimeZone,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    }).formatToParts(now).reduce((acc, part) => ({ ...acc, [part.type]: part.value }), {});
    
    // Formato que flatpickr entiende sin conversiones: YYYY-MM-DD HH:MM:SS
    return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}:${parts.second}`;
};

	// --- L√ìGICA DE FECHAS CORREGIDA (V3) ---
const nowInUserZone = new Date(getNowInUserTimeZone());
const defaultStartDate = isEditing ? event.fechaInicio : (prefilledStartDate || nowInUserZone);
const defaultEndDate = isEditing ? event.fechaFin : (prefilledEndDate || new Date(defaultStartDate.getTime() + 60 * 60 * 1000));

const fpEnd = flatpickr(document.querySelector("#event-end-date").parentElement, {
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    enableTime: true, altInput: true, altFormat: "d/m/Y H:i", dateFormat: "Z",
    defaultDate: defaultEndDate,
    minDate: defaultStartDate
});

const fpStart = flatpickr(document.querySelector("#event-start-date").parentElement, {
    ...getFlatpickrBaseConfig(), // <-- A√ëADIDO
    enableTime: true, altInput: true, altFormat: "d/m/Y H:i", dateFormat: "Z",
    defaultDate: defaultStartDate,
    minDate: isEditing ? null : nowInUserZone, // Usamos la misma referencia de 'ahora'
    onChange: function(selectedDates) {
        const newStartDate = selectedDates[0];
        if (!newStartDate) return;
        fpEnd.setDate(new Date(newStartDate.getTime() + 60 * 60 * 1000), true);
        fpEnd.set('minDate', newStartDate);
    }
});

    const toggleTimePickers = () => {
        const isAllDay = allDayCheckbox.checked;
        timePickersDiv.style.display = isAllDay ? 'none' : 'block';
        const newFormat = isAllDay ? "d/m/Y" : "d/m/Y H:i";
        [fpStart, fpEnd].forEach(fp => {
            fp.set('enableTime', !isAllDay);
            fp.set('altFormat', newFormat);
            fp.redraw();
        });
    };
    allDayCheckbox.onchange = toggleTimePickers;
    toggleTimePickers();

    const colorSelector = document.getElementById('color-selector');
    const colorOptions = document.getElementById('color-options');
    const colorValueInput = document.getElementById('event-color-value');
    colorSelector.onclick = () => colorOptions.style.display = colorOptions.style.display === 'block' ? 'none' : 'block';
    
    colorOptions.querySelectorAll('.custom-dropdown-item').forEach(item => {
        item.onclick = () => {
            const value = item.dataset.value;
            const label = item.querySelector('span:last-child').textContent;
            colorValueInput.value = value;
            colorSelector.querySelector('.color-swatch').style.backgroundColor = value;
            colorSelector.querySelector('span:last-child').textContent = label;
            colorOptions.style.display = 'none';
        };
    });
    
    document.addEventListener('click', (e) => { if (!e.target.closest('.custom-dropdown')) { colorOptions.style.display = 'none'; } }, true);
    
    const getNotificationText = (notif) => {
        const mins = notif.minutosAntes;
        let text = '';
        if (mins >= 1440 && mins % 1440 === 0) text = `${mins/1440} d√≠a(s) antes`;
        else if (mins >= 60 && mins % 60 === 0) text = `${mins/60} hora(s) antes`;
        else text = `${mins} minutos antes`;
        if (notif.metodo === 'email') text += ' - correo';
        return text;
    };

    const renderChips = () => {
        chipsContainer.innerHTML = '';
        currentNotifications.forEach((notif, index) => {
            const chip = document.createElement('div');
            chip.className = 'notification-chip';
            chip.innerHTML = `<span>${getNotificationText(notif)}</span><span class="notification-chip-remove" data-index="${index}">&times;</span>`;
            chip.querySelector('.notification-chip-remove').onclick = (e) => {
                currentNotifications.splice(parseInt(e.target.dataset.index, 10), 1);
                renderChips();
            };
            chipsContainer.appendChild(chip);
        });
    };

    addNotificationBtn.onclick = () => showNotificationModal(currentNotifications, renderChips);
    renderChips();

    const validate = () => { 
        const isValid = titleInput.value.trim() !== '';
        saveBtn.disabled = !isValid;
        addNotificationBtn.disabled = !isValid;
        saveBtn.classList.toggle('enabled', isValid);
        addNotificationBtn.classList.toggle('enabled', isValid);
    };
    titleInput.oninput = validate;
    validate();
    
    // --- L√ìGICA DE GUARDADO CORREGIDA (V2) ---
saveBtn.onclick = () => {
    const eventId = isEditing ? event.id : null;
    const notifications = currentNotifications.map(n => ({...n})); // Pasamos una copia segura para evitar mutaciones
    // La llamada a saveCalendarEvent ahora es directa y maneja su propia UI.
    saveCalendarEvent(eventId, notifications);
};

    if (isEditing) {
        const deleteBtn = document.getElementById('delete-event-btn');
        deleteBtn.onclick = () => {
            const buttonGroup = deleteBtn.closest('.button-group');
            if (!buttonGroup) return;

            deleteBtn.style.display = 'none';
            saveBtn.style.display = 'none';

            const confirmYes = document.createElement('button');
            confirmYes.className = 'confirm-btn-yes enabled';
            confirmYes.textContent = 'S√≠, Eliminar';
            const originalYesText = confirmYes.textContent;

            const confirmNo = document.createElement('button');
            confirmNo.className = 'confirm-btn-no enabled';
            confirmNo.textContent = 'No';

            confirmYes.onclick = async () => {
                confirmYes.disabled = true;
                confirmNo.disabled = true;
                confirmYes.innerHTML = `<span class="spinner btn-spinner"></span> Eliminando...`;
                
                await handleDeleteCalendarEvent(event.id);
                
                confirmYes.disabled = false;
                confirmNo.disabled = false;
                confirmYes.innerHTML = originalYesText;
            };

            confirmNo.onclick = () => {
                deleteBtn.style.display = 'block';
                saveBtn.style.display = 'block';
                confirmYes.remove();
                confirmNo.remove();
            };

            buttonGroup.appendChild(confirmNo);
            buttonGroup.appendChild(confirmYes);
        };
    } else {
        document.getElementById('cancel-event-btn').onclick = goBack;
    }
}
function showNotificationModal(currentNotificationsRef, renderChipsCallback) {
    const modal = document.getElementById('notification-modal');
    const presetsView = document.getElementById('notification-presets-view');
    const customView = document.getElementById('notification-custom-view');
    const presetsList = document.getElementById('notification-presets-list');
    
    const notificationPresets = [
        { label: '5 minutos antes', value: 5, method: 'telegram' },
        { label: '10 minutos antes', value: 10, method: 'telegram' },
        { label: '1 hora antes', value: 60, method: 'telegram' },
        { label: '2 horas antes - correo', value: 120, method: 'email' },
        { label: '2 horas antes', value: 120, method: 'telegram' },
        { label: '1 d√≠a antes - correo', value: 1440, method: 'email' },
        { label: 'Personalizar...', value: 'custom' }
    ];

    presetsList.innerHTML = notificationPresets.map(p => {
        const icon = p.method === 'email' ? '‚úâÔ∏è' : 'üîî';
        return `
        <div class="preset-list-item" data-value='${JSON.stringify(p)}'>
             <span style="font-size:1.5rem; width: 35px; text-align:center;">${icon}</span>
             <span>${p.label}</span>
        </div>`;
    }).join('');

    const hideModal = () => {
        modal.classList.remove('show');
        setTimeout(() => { modal.style.display = 'none'; }, 300);

        // --- INICIO: Restaurar el comportamiento original del bot√≥n "Atr√°s" ---
        // Al cerrar el modal, devolvemos al bot√≥n "Atr√°s" su funci√≥n de navegaci√≥n normal.
        tg.BackButton.onClick(goBack);
        updateBackButton(); // Esto lo ocultar√° si no hay m√°s historial de navegaci√≥n.
        // --- FIN: Restaurar el comportamiento ---
    };

    const addNotification = (notifData) => {
        if (currentNotificationsRef.length >= 5) {
            showToast("Puedes a√±adir un m√°ximo de 5 notificaciones.", true);
            return;
        }
        currentNotificationsRef.push({ 
            metodo: notifData.method, 
            minutosAntes: notifData.value, 
            status: 'pending_creation' 
        });
        renderChipsCallback();
        hideModal();
    };

    presetsList.querySelectorAll('.preset-list-item').forEach(item => {
        item.onclick = () => {
            const data = JSON.parse(item.dataset.value);
            if (data.value === 'custom') {
                presetsView.style.display = 'none';
                customView.style.display = 'block';
            } else {
                addNotification(data);
            }
        };
    });

    document.getElementById('notification-modal-cancel').onclick = hideModal;
    document.getElementById('custom-notification-back').onclick = () => {
        customView.style.display = 'none';
        presetsView.style.display = 'block';
    };
    document.getElementById('custom-notification-done').onclick = () => {
        const value = parseInt(document.getElementById('custom-notification-value').value, 10);
        const unit = document.querySelector('input[name="custom_unit"]:checked').value;
        const method = document.querySelector('input[name="custom_method"]:checked').value;
        if (isNaN(value) || value < 1) {
            showToast("Introduce un n√∫mero v√°lido.", true);
            return;
        }
        let mins = value;
        if (unit === 'hours') mins = value * 60;
        else if (unit === 'days') mins = value * 1440;
        
        addNotification({ value: mins, method: method });
        
        setTimeout(() => {
            customView.style.display = 'none';
            presetsView.style.display = 'block';
        }, 300);
    };

    modal.onclick = (e) => { if (e.target === modal) hideModal(); };
    
    // --- INICIO: L√≥gica para controlar el bot√≥n "Atr√°s" del m√≥vil ---
    // Justo antes de mostrar el modal, le decimos al bot√≥n "Atr√°s" que su nueva
    // funci√≥n es, simplemente, cerrar el modal.
    if (tg && tg.BackButton) {
        tg.BackButton.onClick(hideModal);
        tg.BackButton.show();
    }
    // --- FIN: L√≥gica para controlar el bot√≥n "Atr√°s" ---

    modal.style.display = 'flex';
    setTimeout(() => { modal.classList.add('show'); }, 10);
}
async function saveCalendarEvent(eventId, notifications) {
    const title = document.getElementById('event-title').value.trim();
    const isEditing = !!eventId;
	let notificationsToSave = [];

    if (!title) {
        showToast("El t√≠tulo es obligatorio.", true);
        return; // Salimos directamente
    }

    const saveBtn = document.getElementById('save-event-btn');
    const originalBtnHTML = saveBtn.innerHTML;
    const otherBtn = document.getElementById('delete-event-btn') || document.getElementById('cancel-event-btn');

    saveBtn.disabled = true;
    if (otherBtn) otherBtn.disabled = true;
    saveBtn.innerHTML = `<span class="spinner btn-spinner"></span> Guardando...`;

    try {
        const getTrueUTCTimestamp = (dateFromPicker, userTimeZone) => {
            const year = dateFromPicker.getFullYear();
            const month = dateFromPicker.getMonth();
            const day = dateFromPicker.getDate();
            const hour = dateFromPicker.getHours();
            const minute = dateFromPicker.getMinutes();
            const timestampAsUTC = Date.UTC(year, month, day, hour, minute);
            const tempDate = new Date(timestampAsUTC);
            const utcParts = new Intl.DateTimeFormat('en-US', { timeZone: 'UTC', hour12: false, year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric' }).formatToParts(tempDate).reduce((acc, p) => ({ ...acc, [p.type]: p.value }), {});
            const userParts = new Intl.DateTimeFormat('en-US', { timeZone: userTimeZone, hour12: false, year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric' }).formatToParts(tempDate).reduce((acc, p) => ({ ...acc, [p.type]: p.value }), {});
            const hourDiff = (parseInt(userParts.hour, 10) % 24) - (parseInt(utcParts.hour, 10) % 24);
            let dayDiff = 0;
            if (parseInt(userParts.day, 10) > parseInt(utcParts.day, 10) || (parseInt(userParts.day, 10) === 1 && parseInt(utcParts.day, 10) > 20)) dayDiff = 1;
            if (parseInt(userParts.day, 10) < parseInt(utcParts.day, 10) || (parseInt(userParts.day, 10) > 20 && parseInt(utcParts.day, 10) === 1)) dayDiff = -1;
            const offsetInHours = hourDiff + (dayDiff * 24);
            const offsetMilliseconds = offsetInHours * 60 * 60 * 1000;
            return timestampAsUTC - offsetMilliseconds;
        };

        const userTimeZone = appData.settings.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;
        const isAllDay = document.getElementById('event-all-day').checked;

        let startDateFromPicker = document.getElementById('event-start-date').parentElement._flatpickr.selectedDates[0];
		let endDateFromPicker = document.getElementById('event-end-date').parentElement._flatpickr.selectedDates[0];

        if (isAllDay) {
            startDateFromPicker.setHours(0, 0, 0, 0);
            endDateFromPicker = new Date(startDateFromPicker);
            endDateFromPicker.setHours(23, 59, 59, 999);
        }

        if (endDateFromPicker < startDateFromPicker) {
            throw new Error("La fecha de fin no puede ser anterior a la de inicio.");
        }

        const finalStartDate = new Date(getTrueUTCTimestamp(startDateFromPicker, userTimeZone));
        const finalEndDate = new Date(getTrueUTCTimestamp(endDateFromPicker, userTimeZone));

        if (isEditing) {
    notificationsToSave = (notifications || []).map(notif => ({
        metodo: notif.metodo,
        minutosAntes: notif.minutosAntes,
        status: notif.status || 'pending_creation' // Conserva el estado si existe, si no, lo crea
    }));
	} else {
    notificationsToSave = (notifications || []).map(notif => ({
        metodo: notif.metodo,
        minutosAntes: notif.minutosAntes,
        status: 'pending_creation' // Siempre se crean al ser un evento nuevo
    }));
}

        const dataToSave = {
            titulo: title,
            descripcion: document.getElementById('event-description').value.trim(),
            color: document.getElementById('event-color-value').value,
            fechaInicio: firebase.firestore.Timestamp.fromDate(finalStartDate),
            fechaFin: firebase.firestore.Timestamp.fromDate(finalEndDate),
            esTodoElDia: isAllDay,
            notificaciones: notificationsToSave,
            status: 'pending_creation'
        };
        
        const collectionRef = db.collection('users').doc(chatId).collection(FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION);

        if (isEditing) {
            await collectionRef.doc(eventId).set(dataToSave, { merge: true });
        } else {
            await collectionRef.add(dataToSave);
        }
        
        // --- INICIO: L√≥gica de actualizaci√≥n condicional del badge ---
		// Comprobamos si el evento guardado ocurre hoy seg√∫n la zona horaria del usuario.
			const eventoGuardadoEsHoy = finalStartDate.toDateString() === new Date().toDateString();

		if (eventoGuardadoEsHoy) {
    // Si es para hoy, forzamos la resincronizaci√≥n completa.
    await recalculateAndSyncCalendarCount();
}
// --- FIN: L√≥gica de actualizaci√≥n condicional del badge ---
        
        goBack();

    } catch (err) {
        console.error("Error guardando evento en Firestore:", err);
        showToast(`Error al guardar: ${err.message}`, true);
        saveBtn.disabled = false;
        if (otherBtn) otherBtn.disabled = false;
        saveBtn.innerHTML = originalBtnHTML;
    }
}

/**
 * [NUEVA FUNCI√ìN PROFESIONAL]
 * Recalcula el n√∫mero de eventos para el d√≠a de hoy y actualiza el
 * documento de contadores en Firestore para garantizar la persistencia.
 */
async function recalculateAndSyncCalendarCount() {
    try {
        console.log("Sincronizando contador del calendario en Firestore...");
        const startOfToday = new Date();
        startOfToday.setHours(0, 0, 0, 0);
        const endOfToday = new Date();
        endOfToday.setHours(23, 59, 59, 999);

        const startTimestamp = firebase.firestore.Timestamp.fromDate(startOfToday);
        const endTimestamp = firebase.firestore.Timestamp.fromDate(endOfToday);

        const snapshot = await db.collection('users').doc(chatId).collection('eventos_calendario')
            .where('fechaInicio', '>=', startTimestamp)
            .where('fechaInicio', '<=', endTimestamp)
            .get();

        const todayCount = snapshot.size;

        // Actualizamos el documento maestro de contadores
        const countsRef = db.collection('users').doc(chatId).collection('_metadata').doc('counts');
        // --- INICIO: L√≥gica de actualizaci√≥n instant√°nea ---
		// 1. Actualizamos los datos y la UI localmente al instante.
		appData.counts.calendarTodayCount = todayCount;
		const calendarBadge = document.getElementById('calendar-badge');
		if (calendarBadge) {
		calendarBadge.textContent = todayCount;
}

// 2. Actualizamos Firestore en segundo plano.
await countsRef.update({
    calendarTodayCount: todayCount
});
// --- FIN: L√≥gica de actualizaci√≥n instant√°nea ---

        console.log(`Contador del calendario sincronizado en Firestore. Total para hoy: ${todayCount}`);
    } catch (error) {
        // Este error no debe detener al usuario, solo lo registramos.
        console.error("Error cr√≠tico al sincronizar el contador del calendario:", error);
    }
}

async function handleDeleteCalendarEvent(eventId) {
    // Se elimina la llamada a showSpinner(). La UI del bot√≥n se encargar√° del feedback.
    try {
        const eventRef = db.collection('users').doc(chatId).collection(FIRESTORE_EVENTOS_CALENDARIO_SUBCOLLECTION).doc(eventId);
        await eventRef.delete();
        
        await recalculateAndSyncCalendarCount();

        showToast("Evento eliminado con √©xito.");
        goBack(); // Volvemos a la vista del calendario
        
    } catch (err) { 
        showToast(`Error al eliminar: ${err.message}`, true); 
        // Si hay un error, la UI se quedar√° en el formulario para que el usuario sepa que algo fall√≥.
        // La reactivaci√≥n de los botones se gestionar√° en la funci√≥n que los crea.
    } 
    // Se elimina el 'finally' porque ya no hay spinner global que ocultar.
}

// ==================================================
// --- M√ìDULO: RADAR COMBUSTIBLE (VERSI√ìN 2.0) ---
// ==================================================
function renderCombustibleView() {
    let onMainButtonClick; 
    let map = null;
    let fullscreenMap = null;
    let currentStations = [];
    let markers = new Map();
    let fullscreenMarkers = new Map();

    navigationHistory.push(() => {
        if (tg && tg.MainButton.isVisible) {
            tg.MainButton.hide();
            if (onMainButtonClick) {
                tg.MainButton.offClick(onMainButtonClick);
            }
        }
        // Limpiar mapas al salir
        if (map) map.remove();
        if (fullscreenMap) fullscreenMap.remove();
        renderDashboard();
    });
    updateBackButton();

    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>‚õΩ Radar Combustible</h2></div>
            <div id="combustible-map-wrapper" style="position: relative; margin: 10px;">
                <div id="combustible-map" style="height: 300px; background-color: #e9e9e9; border-radius: 12px;"></div>
            </div>
            <div id="combustible-controls-container"></div>
            <div id="combustible-list"><div class="no-data-msg">Usa el bot√≥n de abajo para buscar cerca de ti.</div></div>
        </div>
    `;

    const mapContainer = document.getElementById('combustible-map');
    const listContainer = document.getElementById('combustible-list');
    const controlsContainer = document.getElementById('combustible-controls-container');

    const getDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 0.5 - Math.cos(dLat) / 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * (1 - Math.cos(dLon)) / 2;
        return R * 2 * Math.asin(Math.sqrt(a));
    };

    const openFullscreenMap = () => {
        const view = document.getElementById('map-fullscreen-view');
        const fullscreenMapContainer = document.getElementById('fullscreen-map-container');
        view.style.display = 'flex';

        if (!fullscreenMap) {
            fullscreenMap = L.map(fullscreenMapContainer);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(fullscreenMap);
        }

        setTimeout(() => {
            fullscreenMap.invalidateSize(); // ¬°Clave! Ajusta el tama√±o del mapa al contenedor visible
            if (map) {
                fullscreenMap.setView(map.getCenter(), map.getZoom() + 1);
            }
            fullscreenMarkers = drawStationsAndList(currentStations, fullscreenMap, document.querySelector('.sort-btn.active')?.dataset.sort || 'gasolina', true);
        }, 50); // Peque√±o delay para asegurar que el contenedor es visible

        document.getElementById('map-close-fullscreen-btn').onclick = () => {
            view.style.display = 'none';
        };
    };

    const renderSortedListAndMap = (sortBy) => {
        if (currentStations.length === 0) return;

        currentStations.sort((a, b) => {
            if (sortBy === 'distancia') return a.distance - b.distance;
            const priceKey = sortBy === 'gasolina' ? 'gasolina_95_e5' : 'gasoleo_a';
            const priceA = a.prices[priceKey] || 999;
            const priceB = b.prices[priceKey] || 999;
            const priceDifference = priceA - priceB;
            return priceDifference !== 0 ? priceDifference : a.distance - b.distance;
        });

        markers = drawStationsAndList(currentStations, map, sortBy);

        const handleItemClick = (container, markersMap) => {
            container.querySelectorAll('.combustible-list-item').forEach(item => {
                item.addEventListener('click', () => {
                    const stationId = item.dataset.id;
                    const marker = markersMap.get(stationId);
                    const targetMap = container === listContainer ? map : fullscreenMap;
                    if (marker && targetMap) {
                        targetMap.flyTo(marker.getLatLng(), 15);
                        marker.openPopup();
                    }
                });
            });
        };
        handleItemClick(listContainer, markers);

        controlsContainer.querySelectorAll('.sort-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.sort === sortBy);
        });
    };

    if (tg && tg.MainButton) {
        
        const handleLocationError = (error) => {
            tg.MainButton.hideProgress(); tg.MainButton.enable();
            let errorMsg = "No pudimos obtener tu ubicaci√≥n. Aseg√∫rate de que el GPS de tu m√≥vil est√© activado y tengas buena se√±al.";
            if (error && error.code === 1) errorMsg = "Permiso de ubicaci√≥n denegado. Revisa los ajustes de tu m√≥vil y de Telegram.";
            
            tg.showPopup({
                title: "Ubicaci√≥n no Encontrada", message: errorMsg,
                buttons: [{ id: 'retry', type: 'default', text: 'Reintentar' }, { id: 'cancel', type: 'cancel', text: 'Cancelar' }]
            }, (buttonId) => { if (buttonId === 'retry') requestLocationAndFetchStations(); });
            
            listContainer.innerHTML = `<div class="no-data-msg">Usa el bot√≥n de abajo para buscar cerca de ti.</div>`;
        };
        
        const requestLocationAndFetchStations = () => {
            tg.MainButton.showProgress(true); tg.MainButton.disable();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    listContainer.innerHTML = `<div class="combustible-loading-state"><p>Buscando gasolineras...</p><div class="dot-spinner"><div class="dot-spinner__dot"></div><div class="dot-spinner__dot"></div><div class="dot-spinner__dot"></div></div></div>`;
                    controlsContainer.innerHTML = '';
                    const { latitude, longitude } = position.coords;
                    
                    if (!map) {
                        map = L.map('combustible-map');
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    }
                    map.setView([latitude, longitude], 14);
                    
                    // A√±adir bot√≥n de expandir mapa
                    const mapWrapper = document.getElementById('combustible-map-wrapper');
                    if (!document.getElementById('map-expand-btn')) {
                        const expandBtn = document.createElement('button');
                        expandBtn.id = 'map-expand-btn';
                        expandBtn.className = 'map-expand-btn';
                        expandBtn.innerHTML = '‚õ∂';
                        expandBtn.onclick = openFullscreenMap;
                        mapWrapper.appendChild(expandBtn);
                    }
                    
                    (async () => {
                        try {
                            currentStations = await fetchStations(latitude, longitude, 5);
                            if (currentStations.length > 0) {
                                controlsContainer.innerHTML = `<div class="combustible-sort-controls"><button class="sort-btn" data-sort="gasolina">‚õΩ Gasolina</button><button class="sort-btn" data-sort="diesel">‚ö´ Di√©sel</button><button class="sort-btn" data-sort="distancia">üìç Distancia</button></div>`;
                                controlsContainer.querySelectorAll('.sort-btn').forEach(btn => btn.addEventListener('click', (e) => renderSortedListAndMap(e.target.dataset.sort)));
                                currentStations.forEach(s => { s.distance = getDistance(latitude, longitude, s.lat, s.lon); });
                                renderSortedListAndMap('gasolina');
                            } else {
                                listContainer.innerHTML = '<div class="no-data-msg">üö´<br>No se encontraron gasolineras en este radio.</div>';
                            }
                        } catch (fetchError) { handleLocationError(null); } 
                        finally { tg.MainButton.hideProgress(); tg.MainButton.enable(); }
                    })();
                },
                handleLocationError,
                { timeout: 12000, enableHighAccuracy: true }
            );
        };

        onMainButtonClick = () => {
            const fuelModalShown = localStorage.getItem('fuelModalShown');
            if (fuelModalShown === 'true') {
                requestLocationAndFetchStations();
            } else {
                const modal = document.getElementById('fuel-location-modal');
                const continueBtn = document.getElementById('fuel-modal-continue');
                const cancelBtn = document.getElementById('fuel-modal-cancel');
                const checkbox = document.getElementById('fuel-modal-checkbox');
                const hideModal = () => { modal.classList.remove('show'); setTimeout(() => { modal.style.display = 'none'; }, 300); };
                continueBtn.onclick = () => { if (checkbox.checked) localStorage.setItem('fuelModalShown', 'true'); hideModal(); requestLocationAndFetchStations(); };
                cancelBtn.onclick = hideModal;
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('show'), 10);
            }
        };
        
        tg.MainButton.offClick(onMainButtonClick);
        tg.MainButton.hideProgress();
        tg.MainButton.enable();
        tg.MainButton.setText("Buscar cerca de m√≠ üìç");
        tg.MainButton.setParams({ text_color: '#ffffff', color: '#4a76f3' });
        tg.MainButton.onClick(onMainButtonClick);
        tg.MainButton.show();
    }
    
    if (mapContainer && appData.settings.ubicacion && appData.settings.ubicacion.lat) {
        map = L.map('combustible-map').setView([appData.settings.ubicacion.lat, appData.settings.ubicacion.lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([appData.settings.ubicacion.lat, appData.settings.ubicacion.lon]).addTo(map).bindPopup('Tu ubicaci√≥n guardada');
    } else {
        mapContainer.innerHTML = '<div class="no-data-msg">Configura una ubicaci√≥n en Ajustes o usa el bot√≥n de abajo.</div>';
    }
}

// --- INICIO: L√≥gica para obtener y mostrar datos de gasolineras ---

// Funci√≥n de ayuda para ejecutar la b√∫squeda
const fetchStations = async (lat, lon, radius) => {
    try {
        const functionUrl = 'https://europe-west1-asistentepersonal-4ad2b.cloudfunctions.net/getFuelStations';
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { lat, lon, radius } })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || 'Error en la respuesta del servidor.');
        }
        
        const { stations } = await response.json();
        return stations;

    } catch (error) {
        console.error("Error al llamar a getFuelStations:", error);
        showToast(`Error: ${error.message}`, true);
        return []; // Devolvemos un array vac√≠o en caso de error
    }
};

// Funci√≥n para dibujar los pines en el mapa
const drawStationsAndList = (stations, map, sortBy = 'gasolina') => {
    if (!map) return;

    map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
    const listContainer = document.getElementById('combustible-list');
    const markersMap = new Map();

    if (stations.length === 0) {
        listContainer.innerHTML = '<div class="no-data-msg">üö´<br>No se encontraron gasolineras en este radio.</div>';
        return markersMap;
    }

    const blueIcon = new L.Icon.Default();
    const greenIcon = L.icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    let listHtml = '';
    stations.forEach((station, index) => {
        // El m√°s barato solo se resalta si se ordena por precio
        const isCheapest = index === 0 && sortBy !== 'distancia';
        const iconToUse = isCheapest ? greenIcon : blueIcon;
        
        const priceKey = sortBy === 'diesel' ? 'gasoleo_a' : 'gasolina_95_e5';
        const priceToShow = station.prices[priceKey];

        const popupContent = `
            <b>${station.label}</b><br>
            ${station.address}<br>
            Gasolina 95: <b>${station.prices.gasolina_95_e5 ? station.prices.gasolina_95_e5.toFixed(3) + '‚Ç¨' : 'N/D'}</b><br>
            Di√©sel A: <b>${station.prices.gasoleo_a ? station.prices.gasoleo_a.toFixed(3) + '‚Ç¨' : 'N/D'}</b>
            <br><br><a href="javascript:void(0);" onclick="Telegram.WebApp.openLink('https://www.google.com/maps/search/?api=1&query=${station.lat},${station.lon}')" style="padding: 5px 10px; background-color: #4a76f3; color: white; text-decoration: none; border-radius: 5px;">C√≥mo llegar</a>
        `;

        const marker = L.marker([station.lat, station.lon], { icon: iconToUse })
            .addTo(map)
            .bindPopup(popupContent);
        
        markersMap.set(station.id, marker);

        listHtml += `
            <div class="combustible-list-item ${isCheapest ? 'cheapest' : ''}" data-id="${station.id}">
                <div class="combustible-item-info">
                    <span class="combustible-item-name">${station.label}</span>
                    <span class="combustible-item-distance">a ${station.distance.toFixed(1)} km</span>
                </div>
                ${priceToShow ? `<span class="combustible-item-price">${priceToShow.toFixed(3)}‚Ç¨</span>` : ''}
            </div>
        `;
    });
    
    listContainer.innerHTML = listHtml;
    return markersMap;
};

// Ejecutamos la b√∫squeda inicial con la ubicaci√≥n de los ajustes
if (appData.settings.ubicacion && appData.settings.ubicacion.lat) {
    const initialLat = appData.settings.ubicacion.lat;
    const initialLon = appData.settings.ubicacion.lon;
    
    (async () => {
        const stations = await fetchStations(initialLat, initialLon, 20); // B√∫squeda inicial de 20 km
        drawStationMarkers(stations);
    })();
}
// --- FIN: L√≥gica para obtener y mostrar datos ---

// ==================================================
// --- CONECTOR E INICIO DE LA APP ---
// ==================================================
function renderDashboard() {
    removeCalendarFAB();
    setActiveTab('tab-home');
    navigationHistory = [];
    updateBackButton();
    const counts = appData.counts;
    const isPremium = appData.isPremium === true;
	const cards = {
        reminders: `
            <div class="card clickable-card" data-card-id="reminders" id="card-reminders" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/avisarme512x512.jpg?v=3'); background-size: cover; background-position: center;">
                <div class="card-badge red" id="reminders-badge">${counts.remindersCount || 0}</div>
                <button class="card-menu-btn" data-menu-id="menu-recordatorios">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">A√±adir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div>
            </div>`,
        shopping: `
            <div class="card clickable-card" data-card-id="shopping" id="card-shopping" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/listadeCompras512x512.jpg?v=3'); background-size: cover; background-position: center;">
                <div class="card-badge-group"><div class="card-badge green" id="shopping-pending-badge">${counts.shoppingPendingCount || 0}</div><div class="card-badge red" id="shopping-bought-badge">${counts.shoppingBoughtCount || 0}</div></div>
                <button class="card-menu-btn" data-menu-id="menu-shopping-list">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">A√±adir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div>
            </div>`,
        notes: `
            <div class="card clickable-card" data-card-id="notes" id="card-notes" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/notas512x512.jpg?v=3'); background-size: cover; background-position: center;">
                <div class="card-badge red" id="notes-badge">${counts.notesCount || 0}</div>
                <button class="card-menu-btn" data-menu-id="menu-notes">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">A√±adir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div>
            </div>`,
        calendar: `
            <div class="card clickable-card" data-card-id="calendar" id="calendar-card" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/calendario512x512.jpg?v=3'); background-size: cover; background-position: center;">
                <div class="card-badge red" id="calendar-badge">${counts.calendarTodayCount || 0}</div>
            </div>`,
        gastos: `
            <div class="card clickable-card" data-card-id="gastos" id="card-gastos" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/Gastos512x512.jpg?v=3'); background-size: cover; background-position: center;">
                <div class="card-badge card-badge-pill red" id="gastos-badge">${Number(counts.gastosMesActual || 0).toLocaleString('es-ES', { maximumFractionDigits: 0 })} ${appData.settings.moneda || ''}</div>
                <button class="card-menu-btn" data-menu-id="menu-gastos">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-gastos"><a class="dropdown-item" id="add-gasto-link">A√±adir</a><a class="dropdown-item" id="scan-gasto-link">Registrar Gasto con Foto</a><a class="dropdown-item" id="list-gastos-link">Ver/Buscar</a><a class="dropdown-item" id="view-gasto-chart-link">Ver Gr√°fico</a></div>
            </div>`,
        cuentasClaras: `
            <div class="card clickable-card" data-card-id="cuentasClaras" id="cuentas-claras-card" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/cuentasclaras512x512.jpg?v=3'); background-size: cover; background-position: center;">
                <div class="card-badge red" id="cuentas-claras-badge">${counts.cuentasClarasCount || 0}</div>
            </div>`,
        chef: isPremium 
            ? `<div class="card clickable-card" data-card-id="chef" id="chef-card" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/chef512x512.jpg?v=3'); background-size: cover; background-position: center;"></div>` 
            : `<div class="card disabled-card" data-card-id="chef" id="chef-card-locked" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/chef512x512.jpg?v=3'); background-size: cover; background-position: center;"></div>`,
        combustible: (() => {
            const fuelData = counts.fuelWidgetData;
            if (fuelData) {
                const getTrendIcon = (trend) => (trend === 'up' ? '‚ñ≤' : (trend === 'down' ? '‚ñº' : '='));
                const getTrendBgColor = (trend) => (trend === 'up' ? '#e74c3c' : (trend === 'down' ? '#2ecc71' : '#f39c12'));
                const formatLastUpdated = (dt) => {
                    if (!dt) return ''; const parts = dt.split(','); if (parts.length < 2) return dt; return `${parts[0]} ${parts[1].trim().slice(0, 5)}`;
                };
                const gasolinePill = fuelData.gasolinePrice ? `<div class="card-badge card-badge-pill" id="gasoline-pill" style="background-color: ${getTrendBgColor(fuelData.gasolineTrend)};">‚õΩ ${fuelData.gasolinePrice.toFixed(3)}${getTrendIcon(fuelData.gasolineTrend)}</div>` : '';
                const dieselPill = `<div class="card-badge card-badge-pill" id="diesel-pill" style="background-color: ${getTrendBgColor(fuelData.dieselTrend)};">‚ö´ ${fuelData.dieselPrice ? fuelData.dieselPrice.toFixed(3) : 'N/D'}${getTrendIcon(fuelData.dieselTrend)}</div>`;
                return `<div class="card clickable-card" data-card-id="combustible" id="combustible-card" style="background-image: url('${fuelData.mapImageUrl}'); background-size: cover; background-position: center;"><div class="card-badge-group">${gasolinePill}${dieselPill}</div><div style="position: absolute; bottom: 8px; right: 8px; font-size: 0.75rem; color: #fff; background-color: rgba(0,0,0,0.6); padding: 2px 5px; border-radius: 4px;">${formatLastUpdated(fuelData.lastUpdated)}</div></div>`;
            }
            if (appData.settings.pais && appData.settings.pais !== 'Espa√±a') return `<div class="card" data-card-id="combustible" style="background-image: url('https://asistentepersonal-4ad2b.web.app/icons/gasolinera512x512.jpg?v=3'); background-size: cover; background-position: center; position: relative;"><div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; text-align: center; color: white; padding: 15px; border-radius: 12px; font-size: 1.1rem;">Pr√≥ximamente en ${appData.settings.pais}</div></div>`;
            return `<div class="card clickable-card" data-card-id="combustible" id="combustible-card"><div class="card-icon">‚õΩ</div><div class="card-title">Combustible</div></div>`;
        })(),
        guiaTV: `<div id="guia-tv-card" data-card-id="guiaTV" class="card disabled-card" style="display: none;"><div class="card-icon">üì∫</div><div class="card-title">Gu√≠a TV</div></div>`,
		
		emergencias: `
    <div class="card clickable-card" data-card-id="emergencias" id="emergencias-card">
        <div class="card-icon" style="font-size: 3.5rem; line-height: 1;">üÜò</div>
        <div class="card-title">Emergencias</div>
    </div>`
    };
	
    // --- L√≥gica de Reconciliaci√≥n Autom√°tica del Dashboard ---
const masterCardList = Object.keys(cards); // La "Fuente de la Verdad" de todas las cards existentes
const defaultCardOrder = [
    'reminders', 'shopping', 'notes', 'calendar', 'gastos', 
    'cuentasClaras', 'chef', 'combustible', 'guiaTV', 'emergencias'
];
let userCardOrder = JSON.parse(localStorage.getItem('dashboardCardOrder')) || defaultCardOrder;

// 1. Limpieza: Eliminar cards obsoletas del orden del usuario
userCardOrder = userCardOrder.filter(cardId => masterCardList.includes(cardId));

// 2. Detecci√≥n de Novedades: A√±adir cards nuevas al final
masterCardList.forEach(cardId => {
    if (!userCardOrder.includes(cardId)) {
        userCardOrder.push(cardId);
    }
});

// Guardamos el orden reconciliado para la pr√≥xima vez
localStorage.setItem('dashboardCardOrder', JSON.stringify(userCardOrder));

// Usamos el orden final y reconciliado
const cardOrder = userCardOrder;
// --- Fin de la L√≥gica de Reconciliaci√≥n ---

    mainContentArea.innerHTML = `<div class="grid" id="dashboard-grid">${cardOrder.map(id => cards[id] || '').join('')}</div>`;
    
    // La clave: Llamamos a la funci√≥n de activaci√≥n despu√©s de un brev√≠simo instante.
    setTimeout(() => activateDashboardListeners(), 0);
}

function activateDashboardListeners() {
    const grid = document.getElementById('dashboard-grid');
    if (!grid) return;

    // Variable de estado en un alcance superior para ser compartida
    let isDragging = false;

    // 1. CONFIGURACI√ìN DE SORTABLEJS (SOLO PARA ARRASTRAR)
    new Sortable(grid, {
        animation: 150,
        forceFallback: true, // Mejora la compatibilidad y suavidad en m√≥viles
        delay: 200,          // Tiempo para diferenciar clic de arrastre
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        
        // Cuando el usuario empieza a arrastrar
        onStart: function () {
            isDragging = true;
        },

        // Cuando el usuario suelta la tarjeta
        onEnd: function (evt) {
            const newOrder = Array.from(grid.children).map(card => card.dataset.cardId);
            localStorage.setItem('dashboardCardOrder', JSON.stringify(newOrder));
            
            // CR√çTICO: Reseteamos la variable de estado despu√©s de un instante.
            // Esto evita que el evento 'click' que se dispara despu√©s de un arrastre sea procesado.
            setTimeout(() => {
                isDragging = false;
            }, 50);
        }
    });

    // 2. LISTENER DE CLIC (CORREGIDO Y DEFINITIVO)
grid.addEventListener('click', (event) => {
    // Si se est√° arrastrando, no hacer NADA.
    if (isDragging) {
        return;
    }

    const target = event.target;

    // --- L√ìGICA 1: ¬øSE HIZO CLIC EN UN ITEM DE MEN√ö? (LA M√ÅS IMPORTANTE) ---
    // Se procesa primero para asegurar que siempre funcione.
    const menuItem = target.closest('.dropdown-item');
    if (menuItem) {
        switch (menuItem.id) {
            case 'add-reminder-link': renderReminderForm(); break;
            case 'list-reminders-link': renderRemindersList(); break;
            case 'add-shopping-item-link': renderAddArticleForm(); break;
            case 'view-shopping-list-link': renderShoppingList(); break;
            case 'add-note-link': renderNoteForm(); break;
            case 'list-notes-link': renderNotesList(); break;
            case 'scan-gasto-link': renderInstructionScreen(); break;
            case 'add-gasto-link': renderAddGastoForm(); break;
            case 'list-gastos-link': navigationHistory.push(renderDashboard); updateBackButton(); renderGastosSearchScreen(); break;
            case 'view-gasto-chart-link': renderGastoChart(); break;
        }
        return; // Se ha manejado la acci√≥n, no hacer nada m√°s.
    }

    // --- L√ìGICA 2: ¬øSE HIZO CLIC EN UNA TARJETA? ---
    const card = target.closest('.card');
    if (card) {
        // Si el clic fue en un elemento interactivo que ya funciona O necesita l√≥gica especial
if (target.closest('.card-menu-btn, .card-badge-pill')) {
    const fuelPill = target.closest('.card-badge-pill[id$="-pill"]');
    if (fuelPill && appData.counts.fuelWidgetData) {
        // L√ìGICA DE LAS P√çLDORAS DE COMBUSTIBLE RESTAURADA
        const fuelData = appData.counts.fuelWidgetData;
        let pillData = {};

        if (fuelPill.id === 'gasoline-pill') pillData = { station: fuelData.gasolineStation, address: fuelData.gasolineAddress, schedule: fuelData.gasolineSchedule, mapUrl: fuelData.gasolineMapUrl };
        if (fuelPill.id === 'diesel-pill') pillData = { station: fuelData.dieselStation, address: fuelData.dieselAddress, schedule: fuelData.dieselSchedule, mapUrl: fuelData.dieselMapUrl };
        
        if (pillData.station) {
            tg.showPopup({
                title: pillData.station,
                message: `${pillData.address}\nHorario: ${pillData.schedule}`,
                buttons: [{ id: 'navigate', type: 'default', text: 'üó∫Ô∏è C√≥mo Llegar' }]
            }, (buttonId) => { if (buttonId === 'navigate' && pillData.mapUrl) tg.openLink(pillData.mapUrl); });
        }
    }
    // Para .card-menu-btn y otros elementos que no sean de combustible, simplemente detenemos la ejecuci√≥n aqu√≠.
    return;
}
        
        // Si es una tarjeta deshabilitada
        if (card.classList.contains('disabled-card')) {
            showToast('‚≠ê Funci√≥n exclusiva para usuarios Premium.');
            return;
        }

        // L√≥gica para abrir men√∫ o navegar
        const menuButton = card.querySelector('.card-menu-btn');
        if (menuButton) {
            // Si la tarjeta TIENE un men√∫, lo abrimos y detenemos el evento.
            menuButton.click();
            event.stopPropagation();
        } else {
            // Si la tarjeta NO tiene men√∫, navegamos.
            switch (card.id) {
				case 'emergencias-card': renderEmergenciasView(); break;
                case 'card-reminders': renderRemindersList(); break;
                case 'card-shopping': renderShoppingList(); break;
                case 'card-notes': renderNotesList(); break;
                case 'calendar-card': renderCalendarView(); break;
                case 'card-gastos': navigationHistory.push(renderDashboard); updateBackButton(); renderGastosSearchScreen(); break;
                case 'cuentas-claras-card': renderCuentasClarasLobby(); break;
                case 'chef-card': renderChefPage(); break;
                case 'combustible-card': renderCombustibleView(); break;
            }
        }
    }
});
}

// L√≥gica de pesta√±as
document.getElementById('tab-home').onclick = () => { destroyActiveFlatpickr(); renderDashboard(); };
document.getElementById('tab-settings').onclick = () => { destroyActiveFlatpickr(); renderSettings(); };
document.getElementById('tab-export').onclick = () => { destroyActiveFlatpickr(); renderExportPage(); };

// =========================================================================
// --- NUEVO PUNTO DE ENTRADA DE LA APP (GUARDI√ÅN DE VERSI√ìN) ---
// =========================================================================
// --- NUEVA FUNCI√ìN REUTILIZABLE PARA VERIFICAR VERSI√ìN ---
async function performVersionCheck(isResumeCheck = false) {
    // Guardi√°n: si el modal ya est√° visible, no hacemos nada para no molestar.
    const isModalVisible = document.getElementById('changelog-overlay')?.classList.contains('show');
    if (isModalVisible) {
        console.log("[Version Check] Modal ya visible, omitiendo re-verificaci√≥n.");
        return true; // Indicamos que el flujo de "actualizaci√≥n" ya est√° en proceso.
    }

    try {
        const localVersion = parseFloat(localStorage.getItem('app_version') || '0');
        const versionDocRef = db.collection('app_config').doc('version_info');
        const versionDoc = await versionDocRef.get();

        if (versionDoc.exists) {
            const serverVersionData = versionDoc.data();
            const serverVersion = parseFloat(serverVersionData.current_version) || 0;

            if (serverVersion > localVersion) {
                const changelogText = serverVersionData.changelog || "* Mejoras y correcciones.";
                showChangelogModal(serverVersion, changelogText);
                return true; // Devuelve TRUE porque se encontr√≥ y mostr√≥ una actualizaci√≥n.
            }
        }
        // Si llegamos aqu√≠, no hay actualizaci√≥n.
        return false; // Devuelve FALSE porque no se necesita actualizar.
    } catch (err) {
        console.error("Error en performVersionCheck:", err);
        return false; // En caso de error, asumimos que no hay actualizaci√≥n para no bloquear al usuario.
    }
}
async function checkVersionAndBootstrap() {
    // Log para verificar si el guardi√°n est√° siendo llamado m√°s de una vez.
    console.log(`[Arranque Guardi√°n] Chequeando guardi√°n. versionCheckPerformed = ${versionCheckPerformed}`);

    // Llamamos a nuestra nueva funci√≥n. Ella se encarga de todo.
    const updateFound = await performVersionCheck(false); // false indica que es el arranque inicial

    // Si la funci√≥n nos dice que NO encontr√≥ una actualizaci√≥n, entonces iniciamos la app.
    if (!updateFound) {
        console.log("[Arranque] No se encontr√≥ actualizaci√≥n. Iniciando carga principal...");
        initializeApp();
    }
}
});
</script>
</body>
</html>
