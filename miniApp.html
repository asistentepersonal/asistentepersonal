<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card.clickable-card { cursor: pointer; }
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:12px;min-width:24px;height:24px;padding:0 7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:24px;font-weight:500;}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;}
    .card-badge.red{background-color:#e74c3c;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; z-index: 10; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
	.dropdown-item { padding: 12px 20px; color: var(--text) !important; background-color: var(--card-bg, #fff) !important; cursor: pointer; display: block; text-align: left; transition: background-color 0.2s, color 0.2s; }
    .dropdown-item:hover { background-color: var(--primary, #4a76f3) !important; color: var(--action-text, #fff) !important; }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container, .settings-container, .export-container, .chef-container {max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input, .form-card select, .form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input, .form-card select{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text); background-color: var(--bg, #f5f7fa);}
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center; flex-wrap: wrap;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .form-card .button-group { display: flex; gap: 10px; margin-top: 20px; }
    .form-card .button-group button { flex: 1; margin-top: 0; }
    .form-card button.cancel { background-color: var(--delete-bg); opacity: 1; cursor: pointer; }
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 2s linear infinite;z-index:1001; text-align: center;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .list-style-none { list-style: none; padding: 0; margin: 0; }
    .list-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .list-item-content { display: flex; flex-direction: column; flex-grow: 1; text-align: left;}
    .list-item-title { font-size: 1.1rem; font-weight: 500; }
    .list-item-subtitle { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .list-item-actions { display: flex; align-items: center; gap: 5px; position: relative; flex-shrink: 0; }
    .generic-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-data-msg { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; font-size: 1.2rem; line-height: 1.5; }
    #recurrent-hours-container { display: none; margin-top: 15px; }
    .shopping-list-header-row { display: flex; align-items: center; justify-content: flex-end; padding: 0 10px 10px 10px; color: var(--muted); font-size: 0.9rem; }
    .shopping-list-header-row input[type="checkbox"] { margin-left: 5px; }
    .shopping-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .shopping-item-checkbox-wrapper { flex-shrink: 0; }
    .shopping-item input[type="checkbox"] { width: 20px; height: 20px; }
    .shopping-item-toggle-btn { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; color: var(--list-item-text); cursor: pointer; text-align: left; }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); }
    .shopping-item-toggle-btn .item-date { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; display:block; }
    .add-article-btn-container { padding: 10px; text-align: center; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .add-article-btn, .multi-select-action-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; flex-grow: 1; max-width: 250px; }
    .multi-select-action-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .shopping-list-section-title { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 10px 10px 10px; padding-top: 10px; border-top: 1px solid #eee; text-align: left; }
    .shopping-list-section-title:first-of-type { border-top: none; margin-top: 0; }
    .note-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .note-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; }
    .note-header-interactive { flex-grow: 1; padding-right: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .note-title-section { display: flex; flex-direction: column; text-align: left; }
    .note-title { font-size: 1.1rem; font-weight: 500; }
    .note-date { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .note-description { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    .note-item.open .note-description { max-height: 500px; padding: 0 15px 15px; }
    .expand-arrow { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
    .note-item.open .expand-arrow { transform: rotate(180deg); }
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; text-align: left;}
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; display: none; }
    .list-item.open .event-description { display: block; }
    .gasto-chart-container { text-align: center; margin-top: 15px; }
    .gasto-chart-container canvas { max-width: 100%; }
    .gasto-legend { list-style: none; padding: 15px 0 0 0; margin: 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .gasto-legend-item { display: flex; align-items: center; font-size: 0.9rem; }
    .gasto-legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; }
    .notification-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
    .notification-row .event-reminder-method { flex: 2 1 auto; min-width: 120px; }
    .notification-row .event-reminder-quantity { flex: 1 1 60px; text-align: right; }
    .notification-row .event-reminder-unit { flex: 2 1 auto; min-width: 90px; }
    .notification-row .remove-notification-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 0 5px; flex-shrink: 0; line-height: 1; }
    .notification-row select, .notification-row input { margin-top: 0 !important; width: auto; }
	#image-preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
	#image-preview-element { max-width: 90%; max-height: 70%; object-fit: contain; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
	#image-preview-actions { display: flex; gap: 20px; margin-top: 20px; width: 100%; max-width: 400px; }
	#image-preview-actions button { flex: 1; padding: 15px; font-size: 1.2rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; }
	#preview-send-btn { background-color: var(--action-bg); color: var(--action-text); }
	#preview-cancel-btn { background-color: var(--delete-bg); color: var(--delete-text); }
	.scan-instruction-screen { text-align: center; padding: 40px 20px; display: flex; flex-direction: column; justify-content: center; height: 100vh; }
	.scan-instruction-screen h2 { font-size: 1.6rem; margin-bottom: 20px; }
	.scan-instruction-screen ol { text-align: left; margin: 0 auto 30px auto; max-width: 300px; }
	.scan-instruction-screen li { margin-bottom: 10px; line-height: 1.5; }
	.scan-instruction-screen .add-article-btn { max-width: 100%; }
	.dropdown-item { background-color: var(--menu-bg, #fff); }
	.form-card textarea, .form-card input, .form-card select { background-color: var(--card-bg, #fff); color: var(--text, #333); border: 1px solid var(--muted, #ddd); }
	.dropdown-menu { background-color: var(--card-bg, #fff); }
    .settings-section-title { font-size: 1.3rem; font-weight: 600; color: var(--text); margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid #eee; text-align: left;}
    .settings-section-title:first-of-type { margin-top: 0; }
    .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
    .settings-item-label { font-size: 1.1rem; }
    .settings-item-control { flex-shrink: 0; margin-left: 15px; }
    .settings-item-control input, .settings-item-control select { margin-top:0 !important; width: auto; max-width: 150px;}
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }
    .chef-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .chef-item label { margin-top:0; }
    #chef-peticion-ayuda { font-size: 0.85rem; color: var(--muted); margin-top: 5px; display: block; }
    .recipe-card { background: var(--card-bg); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .recipe-header { padding: 15px; border-bottom: 1px solid #eee; }
    .recipe-title { font-size: 1.2rem; font-weight: 600; }
    .recipe-body { padding: 15px; }
    .recipe-description { margin-bottom: 15px; line-height: 1.5; }
    .recipe-subtitle { font-size: 1rem; font-weight: 500; margin-bottom: 8px; }
    .recipe-ingredient-list li { list-style: none; margin-bottom: 5px; }
    .recipe-ingredient-list.buy li { display: flex; align-items: center; }
    .recipe-ingredient-list.buy input { margin-right: 10px; width: 18px; height: 18px; }
  </style>
  </head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="main-content-area">
    <!-- El contenido del Dashboard o de Ajustes se renderizar√° aqu√≠ -->
  </div>
  <div class="tabs">
    <div class="tab active" id="tab-home">üè† Home</div>
    <div class="tab" id="tab-chef">üßë‚Äçüç≥ Chef</div>
    <div class="tab" id="tab-export">üìä Exportar Gastos</div>
    <div class="tab" id="tab-settings">‚öôÔ∏è Ajustes</div>
  </div>
  <div id="toast" class="toast"></div>
  <div id="image-preview-overlay" style="display: none;">
    <img id="image-preview-element" src="" alt="Vista previa del ticket" />
    <div id="image-preview-actions">
        <button id="preview-cancel-btn">Cancelar</button>
        <button id="preview-send-btn">Enviar</button>
    </div>
  </div>
      <script>
    document.addEventListener('DOMContentLoaded', () => {

    
// ==================================================
// --- N√öCLEO JAVASCRIPT (SETUP Y FUNCIONES GLOBALES) ---
// ==================================================
const tg = window.Telegram?.WebApp;
if (tg) { tg.expand(); if (tg.themeParams) { document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa'); document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff'); document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333'); document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555'); document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3'); document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff'); } }

const gasWebhookURL = 'https://script.google.com/macros/s/AKfycbxenwF0_F1yz0OJ7Kau7W2-HxqZqq5HIGD-GUdENpduign5J8xewfQJWBfGZpM04vHe/exec';
const chefWebhookURL = 'https://hook.eu2.make.com/p6z2dgx6medjbx47udphv5nz2blqcvm8';
const makeTicketWebhookUrl = 'https://hook.eu2.make.com/d3lj3iug4qsbyjdmalmh3sk491elhqps';
let selectedImageFile = null;
let chatId = tg?.initDataUnsafe?.user?.id;
if (!chatId) { chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', '6840956330'); }

let appData = { counts: {}, remindersList: [], shoppingList: [], notesList: [], calendarEvents: [], settings: {}, isPremium: false };
let initialUserSettings = {};
const mainContentArea = document.getElementById('main-content-area');
const spinner = document.getElementById('spinner');

function showSpinner(message = '') { 
    spinner.innerHTML = message ? `<div style="color:var(--text); margin-top:50px; font-size:1rem;">${message}</div>` : '';
    spinner.style.display = 'block'; 
}
function hideSpinner() { spinner.style.display = 'none'; }
function showToast(msg, isError = false) { let toastTimer; clearTimeout(toastTimer); const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); }

async function fetchWithTimeout(resource, payloadObject, isMakeWebhook = false) {
  const controller = new AbortController();
  const timeout = isMakeWebhook ? 60000 : 30000;
  const id = setTimeout(() => controller.abort(), timeout);
  
  let options = { method: 'POST', signal: controller.signal };
  if (isMakeWebhook) {
      const formData = new FormData();
      formData.append('prompt', payloadObject.prompt);
      if (payloadObject.images && payloadObject.images.length > 0) {
        payloadObject.images.forEach(imageFile => {
            formData.append('images', imageFile, imageFile.name);
        });
      }
      options.body = formData;
  } else {
      const formData = new FormData();
      formData.append("postData", JSON.stringify(payloadObject));
      options.body = formData;
  }
  
  try {
    const response = await fetch(resource, options);
    clearTimeout(id);
    if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
    return response;
  } catch (error) {
    clearTimeout(id);
    if (error.name === 'AbortError') throw new Error('La solicitud tard√≥ demasiado.');
    throw error;
  }
}

async function initializeApp() { 
  showSpinner(); 
  try { 
    const res = await fetchWithTimeout(gasWebhookURL, { Type: 'get_full_dashboard', chat_ID: chatId }); 
    const data = await res.json(); 
    if (data.error) throw new Error(data.error); 
    appData = data; 
    renderDashboard(); 
  } catch (err) { 
    console.error('Error en carga inicial:', err); 
    showToast(`Error al cargar datos: ${err.message}`, true); 
    mainContentArea.innerHTML = `<div class="no-data-msg">‚ùå<br>Error al cargar la aplicaci√≥n.<br><small>${err.message}</small><br><br><button onclick="initializeApp()">Reintentar</button></div>`; 
  } finally { 
    hideSpinner(); 
  } 
}

function setActiveTab(activeTabId) { 
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); 
  const activeTab = document.getElementById(activeTabId); 
  if (activeTab) activeTab.classList.add('active'); 
}

document.body.addEventListener('click', (e) => {
    const menuBtn = e.target.closest('.card-menu-btn, .generic-menu-btn');
    if (!menuBtn && !e.target.closest('.dropdown-menu')) { document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show')); return; }
    if (menuBtn) { e.stopPropagation(); const menuId = menuBtn.dataset.menuId; const menu = document.getElementById(menuId); if (menu) { const isShown = menu.classList.contains('show'); document.querySelectorAll('.dropdown-menu.show').forEach(m => { if (m.id !== menuId) m.classList.remove('show'); }); menu.classList.toggle('show', !isShown); } }
});

window.confirmDelete = function(type, id) {
    const itemElement = document.getElementById(`item-${id}`);
    if (!itemElement) return;
    const actionsContainer = itemElement.querySelector('.list-item-actions');
    const menuButton = actionsContainer.querySelector('.generic-menu-btn');
    const dropdown = actionsContainer.querySelector('.dropdown-menu');
    if (dropdown) dropdown.classList.remove('show');
    if (menuButton) menuButton.style.display = 'none';
    
    const confirmBtnYes = document.createElement('button');
    confirmBtnYes.className = 'confirm-btn-yes';
    confirmBtnYes.textContent = 'S√≠';
    confirmBtnYes.onclick = (e) => { e.stopPropagation(); executeDelete(type, id); };

    const confirmBtnNo = document.createElement('button');
    confirmBtnNo.className = 'confirm-btn-no';
    confirmBtnNo.textContent = 'No';
    confirmBtnNo.onclick = (e) => { e.stopPropagation(); if(menuButton) menuButton.style.display = 'block'; confirmBtnYes.remove(); confirmBtnNo.remove(); };
    
    actionsContainer.appendChild(confirmBtnYes);
    actionsContainer.appendChild(confirmBtnNo);
}

async function executeDelete(type, id) {
    let payload = { chat_ID: chatId };
    let successMessage = '';
    let viewToRender = null;
    try {
        switch(type) {
            case 'reminder':
                payload.Type = 'delete_reminder'; payload.tracking_code = id; successMessage = 'Recordatorio eliminado';
                const reminderIndex = appData.remindersList.findIndex(r => r.tracking_code === id);
                if (reminderIndex > -1) { appData.remindersList.splice(reminderIndex, 1); appData.counts.remindersCount = Math.max(0, appData.counts.remindersCount - 1); viewToRender = renderRemindersList; }
                break;
            case 'shopping_item':
                payload.Type = 'delete_item_shopping_list'; payload.tracking_code = id; successMessage = 'Art√≠culo eliminado';
                const itemIndex = appData.shoppingList.findIndex(i => i['3'] === id);
                if (itemIndex > -1) {
                    const item = appData.shoppingList[itemIndex];
                    if (item['2'] === 'Pendiente') { appData.counts.shoppingPendingCount = Math.max(0, appData.counts.shoppingPendingCount - 1); } 
                    else { appData.counts.shoppingBoughtCount = Math.max(0, appData.counts.shoppingBoughtCount - 1); }
                    appData.shoppingList.splice(itemIndex, 1);
                    viewToRender = renderShoppingList;
                }
                break;
            case 'note':
                payload.Type = 'delete_note'; payload.note_id = id; successMessage = 'Nota eliminada';
                const noteIndex = appData.notesList.findIndex(n => n.Nota_ID === id);
                if (noteIndex > -1) { appData.notesList.splice(noteIndex, 1); appData.counts.notesCount = Math.max(0, appData.counts.notesCount - 1); viewToRender = renderNotesList; }
                break;
            case 'calendar_event':
                payload.Type = 'delete_calendar_event'; payload.eventId = id; successMessage = 'Evento eliminado';
                const eventIndex = appData.calendarEvents.findIndex(e => e.id === id);
                if (eventIndex > -1) {
                    const event = appData.calendarEvents[eventIndex];
                    const eventDateStr = event.start.dateTime || event.start.date;
                    if (eventDateStr) {
                      const eventDate = new Date(eventDateStr).toISOString().split('T')[0];
                      if (eventDate === new Date().toISOString().split('T')[0]) { appData.counts.calendarTodayCount = Math.max(0, appData.counts.calendarTodayCount - 1); }
                    }
                    appData.calendarEvents.splice(eventIndex, 1);
                    viewToRender = () => renderCalendarView(appData.calendarEvents);
                }
                break;
            case 'gasto':
                payload.Type = 'delete_gasto_id'; payload.ID_Unico = id; successMessage = 'Gasto eliminado';
                const gastoIndex = gastosEncontrados.findIndex(g => g.ID_Unico === id);
                if (gastoIndex > -1) {
                    const gastoToDelete = gastosEncontrados[gastoIndex];
                    const importeARestar = parseFloat(gastoToDelete.Importe);
                    const gastosActualesNum = parseFloat(String(appData.counts.gastosMesActual).replace(/\./g, '').replace(',', '.'));
                    const nuevosGastosTotal = gastosActualesNum - importeARestar;
                    appData.counts.gastosMesActual = nuevosGastosTotal.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    
                    gastosEncontrados.splice(gastoIndex, 1);
                    document.getElementById(`item-${id}`)?.remove();
                    renderDashboard(); 
                }
                break;
            default: return;
        }
        if (viewToRender) viewToRender();
        if (type === 'calendar_event') renderDashboard();
    } catch(e) { showToast('Error local al procesar.', true); return; }
    try {
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast(successMessage);
    } catch (err) {
        showToast(`Error: ${err.message}. Restaurando...`, true);
        initializeApp();
    }
}

function manageBackButton(show, onClickHandler) {
    if (tg && tg.BackButton) {
        tg.BackButton.offClick();
        if (show) {
            tg.BackButton.show();
            tg.BackButton.onClick(onClickHandler);
        } else {
            tg.BackButton.hide();
        }
    }
}

// ==================================================
// --- M√ìDULO: RECORDATORIOS ---
// ==================================================
function renderReminderForm() {
  manageBackButton(true, renderDashboard);
  mainContentArea.innerHTML = `
    <div class="list-container">
      <div class="list-header"><h2>üìù Nuevo Recordatorio</h2></div>
      <div class="form-card">
        <label>Descripci√≥n</label><textarea id="text" rows="3" required></textarea>
        <label>Fecha y hora</label><input type="text" id="time" required/>
        <label>Tipo</label>
        <div class="radio-group" id="reminder-type-group">
          <label><input type="radio" name="category" value="Un solo uso" checked/> √önico</label>
          <label><input type="radio" name="category" value="Diario"/> Diario</label>
          <label><input type="radio" name="category" value="Recurrente"/> Recurrente</label>
        </div>
        <div id="recurrent-hours-container">
          <label>Repetir cada...</label>
          <select id="recurrent-hours">${[...Array(11).keys()].map(i => `<option value="${i + 2}">${i + 2} horas</option>`).join('')}</select>
        </div>
        <button id="sendBtn" disabled>Crear Recordatorio</button>
      </div>
    </div>`;
  const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), sendBtn = document.getElementById('sendBtn'), radios = document.querySelectorAll('input[name="category"]'), recurrentContainer = document.getElementById('recurrent-hours-container');
  flatpickr("#time", { enableTime: true, dateFormat: "Y-m-d H-i", defaultDate: new Date(), locale: "es", minDate: "today" });
  function toggleRecurrentField() { const selected = document.querySelector('input[name="category"]:checked').value; recurrentContainer.style.display = selected === 'Recurrente' ? 'block' : 'none'; }
  function validate() { const isValid = textInput.value.trim() !== '' && timeInput.value && document.querySelector('input[name="category"]:checked'); sendBtn.disabled = !isValid; sendBtn.classList.toggle('enabled', isValid); }
  textInput.oninput = validate; timeInput.oninput = validate; radios.forEach(r => r.onchange = () => { toggleRecurrentField(); validate(); });
  sendBtn.onclick = saveReminder;
  toggleRecurrentField(); validate();
}

async function saveReminder() {
  const category = document.querySelector('input[name="category"]:checked').value;
  const description = document.getElementById('text').value.trim();
  const time = document.getElementById('time')._flatpickr.selectedDates[0];
  const horas_recurrentes = category === 'Recurrente' ? document.getElementById('recurrent-hours').value : null;
  const payload = { chat_ID: chatId, Type: 'add_reminder', description, time: time.toISOString(), category, horas_recurrentes };
  appData.counts.remindersCount++;
  const tempId = 'temp-' + Date.now();
  appData.remindersList.unshift({ 'Fecha': new Date().toLocaleString(), 'Descripcion': description, 'Categoria': category, 'tracking_code': tempId });
  renderDashboard();
  showToast('Recordatorio creado');
  try { 
    const res = await fetchWithTimeout(gasWebhookURL, payload); 
    const data = await res.json(); 
    if(data.error) throw new Error(data.error); 
    if (data.tracking_code) {
        const tempReminder = appData.remindersList.find(r => r.tracking_code === tempId);
        if (tempReminder) tempReminder.tracking_code = data.tracking_code;
    }
  } catch (err) { 
    showToast(`Error: ${err.message}. No se guard√≥.`, true); 
    initializeApp();
  }
}

function renderRemindersList() {
  manageBackButton(true, renderDashboard);
  const reminders = appData.remindersList || [];
  let listHtml = (reminders.length > 0) ? reminders.map(item => `
    <li class="list-item" id="item-${item.tracking_code}">
      <div class="list-item-content">
        <span class="list-item-title">${item.Descripcion}</span>
        <span class="list-item-subtitle">${item.Categoria}: ${item.Fecha}</span>
      </div>
      <div class="list-item-actions">
        <button class="generic-menu-btn" data-menu-id="menu-item-${item.tracking_code}">‚ãÆ</button>
        <div class="dropdown-menu" id="menu-item-${item.tracking_code}">
          <a class="dropdown-item" data-action="edit-reminder" data-tracking-code="${item.tracking_code}">Editar Texto</a>
          <a class="dropdown-item" data-action="delete-reminder" data-tracking-code="${item.tracking_code}">Eliminar</a>
        </div>
      </div>
    </li>`).join('') : '<div class="no-data-msg">üéâ<br>No tienes recordatorios.</div>';
  mainContentArea.innerHTML = `<div class="list-container"><div class="list-header"><h2>Recordatorios</h2></div><ul class="list-style-none" id="reminders-list">${listHtml}</ul></div>`;
  document.getElementById('reminders-list').addEventListener('click', (e) => {
    const target = e.target.closest('.dropdown-item');
    if (!target) return;
    const action = target.dataset.action;
    const trackingCode = target.dataset.trackingCode;
    if (action === 'edit-reminder') {
      const item = appData.remindersList.find(r => r.tracking_code === trackingCode);
      if (item) editReminderDescription(item);
    } else if (action === 'delete-reminder') {
      confirmDelete('reminder', trackingCode);
    }
  });
}

async function editReminderDescription(item) {
  const newDescription = prompt('Editar descripci√≥n del recordatorio:', item.Descripcion);
  if (newDescription && newDescription.trim() !== '' && newDescription.trim() !== item.Descripcion) {
    const originalDescription = item.Descripcion;
    const itemIndex = appData.remindersList.findIndex(r => r.tracking_code === item.tracking_code);
    if (itemIndex === -1) return;
    appData.remindersList[itemIndex].Descripcion = newDescription.trim();
    renderRemindersList();
    try {
      const payload = { Type: 'edit_reminder_description', chat_ID: chatId, tracking_code: item.tracking_code, new_description: newDescription.trim() };
      const res = await fetchWithTimeout(gasWebhookURL, payload);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
    } catch (err) {
      showToast(`Error: ${err.message}. No se actualiz√≥.`, true);
      appData.remindersList[itemIndex].Descripcion = originalDescription;
      renderRemindersList();
    }
  }
}

// ==================================================
// --- M√ìDULO: COMPRAS ---
// ==================================================
function renderShoppingList() {
  manageBackButton(true, renderDashboard);
  const items = appData.shoppingList || [];
  const pendingItems = items.filter(item => item['2'] === 'Pendiente');
  const boughtItems = items.filter(item => item['2'] === 'Comprado');
  let listHtml = '';
  const createItemHTML = (item) => {
    const isPending = item['2'] === 'Pendiente';
    if (isPending) {
      return `
        <li class="shopping-item" id="item-${item['3']}">
            <button class="shopping-item-toggle-btn pending" data-tracking-code="${item['3']}" data-current-status="Pendiente" data-cycle="${item['5'] || 0}"><span>${item['1']}</span></button>
            <div class="list-item-actions">
                <button class="generic-menu-btn" data-menu-id="menu-item-${item['3']}">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-item-${item['3']}">
                    <a class="dropdown-item" data-action="edit-shopping-item" data-tracking-code="${item['3']}">Editar</a>
                    <a class="dropdown-item" data-action="delete-shopping-item" data-tracking-code="${item['3']}">Eliminar</a>
                </div>
            </div>
        </li>`;
    } else {
      return `
        <li class="shopping-item" id="item-${item['3']}">
            <div class="shopping-item-checkbox-wrapper"><input type="checkbox" class="shopping-item-checkbox" data-tracking-code="${item['3']}"></div>
            <button class="shopping-item-toggle-btn bought" data-tracking-code="${item['3']}" data-current-status="Comprado" data-cycle="${item['5'] || 0}">
                <span>${item['1']}</span>
                ${item['4'] ? `<span class="item-date">${item['4']}</span>` : ''}
            </button>
            <div class="list-item-actions">
                <button class="generic-menu-btn" data-menu-id="menu-item-${item['3']}">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-item-${item['3']}">
                    <a class="dropdown-item" data-action="edit-shopping-item" data-tracking-code="${item['3']}">Editar</a>
                    <a class="dropdown-item" data-action="delete-shopping-item" data-tracking-code="${item['3']}">Eliminar</a>
                </div>
            </div>
        </li>`;
    }
  };
  if (pendingItems.length > 0) { listHtml += '<h3 class="shopping-list-section-title">Art√≠culos Pendientes</h3>'; listHtml += pendingItems.map(createItemHTML).join(''); }
  if (boughtItems.length > 0) { listHtml += '<h3 class="shopping-list-section-title">Art√≠culos Comprados</h3>'; listHtml += `<div class="shopping-list-header-row"><label for="select-all-checkbox">Seleccionar Todos</label><input type="checkbox" id="select-all-checkbox"></div>`; listHtml += boughtItems.map(createItemHTML).join(''); }
  if (items.length === 0) { listHtml = '<div class="no-data-msg">üõí<br>Tu lista est√° vac√≠a.</div>'; }
  mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>Lista de las Compras</h2></div>
          <ul class="list-style-none" id="shopping-list-ul">${listHtml}</ul>
          <div class="add-article-btn-container">
              <button class="add-article-btn" id="add-shopping-item-btn">A√±adir Art√≠culo</button>
              <button class="multi-select-action-btn" id="multi-select-toggle-btn" disabled>Marcar para comprar</button>
          </div>
      </div>`;
  document.getElementById('shopping-list-ul').addEventListener('click', handleShoppingItemInteractions);
  document.getElementById('add-shopping-item-btn').onclick = renderAddArticleForm;
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  if (selectAllCheckbox) { selectAllCheckbox.onchange = (e) => { document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.checked = e.target.checked; }); updateMultiSelectButtonState(); }; }
  document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.onchange = updateMultiSelectButtonState; });
  document.getElementById('multi-select-toggle-btn').onclick = toggleSelectedItemsToPending;
  updateMultiSelectButtonState();
}

function handleShoppingItemInteractions(event) {
  const toggleButton = event.target.closest('.shopping-item-toggle-btn');
  if (toggleButton) {
      const trackingCode = toggleButton.dataset.trackingCode;
      const currentStatus = toggleButton.dataset.currentStatus;
      const cycle = parseInt(toggleButton.dataset.cycle, 10);
      
      if (currentStatus === 'Pendiente' && cycle === 0) {
          optimisticDeleteItemPermanently(trackingCode);
      } else {
          const newStatus = currentStatus === 'Pendiente' ? 'Comprado' : 'Pendiente';
          optimisticToggleShoppingItemStatus(trackingCode, newStatus);
      }
      return;
  }
  const menuItem = event.target.closest('.dropdown-item');
  if(menuItem) {
    const action = menuItem.dataset.action;
    const trackingCode = menuItem.dataset.trackingCode;
    if (action === 'edit-shopping-item') {
      const item = appData.shoppingList.find(i => i['3'] === trackingCode);
      if(item) renderEditShoppingItemForm(item);
    } else if (action === 'delete-shopping-item') {
      confirmDelete('shopping_item', trackingCode);
    }
  }
}

function optimisticDeleteItemPermanently(trackingCode) {
    const itemIndex = appData.shoppingList.findIndex(item => item['3'] === trackingCode);
    if (itemIndex === -1) return;
    appData.shoppingList.splice(itemIndex, 1);
    appData.counts.shoppingPendingCount--;
    renderShoppingList();
    showToast('Art√≠culo de un solo uso eliminado.');
    fetchWithTimeout(gasWebhookURL, { Type: 'delete_item_shopping_list', chat_ID: chatId, tracking_code: trackingCode })
        .then(res => res.json()).then(data => { if (data.error) throw new Error(data.error); })
        .catch(err => { showToast(`Error: ${err.message}. No se sincroniz√≥.`, true); initializeApp(); });
}

function optimisticToggleShoppingItemStatus(trackingCode, newStatus) {
  const itemIndex = appData.shoppingList.findIndex(item => item['3'] === trackingCode);
  if (itemIndex === -1) return;
  appData.shoppingList[itemIndex]['2'] = newStatus;
  if (newStatus === 'Comprado') { appData.shoppingList[itemIndex]['4'] = new Date().toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }); appData.counts.shoppingPendingCount--; appData.counts.shoppingBoughtCount++; } else { appData.shoppingList[itemIndex]['4'] = ''; appData.counts.shoppingPendingCount++; appData.counts.shoppingBoughtCount--; }
  renderShoppingList();
  fetchWithTimeout(gasWebhookURL, { Type: 'toggle_item_status', chat_ID: chatId, tracking_code: trackingCode, new_status: newStatus })
      .then(res => res.json()).then(data => { if (data.error) throw new Error(data.error); })
      .catch(err => { showToast(`Error: ${err.message}. No se sincroniz√≥.`, true); initializeApp(); });
}

function updateMultiSelectButtonState() {
  const multiSelectToggleButton = document.getElementById('multi-select-toggle-btn');
  if (!multiSelectToggleButton) return;
  const selectedCount = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).length;
  multiSelectToggleButton.disabled = selectedCount === 0;
  multiSelectToggleButton.textContent = selectedCount > 0 ? `Marcar ${selectedCount} para comprar` : 'Marcar para comprar';
}

function toggleSelectedItemsToPending() {
  const trackingCodes = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.trackingCode);
  if (trackingCodes.length === 0) return;
  trackingCodes.forEach(code => { const itemIndex = appData.shoppingList.findIndex(item => item['3'] === code); if (itemIndex !== -1) { appData.shoppingList[itemIndex]['2'] = 'Pendiente'; appData.shoppingList[itemIndex]['4'] = ''; } });
  appData.counts.shoppingPendingCount += trackingCodes.length;
  appData.counts.shoppingBoughtCount -= trackingCodes.length;
  renderShoppingList();
  fetchWithTimeout(gasWebhookURL, { Type: 'toggle_multiple_to_pending', chat_ID: chatId, tracking_codes: trackingCodes })
    .then(res => res.json()).then(data => { if (data.error) throw new Error(data.error); })
    .catch(err => { showToast(`Error: ${err.message}. No se sincroniz√≥.`, true); initializeApp(); });
}

function renderAddArticleForm() {
  manageBackButton(true, renderShoppingList);
  mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>‚ûï A√±adir Art√≠culo</h2></div>
          <div class="form-card">
              <label>Descripci√≥n del art√≠culo</label> <textarea id="article-description" rows="2" required></textarea>
              <label>¬øCada cu√°ntos d√≠as lo compras? (0 si es ocasional)</label> <input type="number" id="article-cycle" value="0" min="0" step="1" required />
              <button id="add-article-send-btn" disabled>A√±adir</button>
          </div>
      </div>`;
  const sendBtn = document.getElementById('add-article-send-btn');
  const descriptionInput = document.getElementById('article-description');
  descriptionInput.oninput = () => { const isEnabled = descriptionInput.value.trim() !== ''; sendBtn.disabled = !isEnabled; sendBtn.classList.toggle('enabled', isEnabled); };
  sendBtn.onclick = addArticle;
}

async function addArticle() {
  const description = document.getElementById('article-description').value.trim();
  const cycle = document.getElementById('article-cycle').value || 0;
  if (!description) return;
  const payload = { Type: 'add_articulo', chat_ID: chatId, description: description, cycle: parseInt(cycle) };
  appData.counts.shoppingPendingCount++;
  const tempId = 'temp-' + Date.now();
  appData.shoppingList.unshift({ '1': description, '2': 'Pendiente', '3': tempId, '4': '', '5': cycle });
  renderShoppingList();
  showToast('Art√≠culo a√±adido');
  try {
      const res = await fetchWithTimeout(gasWebhookURL, payload);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
  } catch (err) { showToast(`Error: ${err.message}. No se a√±adi√≥.`, true); initializeApp(); }
}

function renderEditShoppingItemForm(item) {
    manageBackButton(true, renderShoppingList);
    mainContentArea.innerHTML = `
      <div class="list-container">
          <div class="list-header"><h2>‚úèÔ∏è Editar Art√≠culo</h2></div>
          <div class="form-card">
              <label>Descripci√≥n del art√≠culo</label> <textarea id="article-description" rows="2" required>${item['1']}</textarea>
              <label>¬øCada cu√°ntos d√≠as lo compras? (0 si es ocasional)</label> <input type="number" id="article-cycle" value="${item['5'] || 0}" min="0" step="1" required />
              <button id="edit-article-send-btn" class="enabled">Guardar Cambios</button>
          </div>
      </div>`;
    document.getElementById('edit-article-send-btn').onclick = () => saveEditedShoppingItem(item['3']);
}

async function saveEditedShoppingItem(trackingCode) {
    const newDescription = document.getElementById('article-description').value.trim();
    const newCycle = document.getElementById('article-cycle').value || 0;
    if (!newDescription) return;
    const itemIndex = appData.shoppingList.findIndex(i => i['3'] === trackingCode);
    if (itemIndex === -1) return;
    const originalItem = { ...appData.shoppingList[itemIndex] };
    appData.shoppingList[itemIndex]['1'] = newDescription;
    appData.shoppingList[itemIndex]['5'] = newCycle;
    renderShoppingList();
    const payload = { Type: 'edit_shopping_item', chat_ID: chatId, tracking_code: trackingCode, new_description: newDescription, new_cycle: parseInt(newCycle) };
    try {
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
    } catch (err) {
        showToast(`Error: ${err.message}. No se guard√≥.`, true);
        appData.shoppingList[itemIndex] = originalItem;
        renderShoppingList();
    }
}
// ==================================================
// --- M√ìDULO: NOTAS ---
// ==================================================
function renderNotesList() {
    manageBackButton(true, renderDashboard);
    const notes = appData.notesList || [];
    let listHtml = (notes.length > 0) ? notes.map(note => `
            <li class="list-item" id="item-${note.Nota_ID}">
                <div class="list-item-content">
                    <span class="list-item-title">${note.Titulo}</span>
                    <span class="list-item-subtitle">${note.Fecha}</span>
                    <p style="margin-top: 8px; white-space: pre-wrap; word-wrap: break-word;">${note.Descripcion}</p>
                </div>
                <div class="list-item-actions">
                    <button class="generic-menu-btn" data-menu-id="menu-item-${note.Nota_ID}">‚ãÆ</button>
                    <div class="dropdown-menu" id="menu-item-${note.Nota_ID}">
                        <a class="dropdown-item" data-action="edit-note" data-note-id="${note.Nota_ID}">Editar</a>
                        <a class="dropdown-item" data-action="delete-note" data-note-id="${note.Nota_ID}">Eliminar</a>
                    </div>
                </div>
            </li>`).join('') : '<div class="no-data-msg">üìù<br>No tienes notas guardadas.</div>';
    
    mainContentArea.innerHTML = `<div class="list-container">
                                <div class="list-header"><h2>Mis Notas</h2></div>
                                <div class="add-article-btn-container"><button class="add-article-btn" id="create-new-note-btn">Crear Nueva Nota</button></div>
                                <ul class="list-style-none" id="notes-list">${listHtml}</ul>
                             </div>`;
    document.getElementById('create-new-note-btn').onclick = () => renderNoteForm();
    document.getElementById('notes-list').addEventListener('click', e => {
        const target = e.target.closest('.dropdown-item');
        if (!target) return;
        const action = target.dataset.action;
        const noteId = target.dataset.noteId;
        if (action === 'edit-note') {
            const note = appData.notesList.find(n => n.Nota_ID === noteId);
            if (note) renderNoteForm(note);
        } else if (action === 'delete-note') {
            confirmDelete('note', noteId);
        }
    });
}

function renderNoteForm(note = null) {
    manageBackButton(true, renderNotesList);
    const isEditing = note !== null;
    mainContentArea.innerHTML = `<div class="list-container">
                                <div class="list-header"><h2>${isEditing ? '‚úèÔ∏è Editar Nota' : '‚ûï Nueva Nota'}</h2></div>
                                <div class="form-card">
                                    <label>T√≠tulo</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}" required />
                                    <label>Descripci√≥n</label><textarea id="note-description" rows="8" required>${isEditing ? note.Descripcion : ''}</textarea>
                                    <button id="save-note-btn" data-note-id="${isEditing ? note.Nota_ID : ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button>
                                </div>
                             </div>`;
    const titleInput = document.getElementById('note-title');
    const descriptionInput = document.getElementById('note-description');
    const saveBtn = document.getElementById('save-note-btn');
    function validate() {
        const isEnabled = titleInput.value.trim() !== '' && descriptionInput.value.trim() !== '';
        saveBtn.disabled = !isEnabled;
        saveBtn.classList.toggle('enabled', isEnabled);
    }
    titleInput.oninput = validate;
    descriptionInput.oninput = validate;
    saveBtn.onclick = saveNote;
    validate();
}

async function saveNote() {
    const saveBtn = document.getElementById('save-note-btn');
    const title = document.getElementById('note-title').value.trim();
    const description = document.getElementById('note-description').value.trim();
    const noteId = saveBtn.dataset.noteId;
    const isEditing = !!noteId;
    const payload = { chat_ID: chatId, Type: isEditing ? 'edit_note' : 'add_note', note_id: noteId, title: title, description: description };
    if (isEditing) {
        const itemIndex = appData.notesList.findIndex(n => n.Nota_ID === noteId);
        if (itemIndex === -1) return;
        const originalNote = { ...appData.notesList[itemIndex] };
        appData.notesList[itemIndex].Titulo = title;
        appData.notesList[itemIndex].Descripcion = description;
        renderNotesList();
        showToast('Nota guardada');
        try {
            const res = await fetchWithTimeout(gasWebhookURL, payload);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
        } catch (err) {
            showToast(`Error: ${err.message}. No se pudo guardar.`, true);
            appData.notesList[itemIndex] = originalNote;
            renderNotesList();
        }
    } else {
        appData.counts.notesCount++;
        const tempId = 'temp-' + Date.now();
        appData.notesList.unshift({ Nota_ID: tempId, Titulo: title, Descripcion: description, Fecha: new Date().toLocaleDateString('es-ES') });
        renderNotesList();
        showToast('Nota creada');
        try {
            const res = await fetchWithTimeout(gasWebhookURL, payload);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            if(data.newNoteId){
                const tempNote = appData.notesList.find(n => n.Nota_ID === tempId);
                if(tempNote) tempNote.Nota_ID = data.newNoteId;
            }
        } catch (err) {
            showToast(`Error: ${err.message}. No se pudo crear la nota.`, true);
            initializeApp();
        }
    }
}

// ==================================================
// --- M√ìDULO: CALENDARIO ---
// ==================================================
async function renderCalendarView(eventsToShow = null) {
    manageBackButton(true, renderDashboard);
    showSpinner();
    try {
        let events = eventsToShow;
        if (!events) {
            const startDate = new Date(); const endDate = new Date(); endDate.setDate(startDate.getDate() + 30);
            const res = await fetchWithTimeout(gasWebhookURL, { Type: 'get_calendar_events', chat_ID: chatId, startDate: startDate.toISOString(), endDate: endDate.toISOString() });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            events = data;
            appData.calendarEvents = events;
        }
        const groupAndRenderEvents = (evs) => {
            if (!evs || evs.length === 0) return '<div class="no-data-msg">üóìÔ∏è<br>No se encontraron eventos.</div>';
            const eventsByDay = evs.reduce((acc, event) => { 
                const dateKey = event.start.dateTime || event.start.date;
                if (!dateKey) return acc;
                const day = new Date(dateKey).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); 
                if (!acc[day]) acc[day] = []; 
                acc[day].push(event); 
                return acc; 
            }, {});
            let html = '';
            for (const day in eventsByDay) {
                html += `<h3 class="day-header">${day}</h3>`;
                html += Object.values(eventsByDay[day]).map(event => {
                    const isAllDay = !event.start.dateTime;
                    const startTime = isAllDay ? 'Todo el d√≠a' : new Date(event.start.dateTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    const endTime = isAllDay ? '' : ' - ' + new Date(event.end.dateTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    return `<li class="list-item" id="item-${event.id}">
                              <div class="list-item-content" onclick="this.parentElement.classList.toggle('open')">
                                <span class="list-item-title">${event.summary}</span>
                                <span class="list-item-subtitle">${startTime}${endTime}</span>
                                <div class="event-description">${event.description || ''}</div>
                              </div>
                              <div class="list-item-actions">
                                <button class="generic-menu-btn" data-menu-id="menu-item-${event.id}">‚ãÆ</button>
                                <div class="dropdown-menu" id="menu-item-${event.id}">
                                  <a class="dropdown-item" data-action="delete-calendar-event" data-event-id="${event.id}">Eliminar</a>
                                  ${event.htmlLink ? `<a class="dropdown-item" href="${event.htmlLink}" target="_blank">Ver en Google</a>` : ''}
                                </div>
                              </div>
                            </li>`;
                }).join('');
            }
            return html;
        };
        let listHtml = groupAndRenderEvents(events);
        mainContentArea.innerHTML = `<div class="list-container">
                                  <div class="list-header"><h2>Calendario</h2></div>
                                  <div class="add-article-btn-container">
                                    <button class="add-article-btn" id="add-event-btn">A√±adir Evento</button>
                                    <button class="add-article-btn" id="search-event-btn">Buscar</button>
                                  </div>
                                  <ul class="list-style-none" id="calendar-list">${listHtml}</ul>
                                </div>`;
        document.getElementById('add-event-btn').onclick = renderEventForm;
        document.getElementById('search-event-btn').onclick = renderSearchCalendarForm;
        document.getElementById('calendar-list').addEventListener('click', (e) => {
            const target = e.target.closest('.dropdown-item');
            if (!target || target.href) return;
            const action = target.dataset.action;
            const eventId = target.dataset.eventId;
            if (action === 'delete-calendar-event') {
                confirmDelete('calendar_event', eventId);
            }
        });
    } catch (err) { mainContentArea.innerHTML = `<div class="no-data-msg">‚ùå<br>Error al cargar el calendario.<br><small>${err.message}</small></div>`; } finally { hideSpinner(); }
}

function updateAddNotificationLinkVisibility() {
    const container = document.getElementById('notifications-container');
    const link = document.getElementById('add-notification-link');
    if (!container || !link) return;
    const rows = container.querySelectorAll('.notification-row');
    if (rows.length === 0) {
        link.style.display = 'block';
        return;
    }
    const lastRow = rows[rows.length - 1];
    const method = lastRow.querySelector('.event-reminder-method').value;
    const quantity = lastRow.querySelector('.event-reminder-quantity').value;
    const unit = lastRow.querySelector('.event-reminder-unit').value;
    const isLastRowFilled = method && quantity.trim() !== '' && parseInt(quantity, 10) > 0 && unit;
    link.style.display = isLastRowFilled ? 'block' : 'none';
}

function renderEventForm() {
    manageBackButton(true, renderCalendarView);
    mainContentArea.innerHTML = `
      <div class="list-container"><div class="list-header"><h2>‚ûï Nuevo Evento</h2></div>
      <div class="form-card">
          <label>T√≠tulo</label><input type="text" id="event-summary" required />
          <label><input type="checkbox" id="event-all-day" style="width:auto;margin-right:8px;"> Todo el d√≠a</label>
          <label>Inicio</label><input type="text" id="event-start">
          <label>Fin</label><input type="text" id="event-end">
          <label>Notificarme</label>
          <div id="notifications-container"></div>
          <a href="#" id="add-notification-link" style="font-size: 0.9rem; color: var(--primary); text-decoration: none; margin-top: 8px;">A√±adir notificaci√≥n</a>
          <label>Descripci√≥n</label><textarea id="event-description" rows="4"></textarea>
          <div class="button-group">
            <button id="save-event-btn" disabled>Crear Evento</button>
            <button id="cancel-event-btn" class="cancel">Cancelar</button>
          </div>
      </div></div>`;
    document.getElementById('cancel-event-btn').onclick = renderDashboard;
    const addNotificationLink = document.getElementById('add-notification-link');
    const notificationsContainer = document.getElementById('notifications-container');
    const createNotificationRow = () => {
        const row = document.createElement('div');
        row.className = 'notification-row';
        row.innerHTML = `
            <select class="event-reminder-method">
              <option value="" selected disabled>Tipo</option>
              <option value="popup">Notificaci√≥n</option>
              <option value="email">Email</option>
            </select>
            <input type="number" class="event-reminder-quantity" value="10" min="1" />
            <select class="event-reminder-unit">
              <option value="" selected disabled>Unidad</option>
              <option value="minutes">minutos</option>
              <option value="hours">horas</option>
              <option value="days">d√≠as</option>
              <option value="weeks">semanas</option>
            </select>
            <button class="remove-notification-btn">&times;</button>
        `;
        notificationsContainer.appendChild(row);
        row.querySelector('.remove-notification-btn').onclick = () => { row.remove(); updateAddNotificationLinkVisibility(); };
        row.querySelectorAll('input, select').forEach(el => el.addEventListener('change', updateAddNotificationLinkVisibility));
        updateAddNotificationLinkVisibility();
    };
    addNotificationLink.onclick = (e) => { e.preventDefault(); createNotificationRow(); };
    let startPicker, endPicker;
    const fpConfig = { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true, locale: "es" };
    startPicker = flatpickr("#event-start", { ...fpConfig, defaultDate: new Date(), onChange: function(selectedDates) { if (selectedDates[0] && !document.getElementById('event-all-day').checked) { endPicker.setDate(new Date(selectedDates[0].getTime() + 3600000)); } } });
    endPicker = flatpickr("#event-end", { ...fpConfig, defaultDate: new Date(Date.now() + 3600000) });
    document.getElementById('event-all-day').addEventListener('change', (e) => { const isAllDay = e.target.checked; const newConfig = { enableTime: !isAllDay, dateFormat: isAllDay ? "Y-m-d" : "Y-m-d H:i" }; startPicker.set(newConfig); endPicker.set(newConfig); if (isAllDay) { endPicker.setDate(startPicker.selectedDates[0] || new Date()); } });
    const summaryInput = document.getElementById('event-summary'), saveBtn = document.getElementById('save-event-btn');
    function validate() { saveBtn.disabled = summaryInput.value.trim() === ''; saveBtn.classList.toggle('enabled', !saveBtn.disabled); }
    summaryInput.oninput = validate;
    saveBtn.onclick = saveEvent;
    validate();
}

async function saveEvent() {
    const reminders = [];
    document.querySelectorAll('.notification-row').forEach(row => {
        const quantity = parseInt(row.querySelector('.event-reminder-quantity').value, 10);
        const unit = row.querySelector('.event-reminder-unit').value;
        const method = row.querySelector('.event-reminder-method').value;
        let minutes = 0;
        if (quantity > 0 && unit && method) {
            switch(unit) {
                case 'minutes': minutes = quantity; break;
                case 'hours':   minutes = quantity * 60; break;
                case 'days':    minutes = quantity * 24 * 60; break;
                case 'weeks':   minutes = quantity * 7 * 24 * 60; break;
            }
            reminders.push({ method: method, minutes: minutes });
        }
    });
    const eventData = {
        summary: document.getElementById('event-summary').value.trim(),
        start: document.getElementById('event-start')._flatpickr.selectedDates[0].toISOString(),
        end: document.getElementById('event-end')._flatpickr.selectedDates[0].toISOString(),
        description: document.getElementById('event-description').value,
        isAllDay: document.getElementById('event-all-day').checked,
        reminders: reminders
    };
    if (new Date(eventData.start).toISOString().split('T')[0] === new Date().toISOString().split('T')[0]) {
        appData.counts.calendarTodayCount++;
    }
    renderDashboard();
    showToast('Evento creado');
    try {
        const res = await fetchWithTimeout(gasWebhookURL, { chat_ID: chatId, Type: 'add_calendar_event', eventData });
        const result = await res.json();
        if (result.error) throw new Error(result.error);
    } catch (err) {
        showToast(`Error: ${err.message}. No se guard√≥.`, true);
        initializeApp();
    }
}

function renderSearchCalendarForm() {
    manageBackButton(true, renderCalendarView);
    mainContentArea.innerHTML = `
        <div class="list-container"><div class="list-header"><h2>üîé Buscar en Calendario</h2></div>
        <div class="form-card">
            <label>T√©rmino de b√∫squeda</label>
            <input type="text" id="calendar-search-query" placeholder="Ej: Reuni√≥n, Dentista..." required />
            <button id="search-calendar-btn" class="enabled">Buscar</button>
        </div>
        </div>`;
    document.getElementById('search-calendar-btn').onclick = executeSearchCalendar;
}

async function executeSearchCalendar() {
    const query = document.getElementById('calendar-search-query').value.trim();
    if (!query) { showToast('Introduce un t√©rmino para buscar.', true); return; }
    showSpinner();
    try {
        const res = await fetchWithTimeout(gasWebhookURL, { Type: 'search_calendar_events', chat_ID: chatId, query: query });
        const events = await res.json();
        if (events.error) throw new Error(events.error);
        renderCalendarView(events);
    } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
}
// ==================================================
// --- M√ìDULO: GASTOS ---
// ==================================================
let gastosEncontrados = [];
let pieChartInstance = null, dailyChartInstance = null, monthlyChartInstance = null;

const categoriasGastos = {
    "üè† Gastos del hogar": ["üîë Alquiler o hipoteca", "üí° Servicios (agua, luz, gas, electricidad)", "üåê Internet y tel√©fono", "üîß Mantenimiento y reparaciones", "üõãÔ∏è Mobiliario y electrodom√©sticos"],
    "üßæ Gastos personales": ["üõí Alimentaci√≥n y supermercado", "üëï Ropa y calzado", "üíä Salud (seguros, medicamentos, Farmacia, consultas)", "üéì Educaci√≥n y formaci√≥n", "üíà Cuidado personal (peluquer√≠a, cosm√©tica)"],
    "üöó Transporte": ["‚õΩ Combustible", "üöå Transporte p√∫blico", "üõ°Ô∏è Seguro del veh√≠culo", "üõ†Ô∏è Mantenimiento y reparaciones", "üÖøÔ∏è Estacionamiento y peajes"],
    "üçΩÔ∏è Entretenimiento y ocio": ["‚òï Restaurantes y caf√©s", "üé≠ Cine, teatro, conciertos", "üì∫ Suscripciones (Netflix, Spotify, etc.)", "‚úàÔ∏è Vacaciones y viajes", "‚öΩ Actividades deportivas o hobbies"],
    "üíº Finanzas y seguros": ["üí≥ Pr√©stamos o cr√©ditos", "üìà Ahorros e inversiones", "üìÑ Seguros (vida, hogar, salud, etc.)", "üí∏ Impuestos y tasas"],
    "üéÅ Otros": ["üéâ Regalos y celebraciones", "‚ù§Ô∏è Donaciones o caridad", "üêæ Mascotas (comida, veterinario, etc.)"]
};

function renderInstructionScreen() {
    manageBackButton(true, renderDashboard);
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"></div>
            <div class="scan-instruction-screen">
                <h2>Escanear un Ticket de Gasto</h2>
                <ol>
                    <li>Primero, <strong>saca una foto n√≠tida</strong> de tu ticket con la c√°mara de tu m√≥vil.</li>
                    <li>Aseg√∫rate de que el texto sea legible, con buena luz y sin sombras.</li>
                    <li>Luego, <strong>pulsa el bot√≥n de abajo</strong> para seleccionarla de tu galer√≠a.</li>
                </ol>
                <button class="add-article-btn" id="select-photo-btn">Seleccionar Foto de la Galer√≠a</button>
            </div>
        </div>`;
    document.getElementById('select-photo-btn').onclick = renderScanTicketView;
}

function renderScanTicketView() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
	fileInput.capture = 'environment';
    fileInput.style.display = 'none';
    fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('image-preview-element').src = e.target.result;
            document.getElementById('image-preview-overlay').style.display = 'flex';
        };
        reader.readAsDataURL(file);
    };
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

async function handleImageScan() {
    if (!selectedImageFile) {
        showToast('No se ha seleccionado ninguna imagen.', true);
        return;
    }
    document.getElementById('image-preview-overlay').style.display = 'none';
    showSpinner();
    const formData = new FormData();
    formData.append('file', selectedImageFile, selectedImageFile.name);
    try {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 60000);
        const response = await fetch(makeTicketWebhookUrl, { method: 'POST', body: formData, signal: controller.signal });
        clearTimeout(id);
        if (!response.ok) { throw new Error(`Error del servidor de Make: ${response.status}`); }
        const resultText = await response.text();
        const resultJson = JSON.parse(resultText);
        if(resultJson.tipo && resultJson.tipo.toUpperCase() === 'GASTO') {
            renderAddGastoForm(resultJson);
        } else {
            throw new Error(resultJson.datos.motivo || 'El ticket no parece ser un gasto v√°lido.');
        }
    } catch (error) {
        console.error('Error al escanear el ticket:', error);
        showToast(`Error al procesar: ${error.message}`, true);
    } finally {
        hideSpinner();
        selectedImageFile = null;
    }
}

document.getElementById('preview-cancel-btn').onclick = () => {
    document.getElementById('image-preview-overlay').style.display = 'none';
    selectedImageFile = null;
};
document.getElementById('preview-send-btn').onclick = handleImageScan;

function renderAddGastoForm(initialData = null) {
    manageBackButton(true, renderDashboard);
    const data = initialData ? initialData.datos : {};
    const categoriasOptions = Object.keys(categoriasGastos).map(cat => `<option value="${cat}" ${data.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üí∞ Nuevo Gasto</h2></div>
            <div class="form-card">
                <label>Importe</label> <input type="number" id="gasto-importe" placeholder="Ej: 15.50" step="0.01" value="${data.importe_total || ''}" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" placeholder="Ej: Supermercado" value="${data.establecimiento || ''}" required />
                <label>Categor√≠a</label>
                <select id="gasto-categoria" required><option value="">-- Selecciona una categor√≠a --</option>${categoriasOptions}</select>
                <label>Subcategor√≠a</label>
                <select id="gasto-subcategoria" required disabled><option value="">-- Selecciona una subcategor√≠a --</option></select>
                <label>Fecha</label> <input type="text" id="gasto-fecha" required />
                <button id="save-gasto-btn" disabled>Registrar Gasto</button>
            </div>
        </div>`;
    const categoriaSelect = document.getElementById('gasto-categoria'), subcategoriaSelect = document.getElementById('gasto-subcategoria'), saveBtn = document.getElementById('save-gasto-btn');
    const elementsToValidate = [ document.getElementById('gasto-importe'), document.getElementById('gasto-establecimiento'), document.getElementById('gasto-fecha'), categoriaSelect, subcategoriaSelect ];
    function validateGastoForm() { const allValid = elementsToValidate.every(el => el.value && el.value.trim() !== ''); saveBtn.disabled = !allValid; saveBtn.classList.toggle('enabled', allValid); }
    let defaultDate = new Date();
    let enableTime = true;
    let dateFormat = "Y-m-d H:i";
    if(data.fecha) {
        const dateTimeParts = data.fecha.split(' ');
        const dateParts = dateTimeParts[0].split('/');
        if(dateParts.length === 3) {
            const year = parseInt(dateParts[2], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[0], 10);
            if(dateTimeParts.length > 1) {
                const timeParts = dateTimeParts[1].split(':');
                if(timeParts.length >= 2) {
                    const hours = parseInt(timeParts[0], 10);
                    const minutes = parseInt(timeParts[1], 10);
                    defaultDate = new Date(year, month, day, hours, minutes);
                } else {
                   defaultDate = new Date(year, month, day);
                }
            } else {
                defaultDate = new Date(year, month, day);
            }
        }
    }
    flatpickr("#gasto-fecha", { defaultDate: defaultDate, dateFormat: dateFormat, enableTime: enableTime, locale: "es", onChange: validateGastoForm });
    elementsToValidate.forEach(el => el.oninput = validateGastoForm);
    categoriaSelect.onchange = () => {
        const selectedCategory = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">-- Selecciona una subcategor√≠a --</option>';
        if (selectedCategory && categoriasGastos[selectedCategory]) {
            const subcategoriasOptions = categoriasGastos[selectedCategory].map(sub => `<option value="${sub}" ${data.subcategoria === sub ? 'selected' : ''}>${sub}</option>`).join('');
            subcategoriaSelect.innerHTML += subcategoriasOptions;
            subcategoriaSelect.disabled = false;
        } else { subcategoriaSelect.disabled = true; }
        validateGastoForm();
    };
    saveBtn.onclick = saveGasto;
    if (initialData) {
        categoriaSelect.dispatchEvent(new Event('change'));
        if(data.subcategoria) { subcategoriaSelect.value = data.subcategoria; }
    }
    validateGastoForm();
}

async function saveGasto() {
    try {
        const fechaGastoObj = document.getElementById('gasto-fecha')._flatpickr.selectedDates[0];
        const importe = parseFloat(document.getElementById('gasto-importe').value.replace(',', '.'));
        const establecimiento = document.getElementById('gasto-establecimiento').value;
        const categoria = document.getElementById('gasto-categoria').value;
        const subcategoria = document.getElementById('gasto-subcategoria').value;
        const mes = ('0' + (fechaGastoObj.getMonth() + 1)).slice(-2);
        const anio = fechaGastoObj.getFullYear();
        const mesAnioTexto = `${mes}/${anio}`;
        const payload = {
            Type: 'add_gasto',
            chat_ID: chatId,
            datos: {
                Importe: importe, Establecimiento: establecimiento, categoria: categoria, sub_categoria: subcategoria,
                Fecha: fechaGastoObj.toISOString(), mesAnio: mesAnioTexto,
                ID_Unico: `G-${Math.random().toString(36).substring(2, 8).toUpperCase()}`
            }
        };
        const hoy = new Date();
        const mesActual = ('0' + (hoy.getMonth() + 1)).slice(-2);
        const anioActual = hoy.getFullYear();
        if (mesAnioTexto === `${mesActual}/${anioActual}`) {
            const gastosActualesStr = appData.counts.gastosMesActual || '0,00';
            const gastosActualesNum = parseFloat(gastosActualesStr.replace(/\./g, '').replace(',', '.'));
            const nuevosGastos = gastosActualesNum + importe;
            appData.counts.gastosMesActual = nuevosGastos.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        renderDashboard();
        showToast('Gasto registrado. Guardando...');
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) {
            showToast(`Error del servidor: ${data.error}`, true);
            initializeApp(); 
        }
    } catch (err) {
        console.error("Error en saveGasto():", err);
        showToast(`Error: ${err.message}.`, true);
        initializeApp(); 
    }
}

function renderGastoChart() {
  manageBackButton(true, renderDashboard);
  const mesesOptions = (appData.counts.mesesActivosGastos || []).map(mes => `<option value="${mes}">${mes}</option>`).join('');
  mainContentArea.innerHTML = `
    <div class="list-container">
      <div class="list-header"><h2>An√°lisis de Gastos</h2></div>
      <div class="form-card">
        <label>Detalle por Mes</label>
        <select id="gasto-chart-mes-select"><option value="">-- Selecciona un mes para ver gr√°ficos --</option>${mesesOptions}</select>
        <div class="gasto-chart-container" id="chart-container-pie" style="margin-top:20px; display:none;"><canvas id="pieChartCanvas"></canvas></div>
        <ul class="gasto-legend" id="gasto-legend-container"></ul>
        <hr style="margin: 25px 0; border-top: 1px solid #eee; display:none;" id="hr1">
        <div class="gasto-chart-container" id="chart-container-daily" style="display:none;"><canvas id="dailyChartCanvas"></canvas></div>
        <hr style="margin: 25px 0; border-top: 1px solid #eee; display:none;" id="hr2">
        <div class="gasto-chart-container" id="chart-container-monthly" style="display:none;"><canvas id="monthlyChartCanvas"></canvas></div>
      </div>
    </div>`;
  document.getElementById('gasto-chart-mes-select').onchange = fetchAndDisplayGastoChart;
}

async function fetchAndDisplayGastoChart(event) {
  const mesAnio = event.target.value;
  if (pieChartInstance) pieChartInstance.destroy();
  if (dailyChartInstance) dailyChartInstance.destroy();
  if (monthlyChartInstance) monthlyChartInstance.destroy();
  document.getElementById('gasto-legend-container').innerHTML = '';
  ['chart-container-pie', 'chart-container-daily', 'chart-container-monthly', 'hr1', 'hr2'].forEach(id => document.getElementById(id).style.display = 'none');
  if (!mesAnio) return;
  showSpinner();
  try {
    const payload = { Type: 'get_gastos_chart', chat_ID: chatId, mes_anio: mesAnio };
    const res = await fetchWithTimeout(gasWebhookURL, payload);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    Chart.register(ChartDataLabels);
    const paletaDeColores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    if (data.pieData && data.pieData.data.length > 0) {
      document.getElementById('chart-container-pie').style.display = 'block';
      const pieCtx = document.getElementById('pieChartCanvas').getContext('2d');
      pieChartInstance = new Chart(pieCtx, {
        type: 'pie',
        data: { labels: data.pieData.labels, datasets: [{ data: data.pieData.data, backgroundColor: paletaDeColores, borderWidth: 2, borderColor: '#fff' }] },
        options: {
          responsive: true, maintainAspectRatio: true,
          plugins: {
            title: { display: true, text: data.tituloPie, font: { size: 18 } },
            legend: { display: false },
            datalabels: {
              formatter: (value, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return (value / total * 100).toFixed(0) + '%'; },
              color: '#fff', font: { weight: 'bold', size: 16 }
            }
          }
        }
      });
      document.getElementById('gasto-legend-container').innerHTML = data.datosParaLeyenda.map(item => `<li class="gasto-legend-item"><span class="gasto-legend-color" style="background-color:${item.color};"></span>${item.categoria}: <strong>${item.importe}</strong></li>`).join('');
    }
    if (data.dailyData && data.dailyData.data.length > 0) {
      document.getElementById('hr1').style.display = 'block';
      document.getElementById('chart-container-daily').style.display = 'block';
      const dailyCtx = document.getElementById('dailyChartCanvas').getContext('2d');
      dailyChartInstance = new Chart(dailyCtx, {
        type: 'line',
        data: { labels: data.dailyData.labels, datasets: [{ label: 'Gasto Diario', data: data.dailyData.data, borderColor: '#4BC0C0', fill: false }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { title: { display: true, text: `Evoluci√≥n Diaria - ${mesAnio}`, font: { size: 18 } }, legend: { display: false } } }
      });
    }
    if (data.monthlyData && data.monthlyData.data.length > 1) {
      document.getElementById('hr2').style.display = 'block';
      document.getElementById('chart-container-monthly').style.display = 'block';
      const monthlyDataPoints = data.monthlyData.data.map((y, x) => ({ x, y }));
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      monthlyDataPoints.forEach(p => { sumX += p.x; sumY += p.y; sumXY += p.x * p.y; sumX2 += p.x * p.x; });
      const n = monthlyDataPoints.length;
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      const trendlineData = monthlyDataPoints.map(p => slope * p.x + intercept);
      const monthlyCtx = document.getElementById('monthlyChartCanvas').getContext('2d');
      monthlyChartInstance = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: data.monthlyData.labels,
          datasets: [
            { label: 'Gasto Mensual', data: data.monthlyData.data, backgroundColor: '#36A2EB', yAxisID: 'y' },
            { label: 'Tendencia', data: trendlineData, type: 'line', borderColor: '#FF6384', fill: false, pointRadius: 0, yAxisID: 'y1' }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: true,
          plugins: { title: { display: true, text: 'Evoluci√≥n de Gastos Mensuales', font: { size: 18 } } },
          scales: { y: { type: 'linear', display: true, position: 'left' }, y1: { type: 'linear', display: false, position: 'right', grid: { drawOnChartArea: false } } }
        }
      });
    }
  } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
}

function renderSearchGastosForm() {
    manageBackButton(true, renderDashboard);
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>üîé Buscar Gastos</h2></div>
            <div class="form-card">
                <label>Fecha de Inicio</label> <input type="text" id="gasto-fecha-inicio" required />
                <label>Fecha de Fin</label> <input type="text" id="gasto-fecha-fin" required />
                <button id="search-gasto-btn" class="enabled">Buscar</button>
            </div>
            <div id="gastos-search-results" style="margin-top: 20px;"></div>
        </div>`;
    const fpConfig = { dateFormat: "d/m/Y", locale: "es" };
    flatpickr("#gasto-fecha-inicio", { ...fpConfig, defaultDate: new Date(new Date().setDate(1)) });
    flatpickr("#gasto-fecha-fin", { ...fpConfig, defaultDate: new Date() });
    document.getElementById('search-gasto-btn').onclick = executeSearchGastos;
    document.getElementById('gastos-search-results').addEventListener('click', (e) => {
        const target = e.target.closest('.dropdown-item'); if (!target) return;
        const action = target.dataset.action, idUnico = target.dataset.idUnico;
        if (action === 'edit-gasto') { const gasto = gastosEncontrados.find(g => g.ID_Unico === idUnico); if (gasto) renderEditGastoForm(gasto); } 
        else if (action === 'delete-gasto') { confirmDelete('gasto', idUnico); }
    });
}

async function executeSearchGastos() {
    const startDate = document.getElementById('gasto-fecha-inicio').value, endDate = document.getElementById('gasto-fecha-fin').value;
    if (!startDate || !endDate) { showToast('Debes seleccionar ambas fechas.', true); return; }
    const payload = { Type: 'get_gastos_fecha', chat_ID: chatId, datos: { fecha_start: startDate, fecha_end: endDate } };
    showSpinner();
    const resultsContainer = document.getElementById('gastos-search-results');
    try {
        const res = await fetchWithTimeout(gasWebhookURL, payload); const data = await res.json(); if (data.error) throw new Error(data.error);
        gastosEncontrados = data.gastos || [];
        if (gastosEncontrados.length > 0) {
            let listHtml = gastosEncontrados.map(gasto => `
                <li class="list-item" id="item-${gasto.ID_Unico}">
                    <div class="list-item-content">
                        <span class="list-item-title">${gasto.Establecimiento} - ${gasto.Importe.toLocaleString('es-ES', {minimumFractionDigits: 2})}</span>
                        <span class="list-item-subtitle">${gasto.Subcategoria || gasto.Categoria} - ${new Date(gasto.Fecha).toLocaleDateString('es-ES')}</span>
                    </div>
                    <div class="list-item-actions">
                        <button class="generic-menu-btn" data-menu-id="menu-item-${gasto.ID_Unico}">‚ãÆ</button>
                        <div class="dropdown-menu" id="menu-item-${gasto.ID_Unico}">
                            <a class="dropdown-item" data-action="edit-gasto" data-id-unico="${gasto.ID_Unico}">Editar</a>
                            <a class="dropdown-item" data-action="delete-gasto" data-id-unico="${gasto.ID_Unico}">Eliminar</a>
                        </div>
                    </div>
                </li>`).join('');
            resultsContainer.innerHTML = `<ul class="list-style-none">${listHtml}</ul>`;
        } else { resultsContainer.innerHTML = `<div class="no-data-msg" style="padding: 20px;">No se encontraron gastos.</div>`; }
    } catch (err) { showToast(err.message, true); resultsContainer.innerHTML = ''; } finally { hideSpinner(); }
}

function renderEditGastoForm(gasto) {
    manageBackButton(true, renderSearchGastosForm);
    const categoriasOptions = Object.keys(categoriasGastos).map(cat => `<option value="${cat}" ${gasto.Categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
    const subcategoriasOptions = (categoriasGastos[gasto.Categoria] || []).map(sub => `<option value="${sub}" ${gasto.Subcategoria === sub ? 'selected' : ''}>${sub}</option>`).join('');
    mainContentArea.innerHTML = `
        <div class="list-container">
            <div class="list-header"><h2>‚úèÔ∏è Editar Gasto</h2></div>
            <div class="form-card">
                <label>Importe</label> <input type="number" id="gasto-importe" value="${gasto.Importe}" step="0.01" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" value="${gasto.Establecimiento}" required />
                <label>Categor√≠a</label> <select id="gasto-categoria" required>${categoriasOptions}</select>
                <label>Subcategor√≠a</label> <select id="gasto-subcategoria" required>${subcategoriasOptions}</select>
                <label>Fecha</label> <input type="text" id="gasto-fecha" required />
                <button id="save-gasto-btn" class="enabled">Guardar Cambios</button>
            </div>
        </div>`;
    flatpickr("#gasto-fecha", { defaultDate: gasto.Fecha, dateFormat: "Y-m-d", locale: "es" });
    const categoriaSelect = document.getElementById('gasto-categoria'), subcategoriaSelect = document.getElementById('gasto-subcategoria');
    categoriaSelect.onchange = () => {
        const selectedCategory = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">-- Selecciona una subcategor√≠a --</option>';
        if (selectedCategory && categoriasGastos[selectedCategory]) {
            const newSubOptions = categoriasGastos[selectedCategory].map(sub => `<option value="${sub}">${sub}</option>`).join('');
            subcategoriaSelect.innerHTML += newSubOptions; subcategoriaSelect.disabled = false;
        } else { subcategoriaSelect.disabled = true; }
    };
    document.getElementById('save-gasto-btn').onclick = () => saveEditedGasto(gasto.ID_Unico);
}

async function saveEditedGasto(idUnico) {
    const originalGasto = gastosEncontrados.find(g => g.ID_Unico === idUnico);
    if (!originalGasto) { showToast('Error: No se encontr√≥ el gasto original.', true); return; }
    const nuevoImporte = parseFloat(document.getElementById('gasto-importe').value);
    const originalImporte = parseFloat(originalGasto.Importe);
    const diferencia = nuevoImporte - originalImporte;
    const gastosActualesNum = parseFloat(String(appData.counts.gastosMesActual).replace(/\./g, '').replace(',', '.'));
    const nuevosGastosTotal = gastosActualesNum + diferencia;
    appData.counts.gastosMesActual = nuevosGastosTotal.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fechaGastoObj = document.getElementById('gasto-fecha')._flatpickr.selectedDates[0];
    const mes = ('0' + (fechaGastoObj.getMonth() + 1)).slice(-2), anio = fechaGastoObj.getFullYear(), mesAnioTexto = `${mes}/${anio}`;
    const payload = { Type: 'edit_gasto', chat_ID: chatId, datos: { ID_Unico: idUnico, Importe: nuevoImporte, Establecimiento: document.getElementById('gasto-establecimiento').value, categoria: document.getElementById('gasto-categoria').value, sub_categoria: document.getElementById('gasto-subcategoria').value, Fecha: fechaGastoObj.toISOString(), mesAnio: mesAnioTexto } };
    renderDashboard();
    try {
        const res = await fetchWithTimeout(gasWebhookURL, payload); const data = await res.json(); if (data.error) throw new Error(data.error);
        showToast('Gasto actualizado');
    } catch (err) { showToast(`Error: ${err.message}. Restaurando...`, true); initializeApp(); }
}

// ==================================================
// --- M√ìDULO: CHEF ASISTENTE (VERSI√ìN FINAL) ---
// ==================================================
function renderChefPage() {
    setActiveTab('tab-chef');
    manageBackButton(true, renderDashboard);

    mainContentArea.innerHTML = `
        <div class="chef-container">
            <h2 class="settings-section-title">üßë‚Äçüç≥ Chef Asistente</h2>
            <div class="form-card">
                <div class="chef-item">
                    <label>Tipo de Comida</label>
                    <select id="chef-tipo-comida">
                        <option value="Desayuno">üç≥ Desayuno</option>
                        <option value="Almuerzo" selected>ü•ó Almuerzo</option>
                        <option value="Merienda">ü•™ Merienda</option>
                        <option value="Cena">üçù Cena</option>
                    </select>
                </div>
                <div class="chef-item">
                    <label>Hora Aproximada</label>
                    <input type="text" id="chef-hora" style="width: 100px; text-align: center;"/>
                </div>
                <div class="chef-item">
                    <label>N¬∫ de Comensales</label>
                    <input type="number" id="chef-comensales" value="1" min="1" style="width: 80px; text-align: center;"/>
                </div>
                <div class="chef-item">
                    <label>Estilo de Cocina</label>
                    <select id="chef-estilo">
                        <option value="Sorpr√©ndeme">‚ú® Sorpr√©ndeme</option>
                        <option value="R√°pida">üèÉ R√°pida</option>
                        <option value="Casera">üè° Casera</option>
                        <option value="Saludable">üí™ Saludable</option>
                    </select>
                </div>
                <div class="chef-item">
                    <label>¬øIncluir Postre?</label>
                    <label class="switch"><input type="checkbox" id="chef-postre"><span class="slider"></span></label>
                </div>
                <div class="chef-item">
                    <label>Solo con lo que tengo</label>
                    <label class="switch"><input type="checkbox" id="chef-solo-nevera"><span class="slider"></span></label>
                </div>
                <label style="margin-top: 20px;">Tu Petici√≥n Especial</label>
                <textarea id="chef-peticion" rows="3" placeholder="Ej: soy vegano, alergia al marisco, usa el pollo antes de que caduque..."></textarea>
                
                <button id="chef-add-photo-btn" class="add-article-btn enabled" style="width:100%; max-width:100%; margin-top: 20px;">üì∏ A√±adir Foto(s) de Ingredientes</button>
                <div id="chef-photo-name" style="color:var(--muted); font-size:0.9rem; margin-top:8px; text-align:center;"></div>
                
                <button id="chef-submit-btn" class="enabled" style="margin-top:20px;">Obtener Sugerencias</button>
            </div>
        </div>`;

    flatpickr("#chef-hora", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, defaultDate: "13:00" });
    
    let selectedFiles = [];

    document.getElementById('chef-add-photo-btn').onclick = () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.multiple = true;
        fileInput.onchange = (event) => {
            const newFiles = Array.from(event.target.files);
            const totalFiles = selectedFiles.length + newFiles.length;
            if (totalFiles > 2) {
                showToast("Puedes subir un m√°ximo de 2 fotos.", true);
                return;
            }
            selectedFiles.push(...newFiles);
            if (selectedFiles.length > 0) {
                const fileNames = selectedFiles.map(f => f.name);
                document.getElementById('chef-photo-name').textContent = `üì∑ ${fileNames.join(', ')}`;
            }
        };
        fileInput.click();
    };
    document.getElementById('chef-submit-btn').onclick = () => executeChefRequest(selectedFiles);
}

async function executeChefRequest(files) {
    showSpinner("Un momento, el Chef est√° trabajando...");
    
    const tipoComida = document.getElementById('chef-tipo-comida').value;
    const hora = document.getElementById('chef-hora').value;
    const comensales = document.getElementById('chef-comensales').value;
    const estilo = document.getElementById('chef-estilo').value;
    const conPostre = document.getElementById('chef-postre').checked;
    const soloNevera = document.getElementById('chef-solo-nevera').checked;
    const peticionUsuario = document.getElementById('chef-peticion').value;

    try {
        const contextRes = await fetchWithTimeout(gasWebhookURL, { Type: 'get_user_context', chat_ID: chatId, hora_comida: hora });
        const userContextForChef = await contextRes.json();
        if (userContextForChef.error) throw new Error(userContextForChef.error);

        let prompt = `Rol: Eres un "Chef Asistente Contextual", amigable, creativo y pr√°ctico. Tu objetivo es ayudar a un usuario a decidir qu√© cocinar bas√°ndote en lo que tiene en casa y sus preferencias.
Contexto del Entorno del Usuario:
Ubicaci√≥n: ${userContextForChef.ciudad || 'desconocida'}, ${userContextForChef.pais || 'desconocido'}.
Estaci√≥n del A√±o: ${userContextForChef.estacion}.
Clima a la hora de la comida (${hora}): ${userContextForChef.clima_hora_especifica}.
Contexto de la Petici√≥n:
Tipo de Comida: ${tipoComida} ${conPostre ? '(con Postre incluido)' : ''}
N√∫mero de Comensales: ${comensales}
Estilo de Cocina Deseado: ${estilo}
Petici√≥n Espec√≠fica del Usuario: "${peticionUsuario || 'Ninguna'}"
Restricciones Diet√©ticas del Usuario: ${userContextForChef.preferencias_dieteticas || 'Ninguna especificada'}.
Condici√≥n de ingredientes: ${soloNevera ? 'El usuario solicita usar EXCLUSIVAMENTE los ingredientes de la foto, sin comprar nada m√°s.' : 'El usuario est√° dispuesto a comprar ingredientes si es necesario.'}
An√°lisis de Ingredientes:
Analiza las im√°genes adjuntas de la nevera/despensa del usuario. Lista en primer lugar los ingredientes principales que identificas.
Tu Tarea:
Basado en TODO el contexto anterior, proporciona 2 sugerencias de men√∫. Menciona el clima en tu descripci√≥n para hacerla m√°s personal. Tu respuesta DEBE estar en formato JSON, siguiendo estrictamente esta estructura:
{"sugerencias": [{"titulo_receta": "Nombre Receta 1","descripcion": "Texto apetitoso.","ingredientes_detectados": ["Ingrediente 1"],"ingredientes_a_comprar": [{"nombre": "Ingrediente 3", "cantidad": "1 ud"}],"postre": {"titulo": "Nombre Postre","descripcion": "Descripci√≥n.","ingredientes_a_comprar": []}},{"titulo_receta": "Nombre Receta 2","descripcion": "Texto apetitoso.","ingredientes_detectados": [],"ingredientes_a_comprar": [],"postre": null}]}
Instrucciones Adicionales:
Si no hay postre, el campo "postre" debe ser null. Si no hay ingredientes a comprar, el array debe estar vac√≠o. S√© realista.`;

        const makeRes = await fetchWithTimeout(chefWebhookURL, { prompt: prompt, images: files }, true);
        const responseText = await makeRes.text();
        const data = JSON.parse(responseText);
        
        showToast("¬°Aqu√≠ tienes tus sugerencias!");
        renderChefResults(data.sugerencias);

    } catch(err) {
        showToast(err.message, true);
    } finally {
        hideSpinner();
    }
}

function renderChefResults(sugerencias) {
    manageBackButton(true, renderDashboard);
    let html = '<div class="chef-container">';
    if (!sugerencias || sugerencias.length === 0) {
        html += '<div class="no-data-msg">üßë‚Äçüç≥<br>El Chef no ha encontrado sugerencias. Int√©ntalo de nuevo con otra foto o petici√≥n.</div>';
    } else {
        sugerencias.forEach((sug, index) => {
            html += `
            <div class="recipe-card" id="recipe-${index}">
                <div class="recipe-header"><h3 class="recipe-title">${sug.titulo_receta}</h3></div>
                <div class="recipe-body">
                    <p class="recipe-description">${sug.descripcion}</p>
                    <h4 class="recipe-subtitle">Ingredientes que ya tienes:</h4>
                    <ul class="recipe-ingredient-list">
                        ${(sug.ingredientes_detectados || []).map(ing => `<li>‚úÖ ${ing}</li>`).join('')}
                    </ul>
                    ${sug.ingredientes_a_comprar && sug.ingredientes_a_comprar.length > 0 ? `
                        <h4 class="recipe-subtitle" style="margin-top:15px;">Necesitar√°s comprar:</h4>
                        <ul class="recipe-ingredient-list buy">
                           ${sug.ingredientes_a_comprar.map(ing => `<li><input type="checkbox" class="buy-checkbox" checked data-item-name="${ing.nombre} (${ing.cantidad})"> ${ing.nombre} (${ing.cantidad})</li>`).join('')}
                        </ul>
                        <button class="add-article-btn" data-action="add-ingredients" style="width:100%; max-width:100%; margin-top:15px;">A√±adir seleccionados a la compra</button>
                    ` : '<p style="color:var(--muted); margin-top:15px;">¬°No necesitas comprar nada para esta receta!</p>'}
                    <button class="add-article-btn" data-action="copy-recipe" style="background-color: var(--muted); width:100%; max-width:100%; margin-top:10px;">Copiar Receta</button>
                </div>
            </div>`;
        });
    }
    html += '</div>';
    
    mainContentArea.innerHTML = html;
    mainContentArea.removeEventListener('click', handleChefResultsClicks);
    mainContentArea.addEventListener('click', handleChefResultsClicks);
}

function handleChefResultsClicks(event) {
    const button = event.target.closest('[data-action]');
    if (!button) return;
    const action = button.dataset.action;
    switch(action) {
        case 'add-ingredients': addIngredientsToShoppingList(button); break;
        case 'copy-recipe': copyToClipboard(button); break;
    }
}

function copyToClipboard(buttonElement) {
    const recipeCard = buttonElement.closest('.recipe-card');
    const title = recipeCard.querySelector('.recipe-title').innerText;
    const description = recipeCard.querySelector('.recipe-description').innerText;
    let textToCopy = `Receta: ${title}\n\n${description}\n\n`;
    const detectedIngredients = Array.from(recipeCard.querySelectorAll('.recipe-ingredient-list:not(.buy) li')).map(li => `- ${li.innerText.replace('‚úÖ ', '')}`);
    if(detectedIngredients.length > 0) textToCopy += `Ingredientes en casa:\n${detectedIngredients.join('\n')}\n\n`;
    const toBuyIngredients = Array.from(recipeCard.querySelectorAll('.recipe-ingredient-list.buy li')).map(li => `- ${li.innerText.trim()}`);
    if(toBuyIngredients.length > 0) textToCopy += `Ingredientes a comprar:\n${toBuyIngredients.join('\n')}`;
    navigator.clipboard.writeText(textToCopy).then(() => { showToast('Receta copiada al portapapeles'); }).catch(err => { showToast('Error al copiar la receta', true); });
}

async function addIngredientsToShoppingList(buttonElement) {
    const recipeCard = buttonElement.closest('.recipe-card');
    const checkboxes = recipeCard.querySelectorAll('.buy-checkbox:checked');
    if (checkboxes.length === 0) {
        showToast("No has seleccionado ning√∫n ingrediente.", true);
        return;
    }
    const itemsToAdd = Array.from(checkboxes).map(cb => cb.dataset.itemName);
    showSpinner();
    try {
        const payload = { Type: 'add_multiple_shopping_items', chat_ID: chatId, items: itemsToAdd };
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        itemsToAdd.forEach(item => { appData.shoppingList.unshift({ '1': item, '2': 'Pendiente', '3': `temp-${Date.now()}${Math.random()}`, '4': '', '5': 0 }); });
        appData.counts.shoppingPendingCount += itemsToAdd.length;
        showToast(`${itemsToAdd.length} ingredientes a√±adidos a la lista.`);
        buttonElement.style.display = 'none';
    } catch(err) {
        showToast(err.message, true);
    } finally {
        hideSpinner();
    }
}
// ==================================================
// --- M√ìDULO: AJUSTES ---
// ==================================================
function renderSettings() {
    setActiveTab('tab-settings');
    manageBackButton(true, renderDashboard);
    initialUserSettings = JSON.parse(JSON.stringify(appData.settings || {}));
    
    mainContentArea.innerHTML = `
        <div class="settings-container">
            <h2 class="settings-section-title">üë§ Perfil y Apariencia</h2>
            <div class="form-card">
                <label>Nombre de Usuario</label>
                <input type="text" id="settings-nombre" placeholder="Tu nombre" />
                <label>Email (para Calendario y Exportaciones)</label>
                <input type="email" id="settings-email" placeholder="tu@email.com" />
                <label>Ciudad</label>
                <input type="text" id="settings-ciudad" placeholder="Ej: Barcelona" />
                <label>Pa√≠s</label>
                <input type="text" id="settings-pais" placeholder="Ej: Espa√±a" />
                 <div class="settings-item">
                    <span class="settings-item-label">Tema de la App</span>
                    <div class="settings-item-control">
                        <select id="settings-theme">
                            <option value="auto">Autom√°tico (Telegram)</option>
                            <option value="light">Claro</option>
                            <option value="dark">Oscuro</option>
                        </select>
                    </div>
                </div>
            </div>

            <h2 class="settings-section-title">üîî Informes y Alertas</h2>
            <div class="form-card">
                <div class="settings-item">
                    <span class="settings-item-label">Informe Matutino</span>
                    <div class="settings-item-control">
                        <label class="switch"><input type="checkbox" id="settings-informe-manana-activo"><span class="slider"></span></label>
                    </div>
                </div>
                 <div class="settings-item">
                    <span class="settings-item-label">Hora del Informe</span>
                    <div class="settings-item-control">
                        <select id="settings-franja-manana">
                            <option value="1">A primera hora (6:00)</option>
                            <option value="2">Habitual (7:00)</option>
                            <option value="3">Media ma√±ana (8:00)</option>
                            <option value="4">Tarde (9:00)</option>
                        </select>
                    </div>
                </div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                <div class="settings-item">
                    <span class="settings-item-label">Informe del Tiempo (Tarde)</span>
                    <div class="settings-item-control">
                        <label class="switch"><input type="checkbox" id="settings-informe-tarde-activo"><span class="slider"></span></label>
                    </div>
                </div>
                 <div class="settings-item">
                    <span class="settings-item-label">Hora del Informe</span>
                    <div class="settings-item-control">
                         <select id="settings-franja-tarde">
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                        </select>
                    </div>
                </div>
                <hr style="margin: 15px 0; border-top: 1px solid #eee;">
                 <div class="settings-item">
                    <span class="settings-item-label">Alertas de Compra Inteligente</span>
                    <div class="settings-item-control">
                        <label class="switch"><input type="checkbox" id="settings-alerta-inventario"><span class="slider"></span></label>
                    </div>
                </div>
            </div>

             <h2 class="settings-section-title">üíæ Gesti√≥n de Datos</h2>
             <div class="form-card">
                 <button id="settings-sync-btn" class="add-article-btn" style="width:100%; max-width:100%;">Corregir Contadores</button>
             </div>
             
             <div class="form-card" style="margin-top: 20px;">
                <div class="button-group">
                    <button id="settings-cancel-btn" class="cancel">Cancelar</button>
                    <button id="settings-save-btn" disabled>Guardar Ajustes</button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('settings-nombre').value = appData.settings['Nombre'] || '';
    document.getElementById('settings-email').value = appData.settings['Email'] || '';
    document.getElementById('settings-ciudad').value = appData.settings['Ciudad'] || '';
    document.getElementById('settings-pais').value = appData.settings['Pais'] || '';
    document.getElementById('settings-theme').value = appData.settings['Tema'] || 'auto';
    document.getElementById('settings-informe-manana-activo').checked = (appData.settings['Informe_Ma√±ana_Activo'] === 'SI');
    document.getElementById('settings-franja-manana').value = appData.settings['Franja_Informe_Ma√±ana'] || '2';
    document.getElementById('settings-informe-tarde-activo').checked = (appData.settings['Informe_Tarde_Activo'] === 'SI');
    document.getElementById('settings-franja-tarde').value = appData.settings['Franja_Informe_Tarde'] || '20';
    document.getElementById('settings-alerta-inventario').checked = (appData.settings['Alerta_Inventario'] === 'SI');
    
    const controls = document.querySelectorAll('#settings-nombre, #settings-email, #settings-ciudad, #settings-pais, #settings-theme, #settings-informe-manana-activo, #settings-franja-manana, #settings-informe-tarde-activo, #settings-franja-tarde, #settings-alerta-inventario');
    controls.forEach(control => {
        control.addEventListener('input', validateSettings);
        control.addEventListener('change', validateSettings);
    });

    document.getElementById('settings-save-btn').onclick = saveSettings;
    document.getElementById('settings-cancel-btn').onclick = renderDashboard;
    document.getElementById('settings-sync-btn').onclick = syncCounts;
}
function validateSettings() {
    const saveBtn = document.getElementById('settings-save-btn');
    let hasChanged = false;
    if (document.getElementById('settings-nombre').value !== (initialUserSettings['Nombre'] || '')) hasChanged = true;
    if (document.getElementById('settings-email').value !== (initialUserSettings['Email'] || '')) hasChanged = true;
    if (document.getElementById('settings-ciudad').value !== (initialUserSettings['Ciudad'] || '')) hasChanged = true;
    if (document.getElementById('settings-pais').value !== (initialUserSettings['Pais'] || '')) hasChanged = true;
    if (document.getElementById('settings-theme').value !== (initialUserSettings['Tema'] || 'auto')) hasChanged = true;
    if (document.getElementById('settings-informe-manana-activo').checked !== (initialUserSettings['Informe_Ma√±ana_Activo'] === 'SI')) hasChanged = true;
    if (document.getElementById('settings-franja-manana').value != (initialUserSettings['Franja_Informe_Ma√±ana'] || '2')) hasChanged = true;
    if (document.getElementById('settings-informe-tarde-activo').checked !== (initialUserSettings['Informe_Tarde_Activo'] === 'SI')) hasChanged = true;
    if (document.getElementById('settings-franja-tarde').value != (initialUserSettings['Franja_Informe_Tarde'] || '20')) hasChanged = true;
    if (document.getElementById('settings-alerta-inventario').checked !== (initialUserSettings['Alerta_Inventario'] === 'SI')) hasChanged = true;
    saveBtn.disabled = !hasChanged;
    saveBtn.classList.toggle('enabled', hasChanged);
}

async function saveSettings() {
    showSpinner();
    const settingsToUpdate = {};
    const newName = document.getElementById('settings-nombre').value; if (newName !== (initialUserSettings['Nombre'] || '')) settingsToUpdate['Nombre'] = newName;
    const newEmail = document.getElementById('settings-email').value; if (newEmail !== (initialUserSettings['Email'] || '')) settingsToUpdate['Email'] = newEmail;
    const newCiudad = document.getElementById('settings-ciudad').value; if (newCiudad !== (initialUserSettings['Ciudad'] || '')) settingsToUpdate['Ciudad'] = newCiudad;
    const newPais = document.getElementById('settings-pais').value; if (newPais !== (initialUserSettings['Pais'] || '')) settingsToUpdate['Pais'] = newPais;
    const newTheme = document.getElementById('settings-theme').value; if (newTheme !== (initialUserSettings['Tema'] || 'auto')) settingsToUpdate['Tema'] = newTheme;
    const newMananaActivo = document.getElementById('settings-informe-manana-activo').checked; if (newMananaActivo !== (initialUserSettings['Informe_Ma√±ana_Activo'] === 'SI')) settingsToUpdate['Informe_Ma√±ana_Activo'] = newMananaActivo ? 'SI' : 'NO';
    const newFranjaManana = document.getElementById('settings-franja-manana').value; if (newFranjaManana != (initialUserSettings['Franja_Informe_Ma√±ana'] || '2')) settingsToUpdate['Franja_Informe_Ma√±ana'] = newFranjaManana;
    const newTardeActivo = document.getElementById('settings-informe-tarde-activo').checked; if (newTardeActivo !== (initialUserSettings['Informe_Tarde_Activo'] === 'SI')) settingsToUpdate['Informe_Tarde_Activo'] = newTardeActivo ? 'SI' : 'NO';
    const newFranjaTarde = document.getElementById('settings-franja-tarde').value; if (newFranjaTarde != (initialUserSettings['Franja_Informe_Tarde'] || '20')) settingsToUpdate['Franja_Informe_Tarde'] = newFranjaTarde;
    const newAlerta = document.getElementById('settings-alerta-inventario').checked; if (newAlerta !== (initialUserSettings['Alerta_Inventario'] === 'SI')) settingsToUpdate['Alerta_Inventario'] = newAlerta ? 'SI' : 'NO';
    if (Object.keys(settingsToUpdate).length === 0) {
        hideSpinner();
        showToast("No hay cambios para guardar.");
        return;
    }
    try {
        const payload = { Type: 'save_user_settings', chat_ID: chatId, settings: settingsToUpdate };
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        Object.assign(appData.settings, settingsToUpdate);
        initialUserSettings = JSON.parse(JSON.stringify(appData.settings));
        showToast("Ajustes guardados con √©xito.");
        document.getElementById('settings-save-btn').disabled = true;
        document.getElementById('settings-save-btn').classList.remove('enabled');
    } catch (err) {
        showToast(`Error al guardar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

async function syncCounts() {
    showSpinner();
    try {
        const res = await fetchWithTimeout(gasWebhookURL, { Type: 'resync_counts', chat_ID: chatId });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        if (data.success && data.counts) {
            Object.assign(appData.counts, data.counts);
            showToast("Contadores resincronizados con √©xito.");
        } else {
            throw new Error("Respuesta inesperada del servidor.");
        }
    } catch (err) {
        showToast(`Error al sincronizar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

function renderExportPage() {
    setActiveTab('tab-export');
    manageBackButton(true, renderDashboard);
    mainContentArea.innerHTML = `
        <div class="export-container">
            <h2 class="settings-section-title">üìä Exportar Gastos</h2>
            <div class="form-card">
                <p style="font-size:0.9rem; color:var(--muted); margin-bottom:15px;">Selecciona el rango de fechas para la exportaci√≥n. Recibir√°s el archivo en tu email.</p>
                <label>Fecha de Inicio</label>
                <input type="text" id="export-start-date" required />
                <label>Fecha de Fin</label>
                <input type="text" id="export-end-date" required />
                <div class="button-group">
                    <button id="export-cancel-btn" class="cancel">Cancelar</button>
                    <button id="export-confirm-btn" class="enabled">Generar y Enviar</button>
                </div>
            </div>
        </div>
    `;
    const fpConfig = { dateFormat: "d/m/Y", locale: "es" };
    flatpickr("#export-start-date", { ...fpConfig, defaultDate: new Date(new Date().getFullYear(), 0, 1) });
    flatpickr("#export-end-date", { ...fpConfig, defaultDate: new Date() });
    document.getElementById('export-cancel-btn').onclick = renderDashboard;
    document.getElementById('export-confirm-btn').onclick = executeExport;
}

async function executeExport() {
    showSpinner();
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    if (!startDate || !endDate) {
        hideSpinner();
        showToast("Por favor, selecciona ambas fechas.", true);
        return;
    }
    try {
        const payload = { Type: 'export_gastos', chat_ID: chatId, startDate: startDate, endDate: endDate };
        const res = await fetchWithTimeout(gasWebhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast(data.message || "Petici√≥n de exportaci√≥n enviada. Revisa tu email.");
        renderDashboard();
    } catch (err) {
        showToast(`Error al exportar: ${err.message}`, true);
    } finally {
        hideSpinner();
    }
}

// ==================================================
// --- CONECTOR E INICIO DE LA APP ---
// ==================================================
function renderDashboard() {
  setActiveTab('tab-home');
  manageBackButton(false);
  const counts = appData.counts;
  const isPremium = String(appData.isPremium).toLowerCase() === 'true';

  let chefCardHtml = `
    <div class="card clickable-card" id="chef-card">
        <div class="card-icon">üßë‚Äçüç≥</div>
        <div class="card-title">Chef Asistente</div>
    </div>`;

  if (!isPremium) {
      chefCardHtml = `
        <div class="card" style="opacity: 0.5; cursor: not-allowed;">
            <div class="card-icon">üîí</div>
            <div class="card-title">Chef Asistente</div>
            <div style="font-size: 0.8rem; color: var(--muted); margin-top: 4px;">Funci√≥n Premium</div>
        </div>`;
  }

  mainContentArea.innerHTML = `
    <div class="grid">
      <div class="card clickable-card"><div class="card-badge red" style="left:12px;">${counts.remindersCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-recordatorios">‚ãÆ</button><div class="card-icon">üóìÔ∏è</div><div class="card-title">Recordatorios</div><div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">A√±adir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div></div>
      <div class="card clickable-card"><div class="card-badge-group"><div class="card-badge green">${counts.shoppingPendingCount || 0}</div><div class="card-badge red">${counts.shoppingBoughtCount || 0}</div></div><button class="card-menu-btn" data-menu-id="menu-shopping-list">‚ãÆ</button><div class="card-icon">üõí</div><div class="card-title">Compras</div><div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">A√±adir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div></div>
      <div class="card clickable-card"><div class="card-badge red" style="left:12px;">${counts.notesCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-notes">‚ãÆ</button><div class="card-icon">üìù</div><div class="card-title">Notas</div><div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">A√±adir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div></div>
      <div class="card clickable-card"><div class="card-badge red" style="left:12px;">${counts.calendarTodayCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-calendar">‚ãÆ</button><div class="card-icon">üóìÔ∏è</div><div class="card-title">Calendario</div><div class="dropdown-menu" id="menu-calendar"><a class="dropdown-item" id="add-event-link">A√±adir Evento</a><a class="dropdown-item" id="view-calendar-link">Ver Calendario</a></div></div>
	  <div class="card clickable-card"><div class="card-badge red" style="left:12px;">${(counts.gastosMesActual || '0,00').split(',')[0]}</div><button class="card-menu-btn" data-menu-id="menu-gastos">‚ãÆ</button><div class="card-icon">üí∞</div><div class="card-title">Gastos</div><div class="dropdown-menu" id="menu-gastos"><a class="dropdown-item" id="add-gasto-link">A√±adir</a><a class="dropdown-item" id="scan-gasto-link">Escanear Ticket</a><a class="dropdown-item" id="list-gastos-link">Buscar</a><a class="dropdown-item" id="view-gasto-chart-link">Ver Gr√°fico</a></div></div>
      ${chefCardHtml}
    </div>`;
  
  document.getElementById('add-reminder-link').onclick = renderReminderForm;
  document.getElementById('list-reminders-link').onclick = renderRemindersList;
  document.getElementById('view-shopping-list-link').onclick = renderShoppingList;
  document.getElementById('add-shopping-item-link').onclick = renderAddArticleForm;
  document.getElementById('add-note-link').onclick = () => renderNoteForm();
  document.getElementById('list-notes-link').onclick = renderNotesList;
  document.getElementById('add-event-link').onclick = renderEventForm;
  document.getElementById('view-calendar-link').onclick = () => renderCalendarView();
  document.getElementById('scan-gasto-link').onclick = renderInstructionScreen;
  document.getElementById('add-gasto-link').onclick = () => renderAddGastoForm(null);
  document.getElementById('list-gastos-link').onclick = renderSearchGastosForm;
  document.getElementById('view-gasto-chart-link').onclick = renderGastoChart;
  
  if (isPremium) {
      document.getElementById('chef-card').onclick = renderChefPage;
  }

  document.querySelectorAll('.clickable-card').forEach(card => {
      card.addEventListener('click', (e) => {
          if (e.target.closest('.card-menu-btn') || e.target.closest('.dropdown-menu')) return;
          if (e.currentTarget.id === 'chef-card' && !isPremium) return;
          e.stopPropagation();
          const menuBtn = card.querySelector('.card-menu-btn');
          if (menuBtn) {
            const menuId = menuBtn.dataset.menuId;
            const menu = document.getElementById(menuId);
            if (menu) {
                const isShown = menu.classList.contains('show');
                document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                    if (m.id !== menuId) m.classList.remove('show');
                });
                menu.classList.toggle('show', !isShown);
            }
          }
      });
  });
}

// L√≥gica de pesta√±as
document.getElementById('tab-home').onclick = renderDashboard;
document.getElementById('tab-settings').onclick = renderSettings;
document.getElementById('tab-export').onclick = renderExportPage;
document.getElementById('tab-chef').onclick = () => {
    if(appData.isPremium) {
        renderChefPage();
    } else {
        showToast("El Chef Asistente es una funci√≥n Premium.", true);
    }
};

initializeApp();

    });
  </script>
</body>
</html>
