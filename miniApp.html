<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; --edit-icon-color: #007bff; --checkbox-border: #ddd; --checkbox-checked-bg: var(--primary); }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:.9rem;}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;left:12px;}
    .card-badge.red{background-color:#e74c3c;right:12px;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 12px 20px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .dropdown-item:hover { background-color: var(--bg); }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container{max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card h2{margin-bottom:16px;font-size:1.4rem;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input, .form-card select, .form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input, .form-card select{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text);}
    .form-card input.flatpickr-input { background-color: #fff !important; }
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1001;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .reminder-list, .shopping-list, .notes-list, .agenda-view, .gastos-list { list-style: none; padding: 0; margin: 0; }
    .reminder-item, .shopping-item, .event-item, .gasto-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .reminder-details, .event-details, .gasto-details { display: flex; flex-direction: column; flex-grow: 1; text-align: left;}
    .reminder-text, .event-summary, .gasto-establecimiento { font-size: 1.1rem; font-weight: 500; }
    .reminder-date, .event-time, .gasto-info { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .gasto-importe { font-size: 1.1rem; font-weight: 600; color: var(--text); white-space: nowrap; margin-right: 10px; }
    .reminder-actions, .gasto-actions { display: flex; align-items: center; gap: 5px; }
    .reminder-delete-btn, .event-menu-btn, .gasto-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-reminders, .no-shopping-items, .no-notes, .no-events, .no-gastos { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; }
    #main:empty { display: none; }
    .gasto-list-filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .gasto-list-filters > * { flex-grow: 1; }
    .gasto-list-filters select { flex-basis: 100%; }
    .gasto-list-filters button { padding: 10px 15px; background: var(--primary); color: var(--action-text); border: none; border-radius: 8px; cursor: pointer; }
    .gasto-chart-container { text-align: center; }
    .gasto-chart-container img { max-width: 100%; border-radius: 12px; margin-top: 15px; }
  </style>
</head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="main"></div>
  <div class="tabs"> <div class="tab active" id="tab-home">Home</div> </div>
  <div id="toast" class="toast"></div>
  
  <script>
    (function() { const params = new URLSearchParams(window.location.search); if (!params.has('v')) { const newUrl = new URL(window.location.href); newUrl.searchParams.set('v', new Date().getTime()); window.location.replace(newUrl.href); } })();

    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.expand();
        if (tg.themeParams) {
            document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa');
            document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff');
            document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333');
            document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555');
            document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3');
            document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff');
        }
      }
      const webhookURL = 'https://script.google.com/macros/s/AKfycbxMy9HJ33GJz2S2RvWIFTc6AxI1L2EFw_cyVstKbmvEXQl43sbrYv3QE0dc6OhIX6XBpw/exec';
      let chatId = tg?.initDataUnsafe?.user?.id;
      if (!chatId) { chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', '7200016'); }

      let appData = {
          counts: { remindersCount: 0, shoppingPendingCount: 0, shoppingBoughtCount: 0, notesCount: 0, calendarTodayCount: 0, gastosMesActual: '0,00', mesesActivosGastos: [] },
          gastosCache: {}
      };
      let toastTimer; 
      const mainContent = document.getElementById('main');
      const spinner = document.getElementById('spinner');

      function showSpinner() { spinner.style.display = 'block'; }
      function hideSpinner() { spinner.style.display = 'none'; }
      function showToast(msg, isError = false) { clearTimeout(toastTimer); const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); }
      async function fetchWithTimeout(resource, options = {}, timeout = 30000) { const controller = new AbortController(); const id = setTimeout(() => controller.abort(), timeout); try { const modifiedOptions = { ...options, signal: controller.signal, method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: options.body }; const response = await fetch(resource, modifiedOptions); clearTimeout(id); return response; } catch (error) { clearTimeout(id); if (error.name === 'AbortError') throw new Error('Timeout: La solicitud tardó demasiado.'); throw error; } }

      async function initializeAppContent() {
        showSpinner();
        try {
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_initial_counts' }) });
          if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          appData.counts = data;
        } catch (err) { console.error('Error en la carga inicial:', err); showToast(`Error al cargar datos: ${err.message}`, true);
        } finally { renderDashboard(); hideSpinner(); }
      }

      function renderDashboard() {
        setActiveTab('tab-home');
        mainContent.innerHTML = `
          <div class="grid">
            <div class="card" id="card-recordatorios-wrapper">
              <div class="card-badge red" style="left:12px;">${appData.counts.remindersCount ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="recordatorios">⋮</button>
              <div class="card-icon">🗓️</div><div class="card-title">Recordatorios</div>
              <div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">Añadir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-shopping-list-wrapper">
              <div class="card-badge-group"><div class="card-badge green">${appData.counts.shoppingPendingCount ?? '...'}</div><div class="card-badge red">${appData.counts.shoppingBoughtCount ?? '...'}</div></div>
              <button class="card-menu-btn" data-menu-for="shopping-list">⋮</button>
              <div class="card-icon">🛒</div><div class="card-title">Lista de Compras</div>
              <div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">Añadir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-notes-wrapper">
              <div class="card-badge red" style="left:12px;">${appData.counts.notesCount ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="notes">⋮</button>
              <div class="card-icon">📝</div><div class="card-title">Notas</div>
              <div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">Añadir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-calendar-wrapper">
              <div class="card-badge red" style="left:12px;">${appData.counts.calendarTodayCount ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="calendar">⋮</button>
              <div class="card-icon">🗓️</div><div class="card-title">Calendario</div>
              <div class="dropdown-menu" id="menu-calendar"><a class="dropdown-item" id="add-event-link">Añadir Evento</a><a class="dropdown-item" id="view-agenda-link">Ver Agenda</a></div>
            </div>
            <div class="card" id="card-gastos-wrapper">
              <div class="card-badge red" style="left:12px;">${(appData.counts.gastosMesActual || '0,00').split(',')[0]}</div>
              <button class="card-menu-btn" data-menu-for="gastos">⋮</button>
              <div class="card-icon">💰</div><div class="card-title">Gastos</div>
              <div class="dropdown-menu" id="menu-gastos">
                <a class="dropdown-item" id="add-gasto-link">Añadir Gasto</a>
                <a class="dropdown-item" id="list-gastos-link">Buscar entre Fechas</a>
                <a class="dropdown-item" id="view-gasto-chart-link">Ver Gráfico de Gastos</a>
              </div>
            </div>
          </div>`;
        document.getElementById('add-reminder-link').onclick = () => renderReminderForm();
        document.getElementById('list-reminders-link').onclick = () => renderRemindersList();
        document.getElementById('view-shopping-list-link').onclick = () => renderShoppingList();
        document.getElementById('add-shopping-item-link').onclick = () => renderAddArticleForm();
        document.getElementById('add-note-link').onclick = () => renderNoteForm();
        document.getElementById('list-notes-link').onclick = () => renderNotesList();
        document.getElementById('add-event-link').onclick = () => renderEventForm();
        document.getElementById('view-agenda-link').onclick = () => renderAgendaView();
        document.getElementById('add-gasto-link').onclick = () => renderGastoForm();
        document.getElementById('list-gastos-link').onclick = () => renderGastosList();
        document.getElementById('view-gasto-chart-link').onclick = () => renderGastoChart();
      }
      
      document.body.addEventListener('click', (e) => {
        const menuBtn = e.target.closest('.card-menu-btn, .note-menu-btn, .shopping-item-menu-btn, .event-menu-btn, .gasto-menu-btn');
        document.querySelectorAll('.dropdown-menu').forEach(m => {
          if (!m.contains(e.target) && !menuBtn) { m.classList.remove('show'); }
        });
        if (menuBtn) { 
          e.stopPropagation(); 
          let menuId;
          if (menuBtn.dataset.menuFor) menuId = `menu-${menuBtn.dataset.menuFor}`;
          else if (menuBtn.dataset.gastoId) menuId = `menu-gasto-${menuBtn.dataset.gastoId}`;
          else return; // Simplificado para mayor claridad
          const menu = document.getElementById(menuId);
          if (menu) {
            const isShown = menu.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            if (!isShown) menu.classList.add('show');
          }
        }
      });
      function setActiveTab(activeTabId) { document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); const activeTab = document.getElementById(activeTabId); if (activeTab) activeTab.classList.add('active'); }
      
      // ... (Aquí iría el código completo de las otras 4 cards) ...
      
      // ======================================================================
      // --- SECCIÓN COMPLETA DE GASTOS ---
      // ======================================================================
      function renderGastoForm(gasto = null) {
        const isEditing = gasto !== null;
        mainContent.innerHTML = `
          <div class="list-container">
            <div class="list-header"><button class="back-btn" id="back-btn">‹</button><h2>${isEditing ? '✏️ Editar Gasto' : '💰 Nuevo Gasto'}</h2></div>
            <div class="form-card">
              <label>Fecha</label><input type="text" id="gasto-fecha" readonly="readonly">
              <label>Establecimiento</label><input type="text" id="gasto-establecimiento" value="${isEditing ? (gasto.Establecimiento || '') : ''}" required />
              <label>Importe</label><input type="number" id="gasto-importe" step="0.01" value="${isEditing ? (gasto.Importe || '') : ''}" placeholder="Ej: 12.50" required />
              <label>Categoría</label><input type="text" id="gasto-categoria" value="${isEditing ? (gasto.categoria || '') : ''}" required />
              <label>Sub-categoría (opcional)</label><input type="text" id="gasto-subcategoria" value="${isEditing ? (gasto.sub_categoria || '') : ''}" />
              <button id="save-gasto-btn" data-id-unico="${isEditing ? gasto.ID_Unico : ''}">${isEditing ? 'Guardar Cambios' : 'Registrar Gasto'}</button>
            </div>
          </div>`;
        document.getElementById('back-btn').onclick = () => renderDashboard();
        flatpickr("#gasto-fecha", { defaultDate: isEditing ? new Date(gasto.Fecha) : new Date(), dateFormat: "Y-m-d H:i", enableTime: true, time_24hr: true, locale: "es" });
        const saveBtn = document.getElementById('save-gasto-btn');
        const inputs = ['gasto-establecimiento', 'gasto-importe', 'gasto-categoria'];
        function validateGastoForm() { const allValid = inputs.every(id => document.getElementById(id).value.trim() !== ''); saveBtn.disabled = !allValid; saveBtn.classList.toggle('enabled', allValid); }
        inputs.forEach(id => document.getElementById(id).addEventListener('input', validateGastoForm));
        saveBtn.onclick = saveGasto;
        validateGastoForm();
      }

      async function saveGasto() {
        const saveBtn = document.getElementById('save-gasto-btn');
        if (saveBtn.disabled) return;
        saveBtn.disabled = true;
        const idUnico = saveBtn.dataset.idUnico;
        const isEditing = !!idUnico;
        const oldImporte = isEditing ? parseFloat(document.getElementById('gasto-importe').defaultValue) : 0;
        const newImporte = parseFloat(document.getElementById('gasto-importe').value);
        const payload = { Type: isEditing ? 'edit_gasto' : 'add_gasto', chat_ID: chatId, ID_Unico: idUnico || 'A-' + Math.random().toString(36).substring(2, 8).toUpperCase(), Fecha: document.getElementById('gasto-fecha')._flatpickr.selectedDates[0].toISOString(), Establecimiento: document.getElementById('gasto-establecimiento').value.trim(), Importe: newImporte, categoria: document.getElementById('gasto-categoria').value.trim(), sub_categoria: document.getElementById('gasto-subcategoria').value.trim() };
        showSpinner();
        try {
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) });
          const data = await res.json();
          if (data.error || (data.resultado && data.resultado.startsWith('Error'))) throw new Error(data.resultado || data.error);
          showToast(`Gasto ${isEditing ? 'actualizado' : 'registrado'}`);
          const totalActual = parseFloat((appData.counts.gastosMesActual || '0').replace(',', '.'));
          appData.counts.gastosMesActual = (totalActual - oldImporte + newImporte).toFixed(2).replace('.', ',');
          renderGastosList();
        } catch (err) { showToast(err.message, true); saveBtn.disabled = false; saveBtn.classList.toggle('enabled', true); } finally { hideSpinner(); }
      }

      function renderGastosList() {
        const mesesOptions = (appData.counts.mesesActivosGastos || []).map(mes => `<option value="${mes}">${mes}</option>`).join('');
        mainContent.innerHTML = `
          <div class="list-container">
            <div class="list-header"><button class="back-btn" id="back-btn">‹</button><h2>Historial de Gastos</h2></div>
            <div class="form-card gasto-list-filters">
              <select id="gasto-mes-select"><option value="">Selecciona un mes...</option>${mesesOptions}</select>
              <input type="text" id="gasto-fecha-start" placeholder="O desde..." readonly="readonly">
              <input type="text" id="gasto-fecha-end" placeholder="...hasta" readonly="readonly">
              <button id="buscar-gastos-btn">Buscar</button>
            </div>
            <ul class="gastos-list" id="gastos-list-ul"></ul>
          </div>`;
        document.getElementById('back-btn').onclick = () => renderDashboard();
        const startPicker = flatpickr("#gasto-fecha-start", { dateFormat: "d/m/Y", locale: "es" });
        const endPicker = flatpickr("#gasto-fecha-end", { dateFormat: "d/m/Y", locale: "es" });
        document.getElementById('buscar-gastos-btn').onclick = () => fetchAndDisplayGastos(startPicker.input.value, endPicker.input.value);
        document.getElementById('gasto-mes-select').onchange = (e) => {
          if (e.target.value) {
            const [mes, anio] = e.target.value.split('/');
            const primerDia = `01/${mes}/${anio}`;
            const ultimoDia = new Date(anio, mes, 0).getDate();
            const fechaFin = `${ultimoDia}/${mes}/${anio}`;
            fetchAndDisplayGastos(primerDia, fechaFin);
          }
        };
        document.getElementById('gastos-list-ul').addEventListener('click', handleGastoInteractions);
      }

      async function fetchAndDisplayGastos(fechaStart, fechaEnd) {
        const cacheKey = `${fechaStart}-${fechaEnd}`;
        const listUl = document.getElementById('gastos-list-ul');
        if (appData.gastosCache[cacheKey]) {
          listUl.innerHTML = appData.gastosCache[cacheKey];
          return;
        }
        showSpinner();
        try {
          const payload = { make_action: 'get_gastos_fecha', chat_id: chatId, datos: { fecha_start: fechaStart, fecha_end: fechaEnd } };
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) });
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          let listHtml;
          if (data.Lista_de_gastos && data.Lista_de_gastos.includes("No existen registros")) {
            listHtml = '<div class="no-gastos">🤷<br>No se encontraron gastos en este período.</div>';
          } else {
            const lines = data.Lista_de_gastos.split('\n').filter(line => line.includes('🆔'));
            const categoryIcons = { 'restaurantes y cafés': '🍔', 'alimentación y supermercado': '🛒', 'gastos personales': '👤', 'entretenimiento y ocio': '🎉', 'farmacia': '💊' };
            listHtml = lines.map(line => {
                const parts = line.split(' | ');
                const fecha = parts[0]?.replace('🗓 ', '').trim();
                const establecimiento = parts[1]?.replace('🛍 ', '').trim();
                const importe = parts[2]?.replace('💵 ', '').trim();
                const categoria = parts[3]?.replace('🛒 ', '').trim();
                const idUnico = parts[4]?.replace('🆔 ', '').trim();
                const icon = categoryIcons[categoria.toLowerCase()] || '💰';
                return `<li class="gasto-item" id="gasto-${idUnico}">
                          <div style="font-size: 1.5rem; margin-right: 15px;">${icon}</div>
                          <div class="gasto-details">
                            <span class="gasto-establecimiento">${establecimiento}</span>
                            <span class="gasto-info">${fecha} - ${categoria}</span>
                          </div>
                          <div class="gasto-actions">
                            <span class="gasto-importe">${importe}</span>
                            <div style="position:relative">
                              <button class="gasto-menu-btn" data-gasto-id="${idUnico}">⋮</button>
                              <div class="dropdown-menu" id="menu-gasto-${idUnico}">
                                <a class="dropdown-item" data-action="edit-gasto" data-id-unico="${idUnico}">Editar</a>
                                <a class="dropdown-item" data-action="delete-gasto" data-id-unico="${idUnico}">Eliminar</a>
                              </div>
                            </div>
                          </div>
                        </li>`;
            }).join('');
          }
          appData.gastosCache[cacheKey] = listHtml;
          listUl.innerHTML = listHtml;
        } catch (err) { listUl.innerHTML = `<div class="no-gastos">❌<br>Error al buscar gastos.<br><small>${err.message}</small></div>`;
        } finally { hideSpinner(); }
      }

      function handleGastoInteractions(event) {
        const actionItem = event.target.closest('.dropdown-menu .dropdown-item');
        if (actionItem) {
          event.stopPropagation();
          const action = actionItem.dataset.action;
          const idUnico = actionItem.dataset.idUnico;
          document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
          if (action === 'edit-gasto') { fetchAndRenderGastoForEdit(idUnico);
          } else if (action === 'delete-gasto') {
            const actionContainer = actionItem.closest('.gasto-actions');
            const confirmBtnYes = document.createElement('button'); confirmBtnYes.className = 'confirm-btn-yes'; confirmBtnYes.textContent = 'Sí'; confirmBtnYes.onclick = () => executeDeleteGasto(idUnico);
            const confirmBtnNo = document.createElement('button'); confirmBtnNo.className = 'confirm-btn-no'; confirmBtnNo.textContent = 'No'; 
            confirmBtnNo.onclick = () => { actionContainer.innerHTML = actionContainer.originalInnerHTML; };
            actionContainer.originalInnerHTML = actionContainer.innerHTML;
            const importeSpan = actionContainer.querySelector('.gasto-importe');
            actionContainer.innerHTML = '';
            if(importeSpan) actionContainer.appendChild(importeSpan);
            actionContainer.appendChild(confirmBtnYes); actionContainer.appendChild(confirmBtnNo);
          }
        }
      }

      async function fetchAndRenderGastoForEdit(idUnico) {
        showSpinner();
        try {
          const payload = { Type: 'get_gasto_by_id', chat_ID: chatId, ID_Unico: idUnico };
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) });
          const data = await res.json();
          if(data.error) throw new Error(data.error);
          renderGastoForm(data);
        } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
      }

      async function executeDeleteGasto(idUnico) {
        showSpinner();
        try {
          const payload = { make_action: 'delete_gasto_id', chat_id: chatId, datos: { ID_Unico: idUnico } };
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) });
          const data = await res.json();
          if (data.error || (data.Resultado && data.Resultado.startsWith('Error'))) throw new Error(data.Resultado || data.error);
          showToast('Gasto eliminado');
          appData.gastosCache = {}; // Limpiar caché
          await initializeAppContent(); // Recargar datos para actualizar el badge correctamente
          renderGastosList();
        } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
      }

      function renderGastoChart() {
        const mesesOptions = (appData.counts.mesesActivosGastos || []).map(mes => `<option value="${mes}">${mes}</option>`).join('');
        mainContent.innerHTML = `
          <div class="list-container">
            <div class="list-header"><button class="back-btn" id="back-btn">‹</button><h2>Gráfico de Gastos</h2></div>
            <div class="form-card gasto-chart-container" id="chart-container">
              <select id="gasto-chart-mes-select"><option value="">Selecciona un mes para el gráfico...</option>${mesesOptions}</select>
            </div>
          </div>`;
        document.getElementById('back-btn').onclick = () => renderDashboard();
        document.getElementById('gasto-chart-mes-select').onchange = fetchAndDisplayGastoChart;
      }

      async function fetchAndDisplayGastoChart(event) {
        const mesAnio = event.target.value;
        if (!mesAnio) return;
        showSpinner();
        try {
          const payload = { Type: 'get_gastos_chart', chat_ID: chatId, mes_anio: mesAnio };
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) });
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          let img = document.querySelector('#chart-container img');
          if (!img) {
              img = document.createElement('img');
              document.getElementById('chart-container').appendChild(img);
          }
          img.src = data.chartUrl;
          img.alt = `Gráfico de gastos para ${mesAnio}`;
        } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
      }
      
      // ======================================================================
      // --- INICIO DE LA APP ---
      // ======================================================================
      document.getElementById('tab-home').onclick = () => renderDashboard();
      initializeAppContent();
    });
  </script>
</body>
</html>
