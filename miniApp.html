<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { 
        --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c;
        --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; 
        --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; 
        --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; 
        --list-item-text: #fff; --edit-icon-color: #007bff; --checkbox-border: #ddd;
        --checkbox-checked-bg: var(--primary);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative; transition: opacity 0.3s; cursor: pointer;}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;left:12px;background:var(--badge-color);color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:.9rem;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; overflow: hidden; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 12px 20px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .list-container{max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card h2{margin-bottom:16px;font-size:1.4rem;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input{width:100%;margin-top:8px;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text);}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:pointer;opacity:1;}
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1001;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .shopping-list { list-style: none; padding: 0; margin: 0; }
    .no-items { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; }
    .shopping-item { display: flex; align-items: center; gap: 5px; padding: 10px; }
    .shopping-item-checkbox-wrapper { flex-shrink: 0; margin-right: 8px; }
    .shopping-item input[type="checkbox"] { appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 2px solid var(--checkbox-border); border-radius: 4px; background-color: var(--card-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background-color 0.2s, border-color 0.2s; }
    .shopping-item input[type="checkbox"]::after { content: '‚úî'; font-size: 14px; color: var(--action-text); display: none; }
    .shopping-item input[type="checkbox"]:checked { background-color: var(--checkbox-checked-bg); border-color: var(--checkbox-checked-bg); }
    .shopping-item input[type="checkbox"]:checked::after { display: block; }
    .shopping-item-toggle-btn { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; color: var(--list-item-text); cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: background-color 0.2s ease, transform 0.1s ease; }
    .shopping-item-toggle-btn:active { transform: translateY(1px); }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); }
    .shopping-item-toggle-btn .item-date { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; }
    .shopping-item-menu-container { position: relative; flex-shrink: 0; margin-left: auto; }
    .shopping-item-menu-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; }
    .shopping-item-dropdown-menu { display: none; position: absolute; top: 30px; right: 0; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; min-width: 150px; }
    .shopping-item-dropdown-menu.show { display: block; }
    .shopping-item-dropdown-item { padding: 10px 15px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .add-article-btn-container { padding: 10px; text-align: center; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .add-article-btn, .multi-select-action-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; flex-grow: 1; max-width: 250px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
    .multi-select-action-btn:not(.enabled) { cursor: not-allowed; opacity: 0.6; }
    .section-title { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 10px 10px; padding-top: 10px; border-top: 1px solid var(--muted); text-align: left; }
    .section-title:first-of-type { border-top: none; margin-top: 0; }
  </style>
</head>
<body>
  <div id="spinner" class="spinner" style="display: none;"></div>
  <div id="main"></div>
  <div class="tabs">
    <div class="tab active" id="tab-home">Home</div>
    <div class="tab" id="tab-recordatorios">Recordatorios</div>
  </div>
  <div id="toast" class="toast"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.expand();
        if (tg.themeParams) {
            Object.keys(tg.themeParams).forEach(key => {
                let cssVar = `--${key.replace(/_/g, '-')}`;
                document.documentElement.style.setProperty(cssVar, tg.themeParams[key]);
            });
        }
      }

      const mainContent = document.getElementById('main');
      const spinner = document.getElementById('spinner');
      const webhookURL = 'https://hook.eu2.make.com/d3lj3iug4qsbyjdmalmh3sk491elhqps';
      let chatId;

      function showSpinner() { spinner.style.display = 'block'; }
      function hideSpinner() { spinner.style.display = 'none'; }
      
      function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = `toast show ${isError ? 'error' : ''}`;
        setTimeout(() => t.className = 'toast', 3000);
      }
      
      async function callApi(payload) {
        showSpinner();
        try {
          const response = await fetch(webhookURL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...payload, chat_ID: chatId })
          });
          if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
          const data = await response.json();
          if (data.error) throw new Error(data.error);
          return data;
        } catch (err) {
          showToast(err.message, true);
          mainContent.innerHTML = `<div class="no-items">‚ùå<br>Error de comunicaci√≥n.<br><small>${err.message}</small></div>`;
          throw err;
        } finally {
          hideSpinner();
        }
      }

      function renderDashboard() {
        setActiveTab('tab-home');
        mainContent.innerHTML = `
          <div class="grid">
            <div class="card" id="card-recordatorios-wrapper">
                <div class="card-icon">üóìÔ∏è</div>
                <div class="card-title">Recordatorios</div>
            </div>
            <div class="card" id="card-shopping-list-wrapper">
                <div class="card-icon">üõí</div>
                <div class="card-title">Lista de Compras</div>
                <button class="card-menu-btn" data-menu-for="shopping-list">‚ãÆ</button>
                <div class="dropdown-menu" id="menu-shopping-list">
                    <a class="dropdown-item" id="view-shopping-list-link">Ver lista</a>
                    <a class="dropdown-item" id="add-shopping-item-link">A√±adir art√≠culo</a>
                </div>
            </div>
          </div>`;
        
        document.getElementById('card-shopping-list-wrapper').onclick = (e) => {
            if(!e.target.closest('.card-menu-btn')) renderShoppingList();
        };
        document.getElementById('view-shopping-list-link').onclick = renderShoppingList;
        document.getElementById('add-shopping-item-link').onclick = renderAddArticleForm;
        document.getElementById('card-recordatorios-wrapper').onclick = () => showToast("Funci√≥n de recordatorios en construcci√≥n.");
      }
      
      document.body.addEventListener('click', (e) => {
        const menuBtn = e.target.closest('.card-menu-btn');
        document.querySelectorAll('.dropdown-menu, .shopping-item-dropdown-menu').forEach(m => {
            if (!menuBtn || m.id !== `menu-${menuBtn.dataset.menuFor}`) {
                m.classList.remove('show');
            }
        });
        if (menuBtn) {
            e.stopPropagation();
            const menuId = `menu-${menuBtn.dataset.menuFor}`;
            document.getElementById(menuId)?.classList.toggle('show');
        }
      });
      
      async function renderShoppingList() { 
          try {
              const items = await callApi({ Type: 'get_shopping_list' });
              renderShoppingListItems(items); 
          } catch (err) { /* El error ya se muestra en callApi */ }
      }

      function renderShoppingListItems(items) {
          const pendingItems = items.filter(item => item['2'] === 'Pendiente');
          const boughtItems = items.filter(item => item['2'] === 'Comprado');
          let listHtml = `
            <div class="list-container">
              <div class="list-header"><button class="back-btn" id="back-to-dashboard">‚Äπ</button><h2>Lista de Compras</h2></div>
              <ul class="shopping-list" id="shopping-list-ul">`;
          
          if (items.length === 0) {
              listHtml += '<div class="no-items">üõí<br>¬°Tu lista est√° vac√≠a!</div>';
          } else {
              if (pendingItems.length > 0) {
                  listHtml += '<h3 class="section-title">Pendientes</h3>';
                  listHtml += pendingItems.map(item => shoppingItemTemplate(item, false)).join('');
              }
              if (boughtItems.length > 0) {
                  listHtml += '<h3 class="section-title">Comprados</h3>';
                  listHtml += boughtItems.map(item => shoppingItemTemplate(item, true)).join('');
              }
          }

          listHtml += `</ul><div class="add-article-btn-container">
                        <button class="add-article-btn" id="add-shopping-item-bottom-btn">A√±adir Art√≠culo</button>
                        ${boughtItems.length > 0 ? '<button class="multi-select-action-btn" id="multi-select-toggle-btn">Marcar como pendientes</button>' : ''}
                       </div></div>`;

          mainContent.innerHTML = listHtml;
          document.getElementById('back-to-dashboard').onclick = renderDashboard;
          document.getElementById('shopping-list-ul').addEventListener('click', handleShoppingItemInteractions);
          document.getElementById('add-shopping-item-bottom-btn').onclick = renderAddArticleForm;
          if (boughtItems.length > 0) {
              document.querySelectorAll('.shopping-item-checkbox').forEach(cb => cb.onchange = updateMultiSelectButtonState);
              document.getElementById('multi-select-toggle-btn').onclick = toggleSelectedItemsToPending;
              updateMultiSelectButtonState();
          }
      }

      function shoppingItemTemplate(item, isBought) {
        return `<li class="shopping-item" id="shopping-item-${item['3']}">
                  ${isBought ? `<div class="shopping-item-checkbox-wrapper"><input type="checkbox" class="shopping-item-checkbox" data-tracking-code="${item['3']}"></div>` : ''}
                  <button class="shopping-item-toggle-btn ${isBought ? 'bought' : 'pending'}" data-tracking-code="${item['3']}" data-current-status="${item['2']}">
                    <span>${item['1']}</span>
                    ${isBought && item['4'] ? `<span class="item-date">${item['4']}</span>` : ''}
                  </button>
                  <div class="shopping-item-menu-container">
                    <button class="shopping-item-menu-btn" data-item-tracking-code="${item['3']}">‚ãÆ</button>
                    <div class="shopping-item-dropdown-menu" id="menu-shopping-item-${item['3']}">
                      <a class="dropdown-item edit-btn-item" data-tracking-code="${item['3']}" data-current-description="${item['1']}">Editar</a>
                      <a class="dropdown-item delete-btn-item" data-tracking-code="${item['3']}">Eliminar</a>
                    </div>
                  </div>
                </li>`;
      }

      function handleShoppingItemInteractions(event) {
          const target = event.target;
          const toggleBtn = target.closest('.shopping-item-toggle-btn');
          const menuBtn = target.closest('.shopping-item-menu-btn');
          const editBtn = target.closest('.edit-btn-item');
          const deleteBtn = target.closest('.delete-btn-item');

          document.querySelectorAll('.shopping-item-dropdown-menu').forEach(menu => {
              if (!menuBtn || menu.id !== `menu-shopping-item-${menuBtn.dataset.itemTrackingCode}`) {
                  menu.classList.remove('show');
              }
          });

          if (toggleBtn) {
            toggleShoppingItemStatus(toggleBtn.dataset.trackingCode, toggleBtn.dataset.currentStatus === 'Pendiente' ? 'Comprado' : 'Pendiente');
          } else if (menuBtn) {
            event.stopPropagation();
            document.getElementById(`menu-shopping-item-${menuBtn.dataset.itemTrackingCode}`).classList.toggle('show');
          } else if (editBtn) {
            editShoppingItem(editBtn.dataset.trackingCode, editBtn.dataset.currentDescription);
          } else if (deleteBtn) {
            deleteShoppingItem(deleteBtn.dataset.trackingCode);
          }
      }

      function updateMultiSelectButtonState() {
          const btn = document.getElementById('multi-select-toggle-btn');
          if(!btn) return;
          const selectedCount = document.querySelectorAll('.shopping-item-checkbox:checked').length;
          btn.classList.toggle('enabled', selectedCount > 0);
          btn.textContent = selectedCount > 0 ? `Marcar ${selectedCount} como pendientes` : 'Marcar como pendientes';
      }

      async function toggleShoppingItemStatus(trackingCode, newStatus) {
        const items = await callApi({Type:'toggle_item_status', tracking_code: trackingCode, new_status: newStatus});
        showToast(`Art√≠culo marcado como ${newStatus}`);
        renderShoppingListItems(items);
      }

      async function toggleSelectedItemsToPending() {
        const btn = document.getElementById('multi-select-toggle-btn');
        if (!btn.classList.contains('enabled')) return;
        const codes = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.trackingCode);
        if (codes.length === 0) return;
        const items = await callApi({Type:'toggle_multiple_to_pending', tracking_codes: codes});
        showToast(`${codes.length} art√≠culos marcados como Pendiente.`);
        renderShoppingListItems(items);
      }

      async function editShoppingItem(code, desc) {
        const newDesc = prompt('Editar descripci√≥n:', desc);
        if (newDesc && newDesc.trim() !== '' && newDesc.trim() !== desc) {
          const items = await callApi({Type:'edit_item_description', tracking_code: code, new_description: newDesc.trim()});
          showToast('Art√≠culo editado');
          renderShoppingListItems(items);
        }
      }
      
      async function deleteShoppingItem(code) {
        if(confirm('¬øSeguro que quieres eliminar este art√≠culo?')){
            const items = await callApi({Type:'delete_item_shopping_list', tracking_code: code});
            showToast('Art√≠culo eliminado');
            renderShoppingListItems(items);
        }
      }

      function renderAddArticleForm() {
        mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn" id="back-to-shopping-list">‚Äπ</button><h2>‚ûï A√±adir Art√≠culo</h2></div><div class="form-card"><label>Descripci√≥n</label><textarea id="article-description" rows="2" required></textarea><button id="add-article-send-btn" class="enabled">A√±adir</button></div></div>`;
        document.getElementById('back-to-shopping-list').onclick = renderShoppingList;
        document.getElementById('add-article-send-btn').onclick = addArticle;
        document.getElementById('article-description').focus();
      }

      async function addArticle() {
        const desc = document.getElementById('article-description').value.trim();
        if (desc === '') { showToast('La descripci√≥n no puede estar vac√≠a.', true); return; }
        const items = await callApi({Type:'add_articulo', description: desc});
        showToast('Art√≠culo a√±adido');
        renderShoppingListItems(items);
      }
      
      function setActiveTab(activeTabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(activeTabId)?.classList.add('active');
      }

      function initializeApp() {
        showSpinner();
        chatId = tg?.initDataUnsafe?.user?.id;
        if (!chatId) {
            chatId = prompt('Ingresa tu chat_id para pruebas:', '6840956330');
        }
        if (chatId) {
            renderDashboard();
        }
        hideSpinner();
      }
      
      document.getElementById('tab-home').onclick = renderDashboard;
      
      initializeApp();
    });
  </script>
</body>
</html>
