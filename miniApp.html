<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:12px;min-width:24px;height:24px;padding:0 7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:24px;font-weight:500;}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;}
    .card-badge.red{background-color:#e74c3c;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; z-index: 10; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 12px 20px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .dropdown-item:hover { background-color: var(--bg); }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container{max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input, .form-card select, .form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input, .form-card select{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text);}
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center; flex-wrap: wrap;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1001;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .list-style-none { list-style: none; padding: 0; margin: 0; }
    .list-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .list-item-content { display: flex; flex-direction: column; flex-grow: 1; text-align: left;}
    .list-item-title { font-size: 1.1rem; font-weight: 500; }
    .list-item-subtitle { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .list-item-actions { display: flex; align-items: center; gap: 5px; position: relative; flex-shrink: 0; }
    .generic-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-data-msg { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; font-size: 1.2rem; line-height: 1.5; }
    #recurrent-hours-container { display: none; margin-top: 15px; }
    .shopping-list-header-row { display: flex; align-items: center; justify-content: flex-end; padding: 0 10px 10px 10px; color: var(--muted); font-size: 0.9rem; }
    .shopping-list-header-row input[type="checkbox"] { margin-left: 5px; }
    .shopping-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .shopping-item-checkbox-wrapper { flex-shrink: 0; }
    .shopping-item input[type="checkbox"] { width: 20px; height: 20px; }
    .shopping-item-toggle-btn { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; color: var(--list-item-text); cursor: pointer; text-align: left; }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); }
    .shopping-item-toggle-btn .item-date { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; display:block; }
    .add-article-btn-container { padding: 10px; text-align: center; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .add-article-btn, .multi-select-action-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; flex-grow: 1; max-width: 250px; }
    .multi-select-action-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .shopping-list-section-title { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 10px 10px 10px; padding-top: 10px; border-top: 1px solid #eee; text-align: left; }
    .shopping-list-section-title:first-of-type { border-top: none; margin-top: 0; }
    .note-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .note-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; }
    .note-header-interactive { flex-grow: 1; padding-right: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .note-title-section { display: flex; flex-direction: column; text-align: left; }
    .note-title { font-size: 1.1rem; font-weight: 500; }
    .note-date { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .note-description { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    .note-item.open .note-description { max-height: 500px; padding: 0 15px 15px; }
    .expand-arrow { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
    .note-item.open .expand-arrow { transform: rotate(180deg); }
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; text-align: left;}
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; display: none; }
    .list-item.open .event-description { display: block; }
    .gasto-chart-container { text-align: center; margin-top: 15px; }
    .gasto-chart-container img { max-width: 100%; border-radius: 12px; }
    .gasto-legend { list-style: none; padding: 15px 0 0 0; margin: 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .gasto-legend-item { display: flex; align-items: center; font-size: 0.9rem; }
    .gasto-legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; }
  </style>
</head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="main"></div>
  <div class="tabs"> <div class="tab active" id="tab-home">Home</div> </div>
  <div id="toast" class="toast"></div>
  
  <script>
    // Forzar la recarga para evitar caché en desarrollo
    (function() { const params = new URLSearchParams(window.location.search); if (!params.has('v')) { const newUrl = new URL(window.location.href); newUrl.searchParams.set('v', new Date().getTime()); window.location.replace(newUrl.href); } })();

    document.addEventListener('DOMContentLoaded', () => {
// ==================================================
// --- NÚCLEO JAVASCRIPT (SETUP Y FUNCIONES GLOBALES) ---
// ==================================================
const tg = window.Telegram?.WebApp;
if (tg) { tg.expand(); if (tg.themeParams) { document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa'); document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff'); document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333'); document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555'); document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3'); document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff'); } }

const webhookURL = 'https://script.google.com/macros/s/AKfycbxenwF0_F1yz0OJ7Kau7W2-HxqZqq5HIGD-GUdENpduign5J8xewfQJWBfGZpM04vHe/exec';
let chatId = tg?.initDataUnsafe?.user?.id;
if (!chatId) { chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', '6840956330'); }

let appData = { counts: {}, remindersList: [], shoppingList: [], notesList: [], calendarEvents: [] };
const mainContent = document.getElementById('main');
const spinner = document.getElementById('spinner');

function showSpinner() { spinner.style.display = 'block'; }
function hideSpinner() { spinner.style.display = 'none'; }
function showToast(msg, isError = false) { let toastTimer; clearTimeout(toastTimer); const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); }

async function fetchWithTimeout(resource, payloadObject) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), 30000);
  const formData = new FormData();
  formData.append("postData", JSON.stringify(payloadObject));
  try {
    const response = await fetch(resource, { method: 'POST', body: formData, signal: controller.signal });
    clearTimeout(id);
    if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
    return response;
  } catch (error) {
    clearTimeout(id);
    if (error.name === 'AbortError') throw new Error('La solicitud tardó demasiado.');
    throw error;
  }
}

async function initializeAppContent() { 
  showSpinner(); 
  try { 
    const res = await fetchWithTimeout(webhookURL, { Type: 'get_full_dashboard', chat_ID: chatId }); 
    const data = await res.json(); 
    if (data.error) throw new Error(data.error); 
    appData = data; 
    renderDashboard(); 
  } catch (err) { 
    console.error('Error en carga inicial:', err); 
    showToast(`Error al cargar datos: ${err.message}`, true); 
    mainContent.innerHTML = `<div class="no-data-msg">❌<br>Error al cargar la aplicación.<br><small>${err.message}</small><br><br><button onclick="initializeAppContent()">Reintentar</button></div>`; 
  } finally { 
    hideSpinner(); 
  } 
}

function setActiveTab(activeTabId) { 
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); 
  const activeTab = document.getElementById(activeTabId); 
  if (activeTab) activeTab.classList.add('active'); 
}

document.body.addEventListener('click', (e) => {
    const menuBtn = e.target.closest('.card-menu-btn, .generic-menu-btn');
    if (!menuBtn && !e.target.closest('.dropdown-menu')) { document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show')); return; }
    if (menuBtn) { e.stopPropagation(); const menuId = menuBtn.dataset.menuId; const menu = document.getElementById(menuId); if (menu) { const isShown = menu.classList.contains('show'); document.querySelectorAll('.dropdown-menu.show').forEach(m => { if (m.id !== menuId) m.classList.remove('show'); }); menu.classList.toggle('show', !isShown); } }
});

window.confirmDelete = function(type, id) {
    const itemElement = document.getElementById(`item-${id}`);
    if (!itemElement) return;
    const actionsContainer = itemElement.querySelector('.list-item-actions');
    const menuButton = actionsContainer.querySelector('.generic-menu-btn');
    const dropdown = actionsContainer.querySelector('.dropdown-menu');
    if (dropdown) dropdown.classList.remove('show');
    if (menuButton) menuButton.style.display = 'none';
    
    const confirmBtnYes = document.createElement('button');
    confirmBtnYes.className = 'confirm-btn-yes';
    confirmBtnYes.textContent = 'Sí';
    confirmBtnYes.onclick = (e) => { e.stopPropagation(); executeDelete(type, id); };

    const confirmBtnNo = document.createElement('button');
    confirmBtnNo.className = 'confirm-btn-no';
    confirmBtnNo.textContent = 'No';
    confirmBtnNo.onclick = (e) => { e.stopPropagation(); if(menuButton) menuButton.style.display = 'block'; confirmBtnYes.remove(); confirmBtnNo.remove(); };
    
    actionsContainer.appendChild(confirmBtnYes);
    actionsContainer.appendChild(confirmBtnNo);
}

async function executeDelete(type, id) {
    let payload = { chat_ID: chatId };
    let successMessage = '';
    let viewToRender = null;

    // --- 1. OPTIMISTIC UI UPDATE ---
    try {
        switch(type) {
            case 'reminder':
                payload.Type = 'delete_reminder'; payload.tracking_code = id; successMessage = 'Recordatorio eliminado';
                const reminderIndex = appData.remindersList.findIndex(r => r.tracking_code === id);
                if (reminderIndex > -1) { appData.remindersList.splice(reminderIndex, 1); appData.counts.remindersCount = Math.max(0, appData.counts.remindersCount - 1); viewToRender = renderRemindersList; }
                break;
            case 'shopping_item':
                payload.Type = 'delete_item_shopping_list'; payload.tracking_code = id; successMessage = 'Artículo eliminado';
                const itemIndex = appData.shoppingList.findIndex(i => i['3'] === id);
                if (itemIndex > -1) {
                    const item = appData.shoppingList[itemIndex];
                    if (item['2'] === 'Pendiente') { appData.counts.shoppingPendingCount = Math.max(0, appData.counts.shoppingPendingCount - 1); } 
                    else { appData.counts.shoppingBoughtCount = Math.max(0, appData.counts.shoppingBoughtCount - 1); }
                    appData.shoppingList.splice(itemIndex, 1);
                    viewToRender = renderShoppingList;
                }
                break;
            case 'note':
                payload.Type = 'delete_note'; payload.note_id = id; successMessage = 'Nota eliminada';
                const noteIndex = appData.notesList.findIndex(n => n.Nota_ID === id);
                if (noteIndex > -1) { appData.notesList.splice(noteIndex, 1); appData.counts.notesCount = Math.max(0, appData.counts.notesCount - 1); viewToRender = renderNotesList; }
                break;
            case 'calendar_event':
                payload.Type = 'delete_calendar_event'; payload.eventId = id; successMessage = 'Evento eliminado';
                const eventIndex = appData.calendarEvents.findIndex(e => e.id === id);
                if (eventIndex > -1) {
                    const event = appData.calendarEvents[eventIndex];
                    const eventDateStr = event.start.dateTime || event.start.date;
                    if (eventDateStr) {
                      const eventDate = new Date(eventDateStr).toISOString().split('T')[0];
                      if (eventDate === new Date().toISOString().split('T')[0]) { appData.counts.calendarTodayCount = Math.max(0, appData.counts.calendarTodayCount - 1); }
                    }
                    appData.calendarEvents.splice(eventIndex, 1);
                    viewToRender = () => renderCalendarView(appData.calendarEvents);
                }
                break;
            case 'gasto':
                payload.Type = 'delete_gasto_id'; payload.ID_Unico = id; successMessage = 'Gasto eliminado';
                const gastoIndex = gastosEncontrados.findIndex(g => g.ID_Unico === id);
                if (gastoIndex > -1) gastosEncontrados.splice(gastoIndex, 1);
                document.getElementById(`item-${id}`)?.remove();
                break;
            default: return;
        }
        if (viewToRender) viewToRender();
    } catch(e) { showToast('Error local al procesar.', true); return; }

    // --- 2. BACKEND REQUEST ---
    try {
        const res = await fetchWithTimeout(webhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast(successMessage);
        
        if (type === 'gasto') {
            const freshData = await (await fetchWithTimeout(webhookURL, { Type: 'get_full_dashboard', chat_ID: chatId })).json();
            if(!freshData.error) appData.counts = freshData.counts;
        } else if (type === 'calendar_event') { 
            initializeAppContent();
        }

    } catch (err) {
        showToast(`Error: ${err.message}. Restaurando...`, true);
        initializeAppContent();
    }
}

// ==================================================
// --- MÓDULO: RECORDATORIOS ---
// ==================================================
function renderReminderForm() {
  mainContent.innerHTML = `
    <div class="list-container">
      <div class="list-header"><button class="back-btn">‹</button><h2>📝 Nuevo Recordatorio</h2></div>
      <div class="form-card">
        <label>Descripción</label><textarea id="text" rows="3" required></textarea>
        <label>Fecha y hora</label><input type="text" id="time" required/>
        <label>Tipo</label>
        <div class="radio-group" id="reminder-type-group">
          <label><input type="radio" name="category" value="Un solo uso" checked/> Único</label>
          <label><input type="radio" name="category" value="Diario"/> Diario</label>
          <label><input type="radio" name="category" value="Recurrente"/> Recurrente</label>
        </div>
        <div id="recurrent-hours-container">
          <label>Repetir cada...</label>
          <select id="recurrent-hours">${[...Array(11).keys()].map(i => `<option value="${i + 2}">${i + 2} horas</option>`).join('')}</select>
        </div>
        <button id="sendBtn" disabled>Crear Recordatorio</button>
      </div>
    </div>`;
  document.querySelector('.back-btn').onclick = renderDashboard;
  const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), sendBtn = document.getElementById('sendBtn'), radios = document.querySelectorAll('input[name="category"]'), recurrentContainer = document.getElementById('recurrent-hours-container');
  flatpickr("#time", { enableTime: true, dateFormat: "Y-m-d H-i", defaultDate: new Date(), locale: "es", minDate: "today" });
  function toggleRecurrentField() { const selected = document.querySelector('input[name="category"]:checked').value; recurrentContainer.style.display = selected === 'Recurrente' ? 'block' : 'none'; }
  function validate() { const isValid = textInput.value.trim() !== '' && timeInput.value && document.querySelector('input[name="category"]:checked'); sendBtn.disabled = !isValid; sendBtn.classList.toggle('enabled', isValid); }
  textInput.oninput = validate; timeInput.oninput = validate; radios.forEach(r => r.onchange = () => { toggleRecurrentField(); validate(); });
  sendBtn.onclick = saveReminder;
  toggleRecurrentField(); validate();
}

async function saveReminder() {
  const category = document.querySelector('input[name="category"]:checked').value;
  const description = document.getElementById('text').value.trim();
  const time = document.getElementById('time')._flatpickr.selectedDates[0];
  const horas_recurrentes = category === 'Recurrente' ? document.getElementById('recurrent-hours').value : null;
  const payload = { chat_ID: chatId, Type: 'add_reminder', description, time: time.toISOString(), category, horas_recurrentes };
  
  appData.counts.remindersCount++;
  appData.remindersList.unshift({ 'Fecha': new Date().toLocaleString(), 'Descripcion': description, 'Categoria': category, 'tracking_code': 'temp' });
  renderDashboard();

  try { 
    const res = await fetchWithTimeout(webhookURL, payload); 
    const data = await res.json(); 
    if(data.error) throw new Error(data.error); 
    initializeAppContent();
  } catch (err) { 
    showToast(`Error: ${err.message}. No se guardó.`, true); 
    initializeAppContent();
  }
}

function renderRemindersList() {
  const reminders = appData.remindersList || [];
  let listHtml = (reminders.length > 0) ? reminders.map(item => `
    <li class="list-item" id="item-${item.tracking_code}">
      <div class="list-item-content">
        <span class="list-item-title">${item.Descripcion}</span>
        <span class="list-item-subtitle">${item.Categoria}: ${item.Fecha}</span>
      </div>
      <div class="list-item-actions">
        <button class="generic-menu-btn" data-menu-id="menu-item-${item.tracking_code}">⋮</button>
        <div class="dropdown-menu" id="menu-item-${item.tracking_code}">
          <a class="dropdown-item" data-action="edit-reminder" data-tracking-code="${item.tracking_code}">Editar Texto</a>
          <a class="dropdown-item" data-action="delete-reminder" data-tracking-code="${item.tracking_code}">Eliminar</a>
        </div>
      </div>
    </li>`).join('') : '<div class="no-data-msg">🎉<br>No tienes recordatorios.</div>';
  mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‹</button><h2>Recordatorios</h2></div><ul class="list-style-none" id="reminders-list">${listHtml}</ul></div>`;
  document.querySelector('.back-btn').onclick = renderDashboard;
  
  document.getElementById('reminders-list').addEventListener('click', (e) => {
    const target = e.target.closest('.dropdown-item');
    if (!target) return;
    const action = target.dataset.action;
    const trackingCode = target.dataset.trackingCode;
    if (action === 'edit-reminder') {
      const item = appData.remindersList.find(r => r.tracking_code === trackingCode);
      if (item) editReminderDescription(item);
    } else if (action === 'delete-reminder') {
      confirmDelete('reminder', trackingCode);
    }
  });
}

async function editReminderDescription(item) {
  const newDescription = prompt('Editar descripción del recordatorio:', item.Descripcion);
  if (newDescription && newDescription.trim() !== '' && newDescription.trim() !== item.Descripcion) {
    const originalDescription = item.Descripcion;
    const itemIndex = appData.remindersList.findIndex(r => r.tracking_code === item.tracking_code);
    if (itemIndex === -1) return;
    appData.remindersList[itemIndex].Descripcion = newDescription.trim();
    renderRemindersList();

    try {
      const payload = { Type: 'edit_reminder_description', chat_ID: chatId, tracking_code: item.tracking_code, new_description: newDescription.trim() };
      const res = await fetchWithTimeout(webhookURL, payload);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
    } catch (err) {
      showToast(`Error: ${err.message}. No se actualizó.`, true);
      appData.remindersList[itemIndex].Descripcion = originalDescription;
      renderRemindersList();
    }
  }
}

// ==================================================
// --- MÓDULO: COMPRAS ---
// ==================================================
function renderShoppingList() {
  const items = appData.shoppingList || [];
  const pendingItems = items.filter(item => item['2'] === 'Pendiente');
  const boughtItems = items.filter(item => item['2'] === 'Comprado');
  let listHtml = '';

  const createItemHTML = (item) => {
    const isPending = item['2'] === 'Pendiente';
    if (isPending) {
      return `
        <li class="shopping-item" id="item-${item['3']}">
            <button class="shopping-item-toggle-btn pending" data-tracking-code="${item['3']}" data-current-status="Pendiente"><span>${item['1']}</span></button>
            <div class="list-item-actions">
                <button class="generic-menu-btn" data-menu-id="menu-item-${item['3']}">⋮</button>
                <div class="dropdown-menu" id="menu-item-${item['3']}">
                    <a class="dropdown-item" data-action="edit-shopping-item" data-tracking-code="${item['3']}">Editar</a>
                    <a class="dropdown-item" data-action="delete-shopping-item" data-tracking-code="${item['3']}">Eliminar</a>
                </div>
            </div>
        </li>`;
    } else {
      return `
        <li class="shopping-item" id="item-${item['3']}">
            <div class="shopping-item-checkbox-wrapper"><input type="checkbox" class="shopping-item-checkbox" data-tracking-code="${item['3']}"></div>
            <button class="shopping-item-toggle-btn bought" data-tracking-code="${item['3']}" data-current-status="Comprado">
                <span>${item['1']}</span>
                ${item['4'] ? `<span class="item-date">${item['4']}</span>` : ''}
            </button>
            <div class="list-item-actions">
                <button class="generic-menu-btn" data-menu-id="menu-item-${item['3']}">⋮</button>
                <div class="dropdown-menu" id="menu-item-${item['3']}">
                    <a class="dropdown-item" data-action="edit-shopping-item" data-tracking-code="${item['3']}">Editar</a>
                    <a class="dropdown-item" data-action="delete-shopping-item" data-tracking-code="${item['3']}">Eliminar</a>
                </div>
            </div>
        </li>`;
    }
  };

  if (pendingItems.length > 0) { listHtml += '<h3 class="shopping-list-section-title">Artículos Pendientes</h3>'; listHtml += pendingItems.map(createItemHTML).join(''); }
  if (boughtItems.length > 0) { listHtml += '<h3 class="shopping-list-section-title">Artículos Comprados</h3>'; listHtml += `<div class="shopping-list-header-row"><label for="select-all-checkbox">Seleccionar Todos</label><input type="checkbox" id="select-all-checkbox"></div>`; listHtml += boughtItems.map(createItemHTML).join(''); }
  if (items.length === 0) { listHtml = '<div class="no-data-msg">🛒<br>Tu lista está vacía.</div>'; }
  mainContent.innerHTML = `
      <div class="list-container">
          <div class="list-header"><button class="back-btn">‹</button><h2>Lista de las Compras</h2></div>
          <ul class="list-style-none" id="shopping-list-ul">${listHtml}</ul>
          <div class="add-article-btn-container">
              <button class="add-article-btn" id="add-shopping-item-btn">Añadir Artículo</button>
              <button class="multi-select-action-btn" id="multi-select-toggle-btn" disabled>Marcar para comprar</button>
          </div>
      </div>`;
  document.querySelector('.back-btn').onclick = renderDashboard;
  document.getElementById('shopping-list-ul').addEventListener('click', handleShoppingItemInteractions);
  document.getElementById('add-shopping-item-btn').onclick = renderAddArticleForm;
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  if (selectAllCheckbox) { selectAllCheckbox.onchange = (e) => { document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.checked = e.target.checked; }); updateMultiSelectButtonState(); }; }
  document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.onchange = updateMultiSelectButtonState; });
  document.getElementById('multi-select-toggle-btn').onclick = toggleSelectedItemsToPending;
  updateMultiSelectButtonState();
}

function handleShoppingItemInteractions(event) {
  const toggleButton = event.target.closest('.shopping-item-toggle-btn');
  if (toggleButton) {
      const trackingCode = toggleButton.dataset.trackingCode;
      const newStatus = toggleButton.dataset.currentStatus === 'Pendiente' ? 'Comprado' : 'Pendiente';
      optimisticToggleShoppingItemStatus(trackingCode, newStatus);
      return;
  }
  const menuItem = event.target.closest('.dropdown-item');
  if(menuItem) {
    const action = menuItem.dataset.action;
    const trackingCode = menuItem.dataset.trackingCode;
    if (action === 'edit-shopping-item') {
      const item = appData.shoppingList.find(i => i['3'] === trackingCode);
      if(item) renderEditShoppingItemForm(item);
    } else if (action === 'delete-shopping-item') {
      confirmDelete('shopping_item', trackingCode);
    }
  }
}

function optimisticToggleShoppingItemStatus(trackingCode, newStatus) {
  const itemIndex = appData.shoppingList.findIndex(item => item['3'] === trackingCode);
  if (itemIndex === -1) return;
  appData.shoppingList[itemIndex]['2'] = newStatus;
  if (newStatus === 'Comprado') { appData.shoppingList[itemIndex]['4'] = new Date().toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }); appData.counts.shoppingPendingCount--; appData.counts.shoppingBoughtCount++; } else { appData.shoppingList[itemIndex]['4'] = ''; appData.counts.shoppingPendingCount++; appData.counts.shoppingBoughtCount--; }
  renderShoppingList();
  fetchWithTimeout(webhookURL, { Type: 'toggle_item_status', chat_ID: chatId, tracking_code: trackingCode, new_status: newStatus })
      .then(res => res.json()).then(data => { if (data.error) throw new Error(data.error); })
      .catch(err => { showToast(`Error: ${err.message}. No se sincronizó.`, true); initializeAppContent(); });
}

function updateMultiSelectButtonState() {
  const multiSelectToggleButton = document.getElementById('multi-select-toggle-btn');
  if (!multiSelectToggleButton) return;
  const selectedCount = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).length;
  multiSelectToggleButton.disabled = selectedCount === 0;
  multiSelectToggleButton.textContent = selectedCount > 0 ? `Marcar ${selectedCount} para comprar` : 'Marcar para comprar';
}

function toggleSelectedItemsToPending() {
  const trackingCodes = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.trackingCode);
  if (trackingCodes.length === 0) return;
  trackingCodes.forEach(code => { const itemIndex = appData.shoppingList.findIndex(item => item['3'] === code); if (itemIndex !== -1) { appData.shoppingList[itemIndex]['2'] = 'Pendiente'; appData.shoppingList[itemIndex]['4'] = ''; } });
  appData.counts.shoppingPendingCount += trackingCodes.length;
  appData.counts.shoppingBoughtCount -= trackingCodes.length;
  renderShoppingList();
  fetchWithTimeout(webhookURL, { Type: 'toggle_multiple_to_pending', chat_ID: chatId, tracking_codes: trackingCodes })
    .then(res => res.json()).then(data => { if (data.error) throw new Error(data.error); })
    .catch(err => { showToast(`Error: ${err.message}. No se sincronizó.`, true); initializeAppContent(); });
}

function renderAddArticleForm() {
  mainContent.innerHTML = `
      <div class="list-container">
          <div class="list-header"><button class="back-btn">‹</button><h2>➕ Añadir Artículo</h2></div>
          <div class="form-card">
              <label>Descripción del artículo</label> <textarea id="article-description" rows="2" required></textarea>
              <label>¿Cada cuántos días lo compras? (0 si es ocasional)</label> <input type="number" id="article-cycle" value="0" min="0" step="1" required />
              <button id="add-article-send-btn" disabled>Añadir</button>
          </div>
      </div>`;
  document.querySelector('.back-btn').onclick = renderShoppingList;
  const sendBtn = document.getElementById('add-article-send-btn');
  const descriptionInput = document.getElementById('article-description');
  descriptionInput.oninput = () => { const isEnabled = descriptionInput.value.trim() !== ''; sendBtn.disabled = !isEnabled; sendBtn.classList.toggle('enabled', isEnabled); };
  sendBtn.onclick = addArticle;
}

async function addArticle() {
  const description = document.getElementById('article-description').value.trim();
  const cycle = document.getElementById('article-cycle').value || 0;
  if (!description) return;
  const payload = { Type: 'add_articulo', chat_ID: chatId, description: description, cycle: parseInt(cycle) };
  
  appData.counts.shoppingPendingCount++;
  renderShoppingList();
  showToast('Artículo añadido');

  try {
      const res = await fetchWithTimeout(webhookURL, payload);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      const freshData = await (await fetchWithTimeout(webhookURL, { Type: 'get_full_dashboard', chat_ID: chatId })).json();
      if(freshData.error) throw new Error(freshData.error);
      appData = freshData;
      renderShoppingList();
  } catch (err) { showToast(`Error: ${err.message}. No se añadió.`, true); initializeAppContent(); }
}

function renderEditShoppingItemForm(item) {
    mainContent.innerHTML = `
      <div class="list-container">
          <div class="list-header"><button class="back-btn">‹</button><h2>✏️ Editar Artículo</h2></div>
          <div class="form-card">
              <label>Descripción del artículo</label> <textarea id="article-description" rows="2" required>${item['1']}</textarea>
              <label>¿Cada cuántos días lo compras? (0 si es ocasional)</label> <input type="number" id="article-cycle" value="${item['5'] || 0}" min="0" step="1" required />
              <button id="edit-article-send-btn" class="enabled">Guardar Cambios</button>
          </div>
      </div>`;
    document.querySelector('.back-btn').onclick = renderShoppingList;
    document.getElementById('edit-article-send-btn').onclick = () => saveEditedShoppingItem(item['3']);
}

async function saveEditedShoppingItem(trackingCode) {
    const newDescription = document.getElementById('article-description').value.trim();
    const newCycle = document.getElementById('article-cycle').value || 0;
    if (!newDescription) return;

    const itemIndex = appData.shoppingList.findIndex(i => i['3'] === trackingCode);
    if (itemIndex === -1) return;
    const originalItem = { ...appData.shoppingList[itemIndex] };
    appData.shoppingList[itemIndex]['1'] = newDescription;
    appData.shoppingList[itemIndex]['5'] = newCycle;
    renderShoppingList();

    const payload = { Type: 'edit_shopping_item', chat_ID: chatId, tracking_code: trackingCode, new_description: newDescription, new_cycle: parseInt(newCycle) };
    
    try {
        const res = await fetchWithTimeout(webhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
    } catch (err) {
        showToast(`Error: ${err.message}. No se guardó.`, true);
        appData.shoppingList[itemIndex] = originalItem;
        renderShoppingList();
    }
}

// ==================================================
// --- MÓDULO: NOTAS ---
// ==================================================
function renderNotesList() {
    const notes = appData.notesList || [];
    let listHtml = (notes.length > 0) ? notes.map(note => `
            <li class="note-item" id="item-${note.Nota_ID}">
                <div class="note-header">
                    <div class="note-header-interactive">
                        <div class="note-title-section">
                            <span class="note-title">${note.Titulo}</span>
                            <span class="note-date">${note.Fecha}</span>
                        </div>
                        <span class="expand-arrow">▾</span>
                    </div>
                    <div class="list-item-actions">
                        <button class="generic-menu-btn" data-menu-id="menu-item-${note.Nota_ID}">⋮</button>
                        <div class="dropdown-menu" id="menu-item-${note.Nota_ID}">
                            <a class="dropdown-item" data-action="edit-note" data-note-id="${note.Nota_ID}">Editar</a>
                            <a class="dropdown-item" data-action="delete-note" data-note-id="${note.Nota_ID}">Eliminar</a>
                        </div>
                    </div>
                </div>
                <div class="note-description">${note.Descripcion}</div>
            </li>`).join('') : '<div class="no-data-msg">📝<br>No tienes notas guardadas.</div>';
    
    mainContent.innerHTML = `<div class="list-container">
                                <div class="list-header"><button class="back-btn">‹</button><h2>Mis Notas</h2></div>
                                <div class="add-article-btn-container"><button class="add-article-btn" id="create-new-note-btn">Crear Nueva Nota</button></div>
                                <ul class="list-style-none" id="notes-list">${listHtml}</ul>
                             </div>`;

    document.querySelector('.back-btn').onclick = renderDashboard;
    document.getElementById('create-new-note-btn').onclick = () => renderNoteForm();
    
    const notesList = document.getElementById('notes-list');
    notesList.addEventListener('click', e => {
        const interactiveHeader = e.target.closest('.note-header-interactive');
        if (interactiveHeader) {
            interactiveHeader.closest('.note-item').classList.toggle('open');
            return;
        }
        
        const target = e.target.closest('.dropdown-item');
        if (!target) return;

        const action = target.dataset.action;
        const noteId = target.dataset.noteId;
        if (action === 'edit-note') {
            const note = appData.notesList.find(n => n.Nota_ID === noteId);
            if (note) renderNoteForm(note);
        } else if (action === 'delete-note') {
            confirmDelete('note', noteId);
        }
    });
}

function renderNoteForm(note = null) {
    const isEditing = note !== null;
    mainContent.innerHTML = `<div class="list-container">
                                <div class="list-header"><button class="back-btn">‹</button><h2>${isEditing ? '✏️ Editar Nota' : '➕ Nueva Nota'}</h2></div>
                                <div class="form-card">
                                    <label>Título</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}" required />
                                    <label>Descripción</label><textarea id="note-description" rows="8" required>${isEditing ? note.Descripcion : ''}</textarea>
                                    <button id="save-note-btn" data-note-id="${isEditing ? note.Nota_ID : ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button>
                                </div>
                             </div>`;

    document.querySelector('.back-btn').onclick = renderNotesList;
    const titleInput = document.getElementById('note-title');
    const descriptionInput = document.getElementById('note-description');
    const saveBtn = document.getElementById('save-note-btn');

    function validate() {
        const isEnabled = titleInput.value.trim() !== '' && descriptionInput.value.trim() !== '';
        saveBtn.disabled = !isEnabled;
        saveBtn.classList.toggle('enabled', isEnabled);
    }

    titleInput.oninput = validate;
    descriptionInput.oninput = validate;
    saveBtn.onclick = saveNote;
    validate();
}

async function saveNote() {
    const saveBtn = document.getElementById('save-note-btn');
    const title = document.getElementById('note-title').value.trim();
    const description = document.getElementById('note-description').value.trim();
    const noteId = saveBtn.dataset.noteId;
    const isEditing = !!noteId;

    const payload = { chat_ID: chatId, Type: isEditing ? 'edit_note' : 'add_note', note_id: noteId, title: title, description: description };
    
    if (isEditing) {
        const itemIndex = appData.notesList.findIndex(n => n.Nota_ID === noteId);
        if (itemIndex === -1) return;
        const originalNote = { ...appData.notesList[itemIndex] };
        appData.notesList[itemIndex].Titulo = title;
        appData.notesList[itemIndex].Descripcion = description;
        renderNotesList();
        showToast('Nota guardada');

        try {
            const res = await fetchWithTimeout(webhookURL, payload);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
        } catch (err) {
            showToast(`Error: ${err.message}. No se pudo guardar.`, true);
            appData.notesList[itemIndex] = originalNote; // Revertir
            renderNotesList();
        }
    } else {
        appData.counts.notesCount++;
        appData.notesList.unshift({ Nota_ID: 'temp-' + Date.now(), Titulo: title, Descripcion: description, Fecha: new Date().toLocaleDateString('es-ES') });
        renderNotesList();
        showToast('Nota creada');

        try {
            const res = await fetchWithTimeout(webhookURL, payload);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            const freshData = await (await fetchWithTimeout(webhookURL, { Type: 'get_full_dashboard', chat_ID: chatId })).json();
            if(freshData.error) throw new Error(freshData.error);
            appData = freshData;
            renderNotesList();
        } catch (err) {
            showToast(`Error: ${err.message}. No se pudo crear la nota.`, true);
            initializeAppContent();
        }
    }
}


// ==================================================
// --- MÓDULO: CALENDARIO ---
// ==================================================
async function renderCalendarView(eventsToShow = null) {
    showSpinner();
    try {
        let events = eventsToShow;
        if (!events) {
            const startDate = new Date(); const endDate = new Date(); endDate.setDate(startDate.getDate() + 30);
            const res = await fetchWithTimeout(webhookURL, { Type: 'get_calendar_events', chat_ID: chatId, startDate: startDate.toISOString(), endDate: endDate.toISOString() });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            events = data;
            appData.calendarEvents = events;
        }

        const groupAndRenderEvents = (evs) => {
            if (!evs || evs.length === 0) return '<div class="no-data-msg">🗓️<br>No se encontraron eventos.</div>';
            const eventsByDay = evs.reduce((acc, event) => { 
                const dateKey = event.start.dateTime || event.start.date;
                if (!dateKey) return acc;
                const day = new Date(dateKey).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); 
                if (!acc[day]) acc[day] = []; 
                acc[day].push(event); 
                return acc; 
            }, {});
            let html = '';
            for (const day in eventsByDay) {
                html += `<h3 class="day-header">${day}</h3>`;
                html += Object.values(eventsByDay[day]).map(event => {
                    const isAllDay = !event.start.dateTime;
                    const startTime = isAllDay ? 'Todo el día' : new Date(event.start.dateTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    const endTime = isAllDay ? '' : ' - ' + new Date(event.end.dateTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    return `<li class="list-item" id="item-${event.id}">
                              <div class="list-item-content" onclick="this.parentElement.classList.toggle('open')">
                                <span class="list-item-title">${event.summary}</span>
                                <span class="list-item-subtitle">${startTime}${endTime}</span>
                                <div class="event-description">${event.description || ''}</div>
                              </div>
                              <div class="list-item-actions">
                                <button class="generic-menu-btn" data-menu-id="menu-item-${event.id}">⋮</button>
                                <div class="dropdown-menu" id="menu-item-${event.id}">
                                  <a class="dropdown-item" data-action="delete-calendar-event" data-event-id="${event.id}">Eliminar</a>
                                  ${event.htmlLink ? `<a class="dropdown-item" href="${event.htmlLink}" target="_blank">Ver en Google</a>` : ''}
                                </div>
                              </div>
                            </li>`;
                }).join('');
            }
            return html;
        };
        let listHtml = groupAndRenderEvents(events);
        mainContent.innerHTML = `<div class="list-container">
                                  <div class="list-header"><button class="back-btn">‹</button><h2>Calendario</h2></div>
                                  <div class="add-article-btn-container">
                                    <button class="add-article-btn" id="add-event-btn">Añadir Evento</button>
                                    <button class="add-article-btn" id="search-event-btn">Buscar</button>
                                  </div>
                                  <ul class="list-style-none" id="calendar-list">${listHtml}</ul>
                                </div>`;
        document.querySelector('.back-btn').onclick = renderDashboard;
        document.getElementById('add-event-btn').onclick = renderEventForm;
        document.getElementById('search-event-btn').onclick = renderSearchCalendarForm;
        
        document.getElementById('calendar-list').addEventListener('click', (e) => {
            const target = e.target.closest('.dropdown-item');
            if (!target || target.href) return;
            const action = target.dataset.action;
            const eventId = target.dataset.eventId;
            if (action === 'delete-calendar-event') {
                confirmDelete('calendar_event', eventId);
            }
        });
    } catch (err) { mainContent.innerHTML = `<div class="no-data-msg">❌<br>Error al cargar el calendario.<br><small>${err.message}</small></div>`; } finally { hideSpinner(); }
}

function renderEventForm() {
    mainContent.innerHTML = `
      <div class="list-container"><div class="list-header"><button class="back-btn">‹</button><h2>➕ Nuevo Evento</h2></div>
      <div class="form-card">
          <label>Título</label><input type="text" id="event-summary" required />
          <label><input type="checkbox" id="event-all-day" style="width:auto;margin-right:8px;"> Todo el día</label>
          <label>Inicio</label><input type="text" id="event-start" readonly="readonly">
          <label>Fin</label><input type="text" id="event-end" readonly="readonly">
          <label>Notificación</label>
          <div style="display: flex; gap: 10px;">
            <select id="event-reminder-method" style="flex: 1;"><option value="popup">Notificación</option><option value="email">Email</option></select>
            <input type="number" id="event-reminder-minutes" placeholder="Minutos antes" style="flex: 1;" min="0" />
          </div>
          <label>Descripción</label><textarea id="event-description" rows="4"></textarea>
          <button id="save-event-btn" disabled>Crear Evento</button>
      </div></div>`;
    document.querySelector('.back-btn').onclick = () => renderCalendarView();
    
    let startPicker, endPicker;
    const fpConfig = { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true, locale: "es" };
    startPicker = flatpickr("#event-start", { ...fpConfig, defaultDate: new Date(), onChange: function(selectedDates) { if (selectedDates[0] && !document.getElementById('event-all-day').checked) { endPicker.setDate(new Date(selectedDates[0].getTime() + 3600000)); } } });
    endPicker = flatpickr("#event-end", { ...fpConfig, defaultDate: new Date(Date.now() + 3600000) });
    document.getElementById('event-all-day').addEventListener('change', (e) => { const isAllDay = e.target.checked; const newConfig = { enableTime: !isAllDay, dateFormat: isAllDay ? "Y-m-d" : "Y-m-d H:i" }; startPicker.set(newConfig); endPicker.set(newConfig); if (isAllDay) { endPicker.setDate(startPicker.selectedDates[0] || new Date()); } });
    const summaryInput = document.getElementById('event-summary'), saveBtn = document.getElementById('save-event-btn');
    function validate() { saveBtn.disabled = summaryInput.value.trim() === ''; saveBtn.classList.toggle('enabled', !saveBtn.disabled); }
    summaryInput.oninput = validate;
    saveBtn.onclick = saveEvent;
    validate();
}

async function saveEvent() {
    const eventData = {
        summary: document.getElementById('event-summary').value.trim(),
        start: document.getElementById('event-start')._flatpickr.selectedDates[0].toISOString(),
        end: document.getElementById('event-end')._flatpickr.selectedDates[0].toISOString(),
        description: document.getElementById('event-description').value,
        isAllDay: document.getElementById('event-all-day').checked,
        reminderMethod: document.getElementById('event-reminder-method').value,
        reminderMinutes: document.getElementById('event-reminder-minutes').value || 0
    };
    
    if (new Date(eventData.start).toISOString().split('T')[0] === new Date().toISOString().split('T')[0]) { appData.counts.calendarTodayCount++; }
    renderDashboard();

    try {
        const res = await fetchWithTimeout(webhookURL, { chat_ID: chatId, Type: 'add_calendar_event', eventData });
        const result = await res.json();
        if (result.error) throw new Error(result.error);
        initializeAppContent();
    } catch (err) {
        showToast(`Error: ${err.message}. No se guardó.`, true);
        initializeAppContent();
    }
}

function renderSearchCalendarForm() {
    mainContent.innerHTML = `
        <div class="list-container"><div class="list-header"><button class="back-btn">‹</button><h2>🔎 Buscar en Calendario</h2></div>
        <div class="form-card">
            <label>Término de búsqueda</label>
            <input type="text" id="calendar-search-query" placeholder="Ej: Reunión, Dentista..." required />
            <button id="search-calendar-btn" class="enabled">Buscar</button>
        </div>
        </div>`;
    document.querySelector('.back-btn').onclick = () => renderCalendarView();
    document.getElementById('search-calendar-btn').onclick = executeSearchCalendar;
}

async function executeSearchCalendar() {
    const query = document.getElementById('calendar-search-query').value.trim();
    if (!query) { showToast('Introduce un término para buscar.', true); return; }
    showSpinner();
    try {
        const res = await fetchWithTimeout(webhookURL, { Type: 'search_calendar_events', chat_ID: chatId, query: query });
        const events = await res.json();
        if (events.error) throw new Error(events.error);
        renderCalendarView(events);
    } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
}

// ==================================================
// --- MÓDULO: GASTOS ---
// ==================================================
let gastosEncontrados = [];

function renderGastoChart() {
  const mesesOptions = (appData.counts.mesesActivosGastos || []).map(mes => `<option value="${mes}">${mes}</option>`).join('');
  mainContent.innerHTML = `
    <div class="list-container">
      <div class="list-header"><button class="back-btn">‹</button><h2>Análisis de Gastos</h2></div>
      <div class="form-card">
        <label>Detalle por Mes</label>
        <select id="gasto-chart-mes-select"><option value="">Selecciona un mes...</option>${mesesOptions}</select>
        <div class="gasto-chart-container" id="chart-container-pie"></div>
        <ul class="gasto-legend" id="gasto-legend-container"></ul>
        <hr style="margin: 25px 0; border-top: 1px solid #eee;">
        <div class="gasto-chart-container" id="chart-container-daily"></div>
        <hr style="margin: 25px 0; border-top: 1px solid #eee;">
        <div class="gasto-chart-container" id="chart-container-monthly"></div>
      </div>
    </div>`;
  document.querySelector('.back-btn').onclick = renderDashboard;
  document.getElementById('gasto-chart-mes-select').onchange = fetchAndDisplayGastoChart;
  fetchAndDisplayGastoChart({ target: { value: '' } }); 
}

async function fetchAndDisplayGastoChart(event) {
  const mesAnio = event.target.value;
  showSpinner();
  const pieContainer = document.getElementById('chart-container-pie'), dailyContainer = document.getElementById('chart-container-daily'), monthlyContainer = document.getElementById('chart-container-monthly'), legendContainer = document.getElementById('gasto-legend-container');
  if (mesAnio) { pieContainer.innerHTML = ''; dailyContainer.innerHTML = ''; legendContainer.innerHTML = ''; }
  try {
    const payload = { Type: 'get_gastos_chart', chat_ID: chatId, mes_anio: mesAnio };
    const res = await fetchWithTimeout(webhookURL, payload); const data = await res.json(); if (data.error) throw new Error(data.error);
    if(data.pieChartUrl && mesAnio) { const imgPie = document.createElement('img'); imgPie.src = data.pieChartUrl; pieContainer.appendChild(imgPie); }
    if(data.dailyLineChartUrl && mesAnio) { const imgDaily = document.createElement('img'); imgDaily.src = data.dailyLineChartUrl; dailyContainer.appendChild(imgDaily); }
    if(data.monthlyBarChartUrl) { monthlyContainer.innerHTML = ''; const imgMonthly = document.createElement('img'); imgMonthly.src = data.monthlyBarChartUrl; monthlyContainer.appendChild(imgMonthly); }
    if(data.datosParaLeyenda && data.datosParaLeyenda.length > 0 && mesAnio) { legendContainer.innerHTML = data.datosParaLeyenda.map(item => `<li class="gasto-legend-item"><span class="gasto-legend-color" style="background-color:${item.color};"></span>${item.categoria}: <strong>${item.importe}</strong></li>`).join(''); }
  } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
}

function renderAddGastoForm() {
    mainContent.innerHTML = `
        <div class="list-container">
            <div class="list-header"><button class="back-btn">‹</button><h2>💰 Nuevo Gasto</h2></div>
            <div class="form-card">
                <label>Importe</label> <input type="number" id="gasto-importe" placeholder="Ej: 15.50" step="0.01" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" placeholder="Ej: Supermercado" required />
                <label>Categoría</label> <input type="text" id="gasto-categoria" placeholder="Ej: Alimentación" required />
                <label>Fecha</label> <input type="text" id="gasto-fecha" required />
                <button id="save-gasto-btn" disabled>Registrar Gasto</button>
            </div>
        </div>`;
    document.querySelector('.back-btn').onclick = renderDashboard;
    flatpickr("#gasto-fecha", { defaultDate: new Date(), dateFormat: "Y-m-d", locale: "es" });
    const saveBtn = document.getElementById('save-gasto-btn');
    const inputs = ['gasto-importe', 'gasto-establecimiento', 'gasto-categoria', 'gasto-fecha'];
    function validateGastoForm() { const allValid = inputs.every(i => document.getElementById(i).value.trim() !== ''); saveBtn.disabled = !allValid; saveBtn.classList.toggle('enabled', !allValid); }
    inputs.forEach(id => document.getElementById(id).oninput = validateGastoForm);
    saveBtn.onclick = saveGasto;
    validateGastoForm();
}

async function saveGasto() {
    const payload = {
        Type: 'add_gasto', chat_ID: chatId,
        datos: { 
            Importe: document.getElementById('gasto-importe').value, 
            Establecimiento: document.getElementById('gasto-establecimiento').value, 
            categoria: document.getElementById('gasto-categoria').value, 
            Fecha: document.getElementById('gasto-fecha')._flatpickr.selectedDates[0].toISOString(),
            ID_Unico: `G-${Math.random().toString(36).substring(2, 8).toUpperCase()}`
        }
    };
    renderDashboard();
    try {
        const res = await fetchWithTimeout(webhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast('Gasto añadido con éxito');
        initializeAppContent();
    } catch (err) { showToast(`Error: ${err.message}. No se guardó.`, true); initializeAppContent(); }
}

function renderSearchGastosForm() {
    mainContent.innerHTML = `
        <div class="list-container">
            <div class="list-header"><button class="back-btn">‹</button><h2>🔎 Buscar Gastos</h2></div>
            <div class="form-card">
                <label>Fecha de Inicio</label> <input type="text" id="gasto-fecha-inicio" required />
                <label>Fecha de Fin</label> <input type="text" id="gasto-fecha-fin" required />
                <button id="search-gasto-btn" class="enabled">Buscar</button>
            </div>
            <div id="gastos-search-results" style="margin-top: 20px;"></div>
        </div>`;
    document.querySelector('.back-btn').onclick = renderDashboard;
    const fpConfig = { dateFormat: "d/m/Y", locale: "es" };
    flatpickr("#gasto-fecha-inicio", { ...fpConfig, defaultDate: new Date(new Date().setDate(1)) });
    flatpickr("#gasto-fecha-fin", { ...fpConfig, defaultDate: new Date() });
    document.getElementById('search-gasto-btn').onclick = executeSearchGastos;
    document.getElementById('gastos-search-results').addEventListener('click', (e) => {
        const target = e.target.closest('.dropdown-item');
        if (!target) return;
        const action = target.dataset.action;
        const idUnico = target.dataset.idUnico;
        if (action === 'edit-gasto') {
            const gasto = gastosEncontrados.find(g => g.ID_Unico === idUnico);
            if (gasto) renderEditGastoForm(gasto);
        } else if (action === 'delete-gasto') {
            confirmDelete('gasto', idUnico);
        }
    });
}

async function executeSearchGastos() {
    const startDate = document.getElementById('gasto-fecha-inicio').value, endDate = document.getElementById('gasto-fecha-fin').value;
    if (!startDate || !endDate) { showToast('Debes seleccionar ambas fechas.', true); return; }
    const payload = { Type: 'get_gastos_fecha', chat_ID: chatId, datos: { fecha_start: startDate, fecha_end: endDate } };
    showSpinner();
    const resultsContainer = document.getElementById('gastos-search-results');
    try {
        const res = await fetchWithTimeout(webhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        gastosEncontrados = data.gastos || [];
        if (gastosEncontrados.length > 0) {
            let listHtml = gastosEncontrados.map(gasto => `
                <li class="list-item" id="item-${gasto.ID_Unico}">
                    <div class="list-item-content">
                        <span class="list-item-title">${gasto.Establecimiento} - ${gasto.Importe.toLocaleString('es-ES', {minimumFractionDigits: 2})}</span>
                        <span class="list-item-subtitle">${gasto.Categoria} - ${new Date(gasto.Fecha).toLocaleDateString('es-ES')}</span>
                    </div>
                    <div class="list-item-actions">
                        <button class="generic-menu-btn" data-menu-id="menu-item-${gasto.ID_Unico}">⋮</button>
                        <div class="dropdown-menu" id="menu-item-${gasto.ID_Unico}">
                            <a class="dropdown-item" data-action="edit-gasto" data-id-unico="${gasto.ID_Unico}">Editar</a>
                            <a class="dropdown-item" data-action="delete-gasto" data-id-unico="${gasto.ID_Unico}">Eliminar</a>
                        </div>
                    </div>
                </li>`).join('');
            resultsContainer.innerHTML = `<ul class="list-style-none">${listHtml}</ul>`;
        } else {
            resultsContainer.innerHTML = `<div class="no-data-msg" style="padding: 20px;">No se encontraron gastos.</div>`;
        }
    } catch (err) { showToast(err.message, true); resultsContainer.innerHTML = ''; } finally { hideSpinner(); }
}

function renderEditGastoForm(gasto) {
    mainContent.innerHTML = `
        <div class="list-container">
            <div class="list-header"><button class="back-btn">‹</button><h2>✏️ Editar Gasto</h2></div>
            <div class="form-card">
                <label>Importe</label> <input type="number" id="gasto-importe" value="${gasto.Importe}" step="0.01" required />
                <label>Establecimiento</label> <input type="text" id="gasto-establecimiento" value="${gasto.Establecimiento}" required />
                <label>Categoría</label> <input type="text" id="gasto-categoria" value="${gasto.Categoria}" required />
                <label>Fecha</label> <input type="text" id="gasto-fecha" required />
                <button id="save-gasto-btn" class="enabled">Guardar Cambios</button>
            </div>
        </div>`;
    document.querySelector('.back-btn').onclick = executeSearchGastos;
    flatpickr("#gasto-fecha", { defaultDate: gasto.Fecha, dateFormat: "Y-m-d", locale: "es" });
    document.getElementById('save-gasto-btn').onclick = () => saveEditedGasto(gasto.ID_Unico);
}

async function saveEditedGasto(idUnico) {
    const payload = {
        Type: 'edit_gasto', chat_ID: chatId,
        datos: { ID_Unico: idUnico, Importe: document.getElementById('gasto-importe').value, Establecimiento: document.getElementById('gasto-establecimiento').value, categoria: document.getElementById('gasto-categoria').value, Fecha: document.getElementById('gasto-fecha')._flatpickr.selectedDates[0].toISOString() }
    };
    
    try {
        const res = await fetchWithTimeout(webhookURL, payload);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showToast('Gasto actualizado');
        renderDashboard();
    } catch (err) { 
        showToast(`Error: ${err.message}. No se guardó.`, true); 
    }
}

// ==================================================
// --- CONECTOR E INICIO DE LA APP ---
// ==================================================
function renderDashboard() {
  setActiveTab('tab-home');
  const counts = appData.counts;
  mainContent.innerHTML = `
    <div class="grid">
      <div class="card"><div class="card-badge red" style="left:12px;">${counts.remindersCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-recordatorios">⋮</button><div class="card-icon">🗓️</div><div class="card-title">Recordatorios</div><div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">Añadir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div></div>
      <div class="card"><div class="card-badge-group"><div class="card-badge green">${counts.shoppingPendingCount || 0}</div><div class="card-badge red">${counts.shoppingBoughtCount || 0}</div></div><button class="card-menu-btn" data-menu-id="menu-shopping-list">⋮</button><div class="card-icon">🛒</div><div class="card-title">Compras</div><div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">Añadir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div></div>
      <div class="card"><div class="card-badge red" style="left:12px;">${counts.notesCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-notes">⋮</button><div class="card-icon">📝</div><div class="card-title">Notas</div><div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">Añadir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div></div>
      <div class="card"><div class="card-badge red" style="left:12px;">${counts.calendarTodayCount || 0}</div><button class="card-menu-btn" data-menu-id="menu-calendar">⋮</button><div class="card-icon">🗓️</div><div class="card-title">Calendario</div><div class="dropdown-menu" id="menu-calendar"><a class="dropdown-item" id="add-event-link">Añadir Evento</a><a class="dropdown-item" id="view-calendar-link">Ver Calendario</a></div></div>
      <div class="card"><div class="card-badge red" style="left:12px;">${(counts.gastosMesActual || '0,00').split(',')[0]}</div><button class="card-menu-btn" data-menu-id="menu-gastos">⋮</button><div class="card-icon">💰</div><div class="card-title">Gastos</div><div class="dropdown-menu" id="menu-gastos"><a class="dropdown-item" id="add-gasto-link">Añadir</a><a class="dropdown-item" id="list-gastos-link">Buscar</a><a class="dropdown-item" id="view-gasto-chart-link">Ver Gráfico</a></div></div>
    </div>`;
  
  document.getElementById('add-reminder-link').onclick = renderReminderForm;
  document.getElementById('list-reminders-link').onclick = renderRemindersList;
  document.getElementById('view-shopping-list-link').onclick = renderShoppingList;
  document.getElementById('add-shopping-item-link').onclick = renderAddArticleForm;
  document.getElementById('add-note-link').onclick = () => renderNoteForm();
  document.getElementById('list-notes-link').onclick = renderNotesList;
  document.getElementById('add-event-link').onclick = renderEventForm;
  document.getElementById('view-calendar-link').onclick = () => renderCalendarView();
  document.getElementById('add-gasto-link').onclick = renderAddGastoForm;
  document.getElementById('list-gastos-link').onclick = renderSearchGastosForm;
  document.getElementById('view-gasto-chart-link').onclick = renderGastoChart;
  document.getElementById('tab-home').onclick = renderDashboard;
}

initializeAppContent();
    });
  </script>
</body>
</html>
