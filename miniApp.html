<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; --edit-icon-color: #007bff; --checkbox-border: #ddd; --checkbox-checked-bg: var(--primary); }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:12px;min-width:24px;height:24px;padding:0 7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:24px;font-weight:500;}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;}
    .card-badge.red{background-color:#e74c3c;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; z-index: 10; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 12px 20px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .dropdown-item:hover { background-color: var(--bg); }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container{max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card h2{margin-bottom:16px;font-size:1.4rem;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input, .form-card select, .form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input, .form-card select{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text);}
    .form-card input.flatpickr-input { background-color: #fff !important; }
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center; flex-wrap: wrap;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1001;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .list-style-none { list-style: none; padding: 0; margin: 0; }
    .list-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .list-item-content { display: flex; flex-direction: column; flex-grow: 1; text-align: left;}
    .list-item-title { font-size: 1.1rem; font-weight: 500; }
    .list-item-subtitle { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .list-item-actions { display: flex; align-items: center; gap: 5px; position: relative; }
    .generic-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-data-msg { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; font-size: 1.2rem; line-height: 1.5; }
    #recurrent-hours-container { display: none; margin-top: 15px; }
    .gasto-chart-container { text-align: center; margin-top: 15px; }
    .gasto-chart-container img { max-width: 100%; border-radius: 12px; }
    .gasto-legend { list-style: none; padding: 15px 0 0 0; margin: 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .gasto-legend-item { display: flex; align-items: center; font-size: 0.9rem; }
    .gasto-legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; }
    .note-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .note-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; }
    .note-header-interactive { flex-grow: 1; padding-right: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .note-title-section { display: flex; flex-direction: column; text-align: left; }
    .note-title { font-size: 1.1rem; font-weight: 500; }
    .note-date { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .note-description { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    .note-item.open .note-description { max-height: 500px; padding: 0 15px 15px; }
    .expand-arrow { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
    .note-item.open .expand-arrow { transform: rotate(180deg); }
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; text-align: left;}
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; display: none; }
    .list-item.open .event-description { display: block; }
  </style>
</head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="main"></div>
  <div class="tabs"> <div class="tab active" id="tab-home">Home</div> </div>
  <div id="toast" class="toast"></div>
  
  <script>
    (function() { const params = new URLSearchParams(window.location.search); if (!params.has('v')) { const newUrl = new URL(window.location.href); newUrl.searchParams.set('v', new Date().getTime()); window.location.replace(newUrl.href); } })();

    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram?.WebApp;
      if (tg) { tg.expand(); if (tg.themeParams) { document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa'); document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff'); document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333'); document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555'); document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3'); document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff'); } }
      
      const webhookURL = 'https://script.google.com/macros/s/AKfycbxenwF0_F1yz0OJ7Kau7W2-HxqZqq5HIGD-GUdENpduign5J8xewfQJWBfGZpM04vHe/exec';
      let chatId = tg?.initDataUnsafe?.user?.id;
      if (!chatId) { chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', '6840956330'); }

      let appData = { counts: {}, remindersList: [], shoppingList: [], notesList: [] };
      const mainContent = document.getElementById('main');
      const spinner = document.getElementById('spinner');

      function showSpinner() { spinner.style.display = 'block'; }
      function hideSpinner() { spinner.style.display = 'none'; }
      function showToast(msg, isError = false) { let toastTimer; clearTimeout(toastTimer); const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); }
      
      async function fetchWithTimeout(resource, payloadObject) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), 30000);
        const formData = new FormData();
        formData.append("postData", JSON.stringify(payloadObject));
        try {
          const response = await fetch(resource, { method: 'POST', body: formData, signal: controller.signal });
          clearTimeout(id);
          if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
          return response;
        } catch (error) {
          clearTimeout(id);
          if (error.name === 'AbortError') throw new Error('Timeout: La solicitud tardó demasiado.');
          throw error;
        }
      }

      async function initializeAppContent() { showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { Type: 'get_full_dashboard', chat_ID: chatId }); const data = await res.json(); if (data.error) throw new Error(data.error); appData = data; renderDashboard(); } catch (err) { console.error('Error en carga inicial:', err); showToast(`Error al cargar datos: ${err.message}`, true); mainContent.innerHTML = `<div class="no-data-msg">❌<br>Error al cargar la aplicación.<br><small>${err.message}</small><br><br><button onclick="initializeAppContent()">Reintentar</button></div>`; } finally { hideSpinner(); } }
      
      function renderDashboard() {
        setActiveTab('tab-home');
        mainContent.innerHTML = `
          <div class="grid">
            <div class="card"><div class="card-badge red" style="left:12px;">${appData.counts.remindersCount}</div><button class="card-menu-btn" data-menu-id="menu-recordatorios">⋮</button><div class="card-icon">🗓️</div><div class="card-title">Recordatorios</div><div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">Añadir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div></div>
            <div class="card"><div class="card-badge-group"><div class="card-badge green">${appData.counts.shoppingPendingCount}</div><div class="card-badge red">${appData.counts.shoppingBoughtCount}</div></div><button class="card-menu-btn" data-menu-id="menu-shopping-list">⋮</button><div class="card-icon">🛒</div><div class="card-title">Compras</div><div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">Añadir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div></div>
            <div class="card"><div class="card-badge red" style="left:12px;">${appData.counts.notesCount}</div><button class="card-menu-btn" data-menu-id="menu-notes">⋮</button><div class="card-icon">📝</div><div class="card-title">Notas</div><div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">Añadir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div></div>
            <div class="card"><div class="card-badge red" style="left:12px;">${appData.counts.calendarTodayCount}</div><button class="card-menu-btn" data-menu-id="menu-calendar">⋮</button><div class="card-icon">🗓️</div><div class="card-title">Calendario</div><div class="dropdown-menu" id="menu-calendar"><a class="dropdown-item" id="add-event-link">Añadir Evento</a><a class="dropdown-item" id="view-agenda-link">Ver Agenda</a></div></div>
            <div class="card"><div class="card-badge red" style="left:12px;">${(appData.counts.gastosMesActual || '0,00').split(',')[0]}</div><button class="card-menu-btn" data-menu-id="menu-gastos">⋮</button><div class="card-icon">💰</div><div class="card-title">Gastos</div><div class="dropdown-menu" id="menu-gastos"><a class="dropdown-item" id="add-gasto-link">Añadir</a><a class="dropdown-item" id="list-gastos-link">Buscar</a><a class="dropdown-item" id="view-gasto-chart-link">Ver Gráfico</a></div></div>
          </div>`;
        document.getElementById('add-reminder-link').onclick = renderReminderForm;
        document.getElementById('list-reminders-link').onclick = renderRemindersList;
        document.getElementById('view-shopping-list-link').onclick = renderShoppingList;
        document.getElementById('add-shopping-item-link').onclick = renderAddArticleForm;
        document.getElementById('add-note-link').onclick = () => renderNoteForm();
        document.getElementById('list-notes-link').onclick = renderNotesList;
        document.getElementById('add-event-link').onclick = () => renderEventForm();
        document.getElementById('view-agenda-link').onclick = renderAgendaView;
        document.getElementById('add-gasto-link').onclick = () => { mainContent.innerHTML = `<div class="no-data-msg">Función no implementada</div>`; };
        document.getElementById('list-gastos-link').onclick = () => { mainContent.innerHTML = `<div class="no-data-msg">Función no implementada</div>`; };
        document.getElementById('view-gasto-chart-link').onclick = renderGastoChart;
      }
      
      document.body.addEventListener('click', (e) => { const menuBtn = e.target.closest('[data-menu-id]'); if (!menuBtn && !e.target.closest('.dropdown-menu')) { document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show')); return; } if (menuBtn) { e.stopPropagation(); const menuId = menuBtn.dataset.menuId; const menu = document.getElementById(menuId); if (menu) { const isShown = menu.classList.contains('show'); document.querySelectorAll('.dropdown-menu.show').forEach(m => { if (m.id !== menuId) m.classList.remove('show'); }); menu.classList.toggle('show', !isShown); } } });
      function setActiveTab(activeTabId) { document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); const activeTab = document.getElementById(activeTabId); if (activeTab) activeTab.classList.add('active'); }

      // --- RECORDATORIOS ---
      function renderReminderForm() {
        mainContent.innerHTML = `
          <div class="list-container">
            <div class="list-header"><button class="back-btn">‹</button><h2>📝 Nuevo Recordatorio</h2></div>
            <div class="form-card">
              <label>Descripción</label><textarea id="text" rows="3" required></textarea>
              <label>Fecha y hora</label><input type="text" id="time" required/>
              <label>Tipo</label>
              <div class="radio-group" id="reminder-type-group">
                <label><input type="radio" name="category" value="Un solo uso" checked/> Único</label>
                <label><input type="radio" name="category" value="Diario"/> Diario</label>
                <label><input type="radio" name="category" value="Recurrente"/> Recurrente</label>
              </div>
              <div id="recurrent-hours-container">
                <label>Repetir cada...</label>
                <select id="recurrent-hours">
                  ${[...Array(11).keys()].map(i => `<option value="${i + 2}">${i + 2} horas</option>`).join('')}
                </select>
              </div>
              <button id="sendBtn" disabled>Crear Recordatorio</button>
            </div>
          </div>`;
        document.querySelector('.back-btn').onclick = renderDashboard;
        const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), sendBtn = document.getElementById('sendBtn'), radios = document.querySelectorAll('input[name="category"]'), recurrentContainer = document.getElementById('recurrent-hours-container');
        flatpickr("#time", { enableTime: true, dateFormat: "Y-m-d H:i", defaultDate: new Date(), locale: "es", minDate: "today" });
        function toggleRecurrentField() { const selected = document.querySelector('input[name="category"]:checked').value; recurrentContainer.style.display = selected === 'Recurrente' ? 'block' : 'none'; }
        function validate() { const isValid = textInput.value.trim() !== '' && timeInput.value && document.querySelector('input[name="category"]:checked'); sendBtn.disabled = !isValid; sendBtn.classList.toggle('enabled', isValid); }
        textInput.oninput = validate; timeInput.oninput = validate; radios.forEach(r => r.onchange = () => { toggleRecurrentField(); validate(); });
        sendBtn.onclick = saveReminder;
        toggleRecurrentField(); validate();
      }

      async function saveReminder() {
        const category = document.querySelector('input[name="category"]:checked').value;
        const description = document.getElementById('text').value.trim();
        const time = document.getElementById('time')._flatpickr.selectedDates[0];
        const horas_recurrentes = category === 'Recurrente' ? document.getElementById('recurrent-hours').value : null;
        const payload = { chat_ID: chatId, Type: 'add_reminder', description, time: time.toISOString(), category, horas_recurrentes };
        showToast('Guardando...');
        renderDashboard();
        try { const res = await fetchWithTimeout(webhookURL, payload); const data = await res.json(); if(data.error) throw new Error(data.error); await initializeAppContent(); showToast('Recordatorio guardado'); } catch (err) { showToast(err.message || 'Error de sincronización', true); await initializeAppContent(); }
      }

      function renderRemindersList() {
        const reminders = appData.remindersList || [];
        let listHtml = (reminders.length > 0) ? reminders.map(item => `
          <li class="list-item" id="item-${item.tracking_code}">
            <div class="list-item-content">
              <span class="list-item-title">${item.Descripcion}</span>
              <span class="list-item-subtitle">${item.Categoria}: ${item.Fecha}</span>
            </div>
            <div class="list-item-actions">
              <button class="generic-menu-btn" data-menu-id="menu-item-${item.tracking_code}">⋮</button>
              <div class="dropdown-menu" id="menu-item-${item.tracking_code}">
                <a class="dropdown-item" onclick="confirmDelete('reminder', '${item.tracking_code}')">Eliminar</a>
              </div>
            </div>
          </li>`).join('') : '<div class="no-data-msg">🎉<br>No tienes recordatorios.</div>';
        mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‹</button><h2>Recordatorios</h2></div><ul class="list-style-none">${listHtml}</ul></div>`;
        document.querySelector('.back-btn').onclick = renderDashboard;
      }

      // --- COMPRAS ---
      function renderShoppingList() { mainContent.innerHTML = `<div class="no-data-msg">Función no implementada</div>`; }
      function renderAddArticleForm() { mainContent.innerHTML = `<div class="no-data-msg">Función no implementada</div>`; }

      // --- NOTAS ---
      function renderNotesList() {
          const notes = appData.notesList || [];
          let listHtml = (notes.length > 0) ? notes.map(note => `
              <li class="note-item" id="note-${note.Nota_ID}">
                  <div class="note-header">
                      <div class="note-header-interactive">
                          <div class="note-title-section">
                              <span class="note-title">${note.Titulo}</span>
                              <span class="note-date">${note.Fecha}</span>
                          </div>
                          <span class="expand-arrow">▾</span>
                      </div>
                      <div class="list-item-actions">
                          <button class="generic-menu-btn" data-menu-id="menu-note-${note.Nota_ID}">⋮</button>
                          <div class="dropdown-menu" id="menu-note-${note.Nota_ID}">
                              <a class="dropdown-item" onclick="renderNoteForm({Nota_ID: '${note.Nota_ID}', Titulo: '${note.Titulo}', Descripcion: \`${note.Descripcion}\`})">Editar</a>
                              <a class="dropdown-item" onclick="confirmDelete('note', '${note.Nota_ID}')">Eliminar</a>
                          </div>
                      </div>
                  </div>
                  <div class="note-description">${note.Descripcion}</div>
              </li>`).join('') : '<div class="no-data-msg">📝<br>No tienes notas guardadas.</div>';
          mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‹</button><h2>Mis Notas</h2></div><ul class="list-style-none">${listHtml}</ul></div>`;
          document.querySelector('.back-btn').onclick = renderDashboard;
          document.querySelector('.list-style-none').addEventListener('click', e => { const interactiveHeader = e.target.closest('.note-header-interactive'); if (interactiveHeader) { interactiveHeader.closest('.note-item').classList.toggle('open'); } });
      }

      function renderNoteForm(note = null) {
          const isEditing = note !== null;
          mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‹</button><h2>${isEditing ? '✏️ Editar Nota' : '➕ Nueva Nota'}</h2></div><div class="form-card"><label>Título</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}" required /><label>Descripción</label><textarea id="note-description" rows="8" required>${isEditing ? note.Descripcion : ''}</textarea><button id="save-note-btn" data-note-id="${isEditing ? note.Nota_ID : ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button></div></div>`;
          document.querySelector('.back-btn').onclick = renderNotesList;
          const titleInput = document.getElementById('note-title'), descriptionInput = document.getElementById('note-description'), saveBtn = document.getElementById('save-note-btn');
          function validate() { saveBtn.disabled = !(titleInput.value.trim() !== '' && descriptionInput.value.trim() !== ''); saveBtn.classList.toggle('enabled', !saveBtn.disabled); }
          titleInput.oninput = validate; descriptionInput.oninput = validate;
          saveBtn.onclick = async () => {
              const payload = { chat_ID: chatId, Type: saveBtn.dataset.noteId ? 'edit_note' : 'add_note', note_id: saveBtn.dataset.noteId, title: titleInput.value.trim(), description: descriptionInput.value.trim() };
              showSpinner(); try { const res = await fetchWithTimeout(webhookURL, payload); const data = await res.json(); if (data.error) throw new Error(data.error); appData = data; showToast(`Nota ${saveBtn.dataset.noteId ? 'actualizada' : 'creada'}`); renderNotesList(); } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
          };
          validate();
      }

      // --- CALENDARIO ---
      function renderAgendaView() {
          const events = appData.calendarEvents || [];
          const groupAndRenderEvents = (evs) => {
              const eventsByDay = evs.reduce((acc, event) => { const day = new Date(event.start).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); if (!acc[day]) acc[day] = []; acc[day].push(event); return acc; }, {});
              let html = '';
              for (const day in eventsByDay) {
                  html += `<h3 class="day-header">${day}</h3>`;
                  html += evs.filter(e => new Date(e.start).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) === day).map(event => {
                      const startTime = new Date(event.start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                      const endTime = new Date(event.end).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                      return `<li class="list-item" id="item-${event.id}"><div class="list-item-content" onclick="this.parentElement.classList.toggle('open')"><span class="list-item-title">${event.summary}</span><span class="list-item-subtitle">${startTime} - ${endTime}</span><div class="event-description">${event.description || ''}</div></div><div class="list-item-actions"><button class="generic-menu-btn" data-menu-id="menu-item-${event.id}">⋮</button><div class="dropdown-menu" id="menu-item-${event.id}"><a class="dropdown-item" onclick="confirmDelete('calendar_event', '${event.id}')">Eliminar</a><a class="dropdown-item" href="${event.htmlLink}" target="_blank">Ver en Google</a></div></div></li>`;
                  }).join('');
              }
              return html;
          };
          let listHtml = (events.length > 0) ? groupAndRenderEvents(events) : '<div class="no-data-msg">🗓️<br>No tienes eventos próximos.</div>';
          mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‹</button><h2>Agenda</h2></div><ul class="list-style-none">${listHtml}</ul></div>`;
          document.querySelector('.back-btn').onclick = renderDashboard;
      }

      function renderEventForm(event = null) {
          const isEditing = event !== null;
          mainContent.innerHTML = `
            <div class="list-container"><div class="list-header"><button class="back-btn">‹</button><h2>${isEditing ? '✏️ Editar Evento' : '➕ Nuevo Evento'}</h2></div>
            <div class="form-card">
                <label>Título</label><input type="text" id="event-summary" value="${isEditing ? event.summary : ''}" required />
                <label>Inicio</label><input type="text" id="event-start" readonly="readonly">
                <label>Fin</label><input type="text" id="event-end" readonly="readonly">
                <label>Descripción</label><textarea id="event-description" rows="4">${isEditing && event.description ? event.description : ''}</textarea>
                <button id="save-event-btn" data-event-id="${isEditing ? event.id : ''}" disabled>${isEditing ? 'Guardar' : 'Crear'}</button>
            </div></div>`;
          document.querySelector('.back-btn').onclick = isEditing ? renderAgendaView : renderDashboard;
          const startDate = isEditing ? new Date(event.start) : new Date();
          const endDate = isEditing ? new Date(event.end) : new Date(Date.now() + 3600000);
          const fpOptions = { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true, locale: "es" };
          const startPicker = flatpickr("#event-start", { ...fpOptions, defaultDate: startDate });
          const endPicker = flatpickr("#event-end", { ...fpOptions, defaultDate: endDate });
          const summaryInput = document.getElementById('event-summary'), saveBtn = document.getElementById('save-event-btn');
          function validate() { saveBtn.disabled = summaryInput.value.trim() === ''; saveBtn.classList.toggle('enabled', !saveBtn.disabled); }
          summaryInput.oninput = validate;
          saveBtn.onclick = async () => {
              const eventData = { summary: summaryInput.value, start: startPicker.selectedDates[0].toISOString(), end: endPicker.selectedDates[0].toISOString(), description: document.getElementById('event-description').value };
              const payload = { chat_ID: chatId, Type: 'add_calendar_event', eventData };
              showSpinner(); try { const res = await fetchWithTimeout(webhookURL, payload); const result = await res.json(); if (result.error) throw new Error(result.error); showToast('Evento creado'); initializeAppContent(); } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
          };
          validate();
      }

      // --- GASTOS ---
      function renderGastoChart() {
        const mesesOptions = (appData.counts.mesesActivosGastos || []).map(mes => `<option value="${mes}">${mes}</option>`).join('');
        mainContent.innerHTML = `
          <div class="list-container">
            <div class="list-header"><button class="back-btn">‹</button><h2>Análisis de Gastos</h2></div>
            <div class="form-card">
              <label>Detalle por Mes</label>
              <select id="gasto-chart-mes-select"><option value="">Selecciona un mes...</option>${mesesOptions}</select>
              <div class="gasto-chart-container" id="chart-container-pie"></div>
              <ul class="gasto-legend" id="gasto-legend-container"></ul>
              <hr style="margin: 25px 0; border-top: 1px solid #eee;">
              <div class="gasto-chart-container" id="chart-container-daily"></div>
              <hr style="margin: 25px 0; border-top: 1px solid #eee;">
              <div class="gasto-chart-container" id="chart-container-monthly"></div>
            </div>
          </div>`;
        document.querySelector('.back-btn').onclick = renderDashboard;
        document.getElementById('gasto-chart-mes-select').onchange = fetchAndDisplayGastoChart;
        fetchAndDisplayGastoChart({ target: { value: '' } }); 
      }

      async function fetchAndDisplayGastoChart(event) {
        const mesAnio = event.target.value;
        showSpinner();
        const pieContainer = document.getElementById('chart-container-pie'), dailyContainer = document.getElementById('chart-container-daily'), monthlyContainer = document.getElementById('chart-container-monthly'), legendContainer = document.getElementById('gasto-legend-container');
        if (mesAnio) { pieContainer.innerHTML = ''; dailyContainer.innerHTML = ''; legendContainer.innerHTML = ''; }
        try {
          const payload = { Type: 'get_gastos_chart', chat_ID: chatId, mes_anio: mesAnio };
          const res = await fetchWithTimeout(webhookURL, payload); const data = await res.json(); if (data.error) throw new Error(data.error);
          if(data.pieChartUrl && mesAnio) { const imgPie = document.createElement('img'); imgPie.src = data.pieChartUrl; pieContainer.appendChild(imgPie); }
          if(data.dailyLineChartUrl && mesAnio) { const imgDaily = document.createElement('img'); imgDaily.src = data.dailyLineChartUrl; dailyContainer.appendChild(imgDaily); }
          if(data.monthlyBarChartUrl) { monthlyContainer.innerHTML = ''; const imgMonthly = document.createElement('img'); imgMonthly.src = data.monthlyBarChartUrl; monthlyContainer.appendChild(imgMonthly); }
          if(data.datosParaLeyenda && data.datosParaLeyenda.length > 0 && mesAnio) { legendContainer.innerHTML = data.datosParaLeyenda.map(item => `<li class="gasto-legend-item"><span class="gasto-legend-color" style="background-color:${item.color};"></span>${item.categoria}: <strong>${item.importe}</strong></li>`).join(''); }
        } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
      }

      // --- LÓGICA GENÉRICA DE BORRADO CON CONFIRMACIÓN ---
      window.confirmDelete = function(type, id) {
          const itemElement = document.getElementById(`item-${id}`) || document.getElementById(`note-${id}`);
          if (!itemElement) return;
          const actionsContainer = itemElement.querySelector('.list-item-actions');
          const originalButton = actionsContainer.querySelector('.generic-menu-btn');
          originalButton.style.display = 'none';
          
          const confirmBtnYes = document.createElement('button');
          confirmBtnYes.className = 'confirm-btn-yes';
          confirmBtnYes.textContent = 'Sí';
          confirmBtnYes.onclick = (e) => { e.stopPropagation(); executeDelete(type, id); };

          const confirmBtnNo = document.createElement('button');
          confirmBtnNo.className = 'confirm-btn-no';
          confirmBtnNo.textContent = 'No';
          confirmBtnNo.onclick = (e) => { e.stopPropagation(); originalButton.style.display = 'block'; confirmBtnYes.remove(); confirmBtnNo.remove(); };
          
          actionsContainer.appendChild(confirmBtnYes);
          actionsContainer.appendChild(confirmBtnNo);
      }

      async function executeDelete(type, id) {
          let payload = { chat_ID: chatId };
          let successMessage = '';
          let renderFunction = null;

          switch(type) {
              case 'reminder':
                  payload.Type = 'delete_reminder';
                  payload.tracking_code = id;
                  successMessage = 'Recordatorio eliminado';
                  renderFunction = renderRemindersList;
                  break;
              case 'note':
                  payload.Type = 'delete_note';
                  payload.note_id = id;
                  successMessage = 'Nota eliminada';
                  renderFunction = renderNotesList;
                  break;
              case 'calendar_event':
                  payload.Type = 'delete_calendar_event';
                  payload.eventId = id;
                  successMessage = 'Evento eliminado';
                  renderFunction = renderAgendaView;
                  break;
              default:
                  return;
          }
          
          showSpinner();
          try {
              const res = await fetchWithTimeout(webhookURL, payload);
              const data = await res.json();
              if (data.error) throw new Error(data.error);
              appData = data;
              showToast(successMessage);
              if (renderFunction) renderFunction(); else initializeAppContent();
          } catch (err) {
              showToast(err.message || 'Error al eliminar', true);
          } finally {
              hideSpinner();
          }
      }
      
      initializeAppContent();
    });
  </script>
</body>
</html>
