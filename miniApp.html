<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:12px;min-width:24px;height:24px;padding:0 7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:24px;font-weight:500;}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;}
    .card-badge.red{background-color:#e74c3c;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; z-index: 10; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 12px 20px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .dropdown-item:hover { background-color: var(--bg); }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container{max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input, .form-card select, .form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input, .form-card select{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text);}
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1001;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .list-style-none { list-style: none; padding: 0; margin: 0; }
    .list-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: opacity 0.2s; }
    .list-item.optimistic-delete { opacity: 0.5; }
    .list-item-content { padding: 15px; display: flex; align-items: center; justify-content: space-between; }
    .list-item-details { display: flex; flex-direction: column; flex-grow: 1; text-align: left;}
    .list-item-title { font-size: 1.1rem; font-weight: 500; }
    .list-item-subtitle { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .note-header { cursor: pointer; }
    .note-description { padding: 0 15px 15px; display: none; white-space: pre-wrap; word-wrap: break-word; }
    .note-item.open .note-description { display: block; }
    .generic-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .no-data-msg { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; }
    .shopping-item { display: flex; align-items: center; gap: 10px; padding: 0; background: var(--card-bg); border-radius:10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
    .shopping-item-content { padding: 10px 15px; display: flex; align-items: center; gap: 10px; flex-grow: 1; }
    .shopping-item-toggle-btn { flex-grow: 1; text-align: left; border: none; font-size: 1rem; padding: 10px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; color: var(--list-item-text); font-weight: 500; transition: background-color 0.2s; }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); text-decoration: line-through; opacity: 0.85; }
    .item-date { font-size: 0.8rem; opacity: 0.9; }
    .shopping-list-header-row { display: flex; justify-content: flex-end; align-items: center; gap: 8px; padding: 0 10px 10px; font-size: 0.9rem; }
    .shopping-list-section-title { font-size: 1rem; color: var(--muted); margin: 20px 10px 10px; }
    .add-article-btn-container { padding: 10px; display: flex; gap: 10px; }
    .add-article-btn-container button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
    .add-article-btn { background-color: var(--primary); color: var(--action-text); }
    .multi-select-action-btn { background-color: #f0f0f0; color: var(--text); cursor: not-allowed; opacity: 0.6; }
    .multi-select-action-btn.enabled { background-color: var(--action-bg); color: var(--action-text); opacity: 1; cursor: pointer; }
    .gasto-chart-container img { max-width: 100%; border-radius: 12px; margin-top: 15px; }
    .confirm-actions { display: none; align-items: center; }
    .confirm-actions.show { display: flex; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
  </style>
</head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="main"></div>
  <div class="tabs"> <div class="tab active" id="tab-home">Home</div> </div>
  <div id="toast" class="toast"></div>
  
  <script>
    (function() { const params = new URLSearchParams(window.location.search); if (!params.has('v')) { const newUrl = new URL(window.location.href); newUrl.searchParams.set('v', new Date().getTime()); window.location.replace(newUrl.href); } })();

    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram?.WebApp;
      if (tg) { tg.expand(); if (tg.themeParams) { document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa'); document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff'); document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333'); document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555'); document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3'); document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff'); } }
      const webhookURL = 'https://script.google.com/macros/s/AKfycbxMy9HJ33GJz2S2RvWIFTc6AxI1L2EFw_cyVstKbmvEXQl43sbrYv3QE0dc6OhIX6XBpw/exec';
      let chatId = tg?.initDataUnsafe?.user?.id;
      if (!chatId) { chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', ''); }

      let appData = { counts: {}, remindersList: [], shoppingList: [], notesList: [] };
      let toastTimer;
      const mainContent = document.getElementById('main');
      const spinner = document.getElementById('spinner');

      function showSpinner() { spinner.style.display = 'block'; }
      function hideSpinner() { spinner.style.display = 'none'; }
      function showToast(msg, isError = false) { clearTimeout(toastTimer); const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); }
      async function fetchWithTimeout(resource, options = {}) { const controller = new AbortController(); const id = setTimeout(() => controller.abort(), 30000); try { const response = await fetch(resource, { ...options, signal: controller.signal, method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: options.body }); clearTimeout(id); if (!response.ok) throw new Error(`Error del servidor: ${response.status}`); return response; } catch (error) { clearTimeout(id); if (error.name === 'AbortError') throw new Error('Timeout: La solicitud tard√≥ demasiado.'); throw error; } }

      async function initializeAppContent() { showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_full_dashboard' }) }); const data = await res.json(); if (data.error) throw new Error(data.error); appData = data; renderDashboard(); } catch (err) { console.error('Error en carga inicial:', err); showToast(`Error al cargar datos: ${err.message}`, true); mainContent.innerHTML = `<div class="no-data-msg">‚ùå<br>Error al cargar la aplicaci√≥n.<br><small>${err.message}</small><br><br><button onclick="initializeAppContent()">Reintentar</button></div>`; } finally { hideSpinner(); } }
      function updateLocalData(newData) { if (newData.error) throw new Error(newData.error); appData = newData; }

      function renderDashboard() { setActiveTab('tab-home'); mainContent.innerHTML = `<div class="grid"><div class="card"><div class="card-badge red" style="left:12px;">${appData.counts.remindersCount}</div><button class="card-menu-btn" data-menu-id="menu-recordatorios">‚ãÆ</button><div class="card-icon">üóìÔ∏è</div><div class="card-title">Recordatorios</div><div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">A√±adir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div></div><div class="card"><div class="card-badge-group"><div class="card-badge green">${appData.counts.shoppingPendingCount}</div><div class="card-badge red">${appData.counts.shoppingBoughtCount}</div></div><button class="card-menu-btn" data-menu-id="menu-shopping-list">‚ãÆ</button><div class="card-icon">üõí</div><div class="card-title">Compras</div><div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">A√±adir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div></div><div class="card"><div class="card-badge red" style="left:12px;">${appData.counts.notesCount}</div><button class="card-menu-btn" data-menu-id="menu-notes">‚ãÆ</button><div class="card-icon">üìù</div><div class="card-title">Notas</div><div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">A√±adir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div></div><div class="card"><div class="card-badge red" style="left:12px;">${appData.counts.calendarTodayCount}</div><button class="card-menu-btn" data-menu-id="menu-calendar">‚ãÆ</button><div class="card-icon">üóìÔ∏è</div><div class="card-title">Calendario</div><div class="dropdown-menu" id="menu-calendar"><a class="dropdown-item" id="add-event-link">A√±adir Evento</a><a class="dropdown-item" id="view-agenda-link">Ver Agenda</a></div></div><div class="card"><div class="card-badge red" style="left:12px;">${(appData.counts.gastosMesActual || '0,00').split(',')[0]}</div><button class="card-menu-btn" data-menu-id="menu-gastos">‚ãÆ</button><div class="card-icon">üí∞</div><div class="card-title">Gastos</div><div class="dropdown-menu" id="menu-gastos"><a class="dropdown-item" id="add-gasto-link">A√±adir</a><a class="dropdown-item" id="list-gastos-link">Buscar</a><a class="dropdown-item" id="view-gasto-chart-link">Ver Gr√°fico</a></div></div></div>`; document.getElementById('add-reminder-link').onclick = renderReminderForm; document.getElementById('list-reminders-link').onclick = renderRemindersList; document.getElementById('view-shopping-list-link').onclick = renderShoppingList; document.getElementById('add-shopping-item-link').onclick = renderAddArticleForm; document.getElementById('add-note-link').onclick = renderNoteForm; document.getElementById('list-notes-link').onclick = renderNotesList; document.getElementById('add-event-link').onclick = renderEventForm; document.getElementById('view-agenda-link').onclick = renderAgendaView; document.getElementById('add-gasto-link').onclick = renderGastoForm; document.getElementById('list-gastos-link').onclick = renderGastosList; document.getElementById('view-gasto-chart-link').onclick = renderGastoChart; }
      document.body.addEventListener('click', (e) => { const menuBtn = e.target.closest('[data-menu-id]'); if (!menuBtn && !e.target.closest('.dropdown-menu')) { document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show')); return; } if (menuBtn) { e.stopPropagation(); const menuId = menuBtn.dataset.menuId; const menu = document.getElementById(menuId); if (menu) { const isShown = menu.classList.contains('show'); document.querySelectorAll('.dropdown-menu.show').forEach(m => { if (m.id !== menuId) m.classList.remove('show'); }); menu.classList.toggle('show', !isShown); } } });
      function setActiveTab(activeTabId) { document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); const activeTab = document.getElementById(activeTabId); if (activeTab) activeTab.classList.add('active'); }

      // --- RECORDATORIOS ---
      function renderReminderForm(reminder = null) { const isEditing = !!reminder; mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‚Äπ</button><h2>${isEditing ? '‚úèÔ∏è Editar' : 'üìù Nuevo'} Recordatorio</h2></div><div class="form-card"><label>Descripci√≥n</label><textarea id="text" rows="3" required>${isEditing ? reminder.Descripcion : ''}</textarea><label>Fecha y hora</label><input type="text" id="time" required/><label>Tipo</label><div class="radio-group"><label><input type="radio" name="category" value="un solo uso" ${isEditing && reminder.Categoria === 'un solo uso' ? 'checked' : ''}/> √önico</label><label><input type="radio" name="category" value="diario" ${isEditing && reminder.Categoria === 'diario' ? 'checked' : ''}/> Diario</label></div><button id="sendBtn" ${isEditing ? 'class="enabled"' : ''} disabled>${isEditing ? 'Guardar Cambios' : 'Crear'}</button></div></div>`; document.querySelector('.back-btn').onclick = renderRemindersList; const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), sendBtn = document.getElementById('sendBtn'), radios = document.querySelectorAll('input[name="category"]'); flatpickr("#time", { enableTime: true, dateFormat: "Y-m-d H:i", defaultDate: isEditing ? new Date(reminder.FullDate) : null, locale: "es" }); function validate() { const isValid = textInput.value.trim() !== '' && timeInput.value && document.querySelector('input[name="category"]:checked'); sendBtn.disabled = !isValid; sendBtn.classList.toggle('enabled', isValid); } textInput.oninput = validate; timeInput.oninput = validate; radios.forEach(r => r.onchange = validate); sendBtn.onclick = () => saveReminder(reminder ? reminder.tracking_code : null); }
      async function saveReminder(trackingCode = null) { showSpinner(); try { const payload = { chat_ID: chatId, Type: trackingCode ? 'edit_reminder' : 'add_reminder', tracking_code: trackingCode, description: document.getElementById('text').value.trim(), time: document.getElementById('time')._flatpickr.selectedDates[0].toISOString(), category: document.querySelector('input[name="category"]:checked').value }; const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) }); const data = await res.json(); updateLocalData(data); showToast(`Recordatorio ${trackingCode ? 'actualizado' : 'guardado'}`); renderDashboard(); } catch (err) { showToast(err.message || 'Error al guardar', true); } finally { hideSpinner(); } }
      function renderRemindersList() { const reminders = appData.remindersList || []; let listHtml = (reminders.length > 0) ? reminders.map(item => `<li class="list-item" id="reminder-${item.tracking_code}"><div class="list-item-content"><div class="list-item-details"><span class="list-item-title">${item.Descripcion}</span><span class="list-item-subtitle">${item.Categoria === 'diario' ? 'Diario a las ' : ''}${item.Fecha}</span></div><button class="generic-menu-btn" data-menu-id="menu-rem-${item.tracking_code}">‚ãÆ</button></div><div class="dropdown-menu" id="menu-rem-${item.tracking_code}"><a class="dropdown-item" data-action="edit-reminder" data-id="${item.tracking_code}">Editar</a><a class="dropdown-item" data-action="delete-reminder" data-id="${item.tracking_code}">Eliminar</a></div></li>`).join('') : '<div class="no-data-msg">üéâ<br>No tienes recordatorios.</div>'; mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‚Äπ</button><h2>Recordatorios</h2></div><ul class="list-style-none">${listHtml}</ul></div>`; document.querySelector('.back-btn').onclick = renderDashboard; document.querySelector('.list-style-none').addEventListener('click', (e) => { const actionItem = e.target.closest('.dropdown-item'); if(actionItem){ const id = actionItem.dataset.id; if(actionItem.dataset.action === 'edit-reminder'){ const reminder = appData.remindersList.find(r => r.tracking_code === id); if(reminder) renderReminderForm(reminder); } else if(actionItem.dataset.action === 'delete-reminder'){ executeDeleteReminder(id); } } }); }
      function executeDeleteReminder(trackingCode) { const originalData = JSON.parse(JSON.stringify(appData)); const itemIndex = appData.remindersList.findIndex(i => i.tracking_code === trackingCode); if (itemIndex > -1) { appData.remindersList.splice(itemIndex, 1); appData.counts.remindersCount--; renderRemindersList(); } fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_reminder', tracking_code: trackingCode }) }).then(res => res.json()).then(data => updateLocalData(data)).catch(() => { showToast('Error de Sincronizaci√≥n. Int√©ntalo de nuevo.', true); appData = originalData; renderRemindersList(); }); }

      // --- LISTA DE LA COMPRA ---
      function renderShoppingList() { const items = appData.shoppingList || []; const pending = items.filter(i => i['2']==='Pendiente'); const bought = items.filter(i => i['2']==='Comprado'); let html = ''; if (pending.length > 0) { html += '<h3 class="shopping-list-section-title">Pendientes</h3>'; html += pending.map(item => `<div class="shopping-item" data-id="${item['3']}"><div class="shopping-item-content"><button class="shopping-item-toggle-btn pending" data-id="${item['3']}"><span>${item['1']}</span></button></div><button class="generic-menu-btn" data-menu-id="menu-shop-${item['3']}">‚ãÆ</button><div class="dropdown-menu" id="menu-shop-${item['3']}"><a class="dropdown-item delete-btn-item" data-id="${item['3']}">Eliminar</a></div></div>`).join(''); } if (bought.length > 0) { html += '<h3 class="shopping-list-section-title">Comprados</h3>'; html += '<div class="shopping-list-header-row"><label for="select-all">Todos</label><input type="checkbox" id="select-all"></div>'; html += bought.map(item => `<div class="shopping-item" data-id="${item['3']}"><div class="shopping-item-content"><input type="checkbox" class="shopping-item-checkbox" data-id="${item['3']}"><button class="shopping-item-toggle-btn bought" data-id="${item['3']}"><span>${item['1']}</span><span class="item-date">${item['4']}</span></button></div><button class="generic-menu-btn" data-menu-id="menu-shop-${item['3']}">‚ãÆ</button><div class="dropdown-menu" id="menu-shop-${item['3']}"><a class="dropdown-item delete-btn-item" data-id="${item['3']}">Eliminar</a></div></div>`).join(''); } if (items.length === 0) { html = '<div class="no-data-msg">üõí<br>Tu lista est√° vac√≠a.</div>'; } mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‚Äπ</button><h2>Lista de Compras</h2></div>${html}<div class="add-article-btn-container"><button class="add-article-btn">A√±adir</button><button class="multi-select-action-btn" disabled>Marcar para comprar</button></div></div>`; document.querySelector('.back-btn').onclick = renderDashboard; document.querySelector('.add-article-btn').onclick = renderAddArticleForm; mainContent.addEventListener('click', handleShoppingItemInteractions); const selectAll = document.getElementById('select-all'); if(selectAll) selectAll.onchange = (e) => { document.querySelectorAll('.shopping-item-checkbox').forEach(cb => cb.checked = e.target.checked); updateMultiSelectButtonState(); }; document.querySelectorAll('.shopping-item-checkbox').forEach(cb => cb.onchange = updateMultiSelectButtonState); const multiBtn = document.querySelector('.multi-select-action-btn'); if (multiBtn) multiBtn.onclick = toggleSelectedItemsToPending; updateMultiSelectButtonState(); }
      function handleShoppingItemInteractions(e) { const toggleBtn = e.target.closest('.shopping-item-toggle-btn'); const deleteBtn = e.target.closest('.delete-btn-item'); if(toggleBtn) toggleShoppingItemStatus(toggleBtn.dataset.id); if(deleteBtn) executeDeleteShoppingItem(deleteBtn.dataset.id); }
      function updateMultiSelectButtonState() { const btn = document.querySelector('.multi-select-action-btn'); if(!btn) return; const count = document.querySelectorAll('.shopping-item-checkbox:checked').length; btn.disabled = count === 0; btn.classList.toggle('enabled', count > 0); btn.textContent = count > 0 ? `Marcar ${count} para comprar` : 'Marcar para comprar'; }
      function toggleShoppingItemStatus(trackingCode) { const originalData = JSON.parse(JSON.stringify(appData)); const itemIndex = appData.shoppingList.findIndex(i => i['3'] === trackingCode); if (itemIndex === -1) return; const item = appData.shoppingList[itemIndex]; const newStatus = item['2'] === 'Pendiente' ? 'Comprado' : 'Pendiente'; appData.shoppingList[itemIndex]['2'] = newStatus; if(newStatus === 'Comprado') { appData.counts.shoppingPendingCount--; appData.counts.shoppingBoughtCount++; appData.shoppingList[itemIndex]['4'] = new Date().toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }); } else { appData.counts.shoppingPendingCount++; appData.counts.shoppingBoughtCount--; appData.shoppingList[itemIndex]['4'] = ''; } renderShoppingList(); fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'toggle_item_status', tracking_code: trackingCode }) }).then(res => res.json()).then(data => updateLocalData(data)).catch(() => { showToast('Error de Sincronizaci√≥n. Int√©ntalo de nuevo.', true); appData = originalData; renderShoppingList(); }); }
      function executeDeleteShoppingItem(trackingCode) { const originalData = JSON.parse(JSON.stringify(appData)); const itemIndex = appData.shoppingList.findIndex(i => i['3'] === trackingCode); if (itemIndex > -1) { const item = appData.shoppingList[itemIndex]; if(item['2'] === 'Pendiente') appData.counts.shoppingPendingCount--; else appData.counts.shoppingBoughtCount--; appData.shoppingList.splice(itemIndex, 1); renderShoppingList(); } fetchWithTimeout(webhookURL, { body: JSON.stringify({ Type: 'delete_item_shopping_list', chat_ID: chatId, tracking_code: trackingCode }) }).then(res => res.json()).then(data => updateLocalData(data)).catch(() => { showToast('Error de Sincronizaci√≥n. Int√©ntalo de nuevo.', true); appData = originalData; renderShoppingList(); }); }
      function renderAddArticleForm() { mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‚Äπ</button><h2>‚ûï A√±adir Art√≠culo</h2></div><div class="form-card"><label>Descripci√≥n</label><textarea id="article-desc" rows="2"></textarea><label>¬øCada cu√°ntos d√≠as lo compras? (0 si es ocasional)</label><input type="number" id="article-cycle" value="0" inputmode="numeric"/><button id="add-btn" disabled>A√±adir</button></div></div>`; document.querySelector('.back-btn').onclick = renderShoppingList; const sendBtn = document.getElementById('add-btn'); const descInput = document.getElementById('article-desc'); const cycleInput = document.getElementById('article-cycle'); function validate() { const isValid = descInput.value.trim() !== '' && cycleInput.value.trim() !== ''; sendBtn.disabled = !isValid; sendBtn.classList.toggle('enabled', isValid); } descInput.oninput = validate; cycleInput.oninput = validate; sendBtn.onclick = addArticle; }
      async function addArticle() { showSpinner(); try { const payload = { chat_ID: chatId, Type: 'add_articulo', description: document.getElementById('article-desc').value.trim(), cycle: document.getElementById('article-cycle').value.trim() }; const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) }); const data = await res.json(); updateLocalData(data); renderShoppingList(); } catch (err) { showToast(err.message || 'Error al a√±adir', true); } finally { hideSpinner(); } }
      async function toggleSelectedItemsToPending() { showSpinner(); try { const codes = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.id); if (codes.length === 0) return; const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'toggle_multiple_to_pending', tracking_codes: codes }) }); const data = await res.json(); updateLocalData(data); renderShoppingList(); } catch (err) { showToast(err.message || 'Error al actualizar', true); } finally { hideSpinner(); } }

      // --- NOTAS ---
      function renderNotesList() { const notes = appData.notesList || []; let listHtml = (notes.length > 0) ? notes.map(note => `<li class="list-item note-item" id="note-${note.Nota_ID}"><div class="list-item-content note-header"><div class="list-item-details"><span class="list-item-title">${note.Titulo}</span><span class="list-item-subtitle">${note.Fecha}</span></div><button class="generic-menu-btn" data-menu-id="menu-note-${note.Nota_ID}">‚ãÆ</button></div><div class="dropdown-menu" id="menu-note-${note.Nota_ID}"><a class="dropdown-item" data-action="edit-note" data-id="${note.Nota_ID}">Editar</a><a class="dropdown-item" data-action="delete-note" data-id="${note.Nota_ID}">Eliminar</a></div><div class="note-description">${note.Descripcion}</div></li>`).join('') : '<div class="no-data-msg">üìù<br>No tienes notas.</div>'; mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‚Äπ</button><h2>Mis Notas</h2></div><ul class="list-style-none">${listHtml}</ul></div>`; document.querySelector('.back-btn').onclick = renderDashboard; document.querySelector('.list-style-none').addEventListener('click', handleNoteInteractions); }
      function handleNoteInteractions(event) { const header = event.target.closest('.note-header'); const actionItem = event.target.closest('.dropdown-item'); if (actionItem) { event.stopPropagation(); const noteId = actionItem.dataset.id; if (actionItem.dataset.action === 'edit-note') { const note = appData.notesList.find(n => n.Nota_ID === noteId); if (note) renderNoteForm(note); } else if (actionItem.dataset.action === 'delete-note') { const menu = actionItem.closest('.dropdown-menu'); const btnContainer = menu.previousElementSibling; const confirm = document.createElement('div'); confirm.className = 'confirm-actions show'; confirm.innerHTML = `<button class="confirm-btn-yes">S√≠</button><button class="confirm-btn-no">No</button>`; btnContainer.style.display = 'none'; menu.parentElement.appendChild(confirm); confirm.querySelector('.confirm-btn-no').onclick = () => { confirm.remove(); btnContainer.style.display = 'block'; }; confirm.querySelector('.confirm-btn-yes').onclick = () => executeDeleteNote(noteId); } } else if (header) { header.closest('.note-item').classList.toggle('open'); } }
      function renderNoteForm(note = null) { const isEditing = !!note; mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‚Äπ</button><h2>${isEditing ? '‚úèÔ∏è Editar' : '‚ûï Nueva'} Nota</h2></div><div class="form-card"><label>T√≠tulo</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}"/><label>Descripci√≥n</label><textarea id="note-description" rows="8">${isEditing ? note.Descripcion : ''}</textarea><button id="save-note-btn" class="enabled">${isEditing ? 'Guardar' : 'Crear'}</button></div></div>`; document.querySelector('.back-btn').onclick = renderNotesList; document.getElementById('save-note-btn').onclick = () => saveNote(note ? note.Nota_ID : null); }
      async function saveNote(noteId = null) { showSpinner(); try { const payload = { chat_ID: chatId, Type: noteId ? 'edit_note' : 'add_note', note_id: noteId, title: document.getElementById('note-title').value.trim(), description: document.getElementById('note-description').value.trim() }; const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) }); const data = await res.json(); updateLocalData(data); renderNotesList(); } catch (err) { showToast(err.message, true); } finally { hideSpinner(); } }
      function executeDeleteNote(noteId) { const originalData = JSON.parse(JSON.stringify(appData)); const itemIndex = appData.notesList.findIndex(i => i.Nota_ID === noteId); if (itemIndex > -1) { appData.notesList.splice(itemIndex, 1); appData.counts.notesCount--; renderNotesList(); } fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_note', note_id: noteId }) }).then(res => res.json()).then(data => updateLocalData(data)).catch(() => { showToast('Error de Sincronizaci√≥n. Int√©ntalo de nuevo.', true); appData = originalData; renderNotesList(); }); }

      // --- CALENDARIO Y GASTOS ---
      async function renderAgendaView() { showSpinner(); try { const startDate = new Date(); startDate.setHours(0,0,0,0); const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 30); const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_calendar_events', startDate: startDate.toISOString(), endDate: endDate.toISOString() }) }); const events = await res.json(); if (events.error) throw new Error(events.error); const groupAndRenderEvents = (evs) => { const eventsByDay = evs.reduce((acc, event) => { const day = new Date(event.start).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); if (!acc[day]) acc[day] = []; acc[day].push(event); return acc; }, {}); let html = ''; for (const day in eventsByDay) { html += `<h3 class="shopping-list-section-title">${day}</h3>`; html += events.filter(e => new Date(e.start).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) === day).map(event => { const startTime = new Date(event.start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); const endTime = new Date(event.end).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); return `<li class="list-item" id="event-${event.id}"><div class="list-item-content"><div class="list-item-details"><span class="list-item-title">${event.summary}</span><span class="list-item-subtitle">${startTime} - ${endTime}</span></div><button class="generic-menu-btn" data-menu-id="menu-event-${event.id}">‚ãÆ</button></div><div class="dropdown-menu" id="menu-event-${event.id}"><a class="dropdown-item" href="${event.htmlLink}" target="_blank">Ver en Google</a><a class="dropdown-item" data-action="delete-event" data-event-id="${event.id}">Eliminar</a></div></li>`; }).join(''); } return html; }
      let listHtml = (events.length > 0) ? groupAndRenderEvents(events) : '<div class="no-data-msg">üóìÔ∏è<br>No tienes eventos pr√≥ximos.</div>'; mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‚Äπ</button><h2>Agenda</h2></div><ul class="list-style-none">${listHtml}</ul></div>`; document.querySelector('.back-btn').onclick = renderDashboard; document.querySelector('.list-style-none').addEventListener('click', handleEventInteractions); } catch (err) { mainContent.innerHTML = `<div class="no-data-msg">‚ùå<br>Error al cargar la agenda.<br><small>${err.message}</small></div>`; } finally { hideSpinner(); } }
      function handleEventInteractions(event) { const actionItem = event.target.closest('.dropdown-item'); if (actionItem) { const action = actionItem.dataset.action; if (action === 'delete-event') { executeDeleteEvent(actionItem.dataset.eventId); } } }
      function renderEventForm() { mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn">‚Äπ</button><h2>‚ûï Nuevo Evento</h2></div><div class="form-card"><label>T√≠tulo</label><input type="text" id="event-summary" required /><label>Descripci√≥n</label><textarea id="event-description" rows="3"></textarea><label>Inicio</label><input type="text" id="event-start" readonly="readonly"><label>Fin</label><input type="text" id="event-end" readonly="readonly"><label>Aviso</label><select id="event-reminder"><option value="0">Sin aviso</option><option value="10">Notificaci√≥n 10 min antes</option><option value="60">Notificaci√≥n 1 hora antes</option><option value="1440">Notificaci√≥n 1 d√≠a antes</option></select><button id="save-event-btn" disabled>Crear Evento</button></div></div>`; document.querySelector('.back-btn').onclick = renderDashboard; flatpickr("#event-start", { enableTime: true, dateFormat: "d-m-Y H:i", time_24hr: true, locale: "es", defaultDate: new Date() }); flatpickr("#event-end", { enableTime: true, dateFormat: "d-m-Y H:i", time_24hr: true, locale: "es", defaultDate: new Date(Date.now() + 3600000) }); const summaryInput = document.getElementById('event-summary'); const saveBtn = document.getElementById('save-event-btn'); function validate() { saveBtn.disabled = summaryInput.value.trim() === ''; saveBtn.classList.toggle('enabled', !saveBtn.disabled); } summaryInput.oninput = validate; saveBtn.onclick = saveEvent; }
      async function saveEvent() { const btn = document.getElementById('save-event-btn'); if(btn.disabled) return; btn.disabled = true; const originalText = btn.textContent; btn.textContent = 'Creando...'; showToast('Evento creado con √©xito'); renderDashboard(); const eventData = { summary: document.getElementById('event-summary').value, description: document.getElementById('event-description').value, start: document.getElementById('event-start')._flatpickr.selectedDates[0].toISOString(), end: document.getElementById('event-end')._flatpickr.selectedDates[0].toISOString(), reminderMinutes: document.getElementById('event-reminder').value }; fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'add_calendar_event', eventData: eventData }) }).then(res => res.json()).then(result => { if(result.error) throw new Error(result.error); appData.counts.calendarTodayCount++; }).catch(err => { showToast(`Error al crear evento: ${err.message}`, true); btn.disabled = false; btn.textContent = originalText; }); }
      async function executeDeleteEvent(eventId) { if (!confirm('¬øSeguro que quieres eliminar este evento del calendario?')) return; showSpinner(); try { await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_calendar_event', eventId: eventId }) }); showToast('Evento eliminado'); renderAgendaView(); } catch (err) { showToast(err.message, true); } finally { hideSpinner(); } }
      function renderGastoForm() { mainContent.innerHTML = ` <div class="list-container"> <div class="list-header"><button class="back-btn">‚Äπ</button><h2>üí∞ Nuevo Gasto</h2></div> <div class="form-card"><label>Fecha</label><input type="text" id="gasto-fecha" readonly="readonly"><label>Establecimiento</label><input type="text" id="gasto-establecimiento" required /><label>Importe</label><input type="number" id="gasto-importe" step="0.01" placeholder="Ej: 12.50" required /><label>Categor√≠a</label><input type="text" id="gasto-categoria" required /><button id="save-gasto-btn" disabled>Registrar</button> </div> </div>`; document.querySelector('.back-btn').onclick = renderDashboard; flatpickr("#gasto-fecha", { defaultDate: new Date(), dateFormat: "Y-m-d H:i", enableTime: true, time_24hr: true, locale: "es" }); const saveBtn = document.getElementById('save-gasto-btn'); const inputs = ['gasto-establecimiento', 'gasto-importe', 'gasto-categoria']; function validate() { const allValid = inputs.every(id => document.getElementById(id).value.trim() !== ''); saveBtn.disabled = !allValid; saveBtn.classList.toggle('enabled', allValid); } inputs.forEach(id => document.getElementById(id).addEventListener('input', validate)); saveBtn.onclick = saveGasto; }
      async function saveGasto() { showSpinner(); try { const payload = { make_action: 'add_gasto', chat_id: chatId, datos: { ID_Unico: 'A-' + Math.random().toString(36).substring(2, 9), Fecha: document.getElementById('gasto-fecha')._flatpickr.selectedDates[0].toISOString(), Establecimiento: document.getElementById('gasto-establecimiento').value.trim(), Importe: parseFloat(document.getElementById('gasto-importe').value), categoria: document.getElementById('gasto-categoria').value.trim() } }; const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) }); const data = await res.json(); if (data.error || (data.resultado && data.resultado.startsWith('Error'))) throw new Error(data.resultado || data.error); showToast('Gasto registrado'); initializeAppContent(); } catch (err) { showToast(err.message, true); } finally { hideSpinner(); } }
      function renderGastosList() { mainContent.innerHTML = ` <div class="list-container"> <div class="list-header"><button class="back-btn">‚Äπ</button><h2>Historial de Gastos</h2></div> <div class="form-card" style="display:flex; gap:10px;"><input type="text" id="gasto-fecha-start" placeholder="Desde..." readonly="readonly"><input type="text" id="gasto-fecha-end" placeholder="...hasta" readonly="readonly"><button id="buscar-gastos-btn" style="margin-top:0;">Buscar</button> </div> <ul class="list-style-none" id="gastos-list-ul"><div class="no-data-msg">üîç<br>Selecciona un rango de fechas.</div></ul> </div>`; document.querySelector('.back-btn').onclick = renderDashboard; const startPicker = flatpickr("#gasto-fecha-start", { dateFormat: "d/m/Y", locale: "es" }); const endPicker = flatpickr("#gasto-fecha-end", { dateFormat: "d/m/Y", locale: "es" }); document.getElementById('buscar-gastos-btn').onclick = () => fetchAndDisplayGastos(startPicker.input.value, endPicker.input.value); }
      async function fetchAndDisplayGastos(fechaStart, fechaEnd) { if (!fechaStart || !fechaEnd) { showToast('Selecciona ambas fechas.', true); return; } showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ make_action: 'get_gastos_fecha', chat_id: chatId, datos: { fecha_start: fechaStart, fecha_end: fechaEnd } }) }); const data = await res.json(); if (data.error) throw new Error(data.error); if (data.Lista_de_gastos && data.Lista_de_gastos.includes("No existen registros")) { document.getElementById('gastos-list-ul').innerHTML = '<div class="no-data-msg">ü§∑<br>No se encontraron gastos.</div>'; } else { const lines = data.Lista_de_gastos.split('\n').filter(line => line.includes('üÜî')); document.getElementById('gastos-list-ul').innerHTML = lines.map(line => `<li class="list-item" style="padding:10px 15px;">${line.replace(/\|/g, '<span style="margin:0 5px;">|</span>')}</li>`).join(''); } } catch (err) { document.getElementById('gastos-list-ul').innerHTML = `<div class="no-data-msg">‚ùå<br>Error al buscar.<br><small>${err.message}</small></div>`; } finally { hideSpinner(); } }
      async function renderGastoChart() { mainContent.innerHTML = ` <div class="list-container"> <div class="list-header"><button class="back-btn">‚Äπ</button><h2>Gr√°fico de Gastos</h2></div> <div class="form-card"><select id="gasto-chart-mes-select"><option value="">Selecciona un mes...</option>${(appData.counts.mesesActivosGastos || []).map(mes => `<option value="${mes}">${mes}</option>`).join('')}</select><div class="gasto-chart-container" id="chart-container"></div></div></div>`; document.querySelector('.back-btn').onclick = renderDashboard; document.getElementById('gasto-chart-mes-select').onchange = fetchAndDisplayGastoChart; }
      async function fetchAndDisplayGastoChart(event) { const mesAnio = event.target.value; if (!mesAnio) return; showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ Type: 'get_gastos_chart', chat_ID: chatId, mes_anio: mesAnio }) }); const data = await res.json(); if (data.error) throw new Error(data.error); let img = document.querySelector('#chart-container img'); if (!img) { img = document.createElement('img'); document.getElementById('chart-container').appendChild(img); } img.src = data.chartUrl; } catch (err) { showToast(err.message, true); } finally { hideSpinner(); } }

      // --- INICIO DE LA APP ---
      document.getElementById('tab-home').onclick = () => initializeAppContent();
      initializeAppContent();
    });
  </script>
</body>
</html>
