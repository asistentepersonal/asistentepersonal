<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Asistente Personal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#777; --primary:#4a76f3; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --menu-bg: #fff; --confirm-yes-bg: #28a745; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --badge-pending: #28a745; --badge-bought: #dc3545; --badge-notes: #3498db; --badge-reminders: #f39c12; --badge-calendar: #9b59b6; --badge-gastos: #1abc9c; --border-color: #eee; --header-bg: #fff; }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom:60px;-webkit-tap-highlight-color:transparent;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.1rem;font-weight:500;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;left:12px;color:#fff;border-radius:12px;min-width:24px;height:24px;padding:0 7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;line-height:24px;font-weight:500;}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:var(--badge-pending);} .card-badge.red{background-color:var(--badge-bought);} .card-badge.blue{background-color:var(--badge-notes);} .card-badge.orange{background-color:var(--badge-reminders);} .card-badge.purple{background-color:var(--badge-calendar);} .card-badge.teal{background-color:var(--badge-gastos);}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn{position:absolute;top:8px;right:8px;background:transparent;border:none;font-size:1.5rem;color:var(--muted);cursor:pointer;padding:5px;line-height:1;z-index:10;}
    .dropdown-menu{display:none;position:absolute;top:40px;right:10px;background-color:var(--menu-bg);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:50;overflow:hidden;min-width:150px;}
    .dropdown-menu.show{display:block;}
    .dropdown-item{padding:12px 20px;color:var(--text);cursor:pointer;display:block;text-align:left;}
    .dropdown-item:hover{background-color:var(--bg);}
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index:100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;transition:color 0.2s;}
    .tab.active{color:var(--primary);font-weight:bold;}
    .page-container{max-width:500px;margin:0 auto;padding:10px;}
    .page-header{display:flex;align-items:center;padding:10px;margin-bottom:10px;background:var(--header-bg);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);position:sticky;top:10px;z-index:99;}
    .back-btn{background:transparent;border:none;font-size:1.8rem;cursor:pointer;color:var(--muted);padding-right:15px;line-height:1;}
    .page-header h2{font-size:1.4rem;margin:0;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;margin-top:15px;}
    .form-card label{display:block;margin-top:16px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input,.form-card select{width:100%;margin-top:8px;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:1rem;color:var(--text);background:var(--bg);}
    .radio-group{display:flex;gap:15px;align-items:center;flex-wrap:wrap;margin-top:8px;}
    .form-card button{margin-top:20px;width:100%;padding:14px;background:var(--primary);color:var(--action-text);border:none;border-radius:8px;font-size:1.1rem;font-weight:500;cursor:pointer;transition:opacity .2s,background .2s;}
    .form-card button:disabled{background-color:var(--confirm-no-bg);cursor:not-allowed;}
    .list-item{background:var(--card-bg);border-radius:10px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 6px rgba(0,0,0,0.04);padding:15px;}
    .list-item-content{flex-grow:1;display:flex;flex-direction:column;text-align:left;}
    .list-item-title{font-weight:500;color:var(--text);}
    .list-item-subtitle{font-size:0.9rem;color:var(--muted);margin-top:4px;}
    .list-item-actions button{background:transparent;border:none;font-size:1.2rem;color:var(--muted);cursor:pointer;padding:5px;}
    .shopping-list-item{padding:10px;gap:10px;}
    .shopping-item-checkbox{width:20px;height:20px;margin-right:5px;}
    .shopping-item-details{flex-grow:1;text-align:left;}
    .shopping-item-date{font-size:0.8rem;color:var(--muted);margin-top:4px;display:block;}
    .shopping-list-section-title{font-size:1rem;color:var(--muted);padding:15px 5px 5px;font-weight:bold;border-bottom:1px solid var(--border-color);margin-bottom:10px;text-align:left;}
    .action-bar{padding:10px;position:sticky;bottom:60px;z-index:99;background:rgba(245,247,250,0.8);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:12px;}
    .action-bar button{width:100%;padding:14px;background:var(--primary);color:var(--action-text);border:none;border-radius:8px;font-size:1.1rem;font-weight:500;cursor:pointer;transition:opacity .3s, background-color .3s;}
    .action-bar button:disabled{background-color:var(--confirm-no-bg);cursor:not-allowed;}
    .note-item{padding:0;flex-direction:column;align-items:stretch;cursor:pointer;}
    .note-header{display:flex;align-items:center;justify-content:space-between;padding:15px;}
    .note-description{padding:0 15px;max-height:0;overflow:hidden;transition:max-height 0.3s ease-out, padding 0.3s ease-out;white-space:pre-wrap;word-wrap:break-word;text-align:left;border-top:1px solid transparent;}
    .note-item.open .note-description{max-height:500px;border-top:1px solid var(--border-color);padding-bottom:15px;}
    .no-data-msg{text-align:center;padding:60px 20px;font-size:1.2rem;color:var(--muted);}.no-data-msg span{font-size:3rem;display:block;margin-bottom:15px;}
    .gasto-chart-container{text-align:center;margin:20px 0;}
    .gasto-chart-container img{max-width:100%;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .gasto-legend{list-style:none;padding:15px 0 0 0;margin:0;display:flex;flex-wrap:wrap;justify-content:center;gap:15px;}
    .gasto-legend-item{display:flex;align-items:center;font-size:0.9rem;}
    .gasto-legend-color{width:12px;height:12px;border-radius:3px;margin-right:8px;}
    .date-filter-container{display:flex;gap:10px;margin-top:15px;}
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); text-align: left;}
    .event-item.open .event-description { display: block; }
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; display: none; }
    .toast{visibility:hidden;width:90%;max-width:480px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1001;font-size:1rem;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1002;}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1003;}
    .modal-content{background:var(--card-bg);padding:25px;border-radius:12px;text-align:center;width:90%;max-width:320px;box-shadow:0 5px 20px rgba(0,0,0,0.2);}
    .modal-content p{margin-bottom:20px;font-size:1.1rem;}
    .modal-actions{display:flex;gap:10px;}
    .modal-actions button{flex:1;padding:12px;border:none;border-radius:8px;font-size:1rem;cursor:pointer;font-weight:500;}
    #confirm-yes-btn{background:var(--confirm-yes-bg);color:var(--action-text);}
    #confirm-no-btn{background:var(--confirm-no-bg);color:var(--text);}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;bottom:60px;}to{opacity:1;bottom:80px;}}@keyframes fadeout{from{opacity:1;bottom:80px;}to{opacity:0;bottom:60px;}}
  </style>
</head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="main"></div>
  <div class="tabs"><div class="tab active" data-action="go-home">Home</div></div>
  <div id="toast" class="toast"></div>
  <div id="confirmation-modal" class="modal-overlay">
    <div class="modal-content">
      <p id="confirmation-message">¬øEst√°s seguro?</p>
      <div class="modal-actions"><button id="confirm-no-btn">No</button><button id="confirm-yes-btn">S√≠</button></div>
    </div>
  </div>
  
<script>
// =========================================================================================
// == APLICACI√ìN COMPLETA - V5 (ARQUITECTURA ROBUSTA Y M√ìDULOS COMPLETOS Y FUNCIONALES)
// =========================================================================================
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram?.WebApp;
    if (tg) {
        tg.expand(); tg.BackButton.hide();
        tg.onEvent('backButtonClicked', () => handleAction({ action: 'navigate-back' }));
        if (tg.themeParams) { Object.entries(tg.themeParams).forEach(([key, value]) => document.documentElement.style.setProperty(`--${key.replace(/_/g, '-')}`, value)); }
    }
    const webhookURL = 'https://script.google.com/macros/s/AKfycbxenwF0_F1yz0OJ7Kau7W2-HxqZqq5HIGD-GUdENpduign5J8xewpQJWBfGZpM04vHe/exec';
    let chatId = tg?.initDataUnsafe?.user?.id || prompt('MODO DESARROLLO: Ingresa tu chat_ID:', '6840956330');
    let appData = { counts: {}, remindersList: [], shoppingList: [], notesList: [] };
    const mainContent = document.getElementById('main');
    const spinner = document.getElementById('spinner');
    let navigationStack = [];

    const showSpinner = () => spinner.style.display = 'block';
    const hideSpinner = () => spinner.style.display = 'none';
    let toastTimer;
    const showToast = (msg, isError = false) => { clearTimeout(toastTimer); const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); toastTimer = setTimeout(() => t.className = 'toast', 3000); };
    const showConfirmation = (message, confirmText, onConfirm) => {
        document.getElementById('confirmation-message').textContent = message;
        const yesBtn = document.getElementById('confirm-yes-btn');
        yesBtn.textContent = confirmText;
        const modal = document.getElementById('confirmation-modal');
        modal.style.display = 'flex';
        const noBtn = document.getElementById('confirm-no-btn');
        const confirmHandler = () => { onConfirm(); cleanup(); };
        const cancelHandler = () => cleanup();
        const cleanup = () => { modal.style.display = 'none'; yesBtn.removeEventListener('click', confirmHandler); noBtn.removeEventListener('click', cancelHandler); };
        yesBtn.addEventListener('click', confirmHandler); noBtn.addEventListener('click', cancelHandler);
    };
    const apiCall = async (payload) => {
        showSpinner();
        try {
            const formData = new FormData();
            formData.append("postData", JSON.stringify({ chat_ID: chatId, ...payload }));
            const res = await fetch(webhookURL, { method: 'POST', body: formData });
            if (!res.ok) throw new Error(`Error de red: ${res.status}`);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            appData = data; return data;
        } catch (err) { console.error('Error en apiCall:', err); showToast(err.message || 'Error de conexi√≥n', true); throw err; } finally { hideSpinner(); }
    };

    const dashboardConfig = [
        { id: 'reminders', title: 'Recordatorios', icon: 'üóìÔ∏è', badge: { type: 'single', color: 'orange', value: () => appData.counts.remindersCount || 0 }, menuItems: [{ text: 'Ver Lista', action: 'navigate-to', target: 'renderRemindersList' }, { text: 'A√±adir', action: 'navigate-to', target: 'renderReminderForm' }] },
        { id: 'shopping', title: 'Compras', icon: 'üõí', badge: { type: 'group', values: [{ color: 'green', value: () => appData.counts.shoppingPendingCount || 0 }, { color: 'red', value: () => appData.counts.shoppingBoughtCount || 0 }] }, menuItems: [{ text: 'Ver Lista', action: 'navigate-to', target: 'renderShoppingList' }, { text: 'A√±adir Art√≠culo', action: 'navigate-to', target: 'renderAddArticleForm' }] },
        { id: 'notes', title: 'Notas', icon: 'üìù', badge: { type: 'single', color: 'blue', value: () => appData.counts.notesCount || 0 }, menuItems: [{ text: 'Ver Lista', action: 'navigate-to', target: 'renderNotesList' }, { text: 'Crear Nota', action: 'navigate-to', target: 'renderNoteForm' }] },
        { id: 'calendar', title: 'Calendario', icon: 'üìÖ', badge: { type: 'single', color: 'purple', value: () => appData.counts.calendarTodayCount || 0 }, menuItems: [{ text: 'Ver Agenda', action: 'navigate-to', target: 'renderAgendaView' }, { text: 'A√±adir Evento', action: 'navigate-to', target: 'renderEventForm' }] },
        { id: 'gastos', title: 'Gastos', icon: 'üí∞', badge: { type: 'single', color: 'teal', value: () => `${(appData.counts.gastosMesActual || '0,00').split(',')[0]}‚Ç¨` }, menuItems: [{ text: 'Ver Gr√°ficos', action: 'navigate-to', target: 'renderGastoChart' }, { text: 'Buscar Gastos', action: 'navigate-to', target: 'renderGastosList' }, { text: 'A√±adir Gasto', action: 'navigate-to', target: 'renderGastoForm' }] }
    ];

    const renderFunctions = { renderDashboard, renderRemindersList, renderReminderForm, renderShoppingList, renderAddArticleForm, renderNotesList, renderNoteForm, renderAgendaView, renderEventForm, renderGastoChart, renderGastosList, renderGastoForm };

    document.body.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        e.preventDefault(); e.stopPropagation();
        handleAction(target.dataset);
    });
    
    function handleAction(dataset) {
        const { action, id, value, target, confirm, confirmText } = dataset;
        const actionWithConfirmation = () => {
            switch (action) {
                case 'go-home': renderDashboard(); break;
                case 'navigate-to': navigateTo(renderFunctions[target], id, value); break; 
                case 'navigate-back': navigateBack(); break;
                case 'open-menu': toggleMenu(id); break;
                
                // Recordatorios
                case 'save-reminder': saveReminder(); break;
                case 'delete-reminder': deleteReminder(id); break;
                
                // Lista de la Compra
                case 'toggle-shopping-item': toggleShoppingItem(id); break;
                case 'delete-shopping-item': deleteShoppingItem(id); break;
                case 'check-reset-button': checkResetButtonState(); break;
                case 'reset-selected-bought': resetSelectedBoughtItems(); break;
                case 'add-article': addArticle(); break;
                
                // Notas
                case 'toggle-note-expand': document.getElementById(`note-item-${id}`).classList.toggle('open'); break;
                case 'save-note': saveNote(id); break;
                case 'delete-note': deleteNote(id); break;
                
                // Calendario
                case 'fetch-calendar-events': fetchAndRenderEvents(); break;
                case 'add-calendar-event': saveCalendarEvent(); break;
                case 'delete-calendar-event': deleteCalendarEvent(id); break;
                case 'edit-calendar-event': navigateTo(renderFunctions['renderEventForm'], id, value); break;

                // Gastos
                case 'fetch-gasto-chart': fetchAndDisplayGastoChart(document.getElementById('gasto-chart-mes-select').value); break;
                case 'fetch-gastos-list': fetchAndRenderGastosList(); break;
                case 'add-gasto': saveGasto(); break;
                case 'edit-gasto': navigateTo(renderFunctions['renderGastoForm'], id, value); break;
                case 'delete-gasto': deleteGasto(id); break;

                case 'initializeApp': initializeApp(); break;
            }
        };
        if (confirm) { showConfirmation(confirm, confirmText || 'S√≠', actionWithConfirmation); } else { actionWithConfirmation(); }
    }

    function navigateTo(renderFunc, ...args) { if (typeof renderFunc !== 'function') return; navigationStack.push({ func: renderFunc, args }); renderFunc(...args); tg?.BackButton.show(); }
    function navigateBack() { navigationStack.pop(); if (navigationStack.length > 0) { const { func, args } = navigationStack[navigationStack.length - 1]; func(...args); } else { renderDashboard(); tg?.BackButton.hide(); } }
    function toggleMenu(menuId) { const menu = document.getElementById(menuId); if (!menu) return; const isShown = menu.classList.contains('show'); document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show')); if (!isShown) menu.classList.add('show'); }
    
    function renderDashboard() {
        navigationStack = [{ func: renderDashboard, args: [] }]; tg?.BackButton.hide();
        const dashboardHtml = dashboardConfig.map(card => {
            const badgeHtml = card.badge.type === 'single' ? `<div class="card-badge ${card.badge.color}">${card.badge.value()}</div>` : `<div class="card-badge-group">${card.badge.values.map(b => `<div class="card-badge ${b.color}">${b.value()}</div>`).join('')}</div>`;
            const menuItemsHtml = card.menuItems.map(item => `<a class="dropdown-item" data-action="${item.action}" data-target="${item.target}" ${item.id ? `data-id="${item.id}"` : ''} ${item.value ? `data-value="${item.value}"` : ''}>${item.text}</a>`).join('');
            return `<div class="card">${badgeHtml}<button class="card-menu-btn" data-action="open-menu" data-id="menu-${card.id}">‚ãÆ</button><div class="card-icon">${card.icon}</div><div class="card-title">${card.title}</div><div class="dropdown-menu" id="menu-${card.id}">${menuItemsHtml}</div></div>`;
        }).join('');
        mainContent.innerHTML = `<div class="grid">${dashboardHtml}</div>`;
    }

    // --- M√ìDULO: RECORDATORIOS ---
    function renderRemindersList() {
        const reminders = appData.remindersList || [];
        const listHtml = (reminders.length > 0) ? reminders.map(item => `<div class="list-item"><div class="list-item-content"><span class="list-item-title">${item.Descripcion}</span><span class="list-item-subtitle">${item.Categoria}: ${item.Fecha}</span></div><div class="list-item-actions"><button data-action="delete-reminder" data-id="${item.tracking_code}" data-confirm="¬øEliminar recordatorio?" data-confirm-text="S√≠, eliminar">üóëÔ∏è</button></div></div>`).join('') : '<div class="no-data-msg"><span>üéâ</span>No tienes recordatorios.</div>';
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>Recordatorios</h2></div>${listHtml}</div><div class="action-bar"><button data-action="navigate-to" data-target="renderReminderForm">A√±adir Recordatorio</button></div>`;
    }
    function renderReminderForm() {
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>Nuevo Recordatorio</h2></div><div class="form-card"><label>Descripci√≥n</label><textarea id="reminder-desc" rows="3"></textarea><label>Fecha y hora</label><input type="text" id="reminder-time" placeholder="Selecciona fecha y hora..."><label>Tipo</label><div class="radio-group" id="reminder-type-group"><label><input type="radio" name="category" value="Un solo uso" checked> √önico</label><label><input type="radio" name="category" value="Diario"> Diario</label><label><input type="radio" name="category" value="Recurrente"> Recurrente</label></div><div id="recurrent-hours-container" style="display:none;"><label>Repetir cada...</label><select id="recurrent-hours">${[...Array(11)].map((_, i) => `<option value="${i + 2}">${i + 2} horas</option>`).join('')}</select></div><button id="save-reminder-btn" data-action="save-reminder" disabled>Crear Recordatorio</button></div></div>`;
        const descInput = document.getElementById('reminder-desc'); const saveBtn = document.getElementById('save-reminder-btn');
        const fp = flatpickr("#reminder-time", { enableTime: true, dateFormat: "Y-m-d H:i", locale: "es", minDate: "today", onChange: validateReminderForm });
        document.querySelectorAll('input[name="category"]').forEach(radio => radio.onchange = () => { document.getElementById('recurrent-hours-container').style.display = document.querySelector('input[name="category"]:checked').value === 'Recurrente' ? 'block' : 'none'; validateReminderForm(); });
        descInput.oninput = validateReminderForm;
        function validateReminderForm() { saveBtn.disabled = !(descInput.value.trim() && fp.selectedDates.length > 0); }
    }
    async function saveReminder() {
        const payload = { Type: 'add_reminder', description: document.getElementById('reminder-desc').value.trim(), time: document.getElementById('reminder-time')._flatpickr.selectedDates[0].toISOString(), category: document.querySelector('input[name="category"]:checked').value, horas_recurrentes: document.getElementById('recurrent-hours').value };
        handleAction({action: 'navigate-back'}); showToast('Guardando...');
        try { await apiCall(payload); renderRemindersList(); showToast('Recordatorio guardado'); } catch (err) { await apiCall({ Type: 'get_full_dashboard' }); renderRemindersList(); }
    }
    async function deleteReminder(trackingCode) { const originalData = JSON.parse(JSON.stringify(appData)); appData.remindersList = appData.remindersList.filter(r => r.tracking_code !== trackingCode); appData.counts.remindersCount--; renderRemindersList(); try { await apiCall({ Type: 'delete_reminder', tracking_code: trackingCode }); showToast('Recordatorio eliminado'); } catch (err) { appData = originalData; renderRemindersList(); } }

    // --- M√ìDULO: LISTA DE LA COMPRA ---
    function renderShoppingList() {
        const items = appData.shoppingList || []; const pending = items.filter(i => i['2'] === 'Pendiente'); const bought = items.filter(i => i['2'] === 'Comprado'); let html = '';
        if (pending.length > 0) { html += '<div class="shopping-list-section-title">Pendientes</div>'; html += pending.map(item => `<div class="list-item shopping-list-item" data-action="toggle-shopping-item" data-id="${item['3']}"><div class="shopping-item-details"><button style="background:var(--pending-bg);color:white;border:none;padding:10px;border-radius:8px;width:100%;text-align:left;">${item['1']}</button></div><div class="list-item-actions"><button data-action="delete-shopping-item" data-id="${item['3']}" data-confirm="¬øEliminar este art√≠culo?" data-confirm-text="S√≠, eliminar">üóëÔ∏è</button></div></div>`).join(''); }
        if (bought.length > 0) { html += '<div class="shopping-list-section-title">Comprados</div>'; html += bought.map(item => `<div class="list-item shopping-list-item"><input type="checkbox" class="shopping-item-checkbox" data-action="check-reset-button" data-id="${item['3']}"><div class="shopping-item-details" data-action="toggle-shopping-item" data-id="${item['3']}"><button style="background:var(--bought-bg);color:white;border:none;padding:10px;border-radius:8px;width:100%;text-align:left;text-decoration:line-through">${item['1']}<span class="shopping-item-date">${item['4']}</span></button></div><div class="list-item-actions"><button data-action="delete-shopping-item" data-id="${item['3']}" data-confirm="¬øEliminar este art√≠culo?" data-confirm-text="S√≠, eliminar">üóëÔ∏è</button></div></div>`).join(''); }
        if (items.length === 0) { html = '<div class="no-data-msg"><span>üõí</span>Tu lista est√° vac√≠a.</div>'; }
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>Lista de Compras</h2></div>${html}</div><div class="action-bar">${bought.length > 0 ? '<button id="reset-bought-btn" data-action="reset-selected-bought" disabled>Pasar a Pendiente</button>' : ''}<button data-action="navigate-to" data-target="renderAddArticleForm" style="margin-top:10px;">A√±adir Art√≠culo</button></div>`;
    }
    function checkResetButtonState() { const btn = document.getElementById('reset-bought-btn'); if(btn) btn.disabled = document.querySelectorAll('.shopping-item-checkbox:checked').length === 0; }
    async function toggleShoppingItem(trackingCode) { const originalData = JSON.parse(JSON.stringify(appData)); const item = appData.shoppingList.find(i => i['3'] === trackingCode); const newStatus = item['2'] === 'Pendiente' ? 'Comprado' : 'Pendiente'; item['2'] = newStatus; if (newStatus === 'Comprado') { appData.counts.shoppingPendingCount--; appData.counts.shoppingBoughtCount++; } else { appData.counts.shoppingPendingCount++; appData.counts.shoppingBoughtCount--; } renderShoppingList(); try { await apiCall({ Type: 'toggle_item_status', tracking_code: trackingCode, new_status: newStatus }); } catch (err) { appData = originalData; renderShoppingList(); } }
    async function resetSelectedBoughtItems() { const selectedIds = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.id); if (selectedIds.length === 0) return; const originalData = JSON.parse(JSON.stringify(appData)); let changedCount = 0; appData.shoppingList.forEach(item => { if (selectedIds.includes(item['3'])) { item['2'] = 'Pendiente'; changedCount++; } }); appData.counts.shoppingPendingCount += changedCount; appData.counts.shoppingBoughtCount -= changedCount; renderShoppingList(); try { await apiCall({ Type: 'toggle_multiple_to_pending', tracking_codes: selectedIds }); showToast(`${changedCount} art√≠culo(s) movidos`); } catch(err) { appData = originalData; renderShoppingList(); } }
    function renderAddArticleForm() { mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>A√±adir Art√≠culo</h2></div><div class="form-card"><label>Nombre del art√≠culo</label><textarea id="article-desc" rows="2"></textarea><button data-action="add-article">A√±adir a la Lista</button></div></div>`; }
    async function addArticle() { const description = document.getElementById('article-desc').value.trim(); if (!description) return; handleAction({action: 'navigate-back'}); showToast('A√±adiendo...'); try { await apiCall({ Type: 'add_articulo', description }); renderShoppingList(); showToast('Art√≠culo a√±adido'); } catch (err) { await apiCall({ Type: 'get_full_dashboard' }); renderShoppingList(); } }
    async function deleteShoppingItem(trackingCode) { const originalData = JSON.parse(JSON.stringify(appData)); const item = appData.shoppingList.find(i => i['3'] === trackingCode); if (item['2'] === 'Pendiente') appData.counts.shoppingPendingCount--; else appData.counts.shoppingBoughtCount--; appData.shoppingList = appData.shoppingList.filter(i => i['3'] !== trackingCode); renderShoppingList(); try { await apiCall({ Type: 'delete_item_shopping_list', tracking_code: trackingCode }); showToast('Art√≠culo eliminado'); } catch (err) { appData = originalData; renderShoppingList(); } }

    // --- M√ìDULO: NOTAS ---
    function renderNotesList() {
        const notes = appData.notesList || [];
        const listHtml = (notes.length > 0) ? notes.map(note => `<div class="list-item note-item" id="note-item-${note.Nota_ID}" data-action="toggle-note-expand" data-id="${note.Nota_ID}"><div class="note-header"><div class="list-item-content"><span class="list-item-title">${note.Titulo}</span><span class="list-item-subtitle">${note.Fecha}</span></div><div class="list-item-actions"><button data-action="navigate-to" data-target="renderNoteForm" data-id="${note.Nota_ID}">‚úèÔ∏è</button><button data-action="delete-note" data-id="${note.Nota_ID}" data-confirm="¬øEliminar esta nota?" data-confirm-text="S√≠, eliminar">üóëÔ∏è</button></div></div><div class="note-description">${note.Descripcion}</div></div>`).join('') : '<div class="no-data-msg"><span>üìù</span>No tienes notas.</div>';
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>Mis Notas</h2></div>${listHtml}</div><div class="action-bar"><button data-action="navigate-to" data-target="renderNoteForm">Crear Nota</button></div>`;
    }
    function renderNoteForm(noteId) {
        const isEditing = !!noteId; const note = isEditing ? appData.notesList.find(n => n.Nota_ID === noteId) : { Titulo: '', Descripcion: ''};
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>${isEditing ? 'Editar Nota' : 'Nueva Nota'}</h2></div><div class="form-card"><label>T√≠tulo</label><input type="text" id="note-title" value="${note.Titulo}"><label>Descripci√≥n</label><textarea id="note-description" rows="8">${note.Descripcion}</textarea><button id="save-note-btn" data-action="save-note" data-id="${noteId || ''}" ${!isEditing && !note.Titulo.trim() ? 'disabled' : ''}>${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button></div></div>`;
        const titleInput = document.getElementById('note-title'); const saveBtn = document.getElementById('save-note-btn');
        titleInput.oninput = () => { saveBtn.disabled = titleInput.value.trim() === ''; };
    }
    async function saveNote(noteId) {
        const isEditing = !!noteId; const title = document.getElementById('note-title').value.trim(); const description = document.getElementById('note-description').value.trim(); if(!title) return;
        const payload = { Type: isEditing ? 'edit_note' : 'add_note', note_id: noteId, title, description };
        handleAction({action: 'navigate-back'}); showToast('Guardando...');
        try { await apiCall(payload); renderNotesList(); showToast(`Nota ${isEditing ? 'actualizada' : 'creada'}`); } catch (err) { await apiCall({ Type: 'get_full_dashboard' }); renderNotesList(); }
    }
    async function deleteNote(noteId) { const originalData = JSON.parse(JSON.stringify(appData)); appData.notesList = appData.notesList.filter(n => n.Nota_ID !== noteId); appData.counts.notesCount--; renderNotesList(); try { await apiCall({ Type: 'delete_note', note_id: noteId }); showToast('Nota eliminada'); } catch (err) { appData = originalData; renderNotesList(); } }
    
    // --- M√ìDULO: CALENDARIO ---
    function renderAgendaView() {
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>Agenda</h2></div><div class="form-card"><label>Buscar eventos entre fechas:</label><div class="date-filter-container"><input type="text" id="agenda-start-date" placeholder="Desde..."><input type="text" id="agenda-end-date" placeholder="Hasta..."><button data-action="fetch-calendar-events">Buscar</button></div></div><div id="agenda-list-container"></div></div><div class="action-bar"><button data-action="navigate-to" data-target="renderEventForm">A√±adir Evento</button></div>`;
        const today = new Date();
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        flatpickr("#agenda-start-date", { defaultDate: startOfMonth, locale: "es", onChange: () => document.querySelector('[data-action="fetch-calendar-events"]').click() });
        flatpickr("#agenda-end-date", { defaultDate: endOfMonth, locale: "es", onChange: () => document.querySelector('[data-action="fetch-calendar-events"]').click() });
        fetchAndRenderEvents();
    }
    async function fetchAndRenderEvents() {
        const container = document.getElementById('agenda-list-container');
        container.innerHTML = '<div class="no-data-msg"><span>Buscando...</span></div>';
        const startDate = document.getElementById('agenda-start-date')._flatpickr.selectedDates[0];
        const endDate = document.getElementById('agenda-end-date')._flatpickr.selectedDates[0];
        if (!startDate || !endDate) { container.innerHTML = '<div class="no-data-msg"><span>üóìÔ∏è</span>Selecciona un rango de fechas.</div>'; return; }
        try {
            const payload = { Type: 'get_calendar_events', startDate: startDate.toISOString(), endDate: endDate.toISOString() };
            const events = await apiCall(payload);
            const groupedEvents = events.reduce((acc, event) => {
                const dayKey = new Date(event.start).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                if (!acc[dayKey]) acc[dayKey] = [];
                acc[dayKey].push(event);
                return acc;
            }, {});
            let listHtml = '';
            if (Object.keys(groupedEvents).length > 0) {
                for (const day in groupedEvents) {
                    listHtml += `<h3 class="day-header">${day}</h3>`;
                    listHtml += groupedEvents[day].map(event => {
                        const startTime = new Date(event.start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                        const endTime = new Date(event.end).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                        return `<div class="list-item note-item" id="event-item-${event.id}" data-action="toggle-note-expand" data-id="${event.id}"><div class="note-header"><div class="list-item-content"><span class="list-item-title">${event.summary}</span><span class="list-item-subtitle">${startTime} - ${endTime}</span></div><div class="list-item-actions"><button data-action="edit-calendar-event" data-id="${event.id}">‚úèÔ∏è</button><button data-action="delete-calendar-event" data-id="${event.id}" data-confirm="¬øEliminar evento?" data-confirm-text="S√≠, eliminar">üóëÔ∏è</button><a href="${event.htmlLink}" target="_blank" style="margin-left: 5px;">üîó</a></div></div><div class="event-description">${event.description || 'No hay descripci√≥n.'}</div></div>`;
                    }).join('');
                }
            } else { listHtml = '<div class="no-data-msg"><span>üóìÔ∏è</span>No hay eventos en este rango.</div>'; }
            container.innerHTML = listHtml;
        } catch(err) { container.innerHTML = '<div class="no-data-msg"><span>‚ùå</span>Error al cargar eventos.</div>'; showToast(err.message, true); }
    }
    function renderEventForm(eventId = null) {
        const isEditing = !!eventId; const event = isEditing ? appData.calendarEvents.find(e => e.id === eventId) : {};
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>${isEditing ? 'Editar Evento' : 'Nuevo Evento'}</h2></div><div class="form-card"><label>T√≠tulo</label><input type="text" id="event-summary" value="${event.summary || ''}"><label>Inicio</label><input type="text" id="event-start" placeholder="Fecha y hora de inicio"><label>Fin</label><input type="text" id="event-end" placeholder="Fecha y hora de fin"><label>Descripci√≥n</label><textarea id="event-description" rows="4">${event.description || ''}</textarea><label>Ubicaci√≥n</label><input type="text" id="event-location" value="${event.location || ''}"><label>Recordatorio (minutos antes)</label><select id="event-reminder-minutes"><option value="0">Ninguno</option><option value="5">5 min antes</option><option value="15" selected>15 min antes</option><option value="30">30 min antes</option><option value="60">1 hora antes</option><option value="1440">1 d√≠a antes</option></select><button id="save-event-btn" data-action="add-calendar-event" data-id="${eventId || ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Evento'}</button></div></div>`;
        const summaryInput = document.getElementById('event-summary'); const saveBtn = document.getElementById('save-event-btn');
        const fpStart = flatpickr("#event-start", { enableTime: true, dateFormat: "Y-m-d H:i", locale: "es", defaultDate: isEditing ? event.start : new Date(), onChange: validateEventForm });
        const fpEnd = flatpickr("#event-end", { enableTime: true, dateFormat: "Y-m-d H:i", locale: "es", defaultDate: isEditing ? event.end : new Date(new Date().getTime() + 3600000), onChange: validateEventForm }); // +1hr by default
        summaryInput.oninput = validateEventForm;
        if (isEditing && event.reminders && event.reminders.overrides && event.reminders.overrides.length > 0) { document.getElementById('event-reminder-minutes').value = event.reminders.overrides[0].minutes; }
        function validateEventForm() { saveBtn.disabled = !(summaryInput.value.trim() && fpStart.selectedDates.length > 0 && fpEnd.selectedDates.length > 0 && fpEnd.selectedDates[0] > fpStart.selectedDates[0]); }
    }
    async function saveCalendarEvent() {
        const eventId = document.getElementById('save-event-btn').dataset.id; const isEditing = !!eventId;
        const payload = {
            Type: isEditing ? 'edit_calendar_event' : 'add_calendar_event',
            eventId: eventId,
            eventData: {
                summary: document.getElementById('event-summary').value,
                start: document.getElementById('event-start')._flatpickr.selectedDates[0].toISOString(),
                end: document.getElementById('event-end')._flatpickr.selectedDates[0].toISOString(),
                description: document.getElementById('event-description').value,
                location: document.getElementById('event-location').value,
                reminderMinutes: parseInt(document.getElementById('event-reminder-minutes').value)
            }
        };
        handleAction({action: 'navigate-back'}); showToast('Guardando...');
        try { await apiCall(payload); await apiCall({ Type: 'get_full_dashboard' }); renderAgendaView(); showToast(`Evento ${isEditing ? 'actualizado' : 'creado'}`); } catch (err) { await apiCall({ Type: 'get_full_dashboard' }); renderAgendaView(); }
    }
    async function deleteCalendarEvent(eventId) { try { await apiCall({ Type: 'delete_calendar_event', eventId: eventId }); showToast('Evento eliminado'); await apiCall({ Type: 'get_full_dashboard' }); renderAgendaView(); } catch (err) { showToast(err.message, true); await apiCall({ Type: 'get_full_dashboard' }); renderAgendaView(); } }

    // --- M√ìDULO: GASTOS ---
    function renderGastoChart() {
        const mesesOptions = (appData.counts.mesesActivosGastos || []).map(mes => `<option value="${mes}">${mes}</option>`).sort((a,b) => b.localeCompare(a)).join(''); // Ordenar de m√°s reciente a m√°s antiguo
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>An√°lisis de Gastos</h2></div><div class="form-card"><label>Ver detalle por Mes</label><select id="gasto-chart-mes-select" data-action="fetch-gasto-chart">${mesesOptions ? `<option value="">Selecciona un mes...</option>${mesesOptions}` : '<option value="">No hay datos</option>'}</select><div id="chart-content"><div class="no-data-msg"><span>üìä</span>Selecciona un mes para ver los gr√°ficos.</div></div></div><div class="form-card" style="margin-top:20px;"><label>Evoluci√≥n General</label><div class="gasto-chart-container" id="chart-container-monthly"></div></div></div>`;
        fetchAndDisplayGastoChart(); // Fetch general chart on load
    }
    async function fetchAndDisplayGastoChart(mesAnio = '') {
        const chartContent = document.getElementById('chart-content');
        const monthlyContainer = document.getElementById('chart-container-monthly');
        showSpinner();
        try {
            const payload = { Type: 'get_gastos_chart', mes_anio: mesAnio };
            const data = await apiCall(payload);
            
            if (mesAnio) {
                const legendHtml = (data.datosParaLeyenda?.length > 0) ? `<ul class="gasto-legend">${data.datosParaLeyenda.map(item => `<li class="gasto-legend-item"><span class="gasto-legend-color" style="background-color:${item.color};"></span>${item.categoria}: <strong>${item.importe}‚Ç¨</strong></li>`).join('')}</ul>` : '';
                chartContent.innerHTML = `<div class="gasto-chart-container">${data.pieChartUrl ? `<img src="${data.pieChartUrl}">` : ''}</div>${legendHtml}<hr style="margin:25px 0;border:0;border-top:1px solid var(--border-color);"><div class="gasto-chart-container">${data.dailyLineChartUrl ? `<img src="${data.dailyLineChartUrl}">` : ''}</div>`;
            } else {
                chartContent.innerHTML = `<div class="no-data-msg"><span>üìä</span>Selecciona un mes para ver los gr√°ficos.</div>`;
            }
            if (data.monthlyBarChartUrl) { monthlyContainer.innerHTML = `<img src="${data.monthlyBarChartUrl}">`; }
        } catch (err) { showToast(err.message, true); chartContent.innerHTML = `<div class="no-data-msg"><span>‚ùå</span>Error al cargar gr√°ficos.</div>`; } finally { hideSpinner(); }
    }
    function renderGastosList() {
        mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>Buscar Gastos</h2></div><div class="form-card"><label>Rango de Fechas:</label><div class="date-filter-container"><input type="text" id="gastos-start-date" placeholder="Desde..."><input type="text" id="gastos-end-date" placeholder="Hasta..."><button data-action="fetch-gastos-list">Buscar</button></div></div><div id="gastos-list-container"></div></div>`;
        const today = new Date();
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        flatpickr("#gastos-start-date", { defaultDate: startOfMonth, locale: "es" });
        flatpickr("#gastos-end-date", { defaultDate: endOfMonth, locale: "es" });
        fetchAndRenderGastosList();
    }
    async function fetchAndRenderGastosList() {
        const container = document.getElementById('gastos-list-container');
        container.innerHTML = '<div class="no-data-msg"><span>Buscando...</span></div>';
        const startDate = document.getElementById('gastos-start-date')._flatpickr.selectedDates[0];
        const endDate = document.getElementById('gastos-end-date')._flatpickr.selectedDates[0];
        if (!startDate || !endDate) { container.innerHTML = '<div class="no-data-msg"><span>üîç</span>Selecciona un rango de fechas.</div>'; return; }
        try {
            const payload = { Type: 'get_gastos_por_fecha', fecha_start: startDate.toLocaleDateString('es-ES'), fecha_end: endDate.toLocaleDateString('es-ES') };
            const data = await apiCall(payload);
            let listHtml = '';
            if (data.Lista_de_gastos && data.Lista_de_gastos !== "No existen registros para este periodo.") {
                const gastosArray = data.Lista_de_gastos.split('\n\n')[1].split('\n').map(gasto => {
                    const parts = gasto.match(/üóì (.+?) \| üõç (.+?) \| üíµ (.+?)‚Ç¨ \| üõí (.+?) \| üÜî (.+)/);
                    return parts ? { fecha: parts[1], establecimiento: parts[2], importe: parts[3], categoria: parts[4], id_unico: parts[5] } : null;
                }).filter(Boolean);
                listHtml += gastosArray.map(g => `<div class="list-item" id="gasto-item-${g.id_unico}"><div class="list-item-content"><span class="list-item-title">${g.establecimiento} (${g.importe}‚Ç¨)</span><span class="list-item-subtitle">${g.fecha} | ${g.categoria}</span></div><div class="list-item-actions"><button data-action="edit-gasto" data-id="${g.id_unico}">‚úèÔ∏è</button><button data-action="delete-gasto" data-id="${g.id_unico}" data-confirm="¬øEliminar gasto?" data-confirm-text="S√≠, eliminar">üóëÔ∏è</button></div></div>`).join('');
            } else { listHtml = '<div class="no-data-msg"><span>üîé</span>No existen gastos para este periodo.</div>'; }
            container.innerHTML = listHtml;
        } catch(err) { container.innerHTML = '<div class="no-data-msg"><span>‚ùå</span>Error al buscar gastos.</div>'; showToast(err.message, true); }
    }
    function renderGastoForm(gastoId = null) {
        const isEditing = !!gastoId; let gasto = {};
        if (isEditing) {
            // Fetch single expense for editing
            showSpinner();
            apiCall({ Type: 'get_gasto_by_id', ID_Unico: gastoId }).then(data => {
                gasto = data;
                if (gasto.error) { showToast(gasto.error, true); handleAction({action: 'navigate-back'}); return; }
                renderGastoFormHTML(gasto, isEditing);
            }).catch(err => { showToast(err.message, true); handleAction({action: 'navigate-back'}); }).finally(hideSpinner);
        } else {
            renderGastoFormHTML(gasto, isEditing);
        }
        function renderGastoFormHTML(currentGasto, isEdit) {
            mainContent.innerHTML = `<div class="page-container"><div class="page-header"><button class="back-btn" data-action="navigate-back">‚Äπ</button><h2>${isEdit ? 'Editar Gasto' : 'Nuevo Gasto'}</h2></div><div class="form-card"><label>Fecha</label><input type="text" id="gasto-fecha" placeholder="Selecciona fecha"><label>Establecimiento</label><input type="text" id="gasto-establecimiento" value="${currentGasto.Establecimiento || ''}"><label>Importe (‚Ç¨)</label><input type="number" step="0.01" id="gasto-importe" value="${currentGasto.Importe || ''}"><label>Categor√≠a</label><input type="text" id="gasto-categoria" value="${currentGasto.categoria || ''}"><label>Sub-Categor√≠a</label><input type="text" id="gasto-subcategoria" value="${currentGasto.sub_categoria || ''}"><button id="save-gasto-btn" data-action="add-gasto" data-id="${gastoId || ''}" disabled>${isEdit ? 'Guardar Cambios' : 'Registrar Gasto'}</button></div></div>`;
            const fechaInput = document.getElementById('gasto-fecha'); const establecimientoInput = document.getElementById('gasto-establecimiento'); const importeInput = document.getElementById('gasto-importe'); const saveBtn = document.getElementById('save-gasto-btn');
            const fp = flatpickr(fechaInput, { dateFormat: "Y-m-d", locale: "es", defaultDate: isEdit ? currentGasto.Fecha : new Date(), onChange: validateGastoForm });
            establecimientoInput.oninput = validateGastoForm; importeInput.oninput = validateGastoForm;
            function validateGastoForm() { saveBtn.disabled = !(establecimientoInput.value.trim() && parseFloat(importeInput.value) > 0 && fp.selectedDates.length > 0); }
        }
    }
    async function saveGasto() {
        const gastoId = document.getElementById('save-gasto-btn').dataset.id; const isEditing = !!gastoId;
        const payload = {
            Type: isEditing ? 'edit_gasto' : 'add_gasto',
            ID_Unico: gastoId || `G-${Math.random().toString(36).substring(2, 9).toUpperCase()}`, // Generate new ID if creating
            Fecha: document.getElementById('gasto-fecha')._flatpickr.selectedDates[0].toISOString(),
            Establecimiento: document.getElementById('gasto-establecimiento').value.trim(),
            Importe: parseFloat(document.getElementById('gasto-importe').value),
            categoria: document.getElementById('gasto-categoria').value.trim(),
            sub_categoria: document.getElementById('gasto-subcategoria').value.trim()
        };
        handleAction({action: 'navigate-back'}); showToast('Guardando...');
        try { await apiCall(payload); await apiCall({ Type: 'get_full_dashboard' }); renderGastosList(); showToast(`Gasto ${isEditing ? 'actualizado' : 'registrado'}`); } catch (err) { await apiCall({ Type: 'get_full_dashboard' }); renderGastosList(); }
    }
    async function deleteGasto(gastoId) { try { await apiCall({ Type: 'delete_gasto_id', ID_Unico: gastoId }); showToast('Gasto eliminado'); await apiCall({ Type: 'get_full_dashboard' }); renderGastosList(); } catch (err) { showToast(err.message, true); await apiCall({ Type: 'get_full_dashboard' }); renderGastosList(); } }

    async function initializeApp() {
        showSpinner();
        try { await apiCall({ Type: 'get_full_dashboard' }); renderDashboard(); } catch (err) { mainContent.innerHTML = `<div class="no-data-msg"><span>‚ùå</span>Error al cargar.<br><small>${err.message}</small><br><br><button data-action="initializeApp">Reintentar</button></div>`; } finally { hideSpinner(); }
    }
    initializeApp();
});
</script>
</body>
</html>
