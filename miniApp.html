<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; --edit-icon-color: #007bff; --checkbox-border: #ddd; --checkbox-checked-bg: var(--primary); }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:.9rem;}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;left:12px;}
    .card-badge.red{background-color:#e74c3c;right:12px;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; overflow: hidden; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 12px 20px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .dropdown-item:hover { background-color: var(--bg); }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container{max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card h2{margin-bottom:16px;font-size:1.4rem;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input,.form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text);}
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center;}
    .radio-group.input-error { border: 1px solid var(--error-bg); border-radius: 8px; padding: 5px; }
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1001;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .reminder-list, .shopping-list, .notes-list, .agenda-view { list-style: none; padding: 0; margin: 0; }
    .reminder-item, .shopping-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .reminder-details, .shopping-details { display: flex; flex-direction: column; flex-grow: 1; }
    .reminder-text, .shopping-text { font-size: 1.1rem; font-weight: 500; }
    .reminder-date, .shopping-date { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .reminder-actions { display: flex; align-items: center; gap: 5px; }
    .reminder-delete-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .reminder-delete-btn:hover { color: var(--delete-bg); }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-reminders, .no-shopping-items, .no-notes, .no-events { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; }
    #main:empty { display: none; }
    .shopping-list-header-row { display: flex; align-items: center; justify-content: flex-end; padding: 0 10px 10px 10px; color: var(--muted); font-size: 0.9rem; }
    .shopping-list-header-row input[type="checkbox"] { margin-left: 5px; }
    .shopping-item { display: flex; align-items: center; gap: 5px; padding: 10px; }
    .shopping-item-checkbox-wrapper { flex-shrink: 0; margin-right: 8px; }
    .shopping-item input[type="checkbox"] { appearance: none; -webkit-appearance: none; -moz-appearance: none; width: 20px; height: 20px; border: 2px solid var(--checkbox-border); border-radius: 4px; background-color: var(--card-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background-color 0.2s, border-color 0.2s; }
    .shopping-item input[type="checkbox"]::after { content: '‚úî'; font-size: 14px; color: var(--action-text); display: none; }
    .shopping-item input[type="checkbox"]:checked { background-color: var(--checkbox-checked-bg); border-color: var(--checkbox-checked-bg); }
    .shopping-item input[type="checkbox"]:checked::after { display: block; }
    .shopping-item-toggle-btn { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; color: var(--list-item-text); cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: background-color 0.2s ease, transform 0.1s ease; }
    .shopping-item-toggle-btn:active { transform: translateY(1px); }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); }
    .shopping-item-toggle-btn .item-date { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; }
    .shopping-item-menu-container { position: relative; flex-shrink: 0; margin-left: auto; }
    .shopping-item-menu-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; }
    .shopping-item-menu-btn:hover { color: var(--primary); }
    .shopping-item-dropdown-menu { display: none; position: absolute; top: 30px; right: 0; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .shopping-item-dropdown-menu.show { display: block; }
    .shopping-item-dropdown-item { padding: 10px 15px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .shopping-item-dropdown-item:hover { background-color: var(--bg); }
    .add-article-btn-container { padding: 10px; text-align: center; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .add-article-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; flex-grow: 1; max-width: 250px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
    .add-article-btn:active { transform: translateY(1px); }
    .multi-select-action-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: not-allowed; opacity: 0.6; flex-grow: 1; max-width: 250px; transition: opacity 0.2s; }
    .multi-select-action-btn.enabled { cursor: pointer; opacity: 1; }
    .shopping-list-section-title { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 10px 10px 10px; padding-top: 10px; border-top: 1px solid var(--muted); text-align: left; }
    .shopping-list-section-title:first-of-type { border-top: none; margin-top: 0; }
    .note-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .note-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; }
    .note-header-interactive { flex-grow: 1; padding-right: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .note-title-section { display: flex; flex-direction: column; text-align: left; }
    .note-title { font-size: 1.1rem; font-weight: 500; }
    .note-date { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .note-menu-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; z-index: 5; flex-shrink: 0; }
    .note-description { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); }
    .note-item.open .note-description { max-height: 500px; padding: 0 15px 15px; }
    .note-dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .note-dropdown-menu.show { display: block; }
    .expand-arrow { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
    .note-item.open .expand-arrow { transform: rotate(180deg); }
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid var(--muted); }
    .event-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .event-details { text-align: left; flex-grow: 1; cursor: pointer;}
    .event-time { font-weight: 600; }
    .event-summary { font-size: 1.1rem; }
    .event-menu-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; flex-shrink: 0; }
    .event-dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .event-dropdown-menu.show { display: block; }
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; }
  </style>
</head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="main"></div>
  <div class="tabs">
    <div class="tab active" id="tab-home">Home</div>
  </div>
  <div id="toast" class="toast"></div>
  
  <script>
    (function() { const params = new URLSearchParams(window.location.search); if (!params.has('v')) { const newUrl = new URL(window.location.href); newUrl.searchParams.set('v', new Date().getTime()); window.location.replace(newUrl.href); } })();

    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.expand();
        if (tg.themeParams) {
            document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa');
            document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff');
            document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333');
            document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555');
            document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3');
            document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff');
            document.documentElement.style.setProperty('--menu-bg', tg.themeParams.secondary_bg_color || '#ffffff');
            document.documentElement.style.setProperty('--confirm-yes-bg', tg.themeParams.destructive_text_color || '#e74c3c');
            document.documentElement.style.setProperty('--confirm-no-bg', tg.themeParams.button_color || '#cccccc');
            document.documentElement.style.setProperty('--pending-bg', tg.themeParams.button_color || '#28a745');
            document.documentElement.style.setProperty('--bought-bg', tg.themeParams.destructive_text_color || '#dc3545');
            document.documentElement.style.setProperty('--list-item-text', tg.themeParams.button_text_color || '#fff');
            document.documentElement.style.setProperty('--edit-icon-color', tg.themeParams.link_color || '#007bff');
            document.documentElement.style.setProperty('--checkbox-border', tg.themeParams.hint_color || '#ddd');
            document.documentElement.style.setProperty('--checkbox-checked-bg', tg.themeParams.button_color || '#4a76f3');
        }
      }
      
      const webhookURL = 'https://script.google.com/macros/s/AKfycbw3KSGoSdoEgfPIysm6Uo6mzd4Sc6ePCMZoTyOgFpI8jB61ejkhYTNrOiuspAJ5_Ql93g/exec';
      let chatId = tg?.initDataUnsafe?.user?.id;
      if (!chatId) { chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', ''); }

      let lastCount = { reminders: 0, shoppingPending: 0, shoppingBought: 0, notes: 0, calendarToday: 0 }, toastTimer; 
      const mainContent = document.getElementById('main');
      const spinner = document.getElementById('spinner');

      function showSpinner() { spinner.style.display = 'block'; }
      function hideSpinner() { spinner.style.display = 'none'; }
      function showToast(msg, isError = false) { clearTimeout(toastTimer); const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); }
      async function fetchWithTimeout(resource, options = {}, timeout = 30000) { const controller = new AbortController(); const id = setTimeout(() => controller.abort(), timeout); try { const modifiedOptions = { ...options, signal: controller.signal, method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: options.body }; const response = await fetch(resource, modifiedOptions); clearTimeout(id); return response; } catch (error) { clearTimeout(id); if (error.name === 'AbortError') throw new Error('Timeout: La solicitud tard√≥ demasiado.'); throw error; } }

      async function initializeAppContent() {
        showSpinner();
        try {
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_initial_counts' }) });
          if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          lastCount.reminders = data.remindersCount || 0;
          lastCount.shoppingPending = data.shoppingPendingCount || 0;
          lastCount.shoppingBought = data.shoppingBoughtCount || 0;
          lastCount.notes = data.notesCount || 0;
          lastCount.calendarToday = data.calendarTodayCount || 0;
        } catch (err) {
          console.error('Error en la carga inicial:', err);
          showToast(`Error al cargar datos: ${err.message}`, true);
        } finally {
          renderDashboard();
          hideSpinner();
        }
      }

      function renderDashboard() {
        setActiveTab('tab-home');
        mainContent.innerHTML = `
          <div class="grid">
            <div class="card" id="card-recordatorios-wrapper">
              <div class="card-badge red" style="left:12px;">${lastCount.reminders ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="recordatorios">‚ãÆ</button>
              <div class="card-icon">üóìÔ∏è</div><div class="card-title">Recordatorios</div>
              <div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">A√±adir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-shopping-list-wrapper">
              <div class="card-badge-group"><div class="card-badge green">${lastCount.shoppingPending ?? '...'}</div><div class="card-badge red">${lastCount.shoppingBought ?? '...'}</div></div>
              <div class="card-icon">üõí</div><div class="card-title">Lista de Compras</div>
              <button class="card-menu-btn" data-menu-for="shopping-list">‚ãÆ</button>
              <div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-notes-wrapper">
              <div class="card-badge red" style="left:12px;">${lastCount.notes ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="notes">‚ãÆ</button>
              <div class="card-icon">üìù</div><div class="card-title">Notas</div>
              <div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">A√±adir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-calendar-wrapper">
              <div class="card-badge red" style="left:12px;">${lastCount.calendarToday ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="calendar">‚ãÆ</button>
              <div class="card-icon">üìÖ</div><div class="card-title">Calendario</div>
              <div class="dropdown-menu" id="menu-calendar"><a class="dropdown-item" id="add-event-link">A√±adir Evento</a><a class="dropdown-item" id="view-agenda-link">Ver Agenda</a></div>
            </div>
          </div>`;
        document.getElementById('add-reminder-link').onclick = renderReminderForm;
        document.getElementById('list-reminders-link').onclick = renderRemindersList;
        document.getElementById('view-shopping-list-link').onclick = renderShoppingList;
        document.getElementById('add-note-link').onclick = () => renderNoteForm();
        document.getElementById('list-notes-link').onclick = renderNotesList;
        document.getElementById('add-event-link').onclick = () => renderEventForm();
        document.getElementById('view-agenda-link').onclick = renderAgendaView;
      }
      
      // Manejador de clics global mejorado para men√∫s
      document.body.addEventListener('click', (e) => {
        const menuBtn = e.target.closest('.card-menu-btn, .note-menu-btn, .event-menu-btn, .shopping-item-menu-btn');
        const allMenus = document.querySelectorAll('.dropdown-menu, .note-dropdown-menu, .event-dropdown-menu, .shopping-item-dropdown-menu');

        if (!menuBtn) {
            if (!e.target.closest('.dropdown-menu, .note-dropdown-menu, .event-dropdown-menu, .shopping-item-dropdown-menu')) {
                allMenus.forEach(m => m.classList.remove('show'));
            }
            return;
        }

        e.stopPropagation();
        let menu;
        if (menuBtn.classList.contains('note-menu-btn')) menu = document.getElementById(`menu-note-${menuBtn.dataset.noteId}`);
        else if (menuBtn.classList.contains('event-menu-btn')) menu = document.getElementById(`menu-event-${menuBtn.dataset.eventId}`);
        else if (menuBtn.classList.contains('shopping-item-menu-btn')) menu = document.getElementById(`menu-item-${menuBtn.dataset.trackingCode}`);
        else menu = document.getElementById(`menu-${menuBtn.dataset.menuFor}`);
        
        if (!menu) return; // Salida segura si el men√∫ no existe

        const isShown = menu.classList.contains('show');
        allMenus.forEach(m => m.classList.remove('show'));
        if (!isShown) menu.classList.add('show');
      });
      
      function setActiveTab(activeTabId) {
          document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
          const activeTab = document.getElementById(activeTabId);
          if (activeTab) activeTab.classList.add('active');
      }
      
      // ======================================================================
      // --- SECCI√ìN DE RECORDATORIOS --- (SIN CAMBIOS)
      // ======================================================================
      function renderReminderForm() {
        mainContent.innerHTML = `
        <div class="form-container">
            <div class="list-header"><button class="back-btn" id="back-to-dash-reminders">‚Äπ</button><h2>A√±adir Recordatorio</h2></div>
            <div class="form-card">
                <label for="reminder-desc">Descripci√≥n</label><textarea id="reminder-desc" rows="3"></textarea>
                <label for="reminder-time">Fecha y Hora</label><input type="datetime-local" id="reminder-time">
                <label>Categor√≠a</label>
                <div class="radio-group" id="reminder-category">
                    <input type="radio" id="cat-work" name="category" value="Trabajo"><label for="cat-work">Trabajo</label>
                    <input type="radio" id="cat-personal" name="category" value="Personal"><label for="cat-personal">Personal</label>
                    <input type="radio" id="cat-other" name="category" value="Otro" checked><label for="cat-other">Otro</label>
                </div>
                <button id="save-reminder-btn">Guardar</button>
            </div>
        </div>`;
        document.getElementById('back-to-dash-reminders').onclick = initializeAppContent;
        const saveBtn = document.getElementById('save-reminder-btn');
        const descInput = document.getElementById('reminder-desc');
        const timeInput = document.getElementById('reminder-time');
        function validateReminderForm() { const isValid = descInput.value.trim() !== '' && timeInput.value !== ''; saveBtn.classList.toggle('enabled', isValid); }
        descInput.addEventListener('input', validateReminderForm);
        timeInput.addEventListener('input', validateReminderForm);
        saveBtn.onclick = async () => { if (saveBtn.classList.contains('enabled')) await saveReminder(); };
      }
      async function saveReminder() {
        showSpinner();
        const description = document.getElementById('reminder-desc').value;
        const time = document.getElementById('reminder-time').value;
        const category = document.querySelector('input[name="category"]:checked').value;
        try {
            const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'add_reminder', description, time, category }) });
            if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            lastCount.reminders++;
            showToast('Recordatorio a√±adido con √©xito.');
            renderRemindersList(data);
        } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      async function renderRemindersList(remindersData = null) {
        showSpinner();
        try {
            let reminders = remindersData;
            if (!reminders) {
                const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_reminders_list' }) });
                if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
                reminders = await res.json();
                if (reminders.error) throw new Error(reminders.error);
            }
            mainContent.innerHTML = `
            <div class="list-container">
                <div class="list-header"><button class="back-btn" id="back-to-dash-list">‚Äπ</button><h2>Mis Recordatorios</h2></div>
                <ul class="reminder-list" id="reminders-ul"></ul>
            </div>`;
            document.getElementById('back-to-dash-list').onclick = initializeAppContent;
            const listUl = document.getElementById('reminders-ul');
            if (reminders.length === 0) { listUl.innerHTML = '<li class="no-reminders">No tienes recordatorios.</li>'; }
            else { listUl.innerHTML = reminders.map(r => `
                <li class="reminder-item" id="reminder-${r.tracking_code}">
                    <div class="reminder-details"><span class="reminder-text">${r.Descripcion}</span><span class="reminder-date">${r.Fecha} (${r.Categoria})</span></div>
                    <div class="reminder-actions"><button class="reminder-delete-btn" data-code="${r.tracking_code}">üóëÔ∏è</button></div>
                </li>`).join('');
            }
            document.querySelectorAll('.reminder-delete-btn').forEach(btn => btn.onclick = (e) => confirmDeleteReminder(e.currentTarget.dataset.code));
        } catch(err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      function confirmDeleteReminder(trackingCode) {
        tg.showConfirm("¬øSeguro que quieres eliminar este recordatorio?", (ok) => {
            if (ok) executeDeleteReminder(trackingCode);
        });
      }
      async function executeDeleteReminder(trackingCode) {
        showSpinner();
        try {
            const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_reminder', tracking_code: trackingCode }) });
            if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            lastCount.reminders--;
            showToast('Recordatorio eliminado.');
            renderRemindersList(data);
        } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      
      // ======================================================================
      // --- SECCI√ìN DE LISTA DE LA COMPRA --- (REESCRITA)
      // ======================================================================
      async function renderShoppingList(shoppingData = null) {
          showSpinner();
          try {
              let items = shoppingData;
              if (!items) {
                  const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_shopping_list' }) });
                  if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
                  items = await res.json(); if (items.error) throw new Error(items.error);
              }
              const pendingItems = items.filter(i => i['2'] === 'Pendiente');
              const boughtItems = items.filter(i => i['2'] === 'Comprado');
              
              mainContent.innerHTML = `
              <div class="list-container">
                  <div class="list-header"><button class="back-btn" id="back-to-dash-shopping">‚Äπ</button><h2>Lista de Compras</h2></div>
                  <div class="add-article-btn-container">
                    <button class="add-article-btn" id="add-article-toggle-btn">A√±adir Art√≠culo</button>
                    <button class="multi-select-action-btn" id="move-to-pending-btn" disabled>Pasar a Pendiente</button>
                  </div>
                  <div id="add-item-form-container" style="display: none; padding: 10px; margin-top: -10px;">
                      <div class="form-card" style="padding: 15px; box-shadow: none; border: 1px solid #eee;">
                          <input type="text" id="new-item-description" placeholder="Nombre del art√≠culo..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
                          <div style="display:flex; gap:10px; margin-top:10px;">
                              <button id="save-new-item-btn" style="flex:2; padding:10px; background:var(--action-bg); color:var(--action-text); border:none; border-radius:8px; cursor:pointer;">Guardar</button>
                              <button id="cancel-new-item-btn" style="flex:1; padding:10px; background:#aaa; color:var(--action-text); border:none; border-radius:8px; cursor:pointer;">Cancelar</button>
                          </div>
                      </div>
                  </div>
                  <ul class="shopping-list" id="shopping-ul"></ul>
              </div>`;
              
              const shoppingUl = document.getElementById('shopping-ul');
              if (items.length === 0) {
                  shoppingUl.innerHTML = '<li class="no-shopping-items">La lista est√° vac√≠a.</li>';
              } else {
                  shoppingUl.innerHTML = `
                      ${pendingItems.length > 0 ? `<h3 class="shopping-list-section-title">Pendientes (${pendingItems.length})</h3>` : ''}
                      ${pendingItems.map(item => shoppingItemHTML(item)).join('')}
                      ${boughtItems.length > 0 ? `<h3 class="shopping-list-section-title">Comprados (${boughtItems.length})</h3>` : ''}
                      ${boughtItems.map(item => shoppingItemHTML(item)).join('')}`;
              }
              document.getElementById('back-to-dash-shopping').onclick = initializeAppContent;
              attachShoppingListListeners();
          } catch (err) { showToast(`Error cargando la lista: ${err.message}`, true);
          } finally { hideSpinner(); }
      }
      function shoppingItemHTML(item, isEditing = false) {
        const description = item['1']; const status = item['2']; const trackingCode = item['3']; const date = item['4'];
        if (isEditing) {
            return `
            <div style="display:flex; align-items:center; gap:5px; width:100%;">
                <input type="text" value="${description}" id="edit-desc-${trackingCode}" style="flex-grow:1; padding:10px; border:1px solid var(--primary); border-radius:8px;">
                <button class="shopping-item-action-btn" data-action="save-edit" data-tracking-code="${trackingCode}" style="background:var(--action-bg); color:var(--action-text); border:none; border-radius:50%; width:36px; height:36px; font-size:1.2rem;">‚úîÔ∏è</button>
                <button class="shopping-item-action-btn" data-action="cancel-edit" data-tracking-code="${trackingCode}" style="background:#aaa; color:var(--action-text); border:none; border-radius:50%; width:36px; height:36px; font-size:1.2rem;">‚ùå</button>
            </div>`;
        }
        const isPending = status === 'Pendiente';
        return `
            <div class="shopping-item-checkbox-wrapper"><input type="checkbox" class="shopping-item-checkbox" data-tracking-code="${trackingCode}" ${!isPending ? 'checked' : ''}></div>
            <button class="shopping-item-toggle-btn ${isPending ? 'pending' : 'bought'}" data-tracking-code="${trackingCode}" data-new-status="${isPending ? 'Comprado' : 'Pendiente'}">
                ${description} ${date ? `<span class="item-date">${date}</span>` : ''}
            </button>
            <div class="shopping-item-menu-container">
                <button class="shopping-item-menu-btn" data-tracking-code="${trackingCode}">‚ãÆ</button>
                <div class="shopping-item-dropdown-menu" id="menu-item-${trackingCode}">
                    <a class="shopping-item-dropdown-item" data-action="edit" data-tracking-code="${trackingCode}" data-description="${description}">Editar</a>
                    <a class="shopping-item-dropdown-item" data-action="delete" data-tracking-code="${trackingCode}">Eliminar</a>
                </div>
            </div>`;
      }
      function attachShoppingListListeners() {
          document.getElementById('add-article-toggle-btn').onclick = () => { document.getElementById('add-item-form-container').style.display = 'block'; };
          document.getElementById('cancel-new-item-btn').onclick = () => { document.getElementById('add-item-form-container').style.display = 'none'; };
          document.getElementById('save-new-item-btn').onclick = addShoppingItemFromForm;
          document.querySelectorAll('.shopping-item-toggle-btn').forEach(btn => btn.onclick = handleToggleItemStatus);
          document.querySelectorAll('.shopping-item-dropdown-item').forEach(item => item.onclick = handleShoppingItemMenu);
          document.querySelectorAll('.shopping-item-checkbox').forEach(chk => chk.onchange = updateMultiSelectButton);
          document.getElementById('move-to-pending-btn').onclick = handleMoveMultipleToPending;
      }
      async function addShoppingItemFromForm() {
          const descriptionInput = document.getElementById('new-item-description');
          const description = descriptionInput.value.trim();
          if (description) {
              showSpinner();
              try {
                  const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'add_articulo', description }) });
                  const data = await res.json();
                  if (data.error) throw new Error(data.error);
                  lastCount.shoppingPending++;
                  showToast('Art√≠culo a√±adido.');
                  renderShoppingList(data);
              } catch (err) { showToast(`Error: ${err.message}`, true);
              } finally { hideSpinner(); }
          }
      }
      async function handleToggleItemStatus(event) {
          const button = event.currentTarget;
          showSpinner();
          try {
              const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'toggle_item_status', tracking_code: button.dataset.trackingCode, new_status: button.dataset.newStatus }) });
              const data = await res.json(); if (data.error) throw new Error(data.error);
              if (button.dataset.newStatus === 'Comprado') { lastCount.shoppingPending--; lastCount.shoppingBought++; } else { lastCount.shoppingPending++; lastCount.shoppingBought--; }
              renderShoppingList(data);
          } catch(err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      function handleShoppingItemMenu(event) {
          const action = event.currentTarget.dataset.action;
          const trackingCode = event.currentTarget.dataset.trackingCode;
          if (action === 'delete') {
              tg.showConfirm('¬øSeguro que quieres eliminar este art√≠culo?', (ok) => { if (ok) executeDeleteShoppingItem(trackingCode); });
          } else if (action === 'edit') {
              const itemLi = document.getElementById(`item-${trackingCode}`);
              const currentDescription = event.currentTarget.dataset.description;
              itemLi.innerHTML = shoppingItemHTML({'1': currentDescription, '3': trackingCode}, true);
              itemLi.querySelector('[data-action="cancel-edit"]').onclick = () => renderShoppingList();
              itemLi.querySelector('[data-action="save-edit"]').onclick = () => {
                  const newDescription = document.getElementById(`edit-desc-${trackingCode}`).value;
                  if (newDescription && newDescription.trim() !== '' && newDescription !== currentDescription) {
                      executeEditShoppingItem(trackingCode, newDescription);
                  } else { renderShoppingList(); }
              };
          }
      }
      async function executeDeleteShoppingItem(trackingCode) {
          showSpinner();
          try {
              const itemElement = document.getElementById(`item-${trackingCode}`);
              const status = itemElement.dataset.status;
              const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_item_shopping_list', tracking_code: trackingCode }) });
              const data = await res.json(); if (data.error) throw new Error(data.error);
              if(status === 'Pendiente') { lastCount.shoppingPending--; } else { lastCount.shoppingBought--; }
              showToast('Art√≠culo eliminado.');
              renderShoppingList(data);
          } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      async function executeEditShoppingItem(trackingCode, newDescription) {
          showSpinner();
          try {
              const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'edit_item_description', tracking_code: trackingCode, new_description: newDescription }) });
              const data = await res.json(); if (data.error) throw new Error(data.error);
              showToast('Art√≠culo actualizado.');
              renderShoppingList(data);
          } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      function updateMultiSelectButton() {
          const checkedBoxes = document.querySelectorAll('.shopping-item-checkbox:checked');
          const moveToPendingBtn = document.getElementById('move-to-pending-btn');
          const hasCheckedBoughtItems = Array.from(checkedBoxes).some(chk => chk.closest('.shopping-item')?.dataset.status === 'Comprado');
          moveToPendingBtn.disabled = !hasCheckedBoughtItems;
          moveToPendingBtn.classList.toggle('enabled', hasCheckedBoughtItems);
      }
      async function handleMoveMultipleToPending() {
          const checkedBoughtItems = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(chk => chk.closest('.shopping-item')).filter(item => item?.dataset.status === 'Comprado').map(item => item.querySelector('.shopping-item-toggle-btn').dataset.trackingCode);
          if (checkedBoughtItems.length === 0) return;
          showSpinner();
          try {
              const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'toggle_multiple_to_pending', tracking_codes: checkedBoughtItems }) });
              const data = await res.json(); if (data.error) throw new Error(data.error);
              lastCount.shoppingPending += checkedBoughtItems.length;
              lastCount.shoppingBought -= checkedBoughtItems.length;
              showToast(`${checkedBoughtItems.length} art√≠culo(s) movido(s) a pendientes.`);
              renderShoppingList(data);
          } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      
      // ======================================================================
      // --- SECCI√ìN DE NOTAS --- (ACTUALIZADA CON tg.showConfirm)
      // ======================================================================
      function renderNoteForm(note = null) {
        const isEditing = note !== null;
        mainContent.innerHTML = `
        <div class="form-container">
          <div class="list-header"><button class="back-btn" id="back-to-notes-list">‚Äπ</button><h2>${isEditing ? 'Editar' : 'A√±adir'} Nota</h2></div>
          <div class="form-card">
              <input type="hidden" id="note-id" value="${isEditing ? note.Nota_ID : ''}">
              <label for="note-title">T√≠tulo</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}">
              <label for="note-description">Descripci√≥n</label><textarea id="note-description" rows="8">${isEditing ? note.Descripcion.replace(/\\n/g, '\n') : ''}</textarea>
              <button id="save-note-btn">${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button>
          </div>
        </div>`;
        document.getElementById('back-to-notes-list').onclick = renderNotesList;
        const saveBtn = document.getElementById('save-note-btn');
        const titleInput = document.getElementById('note-title');
        function validateNoteForm(){ saveBtn.classList.toggle('enabled', titleInput.value.trim() !== ''); }
        titleInput.addEventListener('input', validateNoteForm);
        saveBtn.onclick = async () => { if (saveBtn.classList.contains('enabled')) await saveNote(isEditing); };
        validateNoteForm();
      }
      async function saveNote(isEditing) {
        showSpinner();
        const requestBody = { chat_ID: chatId, Type: isEditing ? 'edit_note' : 'add_note', title: document.getElementById('note-title').value, description: document.getElementById('note-description').value, note_id: document.getElementById('note-id').value };
        try {
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(requestBody) });
          if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
          const data = await res.json(); if (data.error) throw new Error(data.error);
          if (!isEditing) lastCount.notes++;
          showToast(`Nota ${isEditing ? 'actualizada' : 'creada'} con √©xito.`);
          renderNotesList(data);
        } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      async function renderNotesList(notesData = null) {
        showSpinner();
        try {
          let notes = notesData;
          if (!notes) {
            const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_notes_list' }) });
            if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
            notes = await res.json(); if (notes.error) throw new Error(notes.error);
          }
          mainContent.innerHTML = `
          <div class="list-container">
              <div class="list-header"><button class="back-btn" id="back-to-dash-notes">‚Äπ</button><h2>Mis Notas</h2></div>
              <ul class="notes-list" id="notes-ul"></ul>
          </div>`;
          document.getElementById('back-to-dash-notes').onclick = initializeAppContent;
          const listUl = document.getElementById('notes-ul');
          if (notes.length === 0) { listUl.innerHTML = '<li class="no-notes">No tienes notas.</li>'; }
          else {
            listUl.innerHTML = notes.map(n => `
              <li class="note-item" id="note-item-${n.Nota_ID}">
                <div class="note-header">
                  <div class="note-header-interactive"><div class="note-title-section"><span class="note-title">${n.Titulo}</span><span class="note-date">${n.Fecha}</span></div><span class="expand-arrow">‚ñº</span></div>
                  <button class="note-menu-btn" data-note-id="${n.Nota_ID}">‚ãÆ</button>
                  <div class="note-dropdown-menu" id="menu-note-${n.Nota_ID}">
                      <a class="dropdown-item" data-action="edit">Editar</a><a class="dropdown-item" data-action="delete">Eliminar</a>
                  </div>
                </div>
                <div class="note-description">${n.Descripcion.replace(/\\n/g, '\n')}</div>
              </li>`).join('');
          }
          listUl.querySelectorAll('.note-header-interactive').forEach(header => header.onclick = (e) => e.currentTarget.closest('.note-item').classList.toggle('open'));
          listUl.querySelectorAll('.note-dropdown-menu .dropdown-item').forEach(item => {
              item.onclick = (e) => {
                  e.stopPropagation();
                  const action = e.target.dataset.action;
                  const noteId = e.target.closest('.note-dropdown-menu').id.replace('menu-note-', '');
                  const note = notes.find(n => n.Nota_ID === noteId);
                  if (action === 'edit') renderNoteForm(note);
                  else if (action === 'delete') {
                      tg.showConfirm('¬øSeguro que quieres eliminar esta nota?', (ok) => { if(ok) executeDeleteNote(noteId); });
                  }
              };
          });
        } catch(err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      async function executeDeleteNote(noteId) {
        showSpinner();
        try {
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_note', note_id: noteId }) });
          if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
          const data = await res.json(); if (data.error) throw new Error(data.error);
          lastCount.notes--;
          showToast('Nota eliminada.');
          renderNotesList(data);
        } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      
      // ======================================================================
      // --- SECCI√ìN DE CALENDARIO --- (ACTUALIZADA CON tg.showConfirm)
      // ======================================================================
      async function renderAgendaView() {
        showSpinner();
        try {
          const startDate = new Date(); const endDate = new Date(); endDate.setDate(startDate.getDate() + 30);
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_calendar_events', startDate: startDate.toISOString(), endDate: endDate.toISOString() }) });
          if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
          const data = await res.json(); if (data.error) throw new Error(data.error);
          mainContent.innerHTML = `
          <div class="list-container">
              <div class="list-header"><button class="back-btn" id="back-to-dash-agenda">‚Äπ</button><h2>Agenda</h2></div>
              <div class="agenda-view" id="agenda-ul"></div>
          </div>`;
          document.getElementById('back-to-dash-agenda').onclick = initializeAppContent;
          const agendaContainer = document.getElementById('agenda-ul');
          if (data.length === 0) { agendaContainer.innerHTML = '<div class="no-events">No hay eventos en los pr√≥ximos 30 d√≠as.</div>'; return; }
          const eventsByDay = data.reduce((acc, event) => {
              const day = new Date(event.start).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
              if (!acc[day]) acc[day] = []; acc[day].push(event); return acc;
          }, {});
          let agendaHtml = '';
          for (const day in eventsByDay) {
              agendaHtml += `<h3 class="day-header">${day}</h3>`;
              eventsByDay[day].forEach(event => {
                  const startTime = new Date(event.start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                  const endTime = new Date(event.end).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                  agendaHtml += `
                  <div class="event-item" id="event-item-${event.id}">
                      <div class="event-details" data-event-id="${event.id}"><div class="event-time">${startTime} - ${endTime}</div><div class="event-summary">${event.summary}</div><div class="event-description" style="display: none;">${event.description || ''}</div></div>
                      <div style="position: relative;">
                          <button class="event-menu-btn" data-event-id="${event.id}">‚ãÆ</button>
                          <div class="event-dropdown-menu" id="menu-event-${event.id}">
                              <a class="dropdown-item" data-action="edit">Editar</a><a class="dropdown-item" data-action="delete">Eliminar</a><a class="dropdown-item" href="${event.htmlLink}" target="_blank">Ver en Google</a>
                          </div>
                      </div>
                  </div>`;
              });
          }
          agendaContainer.innerHTML = agendaHtml;
          agendaContainer.addEventListener('click', (e) => handleCalendarInteractions(e, data));
        } catch (err) { showToast(`Error al cargar la agenda: ${err.message}`, true); } finally { hideSpinner(); }
      }
      function renderEventForm(event = null, date = null) {
          const isEditing = event !== null;
          const start = isEditing ? new Date(event.start) : (date ? new Date(date) : new Date());
          const end = isEditing ? new Date(event.end) : new Date(start.getTime() + 60 * 60 * 1000);
          const toLocalISOString = (d) => { const z = n => ('0' + n).slice(-2); return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`; };
          mainContent.innerHTML = `
          <div class="form-container">
              <div class="list-header"><button class="back-btn" id="back-to-agenda">‚Äπ</button><h2>${isEditing ? 'Editar' : 'Nuevo'} Evento</h2></div>
              <div class="form-card">
                  <input type="hidden" id="event-id" value="${isEditing ? event.id : ''}">
                  <label for="event-summary">T√≠tulo</label><input type="text" id="event-summary" value="${isEditing ? event.summary : ''}">
                  <label for="event-start">Inicio</label><input type="datetime-local" id="event-start" value="${toLocalISOString(start)}">
                  <label for="event-end">Fin</label><input type="datetime-local" id="event-end" value="${toLocalISOString(end)}">
                  <label for="event-description">Descripci√≥n</label><textarea id="event-description" rows="4">${isEditing ? event.description : ''}</textarea>
                  <label for="event-location">Ubicaci√≥n</label><input type="text" id="event-location" value="${isEditing ? event.location : ''}">
                  <button id="save-event-btn">${isEditing ? 'Guardar Cambios' : 'Crear Evento'}</button>
              </div>
          </div>`;
          document.getElementById('back-to-agenda').onclick = renderAgendaView;
          const saveBtn = document.getElementById('save-event-btn');
          const summaryInput = document.getElementById('event-summary');
          function validateEventForm() { saveBtn.classList.toggle('enabled', summaryInput.value.trim() !== ''); }
          summaryInput.addEventListener('input', validateEventForm);
          saveBtn.onclick = () => { if (saveBtn.classList.contains('enabled')) saveCalendarEvent(isEditing); };
          validateEventForm();
      }
      function handleCalendarInteractions(e, events) {
          if (e.target.closest('.event-details')) { const desc = e.target.closest('.event-details').querySelector('.event-description'); if (desc) desc.style.display = desc.style.display === 'none' ? 'block' : 'none'; }
          if (e.target.closest('.dropdown-item')) {
              e.stopPropagation();
              const menuItem = e.target.closest('.dropdown-item');
              const action = menuItem.dataset.action;
              const eventId = menuItem.closest('.event-dropdown-menu').id.replace('menu-event-', '');
              const eventData = events.find(ev => ev.id === eventId);
              if (action === 'edit') renderEventForm(eventData);
              else if (action === 'delete') {
                  tg.showConfirm(`¬øSeguro que quieres eliminar el evento "${eventData.summary}"?`, (ok) => { if (ok) executeDeleteCalendarEvent(eventId); });
              }
              document.querySelectorAll('.event-dropdown-menu').forEach(m => m.classList.remove('show'));
          }
      }
      async function saveCalendarEvent(isEditing) {
        showSpinner();
        const eventId = document.getElementById('event-id').value;
        const eventData = { summary: document.getElementById('event-summary').value, start: document.getElementById('event-start').value, end: document.getElementById('event-end').value, description: document.getElementById('event-description').value, location: document.getElementById('event-location').value };
        const requestBody = { chat_ID: chatId, Type: isEditing ? 'edit_calendar_event' : 'add_calendar_event', eventId, eventData };
        try {
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(requestBody) });
          const data = await res.json(); if (data.error) throw new Error(data.error);
          showToast(`Evento ${isEditing ? 'actualizado' : 'creado'} con √©xito.`);
          initializeAppContent();
        } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }
      async function executeDeleteCalendarEvent(eventId) {
        showSpinner();
        try {
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_calendar_event', eventId: eventId }) });
          const data = await res.json(); if (data.error) throw new Error(data.error);
          showToast('Evento eliminado con √©xito.');
          initializeAppContent();
        } catch (err) { showToast(`Error: ${err.message}`, true); } finally { hideSpinner(); }
      }

      document.getElementById('tab-home').onclick = initializeAppContent;
      initializeAppContent();
    });
  </script>
</body>
</html>
