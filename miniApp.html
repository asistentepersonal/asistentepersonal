<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#f5f7fa; --card-bg:#fff; --text:#333; --muted:#555; --badge-color:#e74c3c; --primary:#4a76f3; --action-bg:#4caf50; --action-text:#fff; --error-bg:#e74c3c; --delete-bg: #e74c3c; --delete-text: #fff; --menu-bg: #fff; --confirm-yes-bg: #e74c3c; --confirm-no-bg: #cccccc; --pending-bg: #28a745; --bought-bg: #dc3545; --list-item-text: #fff; --edit-icon-color: #007bff; --checkbox-border: #ddd; --checkbox-checked-bg: var(--primary); }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom: 60px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:20px;}
    .card{background:var(--card-bg);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);text-align:center;position:relative;}
    .card-icon{font-size:2.5rem;margin-bottom:8px;}
    .card-title{font-size:1.2rem;margin-bottom:4px;}
    .card-badge{position:absolute;top:12px;background:var(--badge-color);color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:.9rem;}
    .card-badge-group{position:absolute;top:12px;left:12px;display:flex;gap:4px;}
    .card-badge.green{background-color:#28a745;left:12px;}
    .card-badge.red{background-color:#e74c3c;right:12px;}
    .card-badge-group .card-badge{position:static;}
    .card-menu-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 5px; line-height: 1; }
    .dropdown-menu { display: none; position: absolute; top: 40px; right: 10px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; min-width: 150px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 12px 20px; color: var(--text); cursor: pointer; display: block; text-align: left; }
    .dropdown-item:hover { background-color: var(--bg); }
    .tabs{position:fixed;bottom:0;left:0;width:100%;display:flex;background:var(--card-bg);box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index: 100;}
    .tab{flex:1;text-align:center;padding:12px 0;font-size:1rem;color:var(--muted);cursor:pointer;}
    .tab.active{color:var(--badge-color);}
    .form-container, .list-container{max-width:480px;margin:20px auto;padding:10px;}
    .form-card{background:var(--card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.05);padding:24px;}
    .form-card h2{margin-bottom:16px;font-size:1.4rem;}
    .form-card label{display:block;margin-top:12px;font-weight:600;color:var(--text);}
    .form-card textarea,.form-card input,.form-card .radio-group{width:100%;margin-top:8px;}
    .form-card textarea,.form-card input{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;color:var(--text);}
    .form-card .input-error { border-color: var(--error-bg) !important; }
    .radio-group{display:flex;gap:10px;align-items:center;}
    .radio-group label{font-weight:400;color:var(--text);margin-top:0;}
    .form-card button{margin-top:20px;width:100%;padding:12px;background:var(--action-bg);color:var(--action-text);border:none;border-radius:8px;font-size:1rem;cursor:not-allowed;opacity:.6;transition:opacity .2s,background .2s;}
    .form-card button.enabled{cursor:pointer;opacity:1;}
    .toast{visibility:hidden;width:90%;max-width:480px;background:var(--action-bg);color:var(--action-text);text-align:center;border-radius:8px;padding:12px;position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:1000;font-size:1rem;}
    .toast.error{background:var(--error-bg);}
    .toast.show{visibility:visible;animation:fadein .3s,fadeout .3s 2.7s;}
    .spinner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1001;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg);}100%{transform:translate(-50%,-50%) rotate(360deg);}}
    @keyframes fadein{from{opacity:0;}to{opacity:1;}}@keyframes fadeout{from{opacity:1;}to{opacity:0;}}
    .list-header { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; }
    .back-btn { background: transparent; border: none; font-size: 1.8rem; cursor: pointer; color: var(--muted); padding-right: 15px; }
    .list-header h2 { font-size: 1.4rem; margin: 0; }
    .reminder-list, .shopping-list, .notes-list, .agenda-view { list-style: none; padding: 0; margin: 0; }
    .reminder-item, .shopping-item, .event-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
    .reminder-details, .event-details { display: flex; flex-direction: column; flex-grow: 1; }
    .reminder-text, .event-summary { font-size: 1.1rem; font-weight: 500; }
    .reminder-date, .event-time { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }
    .reminder-actions { display: flex; align-items: center; gap: 5px; }
    .reminder-delete-btn, .event-menu-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); padding: 5px; }
    .confirm-btn-yes, .confirm-btn-no { padding: 8px 12px; border: none; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 5px; }
    .confirm-btn-yes { background-color: var(--confirm-yes-bg); color: var(--delete-text); }
    .confirm-btn-no { background-color: var(--confirm-no-bg); color: var(--text); }
    .no-reminders, .no-shopping-items, .no-notes, .no-events { text-align: center; padding: 40px; color: var(--muted); background: var(--card-bg); border-radius: 12px; }
    #main:empty { display: none; }
    .shopping-list-header-row { display: flex; align-items: center; justify-content: flex-end; padding: 0 10px 10px 10px; color: var(--muted); font-size: 0.9rem; }
    .shopping-list-header-row input[type="checkbox"] { margin-left: 5px; }
    .shopping-item { gap: 5px; padding: 10px; }
    .shopping-item-checkbox-wrapper { flex-shrink: 0; margin-right: 8px; }
    .shopping-item input[type="checkbox"] { width: 20px; height: 20px; }
    .shopping-item-toggle-btn { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; color: var(--list-item-text); cursor: pointer; text-align: left; }
    .shopping-item-toggle-btn.pending { background-color: var(--pending-bg); }
    .shopping-item-toggle-btn.bought { background-color: var(--bought-bg); }
    .shopping-item-toggle-btn .item-date { font-size: 0.75rem; opacity: 0.8; margin-top: 5px; display:block; }
    .shopping-item-menu-container { position: relative; flex-shrink: 0; margin-left: auto; }
    .shopping-item-menu-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; }
    .add-article-btn-container { padding: 10px; text-align: center; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .add-article-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; flex-grow: 1; max-width: 250px; }
    .multi-select-action-btn { background-color: var(--primary); color: var(--action-text); padding: 12px 20px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: not-allowed; opacity: 0.6; flex-grow: 1; max-width: 250px; }
    .multi-select-action-btn.enabled { cursor: pointer; opacity: 1; }
    .shopping-list-section-title { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 10px 10px 10px; padding-top: 10px; border-top: 1px solid #eee; text-align: left; }
    .shopping-list-section-title:first-of-type { border-top: none; margin-top: 0; }
    .note-item { background: var(--card-bg); border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
    .note-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; }
    .note-header-interactive { flex-grow: 1; padding-right: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .note-title-section { display: flex; flex-direction: column; text-align: left; }
    .note-title { font-size: 1.1rem; font-weight: 500; }
    .note-date { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
    .note-menu-btn { background: transparent; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; flex-shrink: 0; }
    .note-description { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    .note-item.open .note-description { max-height: 500px; padding: 0 15px 15px; }
    .expand-arrow { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
    .note-item.open .expand-arrow { transform: rotate(180deg); }
    .day-header { font-size: 1.2rem; font-weight: 600; color: var(--text); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
    .event-details { cursor: pointer; }
    .event-description { white-space: pre-wrap; word-wrap: break-word; text-align: left; color: var(--text); margin-top: 10px; display: none; }
    .event-item.open .event-description { display: block; }
  </style>
</head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="main"></div>
  <div class="tabs"> <div class="tab active" id="tab-home">Home</div> </div>
  <div id="toast" class="toast"></div>
  
  <script>
    (function() { const params = new URLSearchParams(window.location.search); if (!params.has('v')) { const newUrl = new URL(window.location.href); newUrl.searchParams.set('v', new Date().getTime()); window.location.replace(newUrl.href); } })();

    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.expand();
        if (tg.themeParams) {
            document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f7fa');
            document.documentElement.style.setProperty('--card-bg', tg.themeParams.secondary_bg_color || '#ffffff');
            document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#333333');
            document.documentElement.style.setProperty('--muted', tg.themeParams.hint_color || '#555555');
            document.documentElement.style.setProperty('--primary', tg.themeParams.button_color || '#4a76f3');
            document.documentElement.style.setProperty('--action-text', tg.themeParams.button_text_color || '#ffffff');
        }
      }
      
      const webhookURL = 'https://script.google.com/macros/s/AKfycbw3KSGoSdoEgfPIysm6Uo6mzd4Sc6ePCMZoTyOgFpI8jB61ejkhYTNrOiuspAJ5_Ql93g/exec';
      let chatId = tg?.initDataUnsafe?.user?.id;
      if (!chatId) { chatId = prompt('MODO DE DESARROLLO\n\nIngresa tu chat_ID de Telegram para continuar:', ''); }

      let lastCount = { remindersCount: 0, shoppingPendingCount: 0, shoppingBoughtCount: 0, notesCount: 0, calendarTodayCount: 0 }, toastTimer; 
      const mainContent = document.getElementById('main');
      const spinner = document.getElementById('spinner');

      function showSpinner() { spinner.style.display = 'block'; }
      function hideSpinner() { spinner.style.display = 'none'; }
      function showToast(msg, isError = false) { clearTimeout(toastTimer); const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000); }
      async function fetchWithTimeout(resource, options = {}, timeout = 30000) { const controller = new AbortController(); const id = setTimeout(() => controller.abort(), timeout); try { const modifiedOptions = { ...options, signal: controller.signal, method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: options.body }; const response = await fetch(resource, modifiedOptions); clearTimeout(id); return response; } catch (error) { clearTimeout(id); if (error.name === 'AbortError') throw new Error('Timeout: La solicitud tardó demasiado.'); throw error; } }

      async function initializeAppContent() {
        showSpinner();
        try {
          const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_initial_counts' }) });
          if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          lastCount = data;
        } catch (err) {
          console.error('Error en la carga inicial:', err);
          showToast(`Error al cargar datos: ${err.message}`, true);
        } finally {
          renderDashboard();
          hideSpinner();
        }
      }

      function renderDashboard() {
        setActiveTab('tab-home');
        mainContent.innerHTML = `
          <div class="grid">
            <div class="card" id="card-recordatorios-wrapper">
              <div class="card-badge red" style="left:12px;">${lastCount.remindersCount ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="recordatorios">⋮</button>
              <div class="card-icon">🗓️</div><div class="card-title">Recordatorios</div>
              <div class="dropdown-menu" id="menu-recordatorios"><a class="dropdown-item" id="add-reminder-link">Añadir</a><a class="dropdown-item" id="list-reminders-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-shopping-list-wrapper">
              <div class="card-badge-group"><div class="card-badge green">${lastCount.shoppingPendingCount ?? '...'}</div><div class="card-badge red">${lastCount.shoppingBoughtCount ?? '...'}</div></div>
              <button class="card-menu-btn" data-menu-for="shopping-list">⋮</button>
              <div class="card-icon">🛒</div><div class="card-title">Lista de Compras</div>
              <div class="dropdown-menu" id="menu-shopping-list"><a class="dropdown-item" id="add-shopping-item-link">Añadir</a><a class="dropdown-item" id="view-shopping-list-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-notes-wrapper">
              <div class="card-badge red" style="left:12px;">${lastCount.notesCount ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="notes">⋮</button>
              <div class="card-icon">📝</div><div class="card-title">Notas</div>
              <div class="dropdown-menu" id="menu-notes"><a class="dropdown-item" id="add-note-link">Añadir</a><a class="dropdown-item" id="list-notes-link">Ver Lista</a></div>
            </div>
            <div class="card" id="card-calendar-wrapper">
              <div class="card-badge red" style="left:12px;">${lastCount.calendarTodayCount ?? '...'}</div>
              <button class="card-menu-btn" data-menu-for="calendar">⋮</button>
              <div class="card-icon">📅</div><div class="card-title">Calendario</div>
              <div class="dropdown-menu" id="menu-calendar"><a class="dropdown-item" id="add-event-link">Añadir Evento</a><a class="dropdown-item" id="view-agenda-link">Ver Agenda</a></div>
            </div>
          </div>`;
        document.getElementById('add-reminder-link').onclick = renderReminderForm;
        document.getElementById('list-reminders-link').onclick = renderRemindersList;
        document.getElementById('view-shopping-list-link').onclick = renderShoppingList;
        document.getElementById('add-shopping-item-link').onclick = renderAddArticleForm;
        document.getElementById('add-note-link').onclick = () => renderNoteForm();
        document.getElementById('list-notes-link').onclick = renderNotesList;
        // --- ADICIÓN QUIRÚRGICA ---
        document.getElementById('add-event-link').onclick = renderEventForm;
        document.getElementById('view-agenda-link').onclick = renderAgendaView;
      }
      
      document.body.addEventListener('click', (e) => {
        const menuBtn = e.target.closest('.card-menu-btn, .note-menu-btn, .event-menu-btn, .shopping-item-menu-btn');
        document.querySelectorAll('.dropdown-menu').forEach(m => {
          if (!m.contains(e.target) && !menuBtn) { m.classList.remove('show'); }
        });
        if (menuBtn) { 
          e.stopPropagation(); 
          let menuId;
          if (menuBtn.dataset.menuFor) menuId = `menu-${menuBtn.dataset.menuFor}`;
          else if (menuBtn.dataset.noteId) menuId = `menu-note-${menuBtn.dataset.noteId}`;
          else if (menuBtn.dataset.itemTrackingCode) menuId = `menu-shopping-item-${menuBtn.dataset.itemTrackingCode}`;
          else if (menuBtn.dataset.eventId) menuId = `menu-event-${menuBtn.dataset.eventId}`;
          
          const menu = document.getElementById(menuId);
          if (menu) {
            const isShown = menu.classList.contains('show');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            if (!isShown) menu.classList.add('show');
          }
        }
      });

      function setActiveTab(activeTabId) { document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active')); const activeTab = document.getElementById(activeTabId); if (activeTab) activeTab.classList.add('active'); }
      
      // --- CÓDIGO ORIGINAL DEL ARCHIVO DE 3 TARJETAS (INTACTO) ---
      function renderReminderForm() { mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn" id="back-to-dashboard">‹</button><h2>📝 Nuevo Recordatorio</h2></div><div class="form-card"><label>Descripción</label><textarea id="text" rows="3" required></textarea><label>Fecha y hora</label><input type="datetime-local" id="time" required/><label>Tipo</label><div class="radio-group" id="reminder-type-group"><label><input type="radio" name="category" value="Un solo uso"/> Único</label><label><input type="radio" name="category" value="Diario"/> Diario</label></div><button id="sendBtn" disabled>Crear Recordatorio</button></div></div>`; document.getElementById('back-to-dashboard').onclick = initializeAppContent; const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), sendBtn = document.getElementById('sendBtn'), radios = document.querySelectorAll('input[name="category"]'), radioGroup = document.getElementById('reminder-type-group'); function validateReminderForm() { const isTextValid = textInput.value.trim() !== ''; const isTimeValid = timeInput.value && new Date(timeInput.value) > new Date(); const isRadioSelected = document.querySelector('input[name="category"]:checked') !== null; sendBtn.disabled = !(isTextValid && isTimeValid && isRadioSelected); sendBtn.classList.toggle('enabled', !sendBtn.disabled); } textInput.addEventListener('input', validateReminderForm); timeInput.addEventListener('input', validateReminderForm); radios.forEach(r => r.addEventListener('change', validateReminderForm)); sendBtn.onclick = sendReminder; validateReminderForm(); }
      async function sendReminder() { const textInput = document.getElementById('text'), timeInput = document.getElementById('time'), radioSelected = document.querySelector('input[name="category"]:checked'), radioGroup = document.getElementById('reminder-type-group'); textInput.classList.remove('input-error'); timeInput.classList.remove('input-error'); radioGroup.classList.remove('input-error'); const isTextValid = textInput.value.trim() !== ''; const isTimeValid = !!timeInput.value; const isRadioSelected = radioSelected !== null; if (!isTextValid || !isTimeValid || !isRadioSelected) { if (!isTextValid) textInput.classList.add('input-error'); if (!isTimeValid) timeInput.classList.add('input-error'); if (!isRadioSelected) radioGroup.classList.add('input-error'); showToast('Por favor, rellena todos los campos marcados.', true); return; } const sendBtn = document.getElementById('sendBtn'); sendBtn.disabled = true; sendBtn.classList.remove('enabled'); const payload = { chat_ID: chatId, Type: 'add_reminder', description: textInput.value.trim(), time: timeInput.value, category: radioSelected.value }; showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) }); if (!res.ok) throw new Error(`Error del servidor: ${res.status}`); const data = await res.json(); if (data.error) throw new Error(data.error); showToast('Recordatorio guardado'); setTimeout(initializeAppContent, 500); } catch (err) { showToast(err.message || 'Error al enviar', true); sendBtn.disabled = false; sendBtn.classList.add('enabled'); } finally { hideSpinner(); } }
      async function renderRemindersList() { showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_reminders_list' }) }); if (!res.ok) throw new Error(`Error del servidor: ${res.status}`); const reminders = await res.json(); if (reminders.error) throw new Error(reminders.error); let listHtml = (reminders.length > 0) ? reminders.map(item => `<li class="reminder-item" id="reminder-${item.tracking_code}"><div class="reminder-details"><span class="reminder-text">${item.Descripcion}</span><span class="reminder-date">${item.Fecha} - ${item.Categoria}</span></div><div class="reminder-actions"><button class="reminder-delete-btn" data-tracking-code="${item.tracking_code}">🗑️</button></div></li>`).join('') : '<div class="no-reminders">🎉<br>No tienes recordatorios pendientes.</div>'; mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn" id="back-to-dashboard">‹</button><h2>Recordatorios Activos</h2></div><ul class="reminder-list" id="reminders-list-ul">${listHtml}</ul></div>`; document.getElementById('back-to-dashboard').onclick = initializeAppContent; document.getElementById('reminders-list-ul').addEventListener('click', handleReminderActionClick); } catch (err) { mainContent.innerHTML = `<div class="no-reminders">❌<br>Error al cargar la lista.<br><small>${err.message}</small></div>`; showToast(`Error al cargar la lista: ${err.message}`, true); } finally { hideSpinner(); } }
      function handleReminderActionClick(event) { const deleteButton = event.target.closest('.reminder-delete-btn'); if (deleteButton) { event.stopPropagation(); const trackingCode = deleteButton.dataset.trackingCode; deleteButton.style.display = 'none'; const confirmBtnYes = document.createElement('button'); confirmBtnYes.className = 'confirm-btn-yes'; confirmBtnYes.textContent = 'Sí'; confirmBtnYes.onclick = () => executeDeleteReminder(trackingCode); const confirmBtnNo = document.createElement('button'); confirmBtnNo.className = 'confirm-btn-no'; confirmBtnNo.textContent = 'No'; confirmBtnNo.onclick = () => { deleteButton.style.display = 'block'; confirmBtnYes.remove(); confirmBtnNo.remove(); }; deleteButton.parentElement.appendChild(confirmBtnYes); deleteButton.parentElement.appendChild(confirmBtnNo); } }
      async function executeDeleteReminder(trackingCode) { showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_reminder', tracking_code: trackingCode }) }); if (!res.ok) throw new Error(`Error al eliminar: ${res.status}`); await res.json(); showToast('Recordatorio eliminado'); initializeAppContent(); } catch (err) { showToast(err.message || 'Error al eliminar', true); } finally { hideSpinner(); } }
      function renderShoppingListItems(items) { const pendingItems = items.filter(item => item['2'] === 'Pendiente'); const boughtItems = items.filter(item => item['2'] === 'Comprado'); let listHtml = ''; if (pendingItems.length > 0) { listHtml += '<h3 class="shopping-list-section-title">Artículos Pendientes</h3>'; listHtml += pendingItems.map(item => `<li class="shopping-item" id="shopping-item-${item['3']}"><div class="shopping-item-checkbox-wrapper" style="width: 28px;"></div><button class="shopping-item-toggle-btn pending" data-tracking-code="${item['3']}" data-current-status="${item['2']}"><span>${item['1']}</span></button><div class="shopping-item-menu-container"><button class="shopping-item-menu-btn" data-item-tracking-code="${item['3']}">⋮</button><div class="dropdown-menu shopping-item-dropdown-menu" id="menu-shopping-item-${item['3']}"><a class="dropdown-item edit-btn-item" data-tracking-code="${item['3']}" data-current-description="${item['1']}">Editar</a><a class="dropdown-item delete-btn-item" data-tracking-code="${item['3']}">Eliminar</a></div></div></li>`).join(''); } if (boughtItems.length > 0) { listHtml += '<h3 class="shopping-list-section-title">Artículos Comprados</h3>'; listHtml += `<div class="shopping-list-header-row"><label for="select-all-checkbox">Seleccionar Todos</label><input type="checkbox" id="select-all-checkbox"></div>`; listHtml += boughtItems.map(item => `<li class="shopping-item" id="shopping-item-${item['3']}"><div class="shopping-item-checkbox-wrapper"><input type="checkbox" class="shopping-item-checkbox" data-tracking-code="${item['3']}" data-current-status="${item['2']}"></div><button class="shopping-item-toggle-btn bought" data-tracking-code="${item['3']}" data-current-status="${item['2']}"><span>${item['1']}</span>${item['4'] ? `<span class="item-date">${item['4']}</span>` : ''}</button><div class="shopping-item-menu-container"><button class="shopping-item-menu-btn" data-item-tracking-code="${item['3']}">⋮</button><div class="dropdown-menu shopping-item-dropdown-menu" id="menu-shopping-item-${item['3']}"><a class="dropdown-item edit-btn-item" data-tracking-code="${item['3']}" data-current-description="${item['1']}">Editar</a><a class="dropdown-item delete-btn-item" data-tracking-code="${item['3']}">Eliminar</a></div></div></li>`).join(''); } if (items.length === 0) { listHtml = '<div class="no-shopping-items">🛒<br>Tu lista está vacía.</div>'; } mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn" id="back-to-dashboard">‹</button><h2>Lista de Compras</h2></div><ul class="shopping-list" id="shopping-list-ul">${listHtml}</ul><div class="add-article-btn-container"><button class="add-article-btn" id="add-shopping-item-bottom-btn">Añadir Artículo</button><button class="multi-select-action-btn" id="multi-select-toggle-btn" disabled>Marcar para comprar</button></div></div>`; document.getElementById('back-to-dashboard').onclick = initializeAppContent; document.getElementById('shopping-list-ul').addEventListener('click', handleShoppingItemInteractions); document.getElementById('add-shopping-item-bottom-btn').onclick = renderAddArticleForm; const selectAllCheckbox = document.getElementById('select-all-checkbox'); if (selectAllCheckbox) { selectAllCheckbox.onchange = (e) => { document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.checked = e.target.checked; }); updateMultiSelectButtonState(); }; } document.querySelectorAll('.shopping-item-checkbox').forEach(cb => { cb.onchange = updateMultiSelectButtonState; }); document.getElementById('multi-select-toggle-btn').onclick = toggleSelectedItemsToPending; updateMultiSelectButtonState(); }
      async function renderShoppingList() { showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_shopping_list' }) }); if (!res.ok) throw new Error(`Error del servidor: ${res.status}`); const items = await res.json(); if (items.error) throw new Error(items.error); renderShoppingListItems(items); } catch (err) { mainContent.innerHTML = `<div class="no-shopping-items">❌<br>Error al cargar la lista.<br><small>${err.message}</small></div>`; } finally { hideSpinner(); } }
      function updateMultiSelectButtonState() { const multiSelectToggleButton = document.getElementById('multi-select-toggle-btn'); const selectedBoughtCount = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).length; if (selectedBoughtCount > 0) { multiSelectToggleButton.classList.add('enabled'); multiSelectToggleButton.disabled = false; multiSelectToggleButton.textContent = `Marcar ${selectedBoughtCount} para comprar`; } else { multiSelectToggleButton.classList.remove('enabled'); multiSelectToggleButton.disabled = true; multiSelectToggleButton.textContent = 'Marcar para comprar'; } }
      async function toggleSelectedItemsToPending() { const trackingCodesToUpdate = Array.from(document.querySelectorAll('.shopping-item-checkbox:checked')).map(cb => cb.dataset.trackingCode); if (trackingCodesToUpdate.length === 0) return; showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'toggle_multiple_to_pending', tracking_codes: trackingCodesToUpdate }) }); if (!res.ok) throw new Error(`Error: ${res.statusText}`); const items = await res.json(); if (items.error) throw new Error(items.error); renderShoppingListItems(items); initializeAppContent(); } catch (err) { showToast(err.message || 'Error al actualizar', true); } finally { hideSpinner(); } }
      function handleShoppingItemInteractions(event) { const toggleButton = event.target.closest('.shopping-item-toggle-btn'); const editMenuItem = event.target.closest('.edit-btn-item'); const deleteMenuItem = event.target.closest('.delete-btn-item'); if (toggleButton) { const itemElement = toggleButton.closest('.shopping-item'); const trackingCode = toggleButton.dataset.trackingCode; const newStatus = toggleButton.dataset.currentStatus === 'Pendiente' ? 'Comprado' : 'Pendiente'; updateShoppingItemUI(itemElement, newStatus); toggleShoppingItemStatusOnServer(trackingCode, newStatus, itemElement); } else if (editMenuItem) { event.stopPropagation(); document.querySelectorAll('.shopping-item-dropdown-menu').forEach(m => m.classList.remove('show')); editShoppingItem(editMenuItem.dataset.trackingCode, editMenuItem.dataset.currentDescription); } else if (deleteMenuItem) { event.stopPropagation(); document.querySelectorAll('.shopping-item-dropdown-menu').forEach(m => m.classList.remove('show')); executeDeleteShoppingItem(deleteMenuItem.dataset.trackingCode); } }
      function updateShoppingItemUI(itemElement, newStatus) { const toggleButton = itemElement.querySelector('.shopping-item-toggle-btn'); if (newStatus === 'Comprado') { toggleButton.classList.remove('pending'); toggleButton.classList.add('bought'); toggleButton.dataset.currentStatus = 'Comprado'; lastCount.shoppingPendingCount--; lastCount.shoppingBoughtCount++; } else { toggleButton.classList.remove('bought'); toggleButton.classList.add('pending'); toggleButton.dataset.currentStatus = 'Pendiente'; lastCount.shoppingPendingCount++; lastCount.shoppingBoughtCount--; } if(document.getElementById('card-shopping-list-wrapper')) { document.querySelector('#card-shopping-list-wrapper .card-badge.green').textContent = lastCount.shoppingPendingCount; document.querySelector('#card-shopping-list-wrapper .card-badge.red').textContent = lastCount.shoppingBoughtCount; } }
      async function toggleShoppingItemStatusOnServer(trackingCode, newStatus, itemElement) { try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'toggle_item_status', tracking_code: trackingCode, new_status: newStatus }) }); if (!res.ok) throw new Error(`Error del servidor: ${res.status}`); const items = await res.json(); if (items.error) throw new Error(items.error); console.log("Sincronización exitosa con el servidor."); } catch (err) { showToast(err.message || 'Error de sincronización', true); const oldStatus = newStatus === 'Comprado' ? 'Pendiente' : 'Comprado'; updateShoppingItemUI(itemElement, oldStatus); } }
      async function editShoppingItem(trackingCode, currentDescription) { const newDescription = prompt('Editar descripción:', currentDescription); if (newDescription && newDescription.trim() !== '' && newDescription.trim() !== currentDescription) { showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'edit_item_description', tracking_code: trackingCode, new_description: newDescription.trim() }) }); if (!res.ok) throw new Error(`Error: ${res.statusText}`); const items = await res.json(); if (items.error) throw new Error(items.error); renderShoppingListItems(items); } catch (err) { showToast(err.message || 'Error al editar', true); } finally { hideSpinner(); } } }
      async function executeDeleteShoppingItem(trackingCode) { showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ Type: 'delete_item_shopping_list', chat_ID: chatId, tracking_code: trackingCode }) }); if (!res.ok) throw new Error(`Error: ${res.status}`); const items = await res.json(); if (items.error) throw new Error(items.error); renderShoppingListItems(items); initializeAppContent(); } catch (err) { showToast(err.message || 'Error al eliminar', true); } finally { hideSpinner(); } }
      function renderAddArticleForm() { mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn" id="back-to-shopping-list">‹</button><h2>➕ Añadir Artículo</h2></div><div class="form-card"><label>Descripción</label><textarea id="article-description" rows="2" required></textarea><button id="add-article-send-btn" disabled>Añadir</button></div></div>`; document.getElementById('back-to-shopping-list').onclick = renderShoppingList; const sendBtn = document.getElementById('add-article-send-btn'); document.getElementById('article-description').oninput = (e) => { const isEnabled = e.target.value.trim() !== ''; sendBtn.disabled = !isEnabled; sendBtn.classList.toggle('enabled', isEnabled); }; sendBtn.onclick = addArticle; }
      async function addArticle() { const description = document.getElementById('article-description').value.trim(); if (!description) return; showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'add_articulo', description: description }) }); if (!res.ok) throw new Error(`Error: ${res.statusText}`); const items = await res.json(); if (items.error) throw new Error(items.error); renderShoppingListItems(items); initializeAppContent(); } catch (err) { showToast(err.message || 'Error al añadir', true); } finally { hideSpinner(); } }
      async function renderNotesList() { showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_notes_list' }) }); if (!res.ok) throw new Error(`Error del servidor: ${res.status}`); const notes = await res.json(); if (notes.error) throw new Error(notes.error); let listHtml = (notes.length > 0) ? notes.map(note => `<li class="note-item" id="note-${note.Nota_ID}"><div class="note-header"><div class="note-header-interactive"><div class="note-title-section"><span class="note-title">${note.Titulo}</span><span class="note-date">${note.Fecha}</span></div><span class="expand-arrow">▾</span></div><div style="position:relative"><button class="note-menu-btn" data-note-id="${note.Nota_ID}">⋮</button><div class="dropdown-menu" id="menu-note-${note.Nota_ID}"><a class="dropdown-item" data-action="edit-note" data-note-id="${note.Nota_ID}">Editar</a><a class="dropdown-item" data-action="delete-note" data-note-id="${note.Nota_ID}">Eliminar</a></div></div></div><div class="note-description">${note.Descripcion}</div></li>`).join('') : '<div class="no-notes">📝<br>No tienes notas guardadas.</div>'; mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn" id="back-to-dashboard">‹</button><h2>Mis Notas</h2></div><ul class="notes-list" id="notes-list-ul">${listHtml}</ul></div>`; document.getElementById('back-to-dashboard').onclick = initializeAppContent; document.getElementById('notes-list-ul').addEventListener('click', handleNoteInteractions); } catch (err) { mainContent.innerHTML = `<div class="no-notes">❌<br>Error al cargar las notas.<br><small>${err.message}</small></div>`; } finally { hideSpinner(); } }
      function handleNoteInteractions(event) { const interactiveHeader = event.target.closest('.note-header-interactive'); const actionItem = event.target.closest('.dropdown-item'); if (actionItem) { event.stopPropagation(); const action = actionItem.dataset.action; const noteId = actionItem.dataset.noteId; if (action === 'edit-note') { const noteItem = document.getElementById(`note-${noteId}`); const title = noteItem.querySelector('.note-title').textContent; const description = noteItem.querySelector('.note-description').textContent; renderNoteForm({ Nota_ID: noteId, Titulo: title, Descripcion: description }); } else if (action === 'delete-note') { executeDeleteNote(noteId); } } else if (interactiveHeader) { interactiveHeader.closest('.note-item').classList.toggle('open'); } }
      function renderNoteForm(note = null) { const isEditing = note !== null; mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn" id="back-to-notes-list">‹</button><h2>${isEditing ? '✏️ Editar Nota' : '➕ Nueva Nota'}</h2></div><div class="form-card"><label>Título</label><input type="text" id="note-title" value="${isEditing ? note.Titulo : ''}" required /><label>Descripción</label><textarea id="note-description" rows="8" required>${isEditing ? note.Descripcion : ''}</textarea><button id="save-note-btn" data-note-id="${isEditing ? note.Nota_ID : ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Nota'}</button></div></div>`; document.getElementById('back-to-notes-list').onclick = renderNotesList; const titleInput = document.getElementById('note-title'); const descriptionInput = document.getElementById('note-description'); const saveBtn = document.getElementById('save-note-btn'); function validateNoteForm() { const isTitleValid = titleInput.value.trim() !== ''; const isDescriptionValid = descriptionInput.value.trim() !== ''; saveBtn.disabled = !(isTitleValid && isDescriptionValid); saveBtn.classList.toggle('enabled', !saveBtn.disabled); } titleInput.addEventListener('input', validateNoteForm); descriptionInput.addEventListener('input', validateNoteForm); saveBtn.onclick = saveNote; validateNoteForm(); }
      async function saveNote() { const btn = document.getElementById('save-note-btn'); const titleInput = document.getElementById('note-title'); const descriptionInput = document.getElementById('note-description'); titleInput.classList.remove('input-error'); descriptionInput.classList.remove('input-error'); const isTitleValid = titleInput.value.trim() !== ''; const isDescriptionValid = descriptionInput.value.trim() !== ''; if (!isTitleValid || !isDescriptionValid) { if (!isTitleValid) titleInput.classList.add('input-error'); if (!isDescriptionValid) descriptionInput.classList.add('input-error'); showToast('Por favor, rellena todos los campos.', true); return; } btn.disabled = true; btn.classList.remove('enabled'); const payload = { chat_ID: chatId, Type: btn.dataset.noteId ? 'edit_note' : 'add_note', note_id: btn.dataset.noteId, title: titleInput.value.trim(), description: descriptionInput.value.trim() }; showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) }); if (!res.ok) throw new Error(`Error: ${res.status}`); const data = await res.json(); if (data.error) throw new Error(data.error); showToast(`Nota ${btn.dataset.noteId ? 'actualizada' : 'creada'}`); setTimeout(renderNotesList, 500); } catch (err) { showToast(err.message, true); btn.disabled = false; btn.classList.add('enabled'); } finally { hideSpinner(); } }
      async function executeDeleteNote(noteId) { if (!confirm('¿Estás seguro de que quieres eliminar esta nota?')) return; showSpinner(); try { const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_note', note_id: noteId }) }); if (!res.ok) throw new Error(`Error: ${res.status}`); await res.json(); showToast('Nota eliminada'); initializeAppContent(); renderNotesList(); } catch (err) { showToast(err.message, true); } finally { hideSpinner(); } }

      // ======================================================================
      // --- SECCIÓN DE CALENDARIO (NUEVA, CON LÓGICA REPLICADA) ---
      // ======================================================================
      async function renderAgendaView() {
          showSpinner();
          try {
              const startDate = new Date(); const endDate = new Date(); endDate.setDate(startDate.getDate() + 30);
              const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'get_calendar_events', startDate: startDate.toISOString(), endDate: endDate.toISOString() }) });
              if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
              const events = await res.json(); if (events.error) throw new Error(events.error);
              
              const groupAndRenderEvents = (evs) => {
                  const eventsByDay = evs.reduce((acc, event) => {
                      const day = new Date(event.start).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                      if (!acc[day]) acc[day] = [];
                      acc[day].push(event);
                      return acc;
                  }, {});
                  let html = '';
                  for (const day in eventsByDay) {
                      html += `<h3 class="day-header">${day}</h3>`;
                      html += eventsByDay[day].map(event => {
                          const startTime = new Date(event.start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                          const endTime = new Date(event.end).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                          return `<li class="event-item" id="event-${event.id}">
                              <div class="event-details">
                                  <span class="event-summary">${event.summary}</span>
                                  <span class="event-time">${startTime} - ${endTime}</span>
                                  <div class="event-description">${event.description || ''}</div>
                              </div>
                              <div style="position:relative">
                                  <button class="event-menu-btn" data-event-id="${event.id}">⋮</button>
                                  <div class="dropdown-menu" id="menu-event-${event.id}">
                                      <a class="dropdown-item" data-action="edit-event">Editar</a>
                                      <a class="dropdown-item" data-action="delete-event">Eliminar</a>
                                      <a class="dropdown-item" href="${event.htmlLink}" target="_blank">Ver en Google</a>
                                  </div>
                              </div>
                          </li>`;
                      }).join('');
                  }
                  return html;
              }

              let listHtml = (events.length > 0) ? groupAndRenderEvents(events) : '<div class="no-events">📅<br>No tienes eventos próximos.</div>';
              mainContent.innerHTML = `<div class="list-container"><div class="list-header"><button class="back-btn" id="back-to-dashboard">‹</button><h2>Agenda</h2></div><ul class="agenda-view" id="agenda-list-ul">${listHtml}</ul></div>`;
              document.getElementById('back-to-dashboard').onclick = initializeAppContent;
              document.getElementById('agenda-list-ul').addEventListener('click', (e) => handleEventInteractions(e, events));
          } catch (err) { mainContent.innerHTML = `<div class="no-events">❌<br>Error al cargar la agenda.<br><small>${err.message}</small></div>`; } finally { hideSpinner(); }
      }

      function handleEventInteractions(event, allEvents) {
          const eventDetails = event.target.closest('.event-details');
          const actionItem = event.target.closest('.dropdown-item');
          if (actionItem) {
              event.stopPropagation();
              const action = actionItem.dataset.action;
              const eventId = actionItem.closest('.dropdown-menu').id.replace('menu-event-', '');
              const eventData = allEvents.find(e => e.id === eventId);
              if (action === 'edit-event') {
                  renderEventForm(eventData);
              } else if (action === 'delete-event') {
                  executeDeleteEvent(eventId);
              }
          } else if (eventDetails) {
              eventDetails.closest('.event-item').classList.toggle('open');
          }
      }

      function renderEventForm(event = null) {
          const isEditing = event !== null;
          const toLocalISOString = (d) => {
              if(!d) return '';
              const date = new Date(d);
              date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
              return date.toISOString().slice(0, 16);
          };
          const start = isEditing ? toLocalISOString(event.start) : toLocalISOString(new Date());
          const end = isEditing ? toLocalISOString(event.end) : toLocalISOString(new Date(Date.now() + 3600000));
          
          mainContent.innerHTML = `
            <div class="list-container">
              <div class="list-header"><button class="back-btn" id="back-to-agenda">‹</button><h2>${isEditing ? '✏️ Editar Evento' : '➕ Nuevo Evento'}</h2></div>
              <div class="form-card">
                  <label>Título</label><input type="text" id="event-summary" value="${isEditing ? event.summary : ''}" required />
                  <label>Inicio</label><input type="datetime-local" id="event-start" value="${start}" required />
                  <label>Fin</label><input type="datetime-local" id="event-end" value="${end}" required />
                  <label>Descripción</label><textarea id="event-description" rows="4">${isEditing ? (event.description || '') : ''}</textarea>
                  <label>Ubicación</label><input type="text" id="event-location" value="${isEditing ? (event.location || '') : ''}" />
                  <button id="save-event-btn" data-event-id="${isEditing ? event.id : ''}" disabled>${isEditing ? 'Guardar Cambios' : 'Crear Evento'}</button>
              </div>
            </div>`;
          document.getElementById('back-to-agenda').onclick = renderAgendaView;
          const summaryInput = document.getElementById('event-summary');
          const saveBtn = document.getElementById('save-event-btn');
          function validateEventForm() {
              saveBtn.disabled = summaryInput.value.trim() === '';
              saveBtn.classList.toggle('enabled', !saveBtn.disabled);
          }
          summaryInput.addEventListener('input', validateEventForm);
          saveBtn.onclick = saveEvent;
          validateEventForm();
      }

async function saveEvent() {
    const btn = document.getElementById('save-event-btn');
    const eventId = btn.dataset.eventId;
    const isEditing = !!eventId;
    const eventData = {
        summary: document.getElementById('event-summary').value.trim(),
        start: document.getElementById('event-start').value,
        end: document.getElementById('event-end').value,
        description: document.getElementById('event-description').value.trim(),
        location: document.getElementById('event-location').value.trim()
    };
    // Corrige las fechas para que sean compatibles con el formato ISO que espera el script
    eventData.start = new Date(eventData.start).toISOString();
    eventData.end = new Date(eventData.end).toISOString();

    const payload = { chat_ID: chatId, Type: isEditing ? 'edit_calendar_event' : 'add_calendar_event', eventId: eventId, eventData: eventData };
    showSpinner();
    try {
        const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(`Error: ${res.status}`);
        await res.json();
        showToast(`Evento ${isEditing ? 'actualizado' : 'creado'}`);
        // ¡ESTA ES LA LÍNEA CLAVE AÑADIDA!
        initializeAppContent(); 
    } catch (err) { 
        showToast(err.message, true); 
    } finally { 
        hideSpinner(); 
    }
}

      async function executeDeleteEvent(eventId) {
          if (!confirm('¿Estás seguro de que quieres eliminar este evento?')) return;
          showSpinner();
          try {
              const res = await fetchWithTimeout(webhookURL, { body: JSON.stringify({ chat_ID: chatId, Type: 'delete_calendar_event', eventId: eventId }) });
              if (!res.ok) throw new Error(`Error: ${res.status}`);
              await res.json();
              showToast('Evento eliminado');
              initializeAppContent();
          } catch (err) { showToast(err.message, true); } finally { hideSpinner(); }
      }
      // --- FIN SECCIÓN CALENDARIO ---

      document.getElementById('tab-home').onclick = initializeAppContent;
      initializeAppContent();
    });
  </script>
</body>
</html>
